# Anti-Analysis Capabilities
# Covers anti-debugging, anti-VM, obfuscation, packing, etc.

simple_rules:
  # Debugging detection
  - symbol: ptrace
    capability: anti-analysis/debug/detect
    description: Detect debugger via ptrace
    confidence: 0.8
    platforms: [linux, unix, macos]

  - symbol: isatty
    capability: anti-analysis/debug/detect
    description: Detect terminal attachment
    confidence: 0.6
    platforms: [all]

  # Memory protection manipulation
  - symbol: mprotect
    capability: anti-analysis/memory/protect
    description: Change memory protection (potential unpacking)
    confidence: 0.7
    platforms: [linux, macos, unix]

composite_rules:
  # Anti-debugging via ptrace self-attachment
  - capability: anti-analysis/debug/ptrace-self
    description: Anti-debugging via ptrace self-attachment
    confidence: 0.95
    platforms: [linux, unix]
    file_types: [elf]

    requires_all:
      - type: symbol
        pattern: ptrace

      - type: symbol
        pattern: getpid

      # Common pattern: ptrace(PTRACE_TRACEME, 0, 1, 0)
      - type: string
        regex: 'PTRACE_TRACEME|PT_DENY_ATTACH'

  # VM detection via hardware queries
  - capability: anti-analysis/vm/detect
    description: Virtual machine detection
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # VM vendor strings
      - type: string
        regex: '(VMware|VirtualBox|VBOX|QEMU|Xen|Parallels|KVM)'
        case_insensitive: true

      # VM-specific hardware
      - type: string
        regex: '(VMXH|VBox|QEMU|virtio)'
        case_insensitive: true

      # macOS VM detection
      - type: symbol_or_string
        any:
          - sysctl
          - 'hw.model'
          - 'machdep.cpu'

      # Windows VM detection
      - type: string
        regex: '(DeviceIoControl|HKEY_LOCAL_MACHINE.*SYSTEM)'

  # Sandbox detection
  - capability: anti-analysis/sandbox/detect
    description: Sandbox environment detection
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Check for sandbox artifacts
      - type: string
        regex: '(sandbox|sample|malware|virus|cuckoo|joe\s*sandbox)'
        case_insensitive: true

      # Check for limited user interaction
      - type: symbol_or_string
        any:
          - GetForegroundWindow
          - GetCursorPos
          - GetLastInputInfo
          - GetTickCount

      # Sleep to evade timeout
      - type: symbol_or_string
        any:
          - sleep
          - usleep
          - nanosleep
          - Sleep

      # File system checks
      - type: string
        regex: '/Users/(analyst|sandbox|malware)'

  # Debugger detection (comprehensive)
  - capability: anti-analysis/debug/detect-multi
    description: Multiple debugger detection techniques
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # ptrace-based detection
      - type: symbol
        pattern: ptrace

      # /proc inspection (Linux)
      - type: string
        regex: '/proc/(self/status|self/cmdline|[0-9]+/stat)'

      # macOS sysctl detection
      - type: string
        regex: 'sysctl.*P_TRACED|CTL_KERN.*KERN_PROC'

      # Windows IsDebuggerPresent
      - type: symbol_or_string
        any:
          - IsDebuggerPresent
          - CheckRemoteDebuggerPresent
          - NtQueryInformationProcess

      # Timing checks
      - type: symbol_or_string
        any:
          - clock_gettime
          - gettimeofday
          - QueryPerformanceCounter

  # Runtime packing/unpacking
  - capability: anti-analysis/packing/runtime
    description: Runtime unpacking detected
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Memory allocation
      - type: symbol_or_string
        any:
          - mmap
          - VirtualAlloc
          - malloc

      # Memory protection change (W^X violation)
      - type: symbol
        pattern: 'mprotect|VirtualProtect'

      # High entropy section (packed data)
      - type: structure
        feature: entropy/high
        min_sections: 1

  # String obfuscation via stack strings
  - capability: anti-analysis/obfuscation/stack-strings
    description: String obfuscation via stack construction
    confidence: 0.8
    platforms: [all]

    requires_all:
      # YARA detected stack strings
      - type: yara_match
        namespace: anti-static.obfuscation

      # High ratio of instructions per string
      - type: structure
        feature: binary/stripped

  # Time-based evasion
  - capability: anti-analysis/evasion/time-based
    description: Time-based sandbox evasion
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Long sleep
      - type: symbol_or_string
        any:
          - sleep
          - usleep
          - nanosleep
          - Sleep

      # Time checks
      - type: symbol_or_string
        any:
          - time
          - gettimeofday
          - clock_gettime
          - GetTickCount
          - GetSystemTime

      # Suspicious sleep durations
      - type: string
        regex: '[0-9]{4,}' # Long numbers (could be sleep duration)

  # Anti-disassembly tricks
  - capability: anti-analysis/obfuscation/anti-disassembly
    description: Anti-disassembly techniques
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Junk instructions
      - type: yara_match
        namespace: anti-static.obfuscation

      # Overlapping instructions
      - type: yara_match
        namespace: anti-static

      # Self-modifying code
      - type: symbol
        pattern: 'mprotect|VirtualProtect'

      # High complexity functions (obfuscation)
      - type: structure
        feature: binary/stripped

  # DLL injection detection (anti-analysis tool)
  - capability: anti-analysis/dll-injection/detect
    description: Detect DLL injection (anti-hooking)
    confidence: 0.85
    platforms: [windows]
    file_types: [pe, dll]

    requires_count: 2
    conditions:
      # Check for hooks
      - type: symbol_or_string
        any:
          - GetProcAddress
          - LoadLibrary

      # Read module memory
      - type: symbol
        pattern: 'ReadProcessMemory|VirtualQuery'

      # Unhooking pattern
      - type: string
        regex: '(ntdll|kernel32)\.dll'

  # Hardware breakpoint detection
  - capability: anti-analysis/debug/hardware-breakpoint
    description: Hardware breakpoint detection
    confidence: 0.9
    platforms: [all]

    requires_any:
      # Check debug registers (x86)
      - type: string
        regex: 'DR[0-7]'

      # Windows GetThreadContext
      - type: symbol
        pattern: GetThreadContext

      # Linux ptrace GETREGS
      - type: string
        regex: 'PTRACE_GETREGS|PTRACE_PEEKUSER'

  # Exception-based anti-debugging
  - capability: anti-analysis/debug/exception-based
    description: Exception-based anti-debugging
    confidence: 0.85
    platforms: [windows]
    file_types: [pe, dll]

    requires_count: 2
    conditions:
      # Exception handlers
      - type: symbol_or_string
        any:
          - AddVectoredExceptionHandler
          - SetUnhandledExceptionFilter
          - RaiseException

      # INT3 or invalid instruction triggers
      - type: yara_match
        namespace: anti-behavior

  # Process enumeration (looking for analysis tools)
  - capability: anti-analysis/process/enum
    description: Enumerate processes for analysis tools
    confidence: 0.8
    platforms: [all]

    requires_all:
      # Process listing capability
      - type: symbol_or_string
        any:
          - CreateToolhelp32Snapshot
          - Process32First
          - opendir
          - readdir
          - '/proc'

      # Tool names to detect
      - type: string
        regex: '(wireshark|ida|olly|x64dbg|procmon|processhacker|ghidra)'
        case_insensitive: true

  # DLL list manipulation (unhooking)
  - capability: anti-analysis/unhook
    description: Unhook APIs (remove monitoring)
    confidence: 0.9
    platforms: [windows]
    file_types: [pe, dll]

    requires_all:
      # Read original DLL from disk
      - type: symbol_or_string
        any:
          - CreateFile
          - ReadFile
          - MapViewOfFile

      # Write to process memory
      - type: symbol
        pattern: WriteProcessMemory

      # Target system DLLs
      - type: string
        regex: '(ntdll|kernel32|kernelbase)\.dll'
        case_insensitive: true

  # Checking parent process (detect sandboxes)
  - capability: anti-analysis/parent-process/check
    description: Check parent process for sandbox
    confidence: 0.75
    platforms: [all]

    requires_count: 2
    conditions:
      # Get parent PID
      - type: symbol_or_string
        any:
          - getppid
          - NtQueryInformationProcess
          - '/proc/self/stat'

      # Process name checks
      - type: symbol_or_string
        any:
          - readlink
          - GetModuleFileName
          - CreateToolhelp32Snapshot

  # API hashing (hide imports)
  - capability: anti-analysis/obfuscation/api-hashing
    description: Obfuscate API calls via hashing
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Dynamic resolution
      - type: symbol_or_string
        any:
          - GetProcAddress
          - dlsym
          - dlopen

      # Hashing functions
      - type: symbol_or_string
        any:
          - MD5
          - SHA1
          - crc32

      # Very few imports (hidden via hashing)
      - type: imports_count
        max: 15
