# Execution - Dynamic Library Loading
# ATT&CK: T1574.006 (Dynamic Linker Hijacking)

traits:
  - id: dlopen
    desc: Dynamic library loading via dlopen
    crit: notable
    conf: 0.9
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: symbol
      exact: "dlopen"

  # === Windows LoadLibrary family ===
  - id: load-library
    desc: Dynamic library loading via LoadLibrary
    crit: notable
    conf: 0.95
    attack: "T1574.002"
    for: [pe]
    platforms: [windows]
    if:
      type: symbol
      exact: "LoadLibrary"

  - id: load-library-a
    desc: Dynamic library loading via LoadLibraryA
    crit: notable
    conf: 0.95
    attack: "T1574.002"
    for: [pe]
    platforms: [windows]
    if:
      type: symbol
      exact: "LoadLibraryA"

  - id: load-library-w
    desc: Dynamic library loading via LoadLibraryW
    crit: notable
    conf: 0.95
    attack: "T1574.002"
    for: [pe]
    platforms: [windows]
    if:
      type: symbol
      exact: "LoadLibraryW"

  - id: load-library-ex
    desc: Extended dynamic library loading
    crit: notable
    conf: 0.95
    attack: "T1574.002"
    for: [pe]
    platforms: [windows]
    if:
      type: symbol
      exact: "LoadLibraryEx"

  - id: load-library-ex-a
    desc: Extended dynamic library loading (ANSI)
    crit: notable
    conf: 0.95
    attack: "T1574.002"
    for: [pe]
    platforms: [windows]
    if:
      type: symbol
      exact: "LoadLibraryExA"

  - id: load-library-ex-w
    desc: Extended dynamic library loading (Unicode)
    crit: notable
    conf: 0.95
    attack: "T1574.002"
    for: [pe]
    platforms: [windows]
    if:
      type: symbol
      exact: "LoadLibraryExW"

  - id: dlclose
    desc: Dynamic library unload
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: symbol
      exact: "dlclose"

  - id: dlerror
    desc: Dynamic linker error handling
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: symbol
      exact: "dlerror"

  - id: nsbundle
    desc: macOS NSBundle loading
    crit: notable
    conf: 0.6
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      substr: "NSBundle"

  # === ObjC Runtime Hooking ===
  - id: objc-method-swizzle
    desc: ObjC method swizzling via runtime
    crit: suspicious
    conf: 0.85
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      substr: "class_getInstanceMethod"

  - id: objc-set-instance-var
    desc: ObjC runtime instance variable manipulation
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      substr: "object_setInstanceVariable"

  - id: messaging-app-ichat
    desc: Apple iChat bundle identifier
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      substr: "com.apple.iChat"

  - id: messaging-app-mail
    desc: Apple Mail bundle identifier
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      substr: "com.apple.mail"

  - id: messaging-app-messages
    desc: Apple Messages bundle identifier
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      substr: "com.apple.Messages"

  - id: ctypes-windll
    desc: Python ctypes Windows DLL
    crit: notable
    conf: 0.85
    attack: "T1574.002"
    for: [python]
    if:
      type: string
      regex: "windll\\.[\\w.]+"

  # === ctypes CDLL atomic indicators ===
  - id: ctypes-cdll-dot
    desc: ctypes.CDLL pattern
    crit: notable
    conf: 0.7
    attack: "T1574"
    for: [python]
    if:
      type: ast
      kind: call
      exact: "ctypes.CDLL"

  - id: cdll-paren
    desc: CDLL( call pattern
    crit: notable
    conf: 0.7
    attack: "T1574"
    for: [python]
    if:
      type: ast
      kind: call
      exact: "CDLL"

  # === Python local path loading atomic indicators ===
  - id: loadlibrary-keyword
    desc: LoadLibrary keyword
    crit: inert
    conf: 0.6
    for: [python]
    if:
      type: string
      word: "LoadLibrary"

  - id: python-file-dunder
    desc: __file__ variable
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      substr: "__file__"

  - id: dirname-call
    desc: dirname function call
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      word: "dirname"

  - id: abspath-call
    desc: abspath function call
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      word: "abspath"

  - id: ruby-dlopen
    desc: Ruby FFI dlopen
    crit: notable
    conf: 0.85
    attack: "T1574.006"
    for: [ruby]
    if:
      type: string
      regex: "\\.dlopen\\("

  - id: java-loadclass
    desc: Java runtime class loading
    crit: suspicious
    conf: 0.85
    attack: "T1574"
    for: [java, class]
    if:
      type: string
      substr: "loadReplacementClass"

  - id: webkit-framework
    desc: WebKit framework linked
    crit: inert
    conf: 0.9
    for: [macho]
    if:
      type: string
      substr: "WebKit"

composite_rules:
  # Apple messaging app bundle ID (any variant)
  - id: messaging-app-bundle-id
    desc: Apple messaging app bundle identifier
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [macho]
    any:
      - id: messaging-app-ichat
      - id: messaging-app-mail
      - id: messaging-app-messages

  # ObjC method swizzle targeting messaging apps
  - id: objc-messaging-hook
    desc: ObjC method swizzle with messaging hook
    crit: suspicious
    conf: 0.9
    attack: "T1574.006"
    for: [macho]
    all:
      - id: objc-method-swizzle
      - id: messaging-app-bundle-id

  # Helper composites
  - id: library-loaders
    desc: Library loading functions (CDLL or
    for: [python]
    any:
      - { id: cdll-paren }
      - { id: loadlibrary-keyword }

  - id: path-manipulation
    desc: Path manipulation functions
    for: [python]
    any:
      - { id: python-file-dunder }
      - { id: dirname-call }
      - { id: abspath-call }

  - id: local-load
    desc: Loading dynamic library from local
    crit: suspicious
    conf: 0.9
    attack: "T1574"
    for: [python]
    near_lines: 40
    all:
      - { id: library-loaders }
      - { id: path-manipulation }

  # Core dlopen + dlsym pattern (basic dynamic loading)
  - id: dlopen-dlsym
    desc: Core dlopen/dlsym pattern
    crit: notable
    conf: 0.85
    attack: "T1574.006"
    for: [elf, macho]
    all:
      - id: dlopen
      - id: micro-behaviors/dylib/lookup::dlsym-symbol

  # dl* family function
  - id: dl-function
    desc: Any dl* function usage
    crit: notable
    conf: 0.7
    attack: "T1574.006"
    for: [elf, macho]
    any:
      - id: dlopen
      - id: micro-behaviors/dylib/lookup::dlsym-symbol
      - id: dlclose
      - id: dlerror

  # NSBundle with dynamic loading
  - id: nsbundle-dynamic
    desc: NSBundle with dynamic loading APIs
    crit: suspicious
    conf: 0.85
    attack: "T1574.006"
    for: [macho]
    all:
      - id: nsbundle
      - id: dl-function
    # Downgrade for legitimate system components that use NSBundle + dynamic loading
    # (e.g., ReplayKit daemon, plugin systems, framework code)
    downgrade:
      any:
        - id: metadata/apple::system-component

  # NOTE: dlopen/dlsym is common in many legitimate programs including shells
  # (bash uses it for loadable builtins), interpreters, plugin systems, and
  # graphics/video libraries (loading GPU/video drivers dynamically).
  - id: dynamic-loader-detected
    desc: Dynamic code loading pattern
    crit: suspicious
    conf: 0.9
    attack: "T1574.006"
    mbc: "B0023"
    for: [elf, macho]
    any:
      - id: dlopen-dlsym
      - id: nsbundle-dynamic
    # Downgrade for system components and known system/video libraries
    downgrade:
      any:
        - id: metadata/apple::system-component
        - id: metadata/sign/apple::platform
        - id: micro-behaviors/dylib/library::system-lib-marker
        - id: micro-behaviors/dylib/load/video-lib-marker
        - id: micro-behaviors/dylib/library::graphics-lib-marker
        - id: micro-behaviors/dylib/library::shell-interpreter
        - id: micro-behaviors/dylib/library::cxx-stdlib-marker

  # ctypes CDLL composite
  - id: ctypes-cdll
    desc: Python ctypes CDLL loading
    crit: notable
    conf: 0.85
    attack: "T1574"
    for: [python]
    any:
      - id: ctypes-cdll-dot
      - id: cdll-paren
