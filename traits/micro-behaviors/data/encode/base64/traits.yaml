# Base64 Encoding and Decoding
# Detects Base64 operations across multiple languages
# MBC: C0025 (Encode Data)
# ATT&CK: T1132 (Data Encoding), T1140 (Deobfuscate/Decode Files or Information)

traits:
  # === Python Traits ===
  - id: import-base64
    desc: Imports Python base64 module
    for: [python]
    conf: 0.9
    if:
      type: ast
      kind: import
      exact: "base64"

  - id: b64encode-call
    desc: Calls base64.b64encode (Python)
    for: [python]
    crit: inert
    conf: 0.9
    if:
      type: symbol
      exact: "base64.b64encode"

  - id: b64decode-call
    desc: Calls base64.b64decode (Python)
    for: [python]
    crit: inert
    conf: 0.9
    if:
      type: symbol
      exact: "base64.b64decode"

  - id: encodestring-call
    desc: Calls base64.encodestring (Python legacy)
    for: [python]
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "base64.encodestring"

  - id: decodestring-call
    desc: Calls base64.decodestring (Python legacy)
    for: [python]
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "base64.decodestring"

  - id: binascii-b2a-base64
    desc: Calls binascii.b2a_base64 (Python)
    for: [python]
    crit: inert
    conf: 0.9
    if:
      type: symbol
      exact: "binascii.b2a_base64"

  - id: b64decode-string
    desc: Base64 decode string reference
    crit: notable
    conf: 0.66
    for: [all]
    if:
      type: string
      substr: b64decode

  - id: codecs-decode-base64
    desc: codecs.decode with base64 encoding (Python)
    for: [python]
    crit: notable
    conf: 0.90
    if:
      type: ast
      query: |
        (call
          function: (attribute
            object: (identifier) @mod
            attribute: (identifier) @method)
          arguments: (argument_list
            _
            (string) @encoding)
          (#eq? @mod "codecs")
          (#eq? @method "decode")
          (#match? @encoding "^['\"](base64|base_64|base-64|BASE64|BASE_64|BASE-64)['\"]$"))

  - id: importlib-base64
    desc: importlib.import_module('base64') (Python)
    for: [python]
    crit: notable
    conf: 0.85
    if:
      type: ast
      query: |
        (call
          function: (attribute
            object: (identifier) @mod
            attribute: (identifier) @method)
          arguments: (argument_list
            (string) @modname)
          (#eq? @mod "importlib")
          (#eq? @method "import_module")
          (#match? @modname "^['\"]base64['\"]$"))

  # === Go Traits ===
  - id: std-encoding-decode-string
    desc: base64.StdEncoding.DecodeString (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.StdEncoding\.DecodeString'

  - id: raw-std-encoding-decode-string
    desc: base64.RawStdEncoding.DecodeString (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.RawStdEncoding\.DecodeString'

  - id: url-encoding-decode-string
    desc: base64.URLEncoding.DecodeString (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.URLEncoding\.DecodeString'

  - id: raw-url-encoding-decode-string
    desc: base64.RawURLEncoding.DecodeString (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.RawURLEncoding\.DecodeString'

  - id: std-encoding-decode
    desc: base64.StdEncoding.Decode (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.StdEncoding\.Decode'

  - id: new-decoder
    desc: base64.NewDecoder (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.NewDecoder'

  - id: std-encoding-encode-string
    desc: base64.StdEncoding.EncodeToString (Go)
    for: [go]
    if:
      type: symbol
      regex: 'base64\.StdEncoding\.EncodeToString'

  # === JavaScript/TypeScript Traits ===
  - id: tostring-base64
    desc: Base64 encoding via toString (JS)
    for: [javascript, typescript]
    crit: inert
    conf: 0.8
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (member_expression
            property: (property_identifier) @tostr
          )
          arguments: (arguments
            (string) @enc
          )
          (#eq? @tostr "toString")
          (#match? @enc "base64")
        )

  - id: buffer-from-base64
    desc: Base64 decoding via Buffer.from (JS)
    for: [javascript, typescript]
    crit: inert
    conf: 0.8
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (member_expression
            object: (identifier) @buf
            property: (property_identifier) @from
          )
          arguments: (arguments
            (_)
            (string) @enc
          )
          (#eq? @buf "Buffer")
          (#eq? @from "from")
          (#match? @enc "base64")
        )

  - id: atob-decode
    desc: atob() base64 decode (JS browser)
    for: [javascript, typescript]
    crit: inert
    conf: 0.9
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (identifier) @func
          (#eq? @func "atob"))

  # === Ruby Traits ===
  - id: base64-decode
    desc: Ruby Base64 decode
    for: [ruby]
    conf: 0.90
    if:
      type: raw
      regex: "Base64\\.(decode64|urlsafe_decode64|strict_decode64)"

  - id: base64-urlsafe-decode
    desc: Ruby urlsafe Base64 decode
    for: [ruby]
    conf: 0.90
    if:
      type: raw
      regex: "Base64\\.urlsafe_decode64"

  - id: decode64-symbol
    desc: decode64 symbol call (Ruby)
    for: [ruby]
    conf: 0.88
    if:
      type: symbol
      exact: "decode64"

composite_rules:
  - id: base64-encoding
    desc: Base64 encoding capability
    crit: inert
    conf: 0.95
    any:
      - id: b64encode-call
      - id: encodestring-call
      - id: binascii-b2a-base64
      - id: std-encoding-encode-string
      - id: tostring-base64

  - id: base64-decoding
    desc: Base64 decoding capability
    crit: inert
    conf: 0.95
    any:
      - id: b64decode-call
      - id: decodestring-call
      - id: codecs-decode-base64
      - id: importlib-base64
      - id: std-encoding-decode-string
      - id: raw-std-encoding-decode-string
      - id: url-encoding-decode-string
      - id: raw-url-encoding-decode-string
      - id: std-encoding-decode
      - id: new-decoder
      - id: buffer-from-base64
      - id: atob-decode
      - id: base64-decode
      - id: base64-urlsafe-decode
      - id: decode64-symbol
      - id: micro-behaviors/data/encode/base85::b85decode-call
