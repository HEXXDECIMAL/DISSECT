# HTTP Request Operations - Generic
# MBC: C0002 (HTTP Communication)
# ATT&CK: T1071.001

defaults:
  for: [all]

traits:
  # === HTTP request micro-behaviors (migrated from YARA) ===
  - id: request
    desc: HTTP REQUEST method
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "REQUEST"
      case_insensitive: false

  - id: http-request-func
    desc: httpRequest function reference
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    if:
      type: string
      substr: "httpRequest"

  - id: user-agent-header
    desc: User-Agent header
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    for: [all]
    if:
      type: string
      substr: "User-Agent"

  - id: auth-header
    desc: Authorization header
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    for: [all]
    if:
      type: string
      exact: "Authorization"
      case_insensitive: true

  - id: hardcoded-auth-token
    desc: Hardcoded Authorization token
    crit: suspicious
    conf: 0.7
    mbc: "C0002"
    attack: "T1071.001"
    for: [python, javascript, ruby, go]
    if:
      type: raw
      regex: 'Authorization.:\s*.(Token|Bearer|Basic)\s+[0-9a-fA-F]{16,}'

  - id: http-version
    desc: HTTP/1.x version string
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    if:
      type: string
      substr: "HTTP/1."

  # === Network exfiltration atomic indicators ===
  # NOTE: requests.get/post moved to communications/http/lib/requests/python.yaml
  # as they are library-specific implementations

  - id: socket-dot
    desc: socket module usage
    crit: inert
    conf: 0.4
    # Restrict to script languages - "socket." matches too many binary strings
    # like library names (socket.so), debug paths, etc.
    for: [python, ruby, javascript, typescript]
    if:
      type: string
      regex: "socket\\.(socket|connect|gethostbyname|create_connection)\\("

  # NOTE: fetch() moved to communications/http/request/javascript.yaml
  # as it's JavaScript-specific

  - id: xmlhttprequest-word
    desc: XMLHttpRequest reference
    crit: notable
    conf: 0.4
    if:
      type: string
      substr: "XMLHttpRequest"

  - id: http-config-method
    desc: HTTP configuration field (method)
    crit: inert
    conf: 0.3
    if:
      type: raw
      regex: '("method"|method:)'

  - id: http-config-body
    desc: HTTP configuration field (body)
    crit: inert
    conf: 0.3
    if:
      type: raw
      regex: '("body"|body:)'

  - id: http-config-headers
    desc: HTTP configuration field (headers)
    crit: inert
    conf: 0.3
    if:
      type: raw
      regex: '("headers"|headers:)'

composite_rules:
  - id: http-config-fields
    desc: HTTP configuration fields (method/body/headers)
    crit: inert
    conf: 0.5
    needs: 2
    any:
      - id: http-config-method
      - id: http-config-body
      - id: http-config-headers

  # Network client library composite
  # NOTE: These are common HTTP/network client patterns used in any networked
  # application. The name "network-exfil" was misleading - these are just client
  # capabilities, not exfiltration indicators.
  - id: http-client
    desc: HTTP client library usage
    crit: inert
    conf: 0.7
    any:
      - id: micro-behaviors/communications/http/lib/requests::requests-post
      - id: micro-behaviors/communications/http/lib/requests::requests-get
      - id: micro-behaviors/communications/http/lib/urllib::urllib-word
      - id: socket-dot
      - id: micro-behaviors/communications/http/request::fetch-string
      - id: xmlhttprequest-word
