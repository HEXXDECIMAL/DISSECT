# SSL/TLS Operations
# MBC: C0001 (Socket Communication)
# ATT&CK: T1071

traits:
  # === SSL/TLS Connection ===
  - id: ssl-connect-symbol
    desc: SSL connect API
    crit: inert
    conf: 0.66
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      exact: SSL_connect

  - id: ssl-new-symbol
    desc: SSL object creation API
    crit: inert
    conf: 0.66
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      exact: SSL_new

  - id: ssl-ctx-new-symbol
    desc: SSL context creation API
    crit: inert
    conf: 0.66
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      exact: SSL_CTX_new

  - id: tls-client-method-symbol
    desc: TLS client method API
    crit: inert
    conf: 0.66
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      exact: TLS_client_method

  # === Certificate Verification Skip ===
  - id: insecure-skip-verify
    desc: InsecureSkipVerify (Go)
    crit: suspicious
    conf: 0.8
    for: [go]
    if:
      type: string
      substr: "InsecureSkipVerify"

  - id: cert-none
    desc: cert_reqs set to CERT_NONE (Python)
    crit: notable
    conf: 0.75
    for: [python]
    if:
      type: raw
      regex: "\\bcert_reqs\\s*=\\s*(?:ssl\\.)?CERT_NONE\\b"

  - id: verify-mode-none
    desc: verify_mode = ssl.CERT_NONE (Python)
    crit: notable
    conf: 0.85
    for: [python]
    if:
      type: raw
      regex: "\\bverify_mode\\s*=\\s*(?:ssl\\.)?CERT_NONE\\b"
    unless:
      - type: string
        regex: "urllib3|requests|botocore"

  - id: reject-unauthorized-false
    desc: rejectUnauthorized false (Node.js)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      substr: "rejectUnauthorized: false"

composite_rules:
  - id: connect
    desc: SSL/TLS connection
    crit: inert
    conf: 0.66
    for: [elf, macho, so, dylib, c]
    any:
      - id: ssl-connect-symbol
      - id: ssl-new-symbol
      - id: ssl-ctx-new-symbol
      - id: tls-client-method-symbol

  # Skip SSL certificate verification (migrated from YARA)
  - id: verify-skip
    desc: Skip SSL certificate verification
    crit: suspicious
    conf: 0.66
    # Small binaries/scripts skipping verification are more suspicious
    size_max: 10000
    any:
      - id: insecure-skip-verify
      - id: verify-mode-none
      - id: reject-unauthorized-false
