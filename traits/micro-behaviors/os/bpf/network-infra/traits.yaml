# BPF Infrastructure Components
# Basic BPF structures and packet capture functions

defaults:
  crit: inert
  for: [elf, c]

traits:
  - id: bpf-program
    desc: bpf_program struct
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "bpf_program"

  - id: bpf-prefix
    desc: BPF_ prefix
    conf: 0.4
    if:
      type: string
      exact: "BPF_"

  - id: pcap-prefix-a
    desc: pcap library function reference
    conf: 0.5
    if:
      type: symbol
      # Match actual pcap API functions, not just the prefix
      regex: "\\bpcap_(open_live|compile|setfilter|loop)\\b"

  - id: pcap-prefix-b
    desc: pcap library function reference
    conf: 0.5
    if:
      type: symbol
      regex: "\\bpcap_(next|close|findalldevs|lookupdev)\\b"

  # Removed recvfrom-fn - recvfrom is a general socket function, not BPF-specific
  # It's already covered by micro-behaviors/communications/socket/receive::receive for binaries
  # and micro-behaviors/communications/socket/connect/python::socket-recvfrom-call for Python

composite_rules:
  - id: pcap-prefix
    desc: pcap library function reference
    conf: 0.5
    any:
      - { id: pcap-prefix-a }
      - { id: pcap-prefix-b }

  - id: has-bpf-infra
    desc: Has BPF infrastructure components
    crit: notable
    conf: 0.6
    for: [elf, c]
    needs: 2
    any:
      - { id: bpf-program }
      - { id: bpf-prefix }
      - { id: pcap-prefix }
      - { id: micro-behaviors/communications/socket/receive::receive }
