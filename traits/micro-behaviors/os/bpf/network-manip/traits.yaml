# Packet Manipulation Helpers
# eBPF helpers for modifying packet contents

defaults:
  crit: notable
  conf: 0.75
  for: [c]

traits:
  - id: csum-helper
    desc: Checksum helper function
    if:
      type: raw
      regex: "csum_(fold|replace|update|diff)"

  - id: eth-swap
    desc: Ethernet address swap macro
    conf: 0.8
    if:
      type: raw
      substr: "eth_swap"

  - id: eth-alen
    desc: ETH_ALEN Ethernet address length
    crit: inert
    conf: 0.6
    if:
      type: raw
      substr: "ETH_ALEN"

  # NOTE: ntohs/htons/ntohl/htonl moved to communications/ip/parse/unix.yaml
  # as that's the more canonical location for network byte order functions

  - id: ntohs-bswap-b
    desc: Network byte order conversion
    crit: inert
    conf: 0.5
    if:
      type: raw
      regex: "__builtin_bswap(16|32|64)"


composite_rules:
  - id: ntohs-bswap
    desc: Network byte order conversion
    crit: inert
    conf: 0.5
    any:
      - id: micro-behaviors/communications/ip/parse/
      - { id: ntohs-bswap-b }

  - id: has-packet-manip
    desc: Has packet manipulation capabilities
    crit: notable
    conf: 0.8
    for: [c]
    needs: 2
    any:
      - { id: csum-helper }
      - { id: eth-swap }
      - { id: eth-alen }
      - { id: ntohs-bswap }
