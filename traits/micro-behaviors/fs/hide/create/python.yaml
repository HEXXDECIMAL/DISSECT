defaults:
  for:
  - python
  mbc: F0005
  attack: T1564.001
  crit: suspicious
traits:
- id: python-join-hidden
  desc: Hidden directory construction via os.path.join
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: os\.path\.join\(.{0,200},\s*["']\.[a-zA-Z][a-zA-Z0-9_-]{0,40}["']
  not:
  - regex: '["'']\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)["'']'
- id: python-pathlib-hidden
  desc: Hidden directory construction via pathlib
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: /\s*["']\.[a-zA-Z][a-zA-Z0-9_-]*["']
  not:
  - regex: '["'']\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)["'']'
- id: python-string-hidden-path
  desc: Hidden path string literal
  conf: 0.75
  crit: notable
  if:
    type: string
    regex: '["''].{0,200}[/~]\.[a-zA-Z][a-zA-Z0-9_-]{0,40}'
- id: python-makedirs-hidden
  desc: Create hidden directory (os.makedirs)
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: os\.makedirs\(.{0,220}\.[a-zA-Z][a-zA-Z0-9_-]{0,40}
  not:
  - regex: '["'']\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)["'']'
- id: python-home-expansion
  desc: Home directory path expansion
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: os\.path\.expanduser\(.{0,120}~|Path\.home\(\)
- id: python-hidden-join-pattern
  desc: Join with hidden directory pattern
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: os\.path\.join\(.{0,200},\s*["']\.[a-zA-Z]|/\s*["']\.[a-zA-Z]
- id: python-os-makedirs
  desc: os.makedirs call
  crit: inert
  conf: 0.7
  if:
    type: string
    regex: os\.makedirs\(
- id: python-open-write
  desc: open() with write mode
  crit: inert
  conf: 0.7
  if:
    type: string
    regex: open\(.{0,220}["']w
- id: python-cryptic-hidden
  desc: Cryptic hidden directory name (likely
  crit: suspicious
  conf: 0.85
  if:
    type: string
    regex: (os\.path\.join|/\s*["']\.|makedirs|mkdir)\(.{0,220}["']\.[a-z][a-z0-9]?["']
  not:
  - regex: '["'']\.(py|js|ts|go|rs|rb|md|sh|c|h|pyc|pt|so|git|ssh|aws|npm)["'']'
- id: python-mkdir-hidden__any_1
  desc: Helper raw condition
  if:
    type: raw
    regex: \.mkdir\(\s*["']\.[a-zA-Z][a-zA-Z0-9_-]{0,40}["']
- id: python-mkdir-hidden__any_2
  desc: Helper raw condition
  if:
    type: raw
    regex: \.mkdir\(\s*["'].{0,200}[\\/]\.[a-zA-Z][a-zA-Z0-9_-]{0,40}["']
- id: python-mkdir-hidden__unless_1a
  desc: Helper string condition
  crit: inert
  if:
    type: string
    regex: \.(tox|cache|git|venv)
- id: python-mkdir-hidden__unless_1b
  desc: Helper string condition
  crit: inert
  if:
    type: string
    regex: \.(env|pytest_cache|mypy_cache|build)
- id: python-mkdir-hidden__unless_1c
  desc: Helper string condition
  crit: inert
  if:
    type: string
    regex: \.dist
composite_rules:
- id: python-write-or-makedirs
  desc: File write or directory creation
  crit: notable
  conf: 0.8
  needs: 2
  any:
  - id: python-os-makedirs
  - id: python-open-write
- id: python-mkdir-hidden
  desc: Create hidden directory (pathlib mkdir)
  crit: notable
  conf: 0.9
  unless:
  - id: python-mkdir-hidden__unless_1
  any:
  - id: python-mkdir-hidden__any_1
  - id: python-mkdir-hidden__any_2
- id: python-mkdir-hidden__unless_1
  desc: Helper string condition
  any:
  - id: python-mkdir-hidden__unless_1a
  - id: python-mkdir-hidden__unless_1b
  - id: python-mkdir-hidden__unless_1c
