defaults:
  for:
  - python
  mbc: F0005
  attack: T1564.001
  crit: suspicious
traits:
- id: python-join-hidden
  desc: "Hidden directory construction via os.path.join"
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: os\.path\.join\(.{0,200},\s*["']\.[a-zA-Z][a-zA-Z0-9_-]{0,40}["']
  unless:
    - id: development-hidden-paths

- id: python-pathlib-hidden
  desc: "Hidden directory construction via pathlib"
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: /\s*["']\.[a-zA-Z][a-zA-Z0-9_-]*["']
  unless:
    - id: development-hidden-paths

- id: python-string-hidden-path
  desc: "Hidden path string literal"
  conf: 0.75
  crit: notable
  if:
    type: string
    regex: '["''].{0,200}[/~]\.[a-zA-Z][a-zA-Z0-9_-]{0,40}'

- id: python-makedirs-hidden
  desc: "Create hidden directory (os.makedirs)"
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: os\.makedirs\(.{0,220}\.[a-zA-Z][a-zA-Z0-9_-]{0,40}
  unless:
    - id: development-hidden-paths

- id: python-home-expansion
  desc: "Home directory path expansion"
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: os\.path\.expanduser\(.{0,120}~|Path\.home\(\)

- id: python-hidden-join-pattern
  desc: "Join with hidden directory pattern"
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: os\.path\.join\(.{0,200},\s*["']\.[a-zA-Z]|/\s*["']\.[a-zA-Z]

- id: python-os-makedirs
  desc: "os.makedirs call"
  crit: inert
  conf: 0.7
  if:
    type: string
    regex: os\.makedirs\(

- id: python-open-write
  desc: "open() with write mode"
  crit: inert
  conf: 0.7
  if:
    type: string
    regex: open\(.{0,220}["']w

- id: python-cryptic-hidden
  desc: "Cryptic hidden directory name"
  crit: suspicious
  conf: 0.85
  if:
    type: string
    regex: (os\.path\.join|/\s*["']\.|makedirs|mkdir)\(.{0,220}["']\.[a-z][a-z0-9]?["']
  not:
  - regex: '["'']\.(py|js|ts|go|rs|rb|md|sh|c|h|pyc|pt|so|git|ssh|aws|npm)["'']'

- id: python-mkdir-hidden__any_1
  desc: "Helper raw condition 1"
  if:
    type: raw
    regex: \.mkdir\(\s*["']\.[a-zA-Z][a-zA-Z0-9_-]{0,40}["']

- id: python-mkdir-hidden__any_2
  desc: "Helper raw condition 2"
  if:
    type: raw
    regex: \.mkdir\(\s*["'].{0,200}[\\/]\.[a-zA-Z][a-zA-Z0-9_-]{0,40}["']

# --- Common development hidden paths (centralized exclusions) ---
- id: development-path-tox
  desc: "Tox development directory"
  if: { type: string, substr: ".tox" }
- id: development-path-cache
  desc: "Cache development directory"
  if: { type: string, substr: ".cache" }
- id: development-path-git
  desc: "Git repository directory"
  if: { type: string, substr: ".git" }
- id: development-path-venv
  desc: "Python virtual environment directory"
  if: { type: string, substr: ".venv" }
- id: development-path-env
  desc: "Environment configuration file"
  if:
    type: trait
    id: metadata/quality/config::dotenv-file
- id: development-path-pytest
  desc: "Pytest cache directory"
  if: { type: string, substr: ".pytest_cache" }
- id: development-path-mypy
  desc: "Mypy cache directory"
  if: { type: string, substr: ".mypy_cache" }
- id: development-path-build
  desc: "Build output directory"
  if: { type: string, substr: ".build" }
- id: development-path-dist
  desc: "Distribution output directory"
  if: { type: string, substr: ".dist" }

composite_rules:
- id: development-hidden-paths
  desc: "Legitimate development-related hidden paths"
  crit: inert
  any:
    - id: development-path-tox
    - id: development-path-cache
    - id: development-path-git
    - id: development-path-venv
    - id: development-path-env
    - id: development-path-pytest
    - id: development-path-mypy
    - id: development-path-build
    - id: development-path-dist

- id: python-write-or-makedirs
  desc: "File write or directory creation"
  crit: notable
  conf: 0.8
  needs: 2
  any:
  - id: python-os-makedirs
  - id: python-open-write

- id: python-mkdir-hidden
  desc: "Create hidden directory (pathlib mkdir)"
  crit: notable
  conf: 0.9
  unless:
  - id: development-hidden-paths
  any:
  - id: python-mkdir-hidden__any_1
  - id: python-mkdir-hidden__any_2
