# Extended Attributes (xattr) - Symbol-based
# MBC: E1222 (File Permission Modification)
# ATT&CK: T1222

defaults:
  for: [elf, macho, so, dylib, c]

traits:
  # setxattr/fsetxattr/lsetxattr for elf: use objectives/evasion/anti-av/platform::setxattr-symbol etc. (canonical)
  - id: setxattr-func
    desc: Set extended attribute
    crit: notable
    conf: 0.66
    for: [macho, so, dylib]
    if:
      type: symbol
      exact: "setxattr"

  - id: fsetxattr-func
    desc: Set extended attribute by fd
    crit: notable
    conf: 0.66
    for: [macho, so, dylib, c]
    if:
      type: symbol
      exact: "fsetxattr"

  - id: lsetxattr-func
    desc: Set extended attribute (no symlink)
    crit: notable
    conf: 0.66
    for: [macho, so, dylib, c]
    if:
      type: symbol
      exact: "lsetxattr"

  - id: xattr-get-getxattr
    desc: Read extended file attribute value
    crit: notable
    conf: 0.75
    if:
      type: symbol
      exact: "getxattr"

  - id: xattr-get-fgetxattr
    desc: Read extended file attribute value by fd
    crit: notable
    conf: 0.75
    if:
      type: symbol
      exact: "fgetxattr"

  - id: xattr-get-lgetxattr
    desc: Read extended file attribute value
    crit: notable
    conf: 0.75
    if:
      type: symbol
      exact: "lgetxattr"

  - id: xattr-remove-removexattr
    desc: Remove extended file attribute value
    crit: notable
    conf: 0.66
    if:
      type: symbol
      exact: "removexattr"

  - id: xattr-remove-fremovexattr
    desc: Remove extended file attribute value by fd
    crit: notable
    conf: 0.66
    if:
      type: symbol
      exact: "fremovexattr"

  - id: xattr-remove-lremovexattr
    desc: Remove extended file attribute value (no symlink)
    crit: notable
    conf: 0.66
    if:
      type: symbol
      exact: "lremovexattr"

  - id: xattr-list-listxattr
    desc: Enumerate extended file attributes
    crit: notable
    conf: 0.75
    if:
      type: symbol
      exact: "listxattr"

  - id: xattr-list-flistxattr
    desc: Enumerate extended file attributes by fd
    crit: notable
    conf: 0.75
    if:
      type: symbol
      exact: "flistxattr"

  - id: xattr-list-llistxattr
    desc: Enumerate extended file attributes
    crit: notable
    conf: 0.75
    if:
      type: symbol
      exact: "llistxattr"

composite_rules:
  - id: xattr-get
    desc: Read extended file attribute value
    crit: notable
    conf: 0.75
    any:
      - id: xattr-get-getxattr
      - id: xattr-get-fgetxattr
      - id: xattr-get-lgetxattr

  - id: xattr-remove
    desc: Remove extended file attribute value
    crit: notable
    conf: 0.66
    any:
      - id: xattr-remove-removexattr
      - id: xattr-remove-fremovexattr
      - id: xattr-remove-lremovexattr

  - id: xattr-list
    desc: Enumerate extended file attributes
    crit: notable
    conf: 0.75
    any:
      - id: xattr-list-listxattr
      - id: xattr-list-flistxattr
      - id: xattr-list-llistxattr
