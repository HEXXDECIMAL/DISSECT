# Execution - TTY/PTY Operations
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  - id: exec/tty/openpty
    description: Open pseudoterminal
    criticality: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [elf, macho, python]
    condition:
      type: string
      regex: "(openpty|pty\\.Open)"

  - id: exec/tty/isatty
    description: Check if terminal
    criticality: notable
    confidence: 0.7
    attack: "T1059"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "isatty"

  - id: exec/tty/ttyname
    description: Get terminal device pathname
    criticality: suspicious
    confidence: 0.8
    attack: "T1059"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "ttyname"

  - id: exec/tty/tcgetattr
    description: Get terminal attributes
    criticality: notable
    confidence: 0.75
    attack: "T1059"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "tcgetattr"

  - id: exec/tty/tcsetattr
    description: Set terminal attributes
    criticality: notable
    confidence: 0.75
    attack: "T1059"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "tcsetattr"

  - id: exec/tty/vhangup
    description: Virtual terminal hangup
    criticality: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [elf]
    condition:
      type: string
      exact: "vhangup"

  - id: exec/tty/getpass
    description: Terminal password prompt
    criticality: suspicious
    confidence: 0.8
    attack: "T1056"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getpass"

  - id: exec/tty/setupterm
    description: Terminal initialization
    criticality: notable
    confidence: 0.7
    attack: "T1059"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "setupterm"

  - id: exec/tty/python-pty
    description: Python PTY module
    criticality: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [python]
    condition:
      type: string
      regex: "(import pty|from pty import)"

  - id: exec/tty/pty-spawn
    description: Python PTY spawn
    criticality: suspicious
    confidence: 0.9
    attack: "T1059"
    file_types: [python]
    condition:
      type: string
      exact: "pty.spawn"

composite_rules:
  - id: exec/tty/interactive-shell
    description: Interactive shell via PTY
    criticality: suspicious
    confidence: 0.95
    attack: "T1059"
    mbc: "B0022"
    file_types: [elf, macho, python]
    condition:
      type: yara
      source: |
        rule interactive_pty_shell {
          strings:
            $openpty = "openpty" fullword
            $pty_open = "pty.Open"
            $pty_spawn = "pty.spawn"
            $bin_sh = "/bin/sh"
            $bin_bash = "/bin/bash"
            $dup2 = "dup2" fullword
            $fork = "fork" fullword
            $execve = "execve" fullword
          condition:
            filesize < 10MB and
            (any of ($openpty, $pty_open, $pty_spawn)) and
            (any of ($bin_sh, $bin_bash) or ($dup2 and $fork and $execve))
        }
