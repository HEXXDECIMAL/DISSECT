# Automatic Dependency Installation - Python pip
# Detects runtime package installation, common in malware droppers
# ATT&CK: T1059.006 (Command and Scripting Interpreter: Python)

defaults:
  for: [python]
  mbc: "B0024"
  attack: "T1059.006"
  crit: suspicious

traits:
  # subprocess pip install - most common pattern
  - id: subprocess-install
    desc: "Runtime pip install via subprocess"
    conf: 0.9
    if:
      type: string
      regex: "subprocess\\.[a-z_]+\\([^)]*pip[^)]*install"

  # sys.executable -m pip pattern
  - id: sys-executable
    desc: "pip install using sys.executable"
    conf: 0.95
    if:
      type: string
      regex: "sys\\.executable[^)]*-m[^)]*pip[^)]*install"

  # os.system pip install
  - id: os-system
    desc: "Runtime pip install via os.system"
    conf: 0.9
    if:
      type: string
      regex: "os\\.system\\([^)]*pip[^)]*install"

  # importlib fallback pattern (try import, except install)
  - id: try-import-install
    desc: "Try-except import with fallback pip install"
    conf: 0.85
    if:
      type: string
      # Matches pattern in try/except blocks
      regex: "except[^:]*:.*pip.*install|ImportError.*pip.*install"

  # pip.main() direct call
  - id: main-call
    desc: "Direct pip.main() installation"
    conf: 0.9
    if:
      type: string
      regex: "pip\\.main\\(\\[.*install"

  # ensurepip module usage
  - id: ensurepip
    desc: "pip bootstrapping via ensurepip"
    conf: 0.8
    crit: notable
    if:
      type: string
      regex: "ensurepip"

  # YARA-based try/except import with pip install detection
  - id: yara-pip-fallback-install
    desc: "YARA detection for try import with pip install fallback"
    conf: 0.95
    if:
      type: yara
      source: |
        rule pip_fallback_install {
          meta:
            description = "Try import with pip install fallback"
          strings:
            $try = "try:" ascii
            $except = /except[^:]*:/ ascii
            $import = /import\s+\w+/ ascii
            $pip = /pip.*install/ ascii
          condition:
            all of them
        }

composite_rules:
  # Combination: try/except import with immediate pip install
  - id: fallback-install
    desc: "Import fallback with automatic pip install"
    conf: 0.95
    crit: suspicious
    requires_all:
      - id: yara-pip-fallback-install
