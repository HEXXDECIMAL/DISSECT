# Dynamic Eval Execution - JavaScript/Node.js
# Detects eval() usage patterns that indicate dynamic code execution
# ATT&CK: T1059.007 (Command and Scripting Interpreter: JavaScript)

traits:
  # === Eval function reference atomic indicators ===
  - id: eval-as-first-arg
    desc: eval as first argument (eval,
    crit: inert
    conf: 0.7
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      regex: "\\(eval\\s*,"

  - id: eval-as-last-arg
    desc: eval as last argument ,eval)
    crit: inert
    conf: 0.7
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      regex: ",\\s*eval\\)"

  - id: eval-variable
    desc: eval with variable argument
    crit: suspicious
    conf: 0.9
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      regex: "eval\\s*\\(\\s*[a-zA-Z_$][a-zA-Z0-9_$]*\\s*\\)"

  # === Function constructor atomic indicators ===
  - id: new-function-constructor
    desc: new Function() constructor
    crit: inert
    conf: 0.8
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      regex: "new\\s+Function\\s*\\("

  - id: function-constructor-call
    desc: Function() constructor call
    crit: inert
    conf: 0.8
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      regex: "Function\\s*\\("

  # === VM runIn atomic indicators ===
  - id: vm-runIn-method
    desc: vm.runIn method
    crit: inert
    conf: 0.7
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      regex: "vm\\.runIn"

  - id: runInContext-call
    desc: runInContext call
    crit: inert
    conf: 0.7
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      exact: "runInContext"

  - id: runInNewContext-call
    desc: runInNewContext call
    crit: inert
    conf: 0.7
    attack: "T1059.007"
    for: [javascript]
    if:
      type: string
      exact: "runInNewContext"

composite_rules:
  - id: eval-function-reference
    desc: eval passed as function reference
    crit: suspicious
    conf: 0.95
    attack: "T1059.007"
    for: [javascript]
    count_min: 1
    any:
      - id: eval-as-first-arg
      - id: eval-as-last-arg

  - id: Function-constructor
    desc: Function constructor (dynamic code execution)
    crit: suspicious
    conf: 0.95
    attack: "T1059.007"
    for: [javascript]
    count_min: 1
    any:
      - id: new-function-constructor
      - id: function-constructor-call

  - id: vm-runInContext
    desc: Node.js VM runInContext (sandboxed eval)
    crit: suspicious
    conf: 0.85
    attack: "T1059.007"
    for: [javascript]
    count_min: 1
    any:
      - id: vm-runIn-method
      - id: runInContext-call
      - id: runInNewContext-call
