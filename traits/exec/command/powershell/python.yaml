# PowerShell Execution from Python
# Detects malicious use of PowerShell for downloads or execution

traits:
  - id: python-download
    description: "Downloads file via PowerShell and curl.exe"
    criticality: suspicious
    confidence: 0.9
    file_types: [python]
    condition:
      type: string
      regex: "powershell.*curl\\.exe.*-o"

  - id: python-start-process
    description: "Executes process via PowerShell Start-Process"
    criticality: suspicious
    confidence: 0.9
    file_types: [python]
    condition:
      type: string
      regex: "powershell.*Start-Process"

  # === System masquerade atomic indicators ===
  - id: masq-realtek
    description: "Masquerades as Realtek audio process"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "RealtekHDAudio"

  - id: masq-windowsupdate
    description: "Masquerades as Windows Update process"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "WindowsUpdate"

  - id: masq-lsass
    description: "Masquerades as lsass process"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "lsass"

  - id: masq-svchost
    description: "Masquerades as svchost process"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "svchost"

composite_rules:
  # System masquerade composite
  - id: system-masquerade
    description: "Masquerades as system process"
    criticality: suspicious
    confidence: 0.8
    requires_count: 1
    conditions:
      - id: masq-realtek
      - id: masq-windowsupdate
      - id: masq-lsass
      - id: masq-svchost

  - id: powershell-dropper
    description: "PowerShell-based dropper (Download + Execute)"
    criticality: suspicious
    confidence: 0.98
    attack: "T1059.001"
    mbc: "E1059"
    file_types: [python]
    requires_all:
      - id: exec/command/powershell/python-download
      - id: exec/command/powershell/python-start-process
      - id: exec/command/powershell/system-masquerade

