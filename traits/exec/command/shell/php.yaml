# PHP Command Execution Traits
# MBC: E1059 (Command and Scripting Interpreter)
# ATT&CK: T1059.004 (Unix Shell)

defaults:
  for: [php]
  crit: suspicious
  mbc: "E1059"
  attack: "T1059.004"

traits:
  - id: exec
    desc: Shell command execution via exec()
    conf: 0.95
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "exec"

  - id: shell-exec
    desc: Shell command execution via shell_exec()
    conf: 0.95
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "shell_exec"

  - id: system
    desc: Shell command execution via system()
    conf: 0.95
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "system"

  - id: passthru
    desc: Shell command execution via passthru()
    conf: 0.95
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "passthru"

  - id: popen
    desc: Process open via popen()
    conf: 0.9
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "popen"

  - id: proc-open
    desc: Process execution via proc_open()
    conf: 0.9
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "proc_open"

  - id: pcntl-exec
    desc: Direct process execution via pcntl_exec()
    conf: 0.95
    attack: "T1059"  # Override: generic T1059 instead of T1059.004
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "pcntl_exec"

  - id: backtick
    desc: Shell command execution via backticks
    conf: 0.9
    if:
      type: ast_pattern
      node_type: shell_command_expression
      pattern: ".{0,500}"
      regex: true

  - id: exec-user-input
    desc: Command execution with user input (RCE)
    conf: 0.9
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "(exec|system|shell_exec|passthru|popen)\\s*\\([^)]*\\$_(GET|POST|REQUEST)"
      regex: true
