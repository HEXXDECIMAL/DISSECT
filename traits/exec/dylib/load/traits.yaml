# Execution - Dynamic Library Loading
# ATT&CK: T1574.006 (Dynamic Linker Hijacking)

traits:
  - id: dlopen
    desc: Dynamic library loading via dlopen
    crit: notable
    conf: 0.9
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: string
      exact: "dlopen"

  - id: dlsym
    desc: Dynamic symbol resolution via dlsym
    crit: notable
    conf: 0.9
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: string
      exact: "dlsym"

  - id: dlclose
    desc: Dynamic library unload
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: string
      exact: "dlclose"

  - id: dlerror
    desc: Dynamic linker error handling
    crit: notable
    conf: 0.8
    attack: "T1574.006"
    for: [elf, macho]
    if:
      type: string
      exact: "dlerror"

  # LoadLibrary (Windows)
  - id: loadlibrary
    desc: Runtime library loading via LoadLibrary
    crit: notable
    conf: 0.9
    attack: "T1574.002"
    for: [pe]
    if:
      type: yara
      source: |
        rule loadlibrary_load {
          strings:
            $ll1 = "LoadLibrary" ascii wide
            $ll2 = "LoadLibraryA" ascii
            $ll3 = "LoadLibraryW" ascii
            $ll4 = "LoadLibraryEx" ascii wide
            $gpa = "GetProcAddress" ascii wide
          condition:
            any of ($ll*) or $gpa
        }

  - id: nsbundle
    desc: macOS NSBundle loading
    crit: notable
    conf: 0.6
    attack: "T1574.006"
    for: [macho]
    if:
      type: string
      exact: "NSBundle"

  - id: ctypes-windll
    desc: Python ctypes Windows DLL
    crit: suspicious
    conf: 0.85
    attack: "T1574.002"
    for: [python]
    if:
      type: string
      regex: "windll\\.[\\w.]+"

  # === ctypes CDLL atomic indicators ===
  - id: ctypes-cdll-dot
    desc: ctypes.CDLL pattern
    crit: notable
    conf: 0.7
    attack: "T1574"
    for: [python]
    if:
      type: string
      exact: "ctypes.CDLL"

  - id: cdll-paren
    desc: CDLL( call pattern
    crit: notable
    conf: 0.7
    attack: "T1574"
    for: [python]
    if:
      type: string
      regex: "CDLL\\("

  - id: local-load
    desc: Loading dynamic library from local path
    crit: suspicious
    conf: 0.9
    attack: "T1574"
    for: [python]
    if:
      type: yara
      source: |
        rule local_dylib_load {
          strings:
            $cdll = "CDLL"
            $load = "LoadLibrary"
            $path1 = "__file__"
            $path2 = "dirname"
            $path3 = "abspath"
          condition:
            ($cdll or $load) and any of ($path*)
        }

  - id: ruby-dlopen
    desc: Ruby FFI dlopen
    crit: suspicious
    conf: 0.85
    attack: "T1574.006"
    for: [ruby]
    if:
      type: string
      regex: "\\.dlopen\\("

  - id: java-loadclass
    desc: Java runtime class loading
    crit: suspicious
    conf: 0.85
    attack: "T1574"
    for: [java, class]
    if:
      type: string
      exact: "loadReplacementClass"

composite_rules:
  # Core dlopen + dlsym pattern (basic dynamic loading)
  - id: dlopen-dlsym
    desc: Core dlopen/dlsym pattern
    crit: notable
    conf: 0.85
    attack: "T1574.006"
    for: [elf, macho]
    requires_all:
      - id: dlopen
      - id: dlsym

  # dl* family function
  - id: dl-function
    desc: Any dl* function usage
    crit: notable
    conf: 0.7
    attack: "T1574.006"
    for: [elf, macho]
    requires_count: 1
    any:
      - id: dlopen
      - id: dlsym
      - id: dlclose
      - id: dlerror

  # NSBundle with dynamic loading
  - id: nsbundle-dynamic
    desc: NSBundle with dynamic loading APIs
    crit: suspicious
    conf: 0.85
    attack: "T1574.006"
    for: [macho]
    requires_all:
      - id: nsbundle
      - id: dl-function

  - id: dynamic-loader-detected
    desc: Dynamic code loading pattern
    crit: suspicious
    conf: 0.9
    attack: "T1574.006"
    mbc: "B0023"
    for: [elf, macho]
    requires_count: 1
    any:
      - id: dlopen-dlsym
      - id: nsbundle-dynamic

  # ctypes CDLL composite
  - id: ctypes-cdll
    desc: Python ctypes CDLL loading
    crit: suspicious
    conf: 0.85
    attack: "T1574"
    for: [python]
    requires_count: 1
    any:
      - id: ctypes-cdll-dot
      - id: cdll-paren
