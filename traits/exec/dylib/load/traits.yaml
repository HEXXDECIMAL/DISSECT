# Execution - Dynamic Library Loading
# ATT&CK: T1574.006 (Dynamic Linker Hijacking)

traits:
  - id: dlopen
    description: Dynamic library loading via dlopen
    criticality: notable
    confidence: 0.9
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlopen"

  - id: dlsym
    description: Dynamic symbol resolution via dlsym
    criticality: notable
    confidence: 0.9
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlsym"

  - id: dlclose
    description: Dynamic library unload
    criticality: notable
    confidence: 0.8
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlclose"

  - id: dlerror
    description: Dynamic linker error handling
    criticality: notable
    confidence: 0.8
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlerror"

  # LoadLibrary (Windows)
  - id: loadlibrary
    description: Runtime library loading via LoadLibrary
    criticality: notable
    confidence: 0.9
    attack: "T1574.002"
    file_types: [pe]
    condition:
      type: yara
      source: |
        rule loadlibrary_load {
          strings:
            $ll1 = "LoadLibrary" ascii wide
            $ll2 = "LoadLibraryA" ascii
            $ll3 = "LoadLibraryW" ascii
            $ll4 = "LoadLibraryEx" ascii wide
            $gpa = "GetProcAddress" ascii wide
          condition:
            any of ($ll*) or $gpa
        }

  - id: nsbundle
    description: macOS NSBundle loading
    criticality: notable
    confidence: 0.6
    attack: "T1574.006"
    file_types: [macho]
    condition:
      type: string
      exact: "NSBundle"

  - id: ctypes-windll
    description: Python ctypes Windows DLL
    criticality: suspicious
    confidence: 0.85
    attack: "T1574.002"
    file_types: [python]
    condition:
      type: string
      regex: "windll\\.[\\w.]+"

  - id: ctypes-cdll
    description: Python ctypes CDLL loading
    criticality: suspicious
    confidence: 0.85
    attack: "T1574"
    file_types: [python]
    condition:
      type: string
      regex: "ctypes\\.CDLL|CDLL\\("

  - id: local-load
    description: Loading dynamic library from local path
    criticality: suspicious
    confidence: 0.9
    attack: "T1574"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule local_dylib_load {
          strings:
            $cdll = "CDLL"
            $load = "LoadLibrary"
            $path1 = "__file__"
            $path2 = "dirname"
            $path3 = "abspath"
          condition:
            ($cdll or $load) and any of ($path*)
        }

  - id: ruby-dlopen
    description: Ruby FFI dlopen
    criticality: suspicious
    confidence: 0.85
    attack: "T1574.006"
    file_types: [ruby]
    condition:
      type: string
      regex: "\\.dlopen\\("

  - id: java-loadclass
    description: Java runtime class loading
    criticality: suspicious
    confidence: 0.85
    attack: "T1574"
    file_types: [java, class]
    condition:
      type: string
      exact: "loadReplacementClass"

composite_rules:
  - id: dynamic-loader-detected
    description: Dynamic code loading pattern
    criticality: suspicious
    confidence: 0.9
    attack: "T1574.006"
    mbc: "B0023"
    file_types: [elf, macho]
    requires_any:
      - requires_all:
          - type: trait
            id: dlopen
          - type: trait
            id: dlsym
      - requires_all:
          - type: trait
            id: dlopen
          - type: trait
            id: dlsym
          - type: trait
            id: dlclose
          - type: trait
            id: dlerror
      - requires_all:
          - type: trait
            id: nsbundle
          - requires_any:
              - type: trait
                id: dlopen
              - type: trait
                id: dlsym
              - type: trait
                id: dlclose
              - type: trait
                id: dlerror
