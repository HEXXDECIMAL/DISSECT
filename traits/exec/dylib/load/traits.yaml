# Execution - Dynamic Library Loading
# ATT&CK: T1574.006 (Dynamic Linker Hijacking)

traits:
  - id: dlopen
    description: Dynamic library loading via dlopen
    criticality: notable
    confidence: 0.9
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlopen"

  - id: dlsym
    description: Dynamic symbol resolution via dlsym
    criticality: notable
    confidence: 0.9
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlsym"

  - id: dlclose
    description: Dynamic library unload
    criticality: notable
    confidence: 0.8
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlclose"

  - id: dlerror
    description: Dynamic linker error handling
    criticality: notable
    confidence: 0.8
    attack: "T1574.006"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "dlerror"

  # LoadLibrary (Windows)
  - id: loadlibrary
    description: Runtime library loading via LoadLibrary
    criticality: notable
    confidence: 0.9
    attack: "T1574.002"
    file_types: [pe]
    condition:
      type: yara
      source: |
        rule loadlibrary_load {
          strings:
            $ll1 = "LoadLibrary" ascii wide
            $ll2 = "LoadLibraryA" ascii
            $ll3 = "LoadLibraryW" ascii
            $ll4 = "LoadLibraryEx" ascii wide
            $gpa = "GetProcAddress" ascii wide
          condition:
            any of ($ll*) or $gpa
        }

  - id: nsbundle
    description: macOS NSBundle loading
    criticality: notable
    confidence: 0.6
    attack: "T1574.006"
    file_types: [macho]
    condition:
      type: string
      exact: "NSBundle"

  - id: ctypes-windll
    description: Python ctypes Windows DLL
    criticality: suspicious
    confidence: 0.85
    attack: "T1574.002"
    file_types: [python]
    condition:
      type: string
      regex: "windll\\.[\\w.]+"

  # === ctypes CDLL atomic indicators ===
  - id: ctypes-cdll-dot
    description: ctypes.CDLL pattern
    criticality: notable
    confidence: 0.7
    attack: "T1574"
    file_types: [python]
    condition:
      type: string
      exact: "ctypes.CDLL"

  - id: cdll-paren
    description: CDLL( call pattern
    criticality: notable
    confidence: 0.7
    attack: "T1574"
    file_types: [python]
    condition:
      type: string
      regex: "CDLL\\("

  - id: local-load
    description: Loading dynamic library from local path
    criticality: suspicious
    confidence: 0.9
    attack: "T1574"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule local_dylib_load {
          strings:
            $cdll = "CDLL"
            $load = "LoadLibrary"
            $path1 = "__file__"
            $path2 = "dirname"
            $path3 = "abspath"
          condition:
            ($cdll or $load) and any of ($path*)
        }

  - id: ruby-dlopen
    description: Ruby FFI dlopen
    criticality: suspicious
    confidence: 0.85
    attack: "T1574.006"
    file_types: [ruby]
    condition:
      type: string
      regex: "\\.dlopen\\("

  - id: java-loadclass
    description: Java runtime class loading
    criticality: suspicious
    confidence: 0.85
    attack: "T1574"
    file_types: [java, class]
    condition:
      type: string
      exact: "loadReplacementClass"

composite_rules:
  # Core dlopen + dlsym pattern (basic dynamic loading)
  - id: dlopen-dlsym
    description: Core dlopen/dlsym pattern
    criticality: notable
    confidence: 0.85
    attack: "T1574.006"
    file_types: [elf, macho]
    requires_all:
      - id: dlopen
      - id: dlsym

  # dl* family function
  - id: dl-function
    description: Any dl* function usage
    criticality: notable
    confidence: 0.7
    attack: "T1574.006"
    file_types: [elf, macho]
    requires_count: 1
    conditions:
      - id: dlopen
      - id: dlsym
      - id: dlclose
      - id: dlerror

  # NSBundle with dynamic loading
  - id: nsbundle-dynamic
    description: NSBundle with dynamic loading APIs
    criticality: suspicious
    confidence: 0.85
    attack: "T1574.006"
    file_types: [macho]
    requires_all:
      - id: nsbundle
      - id: dl-function

  - id: dynamic-loader-detected
    description: Dynamic code loading pattern
    criticality: suspicious
    confidence: 0.9
    attack: "T1574.006"
    mbc: "B0023"
    file_types: [elf, macho]
    requires_count: 1
    conditions:
      - id: dlopen-dlsym
      - id: nsbundle-dynamic

  # ctypes CDLL composite
  - id: ctypes-cdll
    description: Python ctypes CDLL loading
    criticality: suspicious
    confidence: 0.85
    attack: "T1574"
    file_types: [python]
    requires_count: 1
    conditions:
      - id: ctypes-cdll-dot
      - id: cdll-paren
