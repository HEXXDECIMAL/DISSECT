# Downloaded Script Execution
# Detects patterns where scripts are downloaded and executed
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  - id: perl-execute
    desc: Perl script execution
    crit: notable
    conf: 0.75
    mbc: "C0059"
    attack: "T1059.006"
    for: [all]
    if:
      type: string
      regex: "perl\\s+[/\\w.-]+"
      search_raw: true

  - id: python-execute
    desc: Python script execution
    crit: notable
    conf: 0.7
    mbc: "C0059"
    attack: "T1059.006"
    for: [all]
    if:
      type: string
      regex: "python[23]?\\s+[/\\w.-]+"
      search_raw: true

  - id: ruby-execute
    desc: Ruby script execution
    crit: notable
    conf: 0.7
    mbc: "C0059"
    attack: "T1059.005"
    for: [all]
    if:
      type: string
      regex: "ruby\\s+[/\\w.-]+"
      search_raw: true

  - id: node-execute
    desc: Node.js script execution
    crit: notable
    conf: 0.7
    mbc: "C0059"
    attack: "T1059.007"
    for: [all]
    if:
      type: string
      regex: "node\\s+[/\\w.-]+"
      search_raw: true

  # === Shell execute atomic indicators ===
  - id: sh-execute-cmd
    desc: sh script execution
    crit: inert
    conf: 0.6
    mbc: "C0059"
    attack: "T1059.004"
    for: [all]
    if:
      type: string
      regex: "sh\\s+[/\\w.-]+"
      search_raw: true

  - id: bash-execute-cmd
    desc: bash script execution
    crit: inert
    conf: 0.6
    mbc: "C0059"
    attack: "T1059.004"
    for: [all]
    if:
      type: string
      regex: "bash\\s+[/\\w.-]+"
      search_raw: true

  - id: zsh-execute-cmd
    desc: zsh script execution
    crit: inert
    conf: 0.6
    mbc: "C0059"
    attack: "T1059.004"
    for: [all]
    if:
      type: string
      regex: "zsh\\s+[/\\w.-]+"
      search_raw: true

  # === Pipe to shell atomic indicators ===
  - id: pipe-to-sh
    desc: Pipe to sh
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.004"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*sh\\b"
      search_raw: true

  - id: pipe-to-bash
    desc: Pipe to bash
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.004"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*bash\\b"
      search_raw: true

  - id: pipe-to-zsh
    desc: Pipe to zsh
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.004"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*zsh\\b"
      search_raw: true

  - id: pipe-to-perl
    desc: Pipe to perl
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.006"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*perl\\b"
      search_raw: true

  - id: pipe-to-python
    desc: Pipe to python
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.006"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*python"
      search_raw: true

  - id: pipe-to-ruby
    desc: Pipe to ruby
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.005"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*ruby\\b"
      search_raw: true

  - id: pipe-to-node
    desc: Pipe to node
    crit: notable
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.007"
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "\\|\\s*node\\b"
      search_raw: true

  - id: download-pipe-execute
    desc: Download and pipe to interpreter
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059"
    # Exclude JS - syntax highlighters have keyword lists that trigger false positives
    for: [shell, elf, macho, pe]
    if:
      type: string
      regex: "(curl|wget).{0,100}(\\||&&).{0,20}(sh|bash|perl|python|ruby|node)"
      search_raw: true

composite_rules:
  # Shell execute composite
  - id: sh-execute
    desc: Shell script execution
    crit: notable
    conf: 0.7
    mbc: "C0059"
    attack: "T1059.004"
    for: [all]
    count_min: 1
    any:
      - id: sh-execute-cmd
      - id: bash-execute-cmd
      - id: zsh-execute-cmd

  # Pipe to shell composite
  - id: pipe-to-shell
    desc: Pipe to shell execution (very suspicious)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059.004"
    for: [shell, elf, macho, pe]
    count_min: 1
    any:
      - id: pipe-to-sh
      - id: pipe-to-bash
      - id: pipe-to-zsh
      - id: pipe-to-perl
      - id: pipe-to-python
      - id: pipe-to-ruby
      - id: pipe-to-node
