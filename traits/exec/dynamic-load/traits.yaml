# Dynamic Loading Patterns
# These patterns can be legitimate but are also used by malware
# Useful for ML classification and behavioral analysis

traits:
  # dlopen/dlsym (Linux/macOS)
  - id: dlopen
    description: Runtime library loading via dlopen
    criticality: notable
    confidence: 0.9
    platforms: [linux, macos, unix]
    file_types: [elf, macho, so, dylib]
    condition:
      type: yara
      source: |
        rule dlopen_load {
          strings:
            $dlopen = "dlopen" ascii
            $dlsym = "dlsym" ascii
            $dlclose = "dlclose" ascii
            $dlerror = "dlerror" ascii
          condition:
            $dlopen or ($dlsym and any of ($dlclose, $dlerror))
        }

  # LoadLibrary (Windows)
  - id: loadlibrary
    description: Runtime library loading via LoadLibrary
    criticality: notable
    confidence: 0.9
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: yara
      source: |
        rule loadlibrary_load {
          strings:
            $ll1 = "LoadLibrary" ascii wide
            $ll2 = "LoadLibraryA" ascii
            $ll3 = "LoadLibraryW" ascii
            $ll4 = "LoadLibraryEx" ascii wide
            $gpa = "GetProcAddress" ascii wide
          condition:
            any of ($ll*) or $gpa
        }

  # Python dynamic import
  - id: python-import
    description: Python dynamic import patterns
    criticality: notable
    confidence: 0.85
    file_types: [python]
    condition:
      type: yara
      source: |
        rule python_dynamic_import {
          strings:
            $imp1 = "__import__" ascii
            $imp2 = "importlib.import_module" ascii
            $imp3 = "exec(compile" ascii
            $imp4 = "importlib.util" ascii
          condition:
            any of them
        }

  # Java reflection loading
  - id: java-reflection
    description: Java reflection class loading
    criticality: notable
    confidence: 0.85
    file_types: [class, java]
    condition:
      type: yara
      source: |
        rule java_reflection_load {
          strings:
            $ref1 = "Class.forName" ascii
            $ref2 = "ClassLoader" ascii
            $ref3 = "defineClass" ascii
            $ref4 = "loadClass" ascii
            $ref5 = "newInstance" ascii
          condition:
            2 of them
        }

  # .NET reflection loading
  - id: dotnet-reflection
    description: .NET reflection assembly loading
    criticality: notable
    confidence: 0.85
    platforms: [windows]
    file_types: [pe, dll, csharp]
    condition:
      type: yara
      source: |
        rule dotnet_reflection_load {
          strings:
            $ref1 = "Assembly.Load" ascii wide
            $ref2 = "Assembly.LoadFrom" ascii wide
            $ref3 = "Activator.CreateInstance" ascii wide
            $ref4 = "Type.GetType" ascii wide
            $ref5 = "MethodInfo.Invoke" ascii wide
          condition:
            any of them
        }

  # Go plugin loading
  - id: go-plugin
    description: Go plugin dynamic loading
    criticality: notable
    confidence: 0.9
    file_types: [elf, macho, pe, go]
    condition:
      type: yara
      source: |
        rule go_plugin_load {
          strings:
            $plug1 = "plugin.Open" ascii
            $plug2 = "plugin.Lookup" ascii
            $plug3 = "plugin.Symbol" ascii
          condition:
            any of them
        }

  # JIT compilation indicators
  - id: jit
    description: JIT compilation patterns
    criticality: notable
    confidence: 0.8
    file_types: [pe, elf, macho, dll, so, dylib]
    condition:
      type: yara
      source: |
        rule jit_compilation {
          strings:
            $jit1 = "mprotect" ascii
            $jit2 = "VirtualProtect" ascii wide
            $jit3 = "PAGE_EXECUTE" ascii wide
            $jit4 = "PROT_EXEC" ascii
            $mmap = "mmap" ascii
            $rwx = "MAP_ANONYMOUS" ascii
          condition:
            any of ($jit*) or ($mmap and $rwx)
        }

composite_rules:
  # Suspicious dynamic loading with memory execution
  - id: memory-exec
    description: Dynamic loading with executable memory allocation
    criticality: suspicious
    confidence: 0.85
    requires_all:
      - type: trait
        id: jit
    requires_any:
      - type: trait
        id: dlopen
      - type: trait
        id: loadlibrary
