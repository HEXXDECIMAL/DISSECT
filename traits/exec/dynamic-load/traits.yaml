# Dynamic Loading Patterns
# These patterns can be legitimate but are also used by malware
# Useful for ML classification and behavioral analysis

traits:
  # dlopen/dlsym (Linux/macOS)
  - id: dlopen
    desc: Runtime library loading via dlopen
    crit: notable
    conf: 0.9
    platforms: [linux, macos, unix]
    file_types: [elf, macho, so, dylib]
    if:
      type: yara
      source: |
        rule dlopen_load {
          strings:
            $dlopen = "dlopen" ascii
            $dlsym = "dlsym" ascii
            $dlclose = "dlclose" ascii
            $dlerror = "dlerror" ascii
          condition:
            $dlopen or ($dlsym and any of ($dlclose, $dlerror))
        }

  # LoadLibrary (Windows)
  - id: loadlibrary
    desc: Runtime library loading via LoadLibrary
    crit: notable
    conf: 0.9
    platforms: [windows]
    file_types: [pe, dll]
    if:
      type: yara
      source: |
        rule loadlibrary_load {
          strings:
            $ll1 = "LoadLibrary" ascii wide
            $ll2 = "LoadLibraryA" ascii
            $ll3 = "LoadLibraryW" ascii
            $ll4 = "LoadLibraryEx" ascii wide
            $gpa = "GetProcAddress" ascii wide
          condition:
            any of ($ll*) or $gpa
        }

  # Python dynamic import
  - id: python-import
    desc: Python dynamic import patterns
    crit: notable
    conf: 0.85
    file_types: [python]
    if:
      type: yara
      source: |
        rule python_dynamic_import {
          strings:
            $imp1 = "__import__" ascii
            $imp2 = "importlib.import_module" ascii
            $imp3 = "exec(compile" ascii
            $imp4 = "importlib.util" ascii
          condition:
            any of them
        }

  # Java reflection loading
  - id: java-reflection
    desc: Java reflection class loading
    crit: notable
    conf: 0.85
    file_types: [class, java]
    if:
      type: yara
      source: |
        rule java_reflection_load {
          strings:
            $ref1 = "Class.forName" ascii
            $ref2 = "ClassLoader" ascii
            $ref3 = "defineClass" ascii
            $ref4 = "loadClass" ascii
            $ref5 = "newInstance" ascii
          condition:
            2 of them
        }

  # .NET reflection loading
  - id: dotnet-reflection
    desc: .NET reflection assembly loading
    crit: notable
    conf: 0.85
    platforms: [windows]
    file_types: [pe, dll, csharp]
    if:
      type: yara
      source: |
        rule dotnet_reflection_load {
          strings:
            $ref1 = "Assembly.Load" ascii wide
            $ref2 = "Assembly.LoadFrom" ascii wide
            $ref3 = "Activator.CreateInstance" ascii wide
            $ref4 = "Type.GetType" ascii wide
            $ref5 = "MethodInfo.Invoke" ascii wide
          condition:
            any of them
        }

  # Go plugin loading
  - id: go-plugin
    desc: Go plugin dynamic loading
    crit: notable
    conf: 0.9
    file_types: [elf, macho, pe, go]
    if:
      type: yara
      source: |
        rule go_plugin_load {
          strings:
            $plug1 = "plugin.Open" ascii
            $plug2 = "plugin.Lookup" ascii
            $plug3 = "plugin.Symbol" ascii
          condition:
            any of them
        }

  # Executable memory allocation
  - id: executable-memory
    desc: Allocates or modifies executable memory
    crit: notable
    conf: 0.8
    file_types: [pe, elf, macho, dll, so, dylib]
    if:
      type: yara
      source: |
        rule executable_memory_ops {
          strings:
            $mprot = "mprotect" ascii
            $vprot = "VirtualProtect" ascii wide
            $p_exec = "PROT_EXEC" ascii
            $pg_exec = "PAGE_EXECUTE" ascii wide
            $mmap = "mmap" ascii
            $rwx = "MAP_ANONYMOUS" ascii
          condition:
            ($mmap and $rwx and ($mprot or $p_exec or $pg_exec)) or
            ($vprot and $pg_exec)
        }

  # JIT runtime references
  - id: jit-runtime-ref
    desc: JIT compilation runtime reference
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "(?i)jit_compile|jit_runtime|libjit|LuaJIT|V8 JIT"

composite_rules:
  # JIT compilation indicators
  - id: jit
    desc: JIT compilation patterns
    crit: notable
    conf: 0.85
    all:
      - id: executable-memory
      - id: jit-runtime-ref

  # Suspicious dynamic loading with memory execution
  - id: memory-exec
    desc: Dynamic loading with executable memory
    crit: suspicious
    conf: 0.85
    all:
      - id: executable-memory
    any:
      - id: dlopen
      - id: loadlibrary
