# HTTP download and execute patterns (Python)
# MBC: B0024 (Dropper)
# ATT&CK: T1105 (Ingress Tool Transfer)

defaults:
  for: [python]
  mbc: "B0024"
  attack: "T1105"
  crit: suspicious

traits:
  # === HTTP library atomic indicators ===
  - id: requests-get
    desc: requests.get call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "requests.get"

  - id: requests-post
    desc: requests.post call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "requests.post"

  - id: urllib-request
    desc: urllib.request module
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "urllib.request"

  - id: http-client
    desc: http.client module
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "http.client"

  - id: urlopen-call
    desc: urlopen call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "urlopen\\("

  - id: urlretrieve-call
    desc: urlretrieve call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "urlretrieve\\("

  # === Directory atomic indicators ===
  - id: tmp-path
    desc: /tmp/ path literal
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: '"/tmp/'

  - id: tempfile-module
    desc: tempfile module
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "tempfile\\."

  - id: expanduser-home
    desc: os.path.expanduser with ~
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: 'os\\.path\\.expanduser\\([^)]*~'

  - id: path-home-call
    desc: Path.home() call
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "Path.home()"

  - id: environ-home
    desc: os.environ HOME access
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: 'os\\.environ.{0,30}HOME'

  # File operations
  - id: python-chmod
    desc: "File permission change"
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "os\\.chmod\\("

  - id: python-write-binary
    desc: "Binary file write"
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "open\\([^)]+['\"]wb['\"]\\)|write_bytes\\("

  - id: python-write-content
    desc: "Write downloaded content to file"
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "\\.write\\([^)]*\\.content\\)|write_bytes\\("

  # === Subprocess atomic indicators ===
  - id: subprocess-popen
    desc: subprocess.Popen call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "subprocess\\.Popen\\("

  - id: subprocess-run
    desc: subprocess.run call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "subprocess\\.run\\("

  - id: subprocess-call
    desc: subprocess.call call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "subprocess\\.call\\("

  - id: os-system-call
    desc: os.system call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "os\\.system\\("

  - id: exec-call
    desc: exec() call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "exec\\("

  # === C2 endpoint path atomic indicators ===
  - id: path-payload
    desc: /payload/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/payload/"
      search_raw: true

  - id: path-stage
    desc: /stage/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/stage/"
      search_raw: true

  - id: path-drop
    desc: /drop/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/drop/"
      search_raw: true

  - id: path-brow
    desc: /brow/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/brow/"
      search_raw: true

  - id: path-mclip
    desc: /mclip/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/mclip/"
      search_raw: true

  - id: path-clip
    desc: /clip/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/clip/"
      search_raw: true

  - id: path-steal
    desc: /steal/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/steal/"
      search_raw: true

  - id: path-grab
    desc: /grab/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/grab/"
      search_raw: true

  - id: path-exfil
    desc: /exfil/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/exfil/"
      search_raw: true

  - id: python-staged-yara
    desc: "Staged payload dropper via YARA"
    conf: 0.9
    crit: suspicious
    if:
      type: yara
      source: |
        rule staged_dropper {
          meta:
            description = "Multiple download functions or payload stages"
          strings:
            $download1 = /def download_\w+\(/ ascii
            $download2 = /def fetch_\w+\(/ ascii
            $payload = /payload|stage|phase/ ascii nocase
            $requests = /requests\.(get|post)\(/ ascii
            $write = /\.write\(/ ascii
            $popen = /subprocess\.(Popen|run|call)\(/ ascii
          condition:
            (2 of ($download*)) or
            ($requests and $write and $popen and $payload)
        }

composite_rules:
  # HTTP library composite
  - id: python-http-lib
    desc: Python HTTP library usage
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: requests-get
      - id: requests-post
      - id: urllib-request
      - id: http-client

  # HTTP download call composite
  - id: python-http-download-call
    desc: Python HTTP download function call
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: requests-get
      - id: requests-post
      - id: urlopen-call
      - id: urlretrieve-call

  # Temp directory composite
  - id: python-tmp-dir
    desc: Temporary directory access
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: tmp-path
      - id: tempfile-module

  # Home directory composite
  - id: python-home-dir
    desc: Home directory access
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: expanduser-home
      - id: path-home-call
      - id: environ-home

  # Subprocess execution composite
  - id: python-subprocess-exec
    desc: Subprocess execution
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: subprocess-popen
      - id: subprocess-run
      - id: subprocess-call

  # Code or process execution composite
  - id: python-exec-any
    desc: Code or process execution
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: subprocess-popen
      - id: subprocess-run
      - id: subprocess-call
      - id: os-system-call
      - id: exec-call

  # C2 endpoint path composite
  - id: python-endpoint-path
    desc: Suspicious C2 endpoint paths
    crit: suspicious
    conf: 0.85
    attack: "T1105"
    requires_count: 1
    any:
      - id: path-payload
      - id: path-stage
      - id: path-drop
      - id: path-brow
      - id: path-mclip
      - id: path-clip
      - id: path-steal
      - id: path-grab
      - id: path-exfil

  # Original rule - tmp directory dropper
  - id: tmp-dropper
    desc: "HTTP download to temp and execute"
    conf: 0.9
    requires_count: 3
    any:
      - id: python-http-lib
      - id: python-tmp-dir
      - id: python-chmod
      - id: python-subprocess-exec

  # Home directory dropper - downloads to hidden dir in home
  - id: home-dropper
    desc: "HTTP download to home directory and execute"
    conf: 0.95
    crit: suspicious
    requires_count: 3
    any:
      - id: python-http-download-call
      - id: python-home-dir
      - id: python-write-binary
      - id: python-exec-any

  # Generic download + write + execute (any location)
  - id: generic-dropper
    desc: "Download, write, and execute pattern"
    conf: 0.9
    requires_all:
      - id: python-http-lib
      - id: python-write-content
      - id: python-subprocess-exec

  # Staged dropper - download function called multiple times
  - id: staged-dropper
    desc: "Staged payload dropper"
    conf: 0.9
    crit: suspicious
    requires_all:
      - id: python-staged-yara
