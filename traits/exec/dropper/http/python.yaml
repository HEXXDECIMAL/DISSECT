# HTTP download and execute patterns (Python)
# MBC: B0024 (Dropper)
# ATT&CK: T1105 (Ingress Tool Transfer)

defaults:
  for: [python]
  mbc: "B0024"
  attack: "T1105"
  crit: suspicious

traits:
  # === HTTP library atomic indicators ===
  - id: requests-get
    desc: requests.get call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "requests.get"

  - id: requests-post
    desc: requests.post call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "requests.post"

  - id: urllib-request
    desc: urllib.request module
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "urllib.request"

  - id: http-client
    desc: http.client module
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "http.client"

  - id: urlopen-call
    desc: urlopen call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "urlopen\\("

  - id: urlretrieve-call
    desc: urlretrieve call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "urlretrieve\\("

  # === Directory atomic indicators ===
  - id: tmp-path
    desc: /tmp/ path literal
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: '"/tmp/'

  - id: tempfile-module
    desc: tempfile module
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "tempfile\\."

  - id: expanduser-home
    desc: os.path.expanduser with ~
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: 'os\\.path\\.expanduser\\([^)]*~'

  - id: path-home-call
    desc: Path.home() call
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "Path.home()"

  - id: environ-home
    desc: os.environ HOME access
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: 'os\\.environ.{0,30}HOME'

  # File operations
  - id: python-chmod
    desc: "File permission change"
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "os\\.chmod\\("

  - id: python-write-binary
    desc: "Binary file write"
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "open\\([^)]+['\"]wb['\"]\\)|write_bytes\\("

  - id: python-write-content
    desc: "Write downloaded content to file"
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "\\.write\\([^)]*\\.content\\)|write_bytes\\("

  - id: os-system-call
    desc: os.system call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "os\\.system\\("

  - id: exec-call
    desc: exec() call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "exec\\("

  # === C2 endpoint path atomic indicators ===
  - id: path-payload
    desc: /payload/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/payload/"
      search_raw: true

  - id: path-stage
    desc: /stage/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/stage/"
      search_raw: true

  - id: path-drop
    desc: /drop/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/drop/"
      search_raw: true

  - id: path-brow
    desc: /brow/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/brow/"
      search_raw: true

  - id: path-mclip
    desc: /mclip/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/mclip/"
      search_raw: true

  - id: path-clip
    desc: /clip/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/clip/"
      search_raw: true

  - id: path-steal
    desc: /steal/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/steal/"
      search_raw: true

  - id: path-grab
    desc: /grab/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/grab/"
      search_raw: true

  - id: path-exfil
    desc: /exfil/ endpoint path
    crit: inert
    conf: 0.6
    attack: "T1105"
    if:
      type: string
      exact: "/exfil/"
      search_raw: true

  - id: def-download
    desc: Function named download_*
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "def download_\\w+\\("

  - id: def-fetch
    desc: Function named fetch_*
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "def fetch_\\w+\\("

  - id: payload-keyword
    desc: payload/stage/phase keyword
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)payload|stage|phase"

  - id: requests-method
    desc: requests.get or requests.post
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "requests\\.(get|post)\\("

  - id: write-call
    desc: .write() call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "\\.write\\("

  - id: popen-call
    desc: subprocess module call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "subprocess\\.(Popen|run|call)\\("

composite_rules:
  # HTTP library composite
  - id: python-http-lib
    desc: Python HTTP library usage
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: requests-get
      - id: requests-post
      - id: urllib-request
      - id: http-client

  # HTTP download call composite
  - id: python-http-download-call
    desc: Python HTTP download function call
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: requests-get
      - id: requests-post
      - id: urlopen-call
      - id: urlretrieve-call

  # Temp directory composite
  - id: python-tmp-dir
    desc: Temporary directory access
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: tmp-path
      - id: tempfile-module

  # Home directory composite
  - id: python-home-dir
    desc: Home directory access
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: expanduser-home
      - id: path-home-call
      - id: environ-home

  # Subprocess execution composite
  - id: python-subprocess-exec
    desc: Subprocess execution
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: exec/command/subprocess/python/popen
      - id: exec/command/subprocess/python/run-call
      - id: exec/command/subprocess/python/call

  # Code or process execution composite
  - id: python-exec-any
    desc: Code or process execution
    crit: notable
    conf: 0.5
    requires_count: 1
    any:
      - id: exec/command/subprocess/python/popen
      - id: exec/command/subprocess/python/run-call
      - id: exec/command/subprocess/python/call
      - id: os-system-call
      - id: exec-call

  # C2 endpoint path composite
  - id: python-endpoint-path
    desc: Suspicious C2 endpoint paths
    crit: suspicious
    conf: 0.85
    attack: "T1105"
    requires_count: 1
    any:
      - id: path-payload
      - id: path-stage
      - id: path-drop
      - id: path-brow
      - id: path-mclip
      - id: path-clip
      - id: path-steal
      - id: path-grab
      - id: path-exfil

  # Original rule - tmp directory dropper
  - id: tmp-dropper
    desc: "HTTP download to temp and execute"
    conf: 0.9
    requires_count: 3
    any:
      - id: python-http-lib
      - id: python-tmp-dir
      - id: python-chmod
      - id: python-subprocess-exec

  # Home directory dropper - downloads to hidden dir in home
  - id: home-dropper
    desc: "HTTP download to home directory and execute"
    conf: 0.95
    crit: suspicious
    requires_count: 3
    any:
      - id: python-http-download-call
      - id: python-home-dir
      - id: python-write-binary
      - id: python-exec-any

  # Generic download + write + execute (any location)
  - id: generic-dropper
    desc: "Download, write, and execute pattern"
    conf: 0.9
    requires_all:
      - id: python-http-lib
      - id: python-write-content
      - id: python-subprocess-exec

  # Multiple download functions composite
  - id: multi-download-funcs
    desc: Multiple download function definitions
    crit: suspicious
    conf: 0.85
    count: 2
    any:
      - id: def-download
      - id: def-fetch

  # Staged dropper - download function called multiple times
  - id: staged-dropper
    desc: "Staged payload dropper"
    conf: 0.9
    crit: suspicious
    requires_any:
      - id: multi-download-funcs
    requires_all:
      - id: requests-method
      - id: write-call
      - id: popen-call
      - id: payload-keyword
