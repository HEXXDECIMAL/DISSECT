# HTTP download and execute patterns (Python)
# MBC: B0024 (Dropper)
# ATT&CK: T1105 (Ingress Tool Transfer)

defaults:
  file_types: [python]
  mbc: "B0024"
  attack: "T1105"
  criticality: suspicious

composite_rules:
  # Original rule - tmp directory dropper
  - id: tmp-dropper
    description: "HTTP download to temp and execute"
    confidence: 0.9
    requires_count: 3
    conditions:
      - type: string
        regex: "requests\\.(get|post)|urllib\\.request|http\\.client"
      - type: string
        regex: '"/tmp/|tempfile\\.'
      - type: string
        regex: "os\\.chmod\\("
      - type: string
        regex: "subprocess\\.(Popen|run|call)\\("

  # Home directory dropper - downloads to hidden dir in home
  - id: home-dropper
    description: "HTTP download to home directory and execute"
    confidence: 0.95
    criticality: suspicious
    requires_count: 3
    conditions:
      - type: string
        # HTTP download
        regex: "requests\\.(get|post)\\(|urllib\\.request\\.(urlopen|urlretrieve)"
      - type: string
        # Home directory access
        regex: 'os\\.path\\.expanduser\\([^)]*~|Path\\.home\\(\\)|os\\.environ.*HOME'
      - type: string
        # File write (binary)
        regex: "open\\([^)]+['\"]wb['\"]\\)|write_bytes\\("
      - type: string
        # Execute
        regex: "subprocess\\.(Popen|run|call)\\(|os\\.system\\(|exec\\("

  # Generic download + write + execute (any location)
  - id: generic-dropper
    description: "Download, write, and execute pattern"
    confidence: 0.9
    requires_all:
      - type: string
        # HTTP download
        regex: "requests\\.(get|post)\\(|urllib\\.request|urlopen\\("
      - type: string
        # Write content to file
        regex: "\\.write\\([^)]*\\.content\\)|write_bytes\\("
      - type: string
        # Execute the written file
        regex: "subprocess\\.(Popen|run|call)\\("

  # Multi-payload dropper - downloads multiple files
  - id: multi-payload
    description: "Multi-payload dropper (downloads multiple files)"
    confidence: 0.95
    criticality: suspicious
    condition:
      type: string
      # Multiple requests.get or similar patterns
      regex: "requests\\.(get|post)\\("
      min_count: 2

  # Staged dropper - download function called multiple times
  - id: staged-dropper
    description: "Staged payload dropper"
    confidence: 0.9
    criticality: suspicious
    condition:
      type: yara
      source: |
        rule staged_dropper {
          meta:
            description = "Multiple download functions or payload stages"
          strings:
            $download = /def download_\w+\(/ ascii
            $payload = /payload|stage|phase/ ascii nocase
            $requests = /requests\.(get|post)\(/ ascii
            $write = /\.write\(/ ascii
            $popen = /subprocess\.(Popen|run|call)\(/ ascii
          condition:
            #$download >= 2 or
            ($requests and $write and $popen and #$payload >= 2)
        }

traits:
  # Single traits for component detection
  - id: python-http-download
    description: "HTTP content download"
    confidence: 0.7
    criticality: notable
    condition:
      type: string
      regex: "requests\\.(get|post)\\([^)]+\\)\\.content"

  - id: python-endpoint-path
    description: "Suspicious C2 endpoint paths (payload, brow, mclip)"
    confidence: 0.85
    criticality: suspicious
    attack: "T1105"
    condition:
      type: string
      # Paths like /payload/, /brow/, /mclip/ etc - the actual URL paths
      regex: "/(payload|stage|drop|brow|mclip|clip|steal|grab|exfil)/"
      search_raw: true
