# HTTP download and execute patterns (Python)
# MBC: B0024 (Dropper)
# ATT&CK: T1105 (Ingress Tool Transfer)

defaults:
  file_types: [python]
  mbc: "B0024"
  attack: "T1105"
  criticality: suspicious

traits:
  # === HTTP library atomic indicators ===
  - id: requests-get
    description: requests.get call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "requests.get"

  - id: requests-post
    description: requests.post call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "requests.post"

  - id: urllib-request
    description: urllib.request module
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "urllib.request"

  - id: http-client
    description: http.client module
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "http.client"

  - id: urlopen-call
    description: urlopen call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "urlopen\\("

  - id: urlretrieve-call
    description: urlretrieve call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "urlretrieve\\("

  # === Directory atomic indicators ===
  - id: tmp-path
    description: /tmp/ path literal
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      exact: '"/tmp/'

  - id: tempfile-module
    description: tempfile module
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      regex: "tempfile\\."

  - id: expanduser-home
    description: os.path.expanduser with ~
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      regex: 'os\\.path\\.expanduser\\([^)]*~'

  - id: path-home-call
    description: Path.home() call
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      exact: "Path.home()"

  - id: environ-home
    description: os.environ HOME access
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      regex: 'os\\.environ.*HOME'

  # File operations
  - id: python-chmod
    description: "File permission change"
    criticality: notable
    confidence: 0.5
    condition:
      type: string
      regex: "os\\.chmod\\("

  - id: python-write-binary
    description: "Binary file write"
    criticality: notable
    confidence: 0.5
    condition:
      type: string
      regex: "open\\([^)]+['\"]wb['\"]\\)|write_bytes\\("

  - id: python-write-content
    description: "Write downloaded content to file"
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      regex: "\\.write\\([^)]*\\.content\\)|write_bytes\\("

  # === Subprocess atomic indicators ===
  - id: subprocess-popen
    description: subprocess.Popen call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "subprocess\\.Popen\\("

  - id: subprocess-run
    description: subprocess.run call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "subprocess\\.run\\("

  - id: subprocess-call
    description: subprocess.call call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "subprocess\\.call\\("

  - id: os-system-call
    description: os.system call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "os\\.system\\("

  - id: exec-call
    description: exec() call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      regex: "exec\\("

  # === C2 endpoint path atomic indicators ===
  - id: path-payload
    description: /payload/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/payload/"
      search_raw: true

  - id: path-stage
    description: /stage/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/stage/"
      search_raw: true

  - id: path-drop
    description: /drop/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/drop/"
      search_raw: true

  - id: path-brow
    description: /brow/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/brow/"
      search_raw: true

  - id: path-mclip
    description: /mclip/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/mclip/"
      search_raw: true

  - id: path-clip
    description: /clip/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/clip/"
      search_raw: true

  - id: path-steal
    description: /steal/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/steal/"
      search_raw: true

  - id: path-grab
    description: /grab/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/grab/"
      search_raw: true

  - id: path-exfil
    description: /exfil/ endpoint path
    criticality: inert
    confidence: 0.6
    attack: "T1105"
    condition:
      type: string
      exact: "/exfil/"
      search_raw: true

  - id: python-staged-yara
    description: "Staged payload dropper via YARA"
    confidence: 0.9
    criticality: suspicious
    condition:
      type: yara
      source: |
        rule staged_dropper {
          meta:
            description = "Multiple download functions or payload stages"
          strings:
            $download1 = /def download_\w+\(/ ascii
            $download2 = /def fetch_\w+\(/ ascii
            $payload = /payload|stage|phase/ ascii nocase
            $requests = /requests\.(get|post)\(/ ascii
            $write = /\.write\(/ ascii
            $popen = /subprocess\.(Popen|run|call)\(/ ascii
          condition:
            (2 of ($download*)) or
            ($requests and $write and $popen and $payload)
        }

composite_rules:
  # HTTP library composite
  - id: python-http-lib
    description: Python HTTP library usage
    criticality: notable
    confidence: 0.6
    requires_count: 1
    conditions:
      - id: requests-get
      - id: requests-post
      - id: urllib-request
      - id: http-client

  # HTTP download call composite
  - id: python-http-download-call
    description: Python HTTP download function call
    criticality: notable
    confidence: 0.6
    requires_count: 1
    conditions:
      - id: requests-get
      - id: requests-post
      - id: urlopen-call
      - id: urlretrieve-call

  # Temp directory composite
  - id: python-tmp-dir
    description: Temporary directory access
    criticality: notable
    confidence: 0.5
    requires_count: 1
    conditions:
      - id: tmp-path
      - id: tempfile-module

  # Home directory composite
  - id: python-home-dir
    description: Home directory access
    criticality: notable
    confidence: 0.5
    requires_count: 1
    conditions:
      - id: expanduser-home
      - id: path-home-call
      - id: environ-home

  # Subprocess execution composite
  - id: python-subprocess-exec
    description: Subprocess execution
    criticality: notable
    confidence: 0.5
    requires_count: 1
    conditions:
      - id: subprocess-popen
      - id: subprocess-run
      - id: subprocess-call

  # Code or process execution composite
  - id: python-exec-any
    description: Code or process execution
    criticality: notable
    confidence: 0.5
    requires_count: 1
    conditions:
      - id: subprocess-popen
      - id: subprocess-run
      - id: subprocess-call
      - id: os-system-call
      - id: exec-call

  # C2 endpoint path composite
  - id: python-endpoint-path
    description: Suspicious C2 endpoint paths
    criticality: suspicious
    confidence: 0.85
    attack: "T1105"
    requires_count: 1
    conditions:
      - id: path-payload
      - id: path-stage
      - id: path-drop
      - id: path-brow
      - id: path-mclip
      - id: path-clip
      - id: path-steal
      - id: path-grab
      - id: path-exfil

  # Original rule - tmp directory dropper
  - id: tmp-dropper
    description: "HTTP download to temp and execute"
    confidence: 0.9
    requires_count: 3
    conditions:
      - id: python-http-lib
      - id: python-tmp-dir
      - id: python-chmod
      - id: python-subprocess-exec

  # Home directory dropper - downloads to hidden dir in home
  - id: home-dropper
    description: "HTTP download to home directory and execute"
    confidence: 0.95
    criticality: suspicious
    requires_count: 3
    conditions:
      - id: python-http-download-call
      - id: python-home-dir
      - id: python-write-binary
      - id: python-exec-any

  # Generic download + write + execute (any location)
  - id: generic-dropper
    description: "Download, write, and execute pattern"
    confidence: 0.9
    requires_all:
      - id: python-http-lib
      - id: python-write-content
      - id: python-subprocess-exec

  # Staged dropper - download function called multiple times
  - id: staged-dropper
    description: "Staged payload dropper"
    confidence: 0.9
    criticality: suspicious
    requires_all:
      - id: python-staged-yara
