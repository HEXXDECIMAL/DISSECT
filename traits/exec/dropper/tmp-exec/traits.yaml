# Download to /tmp, chmod, execute pattern
# MBC: B0024 (Dropper)
# ATT&CK: T1059 (Command and Scripting Interpreter)

defaults:
  mbc: "B0024"
  attack: "T1059.006"

traits:
  - id: tmp-path
    description: Reference to /tmp directory for execution
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: '"/tmp/[a-zA-Z_][a-zA-Z0-9_]*"'

  - id: tmp-path-short
    description: Reference to /tmp directory path
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: '"/tmp/[a-zA-Z_]+'

  - id: os-chmod
    description: Python os.chmod call to modify file permissions
    criticality: notable
    confidence: 0.8
    condition:
      type: string
      regex: "os\\.chmod\\("

  # === subprocess execution (atomic) ===
  - id: subprocess-popen
    description: Python subprocess.Popen call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "subprocess.Popen("

  - id: subprocess-run
    description: Python subprocess.run call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "subprocess.run("

  - id: subprocess-call
    description: Python subprocess.call call
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "subprocess.call("

  - id: os-remove
    description: Python os.remove call to delete files
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "os\\.remove\\("

composite_rules:
  # subprocess execution composite
  - id: subprocess-exec
    description: Python subprocess execution (Popen, run, or call)
    criticality: notable
    confidence: 0.8
    requires_count: 1
    conditions:
      - id: subprocess-popen
      - id: subprocess-run
      - id: subprocess-call

  - id: python
    description: Download to /tmp, chmod, execute (supply chain attack)
    confidence: 0.95
    criticality: suspicious
    file_types: [python]
    requires_count: 3
    conditions:
      - id: tmp-path-short
      - id: os-chmod
      - id: subprocess-exec
      - id: os-remove
