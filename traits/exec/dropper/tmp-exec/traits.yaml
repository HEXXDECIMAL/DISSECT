# Download to /tmp, chmod, execute pattern
# MBC: B0024 (Dropper)
# ATT&CK: T1059 (Command and Scripting Interpreter)

defaults:
  mbc: "B0024"
  attack: "T1059.006"

traits:
  - id: tmp-path
    desc: Reference to /tmp directory for execution
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '"/tmp/[a-zA-Z_][a-zA-Z0-9_]*"'

  - id: tmp-path-short
    desc: Reference to /tmp directory path
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '"/tmp/[a-zA-Z_]+'

  - id: os-chmod
    desc: Python os.chmod call to modify file permissions
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "os\\.chmod\\("

  - id: os-remove
    desc: Python os.remove call to delete files
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "os\\.remove\\("

composite_rules:
  # subprocess execution composite
  - id: subprocess-exec
    desc: Python subprocess execution (Popen, run, or call)
    crit: notable
    conf: 0.8
    count_min: 1
    any:
      - id: exec/command/subprocess/python/popen
      - id: exec/command/subprocess/python/run-call
      - id: exec/command/subprocess/python/call

  - id: python
    desc: Download to /tmp, chmod, execute (supply chain attack)
    conf: 0.95
    crit: suspicious
    for: [python]
    count_min: 3
    any:
      - id: tmp-path-short
      - id: os-chmod
      - id: subprocess-exec
      - id: os-remove
