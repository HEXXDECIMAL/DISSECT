# Download to /tmp, chmod, execute pattern
# MBC: B0024 (Dropper)
# ATT&CK: T1059 (Command and Scripting Interpreter)

defaults:
  mbc: "B0024"
  attack: "T1059.006"

traits:
  - id: tmp-path
    desc: Reference to /tmp directory for execution
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '"/tmp/[a-zA-Z_][a-zA-Z0-9_]*"'

  - id: tmp-path-short
    desc: Reference to /tmp directory path
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '"/tmp/[a-zA-Z_]+'

  - id: os-chmod
    desc: Python os.chmod call to modify file permissions
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "os\\.chmod\\("

  # === subprocess execution (atomic) ===
  - id: subprocess-popen
    desc: Python subprocess.Popen call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "subprocess.Popen("

  - id: subprocess-run
    desc: Python subprocess.run call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "subprocess.run("

  - id: subprocess-call
    desc: Python subprocess.call call
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "subprocess.call("

  - id: os-remove
    desc: Python os.remove call to delete files
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "os\\.remove\\("

composite_rules:
  # subprocess execution composite
  - id: subprocess-exec
    desc: Python subprocess execution (Popen, run, or call)
    crit: notable
    conf: 0.8
    requires_count: 1
    any:
      - id: subprocess-popen
      - id: subprocess-run
      - id: subprocess-call

  - id: python
    desc: Download to /tmp, chmod, execute (supply chain attack)
    conf: 0.95
    crit: suspicious
    for: [python]
    requires_count: 3
    any:
      - id: tmp-path-short
      - id: os-chmod
      - id: subprocess-exec
      - id: os-remove
