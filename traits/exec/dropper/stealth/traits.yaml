# Stealth execution patterns (output hiding, process detachment)
# MBC: F0003 (Process Detach), F0005 (Hide Output)
# NOTE: os.setsid and preexec_fn= traits are defined in exec/command/setsid/traits.yaml

traits:
  - id: devnull
    desc: "subprocess.DEVNULL to hide output"
    crit: notable
    conf: 0.75
    mbc: "F0005"
    for: [python]
    if:
      type: raw
      exact: "subprocess.DEVNULL"

  - id: close-fds
    desc: "close_fds=True for file descriptor isolation"
    crit: notable
    conf: 0.7
    for: [python]
    if:
      type: raw
      exact: "close_fds=True"

  - id: subprocess-popen
    desc: "subprocess.Popen call"
    crit: notable
    conf: 0.6
    for: [python]
    if:
      type: raw
      regex: "subprocess\\.Popen\\("

composite_rules:
  - id: python
    desc: "Process execution with output hiding and detachment"
    conf: 0.92
    crit: suspicious
    mbc: "F0003"
    attack: "T1036"
    for: [python]
    count: 3
    any:
      - id: subprocess-popen
      - id: devnull
      - id: exec/command/setsid/python
      - id: close-fds
      - id: exec/command/setsid/preexec-fn
