---
# Ruby malware dropper composite patterns

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Ruby require strings (library imports) ===
  - id: net-http-single-quote
    desc: "'net/http' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'net/http'"

  - id: net-http-double-quote
    desc: '"net/http" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"net/http"'

  - id: uri-single-quote
    desc: "'uri' require string"
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "'uri'"

  - id: uri-double-quote
    desc: '"uri" require string'
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: '"uri"'

  - id: base64-single-quote
    desc: "'base64' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'base64'"

  - id: base64-double-quote
    desc: '"base64" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"base64"'

  - id: resolv-single-quote
    desc: "'resolv' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'resolv'"

  - id: resolv-double-quote
    desc: '"resolv" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"resolv"'

  - id: socket-single-quote
    desc: "'socket' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'socket'"

  - id: socket-double-quote
    desc: '"socket" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"socket"'

  - id: tempfile-single-quote
    desc: "'tempfile' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'tempfile'"

  - id: tempfile-double-quote
    desc: '"tempfile" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"tempfile"'

  - id: open-uri-single-quote
    desc: "'open-uri' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'open-uri'"

  - id: open-uri-double-quote
    desc: '"open-uri" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"open-uri"'

  - id: pty-single-quote
    desc: "'pty' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'pty'"

  - id: pty-double-quote
    desc: '"pty" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"pty"'

composite_rules:
  # === Library require composites ===
  - id: ruby-require-net-http
    description: Imports HTTP client library
    crit: notable
    conf: 0.80
    any:
      - id: net-http-single-quote
      - id: net-http-double-quote

  - id: ruby-require-uri
    description: Imports URI parsing library
    crit: notable
    conf: 0.75
    any:
      - id: uri-single-quote
      - id: uri-double-quote

  - id: ruby-require-base64
    description: Imports Base64 library
    crit: notable
    conf: 0.80
    any:
      - id: base64-single-quote
      - id: base64-double-quote

  - id: ruby-require-resolv
    description: Imports DNS resolution library
    crit: notable
    conf: 0.80
    any:
      - id: resolv-single-quote
      - id: resolv-double-quote

  - id: ruby-require-socket
    description: Imports socket library
    crit: notable
    conf: 0.85
    any:
      - id: socket-single-quote
      - id: socket-double-quote

  - id: ruby-require-tempfile
    description: Imports temporary file library
    crit: notable
    conf: 0.80
    any:
      - id: tempfile-single-quote
      - id: tempfile-double-quote

  - id: ruby-require-open-uri
    description: Imports Open-URI library
    crit: notable
    conf: 0.85
    any:
      - id: open-uri-single-quote
      - id: open-uri-double-quote

  - id: ruby-require-pty
    description: Imports PTY (pseudo-terminal) library
    crit: notable
    conf: 0.85
    any:
      - id: pty-single-quote
      - id: pty-double-quote

  # === Dropper pattern composites ===
  - id: ruby-http-dropper
    description: HTTP dropper downloads and executes payload
    conf: 0.95
    crit: suspicious
    count: 4
    any:
      - id: ruby-http-get-response
      - id: ruby-http-client
      - id: ruby-file-open-write-binary
      - id: ruby-file-binmode
      - id: ruby-file-chmod
      - id: ruby-chmod-777
      - id: ruby-system
      - id: ruby-exec
      - id: ruby-file-write-tmp

  - id: ruby-obfuscated-c2
    description: Obfuscated C2 with Base64 and DNS
    conf: 0.92
    crit: suspicious
    count: 3
    any:
      - id: ruby-base64-decode
      - id: ruby-dns-resolve
      - id: ruby-http-client
      - id: ruby-http-get-response

  - id: ruby-tmp-execution
    description: Write to /tmp, chmod, and execute
    conf: 0.93
    crit: suspicious
    count: 3
    any:
      - id: ruby-file-write-tmp
      - id: ruby-file-chmod
      - id: ruby-chmod-777
      - id: ruby-system
      - id: ruby-exec

  - id: ruby-reverse-shell
    description: Reverse shell connection
    conf: 0.90
    crit: suspicious
    count: 2
    any:
      - id: ruby-tcp-socket
      - id: ruby-system
      - id: ruby-exec
      - id: ruby-popen
      - id: ruby-pty

  - id: ruby-binary-dropper
    description: Downloads and writes binary payload
    conf: 0.94
    crit: suspicious
    count: 3
    any:
      - id: ruby-http-get-response
      - id: ruby-file-binmode
      - id: ruby-file-open-write-binary
      - id: ruby-file-write-tmp
