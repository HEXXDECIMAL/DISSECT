---
# Ruby malware dropper composite patterns
composite_rules:
  - id: ruby-http-dropper
    description: "HTTP dropper: downloads and executes payload"
    confidence: 0.95
    criticality: suspicious
    platforms:
      - all
    file_types:
      - ruby
    requires_count: 4
    conditions:
      - type: trait
        id: ruby-http-get-response
      - type: trait
        id: ruby-http-client
      - type: trait
        id: ruby-file-open-write-binary
      - type: trait
        id: ruby-file-binmode
      - type: trait
        id: ruby-file-chmod
      - type: trait
        id: ruby-chmod-777
      - type: trait
        id: ruby-system
      - type: trait
        id: ruby-exec
      - type: trait
        id: ruby-file-write-tmp

  - id: ruby-obfuscated-c2
    description: "Obfuscated C2 with Base64 and DNS"
    confidence: 0.92
    criticality: suspicious
    platforms:
      - all
    file_types:
      - ruby
    requires_count: 3
    conditions:
      - type: trait
        id: ruby-base64-decode
      - type: trait
        id: ruby-dns-resolve
      - type: trait
        id: ruby-http-client
      - type: trait
        id: ruby-http-get-response

  - id: ruby-tmp-execution
    description: "Write to /tmp, chmod, and execute"
    confidence: 0.93
    criticality: suspicious
    platforms:
      - all
    file_types:
      - ruby
    requires_count: 3
    conditions:
      - type: trait
        id: ruby-file-write-tmp
      - type: trait
        id: ruby-file-chmod
      - type: trait
        id: ruby-chmod-777
      - type: trait
        id: ruby-system
      - type: trait
        id: ruby-exec

  - id: ruby-reverse-shell
    description: "Reverse shell connection"
    confidence: 0.90
    criticality: suspicious
    platforms:
      - all
    file_types:
      - ruby
    requires_count: 2
    conditions:
      - type: trait
        id: ruby-tcp-socket
      - type: trait
        id: ruby-system
      - type: trait
        id: ruby-exec
      - type: trait
        id: ruby-popen
      - type: trait
        id: ruby-pty

  - id: ruby-binary-dropper
    description: "Downloads and writes binary payload"
    confidence: 0.94
    criticality: suspicious
    platforms:
      - all
    file_types:
      - ruby
    requires_count: 3
    conditions:
      - type: trait
        id: ruby-http-get-response
      - type: trait
        id: ruby-file-binmode
      - type: trait
        id: ruby-file-open-write-binary
      - type: trait
        id: ruby-file-write-tmp

# Individual traits for requires (library imports)
traits:
  - id: ruby-require-net-http
    description: "Imports HTTP client library"
    criticality: notable
    confidence: 0.80
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'net/http'"
        - '"net/http"'

  - id: ruby-require-uri
    description: "Imports URI parsing library"
    criticality: notable
    confidence: 0.75
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'uri'"
        - '"uri"'

  - id: ruby-require-base64
    description: "Imports Base64 library"
    criticality: notable
    confidence: 0.80
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'base64'"
        - '"base64"'

  - id: ruby-require-resolv
    description: "Imports DNS resolution library"
    criticality: notable
    confidence: 0.80
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'resolv'"
        - '"resolv"'

  - id: ruby-require-socket
    description: "Imports socket library"
    criticality: notable
    confidence: 0.85
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'socket'"
        - '"socket"'


  - id: ruby-require-tempfile
    description: "Imports temporary file library"
    criticality: notable
    confidence: 0.80
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'tempfile'"
        - '"tempfile"'

  - id: ruby-require-open-uri
    description: "Imports Open-URI library"
    criticality: notable
    confidence: 0.85
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'open-uri'"
        - '"open-uri"'

  - id: ruby-require-pty
    description: "Imports PTY (pseudo-terminal) library"
    criticality: notable
    confidence: 0.85
    platforms:
      - all
    file_types:
      - ruby
    condition:
      type: symbol_or_string
      any:
        - "'pty'"
        - '"pty"'
