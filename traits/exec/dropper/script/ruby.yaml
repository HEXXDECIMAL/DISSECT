---
# Ruby malware dropper composite patterns

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Ruby require strings (library imports) ===
  - id: net-http-single-quote
    desc: "'net/http' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'net/http'"

  - id: net-http-double-quote
    desc: '"net/http" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"net/http"'

  - id: uri-single-quote
    desc: "'uri' require string"
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "'uri'"

  - id: uri-double-quote
    desc: '"uri" require string'
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: '"uri"'

  - id: base64-single-quote
    desc: "'base64' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'base64'"

  - id: base64-double-quote
    desc: '"base64" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"base64"'

  - id: resolv-single-quote
    desc: "'resolv' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'resolv'"

  - id: resolv-double-quote
    desc: '"resolv" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"resolv"'

  - id: socket-single-quote
    desc: "'socket' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'socket'"

  - id: socket-double-quote
    desc: '"socket" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"socket"'

  - id: tempfile-single-quote
    desc: "'tempfile' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "'tempfile'"

  - id: tempfile-double-quote
    desc: '"tempfile" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: '"tempfile"'

  - id: open-uri-single-quote
    desc: "'open-uri' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'open-uri'"

  - id: open-uri-double-quote
    desc: '"open-uri" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"open-uri"'

  - id: pty-single-quote
    desc: "'pty' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'pty'"

  - id: pty-double-quote
    desc: '"pty" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"pty"'

  # === Base64 with Separator Obfuscation ===
  - id: base64-separator-obfuscation
    desc: Base64 with separator obfuscation
    crit: suspicious
    conf: 0.88
    attack: "T1027"
    if:
      type: string
      regex: 'gsub.{0,50}---|\.gsub.{0,50}"-\-\-"|decode64.{0,50}gsub'

  # === Windows OS Check ===
  - id: windows-os-check
    desc: Windows OS platform check
    crit: notable
    conf: 0.70
    attack: "T1497"
    if:
      type: string
      regex: 'mswin|msys|mingw|cygwin|bccwin|wince|emc|host_os.{0,50}match'

  # === VBS Script Writing ===
  - id: vbs-script-write
    desc: VBS script file creation
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    if:
      type: string
      regex: '\.vbs.{0,50}write|write.{0,50}\.vbs|\.vbs.{0,50}File\.open'

  # === WScript Execution ===
  - id: wscript-execution
    desc: WScript execution
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    if:
      type: string
      regex: 'wscript|cscript|\.vbs'

composite_rules:
  # === Library require composites ===
  - id: ruby-require-net-http
    desc: Imports HTTP client library
    crit: notable
    conf: 0.80
    any:
      - id: net-http-single-quote
      - id: net-http-double-quote

  - id: ruby-require-uri
    desc: Imports URI parsing library
    crit: notable
    conf: 0.75
    any:
      - id: uri-single-quote
      - id: uri-double-quote

  - id: ruby-require-base64
    desc: Imports Base64 library
    crit: notable
    conf: 0.80
    any:
      - id: base64-single-quote
      - id: base64-double-quote

  - id: ruby-require-resolv
    desc: Imports DNS resolution library
    crit: notable
    conf: 0.80
    any:
      - id: resolv-single-quote
      - id: resolv-double-quote

  - id: ruby-require-socket
    desc: Imports socket library
    crit: notable
    conf: 0.85
    any:
      - id: socket-single-quote
      - id: socket-double-quote

  - id: ruby-require-tempfile
    desc: Imports temporary file library
    crit: notable
    conf: 0.80
    any:
      - id: tempfile-single-quote
      - id: tempfile-double-quote

  - id: ruby-require-open-uri
    desc: Imports Open-URI library
    crit: notable
    conf: 0.85
    any:
      - id: open-uri-single-quote
      - id: open-uri-double-quote

  - id: ruby-require-pty
    desc: Imports PTY (pseudo-terminal) library
    crit: notable
    conf: 0.85
    any:
      - id: pty-single-quote
      - id: pty-double-quote

  # === Dropper pattern composites ===
  - id: ruby-http-dropper
    desc: HTTP dropper downloads and executes
    conf: 0.95
    crit: suspicious
    count_min: 4
    any:
      - id: comm/http/request/ruby-http-get-response
      - id: comm/http/request/ruby-http-client
      - id: fs/write/file/ruby-file-open-write-binary
      - id: fs/write/file/ruby-file-binmode
      - id: fs/write/file/ruby-file-chmod
      - id: fs/write/file/ruby-chmod-777
      - id: exec/command/shell/ruby-system
      - id: exec/command/shell/ruby-exec
      - id: fs/write/file/ruby-file-write-tmp

  - id: ruby-obfuscated-c2
    desc: Obfuscated C2 with Base64 and
    conf: 0.92
    crit: suspicious
    count_min: 3
    any:
      - id: anti-static/obfuscation/code/base64-decode
      - id: discovery/system/ruby-dns-resolve
      - id: comm/http/request/ruby-http-client
      - id: comm/http/request/ruby-http-get-response

  - id: ruby-tmp-execution
    desc: Write to /tmp, chmod, and
    conf: 0.93
    crit: suspicious
    count_min: 3
    any:
      - id: fs/write/file/ruby-file-write-tmp
      - id: fs/write/file/ruby-file-chmod
      - id: fs/write/file/ruby-chmod-777
      - id: exec/command/shell/ruby-system
      - id: exec/command/shell/ruby-exec

  - id: ruby-reverse-shell
    desc: Reverse shell connection
    conf: 0.90
    crit: suspicious
    count_min: 2
    any:
      - id: comm/socket/listen/ruby-tcp-socket
      - id: exec/command/shell/ruby-system
      - id: exec/command/shell/ruby-exec
      - id: exec/command/shell/ruby-popen
      - id: process/tty/pty/ruby-pty

  - id: ruby-windows-vbs-dropper
    desc: Windows VBS payload dropper
    conf: 0.94
    crit: suspicious
    count_min: 4
    any:
      - id: windows-os-check
      - id: base64-separator-obfuscation
      - id: vbs-script-write
      - id: wscript-execution
      - id: exec/command/shell/ruby-system
      - id: anti-static/obfuscation/code/base64-decode

  - id: ruby-binary-dropper
    desc: Downloads and writes binary payload
    conf: 0.94
    crit: suspicious
    count_min: 3
    any:
      - id: comm/http/request/ruby-http-get-response
      - id: fs/write/file/ruby-file-binmode
      - id: fs/write/file/ruby-file-open-write-binary
      - id: fs/write/file/ruby-file-write-tmp
