---
# Ruby malware dropper composite patterns
composite_rules:
  - id: ruby-http-dropper
    desc: "HTTP dropper: downloads and executes payload"
    conf: 0.95
    crit: suspicious
    platforms:
      - all
    for:
      - ruby
    requires_count: 4
    any:
      - id: ruby-http-get-response
      - id: ruby-http-client
      - id: ruby-file-open-write-binary
      - id: ruby-file-binmode
      - id: ruby-file-chmod
      - id: ruby-chmod-777
      - id: ruby-system
      - id: ruby-exec
      - id: ruby-file-write-tmp

  - id: ruby-obfuscated-c2
    desc: "Obfuscated C2 with Base64 and DNS"
    conf: 0.92
    crit: suspicious
    platforms:
      - all
    for:
      - ruby
    requires_count: 3
    any:
      - id: ruby-base64-decode
      - id: ruby-dns-resolve
      - id: ruby-http-client
      - id: ruby-http-get-response

  - id: ruby-tmp-execution
    desc: "Write to /tmp, chmod, and execute"
    conf: 0.93
    crit: suspicious
    platforms:
      - all
    for:
      - ruby
    requires_count: 3
    any:
      - id: ruby-file-write-tmp
      - id: ruby-file-chmod
      - id: ruby-chmod-777
      - id: ruby-system
      - id: ruby-exec

  - id: ruby-reverse-shell
    desc: "Reverse shell connection"
    conf: 0.90
    crit: suspicious
    platforms:
      - all
    for:
      - ruby
    requires_count: 2
    any:
      - id: ruby-tcp-socket
      - id: ruby-system
      - id: ruby-exec
      - id: ruby-popen
      - id: ruby-pty

  - id: ruby-binary-dropper
    desc: "Downloads and writes binary payload"
    conf: 0.94
    crit: suspicious
    platforms:
      - all
    for:
      - ruby
    requires_count: 3
    any:
      - id: ruby-http-get-response
      - id: ruby-file-binmode
      - id: ruby-file-open-write-binary
      - id: ruby-file-write-tmp

# Individual traits for requires (library imports)
traits:
  - id: ruby-require-net-http
    desc: "Imports HTTP client library"
    crit: notable
    conf: 0.80
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'net/http'"
        - '"net/http"'

  - id: ruby-require-uri
    desc: "Imports URI parsing library"
    crit: notable
    conf: 0.75
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'uri'"
        - '"uri"'

  - id: ruby-require-base64
    desc: "Imports Base64 library"
    crit: notable
    conf: 0.80
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'base64'"
        - '"base64"'

  - id: ruby-require-resolv
    desc: "Imports DNS resolution library"
    crit: notable
    conf: 0.80
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'resolv'"
        - '"resolv"'

  - id: ruby-require-socket
    desc: "Imports socket library"
    crit: notable
    conf: 0.85
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'socket'"
        - '"socket"'

  - id: ruby-require-tempfile
    desc: "Imports temporary file library"
    crit: notable
    conf: 0.80
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'tempfile'"
        - '"tempfile"'

  - id: ruby-require-open-uri
    desc: "Imports Open-URI library"
    crit: notable
    conf: 0.85
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'open-uri'"
        - '"open-uri"'

  - id: ruby-require-pty
    desc: "Imports PTY (pseudo-terminal) library"
    crit: notable
    conf: 0.85
    platforms:
      - all
    for:
      - ruby
    if:
      type: symbol_or_string
      any:
        - "'pty'"
        - '"pty"'
