# Shell Dropper Detection
# Detects download-chmod-execute patterns common in supply chain attacks
# ATT&CK: T1059.004 (Command and Scripting Interpreter: Unix Shell)

defaults:
  # Shell command strings can be embedded in any language (subprocess, system(), etc.)
  file_types: [*]

traits:
  - id: wget-download
    description: "Download via wget"
    criticality: notable
    confidence: 0.7
    mbc: "C0002"
    attack: "T1105"
    condition:
      type: string
      exact: "wget "
      search_raw: true

  # === Wget output atomic indicators ===
  - id: wget-output-dash-O
    description: "Wget with -O flag"
    criticality: inert
    confidence: 0.7
    mbc: "C0002"
    attack: "T1105"
    condition:
      type: string
      regex: "wget .* -O "
      search_raw: true

  - id: wget-output-document
    description: "Wget with --output-document"
    criticality: inert
    confidence: 0.7
    mbc: "C0002"
    attack: "T1105"
    condition:
      type: string
      regex: "wget .*--output-document"
      search_raw: true

  - id: curl-download
    description: "Download via curl"
    criticality: notable
    confidence: 0.7
    mbc: "C0002"
    attack: "T1105"
    condition:
      type: string
      exact: "curl "
      search_raw: true

  # === Curl output atomic indicators ===
  - id: curl-output-dash-o
    description: "Curl with -o flag"
    criticality: inert
    confidence: 0.7
    mbc: "C0002"
    attack: "T1105"
    condition:
      type: string
      regex: "curl .* -o "
      search_raw: true

  - id: curl-output-flag
    description: "Curl with --output"
    criticality: inert
    confidence: 0.7
    mbc: "C0002"
    attack: "T1105"
    condition:
      type: string
      regex: "curl .*--output"
      search_raw: true

  - id: chmod-plus-x
    description: "Making file executable"
    criticality: notable
    confidence: 0.75
    mbc: "C0047"
    attack: "T1222.002"
    condition:
      type: string
      regex: "chmod \\+x"
      search_raw: true

  - id: chmod-777
    description: "chmod 777 (world-writable executable)"
    criticality: suspicious
    confidence: 0.85
    mbc: "C0047"
    attack: "T1222.002"
    condition:
      type: string
      exact: "chmod 777"
      search_raw: true

  - id: execute-dot-slash
    description: "Execute file in current directory"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "\\./[a-zA-Z0-9_-]+"
      search_raw: true

  - id: hardcoded-ip-url
    description: "Hardcoded IP address in URL"
    criticality: suspicious
    confidence: 0.9
    mbc: "C0002"
    attack: "T1071.001"
    condition:
      type: string
      regex: "https?://\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}"
      search_raw: true

  # === Tmp staging atomic indicators ===
  - id: cd-tmp
    description: "cd /tmp command"
    criticality: notable
    confidence: 0.7
    mbc: "C0047"
    attack: "T1074.001"
    condition:
      type: string
      exact: "cd /tmp"
      search_raw: true

  - id: tmp-path
    description: "/tmp/ path reference"
    criticality: inert
    confidence: 0.6
    mbc: "C0047"
    attack: "T1074.001"
    condition:
      type: string
      exact: "/tmp/"
      search_raw: true

  - id: rm-rf-cleanup
    description: "Force remove files (cleanup/anti-forensics)"
    criticality: notable
    confidence: 0.7
    mbc: "F0007"
    attack: "T1070.004"
    condition:
      type: string
      exact: "rm -rf"
      search_raw: true

  # === MIPS architecture atomic indicators ===
  - id: mips-lower
    description: mips architecture string (lowercase)
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      exact: "mips"
      search_raw: true

  - id: mips-upper
    description: MIPS architecture string (uppercase)
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      exact: "MIPS"
      search_raw: true

  - id: iot-arch-arm
    description: "ARM architecture binary (IoT target)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "arm[0-9]?|ARM"
      search_raw: true

  # === MIPSEL architecture atomic indicators ===
  - id: mpsl-short
    description: mpsl architecture string (short)
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      exact: "mpsl"
      search_raw: true

  - id: mipsel-lower
    description: mipsel architecture string (lowercase)
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      exact: "mipsel"
      search_raw: true

  - id: mipsel-upper
    description: MIPSEL architecture string (uppercase)
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      exact: "MIPSEL"
      search_raw: true

composite_rules:
  # Wget output file composite
  - id: wget-output-file
    description: "Wget downloading to specific file"
    criticality: notable
    confidence: 0.8
    mbc: "C0002"
    attack: "T1105"
    requires_count: 1
    conditions:
      - id: wget-output-dash-O
      - id: wget-output-document

  # Curl output file composite
  - id: curl-output-file
    description: "Curl downloading to file"
    criticality: notable
    confidence: 0.8
    mbc: "C0002"
    attack: "T1105"
    requires_count: 1
    conditions:
      - id: curl-output-dash-o
      - id: curl-output-flag

  # Tmp staging composite
  - id: tmp-staging
    description: "/tmp staging directory usage"
    criticality: suspicious
    confidence: 0.8
    mbc: "C0047"
    attack: "T1074.001"
    requires_count: 1
    conditions:
      - id: cd-tmp
      - id: tmp-path

  - id: download-chmod-execute
    description: "Download, chmod, and execute in one command"
    confidence: 0.95
    criticality: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux, macos]
    requires_all:
      - id: wget-download
      - id: chmod-777
      - id: execute-dot-slash

  - id: curl-chmod-execute
    description: "Download via curl, chmod, and execute"
    confidence: 0.95
    criticality: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux, macos]
    requires_all:
      - id: curl-download
      - id: chmod-plus-x
      - id: execute-dot-slash

  # MIPS architecture composite
  - id: iot-arch-mips
    description: "MIPS architecture binary (IoT target)"
    criticality: suspicious
    confidence: 0.85
    requires_count: 1
    conditions:
      - id: mips-lower
      - id: mips-upper

  # MIPSEL architecture composite
  - id: iot-arch-mpsl
    description: "MIPSEL architecture binary (IoT target)"
    criticality: suspicious
    confidence: 0.85
    requires_count: 1
    conditions:
      - id: mpsl-short
      - id: mipsel-lower
      - id: mipsel-upper

  - id: iot-multi-arch
    description: "IoT botnet: multi-architecture payload dropper"
    confidence: 0.95
    criticality: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux]
    requires_count: 2
    conditions:
      - id: iot-arch-mips
      - id: iot-arch-arm
      - id: iot-arch-mpsl

  - id: tmp-staging-cleanup
    description: "Payload staging in /tmp with cleanup"
    confidence: 0.9
    criticality: suspicious
    mbc: "C0047"
    attack: "T1074.001"
    platforms: [linux, macos]
    requires_all:
      - id: tmp-staging
      - id: rm-rf-cleanup

  - id: hardcoded-c2-download
    description: "Download from hardcoded C2 IP address"
    confidence: 0.95
    criticality: suspicious
    mbc: "C0002"
    attack: "T1105"
    platforms: [linux, macos]
    requires_all:
      - id: hardcoded-ip-url
      - id: wget-download
