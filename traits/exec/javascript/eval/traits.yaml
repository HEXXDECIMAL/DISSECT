# JavaScript/Node.js Execution Traits
# Detects process execution and shell invocation patterns
# MBC: Execution
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  # Process execution functions
  - id: getExecOutput
    description: Node.js exec output capture (GitHub Actions)
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "getExecOutput"

  - id: child-process-exec
    description: Node.js child_process exec
    criticality: notable
    confidence: 0.85
    mbc: "C0017"
    attack: "T1059"
    file_types: [javascript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "exec"

  - id: child-process-spawn
    description: Node.js child_process spawn
    criticality: notable
    confidence: 0.85
    mbc: "C0017"
    attack: "T1059"
    file_types: [javascript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "spawn"

  - id: child-process-execSync
    description: Node.js synchronous exec
    criticality: notable
    confidence: 0.85
    mbc: "C0017"
    attack: "T1059"
    file_types: [javascript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "execSync"

  - id: child-process-require
    description: Node.js child_process module import
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: string
      exact: "child_process"

  # === Shell invocation atomic indicators ===
  - id: bash-single-quote
    description: Bash shell in single quotes
    criticality: inert
    confidence: 0.65
    file_types: [javascript]
    condition:
      type: string
      exact: "'bash'"

  - id: bash-double-quote
    description: Bash shell in double quotes
    criticality: inert
    confidence: 0.65
    file_types: [javascript]
    condition:
      type: string
      exact: "\"bash\""

  - id: bin-sh-single-quote
    description: /bin/sh in single quotes
    criticality: inert
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      exact: "'/bin/sh'"

  - id: bin-sh-double-quote
    description: /bin/sh in double quotes
    criticality: inert
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      exact: "\"/bin/sh\""

  - id: sh-single-quote
    description: sh in single quotes
    criticality: inert
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      exact: "'sh'"

  - id: sh-double-quote
    description: sh in double quotes
    criticality: inert
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      exact: "\"sh\""

  - id: bash-c-flag
    description: Bash -c command execution flag
    criticality: suspicious
    confidence: 0.85
    mbc: "C0017"
    attack: "T1059.004"
    file_types: [javascript]
    condition:
      type: string
      exact: "'-c'"

  # Output/error handling (stealth indicators)
  - id: stdout-capture
    description: Standard output capture
    criticality: inert
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      exact: "stdout"

  - id: stderr-capture
    description: Standard error capture
    criticality: inert
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      exact: "stderr"

  - id: silent-true
    description: Silent execution flag (hides output)
    criticality: suspicious
    confidence: 0.85
    mbc: "F0005"
    file_types: [javascript]
    condition:
      type: string
      regex: "silent:\\s*true"

  - id: ignoreReturnCode
    description: Ignore return code (hides errors)
    criticality: suspicious
    confidence: 0.8
    mbc: "F0005"
    file_types: [javascript]
    condition:
      type: string
      exact: "ignoreReturnCode"

  # === Base64 decode atomic indicators ===
  - id: base64-dash-d
    description: Base64 decode short flag
    criticality: notable
    confidence: 0.8
    mbc: "C0026"
    attack: "T1140"
    file_types: [javascript]
    condition:
      type: string
      exact: "base64 -d"

  - id: base64-dash-decode
    description: Base64 decode long flag
    criticality: notable
    confidence: 0.8
    mbc: "C0026"
    attack: "T1140"
    file_types: [javascript]
    condition:
      type: string
      exact: "base64 --decode"

  - id: echo-pipe
    description: Echo piped to command
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: string
      regex: "echo .* \\|"

  # Temp file operations
  - id: tmp-write
    description: Write to /tmp directory
    criticality: suspicious
    confidence: 0.85
    mbc: "C0016"
    attack: "T1074.001"
    file_types: [javascript]
    condition:
      type: string
      regex: "> /tmp/|>/tmp/"

  # === Tmp execute atomic indicators ===
  - id: tmp-bash-exec
    description: Execute bash from /tmp
    criticality: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript]
    condition:
      type: string
      exact: "bash /tmp/"

  - id: tmp-sh-exec
    description: Execute sh from /tmp
    criticality: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript]
    condition:
      type: string
      exact: "sh /tmp/"

  - id: tmp-dot-exec
    description: Execute ./tmp path
    criticality: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript]
    condition:
      type: string
      exact: "./tmp/"

  # === Function constructor atomic indicators ===
  - id: function-dot-constructor
    description: Function.constructor abuse
    criticality: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059.007"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "new\\s+Function\\.constructor\\("

  - id: new-function
    description: new Function() code execution
    criticality: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059.007"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "new\\s+Function\\s*\\("

  # Detached child process (background execution)
  - id: detached-spawn
    description: Detached child process (background execution)
    criticality: suspicious
    confidence: 0.85
    mbc: "F0011"
    attack: "T1059"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "detached:\\s*true"

  # Signal handler abuse (prevent termination)
  - id: sigint-handler
    description: SIGINT handler (may prevent CTRL+C)
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.on\\s*\\(['\"]SIGINT['\"]"

  - id: sigterm-handler
    description: SIGTERM handler (may prevent kill)
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.on\\s*\\(['\"]SIGTERM['\"]"

  # Process respawning (persistence via self-restart)
  - id: self-respawn
    description: Self-respawning process
    criticality: suspicious
    confidence: 0.85
    mbc: "F0011"
    attack: "T1547"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule self_respawn {
          strings:
            $spawn = "spawn(" ascii
            $import_meta = "import.meta.url" ascii
            $process_argv = "process.argv" ascii
            $file = "__filename" ascii
          condition:
            $spawn and any of ($import_meta, $process_argv, $file)
        }

composite_rules:
  # Bash string reference composite
  - id: bash-string
    description: Bash shell reference in string
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    requires_count: 1
    conditions:
      - id: bash-single-quote
      - id: bash-double-quote

  # Shell string reference composite
  - id: sh-string
    description: Shell reference in string
    criticality: notable
    confidence: 0.7
    file_types: [javascript]
    requires_count: 1
    conditions:
      - id: bin-sh-single-quote
      - id: bin-sh-double-quote
      - id: sh-single-quote
      - id: sh-double-quote

  # Base64 decode CLI composite
  - id: base64-decode-cli
    description: Base64 decode via CLI
    criticality: suspicious
    confidence: 0.9
    mbc: "C0026"
    attack: "T1140"
    file_types: [javascript]
    requires_count: 1
    conditions:
      - id: base64-dash-d
      - id: base64-dash-decode

  # Tmp execute composite
  - id: tmp-execute
    description: Execute from /tmp directory
    criticality: suspicious
    confidence: 0.9
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript]
    requires_count: 1
    conditions:
      - id: tmp-bash-exec
      - id: tmp-sh-exec
      - id: tmp-dot-exec

  # Function constructor composite
  - id: function-constructor
    description: Function constructor code execution
    criticality: suspicious
    confidence: 0.9
    mbc: "B0024"
    attack: "T1059.007"
    file_types: [javascript, typescript]
    requires_count: 1
    conditions:
      - id: function-dot-constructor
      - id: new-function
