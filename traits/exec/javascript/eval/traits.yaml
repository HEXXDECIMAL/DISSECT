# JavaScript/Node.js Execution Traits
# Detects process execution and shell invocation patterns
# MBC: Execution
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  # Process execution functions
  - id: getExecOutput
    desc: Node.js exec output capture (GitHub Actions)
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "getExecOutput"

  - id: child-process-exec
    desc: Node.js child_process exec
    crit: notable
    conf: 0.85
    mbc: "C0017"
    attack: "T1059"
    for: [javascript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "exec"

  - id: child-process-spawn
    desc: Node.js child_process spawn
    crit: notable
    conf: 0.85
    mbc: "C0017"
    attack: "T1059"
    for: [javascript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "spawn"

  - id: child-process-execSync
    desc: Node.js synchronous exec
    crit: notable
    conf: 0.85
    mbc: "C0017"
    attack: "T1059"
    for: [javascript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "execSync"

  - id: child-process-require
    desc: Node.js child_process module import
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: string
      exact: "child_process"

  # === Shell invocation atomic indicators ===
  - id: bash-single-quote
    desc: Bash shell in single quotes
    crit: inert
    conf: 0.65
    for: [javascript]
    if:
      type: string
      exact: "'bash'"

  - id: bash-double-quote
    desc: Bash shell in double quotes
    crit: inert
    conf: 0.65
    for: [javascript]
    if:
      type: string
      exact: '"bash"'

  - id: bin-sh-single-quote
    desc: /bin/sh in single quotes
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: "'/bin/sh'"

  - id: bin-sh-double-quote
    desc: /bin/sh in double quotes
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: '"/bin/sh"'

  - id: sh-single-quote
    desc: sh in single quotes
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: "'sh'"

  - id: sh-double-quote
    desc: sh in double quotes
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: '"sh"'

  - id: bash-c-flag
    desc: Bash -c command execution flag
    crit: suspicious
    conf: 0.85
    mbc: "C0017"
    attack: "T1059.004"
    for: [javascript]
    if:
      type: string
      exact: "'-c'"

  # Output/error handling (stealth indicators)
  - id: stdout-capture
    desc: Standard output capture
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: "stdout"

  - id: stderr-capture
    desc: Standard error capture
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: "stderr"

  - id: silent-true
    desc: Silent execution flag (hides output)
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    for: [javascript]
    if:
      type: string
      regex: "silent:\\s*true"

  - id: ignoreReturnCode
    desc: Ignore return code (hides errors)
    crit: suspicious
    conf: 0.8
    mbc: "F0005"
    for: [javascript]
    if:
      type: string
      exact: "ignoreReturnCode"

  # === Base64 decode atomic indicators ===
  - id: base64-dash-d
    desc: Base64 decode short flag
    crit: notable
    conf: 0.8
    mbc: "C0026"
    attack: "T1140"
    for: [javascript]
    if:
      type: string
      exact: "base64 -d"

  - id: base64-dash-decode
    desc: Base64 decode long flag
    crit: notable
    conf: 0.8
    mbc: "C0026"
    attack: "T1140"
    for: [javascript]
    if:
      type: string
      exact: "base64 --decode"

  - id: echo-pipe
    desc: Echo piped to command
    crit: notable
    conf: 0.75
    for: [javascript]
    if:
      type: string
      regex: "echo .{0,100} \\|"

  # Temp file operations
  - id: tmp-write
    desc: Write to /tmp directory
    crit: suspicious
    conf: 0.85
    mbc: "C0016"
    attack: "T1074.001"
    for: [javascript]
    if:
      type: string
      regex: "> /tmp/|>/tmp/"

  # === Tmp execute atomic indicators ===
  - id: tmp-bash-exec
    desc: Execute bash from /tmp
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1059"
    for: [javascript]
    if:
      type: string
      exact: "bash /tmp/"

  - id: tmp-sh-exec
    desc: Execute sh from /tmp
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1059"
    for: [javascript]
    if:
      type: string
      exact: "sh /tmp/"

  - id: tmp-dot-exec
    desc: Execute ./tmp path
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1059"
    for: [javascript]
    if:
      type: string
      exact: "./tmp/"

  # === Function constructor atomic indicators ===
  - id: function-dot-constructor
    desc: Function.constructor abuse
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.007"
    for: [javascript, typescript]
    if:
      type: string
      regex: "new\\s+Function\\.constructor\\("

  - id: new-function
    desc: new Function() code execution
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.007"
    for: [javascript, typescript]
    if:
      type: string
      regex: "new\\s+Function\\s*\\("

  # Detached child process (background execution)
  - id: detached-spawn
    desc: Detached child process (background execution)
    crit: suspicious
    conf: 0.85
    mbc: "F0011"
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: string
      regex: "detached:\\s*true"

  # Signal handler abuse (prevent termination)
  - id: sigint-handler
    desc: SIGINT handler (may prevent CTRL+C)
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "process\\.on\\s*\\(['\"]SIGINT['\"]"

  - id: sigterm-handler
    desc: SIGTERM handler (may prevent kill)
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "process\\.on\\s*\\(['\"]SIGTERM['\"]"

  # Process respawning (persistence via self-restart)
  - id: self-respawn
    desc: Self-respawning process
    crit: suspicious
    conf: 0.85
    mbc: "F0011"
    attack: "T1547"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule self_respawn {
          strings:
            $spawn = "spawn(" ascii
            $import_meta = "import.meta.url" ascii
            $process_argv = "process.argv" ascii
            $file = "__filename" ascii
          condition:
            $spawn and any of ($import_meta, $process_argv, $file)
        }

composite_rules:
  # Bash string reference composite
  - id: bash-string
    desc: Bash shell reference in string
    crit: notable
    conf: 0.75
    for: [javascript]
    requires_count: 1
    any:
      - id: bash-single-quote
      - id: bash-double-quote

  # Shell string reference composite
  - id: sh-string
    desc: Shell reference in string
    crit: notable
    conf: 0.7
    for: [javascript]
    requires_count: 1
    any:
      - id: bin-sh-single-quote
      - id: bin-sh-double-quote
      - id: sh-single-quote
      - id: sh-double-quote

  # Base64 decode CLI composite
  - id: base64-decode-cli
    desc: Base64 decode via CLI
    crit: suspicious
    conf: 0.9
    mbc: "C0026"
    attack: "T1140"
    for: [javascript]
    requires_count: 1
    any:
      - id: base64-dash-d
      - id: base64-dash-decode

  # Tmp execute composite
  - id: tmp-execute
    desc: Execute from /tmp directory
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059"
    for: [javascript]
    requires_count: 1
    any:
      - id: tmp-bash-exec
      - id: tmp-sh-exec
      - id: tmp-dot-exec

  # Function constructor composite
  - id: function-constructor
    desc: Function constructor code execution
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059.007"
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: function-dot-constructor
      - id: new-function
