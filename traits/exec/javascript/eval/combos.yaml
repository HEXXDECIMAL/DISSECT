# JavaScript Supply Chain Attack Detection
# Composite rules combining traits to detect malicious patterns

composite_rules:
  # Hidden shell execution (common in supply chain attacks)
  - id: hidden-shell-exec
    desc: Shell execution with output suppression
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059.004"
    for: [javascript]
    requires_all:
      - id: exec/javascript/getExecOutput
      - id: exec/javascript/silent-true

  # Base64 decode and execute pattern
  - id: base64-decode-exec
    desc: Decode and execute pattern (supply chain indicator)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059"
    for: [javascript]
    requires_all:
      - id: exec/javascript/base64-decode-cli
      - id: exec/javascript/bash-string

  # Temp file dropper pattern
  - id: tmp-dropper
    desc: Write to temp and execute
    crit: suspicious
    conf: 0.98
    mbc: "B0025"
    attack: "T1105"
    for: [javascript]
    requires_all:
      - id: exec/javascript/tmp-write
      - id: exec/javascript/tmp-execute

  # Silent error suppression (stealth)
  - id: silent-error-suppression
    desc: Silent execution with error suppression
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    for: [javascript]
    requires_count: 2
    any:
      - id: exec/javascript/silent-true
      - id: exec/javascript/ignoreReturnCode
      - id: exec/javascript/stderr-capture

  # Comprehensive supply chain attack pattern
  - id: supply-chain-exec
    desc: Supply chain attack execution pattern
    crit: suspicious
    conf: 0.98
    mbc: "B0024"
    attack: "T1195.002"
    for: [javascript]
    requires_count: 3
    any:
      - id: exec/javascript/getExecOutput
      - id: exec/javascript/bash-string
      - id: exec/javascript/base64-decode-cli
      - id: exec/javascript/silent-true
      - id: exec/javascript/tmp-write
      - id: exec/javascript/echo-pipe
