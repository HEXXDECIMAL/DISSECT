# Node.js VM Module Traits
# Detects sandbox execution and potential sandbox escape patterns
# MBC: B0024 (Sandbox Evasion), E1059 (Code Execution)
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  # VM Module Imports
  - id: vm-require
    desc: Node.js vm module import
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: string
      regex: "require\\(['\"]vm['\"]\\)|from ['\"]vm['\"]"

  - id: vm-createContext
    desc: VM createContext (sandbox creation)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "createContext"

  - id: vm-runInContext
    desc: VM runInContext (execute code in sandbox)
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "runInContext"

  - id: vm-runInNewContext
    desc: VM runInNewContext (execute in isolated context)
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "runInNewContext"

  - id: vm-runInThisContext
    desc: VM runInThisContext (execute in current context)
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "runInThisContext"

  - id: vm-Script
    desc: VM Script compilation
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "new vm\\.Script|vm\\.Script\\("

  # Remote Code Execution via VM
  - id: vm-with-http
    desc: VM execution combined with HTTP fetch (stage loader pattern)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1105"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule vm_remote_code_exec {
          strings:
            $vm1 = "runInContext"
            $vm2 = "runInNewContext"
            $http1 = "https.request"
            $http2 = "http.request"
            $http3 = "fetch("
            $http4 = "axios"
          condition:
            any of ($vm*) and any of ($http*)
        }

  # Sandbox Escape Patterns
  - id: constructor-escape
    desc: VM sandbox escape via constructor technique
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: string
      regex: "constructor\\s*\\(\\s*['\"]return this['\"]\\s*\\)|this\\.constructor\\.constructor"

  - id: process-binding
    desc: Access to process.binding (internal Node API)
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      exact: "process.binding"

  # Remote Code Loading via Function Constructor
  - id: function-with-http
    desc: Function constructor with HTTP fetch (remote code execution)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1105"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule function_remote_code_exec {
          strings:
            $func1 = "new Function(" ascii
            $func2 = "Function.constructor" ascii
            $func3 = "Function(" ascii
            $http1 = "axios.get" ascii
            $http2 = "axios(" ascii
            $http3 = "fetch(" ascii
            $http4 = "https.get" ascii
            $http5 = "http.get" ascii
            $http6 = ".request(" ascii
          condition:
            any of ($func*) and any of ($http*)
        }

  # Base64 encoded URL patterns (evasion)
  - id: base64-url
    desc: Base64 encoded URL (potential C2 obfuscation)
    crit: suspicious
    conf: 0.85
    mbc: "C0026"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule base64_url_pattern {
          strings:
            $decode1 = "atob(" ascii
            $decode2 = "Buffer.from" ascii
            $url_like = /[a-zA-Z0-9+\/=]{20,}/ ascii
            $http = /https?:\/\// ascii
            $env_key = /DEV_.*_KEY|API_.*KEY|SECRET/ ascii
          condition:
            any of ($decode*) and $url_like and ($http or $env_key)
        }
