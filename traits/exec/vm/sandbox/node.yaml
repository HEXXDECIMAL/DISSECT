# Node.js VM Module Traits
# Detects sandbox execution and potential sandbox escape patterns
# MBC: B0024 (Sandbox Evasion), E1059 (Code Execution)
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  # VM Module Imports
  - id: exec/vm/sandbox/vm-require
    description: Node.js vm module import
    criticality: notable
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"]vm['\"]\\)|from ['\"]vm['\"]"

  - id: exec/vm/sandbox/vm-createContext
    description: VM createContext (sandbox creation)
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "createContext"

  - id: exec/vm/sandbox/vm-runInContext
    description: VM runInContext (execute code in sandbox)
    criticality: suspicious
    confidence: 0.9
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "runInContext"

  - id: exec/vm/sandbox/vm-runInNewContext
    description: VM runInNewContext (execute in isolated context)
    criticality: suspicious
    confidence: 0.9
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "runInNewContext"

  - id: exec/vm/sandbox/vm-runInThisContext
    description: VM runInThisContext (execute in current context)
    criticality: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "runInThisContext"

  - id: exec/vm/sandbox/vm-Script
    description: VM Script compilation
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "new vm\\.Script|vm\\.Script\\("

  # Remote Code Execution via VM
  - id: exec/vm/sandbox/vm-with-http
    description: VM execution combined with HTTP fetch (stage loader)
    criticality: malicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule vm_remote_code_exec {
          strings:
            $vm1 = "runInContext"
            $vm2 = "runInNewContext"
            $http1 = "https.request"
            $http2 = "http.request"
            $http3 = "fetch("
            $http4 = "axios"
          condition:
            any of ($vm*) and any of ($http*)
        }

  # Sandbox Escape Patterns
  - id: exec/vm/sandbox/constructor-escape
    description: VM sandbox escape via constructor
    criticality: malicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "constructor\\s*\\(\\s*['\"]return this['\"]\\s*\\)|this\\.constructor\\.constructor"

  - id: exec/vm/sandbox/process-binding
    description: Access to process.binding (internal Node API)
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "process.binding"

  # Remote Code Loading via Function Constructor
  - id: exec/vm/sandbox/function-with-http
    description: Function constructor with HTTP fetch (remote code execution)
    criticality: malicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule function_remote_code_exec {
          strings:
            $func1 = "new Function(" ascii
            $func2 = "Function.constructor" ascii
            $func3 = "Function(" ascii
            $http1 = "axios.get" ascii
            $http2 = "axios(" ascii
            $http3 = "fetch(" ascii
            $http4 = "https.get" ascii
            $http5 = "http.get" ascii
            $http6 = ".request(" ascii
          condition:
            any of ($func*) and any of ($http*)
        }

  # Base64 encoded URL patterns (evasion)
  - id: exec/vm/sandbox/base64-url
    description: Base64 encoded URL (potential C2 obfuscation)
    criticality: suspicious
    confidence: 0.85
    mbc: "C0026"
    attack: "T1027"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule base64_url_pattern {
          strings:
            $decode1 = "atob(" ascii
            $decode2 = "Buffer.from" ascii
            $url_like = /[a-zA-Z0-9+\/=]{20,}/ ascii
            $http = /https?:\/\// ascii
            $env_key = /DEV_.*_KEY|API_.*KEY|SECRET/ ascii
          condition:
            any of ($decode*) and $url_like and ($http or $env_key)
        }
