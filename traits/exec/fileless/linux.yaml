# Linux Fileless Execution Techniques
# ATT&CK: T1620 (Reflective Code Loading)

defaults:
  attack: "T1620"

traits:
  # === memfd_create indicators (atomic) ===
  - id: memfd-create-fn
    desc: memfd_create function call
    crit: inert
    conf: 0.6
    for: [python, c, shell]
    if:
      type: string
      exact: "memfd_create"

  - id: sys-memfd-create
    desc: SYS_memfd_create constant
    crit: inert
    conf: 0.6
    for: [python, c, shell]
    if:
      type: string
      exact: "SYS_memfd_create"

  - id: syscall-319
    desc: memfd_create syscall number 319
    crit: inert
    conf: 0.4
    for: [python, c, shell]
    if:
      type: string
      exact: "319"

  - id: mfd-cloexec
    desc: MFD_CLOEXEC flag
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    if:
      type: string
      exact: "MFD_CLOEXEC"

  - id: libc-syscall
    desc: libc.syscall call
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    if:
      type: string
      exact: "libc.syscall"

  - id: syscall-paren
    desc: syscall( invocation
    crit: inert
    conf: 0.4
    for: [python, c, shell]
    if:
      type: string
      exact: "syscall("

  # === proc/self/fd indicators (atomic) ===
  - id: proc-self-fd
    desc: /proc/self/fd path
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    if:
      type: string
      exact: "/proc/self/fd"

  - id: proc-self-fd-slash
    desc: /proc/self/fd/ path
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    if:
      type: string
      exact: "/proc/self/fd/"

  # === exec indicators (atomic) ===
  - id: execv-fn
    desc: execv function call
    crit: inert
    conf: 0.4
    for: [python, c, shell]
    if:
      type: string
      exact: "execv"

  - id: execve-fn
    desc: execve function call
    crit: inert
    conf: 0.4
    for: [python, c, shell]
    if:
      type: string
      exact: "execve"

  - id: execl-fn
    desc: execl function call
    crit: inert
    conf: 0.4
    for: [python, c, shell]
    if:
      type: string
      exact: "execl"

  - id: os-exec
    desc: os.exec Python call
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: "os.exec"

  - id: subprocess-mod
    desc: subprocess module
    crit: inert
    conf: 0.3
    for: [python]
    if:
      type: string
      exact: "subprocess"

  # === ctypes indicators (atomic) ===
  - id: ctypes-mod
    desc: ctypes module
    crit: inert
    conf: 0.4
    for: [python]
    if:
      type: string
      exact: "ctypes"

  - id: ctypes-cdll
    desc: CDLL ctypes class
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: "CDLL"

  - id: libc-so
    desc: libc.so reference
    crit: inert
    conf: 0.4
    for: [python, c]
    if:
      type: string
      exact: "libc.so"

  - id: dot-syscall
    desc: .syscall( call
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: ".syscall("

  # === download indicators (atomic) ===
  - id: requests-get
    desc: requests.get HTTP call
    crit: inert
    conf: 0.4
    for: [python]
    if:
      type: string
      exact: "requests.get"

  - id: urllib-mod
    desc: urllib module
    crit: inert
    conf: 0.3
    for: [python]
    if:
      type: string
      exact: "urllib"

  - id: http-client
    desc: http.client module
    crit: inert
    conf: 0.3
    for: [python]
    if:
      type: string
      exact: "http.client"

  - id: dot-content
    desc: .content response attribute
    crit: inert
    conf: 0.3
    for: [python]
    if:
      type: string
      exact: ".content"

  # === write indicators (atomic) ===
  - id: os-write
    desc: os.write function
    crit: inert
    conf: 0.4
    for: [python]
    if:
      type: string
      exact: "os.write("

  - id: write-fd
    desc: write(fd call
    crit: inert
    conf: 0.4
    for: [python, c]
    if:
      type: string
      exact: "write(fd"

  - id: os-lseek
    desc: os.lseek function
    crit: inert
    conf: 0.4
    for: [python]
    if:
      type: string
      exact: "os.lseek("

  - id: seek-set
    desc: SEEK_SET constant
    crit: inert
    conf: 0.3
    for: [python, c]
    if:
      type: string
      exact: "SEEK_SET"

  # === shared memory indicators (atomic) ===
  - id: shm-open
    desc: shm_open function
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    if:
      type: string
      exact: "shm_open"

  - id: mmap-fn
    desc: mmap function
    crit: inert
    conf: 0.4
    for: [python, c]
    if:
      type: string
      exact: "mmap"

  - id: dev-shm
    desc: /dev/shm path
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    if:
      type: string
      exact: "/dev/shm"

composite_rules:
  # Exec function composite
  - id: exec-function
    desc: Execution function calls
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    count_min: 1
    any:
      - id: execv-fn
      - id: execve-fn
      - id: execl-fn
      - id: os-exec
      - id: subprocess-mod

  # Download indicators composite
  - id: http-download-python
    desc: Python HTTP download libraries for fetching remote content
    crit: notable
    conf: 0.8
    attack: "T1105"
    for: [python]
    count_min: 1
    any:
      - id: requests-get
      - id: urllib-mod
      - id: http-client
      - id: dot-content

  # Write to fd composite
  - id: fd-write-raw
    desc: Writes data to file descriptor (os.write or write syscall)
    crit: notable
    conf: 0.8
    for: [python, c]
    count_min: 1
    any:
      - id: os-write
      - id: write-fd

  # memfd_create syscall
  - id: memfd-create
    desc: Creates anonymous memory-backed file (memfd_create syscall)
    crit: suspicious
    conf: 0.95
    for: [python, c, shell]
    count_min: 1
    any:
      - id: memfd-create-fn
      - id: sys-memfd-create

  # proc/self/fd path
  - id: proc-fd-path
    desc: References /proc/self/fd path
    crit: inert
    conf: 0.5
    for: [python, c, shell]
    count_min: 1
    any:
      - id: proc-self-fd
      - id: proc-self-fd-slash

  # Execution from /proc/self/fd
  - id: proc-fd-exec
    desc: Executes binary from /proc/self/fd (fileless execution)
    crit: suspicious
    conf: 0.95
    for: [python, c, shell]
    all:
      - id: proc-fd-path
      - id: exec-function

  # ctypes syscall invocation
  - id: ctypes-syscall
    desc: Direct syscall invocation via ctypes
    crit: suspicious
    conf: 0.9
    attack: "T1106"
    for: [python]
    all:
      - id: ctypes-mod
      - id: dot-syscall
    count_min: 1
    any:
      - id: ctypes-cdll
      - id: libc-so

  # Write to fd with seek
  - id: fd-write
    desc: Writes binary data to file descriptor with seek
    crit: notable
    conf: 0.8
    for: [python]
    all:
      - id: os-write
    count_min: 1
    any:
      - id: os-lseek
      - id: seek-set

  # Download and memfd execution chain
  - id: download-memfd-exec
    desc: Downloads binary and executes via memfd (fileless dropper)
    crit: suspicious
    conf: 0.98
    for: [python, c, shell]
    all:
      - id: http-download-python
      - id: memfd-create
    count_min: 1
    any:
      - id: exec-function
      - id: fd-write-raw

  # shm_open for shared memory execution
  - id: shm-exec
    desc: Uses shared memory for fileless execution
    crit: suspicious
    conf: 0.9
    for: [python, c, shell]
    count_min: 2
    any:
      - id: shm-open
      - id: mmap-fn
      - id: dev-shm
      - id: execv-fn

  # Complete fileless dropper pattern
  - id: linux-dropper
    desc: Linux fileless dropper (download + memfd + exec)
    crit: hostile
    conf: 0.99
    for: [python, elf]
    all:
      - id: memfd-create
      - id: http-download-python
      - id: fd-write-raw
