# Linux Fileless Execution Techniques
# ATT&CK: T1620 (Reflective Code Loading)

defaults:
  attack: "T1620"

traits:
  # === memfd_create indicators (atomic) ===
  - id: memfd-create-fn
    description: memfd_create function call
    criticality: inert
    confidence: 0.6
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "memfd_create"

  - id: sys-memfd-create
    description: SYS_memfd_create constant
    criticality: inert
    confidence: 0.6
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "SYS_memfd_create"

  - id: syscall-319
    description: memfd_create syscall number 319
    criticality: inert
    confidence: 0.4
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "319"

  - id: mfd-cloexec
    description: MFD_CLOEXEC flag
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "MFD_CLOEXEC"

  - id: libc-syscall
    description: libc.syscall call
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "libc.syscall"

  - id: syscall-paren
    description: syscall( invocation
    criticality: inert
    confidence: 0.4
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "syscall("

  # === proc/self/fd indicators (atomic) ===
  - id: proc-self-fd
    description: /proc/self/fd path
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "/proc/self/fd"

  - id: proc-self-fd-slash
    description: /proc/self/fd/ path
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "/proc/self/fd/"

  # === exec indicators (atomic) ===
  - id: execv-fn
    description: execv function call
    criticality: inert
    confidence: 0.4
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "execv"

  - id: execve-fn
    description: execve function call
    criticality: inert
    confidence: 0.4
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "execve"

  - id: execl-fn
    description: execl function call
    criticality: inert
    confidence: 0.4
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "execl"

  - id: os-exec
    description: os.exec Python call
    criticality: inert
    confidence: 0.5
    file_types: [python]
    condition:
      type: string
      exact: "os.exec"

  - id: subprocess-mod
    description: subprocess module
    criticality: inert
    confidence: 0.3
    file_types: [python]
    condition:
      type: string
      exact: "subprocess"

  # === ctypes indicators (atomic) ===
  - id: ctypes-mod
    description: ctypes module
    criticality: inert
    confidence: 0.4
    file_types: [python]
    condition:
      type: string
      exact: "ctypes"

  - id: ctypes-cdll
    description: CDLL ctypes class
    criticality: inert
    confidence: 0.5
    file_types: [python]
    condition:
      type: string
      exact: "CDLL"

  - id: libc-so
    description: libc.so reference
    criticality: inert
    confidence: 0.4
    file_types: [python, c]
    condition:
      type: string
      exact: "libc.so"

  - id: dot-syscall
    description: .syscall( call
    criticality: inert
    confidence: 0.5
    file_types: [python]
    condition:
      type: string
      exact: ".syscall("

  # === download indicators (atomic) ===
  - id: requests-get
    description: requests.get HTTP call
    criticality: inert
    confidence: 0.4
    file_types: [python]
    condition:
      type: string
      exact: "requests.get"

  - id: urllib-mod
    description: urllib module
    criticality: inert
    confidence: 0.3
    file_types: [python]
    condition:
      type: string
      exact: "urllib"

  - id: http-client
    description: http.client module
    criticality: inert
    confidence: 0.3
    file_types: [python]
    condition:
      type: string
      exact: "http.client"

  - id: dot-content
    description: .content response attribute
    criticality: inert
    confidence: 0.3
    file_types: [python]
    condition:
      type: string
      exact: ".content"

  # === write indicators (atomic) ===
  - id: os-write
    description: os.write function
    criticality: inert
    confidence: 0.4
    file_types: [python]
    condition:
      type: string
      exact: "os.write("

  - id: write-fd
    description: write(fd call
    criticality: inert
    confidence: 0.4
    file_types: [python, c]
    condition:
      type: string
      exact: "write(fd"

  - id: os-lseek
    description: os.lseek function
    criticality: inert
    confidence: 0.4
    file_types: [python]
    condition:
      type: string
      exact: "os.lseek("

  - id: seek-set
    description: SEEK_SET constant
    criticality: inert
    confidence: 0.3
    file_types: [python, c]
    condition:
      type: string
      exact: "SEEK_SET"

  # === shared memory indicators (atomic) ===
  - id: shm-open
    description: shm_open function
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "shm_open"

  - id: mmap-fn
    description: mmap function
    criticality: inert
    confidence: 0.4
    file_types: [python, c]
    condition:
      type: string
      exact: "mmap"

  - id: dev-shm
    description: /dev/shm path
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    condition:
      type: string
      exact: "/dev/shm"

composite_rules:
  # Exec function composite
  - id: exec-function
    description: Execution function calls
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    requires_count: 1
    conditions:
      - id: execv-fn
      - id: execve-fn
      - id: execl-fn
      - id: os-exec
      - id: subprocess-mod

  # Download indicators composite
  - id: http-download-python
    description: Python HTTP download libraries for fetching remote content
    criticality: notable
    confidence: 0.8
    attack: "T1105"
    file_types: [python]
    requires_count: 1
    conditions:
      - id: requests-get
      - id: urllib-mod
      - id: http-client
      - id: dot-content

  # Write to fd composite
  - id: fd-write-raw
    description: Writes data to file descriptor (os.write or write syscall)
    criticality: notable
    confidence: 0.8
    file_types: [python, c]
    requires_count: 1
    conditions:
      - id: os-write
      - id: write-fd

  # memfd_create syscall
  - id: memfd-create
    description: Creates anonymous memory-backed file (memfd_create syscall)
    criticality: suspicious
    confidence: 0.95
    file_types: [python, c, shell]
    requires_count: 1
    conditions:
      - id: memfd-create-fn
      - id: sys-memfd-create

  # proc/self/fd path
  - id: proc-fd-path
    description: References /proc/self/fd path
    criticality: inert
    confidence: 0.5
    file_types: [python, c, shell]
    requires_count: 1
    conditions:
      - id: proc-self-fd
      - id: proc-self-fd-slash

  # Execution from /proc/self/fd
  - id: proc-fd-exec
    description: Executes binary from /proc/self/fd (fileless execution)
    criticality: suspicious
    confidence: 0.95
    file_types: [python, c, shell]
    requires_all:
      - id: proc-fd-path
      - id: exec-function

  # ctypes syscall invocation
  - id: ctypes-syscall
    description: Direct syscall invocation via ctypes
    criticality: suspicious
    confidence: 0.9
    attack: "T1106"
    file_types: [python]
    requires_all:
      - id: ctypes-mod
      - id: dot-syscall
    requires_count: 1
    conditions:
      - id: ctypes-cdll
      - id: libc-so

  # Write to fd with seek
  - id: fd-write
    description: Writes binary data to file descriptor with seek
    criticality: notable
    confidence: 0.8
    file_types: [python]
    requires_all:
      - id: os-write
    requires_count: 1
    conditions:
      - id: os-lseek
      - id: seek-set

  # Download and memfd execution chain
  - id: download-memfd-exec
    description: Downloads binary and executes via memfd (fileless dropper)
    criticality: suspicious
    confidence: 0.98
    file_types: [python, c, shell]
    requires_all:
      - id: http-download-python
      - id: memfd-create
    requires_count: 1
    conditions:
      - id: exec-function
      - id: fd-write-raw

  # shm_open for shared memory execution
  - id: shm-exec
    description: Uses shared memory for fileless execution
    criticality: suspicious
    confidence: 0.9
    file_types: [python, c, shell]
    requires_count: 2
    conditions:
      - id: shm-open
      - id: mmap-fn
      - id: dev-shm
      - id: execv-fn

  # Complete fileless dropper pattern
  - id: linux-dropper
    description: Linux fileless dropper (download + memfd + exec)
    criticality: hostile
    confidence: 0.99
    file_types: [python, elf]
    requires_all:
      - id: memfd-create
      - id: http-download-python
      - id: fd-write-raw
