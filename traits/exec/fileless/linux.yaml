# Linux Fileless Execution Techniques
# ATT&CK: T1620 (Reflective Code Loading)

traits:
  # memfd_create syscall for anonymous memory-backed file
  - id: memfd-create
    description: Creates anonymous memory-backed file (memfd_create syscall)
    criticality: suspicious
    confidence: 0.95
    attack: "T1620"
    file_types: [python, c, shell]
    condition:
      type: yara
      source: |
        rule memfd_create {
          strings:
            $memfd1 = "memfd_create" ascii
            $memfd2 = "SYS_memfd_create" ascii
            $syscall_num = "319" ascii
            $mfd_cloexec = "MFD_CLOEXEC" ascii
            $libc_syscall = "libc.syscall" ascii
            $syscall = "syscall(" ascii
          condition:
            any of ($memfd*) or ($syscall_num and any of ($mfd_cloexec, $libc_syscall, $syscall))
        }

  # Execution from /proc/self/fd (fileless execution)
  - id: proc-fd-exec
    description: Executes binary from /proc/self/fd (fileless execution)
    criticality: suspicious
    confidence: 0.95
    attack: "T1620"
    file_types: [python, c, shell]
    condition:
      type: yara
      source: |
        rule proc_fd_exec {
          strings:
            $proc_fd = "/proc/self/fd" ascii
            $proc_fd2 = "/proc/self/fd/" ascii
            $execv = "execv" ascii
            $execve = "execve" ascii
            $execl = "execl" ascii
            $os_exec = "os.exec" ascii
            $subprocess = "subprocess" ascii
          condition:
            any of ($proc_fd*) and any of ($execv, $execve, $execl, $os_exec, $subprocess)
        }

  # ctypes syscall invocation
  - id: ctypes-syscall
    description: Direct syscall invocation via ctypes
    criticality: suspicious
    confidence: 0.9
    attack: "T1106"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule ctypes_syscall {
          strings:
            $cdll = "CDLL" ascii
            $libc = "libc.so" ascii
            $syscall = ".syscall(" ascii
            $ctypes = "ctypes" ascii
          condition:
            $ctypes and ($cdll or $libc) and $syscall
        }

  # Download and memfd execution chain
  - id: download-memfd-exec
    description: Downloads binary and executes via memfd (fileless dropper)
    criticality: suspicious
    confidence: 0.98
    attack: "T1620"
    file_types: [python, c, shell]
    condition:
      type: yara
      source: |
        rule download_memfd_exec {
          strings:
            // Download indicators
            $dl1 = "requests.get" ascii
            $dl2 = "urllib" ascii
            $dl3 = "http.client" ascii
            $dl4 = ".content" ascii
            // memfd indicators
            $memfd1 = "memfd_create" ascii
            $memfd2 = "SYS_memfd_create" ascii
            $memfd3 = "MFD_CLOEXEC" ascii
            // Execution indicators
            $exec1 = "execv" ascii
            $exec2 = "os.exec" ascii
            $exec3 = "/proc/self/fd" ascii
            // Write to fd
            $write1 = "os.write" ascii
            $write2 = "write(fd" ascii
          condition:
            any of ($dl*) and any of ($memfd*) and (any of ($exec*) or any of ($write*))
        }

  # os.write to file descriptor
  - id: fd-write
    description: Writes binary data to file descriptor
    criticality: notable
    confidence: 0.8
    attack: "T1620"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule fd_write {
          strings:
            $os_write = "os.write(" ascii
            $os_lseek = "os.lseek(" ascii
            $seek_set = "SEEK_SET" ascii
          condition:
            $os_write and ($os_lseek or $seek_set)
        }

  # shm_open for shared memory execution
  - id: shm-exec
    description: Uses shared memory for fileless execution
    criticality: suspicious
    confidence: 0.9
    attack: "T1620"
    file_types: [python, c, shell]
    condition:
      type: yara
      source: |
        rule shm_exec {
          strings:
            $shm_open = "shm_open" ascii
            $mmap = "mmap" ascii
            $execv = "execv" ascii
            $dev_shm = "/dev/shm" ascii
          condition:
            ($shm_open and $mmap) or ($dev_shm and any of ($execv, $mmap))
        }

composite_rules:
  # Complete fileless dropper pattern
  - id: linux-dropper
    description: Linux fileless dropper (download + memfd + exec)
    criticality: hostile
    confidence: 0.99
    file_types: [python, elf]
    requires_all:
      - type: trait
        id: exec/fileless/memfd-create
      - type: string
        regex: 'requests\.get|urllib|http\.client'
      - type: string
        regex: 'os\.write|write\('
