# Windows Scripting Objects Detection
# ATT&CK: T1059.005 (Visual Basic), T1059.007 (JavaScript)
# Detects WScript, ActiveX, and COM object abuse

traits:
  # WScript.Shell execution
  - id: wscript-shell
    desc: WScript.Shell command execution
    crit: suspicious
    conf: 0.9
    attack: "T1059.005"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule wscript_shell {
          strings:
            $ws1 = "WScript.Shell" ascii
          condition:
            $ws1
        }

  # Scripting.FileSystemObject
  - id: filesystem-object
    desc: Scripting.FileSystemObject usage
    crit: suspicious
    conf: 0.85
    attack: "T1059.005"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule filesystem_object {
          strings:
            $fso = "FileSystemObject" ascii
          condition:
            $fso
        }

  # ActiveXObject creation
  - id: activex-object
    desc: ActiveXObject instantiation
    crit: notable
    conf: 0.8
    attack: "T1559.001"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule activex_object {
          strings:
            $ax = "ActiveXObject" ascii
          condition:
            $ax
        }

  # Shell.Application (explorer shell)
  - id: shell-application
    desc: Shell.Application COM object
    crit: suspicious
    conf: 0.85
    attack: "T1559.001"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule shell_application {
          strings:
            $sa = "Shell.Application" ascii
          condition:
            $sa
        }

  # MSXML HTTP request
  - id: msxml-http
    desc: MSXML HTTP request object
    crit: notable
    conf: 0.75
    attack: "T1071.001"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule msxml_http {
          strings:
            $xml1 = "MSXML2.XMLHTTP" ascii
            $xml2 = "Microsoft.XMLHTTP" ascii
            $xml3 = "Msxml2.ServerXMLHTTP" ascii
          condition:
            any of them
        }

  # WMI scripting
  - id: wmi-scripting
    desc: WMI scripting access
    crit: suspicious
    conf: 0.85
    attack: "T1047"
    for: [javascript, typescript, powershell]
    if:
      type: yara
      source: |
        rule wmi_scripting {
          strings:
            $wmi1 = "winmgmts:" ascii
            $wmi2 = "WbemScripting.SWbemLocator" ascii
          condition:
            any of them
        }

  # ADODB stream (file operations)
  - id: adodb-stream
    desc: ADODB.Stream for file operations
    crit: suspicious
    conf: 0.85
    attack: "T1059.005"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule adodb_stream {
          strings:
            $adodb = "ADODB.Stream" ascii
          condition:
            $adodb
        }

  # Schedule.Service (task scheduler)
  - id: schedule-service
    desc: Task Scheduler COM object access
    crit: suspicious
    conf: 0.9
    attack: "T1053.005"
    for: [javascript, typescript, powershell]
    if:
      type: yara
      source: |
        rule schedule_service {
          strings:
            $sched1 = "Schedule.Service" ascii
            $sched2 = "Win32_ScheduledJob" ascii
          condition:
            any of them
        }

  # Registry manipulation via scripting
  - id: registry-scripting
    desc: Registry manipulation via scripting
    crit: suspicious
    conf: 0.85
    attack: "T1112"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule registry_scripting {
          strings:
            $wsh = "WScript.Shell" ascii
            $reg1 = "RegRead" ascii
            $reg2 = "RegWrite" ascii
            $reg3 = "RegDelete" ascii
            $hklm = "HKLM" ascii
            $hkcu = "HKCU" ascii
          condition:
            $wsh and any of ($reg*) and any of ($hklm, $hkcu)
        }

  # Windows Script Host dropper
  - id: wsh-dropper
    desc: Windows Script Host dropper pattern (download and execute)
    crit: suspicious
    conf: 0.95
    attack: "T1059.005"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule wsh_dropper {
          strings:
            $wsh = "WScript.Shell" ascii
            $fso = "FileSystemObject" ascii
            $http1 = "MSXML2.XMLHTTP" ascii
            $http2 = "WinHttp" ascii
            $run = ".Run(" ascii
            $exec = ".Exec(" ascii
            $save = "SaveToFile" ascii
          condition:
            ($wsh or $fso) and any of ($http*) and any of ($run, $exec, $save)
        }
