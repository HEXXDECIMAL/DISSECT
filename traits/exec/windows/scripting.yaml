# Windows Scripting Objects Detection
# ATT&CK: T1059.005 (Visual Basic), T1059.007 (JavaScript)
# Detects WScript, ActiveX, and COM object abuse

traits:
  # WScript.Shell execution
  - id: wscript-shell-string
    desc: WScript.Shell string reference
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "WScript.Shell"

  # Scripting.FileSystemObject
  - id: filesystem-object-string
    desc: FileSystemObject string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "FileSystemObject"

  # ActiveXObject creation
  - id: activex-object-string
    desc: ActiveXObject string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "ActiveXObject"

  # Shell.Application (explorer shell)
  - id: shell-application-string
    desc: Shell.Application string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "Shell.Application"

  # MSXML HTTP request
  - id: msxml2-xmlhttp-string
    desc: MSXML2.XMLHTTP string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "MSXML2.XMLHTTP"

  - id: microsoft-xmlhttp-string
    desc: Microsoft.XMLHTTP string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "Microsoft.XMLHTTP"

  - id: msxml2-serverxmlhttp-string
    desc: Msxml2.ServerXMLHTTP string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "Msxml2.ServerXMLHTTP"

  # WMI scripting
  - id: winmgmts-string
    desc: winmgmts WMI moniker string
    crit: inert
    conf: 0.6
    for: [javascript, typescript, powershell]
    if:
      type: string
      exact: "winmgmts:"

  - id: wbemscripting-locator-string
    desc: WbemScripting.SWbemLocator string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript, powershell]
    if:
      type: string
      exact: "WbemScripting.SWbemLocator"

  # ADODB stream (file operations)
  - id: adodb-stream-string
    desc: ADODB.Stream string reference
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "ADODB.Stream"

  # Schedule.Service (task scheduler)
  - id: schedule-service-string
    desc: Schedule.Service string reference
    crit: inert
    conf: 0.7
    for: [javascript, typescript, powershell]
    if:
      type: string
      exact: "Schedule.Service"

  - id: win32-scheduledjob-string
    desc: Win32_ScheduledJob string reference
    crit: inert
    conf: 0.7
    for: [javascript, typescript, powershell]
    if:
      type: string
      exact: "Win32_ScheduledJob"

  # Registry manipulation keywords
  - id: regread-method
    desc: RegRead method call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "RegRead"

  - id: regwrite-method
    desc: RegWrite method call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "RegWrite"

  - id: regdelete-method
    desc: RegDelete method call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "RegDelete"

  - id: hklm-hive
    desc: HKLM registry hive reference
    crit: inert
    conf: 0.4
    for: [javascript, typescript, powershell]
    if:
      type: string
      exact: "HKLM"

  - id: hkcu-hive
    desc: HKCU registry hive reference
    crit: inert
    conf: 0.4
    for: [javascript, typescript, powershell]
    if:
      type: string
      exact: "HKCU"

  # WinHttp for droppers
  - id: winhttp-string
    desc: WinHttp string reference
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "WinHttp"

  # Method calls
  - id: run-method
    desc: .Run method call
    crit: inert
    conf: 0.4
    for: [javascript, typescript]
    if:
      type: string
      exact: ".Run("

  - id: exec-method
    desc: .Exec method call
    crit: inert
    conf: 0.4
    for: [javascript, typescript]
    if:
      type: string
      exact: ".Exec("

  - id: savetofile-method
    desc: SaveToFile method call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "SaveToFile"

# === Composite Rules ===
composite_rules:
  # WScript.Shell execution

  # MSXML HTTP request variants
  - id: msxml-http-variants
    desc: MSXML HTTP request object variants
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    any:
      - id: msxml2-xmlhttp-string
      - id: microsoft-xmlhttp-string
      - id: msxml2-serverxmlhttp-string


  # WMI scripting variants
  - id: wmi-scripting-patterns
    desc: WMI scripting patterns
    crit: inert
    conf: 0.7
    for: [javascript, typescript, powershell]
    any:
      - id: winmgmts-string
      - id: wbemscripting-locator-string


  # Schedule.Service variants
  - id: schedule-service-patterns
    desc: Task scheduler COM object patterns
    crit: inert
    conf: 0.8
    for: [javascript, typescript, powershell]
    any:
      - id: schedule-service-string
      - id: win32-scheduledjob-string


  # Registry operation methods
  - id: registry-methods
    desc: Registry manipulation methods
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    any:
      - id: regread-method
      - id: regwrite-method
      - id: regdelete-method

  # Registry hive references
  - id: registry-hives
    desc: Registry hive references
    crit: inert
    conf: 0.5
    for: [javascript, typescript, powershell]
    any:
      - id: hklm-hive
      - id: hkcu-hive

  # Registry manipulation via scripting
  - id: registry-scripting
    desc: Registry manipulation via scripting
    crit: suspicious
    conf: 0.85
    attack: "T1112"
    for: [javascript, typescript]
    all:
      - id: wscript-shell-string
      - id: registry-methods
      - id: registry-hives

  # HTTP objects for droppers
  - id: http-objects
    desc: HTTP objects for network access
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    any:
      - id: msxml-http-variants
      - id: winhttp-string

  # Execution methods
  - id: execution-methods
    desc: Code execution methods
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    any:
      - id: run-method
      - id: exec-method
      - id: savetofile-method

  # Shell or FSO objects
  - id: wsh-or-fso
    desc: WScript.Shell or FileSystemObject
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    any:
      - id: wscript-shell-string
      - id: filesystem-object-string

  # Windows Script Host dropper
  - id: wsh-dropper
    desc: Windows Script Host dropper pattern (download and execute)
    crit: suspicious
    conf: 0.95
    attack: "T1059.005"
    for: [javascript, typescript]
    all:
      - id: wsh-or-fso
      - id: http-objects
      - id: execution-methods
