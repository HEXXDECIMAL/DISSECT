---
# Ruby File Infector Detection
# Detects self-replicating malware that spreads by injecting into other files
# ATT&KT: T1029 (Scheduled Transfer), T1491.001 (Data Encrypted for Impact)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Directory Traversal ===
  - id: recursive-dir-traverse
    desc: Recursive directory enumeration
    crit: notable
    conf: 0.75
    attack: "T1083"
    if:
      type: ast_pattern
      node_type: call
      exact: "Dir.foreach"

  - id: recursive-call-self
    desc: Recursive function call for traversal
    crit: notable
    conf: 0.80
    attack: "T1083"
    if:
      type: ast_pattern
      node_type: call
      exact: "find_files"

  - id: depth-limit-param
    desc: Depth-limited recursion parameter
    crit: notable
    conf: 0.70
    attack: "T1083"
    if:
      type: string
      regex: 'max_depth|depth.{0,50}[0-9]'

  # === File Collection ===
  - id: file-array-append
    desc: File path collection in array
    crit: notable
    conf: 0.75
    attack: "T1083"
    if:
      type: ast_pattern
      node_type: call
      exact: "<<"

  - id: directory-array-append
    desc: Directory path collection in array
    crit: notable
    conf: 0.75
    attack: "T1083"
    if:
      type: string
      regex: 'directories.{0,50}<<|dirs.{0,50}<<'

  # === Extension Manipulation ===
  - id: file-extension-rename
    desc: File extension renaming
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    if:
      type: string
      regex: 'File\.rename.{0,50}\.rb|\.rb.{0,50}File\.rename'

  - id: split-extension
    desc: File name extension splitting
    crit: notable
    conf: 0.70
    attack: "T1027"
    if:
      type: string
      regex: 'split.{0,50}\.|file_name.{0,50}split'

  # === Self-Replication ===
  - id: self-file-reference
    desc: Self-reference via __FILE__
    crit: notable
    conf: 0.80
    attack: "T1059"
    if:
      type: string
      regex: '__FILE__|File\.basename.{0,50}__FILE__'

  - id: read-self-content
    desc: Reading own file content
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    if:
      type: string
      regex: 'File\.open.{0,50}__FILE__|File\.read.{0,50}__FILE__|file_malware\.read'

  - id: write-to-other-files
    desc: Writing content to other files
    crit: suspicious
    conf: 0.90
    attack: "T1059"
    if:
      type: string
      regex: 'File\.open.{0,50}w.{0,50}file|file_target\.write|write\(content'

  # === Self-Preservation ===
  - id: skip-self-check
    desc: Skip self to avoid infection
    crit: notable
    conf: 0.80
    attack: "T1070"
    if:
      type: string
      regex: 'next if file == __FILE__|file_name\[0\].{0,50}malware\.rb|file_name\[0\].{0,50}main\.rb'

  - id: exception-swallow-file-ops
    desc: Exception swallowing for file operations
    crit: notable
    conf: 0.75
    attack: "T1070"
    if:
      type: string
      regex: 'rescue.{0,50}next|begin.{0,50}rescue.{0,50}File'

composite_rules:
  # === File Enumerator ===
  - id: file-enumerator
    desc: Recursive file enumeration behavior
    crit: notable
    conf: 0.80
    attack: "T1083"
    count_min: 2
    any:
      - id: recursive-dir-traverse
      - id: recursive-call-self
      - id: file-array-append
      - id: depth-limit-param

  # === Extension Spoofer ===
  - id: extension-spoofer
    desc: File extension manipulation
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    count_min: 2
    any:
      - id: file-extension-rename
      - id: split-extension

  # === Self-Replicator ===
  - id: self-replicator
    desc: Self-replicating malware behavior
    crit: suspicious
    conf: 0.92
    attack: "T1059"
    count_min: 3
    any:
      - id: self-file-reference
      - id: read-self-content
      - id: write-to-other-files
      - id: skip-self-check

  # === File Infector Virus ===
  - id: file-infector-virus
    desc: File infector virus spreads by injecting code into other files
    crit: suspicious
    conf: 0.95
    attack: "T1491.001"
    count_min: 5
    any:
      - id: recursive-dir-traverse
      - id: recursive-call-self
      - id: file-extension-rename
      - id: read-self-content
      - id: write-to-other-files
      - id: skip-self-check
      - id: exception-swallow-file-ops
      - id: file-array-append
