# macOS Application Trojanization
# Detects replacement of legitimate applications with malicious versions
# ATT&CK: T1574.001 (Hijack Execution Flow: DLL Search Order Hijacking)
# Note: Conceptually similar - replacing legitimate executables

defaults:
  attack: "T1574.001"
  platforms: [macos]
  criticality: suspicious

traits:
  # Ledger Live application path
  - id: ledger-app-path
    description: "Ledger Live application path reference"
    confidence: 0.85
    condition:
      type: string
      exact: "/Applications/Ledger Live.app"

  # === pkill atomic indicators ===
  - id: pkill-ledger-live
    description: pkill Ledger Live
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "pkill.*Ledger Live"

  - id: killall-ledger
    description: killall Ledger
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "killall.*Ledger"

  # === Remove applications atomic indicators ===
  - id: rm-applications-dir
    description: rm -r /Applications/
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "rm\\s+-r.*\"/Applications/"

  - id: sudo-rm-app
    description: sudo rm .app
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "sudo.*rm.*\\.app"

  # === Unzip applications atomic indicators ===
  - id: unzip-to-applications
    description: unzip to /Applications
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "unzip.*/Applications"

  - id: unzip-d-applications
    description: unzip -d /Applications
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "unzip.*-d.*/Applications"

  # === Download app atomic indicators ===
  - id: curl-app-zip
    description: curl .app.zip download
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "curl.*\\.app\\.zip"

  - id: curl-app-archive
    description: curl app.zip download
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "curl.*app\\.zip"

  - id: wget-app-zip
    description: wget .app.zip download
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "wget.*\\.app\\.zip"

  # === App replacement atomic indicators ===
  - id: rm-app-unzip
    description: rm .app && unzip pattern
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "rm.*\\.app.*&&.*unzip"

  - id: rm-app-cp
    description: rm .app && cp pattern
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "rm.*\\.app.*&&.*cp"

composite_rules:
  - id: pkill-ledger
    description: "Kill Ledger Live process"
    confidence: 0.9
    requires_count: 1
    conditions:
      - id: pkill-ledger-live
      - id: killall-ledger

  - id: rm-applications
    description: "Remove application from /Applications"
    criticality: suspicious
    confidence: 0.9
    requires_count: 1
    conditions:
      - id: rm-applications-dir
      - id: sudo-rm-app

  - id: unzip-applications
    description: "Unzip to /Applications directory"
    criticality: suspicious
    confidence: 0.85
    requires_count: 1
    conditions:
      - id: unzip-to-applications
      - id: unzip-d-applications

  - id: download-app-zip
    description: "Download application archive"
    criticality: suspicious
    confidence: 0.85
    requires_count: 1
    conditions:
      - id: curl-app-zip
      - id: curl-app-archive
      - id: wget-app-zip

  - id: app-replacement
    description: "Application replacement pattern"
    criticality: suspicious
    confidence: 0.8
    requires_count: 1
    conditions:
      - id: rm-app-unzip
      - id: rm-app-cp

  # App termination group
  - id: app-termination
    description: App termination or removal
    criticality: suspicious
    confidence: 0.8
    file_types: [shell, applescript, python]
    requires_count: 1
    conditions:
      - id: pkill-ledger
      - id: rm-applications

  # App replacement group
  - id: app-replace-action
    description: App replacement action
    criticality: suspicious
    confidence: 0.8
    file_types: [shell, applescript, python]
    requires_count: 1
    conditions:
      - id: unzip-applications
      - id: download-app-zip

  # Ledger Live replacement attack
  - id: ledger-trojanize
    description: "Ledger Live application replacement attack"
    criticality: hostile
    confidence: 0.95
    attack: "T1574.001"
    file_types: [shell, applescript, python]
    requires_all:
      - id: ledger-app-path
      - id: app-termination
      - id: app-replace-action

  # Generic app replacement
  - id: app-trojanize
    description: "macOS application replacement attack"
    criticality: suspicious
    confidence: 0.9
    attack: "T1574.001"
    file_types: [shell, applescript, python]
    requires_all:
      - id: rm-applications
      - id: unzip-applications
