# Lateral Movement - SSH Attack Traits
# ATT&CK: T1021.004 (Remote Services: SSH)
# MBC: E1021

traits:
  # === Atomic: SSH Attack Terminology ===

  # === Atomic: SSH Attack Terminology ===
  - id: ssh-attack-suffix
    description: SSH attack function/variable (ssh_attack, ssh-attack, sshattack)
    crit: notable
    confidence: 0.8
    attack: "T1021.004"
    platforms: [all]
    condition:
      type: string
      regex: "[Ss][Ss][Hh][_\\-]?[Aa]ttack"

  - id: attack-ssh-prefix
    description: Attack SSH function/variable (attack_ssh, attack-ssh, attackssh)
    crit: notable
    confidence: 0.8
    attack: "T1021.004"
    platforms: [all]
    condition:
      type: string
      regex: "[Aa]ttack[_\\-]?[Ss][Ss][Hh]"

  - id: ssh-boom
    description: SSH boom function/variable reference
    crit: notable
    confidence: 0.8
    attack: "T1021.004"
    platforms: [all]
    condition:
      type: string
      regex: "ssh[_\\-]?boom"

  # === Atomic: SSH Configuration Abuse ===

  - id: dot-ssh-ref
    description: References .ssh directory
    crit: notable
    confidence: 0.5
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: ".ssh"

  - id: strict-host-disable
    description: StrictHostKeyChecking reference (bypass host verification)
    crit: suspicious
    confidence: 0.75
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "StrictHostKeyChecking"

  - id: known-hosts-bypass
    description: UserKnownHostsFile reference (bypass known hosts)
    crit: suspicious
    confidence: 0.75
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "UserKnownHostsFile"

  - id: connect-timeout
    description: ConnectTimeout reference (scripted SSH)
    crit: notable
    confidence: 0.6
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "ConnectTimeout"

  # === Atomic: SSH Key Files ===
  # NOTE: id_rsa, authorized_keys, known_hosts are defined in cred/ssh/key/
  # Use cred/ssh/key directory reference in composite rules for those traits

  - id: key-pem
    description: References .pem key file
    crit: notable
    confidence: 0.6
    attack: "T1552.004"
    platforms: [all]
    condition:
      type: string
      exact: ".pem"

  - id: key-identity-file
    description: IdentityFile SSH config option
    crit: notable
    confidence: 0.6
    attack: "T1552.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "IdentityFile"

  - id: ssh-config-parse
    description: Parses SSH config for hostnames
    crit: suspicious
    confidence: 0.8
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "grep.{0,30}HostName.{0,30}/\\.ssh/config"

  # === Bash history SSH atomic indicators ===
  - id: ssh-bash-history
    description: ssh with bash_history
    crit: inert
    confidence: 0.7
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "ssh.{2,64}bash_history"

  - id: scp-bash-history
    description: scp with bash_history
    crit: inert
    confidence: 0.7
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "scp.{2,64}bash_history"

  - id: getent-hosts
    description: Uses getent for host discovery
    crit: suspicious
    confidence: 0.75
    attack: "T1018"
    platforms: [linux, unix]
    condition:
      type: string
      exact: "getent ahostsv4"

  # === Atomic: Remote Payload Delivery ===

  # Removed: remote-curl, remote-wget, remote-lwp (better covered by net/download/ traits)

composite_rules:
  # SSH attack terminology composite
  - id: attack-ref
    description: SSH attack function/variable reference
    crit: suspicious
    confidence: 0.9
    attack: "T1021.004"
    platforms: [all]
    count: 1
    any:
      - id: ssh-attack-suffix
      - id: attack-ssh-prefix
      - id: ssh-boom

  - id: bash-history-ssh
    description: Extracts SSH targets from bash history
    crit: suspicious
    confidence: 0.85
    attack: "T1021.004"
    platforms: [linux, macos, unix]
    count: 1
    any:
      - id: ssh-bash-history
      - id: scp-bash-history

