# Lateral Movement - SSH Worm Composite Rules
# ATT&CK: T1021.004 (Remote Services: SSH)

composite_rules:
  # === SSH Worm Detection ===

  - id: shell-worm
    description: SSH worm implemented in shell script
    criticality: suspicious
    confidence: 0.95
    attack: "T1021.004"
    mbc: "E1021"
    file_types: [shell]
    requires_all:
      - type: trait
        id: dot-ssh-ref
    requires_count: 3
    conditions:
      - type: trait
        id: strict-host-disable
      - type: trait
        id: known-hosts-bypass
      - type: trait
        id: connect-timeout
      - type: trait
        id: remote-curl
      - type: trait
        id: remote-wget
      - type: trait
        id: authorized-keys
      - type: trait
        id: known-hosts-file
      - type: trait
        id: ssh-config-parse

  # === SSH Attack Tool ===
  # NOTE: attack-ref is a single condition composite rule, moved to traits section
  # in lateral/ssh/connect/traits.yaml

  # === SSH Key Theft + Lateral Movement ===

  - id: key-based-spread
    description: SSH key theft for lateral movement
    criticality: suspicious
    confidence: 0.85
    attack: "T1552.004"
    file_types: [elf, shell]
    requires_all:
      - type: trait
        id: dot-ssh-ref
    requires_any:
      - type: trait
        id: key-id-rsa
      - type: trait
        id: key-pem

  # === SSH Host Discovery ===

  - id: host-discovery
    description: SSH target host discovery
    criticality: suspicious
    confidence: 0.8
    attack: "T1018"
    file_types: [elf, shell]
    requires_count: 2
    conditions:
      - type: trait
        id: authorized-keys
      - type: trait
        id: known-hosts-file
      - type: trait
        id: ssh-config-parse
      - type: trait
        id: bash-history-ssh
      - type: trait
        id: getent-hosts
