# Lateral Movement - Exploit Scanner/Deployer (Python)
# Mass exploitation tools that iterate over IP lists
# ATT&CK: T1210 (Exploitation of Remote Services)

defaults:
  file_types: [python]
  attack: "T1210"

traits:
  # Reading IP list from file
  - id: ip-list-read
    description: Reading IP addresses from file
    crit: notable
    confidence: 0.7
    condition:
      type: string
      regex: "open\\([^)]*\\)\\.(read|readlines)\\(\\)"

  # POST request to variable IP/host
  - id: post-to-target
    description: HTTP POST to dynamic target
    crit: notable
    confidence: 0.6
    condition:
      type: string
      regex: "(requests|aiohttp|httpx)\\.post\\s*\\(\\s*f['\"]"

  # === Threading atomic indicators ===
  - id: threading-dot-thread
    description: threading.Thread usage
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "threading.Thread"

  - id: threading-dot-start
    description: threading.start usage
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "threading.start"

  # Exploit path patterns (common vuln endpoints)
  - id: exploit-endpoint
    description: Common exploit endpoint pattern
    crit: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: '\\$[0-9]{4,5}|/cgi-bin/|/admin/|/wp-admin|shell\\.php|cmd\\.asp'

  # IP list sources - command line argument
  - id: ip-list-argv
    description: IP list from command line argument
    crit: notable
    confidence: 0.6
    condition:
      type: string
      exact: "sys.argv[1]"

  # === IP list variable atomic indicators ===
  - id: ip-list-word
    description: ip_list variable naming
    crit: inert
    confidence: 0.4
    condition:
      type: string
      exact: "ip_list"

  - id: targets-word
    description: targets variable naming
    crit: inert
    confidence: 0.4
    condition:
      type: string
      exact: "targets"

  # HTTP library - requests.post
  - id: http-requests-post
    description: HTTP POST via requests library
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "requests.post"

  # HTTP library - aiohttp
  - id: http-aiohttp
    description: Async HTTP via aiohttp library
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "aiohttp"

  # HTTP library - httpx.post
  - id: http-httpx-post
    description: HTTP POST via httpx library
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "httpx.post"

  # HTTP library - urllib
  - id: http-urllib
    description: HTTP via urllib library
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "urllib"

  # Exploit indicator - exploit keyword
  - id: exploit-keyword
    description: Contains exploit keyword
    crit: notable
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)exploit"

  # Exploit indicator - payload keyword
  - id: payload-keyword
    description: Contains payload keyword
    crit: notable
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)payload"

  # Exploit indicator - shell keyword
  - id: shell-keyword
    description: Contains shell keyword
    crit: notable
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)shell"

  # Exploit indicator - pawn keyword
  - id: pawn-keyword
    description: Contains pawn keyword
    crit: notable
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)pawn"

  # Threading - Thread class
  - id: threading-thread
    description: Uses threading.Thread class
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "threading.Thread"

  # Async - asyncio
  - id: asyncio-usage
    description: Uses asyncio library
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "asyncio"

  # Multiprocessing
  - id: multiprocessing-usage
    description: Uses multiprocessing library
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "multiprocessing"

  # SSL bypass - verify=False
  - id: ssl-verify-false
    description: SSL verify disabled
    crit: notable
    confidence: 0.6
    condition:
      type: string
      exact: "verify=False"

  # SSL bypass - verify_ssl=False
  - id: ssl-verify-ssl-false
    description: SSL verify_ssl disabled
    crit: notable
    confidence: 0.6
    condition:
      type: string
      exact: "verify_ssl=False"

  # SSL bypass - InsecureRequestWarning
  - id: ssl-insecure-warning
    description: Suppresses InsecureRequestWarning
    crit: notable
    confidence: 0.6
    condition:
      type: string
      exact: "InsecureRequestWarning"

  # File upload - files dict pattern
  - id: files-dict
    description: Files dict for upload
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "files={"

  # File upload - multipart
  - id: multipart-upload
    description: Multipart file upload
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: "multipart"

  # File open call
  - id: file-open
    description: File open call
    crit: notable
    confidence: 0.4
    condition:
      type: string
      exact: "open("

  # Binary read mode
  - id: binary-read-mode
    description: Binary read mode
    crit: notable
    confidence: 0.4
    condition:
      type: string
      exact: "'rb'"

  # HTTP post method
  - id: http-post-call
    description: HTTP POST method call
    crit: notable
    confidence: 0.5
    condition:
      type: string
      exact: ".post("

  # For loop iteration
  - id: for-loop-iteration
    description: For loop iteration pattern
    crit: notable
    confidence: 0.4
    condition:
      type: string
      regex: "for\\s+\\w+\\s+in\\s+"

composite_rules:
  # IP list variable composite
  - id: ip-list-var
    description: IP list variable naming pattern
    crit: notable
    confidence: 0.5
    requires_count: 1
    any:
      - id: ip-list-word
      - id: targets-word

  # Threaded requests composite
  - id: threaded-requests
    description: Multi-threaded network requests
    crit: notable
    confidence: 0.6
    requires_count: 1
    any:
      - id: threading-dot-thread
      - id: threading-dot-start

  # SSL disabled composite
  - id: ssl-disabled
    description: SSL certificate verification disabled
    crit: suspicious
    confidence: 0.8
    requires_count: 1
    any:
      - id: ssl-verify-false
      - id: ssl-verify-ssl-false
      - id: ssl-insecure-warning

  # Mass exploit scanner/deployer
  - id: mass-exploiter
    description: Mass exploitation tool (IP list + payload delivery)
    crit: suspicious
    confidence: 0.95
    attack: "T1210"
    mbc: "B0030"
    requires_any:
      - id: ip-list-read
      - id: exploit-keyword
      - id: payload-keyword

  # Vulnerability scanner with file upload
  - id: file-upload-exploit
    description: File upload exploitation tool
    crit: suspicious
    confidence: 0.9
    attack: "T1210"
    requires_all:
      - id: files-dict
      - id: file-open
      - id: http-post-call
