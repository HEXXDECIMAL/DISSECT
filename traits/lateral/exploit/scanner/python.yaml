# Lateral Movement - Exploit Scanner/Deployer (Python)
# Mass exploitation tools that iterate over IP lists
# ATT&CK: T1210 (Exploitation of Remote Services)

defaults:
  file_types: [python]
  attack: "T1210"

traits:
  # Reading IP list from file
  - id: ip-list-read
    description: Reading IP addresses from file
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "open\\([^)]*\\)\\.(read|readlines)\\(\\)"

  # POST request to variable IP/host
  - id: post-to-target
    description: HTTP POST to dynamic target
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      regex: "(requests|aiohttp|httpx)\\.post\\s*\\(\\s*f['\"]"

  # Threading with network requests
  - id: threaded-requests
    description: Multi-threaded network requests
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      regex: "threading\\.(Thread|start)"

  # SSL verification disabled
  - id: ssl-disabled
    description: SSL certificate verification disabled
    criticality: suspicious
    confidence: 0.8
    condition:
      type: string
      regex: "verify\\s*=\\s*False|verify_ssl\\s*=\\s*False|InsecureRequestWarning"

  # Exploit path patterns (common vuln endpoints)
  - id: exploit-endpoint
    description: Common exploit endpoint pattern
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: '\\$[0-9]{4,5}|/cgi-bin/|/admin/|/wp-admin|shell\\.php|cmd\\.asp'

composite_rules:
  # Mass exploit scanner/deployer
  - id: mass-exploiter
    description: Mass exploitation tool (IP list + payload delivery)
    criticality: suspicious
    confidence: 0.95
    attack: "T1210"
    mbc: "B0030"
    condition:
      type: yara
      source: |
        rule mass_exploit_scanner {
          meta:
            description = "Detects mass exploitation/scanning tools"
          strings:
            // IP list reading
            $ips1 = /open\([^)]+\)\.readlines?\(\)/ ascii
            $ips2 = "sys.argv[1]" ascii
            $ips3 = "ip_list" ascii nocase
            $ips4 = "targets" ascii nocase
            // HTTP libraries
            $http1 = "requests.post" ascii
            $http2 = "aiohttp" ascii
            $http3 = "httpx.post" ascii
            $http4 = "urllib" ascii
            // Exploit indicators
            $exploit1 = "exploit" ascii nocase
            $exploit2 = "payload" ascii nocase
            $exploit3 = "shell" ascii nocase
            $exploit4 = "pawn" ascii nocase
            // Multi-threading/async
            $thread1 = "threading.Thread" ascii
            $thread2 = "asyncio" ascii
            $thread3 = "multiprocessing" ascii
            // SSL bypass
            $ssl1 = "verify=False" ascii
            $ssl2 = "verify_ssl=False" ascii
            $ssl3 = "InsecureRequestWarning" ascii
          condition:
            filesize < 1MB and
            any of ($ips*) and
            any of ($http*) and
            any of ($exploit*) and
            (any of ($thread*) or any of ($ssl*))
        }

  # Vulnerability scanner with file upload
  - id: file-upload-exploit
    description: File upload exploitation tool
    criticality: suspicious
    confidence: 0.9
    attack: "T1210"
    condition:
      type: yara
      source: |
        rule file_upload_exploiter {
          meta:
            description = "File upload vulnerability exploiter"
          strings:
            $files1 = "files={" ascii
            $files2 = 'files={"file"' ascii
            $files3 = "multipart" ascii
            $open = 'open(' ascii
            $rb = "'rb'" ascii
            $post = ".post(" ascii
            $for = /for\s+\w+\s+in\s+/ ascii
          condition:
            filesize < 1MB and
            any of ($files*) and
            $open and $rb and $post and $for
        }
