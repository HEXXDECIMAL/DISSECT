traits:
  # VSCode Extension API Usage
  - id: workspace-findFiles
    description: VSCode workspace.findFiles API call (file enumeration)
    criticality: notable
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "workspace.findFiles"

  - id: fs-readFile
    description: VSCode workspace.fs.readFile API call (file reading)
    criticality: notable
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "workspace.fs.readFile"

  - id: openTextDocument
    description: VSCode workspace.openTextDocument API call
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "openTextDocument"

  - id: globalState
    description: VSCode extension globalState access
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "globalState"

  # === Extension Activation atomic indicators ===
  - id: function-activate
    description: function activate definition
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "function activate"

  - id: async-function-activate
    description: async function activate definition
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "async function activate"

  - id: export-activate
    description: export activate pattern
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "export.*activate"

  # === Extension Deactivation atomic indicators ===
  - id: function-deactivate
    description: function deactivate definition
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "function deactivate"

  - id: export-deactivate
    description: export deactivate pattern
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "export.*deactivate"

  # Suspicious VSCode Extension Behaviors
  # IMPORTANT: Requires VSCode markers to avoid FPs on regular npm packages
  - id: env-access
    description: Access to process.env in VSCode extension
    criticality: suspicious
    confidence: 0.85
    mbc: "E1592"
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule vscode_env_access {
          strings:
            $vscode1 = "vscode.commands"
            $vscode2 = "vscode.window"
            $vscode3 = "vscode.workspace"
            $vscode4 = "vscode.extensions"
            $vscode5 = "function activate"
            $env = "process.env"
          condition:
            any of ($vscode*) and $env
        }

  - id: clipboard-write
    description: VSCode clipboard write access
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "clipboard.writeText"

  - id: clipboard-read
    description: VSCode clipboard read access
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "clipboard.readText"

  # Telemetry/Exfiltration Patterns
  # IMPORTANT: Requires VSCode markers to avoid FPs on regular npm packages
  - id: external-request
    description: HTTP request in VSCode extension (potential exfiltration)
    criticality: suspicious
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule vscode_external_request {
          strings:
            $vscode1 = "vscode.commands"
            $vscode2 = "vscode.window"
            $vscode3 = "vscode.workspace"
            $vscode4 = "vscode.extensions"
            $vscode5 = "function activate"
            $http1 = "https.request"
            $http2 = "http.request"
            $http3 = "axios"
            $http4 = "node-fetch"
            $http5 = "fetch("
          condition:
            any of ($vscode*) and any of ($http*)
        }

  - id: telemetry-event
    description: VSCode telemetry event sending
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "sendTelemetryEvent"

composite_rules:
  # Activate composite
  - id: activate
    description: VSCode extension activate function
    criticality: inert
    confidence: 1.0
    file_types: [javascript, typescript]
    requires_count: 1
    conditions:
      - id: function-activate
      - id: async-function-activate
      - id: export-activate

  # Deactivate composite
  - id: deactivate
    description: VSCode extension deactivate function
    criticality: inert
    confidence: 1.0
    file_types: [javascript, typescript]
    requires_count: 1
    conditions:
      - id: function-deactivate
      - id: export-deactivate
