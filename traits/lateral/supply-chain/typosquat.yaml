# Supply Chain - Typosquatting Domain Detection (Python/PyPI)
# Detects typosquatting domains that impersonate legitimate package repositories
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)

defaults:
  file_types: [python]
  mbc: "B0030"
  attack: "T1195.002"
  criticality: suspicious

traits:
  # Fake PyPI file hosting domains (AST-based for accuracy)
  - id: fake-pypi-host
    description: "Typosquatted PyPI file hosting domain"
    confidence: 0.98
    criticality: suspicious
    condition:
      type: ast_pattern
      node_type: string
      pattern: "pypihosted.org"
      case_insensitive: true

  # Fake PyPI file hosting domains - raw search fallback
  - id: fake-pypi-host-raw
    description: "Typosquatted PyPI file hosting domain"
    confidence: 0.95
    criticality: suspicious
    condition:
      type: string
      regex: "pypihosted\\.org|pythonhosted\\.com|pypi-files\\.|pypyhosted\\.|pythonhost\\."
      search_raw: true

  # Fake PyPI index domains
  - id: fake-pypi-index
    description: "Typosquatted PyPI index domain"
    confidence: 0.95
    criticality: suspicious
    condition:
      type: string
      regex: "pypii\\.org|pipy\\.org|pyp1\\.org|pypl\\.org|py-pi\\."
      search_raw: true

  # Suspicious package download from non-official source
  - id: unofficial-package-source
    description: "Package download from unofficial source"
    confidence: 0.85
    condition:
      type: string
      # pip install from URL that's not pypi.org or pythonhosted.org
      regex: "pip\\s+install\\s+https?://(?!pypi\\.org|files\\.pythonhosted\\.org)[a-zA-Z0-9.-]+/"
      search_raw: true

  # Fake PyPI-like domains in URLs (YARA-based)
  - id: fake-pypi-url-domain
    description: "URL containing fake PyPI-like domain"
    confidence: 0.90
    criticality: suspicious
    condition:
      type: yara
      source: |
        rule fake_pypi_package_download {
          meta:
            description = "Detects package downloads from fake PyPI domains"
          strings:
            $fake_host = /https?:\/\/[a-z]*pypi[a-z]*\.(org|com|net)/ ascii nocase
            $fake_python = /https?:\/\/[a-z]*python[a-z]*hosted\.(org|com|net)/ ascii nocase
            $package_ext = /\.(tar\.gz|whl|zip)/ ascii
          condition:
            ($fake_host or $fake_python) and $package_ext
        }

  # Python package file extensions
  - id: python-package-extension
    description: "Python package file extension"
    confidence: 0.70
    criticality: notable
    condition:
      type: string
      regex: "\\.(tar\\.gz|whl|zip)"
      search_raw: true

composite_rules:
  # URL pointing to tar.gz/whl on suspicious domain
  - id: fake-package-download
    description: "Package download URL from typosquatted domain"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    requires_any:
      - type: trait
        id: fake-pypi-host
      - type: trait
        id: fake-pypi-host-raw
      - type: trait
        id: fake-pypi-index
      - type: trait
        id: fake-pypi-url-domain
