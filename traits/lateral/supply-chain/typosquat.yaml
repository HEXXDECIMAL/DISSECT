# Supply Chain - Typosquatting Domain Detection (Python/PyPI)
# Detects typosquatting domains that impersonate legitimate package repositories
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)

defaults:
  file_types: [python]
  mbc: "B0030"
  attack: "T1195.002"
  crit: suspicious

traits:
  # Fake PyPI file hosting domains (AST-based for accuracy)
  - id: fake-pypi-host
    description: "Typosquatted PyPI file hosting domain"
    confidence: 0.98
    crit: suspicious
    condition:
      type: ast_pattern
      node_type: string
      pattern: "pypihosted.org"
      case_insensitive: true

  # === Fake PyPI host atomic indicators ===
  - id: pypihosted-org
    description: pypihosted.org typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pypihosted.org"
      search_raw: true

  - id: pythonhosted-com
    description: pythonhosted.com typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pythonhosted.com"
      search_raw: true

  - id: pypi-files-domain
    description: pypi-files. typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pypi-files."
      search_raw: true

  - id: pypyhosted-domain
    description: pypyhosted. typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pypyhosted."
      search_raw: true

  - id: pythonhost-domain
    description: pythonhost. typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pythonhost."
      search_raw: true

  # === Fake PyPI index atomic indicators ===
  - id: pypii-org
    description: pypii.org typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pypii.org"
      search_raw: true

  - id: pipy-org
    description: pipy.org typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pipy.org"
      search_raw: true

  - id: pyp1-org
    description: pyp1.org typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pyp1.org"
      search_raw: true

  - id: pypl-org
    description: pypl.org typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "pypl.org"
      search_raw: true

  - id: py-pi-domain
    description: py-pi. typosquat
    confidence: 0.9
    crit: notable
    condition:
      type: string
      exact: "py-pi."
      search_raw: true

  # Suspicious package download from non-official source
  - id: unofficial-package-source
    description: "Package download from unofficial source"
    confidence: 0.85
    condition:
      type: string
      # pip install from URL that's not pypi.org or pythonhosted.org
      regex: "pip\\s+install\\s+https?://(?!pypi\\.org|files\\.pythonhosted\\.org)[a-zA-Z0-9.-]+/"
      search_raw: true

  # Fake PyPI-like domains in URLs (YARA-based)
  - id: fake-pypi-url-domain
    description: "URL containing fake PyPI-like domain"
    confidence: 0.90
    crit: suspicious
    condition:
      type: yara
      source: |
        rule fake_pypi_package_download {
          meta:
            description = "Detects package downloads from fake PyPI domains"
          strings:
            $fake_host = /https?:\/\/[a-z]*pypi[a-z]*\.(org|com|net)/ ascii nocase
            $fake_python = /https?:\/\/[a-z]*python[a-z]*hosted\.(org|com|net)/ ascii nocase
            $package_ext = /\.(tar\.gz|whl|zip)/ ascii
          condition:
            ($fake_host or $fake_python) and $package_ext
        }

  # === Python package extension atomic indicators ===
  - id: ext-tar-gz
    description: .tar.gz package extension
    confidence: 0.6
    crit: inert
    condition:
      type: string
      exact: ".tar.gz"
      search_raw: true

  - id: ext-whl
    description: .whl package extension
    confidence: 0.6
    crit: inert
    condition:
      type: string
      exact: ".whl"
      search_raw: true

  - id: ext-zip
    description: .zip package extension
    confidence: 0.5
    crit: inert
    condition:
      type: string
      exact: ".zip"
      search_raw: true

composite_rules:
  # Python package extension composite
  - id: python-package-extension
    description: Python package file extension
    confidence: 0.70
    crit: notable
    requires_count: 1
    any:
      - id: ext-tar-gz
      - id: ext-whl
      - id: ext-zip

  # Fake PyPI host composite
  - id: fake-pypi-host-raw
    description: "Typosquatted PyPI file hosting domain"
    confidence: 0.95
    crit: suspicious
    requires_count: 1
    any:
      - id: pypihosted-org
      - id: pythonhosted-com
      - id: pypi-files-domain
      - id: pypyhosted-domain
      - id: pythonhost-domain

  # Fake PyPI index composite
  - id: fake-pypi-index
    description: "Typosquatted PyPI index domain"
    confidence: 0.95
    crit: suspicious
    requires_count: 1
    any:
      - id: pypii-org
      - id: pipy-org
      - id: pyp1-org
      - id: pypl-org
      - id: py-pi-domain

  # URL pointing to tar.gz/whl on suspicious domain
  - id: fake-package-download
    description: "Package download URL from typosquatted domain"
    crit: suspicious
    confidence: 0.95
    mbc: "B0030"
    requires_any:
      - id: fake-pypi-host
      - id: fake-pypi-host-raw
      - id: fake-pypi-index
      - id: fake-pypi-url-domain
