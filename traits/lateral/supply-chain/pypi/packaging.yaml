# PyPI Package Distribution Patterns
# Detects Python packaging mechanisms (setuptools, distutils)
# These help identify setup.py context for supply-chain analysis

defaults:
  file_types: [python]
  crit: notable

traits:
  # === setuptools atomic indicators ===
  - id: from-setuptools-import
    description: from setuptools import statement
    crit: inert
    confidence: 0.7
    condition:
      type: string
      regex: "from\\s+setuptools\\s+import"

  - id: import-setuptools
    description: import setuptools statement
    crit: inert
    confidence: 0.7
    condition:
      type: string
      regex: "import\\s+setuptools"

  # distutils usage (older)
  - id: distutils
    description: "Python package distribution (distutils)"
    confidence: 0.8
    condition:
      type: string
      regex: "from\\s+distutils"

  # setup() function call
  - id: setup-call
    description: "Python package setup() definition"
    confidence: 0.85
    condition:
      type: ast_pattern
      node_type: call
      pattern: "setup("

  # === Package metadata atomic indicators ===
  - id: metadata-author
    description: author= metadata field
    crit: inert
    confidence: 0.5
    condition:
      type: string
      regex: "author\\s*="

  - id: metadata-version
    description: version= metadata field
    crit: inert
    confidence: 0.5
    condition:
      type: string
      regex: "version\\s*="

  - id: metadata-description
    description: description= metadata field
    crit: inert
    confidence: 0.5
    condition:
      type: string
      regex: "description\\s*="

  - id: metadata-packages
    description: packages= metadata field
    crit: inert
    confidence: 0.5
    condition:
      type: string
      regex: "packages\\s*="

  # Directory masquerading (evasion technique)
  - id: directory-masquerade
    description: Directory masquerading as file (e.g. file.py/file.py)
    crit: suspicious
    confidence: 0.8
    file_types: [all]
    condition:
      type: string
      regex: "os\\.path\\.join\\(.{0,100}\\.py.{0,30}\\)"

  # === cmdclass override atomic indicators ===
  - id: cmdclass-dict
    description: cmdclass dict assignment
    crit: notable
    confidence: 0.75
    condition:
      type: string
      regex: "cmdclass\\s*=\\s*\\{"

  - id: install-class-inherit
    description: class inheriting from install
    crit: notable
    confidence: 0.75
    condition:
      type: string
      regex: "class\\s+\\w+\\(install\\)"

composite_rules:
  # setuptools composite
  - id: setuptools
    description: Python package distribution (setuptools)
    crit: notable
    confidence: 0.8
    requires_count: 1
    any:
      - id: from-setuptools-import
      - id: import-setuptools

  # metadata composite
  - id: metadata
    description: Python package metadata definition
    crit: notable
    confidence: 0.7
    requires_count: 1
    any:
      - id: metadata-author
      - id: metadata-version
      - id: metadata-description
      - id: metadata-packages

  # cmdclass override composite
  - id: cmdclass-override
    description: Custom install command class override
    crit: suspicious
    confidence: 0.85
    requires_count: 1
    any:
      - id: cmdclass-dict
      - id: install-class-inherit
