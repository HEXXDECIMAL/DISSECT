# NPM Malicious Package Patterns (Supply-Chain Specific)
# ATT&CK: T1195.002 (Supply Chain Compromise)
# These patterns are specific to npm supply-chain attacks, not generic behaviors

traits:
  # === Lifecycle hook atomic indicators ===
  - id: preinstall-hook
    description: preinstall lifecycle hook
    crit: inert
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: content


composite_rules:
  # Lifecycle hook helpers
  - id: lifecycle-hook
    description: NPM lifecycle hook (preinstall or postinstall)
    crit: inert
    confidence: 0.6
    file_types: [packagejson]
    count_min: 1
    any:
      - id: preinstall-hook
      - id: postinstall-hook

  # Download command helpers
  - id: download-command
    description: Download command (curl or wget)
    crit: notable
    confidence: 0.7
    file_types: [packagejson]
    count_min: 1
    any:
      - id: curl-command
      - id: wget-command

  # Pipe to shell helpers
  - id: pipe-to-shell
    description: Pipe to shell interpreter
    crit: notable
    confidence: 0.75
    file_types: [packagejson]
    count_min: 1
    any:
      - id: pipe-to-bash
      - id: pipe-to-sh
      - id: pipe-to-node

  # Node eval helpers
  - id: node-eval
    description: Node inline eval (node -e or --eval)
    crit: notable
    confidence: 0.8
    file_types: [packagejson]
    count_min: 1
    any:
      - id: node-dash-e
      - id: node-eval-flag

  # NPM preinstall/postinstall abuse with dropper behavior
  - id: lifecycle-dropper
    description: NPM lifecycle script with dropper pattern
    crit: suspicious
    confidence: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    file_types: [packagejson]
    all:
      - id: lifecycle-hook
      - id: download-command
      - id: pipe-to-shell

  # NPM package with inline node eval in hooks
  - id: hook-node-eval
    description: NPM install hook with node -e inline execution
    crit: suspicious
    confidence: 0.95
    attack: "T1059.007"
    mbc: "B0024"
    file_types: [packagejson]
    all:
      - id: lifecycle-hook
      - id: node-eval

  # Install hook spawns child process
  - id: hook-child-process
    description: NPM install hook using child_process module
    crit: suspicious
    confidence: 0.85
    attack: "T1195.002"
    file_types: [packagejson]
    all:
      - id: lifecycle-hook
      - id: child-process-module
