# npm package.json Script Patterns
# Detects suspicious patterns in npm package scripts
# MBC: B0024 (Execution), C0002 (Download)
# ATT&CK: T1059 (Command Interpreter), T1105 (Ingress Tool Transfer)

traits:
  # Install Hooks
  - id: preinstall-hook
    description: Package has 'preinstall' hook that runs before install
    criticality: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"preinstall"\s*:'
      search_raw: true

  - id: postinstall-hook
    description: Package has 'postinstall' hook that runs after install
    criticality: notable
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"postinstall"\s*:'
      search_raw: true

  - id: prepare-hook
    description: Package has 'prepare' hook that runs during install
    criticality: notable
    confidence: 0.75
    file_types: [packagejson]
    condition:
      type: string
      regex: '"prepare"\s*:'
      search_raw: true

  # Download and Execute Patterns
  - id: curl-in-script
    description: npm script uses curl for downloading
    criticality: suspicious
    confidence: 0.85
    mbc: "C0002"
    attack: "T1105"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"[^"]*curl\s'
      search_raw: true

  - id: wget-in-script
    description: npm script uses wget for downloading
    criticality: suspicious
    confidence: 0.85
    mbc: "C0002"
    attack: "T1105"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"[^"]*wget\s'
      search_raw: true

  - id: pipe-to-shell
    description: npm script pipes content to shell interpreter
    criticality: suspicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: string
      regex: '\|\s*(sh|bash|zsh|perl|python|ruby|node)'
      search_raw: true

  - id: download-execute
    description: npm script downloads and executes code (dropper pattern)
    criticality: suspicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1105"
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule npm_download_execute {
          strings:
            $dl1 = "curl" nocase
            $dl2 = "wget" nocase
            $chain = "&&"
            $exec1 = "| sh"
            $exec2 = "| bash"
            $exec3 = "| perl"
            $exec4 = "| python"
            $exec5 = "| node"
          condition:
            any of ($dl*) and ($chain or any of ($exec*))
        }

  # Obfuscation in Scripts
  - id: base64-in-script
    description: npm script uses base64 encoding
    criticality: suspicious
    confidence: 0.8
    mbc: "C0026"
    attack: "T1027"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'base64|atob|btoa'
      search_raw: true

  - id: eval-in-script
    description: npm script uses eval for code execution
    criticality: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"[^"]*eval\s'
      search_raw: true

  # Environment Variable Access
  - id: env-access
    description: npm script accesses environment variables
    criticality: notable
    confidence: 0.7
    attack: "T1082"
    file_types: [packagejson]
    condition:
      type: string
      regex: '\$HOME|\$USER|\$AWS_|\$GITHUB_TOKEN|process\.env'
      search_raw: true

  # Data Exfiltration
  - id: curl-post
    description: npm script sends data via HTTP POST
    criticality: suspicious
    confidence: 0.9
    mbc: "E1591"
    attack: "T1041"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'curl\s+(-d|--data|-X\s*POST)'
      search_raw: true

  - id: file-upload
    description: npm script uploads local file via curl
    criticality: suspicious
    confidence: 0.95
    mbc: "E1591"
    attack: "T1041"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'curl.*@/'
      search_raw: true

  # Interpreter Execution
  - id: perl-exec
    description: npm script executes perl interpreter
    criticality: notable
    confidence: 0.85
    attack: "T1059.006"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'perl\s+-e|perl\s+[^|]'
      search_raw: true

  - id: python-exec
    description: npm script executes python interpreter
    criticality: notable
    confidence: 0.8
    attack: "T1059.006"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'python3?\s+-c|python3?\s+[^|]'
      search_raw: true
