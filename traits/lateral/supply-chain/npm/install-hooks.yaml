# npm package.json Script Patterns
# Detects suspicious patterns in npm package scripts
# MBC: B0024 (Execution), C0002 (Download)
# ATT&CK: T1059 (Command Interpreter), T1105 (Ingress Tool Transfer)

traits:
  # Install Hooks
  - id: preinstall-hook
    description: Package has 'preinstall' hook that runs before install
    crit: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"preinstall"\s*:'
      search_raw: true

  - id: postinstall-hook
    description: Package has 'postinstall' hook that runs after install
    crit: notable
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"postinstall"\s*:'
      search_raw: true

  - id: prepare-hook
    description: Package has 'prepare' hook that runs during install
    crit: notable
    confidence: 0.75
    file_types: [packagejson]
    condition:
      type: string
      regex: '"prepare"\s*:'
      search_raw: true

  # Download and Execute Patterns
  - id: curl-in-script
    description: npm script uses curl for downloading
    crit: suspicious
    confidence: 0.85
    mbc: "C0002"
    attack: "T1105"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"[^"]*curl\s'
      search_raw: true

  - id: wget-in-script
    description: npm script uses wget for downloading
    crit: suspicious
    confidence: 0.85
    mbc: "C0002"
    attack: "T1105"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"[^"]*wget\s'
      search_raw: true

  - id: pipe-to-shell
    description: npm script pipes content to shell interpreter
    crit: suspicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: string
      regex: '\|\s*(sh|bash|zsh|perl|python|ruby|node)'
      search_raw: true

  # Atomic traits for download-execute
  - id: curl-keyword
    description: Script contains curl command
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: 'curl'
      search_raw: true
      case_insensitive: true

  - id: wget-keyword
    description: Script contains wget command
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: 'wget'
      search_raw: true
      case_insensitive: true

  - id: shell-chain
    description: Script contains shell chaining operator
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      exact: '&&'
      search_raw: true

  - id: pipe-to-sh
    description: Script pipes to sh
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: '| sh'
      search_raw: true

  - id: pipe-to-bash
    description: Script pipes to bash
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: '| bash'
      search_raw: true

  - id: pipe-to-perl
    description: Script pipes to perl
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: '| perl'
      search_raw: true

  - id: pipe-to-python
    description: Script pipes to python
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: '| python'
      search_raw: true

  - id: pipe-to-node
    description: Script pipes to node
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      exact: '| node'
      search_raw: true

  # Obfuscation in Scripts
  - id: base64-in-script
    description: npm script uses base64 encoding
    crit: suspicious
    confidence: 0.8
    mbc: "C0026"
    attack: "T1027"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'base64|atob|btoa'
      search_raw: true

  - id: eval-in-script
    description: npm script uses eval for code execution
    crit: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: string
      regex: '"[^"]*eval\s'
      search_raw: true

  # Environment Variable Access
  - id: env-access
    description: npm script accesses environment variables
    crit: notable
    confidence: 0.7
    attack: "T1082"
    file_types: [packagejson]
    condition:
      type: string
      regex: '\$HOME|\$USER|\$AWS_|\$GITHUB_TOKEN|process\.env'
      search_raw: true

  # Data Exfiltration
  - id: curl-post
    description: npm script sends data via HTTP POST
    crit: suspicious
    confidence: 0.9
    mbc: "E1591"
    attack: "T1041"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'curl\s+(-d|--data|-X\s*POST)'
      search_raw: true

  - id: file-upload
    description: npm script uploads local file via curl
    crit: suspicious
    confidence: 0.95
    mbc: "E1591"
    attack: "T1041"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'curl.{0,100}@/'
      search_raw: true

  # Interpreter Execution
  - id: perl-exec
    description: npm script executes perl interpreter
    crit: notable
    confidence: 0.85
    attack: "T1059.006"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'perl\s+-e|perl\s+[^|]'
      search_raw: true

  - id: python-exec
    description: npm script executes python interpreter
    crit: notable
    confidence: 0.8
    attack: "T1059.006"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'python3?\s+-c|python3?\s+[^|]'
      search_raw: true

# === Composite Rules ===
composite_rules:
  # Download tools
  - id: download-tools
    description: Script uses download tools
    crit: inert
    conf: 0.6
    file_types: [packagejson]
    any:
      - id: curl-keyword
      - id: wget-keyword

  # Pipe to interpreter patterns
  - id: pipe-to-interpreters
    description: Script pipes to shell or interpreter
    crit: inert
    conf: 0.6
    file_types: [packagejson]
    any:
      - id: pipe-to-sh
      - id: pipe-to-bash
      - id: pipe-to-perl
      - id: pipe-to-python
      - id: pipe-to-node

  # Download and execute composite
  - id: download-execute
    description: npm script downloads and executes code (dropper pattern)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1105"
    file_types: [packagejson]
    all:
      - id: download-tools
    any:
      - id: shell-chain
      - id: pipe-to-interpreters
