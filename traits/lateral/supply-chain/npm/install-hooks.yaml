# npm package.json Script Patterns
# Detects suspicious patterns in npm package scripts
# MBC: B0024 (Execution), C0002 (Download)
# ATT&CK: T1059 (Command Interpreter), T1105 (Ingress Tool Transfer)

traits:
  # Install Hooks
  - id: preinstall-hook
    description: Package has 'preinstall' hook that runs before install
    crit: suspicious
    confidence: 0.85
    mbc: "B0024"
    attack: "T1059"
    file_types: [packagejson]
    condition:
      type: content


# === Composite Rules ===
composite_rules:
  # Download tools
  - id: download-tools
    description: Script uses download tools
    crit: inert
    conf: 0.6
    file_types: [packagejson]
    any:
      - id: curl-keyword
      - id: wget-keyword

  # Pipe to interpreter patterns
  - id: pipe-to-interpreters
    description: Script pipes to shell or interpreter
    crit: inert
    conf: 0.6
    file_types: [packagejson]
    any:
      - id: pipe-to-sh
      - id: pipe-to-bash
      - id: pipe-to-perl
      - id: pipe-to-python
      - id: pipe-to-node

  # Download and execute composite
  - id: download-execute
    description: npm script downloads and executes code (dropper pattern)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1105"
    file_types: [packagejson]
    all:
      - id: download-tools
    any:
      - id: shell-chain
      - id: pipe-to-interpreters
