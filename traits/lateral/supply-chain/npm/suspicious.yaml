# NPM Package Structure Anomalies
# Patterns specific to npm supply-chain attacks - package structure and metadata
# Generic JS behaviors should be in their objective directories

defaults:
  file_types: [packagejson]

traits:
  # No exports (side-effect only module)
  - id: no-exports
    description: Module has no exports (side-effect only)
    criticality: notable
    confidence: 0.7
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule no_exports {
          strings:
            $export1 = "module.exports" ascii
            $export2 = "exports." ascii
            $export3 = /^export\s/ ascii
          condition:
            not any of ($export*)
        }

  # Single small file with dangerous APIs (npm-specific context)
  - id: single-file-dangerous
    description: Tiny npm package using dangerous Node APIs
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule single_file_dangerous {
          strings:
            $os = "require('os')" ascii
            $cp = "require('child_process')" ascii
            $https = "require('https')" ascii
            $fs = "require('fs')" ascii
          condition:
            filesize < 5KB and 3 of them
        }

  # No dependencies but has install hooks
  - id: no-deps-with-hooks
    description: Package has install hooks but no dependencies
    criticality: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule no_deps_with_hooks {
          strings:
            $deps = "\"dependencies\":" ascii
            $hook1 = "\"preinstall\":" ascii
            $hook2 = "\"postinstall\":" ascii
          condition:
            any of ($hook*) and not $deps
        }

  # Multiple install hooks (unusual)
  - id: multiple-hooks
    description: Package has multiple install lifecycle hooks
    criticality: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule multiple_hooks {
          strings:
            $hook1 = "\"preinstall\":" ascii
            $hook2 = "\"postinstall\":" ascii
            $hook3 = "\"install\":" ascii
          condition:
            2 of them
        }

  # Very new version with install hooks
  - id: new-version-hooks
    description: Brand new version (0.0.1) with install hooks
    criticality: suspicious
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule new_version_with_hooks {
          strings:
            $ver = "\"version\": \"0.0.1\"" ascii
            $hook1 = "\"preinstall\":" ascii
            $hook2 = "\"postinstall\":" ascii
          condition:
            $ver and any of ($hook*)
        }

  # Missing metadata with install hooks
  - id: missing-metadata-hooks
    description: Package missing standard metadata but has install hooks
    criticality: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule missing_metadata_hooks {
          strings:
            $repo = "\"repository\":" ascii
            $hook1 = "\"preinstall\":" ascii
            $hook2 = "\"postinstall\":" ascii
          condition:
            any of ($hook*) and not $repo
        }

  # Package writes to node_modules (persistence)
  - id: node-modules-write
    description: Package writes to node_modules directory
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:writeFile|writeFileSync|appendFile)\\s*\\([^)]*node_modules"

  # Reads .npmrc (token theft)
  - id: npmrc-read
    description: Reads .npmrc file (potential token theft)
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:readFile|readFileSync)\\s*\\([^)]*\\.npmrc"

  # Package writes to package.json (persistence)
  - id: package-json-write
    description: Writes to package.json file
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "writeFileSync\\s*\\([^)]*package\\.json|writeFile\\s*\\([^)]*package\\.json"

  # Scoped package mimicking popular library
  - id: scoped-typosquat
    description: Scoped package mimicking well-known package
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: '"name":\\s*"@[^/]+/(react|vue|angular|express|lodash|axios|webpack|babel|typescript|eslint|prettier|jest|mocha)'

  # Orphan child process (detached from install)
  - id: child-unref
    description: Orphan child process (unref pattern)
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "child\\.unref\\(\\)|spawn\\([^)]+\\)\\.unref\\(\\)"

  # Silent process execution
  - id: stdio-ignore
    description: Silent process execution (stdio ignored)
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "stdio:\\s*['\"]ignore['\"]|stdio:\\s*\\[.*ignore"

  # Bug bounty / security research markers
  - id: bug-bounty-marker
    description: Bug bounty or security research marker
    criticality: notable
    confidence: 0.9
    file_types: [javascript, packagejson]
    condition:
      type: string
      regex: "bug\\s*bounty|hackerone|bugcrowd|security\\s*research|proof\\s*of\\s*concept|PoC|benign\\s*test"

  # Multiple OOB exfil domains
  - id: multi-oob
    description: Multiple OOB exfiltration endpoints
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript, packagejson]
    condition:
      type: yara
      source: |
        rule multi_oob {
          strings:
            $oast1 = "oast.fun" ascii nocase
            $oast2 = "oastify.com" ascii nocase
            $oast3 = "oast.me" ascii nocase
            $webhook = "webhook.site" ascii nocase
            $pipedream = "pipedream.net" ascii nocase
            $discord = "discord.com/api/webhooks" ascii nocase
          condition:
            2 of them
        }
