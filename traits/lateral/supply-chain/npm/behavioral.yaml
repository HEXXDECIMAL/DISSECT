# NPM Behavioral Context Traits
# These capture when and how code executes in npm package context
# Helps distinguish install-time vs runtime behavior

defaults:
  file_types: [javascript]

traits:
  # === INSTALL-TIME BEHAVIOR (Suspicious Context) ===

  # Executes immediately on require (no export call needed)
  - id: auto-execute
    description: Code auto-executes on require/import
    criticality: notable
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule auto_execute {
          strings:
            $iife = /^\s*\((?:async\s+)?(?:function|\(\s*\)|[a-z_$][a-z0-9_$]*\s*=>)/ ascii
            $call = /^[a-z_$][a-z0-9_$]*\s*\(\s*\)\s*;?\s*$/ ascii
            $export = "module.exports" ascii
          condition:
            any of ($iife, $call) and not $export
        }

  # Side-effect only module (no exports)
  - id: side-effect-only
    description: Module produces side effects without exports
    criticality: notable
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule side_effect_only {
          strings:
            $export1 = "module.exports" ascii
            $export2 = "exports." ascii
            $export3 = /^export\s/ ascii
            $http = "http" ascii
            $fs = "writeFile" ascii
            $exec = "exec(" ascii
            $spawn = "spawn(" ascii
          condition:
            (any of ($http, $fs, $exec, $spawn)) and not any of ($export*)
        }

  # Network activity at module load time
  - id: network-on-load
    description: Network request during module initialization
    criticality: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule network_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $fetch = "fetch(" ascii
            $http = "https.request" ascii
            $axios = "axios" ascii
            $got = "got(" ascii
          condition:
            $iife and any of ($fetch, $http, $axios, $got)
        }

  # File write at module load time
  - id: write-on-load
    description: File write during module initialization
    criticality: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule write_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $write1 = "writeFileSync" ascii
            $write2 = "writeFile(" ascii
            $append = "appendFile" ascii
          condition:
            $iife and any of ($write*, $append)
        }

  # Process spawn at module load time
  - id: spawn-on-load
    description: Process spawned during module initialization
    criticality: suspicious
    confidence: 0.9
    condition:
      type: yara
      source: |
        rule spawn_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $exec = "exec(" ascii
            $spawn = "spawn(" ascii
            $fork = "fork(" ascii
          condition:
            $iife and any of ($exec, $spawn, $fork)
        }

  # === STRUCTURAL INDICATORS ===

  # Very small file (< 500 bytes)
  - id: tiny-file
    description: Very small code file
    criticality: notable
    confidence: 0.6
    condition:
      type: yara
      source: |
        rule tiny_file {
          condition:
            filesize < 500
        }

  # Medium file with no functions
  - id: script-blob
    description: Medium-sized file with no function definitions
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule script_blob {
          strings:
            $func = /function\s+\w+\s*\(/ ascii
            $arrow = /const\s+\w+\s*=\s*(?:async\s+)?\([^)]*\)\s*=>/ ascii
            $class = /class\s+\w+/ ascii
          condition:
            filesize > 500 and filesize < 5000 and not any of ($func, $arrow, $class)
        }

composite_rules:
  # npm package with interpreter dropper (hostile combination)
  - id: interpreter-dropper-package
    description: npm package that downloads and executes via external interpreter
    criticality: hostile
    confidence: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    file_types: [javascript, typescript]
    requires_any:
      - type: string
        regex: "python3?\\s+-c|python3?\\s+-"
      - type: string
        regex: "node\\s+-e|node\\s+--eval"
    requires_all:
      - type: string
        regex: "spawn\\(|exec\\("
      - type: string
        regex: "child_process"
