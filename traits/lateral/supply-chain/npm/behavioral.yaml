# NPM Behavioral Context Traits
# These capture when and how code executes in npm package context
# Helps distinguish install-time vs runtime behavior

defaults:
  file_types: [javascript]

traits:
  # === INSTALL-TIME BEHAVIOR (Suspicious Context) ===

  # NOTE: YARA kept for auto-execute - requires multiline/structural patterns with NOT conditions
  - id: auto-execute
    description: Code auto-executes on require/import
    crit: notable
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule auto_execute {
          strings:
            $iife = /^\s*\((?:async\s+)?(?:function|\(\s*\)|[a-z_$][a-z0-9_$]*\s*=>)/ ascii
            $call = /^[a-z_$][a-z0-9_$]*\s*\(\s*\)\s*;?\s*$/ ascii
            $export = "module.exports" ascii
          condition:
            any of ($iife, $call) and not $export
        }

  # NOTE: YARA kept for side-effect-only - requires NOT conditions across multiple patterns
  - id: side-effect-only
    description: Module produces side effects without exports
    crit: notable
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule side_effect_only {
          strings:
            $export1 = "module.exports" ascii
            $export2 = "exports." ascii
            $export3 = /^export\s/ ascii
            $http = "http" ascii
            $fs = "writeFile" ascii
            $exec = "exec(" ascii
            $spawn = "spawn(" ascii
          condition:
            (any of ($http, $fs, $exec, $spawn)) and not any of ($export*)
        }

  # NOTE: YARA kept for network-on-load - requires combining IIFE pattern with network calls
  - id: network-on-load
    description: Network request during module initialization
    crit: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule network_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $fetch = "fetch(" ascii
            $http = "https.request" ascii
            $axios = "axios" ascii
            $got = "got(" ascii
          condition:
            $iife and any of ($fetch, $http, $axios, $got)
        }

  # NOTE: YARA kept for write-on-load - requires combining IIFE pattern with file writes
  - id: write-on-load
    description: File write during module initialization
    crit: suspicious
    confidence: 0.85
    condition:
      type: yara
      source: |
        rule write_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $write1 = "writeFileSync" ascii
            $write2 = "writeFile(" ascii
            $append = "appendFile" ascii
          condition:
            $iife and any of ($write*, $append)
        }

  # NOTE: YARA kept for spawn-on-load - requires combining IIFE pattern with process spawning
  - id: spawn-on-load
    description: Process spawned during module initialization
    crit: suspicious
    confidence: 0.9
    condition:
      type: yara
      source: |
        rule spawn_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $exec = "exec(" ascii
            $spawn = "spawn(" ascii
            $fork = "fork(" ascii
          condition:
            $iife and any of ($exec, $spawn, $fork)
        }

  # === STRUCTURAL INDICATORS ===

  # Very small file (< 500 bytes)
  # NOTE: YARA kept for filesize check - DISSECT doesn't support filesize conditions
  - id: tiny-file
    description: Very small code file
    crit: notable
    confidence: 0.6
    condition:
      type: yara
      source: |
        rule tiny_file {
          condition:
            filesize < 500
        }

  # Medium file with no functions
  # NOTE: YARA kept for filesize check - DISSECT doesn't support filesize conditions
  - id: script-blob
    description: Medium-sized file with no function definitions
    crit: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule script_blob {
          strings:
            $func = /function\s+\w+\s*\(/ ascii
            $arrow = /const\s+\w+\s*=\s*(?:async\s+)?\([^)]*\)\s*=>/ ascii
            $class = /class\s+\w+/ ascii
          condition:
            filesize > 500 and filesize < 5000 and not any of ($func, $arrow, $class)
        }

  # === INTERPRETER EXECUTION PATTERNS ===

  # === Python interpreter atomic indicators ===
  - id: python-c-flag
    description: python -c flag
    crit: inert
    confidence: 0.6
    condition:
      type: string
      regex: "python3?\\s+-c"

  - id: python-stdin-flag
    description: python stdin flag
    crit: inert
    confidence: 0.6
    condition:
      type: string
      regex: "python3?\\s+-"

  # === Node interpreter atomic indicators ===
  - id: node-e-flag
    description: node -e flag
    crit: inert
    confidence: 0.6
    condition:
      type: string
      regex: "node\\s+-e"

  - id: node-eval-flag
    description: node --eval flag
    crit: inert
    confidence: 0.6
    condition:
      type: string
      regex: "node\\s+--eval"

  # === CHILD PROCESS PATTERNS ===

  # spawn call
  - id: spawn-call
    description: Process spawn call
    crit: inert
    confidence: 0.6
    condition:
      type: string
      regex: "spawn\\("

  # exec call
  - id: exec-call
    description: Process exec call
    crit: inert
    confidence: 0.6
    condition:
      type: string
      regex: "exec\\("

  # child_process module reference
  - id: child-process-import
    description: Node child_process module usage
    crit: notable
    confidence: 0.9
    condition:
      type: string
      exact: "child_process"

composite_rules:
  # Python interpreter exec composite
  - id: python-interpreter-exec
    description: Python interpreter with inline code execution
    crit: suspicious
    confidence: 0.8
    requires_count: 1
    any:
      - id: python-c-flag
      - id: python-stdin-flag

  # Node interpreter exec composite
  - id: node-interpreter-exec
    description: Node interpreter with inline code execution
    crit: suspicious
    confidence: 0.8
    requires_count: 1
    any:
      - id: node-e-flag
      - id: node-eval-flag

  # Spawn or exec composite
  - id: spawn-or-exec-call
    description: Process spawn or exec function invocation
    crit: notable
    confidence: 0.8
    requires_count: 1
    any:
      - id: spawn-call
      - id: exec-call

  # npm package with interpreter dropper (hostile combination)
  - id: interpreter-dropper-package
    description: npm package that downloads and executes via external interpreter
    crit: hostile
    confidence: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    file_types: [javascript, typescript]
    requires_any:
      - id: python-interpreter-exec
      - id: node-interpreter-exec
    requires_all:
      - id: spawn-or-exec-call
      - id: child-process-import
