# NPM Malicious Package Patterns
# ATT&CK: T1195.002 (Supply Chain Compromise)

traits:
  # NPM preinstall/postinstall abuse
  - id: malicious/lifecycle-abuse
    description: NPM lifecycle script abuse
    criticality: suspicious
    confidence: 0.85
    attack: "T1195.002"
    condition:
      type: yara
      source: |
        rule npm_lifecycle_abuse {
          strings:
            // Lifecycle hooks
            $hook1 = "preinstall" ascii
            $hook2 = "postinstall" ascii
            $hook3 = "preuninstall" ascii
            // Suspicious commands
            $cmd1 = "curl " ascii
            $cmd2 = "wget " ascii
            $cmd3 = "| bash" ascii
            $cmd4 = "| sh" ascii
            // Child process
            $cp1 = "child_process" ascii
            $cp2 = "exec(" ascii
            $cp3 = "spawn(" ascii
          condition:
            (any of ($hook*) and any of ($cmd*)) or
            (any of ($hook*) and any of ($cp*))
        }

  # NPM environment stealing
  - id: malicious/env-steal
    description: NPM package stealing environment variables
    criticality: suspicious
    confidence: 0.8
    attack: "T1552"
    condition:
      type: yara
      source: |
        rule npm_env_steal {
          strings:
            // Environment access
            $env1 = "process.env" ascii
            // Sensitive vars
            $sens1 = "NPM_TOKEN" ascii
            $sens2 = "AWS_" ascii
            $sens3 = "GITHUB_TOKEN" ascii
            $sens4 = "API_KEY" ascii
            // Exfiltration
            $exfil1 = "http.request" ascii
            $exfil2 = "https.request" ascii
            $exfil3 = "fetch(" ascii
            $exfil4 = "axios" ascii
          condition:
            ($env1 and any of ($sens*) and any of ($exfil*))
        }

  # NPM typosquatting indicators
  - id: malicious/typosquat
    description: NPM typosquatting patterns
    criticality: suspicious
    confidence: 0.75
    attack: "T1195.002"
    condition:
      type: yara
      source: |
        rule npm_typosquat {
          strings:
            // Common typosquat patterns in package.json
            $pkg1 = "lodash" ascii
            $pkg2 = "express" ascii
            $pkg3 = "request" ascii
            $pkg4 = "axios" ascii
            // Combined with suspicious behavior
            $sus1 = "child_process" ascii
            $sus2 = "exec(" ascii
            $sus3 = "eval(" ascii
          condition:
            (any of ($pkg*) and any of ($sus*))
        }

  # NPM code obfuscation
  - id: malicious/obfuscation
    description: Obfuscated NPM package code
    criticality: suspicious
    confidence: 0.8
    attack: "T1027"
    condition:
      type: yara
      source: |
        rule npm_obfuscated {
          strings:
            // Obfuscation patterns
            $obf1 = "\\x" ascii
            $obf2 = "fromCharCode" ascii
            $obf3 = "atob(" ascii
            $obf4 = "Buffer.from" ascii
            // Eval-like execution
            $eval1 = "eval(" ascii
            $eval2 = "Function(" ascii
            $eval3 = "new Function" ascii
            // Long encoded strings
            $enc1 = "base64" ascii
            $enc2 = "decode" ascii
          condition:
            (any of ($obf*) and any of ($eval*)) or
            (any of ($enc*) and any of ($eval*))
        }
