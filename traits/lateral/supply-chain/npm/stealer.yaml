# NPM Supply Chain Stealer Patterns
# Detects malicious packages that import credential/data stealers
# ATT&CK: T1195.002 (Supply Chain Compromise: Software Supply Chain)

defaults:
  attack: "T1195.002"
  for: [javascript, typescript]

traits:
  # === STEALER MODULE IMPORTS ===
  # Importing from a local stealer/grabber module is a clear malicious indicator

  - id: local-stealer-import
    desc: Import from local stealer module
    crit: suspicious
    conf: 0.95
    mbc: "E1059"
    if:
      type: string
      regex: "from\\s+['\"]\\./(?:stealer|grabber|logger|exfil)['\"]|require\\(['\"]\\./(?:stealer|grabber|logger|exfil)['\"]\\)"
      case_insensitive: true

  - id: stealer-string
    desc: Stealer module string reference
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: "./stealer"

  - id: grabber-string
    desc: Grabber module string reference
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: "./grabber"

  # === CLOUD SANDBOX DETECTION ===
  # Checking for /app homedir indicates Heroku/container sandbox detection

  - id: homedir-app-check
    desc: Homedir /app sandbox check
    crit: suspicious
    conf: 0.9
    mbc: "B0007"
    attack: "T1497.001"
    if:
      type: string
      regex: "homedir\\(\\)\\s*===?\\s*['\"]/?app['\"]"

  - id: app-path-string
    desc: /app path string (cloud sandbox)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "/app"

  # === POSTINSTALL FLAG CHECK ===
  # Checking for --postinstall flag in argv is common in npm supply chain attacks

  - id: postinstall-argv-check
    desc: Check for --postinstall in argv
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    if:
      type: string
      regex: "process\\.argv\\.(?:includes|indexOf)\\(['\"]--postinstall['\"]\\)"

  - id: postinstall-flag-string
    desc: --postinstall flag string
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "--postinstall"

  # === GLOBAL STATE MANIPULATION ===
  # Setting global flags for malware state tracking

  - id: global-dunder-assignment
    desc: Global __variable assignment
    crit: notable
    conf: 0.75
    mbc: "B0024"
    if:
      type: string
      regex: "global\\.__[a-z_]+"
      case_insensitive: true

  - id: global-postinstall-flag
    desc: Global postinstall state flag
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    if:
      type: string
      regex: "global\\.__[a-z_]*postinstall"
      case_insensitive: true

composite_rules:
  # Stealer module import (any form)
  - id: stealer-import
    desc: Local stealer/grabber module import
    crit: suspicious
    conf: 0.9
    count_min: 1
    any:
      - id: local-stealer-import
      - id: stealer-string
      - id: grabber-string

  # Cloud sandbox detection
  - id: cloud-sandbox-check
    desc: Cloud environment sandbox detection
    crit: suspicious
    conf: 0.85
    mbc: "B0007"
    attack: "T1497.001"
    all:
      - id: discovery/system/os-homedir-call
      - id: app-path-string

  # Postinstall hook abuse
  - id: postinstall-abuse
    desc: NPM postinstall hook abuse
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    count_min: 1
    any:
      - id: postinstall-argv-check
      - id: postinstall-flag-string

  # Supply chain stealer package (HOSTILE)
  # Complexity: file_types(+1) + all(+3) = 4
  - id: supply-chain-stealer
    desc: NPM supply chain stealer package
    crit: hostile
    conf: 0.98
    mbc: "E1059"
    file_types: [javascript, typescript]
    all:
      - id: stealer-import
      - id: postinstall-abuse
      - id: discovery/system/os-homedir-call

  # Stealer with sandbox evasion (HOSTILE)
  # Complexity: file_types(+1) + all(+3) = 4
  - id: stealer-sandbox-evasion
    desc: Stealer with sandbox evasion
    crit: hostile
    conf: 0.98
    mbc: "B0007"
    attack: "T1497.001"
    file_types: [javascript, typescript]
    all:
      - id: stealer-import
      - id: cloud-sandbox-check
      - id: process/exit/process-exit
