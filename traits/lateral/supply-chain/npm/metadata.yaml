# npm Package Metadata Patterns
# Detects suspicious metadata patterns in package.json
# These patterns often indicate malicious or typosquatting packages

traits:
  # VSCode extension detection
  - id: vscode-extension
    description: Package is a VSCode extension
    crit: inert
    confidence: 0.95
    file_types: [packagejson]
    condition:
      type: string
      exact: "vscode"
      search_raw: true

  # Empty Author Field (detected by analyzer, this catches explicit empty)
  - id: empty-author
    description: Package has explicitly empty author field
    crit: notable
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: '"author"\s*:\s*""'
      search_raw: true

  # Suspicious Version Patterns
  - id: version-1.0.0
    description: Package version is 1.0.0
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\s*:\s*"1\.0\.0"'
      search_raw: true

  - id: preinstall-hook-key
    description: Package has preinstall hook key
    crit: inert
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: '"preinstall"\s*:'
      search_raw: true

  - id: postinstall-hook-key
    description: Package has postinstall hook key
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      regex: '"postinstall"\s*:'
      search_raw: true

  - id: install-hook-key
    description: Package has install hook key
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      regex: '"install"\s*:'
      search_raw: true

  - id: version-0.0.1
    description: Very early version number (0.0.1)
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\s*:\s*"0\.0\.1"'
      search_raw: true

  # Suspicious Name Patterns
  - id: typosquat-lodash
    description: Potential lodash typosquat
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(l0dash|1odash|lodas|lodashe)'
      search_raw: true

  - id: typosquat-express
    description: Potential express typosquat
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(expres|expresss|expess|3xpress)'
      search_raw: true

  - id: typosquat-react
    description: Potential react typosquat
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(reacr|raect|reactt|r3act)'
      search_raw: true

  - id: suspicious-name-pattern
    description: Package name matches suspicious patterns (random chars, test names)
    crit: notable
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(test-pkg-|temp-pkg-|tmp-pkg-)'
      search_raw: true

  # Dependency Patterns
  - id: github-dependency
    description: Package has GitHub URL as dependency (not pinned version)
    crit: notable
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: 'github\.com/[^"]+\.git'
      search_raw: true

  - id: git-dependency
    description: Package has git:// protocol dependency
    crit: notable
    confidence: 0.65
    file_types: [packagejson]
    condition:
      type: string
      regex: 'git://'
      search_raw: true

  # Binary Patterns
  - id: has-bin
    description: Package installs binary executables
    crit: notable
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: string
      regex: '"bin"\s*:\s*\{'
      search_raw: true

  # Suspicious URLs in package
  - id: pastebin-url
    description: Package references pastebin (common for malware payloads)
    crit: suspicious
    confidence: 0.85
    attack: "T1102"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'pastebin\.com|hastebin\.com|ghostbin\.com'
      search_raw: true

  - id: discord-webhook
    description: Package references Discord webhook (common exfil channel)
    crit: suspicious
    confidence: 0.85
    attack: "T1567"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'discord\.com/api/webhooks|discordapp\.com/api/webhooks'
      search_raw: true

  - id: telegram-bot
    description: Package references Telegram bot API (common exfil channel)
    crit: suspicious
    confidence: 0.85
    attack: "T1567"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'api\.telegram\.org/bot'
      search_raw: true

  # Typosquats of blockchain/crypto packages
  - id: typosquat-ganache
    description: Potential ganache typosquat
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"(ganach-|ganacha|ganachee|ganacche|ganac[^h])'
      search_raw: true

  - id: typosquat-ethers
    description: Potential ethers.js typosquat
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"(ether[^s]|etherss|3thers|etheers)'
      search_raw: true

  - id: typosquat-web3
    description: Potential web3 typosquat
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"(web3[a-z]|w3b3|vveb3|wep3)'
      search_raw: true

  # Random-looking package names
  - id: random-name
    description: Package name looks randomly generated
    crit: notable
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"[a-z]{2,4}[0-9]{3,}[a-z]*"'
      search_raw: true

  # Extremely long version numbers (often used to evade detection)
  - id: long-version
    description: Suspiciously long version number
    crit: notable
    confidence: 0.75
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\\s*:\\s*"[0-9]{4,}\\.'
      search_raw: true

  # Future year versions (dependency confusion)
  - id: future-version
    description: Version number with future year (dependency confusion)
    crit: suspicious
    confidence: 0.9
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\\s*:\\s*"202[7-9]\\.|"version"\\s*:\\s*"203'
      search_raw: true

  # Self-dependency (package depends on itself)
  # NOTE: YARA kept for dynamic extraction and cross-field comparison - requires
  # "for" loop to extract package name from "name" field and verify it appears
  # in "dependencies" section. DISSECT doesn't support this kind of stateful analysis.
  - id: self-dependency
    description: Package depends on itself (circular dependency, often malicious)
    crit: suspicious
    confidence: 0.95
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule npm_self_dependency {
          meta:
            description = "Detects packages that depend on themselves"
          strings:
            // Match name field to extract package name, then check dependencies
            // This pattern catches when the same string appears in both name and dependencies
            $name_pattern = /"name"\s*:\s*"([^"]+)"/ ascii
            $deps_pattern = /"dependencies"\s*:\s*\{[^}]*"/ ascii
          condition:
            $name_pattern and $deps_pattern and
            // Check for the package name appearing in dependencies section
            for any s in (1..#name_pattern) : (
              @deps_pattern > @name_pattern[s]
            )
        }

  # npm URL as homepage/repository (lazy/suspicious)
  - id: npm-homepage-url
    description: Package uses npmjs.com as homepage
    crit: inert
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: string
      regex: '"homepage"\s*:\s*"https?://(www\.)?npmjs\.(com|org)/package/'
      search_raw: true

  - id: npm-repo-url
    description: Package uses npmjs.com URL in repository field
    crit: inert
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: string
      regex: '"url"\s*:\s*"https?://(www\.)?npmjs\.(com|org)/package/'
      search_raw: true

  # Missing repository with install hooks (suspicious combo)
  - id: repository-key
    description: Package has repository key
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      regex: '"repository"\s*:'
      search_raw: true

  - id: repo-url-git-host
    description: Package has git hosting URL in repository
    crit: inert
    confidence: 0.5
    file_types: [packagejson]
    condition:
      type: string
      regex: '"url"\s*:\s*"(git|https?)://(github|gitlab|bitbucket)'
      search_raw: true

  # Generic description with hooks (template malware)
  - id: desc-lightweight
    description: Package description contains "lightweight"
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      regex: 'A lightweight'
      search_raw: true
      case_insensitive: true

  - id: desc-modern-web-apps
    description: Package description mentions "modern web applications"
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      exact: 'modern web applications'
      search_raw: true
      case_insensitive: true

  - id: desc-universal
    description: Package description contains "universal"
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      exact: 'universal'
      search_raw: true
      case_insensitive: true

  - id: desc-powerful-library
    description: Package description mentions "powerful library"
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      exact: 'powerful library'
      search_raw: true
      case_insensitive: true

  - id: desc-simple-easy
    description: Package description contains "simple and easy"
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      exact: 'simple and easy'
      search_raw: true
      case_insensitive: true

# === Composite Rules ===
composite_rules:
  # Install hook group
  - id: install-hooks
    description: Package has install hook (preinstall, postinstall, or install)
    crit: inert
    conf: 0.6
    file_types: [packagejson]
    any:
      - id: preinstall-hook-key
      - id: postinstall-hook-key
      - id: install-hook-key

  # Version 1.0.0 with install hooks
  - id: version-1.0.0-with-hooks
    description: Version 1.0.0 with install hooks (common malware pattern)
    crit: suspicious
    conf: 0.75
    file_types: [packagejson]
    all:
      - id: version-1.0.0
      - id: install-hooks

  # npm URL as homepage/repository
  - id: npm-as-homepage
    description: Package uses npmjs.com as homepage (lazy metadata, often malicious)
    crit: notable
    conf: 0.8
    file_types: [packagejson]
    any:
      - id: npm-homepage-url
      - id: npm-repo-url

  # Repository presence check
  - id: has-repository
    description: Package has repository URL
    crit: inert
    conf: 0.5
    file_types: [packagejson]
    any:
      - id: repository-key
      - id: repo-url-git-host

  # Missing repository with install hooks
  - id: no-repo-with-hooks
    description: Package has install hooks but no repository URL
    crit: suspicious
    conf: 0.85
    file_types: [packagejson]
    all:
      - id: install-hooks
    none:
      - id: has-repository

  # Generic descriptions group
  - id: generic-descriptions
    description: Package has generic marketing descriptions
    crit: inert
    conf: 0.5
    file_types: [packagejson]
    count: 2
    any:
      - id: desc-lightweight
      - id: desc-modern-web-apps
      - id: desc-universal
      - id: desc-powerful-library
      - id: desc-simple-easy

  # Generic description with hooks
  - id: generic-desc-with-hooks
    description: Generic description combined with install hooks (template malware)
    crit: suspicious
    conf: 0.8
    file_types: [packagejson]
    all:
      - id: generic-descriptions
      - id: install-hooks
