# npm Package Metadata Patterns
# Detects suspicious metadata patterns in package.json
# These patterns often indicate malicious or typosquatting packages

traits:
  # VSCode extension detection
  - id: vscode-extension
    description: Package is a VSCode extension
    crit: inert
    confidence: 0.95
    file_types: [packagejson]
    condition:
      type: string
      exact: "vscode"
      search_raw: true

  # Empty Author Field (detected by analyzer, this catches explicit empty)
  - id: empty-author
    description: Package has explicitly empty author field
    crit: notable
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: '"author"\s*:\s*""'
      search_raw: true

  # Suspicious Version Patterns
  - id: version-1.0.0-with-hooks
    description: Version 1.0.0 with install hooks (common malware pattern)
    crit: suspicious
    confidence: 0.75
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule npm_v100_with_hooks {
          strings:
            $version = /"version"\s*:\s*"1\.0\.0"/
            $hook1 = /"preinstall"\s*:/
            $hook2 = /"postinstall"\s*:/
            $hook3 = /"install"\s*:/
          condition:
            $version and any of ($hook*)
        }

  - id: version-0.0.1
    description: Very early version number (0.0.1)
    crit: inert
    confidence: 0.3
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\s*:\s*"0\.0\.1"'
      search_raw: true

  # Suspicious Name Patterns
  - id: typosquat-lodash
    description: Potential lodash typosquat
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(l0dash|1odash|lodas|lodashe)'
      search_raw: true

  - id: typosquat-express
    description: Potential express typosquat
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(expres|expresss|expess|3xpress)'
      search_raw: true

  - id: typosquat-react
    description: Potential react typosquat
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(reacr|raect|reactt|r3act)'
      search_raw: true

  - id: suspicious-name-pattern
    description: Package name matches suspicious patterns (random chars, test names)
    crit: notable
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\s*:\s*"(test-pkg-|temp-pkg-|tmp-pkg-)'
      search_raw: true

  # Dependency Patterns
  - id: github-dependency
    description: Package has GitHub URL as dependency (not pinned version)
    crit: notable
    confidence: 0.6
    file_types: [packagejson]
    condition:
      type: string
      regex: 'github\.com/[^"]+\.git'
      search_raw: true

  - id: git-dependency
    description: Package has git:// protocol dependency
    crit: notable
    confidence: 0.65
    file_types: [packagejson]
    condition:
      type: string
      regex: 'git://'
      search_raw: true

  # Binary Patterns
  - id: has-bin
    description: Package installs binary executables
    crit: notable
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: string
      regex: '"bin"\s*:\s*\{'
      search_raw: true

  # Suspicious URLs in package
  - id: pastebin-url
    description: Package references pastebin (common for malware payloads)
    crit: suspicious
    confidence: 0.85
    attack: "T1102"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'pastebin\.com|hastebin\.com|ghostbin\.com'
      search_raw: true

  - id: discord-webhook
    description: Package references Discord webhook (common exfil channel)
    crit: suspicious
    confidence: 0.85
    attack: "T1567"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'discord\.com/api/webhooks|discordapp\.com/api/webhooks'
      search_raw: true

  - id: telegram-bot
    description: Package references Telegram bot API (common exfil channel)
    crit: suspicious
    confidence: 0.85
    attack: "T1567"
    file_types: [packagejson]
    condition:
      type: string
      regex: 'api\.telegram\.org/bot'
      search_raw: true

  # Typosquats of blockchain/crypto packages
  - id: typosquat-ganache
    description: Potential ganache typosquat
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"(ganach-|ganacha|ganachee|ganacche|ganac[^h])'
      search_raw: true

  - id: typosquat-ethers
    description: Potential ethers.js typosquat
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"(ether[^s]|etherss|3thers|etheers)'
      search_raw: true

  - id: typosquat-web3
    description: Potential web3 typosquat
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"(web3[a-z]|w3b3|vveb3|wep3)'
      search_raw: true

  # Random-looking package names
  - id: random-name
    description: Package name looks randomly generated
    crit: notable
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name"\\s*:\\s*"[a-z]{2,4}[0-9]{3,}[a-z]*"'
      search_raw: true

  # Extremely long version numbers (often used to evade detection)
  - id: long-version
    description: Suspiciously long version number
    crit: notable
    confidence: 0.75
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\\s*:\\s*"[0-9]{4,}\\.'
      search_raw: true

  # Future year versions (dependency confusion)
  - id: future-version
    description: Version number with future year (dependency confusion)
    crit: suspicious
    confidence: 0.9
    file_types: [packagejson]
    condition:
      type: string
      regex: '"version"\\s*:\\s*"202[7-9]\\.|"version"\\s*:\\s*"203'
      search_raw: true

  # Self-dependency (package depends on itself)
  - id: self-dependency
    description: Package depends on itself (circular dependency, often malicious)
    crit: suspicious
    confidence: 0.95
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule npm_self_dependency {
          meta:
            description = "Detects packages that depend on themselves"
          strings:
            // Match name field to extract package name, then check dependencies
            // This pattern catches when the same string appears in both name and dependencies
            $name_pattern = /"name"\s*:\s*"([^"]+)"/ ascii
            $deps_pattern = /"dependencies"\s*:\s*\{[^}]*"/ ascii
          condition:
            $name_pattern and $deps_pattern and
            // Check for the package name appearing in dependencies section
            for any s in (1..#name_pattern) : (
              @deps_pattern > @name_pattern[s]
            )
        }

  # npm URL as homepage/repository (lazy/suspicious)
  - id: npm-as-homepage
    description: Package uses npmjs.com as homepage (lazy metadata, often malicious)
    crit: notable
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule npm_url_as_homepage {
          strings:
            $homepage = /"homepage"\s*:\s*"https?:\/\/(www\.)?npmjs\.(com|org)\/package\// ascii
            $repo = /"url"\s*:\s*"https?:\/\/(www\.)?npmjs\.(com|org)\/package\// ascii
          condition:
            any of them
        }

  # Missing repository with install hooks (suspicious combo)
  - id: no-repo-with-hooks
    description: Package has install hooks but no repository URL
    crit: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule no_repo_install_hooks {
          strings:
            $repo1 = /"repository"\s*:/ ascii
            $repo2 = /"url"\s*:\s*"(git|https?):\/\/(github|gitlab|bitbucket)/ ascii
            $hook1 = /"preinstall"\s*:/ ascii
            $hook2 = /"postinstall"\s*:/ ascii
            $hook3 = /"install"\s*:/ ascii
          condition:
            any of ($hook*) and not any of ($repo*)
        }

  # Generic description with hooks (template malware)
  - id: generic-desc-with-hooks
    description: Generic description combined with install hooks (template malware)
    crit: suspicious
    confidence: 0.8
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule generic_desc_hooks {
          strings:
            // Generic descriptions often used in malware templates
            $desc1 = "A lightweight" ascii nocase
            $desc2 = "modern web applications" ascii nocase
            $desc3 = "universal" ascii nocase
            $desc4 = "powerful library" ascii nocase
            $desc5 = "simple and easy" ascii nocase
            // Install hooks
            $hook1 = /"preinstall"\s*:/ ascii
            $hook2 = /"postinstall"\s*:/ ascii
          condition:
            2 of ($desc*) and any of ($hook*)
        }
