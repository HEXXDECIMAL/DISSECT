# Legitimate Bundled/Minified Code Markers
# These patterns indicate code was bundled by legitimate tools
# Helps reduce false positives from minification being flagged as obfuscation

traits:
  # Webpack bundled
  - id: legitimate/webpack-bundled
    description: Code bundled with webpack (legitimate minification)
    criticality: inert
    confidence: 0.95
    file_types: [javascript]
    condition:
      type: string
      regex: '__webpack_require__|webpackChunk|__webpack_modules__'

  # Rollup bundled
  - id: legitimate/rollup-bundled
    description: Code bundled with rollup (legitimate minification)
    criticality: inert
    confidence: 0.95
    file_types: [javascript]
    condition:
      type: string
      regex: '_interopDefaultLegacy|_interopNamespace|rollupPluginBabel'

  # esbuild bundled
  - id: legitimate/esbuild-bundled
    description: Code bundled with esbuild (legitimate minification)
    criticality: inert
    confidence: 0.95
    file_types: [javascript]
    condition:
      type: string
      regex: '__toESM|__toCommonJS|__export|__copyProps'

  # Parcel bundled
  - id: legitimate/parcel-bundled
    description: Code bundled with Parcel (legitimate minification)
    criticality: inert
    confidence: 0.95
    file_types: [javascript]
    condition:
      type: string
      regex: 'parcelRequire|__parcel__'

  # Vite bundled
  - id: legitimate/vite-bundled
    description: Code bundled with Vite (legitimate minification)
    criticality: inert
    confidence: 0.95
    file_types: [javascript]
    condition:
      type: string
      regex: '__vite__|import\\.meta\\.hot'

  # TypeScript compiled marker
  - id: legitimate/typescript-compiled
    description: Code compiled from TypeScript
    criticality: inert
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: '__esModule|Object\\.defineProperty\\(exports|tslib'

  # Babel transpiled
  - id: legitimate/babel-transpiled
    description: Code transpiled with Babel
    criticality: inert
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: '_classCallCheck|_defineProperty|_objectSpread|@babel/runtime'

  # Source map reference
  - id: legitimate/has-sourcemap
    description: Code has source map reference (professional build)
    criticality: inert
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: '//# sourceMappingURL=|//@ sourceMappingURL='

  # UMD module pattern
  - id: legitimate/umd-pattern
    description: Universal Module Definition pattern
    criticality: inert
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: string
      regex: 'typeof exports.*===.*object.*&&.*typeof module.*!==.*undefined|\\(function\\s*\\(root,\\s*factory\\)'

  # CommonJS2 export pattern
  - id: legitimate/cjs2-export
    description: CommonJS2 module export pattern
    criticality: inert
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: string
      regex: 'module\\.exports\\.default|exports\\.default\\s*='

  # React production build
  - id: legitimate/react-production
    description: React production build markers
    criticality: inert
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: 'react\\.production\\.min|ReactDOM\\.production'

  # Vue production build
  - id: legitimate/vue-production
    description: Vue production build markers
    criticality: inert
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: 'vue\\.runtime\\.esm|vue\\.esm-bundler|__VUE_PROD'

  # Angular production build
  - id: legitimate/angular-production
    description: Angular production build markers
    criticality: inert
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: '@angular/core|ngDevMode|ɵɵdefineComponent'

  # Known legitimate minifier output
  - id: legitimate/terser-output
    description: Terser/UglifyJS minified output markers
    criticality: inert
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule terser_output {
          strings:
            $strict = "\"use strict\"" ascii
            $void0 = "void 0" ascii
            $export = "__esModule" ascii
            $define = "Object.defineProperty" ascii
          condition:
            $strict and ($void0 or $export or $define)
        }

