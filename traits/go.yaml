# Go Language Traits and Capabilities
# Detection rules for Go programs covering execution, networking, crypto, and malicious behaviors

# ============================================================================
# TRAITS: Atomic Observations
# ============================================================================

traits:
  # ==========================================
  # Command Execution APIs
  # ==========================================

  - id: exec/go/command
    description: Uses exec.Command for shell execution
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: exec.Command
    platforms: [all]

  - id: exec/go/syscall-exec
    description: Uses syscall.Exec for direct program execution
    capability: true
    criticality: medium
    confidence: 0.95
    type: symbol
    pattern: syscall.Exec
    platforms: [unix, linux, macos]

  - id: exec/go/syscall-forkexec
    description: Uses syscall.ForkExec
    capability: true
    criticality: medium
    confidence: 0.95
    type: symbol
    pattern: syscall.ForkExec
    platforms: [unix, linux, macos]

  # ==========================================
  # Network APIs
  # ==========================================

  - id: net/go/dial
    description: Creates network connections with net.Dial
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: net.Dial
    platforms: [all]

  - id: net/go/dial-tcp
    description: Creates TCP connections with net.DialTCP
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: net.DialTCP
    platforms: [all]

  - id: net/go/listen
    description: Listens for network connections
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: net.Listen
    platforms: [all]

  - id: net/go/listen-tcp
    description: Listens for TCP connections
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: net.ListenTCP
    platforms: [all]

  - id: net/go/http-get
    description: HTTP GET requests
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: http.Get
    platforms: [all]

  - id: net/go/http-post
    description: HTTP POST requests
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: http.Post
    platforms: [all]

  - id: net/go/http-server
    description: HTTP server
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: http.ListenAndServe
    platforms: [all]

  # ==========================================
  # Cryptography
  # ==========================================

  - id: crypto/go/aes-cipher
    description: AES cipher creation
    criticality: none
    confidence: 0.9
    type: symbol
    pattern: aes.NewCipher
    platforms: [all]

  - id: crypto/go/cbc-encrypter
    description: CBC mode encrypter
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: cipher.NewCBCEncrypter
    platforms: [all]

  - id: crypto/go/rsa-encrypt
    description: RSA encryption
    criticality: none
    confidence: 0.9
    type: symbol
    pattern: rsa.EncryptOAEP
    platforms: [all]

  - id: crypto/go/rsa-keygen
    description: RSA key generation
    criticality: none
    confidence: 0.9
    type: symbol
    pattern: rsa.GenerateKey
    platforms: [all]

  # ==========================================
  # File Operations
  # ==========================================

  - id: fs/go/create
    description: File creation
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: os.Create
    platforms: [all]

  - id: fs/go/writefile
    description: Write to file
    criticality: none
    confidence: 0.8
    type: symbol_or_string
    any:
      - ioutil.WriteFile
      - os.WriteFile
    platforms: [all]

  - id: fs/go/remove
    description: Delete file
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: os.Remove
    platforms: [all]

  - id: fs/go/removeall
    description: Recursive directory deletion
    capability: true
    criticality: medium
    confidence: 0.95
    type: symbol
    pattern: os.RemoveAll
    platforms: [all]

  - id: fs/go/walk
    description: Directory tree traversal
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: filepath.Walk
    platforms: [all]

  - id: fs/go/readdir
    description: Read directory contents
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: ioutil.ReadDir
    platforms: [all]

  - id: fs/go/chmod
    description: Change file permissions
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: os.Chmod
    platforms: [unix, linux, macos]

  - id: fs/go/chown
    description: Change file ownership
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: os.Chown
    platforms: [unix, linux, macos]

  # ==========================================
  # Process Manipulation
  # ==========================================

  - id: process/go/find
    description: Find process by PID
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: os.FindProcess
    platforms: [all]

  - id: process/go/kill
    description: Send signal to process
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: syscall.Kill
    platforms: [unix, linux, macos]

  - id: process/go/setuid
    description: Change user ID
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: syscall.Setuid
    platforms: [unix, linux, macos]

  - id: process/go/setgid
    description: Change group ID
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: syscall.Setgid
    platforms: [unix, linux, macos]

  # ==========================================
  # Persistence
  # ==========================================

  - id: persistence/go/symlink
    description: Create symbolic link
    capability: true
    criticality: low
    confidence: 0.8
    type: symbol
    pattern: os.Symlink
    platforms: [unix, linux, macos]

  # ==========================================
  # Reflection & Dynamic Loading
  # ==========================================

  - id: anti-analysis/go/reflect-valueof
    description: Reflection operations
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: reflect.ValueOf
    platforms: [all]

  - id: anti-analysis/go/reflect-call
    description: Dynamic function invocation
    capability: true
    criticality: medium
    confidence: 0.85
    type: symbol
    pattern: reflect.Call
    platforms: [all]

  - id: exec/go/plugin-load
    description: Runtime plugin loading
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: plugin.Open
    platforms: [unix, linux, macos]

  # ==========================================
  # Unsafe Operations
  # ==========================================

  - id: unsafe/go/pointer
    description: Unsafe pointer operations
    capability: true
    criticality: medium
    confidence: 0.8
    type: symbol
    pattern: unsafe.Pointer
    platforms: [all]

  - id: unsafe/go/mmap
    description: Memory mapping
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: syscall.Mmap
    platforms: [unix, linux, macos]

  - id: unsafe/go/mprotect
    description: Change memory protection
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: syscall.Mprotect
    platforms: [unix, linux, macos]

  # ==========================================
  # Encoding & Obfuscation
  # ==========================================

  - id: encoding/go/base64-decode
    description: Base64 decoding
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: base64.StdEncoding.DecodeString
    platforms: [all]

  - id: encoding/go/hex-decode
    description: Hex decoding
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: hex.DecodeString
    platforms: [all]

  - id: compression/go/gzip
    description: Gzip decompression
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: gzip.NewReader
    platforms: [all]

  - id: compression/go/zlib
    description: Zlib decompression
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: zlib.NewReader
    platforms: [all]

  # ==========================================
  # Runtime Environment
  # ==========================================

  - id: anti-analysis/go/gomaxprocs
    description: Runtime environment query
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: runtime.GOMAXPROCS
    platforms: [all]

  - id: anti-analysis/go/goroutine-count
    description: Check goroutine count
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: runtime.NumGoroutine
    platforms: [all]

  # ==========================================
  # Shell References (Building Blocks)
  # ==========================================

  - id: exec/shell/bin-sh
    description: References /bin/sh
    criticality: none
    confidence: 1.0
    type: string
    exact: '/bin/sh'
    platforms: [unix, linux, macos]

  - id: exec/shell/bin-bash
    description: References /bin/bash
    criticality: none
    confidence: 1.0
    type: string
    exact: '/bin/bash'
    platforms: [unix, linux, macos]

  - id: exec/shell/cmd-exe
    description: References cmd.exe
    criticality: none
    confidence: 1.0
    type: string
    exact: 'cmd.exe'
    platforms: [windows]

  # ==========================================
  # Container/Cloud (Capability Markers)
  # ==========================================

  - id: container/go/docker-import
    description: Docker client library usage
    capability: true
    criticality: low
    confidence: 0.8
    type: symbol
    pattern: docker
    platforms: [all]

  - id: container/go/containerd-import
    description: Containerd library usage
    capability: true
    criticality: low
    confidence: 0.8
    type: symbol
    pattern: containerd
    platforms: [all]

  - id: container/go/k8s-import
    description: Kubernetes client library usage
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol_or_string
    any:
      - kubernetes
      - k8s.io
    platforms: [all]

# ============================================================================
# COMPOSITE CAPABILITIES: Behavioral Interpretations
# ============================================================================

capabilities:
  # ==========================================
  # Reverse Shell Patterns
  # ==========================================

  - id: c2/go/reverse-shell
    description: Reverse shell pattern (network + shell execution)
    confidence: 0.98
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: net/go/dial
      - type: trait
        id: exec/go/command
      - type: trait
        id: exec/shell/bin-sh
  - id: c2/go/reverse-shell-tcp
    description: TCP reverse shell (explicit TCP connection)
    confidence: 0.98
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: net/go/dial-tcp
      - type: trait
        id: exec/go/command
      - type: trait
        id: exec/shell/bin-sh
  # ==========================================
  # Ransomware Patterns
  # ==========================================

  - id: crypto/go/ransomware
    description: File encryption pattern (crypto + directory walking)
    confidence: 0.92
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: crypto/go/aes-cipher
      - type: trait
        id: fs/go/walk
  - id: crypto/go/ransomware-rsa
    description: RSA-based file encryption
    confidence: 0.90
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: crypto/go/rsa-keygen
      - type: trait
        id: fs/go/walk
      - type: trait
        id: fs/go/writefile
  # ==========================================
  # Obfuscated Execution
  # ==========================================

  - id: exec/go/obfuscated-base64
    description: Base64-obfuscated command execution
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: encoding/go/base64-decode
      - type: trait
        id: exec/go/command
  - id: exec/go/obfuscated-hex
    description: Hex-encoded command execution
    confidence: 0.92
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: encoding/go/hex-decode
      - type: trait
        id: exec/go/command
  # ==========================================
  # Privilege Escalation
  # ==========================================

  - id: privilege/go/setuid-exec
    description: Privilege escalation via setuid + execution
    confidence: 0.95
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: process/go/setuid
      - type: trait
        id: exec/go/command
  # ==========================================
  # Memory Manipulation
  # ==========================================

  - id: exec/go/memory-exec
    description: Code execution via memory manipulation
    confidence: 0.95
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: unsafe/go/mmap
      - type: trait
        id: unsafe/go/mprotect
  # ==========================================
  # Data Destruction
  # ==========================================

  - id: impact/go/wiper
    description: Potential wiper malware (recursive deletion)
    confidence: 0.85
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: fs/go/walk
      - type: trait
        id: fs/go/removeall
  # ==========================================
  # Container/K8s Persistence
  # ==========================================

  - id: persistence/go/k8s-exec
    description: Kubernetes execution capability (potential backdoor)
    confidence: 0.88
    criticality: medium
    platforms: [all]

    requires_all:
      - type: trait
        id: container/go/k8s-import
      - type: trait
        id: exec/go/command