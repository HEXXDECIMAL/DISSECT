# Meta - Apple System Component Identification
# Identifies legitimate Apple system binaries and frameworks
# These traits help contextualize findings for known-good system components

defaults:
  crit: inert
  platforms: [macos]
  for: [macho, dylib]

traits:
  # === Bundle Identifiers ===

  - id: bundle-id
    desc: Apple bundle identifier (com.apple.* with minimum length)
    crit: inert
    conf: 0.95
    if:
      id: metadata/apple/bundle-id::generic-apple
    not:
      - id: metadata/apple/bundle-id::mail
      - id: metadata/apple/bundle-id::ichat
      - id: metadata/apple/bundle-id::messages
      - id: metadata/apple/bundle-id::dt-runtime
      - id: metadata/apple/bundle-id::quarantine

  - id: system-daemon
    desc: Apple system daemon (libexec)
    crit: inert
    conf: 0.9
    platforms: [macos]
    for: [macho]
    if:
      type: string
      regex: "/usr/libexecution/[a-z][a-z0-9_-]+d\\b"

  - id: xpc-service
    desc: Apple XPC service
    crit: inert
    conf: 0.9
    platforms: [macos]
    for: [macho]
    if:
      type: string
      regex: "\\.xpc/Contents/MacOS/"

  # === Code Signing ===

  # === Project Identifiers ===

  - id: project-marker
    desc: Apple internal project marker
    conf: 0.95
    if:
      type: string
      # Apple internal PROJECT: marker in binary
      regex: "@\\(#\\)PROGRAM:[a-z]+\\s+PROJECT:[A-Za-z]+-[0-9]+"

  # === Apple Frameworks ===

  # === Ad framework atomic indicators ===
  - id: adcore-framework
    desc: AdCore.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "/AdCore.framework/"

  - id: adid-framework
    desc: AdID.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "/AdID.framework/"

  - id: limitadtracking-framework
    desc: LimitAdTracking.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "/LimitAdTracking.framework/"

  # === Privacy framework atomic indicators ===
  - id: apptrackingtransparency-framework
    desc: AppTrackingTransparency.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "/AppTrackingTransparency.framework/"

  # === Privacycontentprediction framework ===
  - id: privacycontentprediction-framework
    desc: PrivacyContentPrediction.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "/PrivacyContentPrediction.framework/"

  - id: private-framework
    desc: Apple private framework usage
    conf: 0.85
    if:
      type: string
      substr: "/System/Library/PrivateFrameworks"

  - id: system-framework
    desc: Apple system framework path
    crit: inert
    conf: 0.85
    if:
      type: string
      substr: "/System/Library/Frameworks"

  - id: launchd-plist
    desc: launchd plist embedding
    crit: inert
    conf: 0.85
    if:
      type: string
      substr: "launchd.plist"

  # === IPC Mechanisms ===

  # === Dispatch (GCD) ===

  # === Dispatch queue atomic indicators ===
  - id: dispatch-queue-create
    desc: dispatch_queue_create symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      regex: "dispatch_queue_create"

  - id: dispatch-get-global-queue
    desc: dispatch_get_global_queue symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      regex: "dispatch_get_global_queue"

  # === Dispatch async atomic indicators ===
  - id: dispatch-async-symbol
    desc: dispatch_async symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      regex: "dispatch_async"

  - id: dispatch-sync-symbol
    desc: dispatch_sync symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      regex: "dispatch_sync"

  - id: dispatch-source
    desc: Grand Central Dispatch source (event
    conf: 0.85
    if:
      type: symbol
      regex: "dispatch_source_create"


composite_rules:
  - id: ad-framework
    desc: Apple advertising framework usage
    crit: notable
    conf: 0.9
    any:
      - id: adcore-framework
      - id: adid-framework
      - id: limitadtracking-framework

  - id: privacy-framework
    desc: Apple privacy framework usage
    crit: notable
    conf: 0.9
    any:
      - id: apptrackingtransparency-framework
      - id: privacycontentprediction-framework

  - id: dispatch-queue
    desc: Grand Central Dispatch queue usage
    conf: 0.8
    any:
      - id: dispatch-queue-create
      - id: dispatch-get-global-queue

  - id: dispatch-async
    desc: Grand Central Dispatch async execution
    conf: 0.8
    any:
      - id: dispatch-async-symbol
      - id: dispatch-sync-symbol

  # Helper: Any Apple framework path detected
  - id: any-framework
    desc: Any Apple framework path (system
    crit: inert
    conf: 0.85
    platforms: [macos]
    for: [macho]
    any:
      - id: system-framework
      - id: private-framework

  # Bundle + Project combination
  - id: bundle-and-project
    desc: Apple bundle identifier with project
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    all:
      - id: bundle-id
      - id: project-marker

  # Bundle + Framework combination
  - id: bundle-and-framework
    desc: Apple bundle identifier with framework
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    all:
      - id: bundle-id
      - id: any-framework

  # Project + Framework combination
  - id: project-and-framework
    desc: Apple project marker with framework
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    all:
      - id: project-marker
      - id: any-framework

  # Valid structure combinations (helper)
  - id: system-component-indicators
    desc: Apple system component structure
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    any:
      - id: bundle-and-project
      - id: bundle-and-framework
      - id: project-and-framework
      - id: project-marker

  # Main composite: Requires structure AND platform signature
  - id: system-component
    desc: Apple system component (legitimate macOS)
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    all:
      - id: metadata/sign/apple::platform
      - id: system-component-indicators
