# Node.js Testing Patterns
# Detects Node.js core tests and common testing patterns

defaults:
  for: [javascript, typescript]

traits:
  - id: node-common-require
    desc: Imports Node.js common test helper
    crit: notable
    if:
      type: raw
      regex: 'require\\(["'']\\.\\./common["'']\\)'

  - id: test-function-def
    desc: Defines generic test function
    if:
      type: raw
      regex: 'function test\s*\(\)\s*\{'

  - id: v8-native-syntax-eval
    desc: Uses V8 native syntax via eval
    if:
      type: raw
      regex: 'eval\(["'']%[A-Z][a-zA-Z]+'

  - id: joyent-copyright
    desc: Joyent copyright header Node.js
    if:
      type: string
      substr: Copyright Joyent, Inc. and other Node contributors

  - id: test-basename-pattern
    desc: Node.js test filename pattern
    if:
      type: basename
      regex: 'test[-_].{0,220}\.js$|.{0,220}[-_]test\.js$|.{0,220}\.spec\.js$'

composite_rules:
  - id: is-test
    desc: Identifies Node.js test files
    crit: inert
    conf: 0.9
    for: [javascript, typescript]
    any:
      - id: node-common-require
      - id: objectives/lateral-movement/supply-chain/npm/testing::has-assertions
      - id: test-basename-pattern
