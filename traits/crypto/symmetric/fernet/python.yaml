# Fernet Encryption Library Detection (Python)
# Fernet is a symmetric encryption library often abused by malware for payload encryption
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [python]
  attack: "T1027"
  mbc: "C0027"

traits:
  # === Fernet import atomic indicators ===
  - id: import-fernet-direct
    desc: Direct fernet import
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "\\bimport\\s+fernet\\b"

  - id: from-cryptography-fernet
    desc: From cryptography.fernet import
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "\\bfrom\\s+cryptography\\.fernet\\s+import"

  # Fernet class usage
  - id: class-usage
    desc: "Fernet encryption class instantiation"
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "Fernet\\s*\\("

  # Fernet decrypt operation
  - id: decrypt
    desc: "Fernet decryption operation"
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: "\\.decrypt\\s*\\("

  # Fernet key generation
  - id: keygen
    desc: "Fernet key generation"
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "Fernet\\.generate_key\\s*\\("

  # Runtime fernet installation (very suspicious - why install crypto at runtime?)
  - id: runtime-install
    desc: "Runtime installation of fernet encryption library"
    crit: suspicious
    conf: 0.95
    if:
      type: yara
      source: |
        rule fernet_runtime_install {
          meta:
            description = "Detects runtime installation of fernet library"
          strings:
            $pip_fernet1 = "pip install fernet" ascii nocase
            $pip_fernet2 = "pip install cryptography" ascii nocase
            $import_check = "import fernet" ascii
            $except = "except" ascii
            $importerror = "ImportError" ascii
          condition:
            ($pip_fernet1 or $pip_fernet2) and ($except or $importerror or $import_check)
        }

  # Fernet with hardcoded key (payload decryption)
  - id: hardcoded-key
    desc: "Fernet encryption with hardcoded key pattern"
    crit: suspicious
    conf: 0.9
    if:
      type: yara
      source: |
        rule fernet_hardcoded_key {
          meta:
            description = "Fernet with base64 key (44 chars ending in =)"
          strings:
            $fernet = "Fernet" ascii
            $b64_key = /b['"][A-Za-z0-9+\/]{43}=['"]/ ascii
          condition:
            $fernet and $b64_key
        }

composite_rules:
  # Fernet import composite
  - id: import
    desc: Fernet symmetric encryption library import
    crit: notable
    conf: 0.9
    requires_count: 1
    any:
      - id: import-fernet-direct
      - id: from-cryptography-fernet
