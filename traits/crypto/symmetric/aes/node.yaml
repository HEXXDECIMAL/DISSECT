# Node.js AES Encryption Traits
# Detects AES encryption usage patterns (often used in C2 communication)
# MBC: C0027 (Cryptography)
# ATT&CK: T1573 (Encrypted Channel)

traits:
  # === Crypto module import atomic indicators ===
  - id: crypto-require-call
    desc: require('crypto') import
    crit: inert
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "require\\(['\"]crypto['\"]\\)"

  - id: crypto-from-import
    desc: from 'crypto' import (ESM)
    crit: inert
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "from ['\"]crypto['\"]"

  # Cipher Creation
  - id: createCipheriv
    desc: Create cipher with IV (symmetric encryption)
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "createCipheriv"

  - id: createDecipheriv
    desc: Create decipher with IV (symmetric decryption)
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "createDecipheriv"

  # === AES-128-CTR atomic indicators ===
  - id: aes-128-ctr-dash
    desc: AES-128-CTR with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes-128-ctr"

  - id: aes128ctr-nodash
    desc: AES-128-CTR without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes128ctr"

  # === AES-256-CBC atomic indicators ===
  - id: aes-256-cbc-dash
    desc: AES-256-CBC with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes-256-cbc"

  - id: aes256cbc-nodash
    desc: AES-256-CBC without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes256cbc"

  # === AES-256-GCM atomic indicators ===
  - id: aes-256-gcm-dash
    desc: AES-256-GCM with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes-256-gcm"

  - id: aes256gcm-nodash
    desc: AES-256-GCM without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes256gcm"

  # Encryption with Network Activity
  - id: encrypted-c2
    desc: AES encryption combined with network requests (encrypted C2)
    crit: suspicious
    conf: 0.9
    mbc: "C0027"
    attack: "T1573"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule encrypted_c2_channel {
          strings:
            $cipher1 = "createCipheriv"
            $cipher2 = "createDecipheriv"
            $aes = "aes-" nocase
            $net1 = "https.request"
            $net2 = "http.request"
            $net3 = "fetch("
            $net4 = "axios"
            $dns = "resolveTxt"
          condition:
            any of ($cipher*) and $aes and any of ($net*, $dns)
        }

  # Key/IV Handling
  - id: hardcoded-key
    desc: Hardcoded encryption key pattern
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule hardcoded_crypto_key {
          strings:
            $key = /['"](key|secret|password|pass)['"]\s*[,:=]\s*['"][A-Za-z0-9+\/=]{16,}['"]/
            $iv = /iv\s*[,:=]\s*['"][A-Za-z0-9+\/=]{16,}['"]/
            $hex = /Buffer\.from\s*\(\s*['"][0-9a-fA-F]{32,}['"]/
          condition:
            any of them
        }

  # Compression with Encryption
  - id: gzip-with-crypto
    desc: Gzip compression with encryption (obfuscated payload)
    crit: suspicious
    conf: 0.85
    mbc: "C0027"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule compressed_encrypted_payload {
          strings:
            $gzip1 = "zlib"
            $gzip2 = "gzip"
            $gzip3 = "gunzip"
            $gzip4 = "inflate"
            $gzip5 = "deflate"
            $crypto1 = "createCipheriv"
            $crypto2 = "createDecipheriv"
          condition:
            any of ($gzip*) and any of ($crypto*)
        }

composite_rules:
  # Crypto require composite
  - id: crypto-require
    desc: Node.js crypto module import
    crit: inert
    conf: 0.9
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: crypto-require-call
      - id: crypto-from-import

  # AES-128-CTR composite
  - id: aes-128-ctr
    desc: AES-128-CTR encryption (stream cipher mode)
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: aes-128-ctr-dash
      - id: aes128ctr-nodash

  # AES-256-CBC composite
  - id: aes-256-cbc
    desc: AES-256-CBC encryption
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: aes-256-cbc-dash
      - id: aes256cbc-nodash

  # AES-256-GCM composite
  - id: aes-256-gcm
    desc: AES-256-GCM authenticated encryption
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: aes-256-gcm-dash
      - id: aes256gcm-nodash
