# Execution Capabilities
# Covers command execution, process spawning, code injection, etc.

simple_rules:
  # Shell command execution
  - symbol: system
    capability: exec/command/shell
    description: Execute shell commands via system()
    confidence: 0.8
    platforms: [all]

  - symbol: popen
    capability: exec/command/shell
    description: Execute commands via popen()
    confidence: 0.8
    platforms: [unix, linux, macos]

  # Direct program execution
  - symbol: execve
    capability: exec/program/direct
    description: Execute programs directly
    confidence: 0.9
    platforms: [unix, linux, macos]

  - symbol: execv
    capability: exec/program/direct
    description: Execute programs directly
    confidence: 0.9
    platforms: [unix, linux, macos]

  - symbol: execl
    capability: exec/program/direct
    description: Execute programs directly
    confidence: 0.9
    platforms: [unix, linux, macos]

  - symbol: execlp
    capability: exec/program/direct
    description: Execute programs via PATH
    confidence: 0.9
    platforms: [unix, linux, macos]

  - symbol: execvp
    capability: exec/program/direct
    description: Execute programs via PATH
    confidence: 0.9
    platforms: [unix, linux, macos]

  # Process spawning
  - symbol: fork
    capability: process/spawn
    description: Create child processes
    confidence: 0.7
    platforms: [unix, linux, macos]

  - symbol: vfork
    capability: process/spawn
    description: Create child processes
    confidence: 0.7
    platforms: [unix, linux, macos]

  - symbol: posix_spawn
    capability: process/spawn
    description: Spawn child processes
    confidence: 0.8
    platforms: [unix, linux, macos]

  # Dynamic library loading
  - symbol: dlopen
    capability: exec/dylib/load
    description: Load dynamic libraries at runtime
    confidence: 0.7
    platforms: [unix, linux, macos]

  - symbol: dlsym
    capability: exec/dylib/resolve
    description: Resolve dynamic library symbols
    confidence: 0.7
    platforms: [unix, linux, macos]

  # Process debugging/tracing
  - symbol: ptrace
    capability: process/debug/attach
    description: Attach debugger to processes
    confidence: 1.0
    platforms: [linux, unix]
    file_types: [elf]

  # macOS process injection APIs
  - symbol: task_for_pid
    capability: process/inject/access
    description: Get task port for process (macOS)
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib]

  - symbol: mach_vm_write
    capability: process/inject/write
    description: Write to process memory (macOS)
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib]

composite_rules:
  # Shellcode execution pattern
  - capability: exec/shellcode/execute
    description: Execute shellcode in memory
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # Memory allocation/mapping
      - type: symbol_or_string
        any:
          - mmap
          - VirtualAlloc
          - malloc

      # Memory protection change (make executable)
      - type: symbol_or_string
        any:
          - mprotect
          - VirtualProtect

      # High entropy data (potential shellcode)
      - type: structure
        feature: entropy/high
        min_sections: 1

      # Jump to dynamic address
      - type: yara_match
        namespace: exec.shellcode

  # Process injection (comprehensive)
  - capability: process/inject/code
    description: Inject code into remote process
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # Process access/attachment
      - type: symbol_or_string
        any:
          - ptrace
          - task_for_pid
          - OpenProcess
          - '/proc/[0-9]+/mem'

      # Memory manipulation
      - type: symbol_or_string
        any:
          - mach_vm_write
          - process_vm_writev
          - WriteProcessMemory
          - mprotect

      # Thread creation in remote process
      - type: symbol_or_string
        any:
          - thread_create
          - CreateRemoteThread
          - RtlCreateUserThread

  # Reflective DLL injection
  - capability: exec/dll/reflective
    description: Reflective DLL injection
    confidence: 0.95
    platforms: [windows]
    file_types: [pe, dll]

    requires_all:
      # PE header parsing
      - type: string
        regex: 'IMAGE_DOS_HEADER|IMAGE_NT_HEADERS'

      # Memory allocation
      - type: symbol
        pattern: 'VirtualAlloc'

      # Manual DLL loading
      - type: yara_match
        namespace: exec.reflective-dll

  # Downloaded code execution
  - capability: exec/download-and-execute
    description: Download and execute remote code
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Network download
      - type: symbol_or_string
        any:
          - curl
          - wget
          - URLSession
          - HttpURLConnection
          - 'http://'
          - 'https://'

      # Execution capability
      - type: symbol_or_string
        any:
          - system
          - execve
          - popen
          - dlopen
          - CreateProcess

      # Temporary file usage (optional)
      - type: symbol_or_string
        any:
          - mkstemp
          - tmpfile
          - '/tmp/'
          - GetTempPath

  # Command injection vulnerability
  - capability: exec/command-injection
    description: Potential command injection pattern
    confidence: 0.75
    platforms: [all]

    requires_all:
      # User input functions
      - type: symbol_or_string
        any:
          - getenv
          - fgets
          - scanf
          - recv
          - read

      # Command execution without sanitization
      - type: symbol
        pattern: 'system|popen'

      # Shell metacharacters in strings
      - type: string
        regex: '[;&|`$()<>]'

  # Script interpreter execution
  - capability: exec/interpreter
    description: Execute scripts via interpreter
    confidence: 0.8
    platforms: [all]

    requires_any:
      # Python execution
      - type: string
        regex: 'python[0-9.]* -c|python.*exec|python.*eval'

      # Perl execution
      - type: string
        regex: 'perl -e|perl.*eval'

      # Ruby execution
      - type: string
        regex: 'ruby -e|ruby.*eval'

      # Node.js execution
      - type: string
        regex: 'node -e|node.*eval'

      # Shell execution
      - type: string
        regex: '(bash|sh) -c|eval '

  # Fileless execution
  - capability: exec/fileless
    description: Execute code without writing to disk
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Memory execution
      - type: symbol_or_string
        any:
          - memfd_create
          - mmap
          - shm_open
          - '/dev/shm'

      # Execution from memory
      - type: symbol_or_string
        any:
          - execve
          - fexecve
          - dlopen

      # No file write operations
      - type: imports_count
        max: 5
        filter: 'fwrite|write|creat|open.*O_CREAT'

  # DLL hijacking preparation
  - capability: exec/dll-hijack
    description: DLL search order hijacking
    confidence: 0.8
    platforms: [windows]
    file_types: [pe, dll]

    requires_count: 2
    conditions:
      # DLL loading
      - type: symbol
        pattern: 'LoadLibrary|LoadLibraryEx'

      # Current directory check
      - type: symbol_or_string
        any:
          - GetCurrentDirectory
          - SetDllDirectory
          - '.\\'

      # Common hijackable DLLs
      - type: string
        regex: '(version|uxtheme|ntshrui|wlbsctrl)\.dll'
        case_insensitive: true

  # macOS dylib injection
  - capability: exec/dylib/inject
    description: Inject dynamic library into process
    confidence: 0.9
    platforms: [macos]
    file_types: [macho, dylib]

    requires_all:
      # Process access
      - type: symbol_or_string
        any:
          - task_for_pid
          - DYLD_INSERT_LIBRARIES

      # Memory manipulation
      - type: symbol
        pattern: 'mach_vm_write|mach_vm_allocate'

      # Thread creation
      - type: symbol
        pattern: 'thread_create_running'

  # Linux shared object injection
  - capability: exec/so/inject
    description: Inject shared object into process
    confidence: 0.9
    platforms: [linux]
    file_types: [elf, so]

    requires_count: 2
    conditions:
      # LD_PRELOAD technique
      - type: string
        exact: 'LD_PRELOAD'

      # ptrace injection
      - type: symbol
        pattern: ptrace

      # /proc manipulation
      - type: string
        regex: '/proc/[0-9]+/(mem|maps)'

      # dlopen injection
      - type: symbol_or_string
        any:
          - dlopen
          - __libc_dlopen_mode

  # Inline hooking
  - capability: exec/hook/inline
    description: Inline function hooking
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Memory protection modification
      - type: symbol
        pattern: 'mprotect|VirtualProtect'

      # Jump instruction patterns
      - type: yara_match
        namespace: exec.hook

      # Memory write to code section
      - type: symbol_or_string
        any:
          - memcpy
          - WriteProcessMemory
          - mach_vm_write

  # Kernel module loading
  - capability: exec/kernel/module
    description: Load kernel modules
    confidence: 0.95
    platforms: [linux, unix]

    requires_any:
      # Kernel module paths
      - type: string
        regex: '/lib/modules|\.ko$|insmod|modprobe'

      # Kernel symbols
      - type: symbol
        pattern: 'init_module|finit_module'

      # /sys or /proc manipulation
      - type: string
        regex: '/sys/module|/proc/sys/kernel'

  # SSH server backdoor pattern (xzutils-style)
  - capability: exec/backdoor/ssh
    description: SSH server backdoor with crypto and execution capabilities
    confidence: 0.95
    platforms: [linux, unix]
    file_types: [elf, so, dylib]

    requires_all:
      # Crypto library imports (RSA functions suspicious in compression libs)
      - type: symbol_or_string
        any:
          - RSA_public_decrypt
          - EVP_PKEY_set1_RSA
          - EVP_PKEY_new
          - RSA_public_encrypt
          - libcrypto
          - OpenSSL

      # Command execution capability
      - type: symbol_or_string
        any:
          - system
          - execve
          - popen
          - execl
          - execv

      # High entropy or obfuscation (shellcode/packed)
      - type: structure
        feature: entropy/high
