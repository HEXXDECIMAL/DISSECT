# Credential Access - Firefox Browser Data Theft
# ATT&CK: T1555.003 (Credentials from Password Stores: Credentials from Web Browsers)

traits:
  # === Path/File References ===

  - id: credential/browser/firefox/path
    description: Firefox browser reference
    criticality: notable
    confidence: 0.6
    attack: "T1555.003"
    condition:
      type: string
      exact: "Firefox"

  - id: credential/browser/firefox/cookies-sqlite
    description: Firefox cookies.sqlite database
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.003"
    condition:
      type: string
      exact: "cookies.sqlite"

  - id: credential/browser/firefox/formhistory-sqlite
    description: Firefox formhistory.sqlite database
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    condition:
      type: string
      exact: "formhistory.sqlite"

  - id: credential/browser/firefox/logins-json
    description: Firefox logins.json file
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    condition:
      type: string
      exact: "logins.json"

  - id: credential/browser/firefox/key4-db
    description: Firefox key4.db (master password database)
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.003"
    condition:
      type: string
      exact: "key4.db"

  - id: credential/browser/firefox/cert9-db
    description: Firefox cert9.db certificate store
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.003"
    condition:
      type: string
      exact: "cert9.db"

  # === NSS Library (used for decryption) ===

  - id: credential/browser/firefox/nss-private
    description: Firefox NSS private key database
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.003"
    condition:
      type: string
      exact: "nssPrivate"

  - id: credential/browser/firefox/nss3-lib
    description: Firefox NSS3 library reference
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    condition:
      type: string
      regex: "\\bnss3\\b|libnss3"

  - id: credential/browser/firefox/pk11-decrypt
    description: Firefox PK11SDR_Decrypt function
    criticality: hostile
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    condition:
      type: string
      exact: "PK11SDR_Decrypt"

  # === SQL Queries ===

  - id: credential/browser/firefox/moz-cookies-sql
    description: Firefox moz_cookies SQL query
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.003"
    condition:
      type: string
      regex: "SELECT.*FROM\\s+moz_cookies"
      case_insensitive: true

  - id: credential/browser/firefox/moz-logins-sql
    description: Firefox moz_logins SQL query
    criticality: hostile
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    condition:
      type: string
      regex: "SELECT.*FROM\\s+moz_logins"
      case_insensitive: true

composite_rules:
  - id: credential/browser/firefox/cookie-theft
    description: Firefox cookie theft
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    requires_all:
      - type: trait
        id: credential/browser/firefox/path
      - type: trait
        id: credential/browser/firefox/cookies-sqlite

  - id: credential/browser/firefox/password-theft
    description: Firefox password/form history theft
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    requires_all:
      - type: trait
        id: credential/browser/firefox/path
    requires_any:
      - type: trait
        id: credential/browser/firefox/formhistory-sqlite
      - type: trait
        id: credential/browser/firefox/nss-private
      - type: trait
        id: credential/browser/firefox/logins-json
      - type: trait
        id: credential/browser/firefox/key4-db

  - id: credential/browser/firefox/nss-decrypt
    description: Firefox NSS decryption (password extraction)
    criticality: hostile
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    requires_any:
      - type: trait
        id: credential/browser/firefox/pk11-decrypt
      - type: trait
        id: credential/browser/firefox/nss3-lib
    requires_all:
      - type: trait
        id: credential/browser/firefox/path
