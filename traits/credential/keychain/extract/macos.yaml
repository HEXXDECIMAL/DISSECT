# Keychain Credential Access (macOS)
# MBC: E1555 (Credentials from Password Stores)
# ATT&CK: T1555.001

traits:
  # === Atomic: Security Framework Symbols ===

  - id: credential/keychain/find-generic
    description: Read passwords from macOS Keychain (SecKeychainFindGenericPassword)
    criticality: suspicious
    confidence: 0.9
    mbc: "E1555.001"
    attack: "T1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "SecKeychainFindGenericPassword"

  - id: credential/keychain/find-internet
    description: Read internet passwords from macOS Keychain (SecKeychainFindInternetPassword)
    criticality: suspicious
    confidence: 0.9
    mbc: "E1555.001"
    attack: "T1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "SecKeychainFindInternetPassword"

  - id: credential/keychain/item-copy-content
    description: Copy Keychain item contents (SecKeychainItemCopyContent)
    criticality: suspicious
    confidence: 0.95
    mbc: "E1555.001"
    attack: "T1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "SecKeychainItemCopyContent"

  - id: credential/keychain/open
    description: Open Keychain database (SecKeychainOpen)
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "SecKeychainOpen"

  - id: credential/keychain/copy-default
    description: Copy default Keychain reference (SecKeychainCopyDefault)
    criticality: notable
    confidence: 0.7
    attack: "T1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "SecKeychainCopyDefault"

  - id: credential/keychain/sec-item-copy
    description: Copy keychain item attributes (SecItemCopyMatching)
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "SecItemCopy"

  # === Atomic: Command Line Tools ===

  - id: credential/keychain/security-cli
    description: macOS security command line tool
    criticality: suspicious
    confidence: 0.75
    attack: "T1555.001"
    platforms: [macos]
    file_types: [shell, macho]
    condition:
      type: string
      exact: "security "

  - id: credential/keychain/find-generic-password-cli
    description: security find-generic-password command
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.001"
    platforms: [macos]
    file_types: [shell, macho]
    condition:
      type: string
      exact: "find-generic-password"

  - id: credential/keychain/dump-keychain-cli
    description: security dump-keychain command
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.001"
    platforms: [macos]
    file_types: [shell, macho]
    condition:
      type: string
      exact: "dump-keychain"

  # === Atomic: Keychain File Paths ===

  - id: credential/keychain/login-path
    description: User login keychain path
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.001"
    platforms: [macos]
    file_types: [all]
    condition:
      type: string
      exact: "login.keychain"

  - id: credential/keychain/system-path
    description: System keychain path
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.001"
    platforms: [macos]
    file_types: [all]
    condition:
      type: string
      exact: "/Library/Keychains/System.keychain"

composite_rules:
  - id: credential/keychain/password-extraction
    description: macOS Keychain password extraction
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.001"
    mbc: "E1555.001"
    platforms: [macos]
    file_types: [macho, dylib]
    requires_any:
      - type: trait
        id: credential/keychain/find-generic
      - type: trait
        id: credential/keychain/find-internet
    requires_all:
      - type: trait
        id: credential/keychain/item-copy-content

  - id: credential/keychain/cli-dump
    description: macOS Keychain dump via CLI
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.001"
    platforms: [macos]
    file_types: [shell, macho]
    requires_all:
      - type: trait
        id: credential/keychain/security-cli
    requires_any:
      - type: trait
        id: credential/keychain/find-generic-password-cli
      - type: trait
        id: credential/keychain/dump-keychain-cli
