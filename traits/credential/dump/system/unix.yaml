# Credential Dumping - Unix
# MBC: E1003 (OS Credential Dumping)
# ATT&CK: T1003 (OS Credential Dumping)

composite_rules:
  # === Atomic: Password Database Functions ===

  - id: credential/dump/getpwnam
    description: Read user password database (getpwnam)
    criticality: inert
    confidence: 0.7
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [unix, linux, macos]
    file_types: [elf, macho, so, dylib]
    condition:
      type: symbol
      pattern: "getpwnam"

  - id: credential/dump/getpwuid
    description: Read user password database by UID (getpwuid)
    criticality: inert
    confidence: 0.7
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [unix, linux, macos]
    file_types: [elf, macho, so, dylib]
    condition:
      type: symbol
      pattern: "getpwuid"

  - id: credential/dump/getspnam
    description: Read shadow password file (getspnam)
    criticality: suspicious
    confidence: 1.0
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [linux, unix]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "getspnam"

  # === Atomic: Direct File Access ===

  # NOTE: For ELF binaries, shadow file access is common in system utilities
  # Real credential dumping detection requires additional context
  - id: credential/dump/shadow-file
    description: Direct shadow file access (/etc/shadow)
    criticality: notable
    confidence: 0.6
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [linux, unix]
    file_types: [all]
    condition:
      type: string
      exact: "/etc/shadow"

  - id: credential/dump/passwd-file
    description: Password file access (/etc/passwd)
    criticality: inert
    confidence: 0.6
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [unix, linux, macos]
    file_types: [all]
    condition:
      type: string
      exact: "/etc/passwd"

  # NOTE: System utilities like busybox legitimately access gshadow
  - id: credential/dump/gshadow-file
    description: Group shadow file access (/etc/gshadow)
    criticality: notable
    confidence: 0.6
    attack: "T1003.008"
    platforms: [linux]
    file_types: [all]
    condition:
      type: string
      exact: "/etc/gshadow"

  - id: credential/dump/master-passwd
    description: BSD master.passwd file access
    criticality: suspicious
    confidence: 0.9
    attack: "T1003.008"
    platforms: [macos, unix]
    file_types: [all]
    condition:
      type: string
      exact: "/etc/master.passwd"

  - id: credential/dump/shadow-extraction
    description: Shadow file credential extraction
    criticality: suspicious
    confidence: 0.9
    attack: "T1003.008"
    mbc: "E1003.008"
    platforms: [linux, unix]
    file_types: [elf]
    requires_any:
      - type: trait
        id: credential/dump/getspnam
      - type: trait
        id: credential/dump/shadow-file
