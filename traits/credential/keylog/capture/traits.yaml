# Keylogging Detection
# MBC: B0015 (Keylogging)
# ATT&CK: T1056.001 (Input Capture: Keylogging)
#
# NOTE: Single keyboard API usage is suspicious but not hostile.
# These APIs are used legitimately by accessibility software, games,
# hotkey managers, and automation tools. Hostile classification
# requires multiple indicators (e.g., keyboard capture + exfiltration).

traits:
  # === Atomic: Windows Keyboard Hooks ===

  - id: credential/keylog/windows-hook
    description: Windows keyboard hooking via SetWindowsHookEx
    criticality: suspicious
    confidence: 0.7
    mbc: "B0015.001"
    attack: "T1056.001"
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: symbol
      pattern: "SetWindowsHookEx"

  - id: credential/keylog/windows-rawinput
    description: Windows raw input API for keyboard access
    criticality: suspicious
    confidence: 0.7
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: symbol
      pattern: "GetRawInputData"

  - id: credential/keylog/windows-asynckey
    description: Windows GetAsyncKeyState for key polling
    criticality: suspicious
    confidence: 0.65
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: symbol
      pattern: "GetAsyncKeyState"

  # === Atomic: Linux Keyboard Input ===

  - id: credential/keylog/linux-input-device
    description: Direct access to Linux input devices
    criticality: suspicious
    confidence: 0.75
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [linux]
    file_types: [elf, python, shell]
    condition:
      type: string
      regex: "/dev/input/event[0-9]+"

  - id: credential/keylog/x11-grab
    description: X11 key grabbing for keylogging
    criticality: suspicious
    confidence: 0.65
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [linux, unix]
    file_types: [elf, so]
    condition:
      type: symbol
      pattern: "XGrabKey"

  # === Atomic: macOS Keyboard Capture ===

  - id: credential/keylog/macos-eventtap
    description: macOS CGEventTap for key interception
    criticality: suspicious
    confidence: 0.7
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "CGEventTapCreate"

  # === Atomic: Language Libraries ===

  - id: credential/keylog/go-gohook
    description: Go robotn/gohook keyboard capture library
    criticality: suspicious
    confidence: 0.75
    mbc: "B0015"
    attack: "T1056.001"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "github.com/robotn/gohook"

  - id: credential/keylog/python-pynput
    description: Python pynput keyboard listener
    criticality: suspicious
    confidence: 0.7
    mbc: "B0015"
    attack: "T1056.001"
    file_types: [python]
    condition:
      type: string
      regex: "(from pynput import keyboard|from pynput\\.keyboard)"

  - id: credential/keylog/js-iohook
    description: Node.js iohook global keyboard hook library
    criticality: suspicious
    confidence: 0.75
    mbc: "B0015"
    attack: "T1056.001"
    file_types: [javascript]
    condition:
      type: string
      regex: "(require\\(['\"]iohook['\"]\\)|from ['\"]iohook['\"])"

  - id: credential/keylog/rust-rdev
    description: Rust rdev keyboard event library
    criticality: suspicious
    confidence: 0.65
    mbc: "B0015"
    attack: "T1056.001"
    file_types: [rust]
    condition:
      type: string
      regex: "(use rdev::|extern crate rdev)"

composite_rules:
  # Composite rules requiring multiple keyboard-related indicators
  # are still only suspicious - need exfiltration for hostile

  - id: credential/keylog/windows-keylogger
    description: Windows keylogger pattern (multiple keyboard APIs)
    criticality: suspicious
    confidence: 0.85
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [windows]
    file_types: [pe, dll]
    requires_count: 2
    conditions:
      - type: trait
        id: credential/keylog/windows-hook
      - type: trait
        id: credential/keylog/windows-rawinput
      - type: trait
        id: credential/keylog/windows-asynckey

  - id: credential/keylog/linux-keylogger
    description: Linux keylogger pattern (multiple input methods)
    criticality: suspicious
    confidence: 0.85
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [linux]
    file_types: [elf]
    requires_all:
      - type: trait
        id: credential/keylog/linux-input-device
      - type: trait
        id: credential/keylog/x11-grab
