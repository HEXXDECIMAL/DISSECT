# Credential Access - SSH Keys and Configuration
# ATT&CK: T1552.004 (Unsecured Credentials: Private Keys)

defaults:
  platforms: [linux, macos, unix]

composite_rules:
  # === Atomic: SSH Directory ===
  - id: credential/ssh/dot-ssh-path
    description: Accesses .ssh directory
    criticality: notable
    confidence: 0.6
    attack: "T1552.004"
    condition:
      type: string
      regex: "/\\.ssh|\\.\\.ssh/"

  # === Atomic: SSH Private Keys ===
  - id: credential/ssh/id-rsa
    description: SSH id_rsa private key reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1552.004"
    condition:
      type: string
      exact: "id_rsa"

  - id: credential/ssh/id-dsa
    description: SSH id_dsa private key reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1552.004"
    condition:
      type: string
      exact: "id_dsa"

  - id: credential/ssh/id-ecdsa
    description: SSH id_ecdsa private key reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1552.004"
    condition:
      type: string
      exact: "id_ecdsa"

  - id: credential/ssh/id-ed25519
    description: SSH id_ed25519 private key reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1552.004"
    condition:
      type: string
      exact: "id_ed25519"

  # === Atomic: SSH Configuration Files ===
  - id: credential/ssh/authorized-keys
    description: SSH authorized_keys file reference
    criticality: notable
    confidence: 0.6
    attack: "T1552.004"
    condition:
      type: string
      exact: "authorized_keys"

  - id: credential/ssh/known-hosts
    description: SSH known_hosts file reference
    criticality: notable
    confidence: 0.5
    attack: "T1552.004"
    condition:
      type: string
      exact: "known_hosts"

  # === Atomic: PuTTY (Windows) ===
  - id: credential/ssh/putty-sessions
    description: PuTTY sessions registry reference
    criticality: suspicious
    confidence: 0.8
    attack: "T1552.004"
    platforms: [windows]
    condition:
      type: string
      exact: "Software\\SimonTatham\\PuTTY\\Sessions"

  # === Atomic: SSHD Process (no ATT&CK - process reference, not credential access) ===
  - id: credential/ssh/sshd-ref
    description: SSHD daemon reference
    criticality: notable
    confidence: 0.5
    condition:
      type: string
      exact: "sshd"

  - id: credential/ssh/sshd-path
    description: SSHD daemon path
    criticality: suspicious
    confidence: 0.7
    condition:
      type: string
      exact: "/usr/bin/sshd"

  - id: credential/ssh/sshd-net-proc
    description: SSHD network process reference
    criticality: suspicious
    confidence: 0.8
    condition:
      type: string
      regex: "sshd: \\[(net|accepted)\\]"

  - id: credential/ssh/sshd-proc-ref
    description: SSHD process reference
    criticality: suspicious
    confidence: 0.75
    condition:
      type: string
      regex: "sshd_?proc"

  # === Composite Rules ===
  - id: credential/ssh/private-key-theft
    description: SSH private key theft
    criticality: suspicious
    confidence: 0.85
    attack: "T1552.004"
    mbc: "E1552"
    requires_all:
      - type: trait
        id: credential/ssh/dot-ssh-path
    requires_any:
      - type: trait
        id: credential/ssh/id-rsa
      - type: trait
        id: credential/ssh/id-dsa
      - type: trait
        id: credential/ssh/id-ecdsa
      - type: trait
        id: credential/ssh/id-ed25519

  - id: credential/ssh/sshd-password-trace
    description: SSHD memory tracing for passwords
    criticality: suspicious
    confidence: 0.85
    attack: "T1552.004"
    platforms: [linux]
    requires_all:
      - type: symbol_or_string
        any: ["ptrace", "tracer"]
      - type: string
        regex: "passw(or)?d"
      - type: trait
        id: credential/ssh/sshd-ref
