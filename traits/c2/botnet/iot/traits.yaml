# IoT Botnet Detection
# Patterns common to Mirai, Gafgyt, and similar IoT malware
# ATT&CK: T1059.004, T1110.001

traits:
  # NOTE: Individual "/bin/busybox" string is notable, not suspicious
  # Real IoT malware detection requires multiple indicators (see composite rules)
  - id: busybox
    description: "BusyBox reference (IoT device targeting)"
    criticality: notable
    confidence: 0.5
    attack: "T1059.004"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      exact: "/bin/busybox"

  - id: busybox-wget
    description: "BusyBox wget payload download"
    criticality: suspicious
    confidence: 0.9
    attack: "T1105"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "busybox wget"

  - id: busybox-tftp
    description: "BusyBox tftp payload download"
    criticality: suspicious
    confidence: 0.9
    attack: "T1105"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "busybox tftp"

  - id: busybox-ftpget
    description: "BusyBox ftpget payload download"
    criticality: suspicious
    confidence: 0.9
    attack: "T1105"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "busybox ftpget"

  - id: pipe-to-shell
    description: "Download and pipe to shell execution"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1059.004"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: yara
      source: |
        rule pipe_to_shell {
          strings:
            // curl/wget piped to shell
            $curl_sh = "curl " ascii
            $wget_sh = "wget " ascii
            $pipe_sh1 = " | sh" ascii
            $pipe_sh2 = " | bash" ascii
            $pipe_sh3 = " |sh" ascii
            $pipe_sh4 = " |bash" ascii
            // -O- | sh pattern
            $o_pipe1 = "-O- | sh" ascii
            $o_pipe2 = "-o- | sh" ascii
            $o_pipe3 = "-O - | sh" ascii
          condition:
            (($curl_sh or $wget_sh) and any of ($pipe_sh*)) or
            any of ($o_pipe*)
        }

  - id: mirai-credential
    description: "Mirai botnet default credential (7ujMko0admin)"
    criticality: suspicious
    confidence: 0.99
    attack: "T1110.001"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      exact: "7ujMko0admin"

  - id: telnet-target
    description: "Telnet service targeting"
    criticality: suspicious
    confidence: 0.8
    attack: "T1021.007"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "telnetadmin|:23[^0-9]"

  - id: self-propagate
    description: "Read own executable for propagation"
    criticality: suspicious
    confidence: 0.8
    mbc: "E1036"
    attack: "T1105"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: yara
      source: |
        rule self_propagate {
          strings:
            // Self-propagation patterns with network context
            $proc_exe = "/proc/self/exe" ascii
            $send1 = "send(" ascii
            $send2 = "sendto(" ascii
            $send3 = "sendfile(" ascii
            $tftp = "tftp" ascii
            $wget = "wget" ascii
            $curl = "curl" ascii
          condition:
            $proc_exe and (any of ($send*) or any of ($tftp, $wget, $curl))
        }

composite_rules:
  - id: mirai-variant
    description: "Mirai-like IoT botnet (credential brute-force + shell dropper)"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1110.001"
    file_types: [elf]
    platforms: [linux]
    requires_count: 2
    conditions:
      - type: trait
        id: mirai-credential
      - type: trait
        id: busybox
      - type: trait
        id: pipe-to-shell

  - id: multi-protocol
    description: "Multi-protocol payload dropper (wget/tftp/ftpget/curl)"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0024"
    attack: "T1105"
    file_types: [elf]
    platforms: [linux]
    requires_count: 2
    conditions:
      - type: trait
        id: busybox-wget
      - type: trait
        id: busybox-tftp
      - type: trait
        id: busybox-ftpget
      - type: string
        exact: "curl http://"
