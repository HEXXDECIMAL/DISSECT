# IoT Botnet Detection
# Patterns common to Mirai, Gafgyt, and similar IoT malware
# ATT&CK: T1059.004, T1110.001

traits:
  # NOTE: Individual "/bin/busybox" string is notable, not suspicious
  # Real IoT malware detection requires multiple indicators (see composite rules)
  - id: busybox
    desc: "BusyBox reference (IoT device targeting)"
    crit: notable
    conf: 0.5
    attack: "T1059.004"
    for: [elf]
    platforms: [linux]
    if:
      type: string
      exact: "/bin/busybox"

  - id: busybox-wget
    desc: "BusyBox wget payload download"
    crit: suspicious
    conf: 0.9
    attack: "T1105"
    for: [elf]
    platforms: [linux]
    if:
      type: string
      regex: "busybox wget"

  - id: busybox-tftp
    desc: "BusyBox tftp payload download"
    crit: suspicious
    conf: 0.9
    attack: "T1105"
    for: [elf]
    platforms: [linux]
    if:
      type: string
      regex: "busybox tftp"

  - id: busybox-ftpget
    desc: "BusyBox ftpget payload download"
    crit: suspicious
    conf: 0.9
    attack: "T1105"
    for: [elf]
    platforms: [linux]
    if:
      type: string
      regex: "busybox ftpget"

  - id: pipe-to-shell
    desc: "Download and pipe to shell execution"
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059.004"
    for: [elf]
    platforms: [linux]
    if:
      type: yara
      source: |
        rule pipe_to_shell {
          strings:
            // curl/wget piped to shell
            $curl_sh = "curl " ascii
            $wget_sh = "wget " ascii
            $pipe_sh1 = " | sh" ascii
            $pipe_sh2 = " | bash" ascii
            $pipe_sh3 = " |sh" ascii
            $pipe_sh4 = " |bash" ascii
            // -O- | sh pattern
            $o_pipe1 = "-O- | sh" ascii
            $o_pipe2 = "-o- | sh" ascii
            $o_pipe3 = "-O - | sh" ascii
          condition:
            (($curl_sh or $wget_sh) and any of ($pipe_sh*)) or
            any of ($o_pipe*)
        }

  # NOTE: Mirai credentials are defined in lateral/brute-force/iot-creds/traits.yaml

  - id: telnet-target
    desc: "Telnet service targeting"
    crit: suspicious
    conf: 0.8
    attack: "T1021.007"
    for: [elf]
    platforms: [linux]
    if:
      type: string
      regex: "telnetadmin|:23[^0-9]"

  - id: self-propagate
    desc: "Read own executable for propagation"
    crit: suspicious
    conf: 0.8
    mbc: "E1036"
    attack: "T1105"
    for: [elf]
    platforms: [linux]
    if:
      type: yara
      source: |
        rule self_propagate {
          strings:
            // Self-propagation patterns with network context
            $proc_exe = "/proc/self/exe" ascii
            $send1 = "send(" ascii
            $send2 = "sendto(" ascii
            $send3 = "sendfile(" ascii
            $tftp = "tftp" ascii
            $wget = "wget" ascii
            $curl = "curl" ascii
          condition:
            $proc_exe and (any of ($send*) or any of ($tftp, $wget, $curl))
        }

  - id: curl-http-download
    desc: "Curl HTTP payload download"
    crit: suspicious
    conf: 0.9
    attack: "T1105"
    for: [elf]
    platforms: [linux]
    if:
      type: string
      exact: "curl http://"

composite_rules:
  - id: mirai-variant
    desc: "Mirai-like IoT botnet (credential brute-force + shell dropper)"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1110.001"
    for: [elf]
    platforms: [linux]
    count: 2
    any:
      - id: lateral/brute-force/iot-creds/mirai-cred-admin
      - id: busybox
      - id: pipe-to-shell

  - id: multi-protocol
    desc: "Multi-protocol payload dropper (wget/tftp/ftpget/curl)"
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1105"
    for: [elf]
    platforms: [linux]
    count: 2
    any:
      - id: busybox-wget
      - id: busybox-tftp
      - id: busybox-ftpget
      - id: curl-http-download
