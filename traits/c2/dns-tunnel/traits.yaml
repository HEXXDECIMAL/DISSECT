# DNS Tunneling Detection
# MBC: C0001 (Command and Control)
# ATT&CK: T1071.004 (Application Layer Protocol: DNS)

defaults:
  mbc: "C0001"
  attack: "T1071.004"

traits:
  # === dnscat2 atomic indicators ===
  - id: dnscat-secret
    description: dnscat2 secret environment variable
    criticality: inert
    confidence: 0.9
    condition:
      type: string
      exact: DNSCAT_SECRET

  - id: dnscat-name
    description: dnscat2 tool name reference
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: dnscat
      case_insensitive: true

  - id: dnscat-session
    description: dnscat2 session state constant
    criticality: inert
    confidence: 0.9
    condition:
      type: string
      exact: SESSION_STATE_ESTABLISHED

  - id: dnscat-packet
    description: dnscat2 packet debug message
    criticality: inert
    confidence: 0.8
    condition:
      type: string
      exact: "MSG packet"

  # === iodine atomic indicators ===
  - id: iodine-name
    description: iodine tool name reference
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      exact: iodine

  - id: tun-device
    description: TUN device access for tunneling
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      exact: /dev/net/tun

  - id: dns-tunnel-phrase
    description: DNS tunnel terminology
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      exact: "dns tunnel"
      case_insensitive: true

  # === Generic DNS tunnel indicators ===
  - id: dns-exfil
    description: DNS exfiltration terminology
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      exact: "dns exfil"
      case_insensitive: true

  - id: dns-c2
    description: DNS C2 terminology
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      exact: "dns c2"
      case_insensitive: true

  - id: subdomain-encode
    description: Long subdomain encoding pattern
    criticality: suspicious
    confidence: 0.75
    condition:
      type: string
      regex: '[a-z0-9]{30,}\.[a-z]+\.(com|net|org|io)'

  - id: txt-record
    description: TXT record reference (DNS exfil)
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "TXT record"

  - id: dns-beacon
    description: DNS beacon terminology
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      exact: "dns beacon"
      case_insensitive: true

  # === DoH C2 indicators ===
  - id: doh-cloudflare
    description: Cloudflare DoH endpoint
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: cloudflare-dns.com/dns-query

  - id: doh-google
    description: Google DoH endpoint
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: dns.google/dns-query

  - id: doh-quad9
    description: Quad9 DoH endpoint
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: dns.quad9.net/dns-query

  - id: doh-content-type
    description: DoH content type header
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      exact: application/dns-message

  - id: doh-json-content
    description: DoH JSON content type
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      exact: application/dns-json

composite_rules:
  # dnscat2 protocol
  - id: dnscat
    description: dnscat2 DNS tunneling tool
    criticality: suspicious
    confidence: 0.95
    requires_count: 1
    conditions:
      - id: dnscat-secret
      - id: dnscat-name
      - id: dnscat-session
      - id: dnscat-packet

  # iodine DNS tunnel
  - id: iodine
    description: iodine DNS tunneling tool
    criticality: suspicious
    confidence: 0.95
    requires_any:
      - id: dns-tunnel-phrase
    requires_all:
      - id: iodine-name
      - id: tun-device

  # Generic DNS tunnel patterns
  - id: generic
    description: Generic DNS tunneling patterns
    criticality: suspicious
    confidence: 0.8
    requires_count: 1
    conditions:
      - id: dns-exfil
      - id: dns-c2
      - id: subdomain-encode
      - id: txt-record
      - id: dns-beacon

  # DNS over HTTPS for C2
  - id: doh-c2
    description: DNS over HTTPS potential C2 channel
    criticality: suspicious
    confidence: 0.75
    requires_count: 1
    conditions:
      - id: doh-cloudflare
      - id: doh-google
      - id: doh-quad9
      - id: doh-content-type
      - id: doh-json-content
