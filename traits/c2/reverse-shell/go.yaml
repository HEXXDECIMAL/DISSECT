# Reverse Shell Detection - Go
# MBC: B0033 (Adversary-in-the-Middle)
# ATT&CK: T1059

defaults:
  for: [go, elf, macho, pe]

traits:
  # === Go exec micro-traits ===
  - id: os-exec-command
    desc: os/exec.Command reference
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "os/exec.Command"

  - id: exec-cmd-start
    desc: exec.(*Cmd).Start reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "exec.(*Cmd).Start"

  - id: exec-cmd-run
    desc: exec.(*Cmd).Run reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "exec.(*Cmd).Run"

  # === Go pipe micro-traits ===
  - id: stdin-pipe
    desc: StdinPipe reference
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "StdinPipe"

  - id: stdout-pipe
    desc: StdoutPipe reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "StdoutPipe"

  - id: stderr-pipe
    desc: StderrPipe reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "StderrPipe"

  # === Shell path micro-traits ===
  - id: cmd-exe
    desc: cmd.exe shell reference
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "cmd.exe"

composite_rules:
  # Go connection composite
  - id: go-net-connection
    desc: Go network connection
    crit: notable
    conf: 0.6
    count_min: 1
    any:
      - id: comm/socket/dial
      - id: comm/socket/dial-tcp
      - id: comm/socket/dialer-dial

  # Go exec composite
  - id: go-exec
    desc: Go command execution
    crit: notable
    conf: 0.6
    count_min: 1
    any:
      - id: os-exec-command
      - id: exec-cmd-start
      - id: exec-cmd-run

  # Go pipe composite
  - id: go-pipe
    desc: Go pipe redirection
    crit: notable
    conf: 0.5
    count_min: 1
    any:
      - id: stdin-pipe
      - id: stdout-pipe
      - id: stderr-pipe

  # Shell composite
  - id: shell-path
    desc: Shell path reference
    crit: notable
    conf: 0.5
    count_min: 1
    any:
      - id: exec/command/shell/generic/bin-sh
      - id: exec/command/shell/generic/bin-bash
      - id: cmd-exe

  # Go reverse shell (migrated from YARA)
  - id: reverse-shell
    desc: Go reverse shell implementation patterns
    crit: suspicious
    conf: 0.85
    mbc: "B0033"
    attack: "T1059"
    all:
      - id: go-net-connection
      - id: go-exec
    any:
      - id: go-pipe
      - id: shell-path
