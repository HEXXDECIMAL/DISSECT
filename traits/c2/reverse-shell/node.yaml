# Node.js Reverse Shell Traits
# Detects reverse shell and remote command execution patterns
# MBC: B0032 (Remote Access)
# ATT&CK: T1059 (Command Interpreter), T1095 (Non-Application Layer Protocol)

traits:
  - id: node
    desc: Node.js reverse shell pattern (net + child_process)
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule node_reverse_shell {
          strings:
            $net = "net.Socket"
            $cp = "child_process"
            $spawn = "spawn"
            $exec = "exec"
            $pipe = "pipe"
          condition:
            $net and $cp and ($spawn or $exec) and $pipe
        }

  # === Net socket atomic indicators ===
  - id: new-net-socket
    desc: new net.Socket creation
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "new net.Socket"

  - id: net-createConnection
    desc: net.createConnection call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "net.createConnection"

  - id: net-connect
    desc: net.connect call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "net.connect"

  - id: socket-with-exec
    desc: Socket combined with command execution (reverse shell indicator)
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule socket_exec_combo {
          strings:
            $socket1 = "net.Socket"
            $socket2 = "net.connect"
            $socket3 = "createConnection"
            $exec1 = ".exec("
            $exec2 = ".spawn("
            $exec3 = "execSync"
          condition:
            any of ($socket*) and any of ($exec*)
        }

  # === Ngrok atomic indicators ===
  - id: ngrok-io
    desc: ngrok.io domain
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "ngrok.io"

  - id: ngrok-com
    desc: ngrok.com domain
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "ngrok.com"

  - id: tcp-ngrok
    desc: tcp.ngrok endpoint
    crit: inert
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "tcp.ngrok"

  # === Tunnel service atomic indicators ===
  - id: serveo-net
    desc: serveo.net tunnel service
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "serveo.net"

  - id: localtunnel-me
    desc: localtunnel.me tunnel service
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "localtunnel.me"

  - id: localhost-run
    desc: localhost.run tunnel service
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "localhost.run"

  - id: pinggy-io
    desc: pinggy.io tunnel service
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "pinggy.io"

  # Lock File Pattern (single instance)
  - id: lock-file
    desc: Lock file for single instance (RAT pattern)
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule rat_lock_file {
          strings:
            $lock1 = ".lock"
            $lock2 = "lockfile"
            $exists = "existsSync"
            $write = "writeFileSync"
          condition:
            any of ($lock*) and $exists and $write
        }

  # Socket Data Event with Exec
  # NOTE: Requires net.Socket context to avoid FPs from HTTP response streaming
  # HTTP responses also use .on('data') but are not reverse shells
  - id: data-event-exec
    desc: Socket data event with command execution
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1059"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule socket_data_exec {
          strings:
            // Socket creation (required for reverse shell)
            $socket1 = "net.Socket" ascii
            $socket2 = "net.connect" ascii
            $socket3 = "net.createConnection" ascii
            $socket4 = "new Socket(" ascii
            // Data event handler
            $event1 = ".on('data'" ascii
            $event2 = ".on(\"data\"" ascii
            // Command execution
            $exec1 = "exec(" ascii
            $exec2 = "spawn(" ascii
            $exec3 = "execSync(" ascii
            $exec4 = "spawnSync(" ascii
            // Exclude HTTP response patterns (not reverse shells)
            $http_res1 = "res.on('data'" ascii
            $http_res2 = "response.on('data'" ascii
            $http_res3 = "https.get" ascii
            $http_res4 = "http.get" ascii
          condition:
            any of ($socket*) and any of ($event*) and any of ($exec*) and none of ($http_res*)
        }

composite_rules:
  - id: net-socket
    desc: Net socket creation (potential reverse shell)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    count: 1
    any:
      - id: new-net-socket
      - id: net-createConnection
      - id: net-connect

  - id: ngrok-tunnel
    desc: Ngrok tunnel endpoint (C2 tunneling)
    crit: malicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1572"
    for: [javascript, typescript]
    count: 1
    any:
      - id: ngrok-io
      - id: ngrok-com
      - id: tcp-ngrok

  - id: tunnel-service
    desc: Tunneling service endpoint
    crit: suspicious
    conf: 0.85
    attack: "T1572"
    for: [javascript, typescript]
    count: 1
    any:
      - id: serveo-net
      - id: localtunnel-me
      - id: localhost-run
      - id: pinggy-io
