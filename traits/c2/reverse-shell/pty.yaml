# PTY-based Reverse Shell Patterns
# ATT&CK: T1059 (Command and Scripting Interpreter)
# Detects interactive shell spawning via PTY

traits:
  # Python PTY spawn
  - id: python-pty
    desc: Python PTY spawn reverse shell
    crit: suspicious
    conf: 0.95
    attack: "T1059.006"
    for: [python]
    if:
      type: yara
      source: |
        rule python_pty_shell {
          strings:
            $pty1 = "pty.spawn" ascii
            $pty2 = "import pty" ascii
            $shell1 = "/bin/sh" ascii
            $shell2 = "/bin/bash" ascii
            $socket = "socket" ascii
          condition:
            any of ($pty*) and (any of ($shell*) or $socket)
        }

  # Python socket + subprocess shell
  - id: python-socket-shell
    desc: Python socket-based reverse shell
    crit: suspicious
    conf: 0.95
    attack: "T1059.006"
    for: [python]
    if:
      type: yara
      source: |
        rule python_socket_shell {
          strings:
            $sock1 = "socket.socket" ascii
            $sock2 = ".connect(" ascii
            $sub1 = "subprocess" ascii
            $pipe1 = "stdin=" ascii
            $pipe2 = "stdout=" ascii
            $pipe3 = "stderr=" ascii
          condition:
            $sock1 and $sock2 and $sub1 and any of ($pipe*)
        }

  # Node.js PTY reverse shell
  - id: node-pty
    desc: Node.js PTY-based reverse shell
    crit: suspicious
    conf: 0.95
    attack: "T1059.007"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule node_pty_shell {
          strings:
            $pty1 = "node-pty" ascii
            $pty2 = "pty.spawn" ascii
            $pty3 = "require('pty.js')" ascii
            $socket1 = "net.Socket" ascii
            $socket2 = "socket.connect" ascii
            $ws = "WebSocket" ascii
          condition:
            any of ($pty*) and any of ($socket*, $ws)
        }

  # Stdin/stdout socket piping
  - id: stdio-socket
    desc: Stdin/stdout piped to socket (reverse shell)
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    for: [python, javascript, typescript]
    if:
      type: yara
      source: |
        rule stdio_socket_pipe {
          strings:
            $stdin = "stdin" ascii
            $stdout = "stdout" ascii
            $stderr = "stderr" ascii
            $pipe1 = ".pipe(" ascii
            $pipe2 = "PIPE" ascii
            $sock1 = "socket" ascii
            $sock2 = "connect" ascii
          condition:
            2 of ($stdin, $stdout, $stderr) and any of ($pipe*) and any of ($sock*)
        }

  # Interactive shell markers
  - id: interactive-markers
    desc: Interactive shell session markers
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    for: [python, javascript, shell]
    if:
      type: yara
      source: |
        rule interactive_shell {
          strings:
            $tty1 = "isatty" ascii
            $tty2 = "ttyname" ascii
            $tty3 = "/dev/tty" ascii
            $term1 = "TERM=" ascii
            $term2 = "xterm" ascii
            $stty = "stty" ascii
            $raw = "raw" ascii
          condition:
            2 of them
        }

  # === Socat atomic indicators ===
  - id: socat-exec-sh
    desc: socat EXEC shell pattern
    crit: inert
    conf: 0.8
    for: [shell, packagejson]
    if:
      type: string
      regex: 'socat\s+.*EXEC.*sh'

  - id: socat-tcp-exec
    desc: socat TCP EXEC pattern
    crit: inert
    conf: 0.8
    for: [shell, packagejson]
    if:
      type: string
      regex: 'socat\s+.*TCP.*EXEC'

  - id: socat-pty
    desc: socat PTY pattern
    crit: inert
    conf: 0.8
    for: [shell, packagejson]
    if:
      type: string
      regex: 'socat\s+.*PTY'

  # === Telnet atomic indicators ===
  - id: telnet-pipe
    desc: telnet piped reverse shell pattern
    crit: inert
    conf: 0.8
    for: [shell, packagejson]
    if:
      type: string
      regex: 'telnet\s+\S+\s+\d+\s*\|.*\|\s*telnet'

  - id: mknod-telnet
    desc: mknod telnet reverse shell pattern
    crit: inert
    conf: 0.8
    for: [shell, packagejson]
    if:
      type: string
      regex: "mknod.*telnet"

composite_rules:
  - id: socat
    desc: Socat reverse shell pattern
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    for: [shell, packagejson]
    count: 1
    any:
      - id: socat-exec-sh
      - id: socat-tcp-exec
      - id: socat-pty

  - id: telnet
    desc: Telnet-based reverse shell
    crit: suspicious
    conf: 0.9
    attack: "T1059.004"
    for: [shell, packagejson]
    count: 1
    any:
      - id: telnet-pipe
      - id: mknod-telnet
