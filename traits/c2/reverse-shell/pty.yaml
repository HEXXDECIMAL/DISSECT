# PTY-based Reverse Shell Patterns
# ATT&CK: T1059 (Command and Scripting Interpreter)
# Detects interactive shell spawning via PTY

traits:
  # Python PTY spawn
  - id: python-pty
    description: Python PTY spawn reverse shell
    criticality: suspicious
    confidence: 0.95
    attack: "T1059.006"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule python_pty_shell {
          strings:
            $pty1 = "pty.spawn" ascii
            $pty2 = "import pty" ascii
            $shell1 = "/bin/sh" ascii
            $shell2 = "/bin/bash" ascii
            $socket = "socket" ascii
          condition:
            any of ($pty*) and (any of ($shell*) or $socket)
        }

  # Python socket + subprocess shell
  - id: python-socket-shell
    description: Python socket-based reverse shell
    criticality: suspicious
    confidence: 0.95
    attack: "T1059.006"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule python_socket_shell {
          strings:
            $sock1 = "socket.socket" ascii
            $sock2 = ".connect(" ascii
            $sub1 = "subprocess" ascii
            $pipe1 = "stdin=" ascii
            $pipe2 = "stdout=" ascii
            $pipe3 = "stderr=" ascii
          condition:
            $sock1 and $sock2 and $sub1 and any of ($pipe*)
        }

  # Node.js PTY reverse shell
  - id: node-pty
    description: Node.js PTY-based reverse shell
    criticality: suspicious
    confidence: 0.95
    attack: "T1059.007"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule node_pty_shell {
          strings:
            $pty1 = "node-pty" ascii
            $pty2 = "pty.spawn" ascii
            $pty3 = "require('pty.js')" ascii
            $socket1 = "net.Socket" ascii
            $socket2 = "socket.connect" ascii
            $ws = "WebSocket" ascii
          condition:
            any of ($pty*) and any of ($socket*, $ws)
        }

  # Stdin/stdout socket piping
  - id: stdio-socket
    description: Stdin/stdout piped to socket (reverse shell)
    criticality: suspicious
    confidence: 0.9
    attack: "T1059"
    file_types: [python, javascript, typescript]
    condition:
      type: yara
      source: |
        rule stdio_socket_pipe {
          strings:
            $stdin = "stdin" ascii
            $stdout = "stdout" ascii
            $stderr = "stderr" ascii
            $pipe1 = ".pipe(" ascii
            $pipe2 = "PIPE" ascii
            $sock1 = "socket" ascii
            $sock2 = "connect" ascii
          condition:
            2 of ($stdin, $stdout, $stderr) and any of ($pipe*) and any of ($sock*)
        }

  # Interactive shell markers
  - id: interactive-markers
    description: Interactive shell session markers
    criticality: suspicious
    confidence: 0.85
    attack: "T1059"
    file_types: [python, javascript, shell]
    condition:
      type: yara
      source: |
        rule interactive_shell {
          strings:
            $tty1 = "isatty" ascii
            $tty2 = "ttyname" ascii
            $tty3 = "/dev/tty" ascii
            $term1 = "TERM=" ascii
            $term2 = "xterm" ascii
            $stty = "stty" ascii
            $raw = "raw" ascii
          condition:
            2 of them
        }

  # Socat reverse shell
  - id: socat
    description: Socat reverse shell pattern
    criticality: suspicious
    confidence: 0.95
    attack: "T1059.004"
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: 'socat\s+.*EXEC.*sh|socat\s+.*TCP.*EXEC|socat\s+.*PTY'

  # Telnet reverse shell
  - id: telnet
    description: Telnet-based reverse shell
    criticality: suspicious
    confidence: 0.9
    attack: "T1059.004"
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: 'telnet\s+\S+\s+\d+\s*\|.*\|\s*telnet|mknod.*telnet'

