# Reverse Shell Detection - Shell/Bash
# MBC: B0033 (Adversary-in-the-Middle)
# ATT&CK: T1059.004 (Unix Shell)
# NOTE: stdin-redirect (0>&1) is defined in c2/backdoor/traits.yaml

defaults:
  attack: "T1059.004"

traits:
  # Complete bash reverse shell pattern (no legitimate use)
  - id: reverse-shell-bash-complete
    description: Bash reverse shell via /dev/tcp (complete pattern)
    criticality: suspicious
    confidence: 0.98
    file_types: [shell, packagejson, javascript]
    condition:
      type: string
      regex: "bash\\s+-i\\s+>&\\s*/dev/tcp/[0-9.]+/[0-9]+\\s+0>&1"

  - id: reverse-shell-bash
    description: Bash reverse shell via /dev/tcp
    criticality: suspicious
    confidence: 0.95
    file_types: [shell, packagejson, javascript]
    condition:
      type: string
      regex: "bash\\s+-i\\s+>&\\s*/dev/tcp/"

  # === mkfifo netcat atomic indicators ===
  - id: mkfifo-cmd
    description: mkfifo command for named pipe
    criticality: inert
    confidence: 0.5
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: '\bmkfifo\b'

  - id: sh-interactive
    description: Interactive shell invocation
    criticality: inert
    confidence: 0.5
    file_types: [shell, packagejson]
    condition:
      type: string
      exact: "sh -i"

  - id: nc-pipe
    description: Netcat with pipe
    criticality: inert
    confidence: 0.5
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: '\| {0,2}nc '

  # Python reverse shell
  - id: reverse-shell-python
    description: Python reverse shell pattern
    criticality: suspicious
    confidence: 0.95
    attack: "T1059.006"
    file_types: [shell, packagejson, python]
    condition:
      type: string
      regex: "python[23]?\\s+-c\\s+['\"]import socket.*subprocess.*connect"

  # Perl reverse shell
  - id: reverse-shell-perl
    description: Perl reverse shell pattern
    criticality: suspicious
    confidence: 0.95
    attack: "T1059"
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: "perl\\s+-e\\s+['\"].*socket.*connect.*exec"

  # === Netcat reverse shell atomic indicators ===
  - id: nc-exec-sh
    description: nc -e /bin/sh pattern
    criticality: suspicious
    confidence: 0.9
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: 'nc\s+-e\s+/bin/(ba)?sh'

  - id: ncat-exec-sh
    description: ncat -e /bin/sh pattern
    criticality: suspicious
    confidence: 0.9
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: 'ncat\s+-e\s+/bin/(ba)?sh'

  - id: netcat-exec-sh
    description: netcat -e /bin/sh pattern
    criticality: suspicious
    confidence: 0.9
    file_types: [shell, packagejson]
    condition:
      type: string
      regex: 'netcat\s+-e\s+/bin/(ba)?sh'

  # Ruby reverse shell
  - id: reverse-shell-ruby
    description: Ruby reverse shell pattern
    criticality: suspicious
    confidence: 0.95
    attack: "T1059"
    file_types: [shell, packagejson, ruby]
    condition:
      type: string
      regex: "ruby\\s+-rsocket\\s+-e|TCPSocket\\.open.*exec"

  # PHP reverse shell
  - id: reverse-shell-php
    description: PHP reverse shell pattern
    criticality: suspicious
    confidence: 0.95
    attack: "T1059"
    file_types: [shell, packagejson, php]
    condition:
      type: string
      regex: "php\\s+-r\\s+['\"].*fsockopen.*shell_exec|\\$sock\\s*=\\s*fsockopen"

composite_rules:
  # mkfifo + netcat reverse shell (all of them + small file)
  - id: reverse-shell-mkfifo
    description: Reverse shell using mkfifo and netcat
    criticality: suspicious
    confidence: 0.95
    file_types: [shell, packagejson]
    requires_all:
      - id: mkfifo-cmd
      - id: sh-interactive
      - id: nc-pipe

  # Netcat reverse shell variants
  - id: reverse-shell-netcat
    description: Netcat reverse shell pattern
    criticality: suspicious
    confidence: 0.9
    file_types: [shell, packagejson]
    requires_count: 1
    conditions:
      - id: nc-exec-sh
      - id: ncat-exec-sh
      - id: netcat-exec-sh
