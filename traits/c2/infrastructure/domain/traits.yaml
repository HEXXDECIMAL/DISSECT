# C2 Infrastructure Detection - Domains
# Detects hardcoded domain names and suspicious TLDs
# ATT&CK: T1071.001

defaults:
  file_types: [elf, macho, pe]
  mbc: "C0002"
  attack: "T1071.001"

composite_rules:
  - id: hardcoded-domain-com
    description: "Hardcoded .com domain"
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule hardcoded_domain_com {
          meta:
            description = "Detects hardcoded .com/.org/.net domains excluding known legitimate vendors"
          strings:
            // Generic domain pattern
            $domain = /\b[a-zA-Z0-9][-a-zA-Z0-9]{0,62}\.(com|org|net)\b/
            // Known legitimate OS vendor / major software domains (excludes)
            $legit_apple = "apple.com" ascii nocase
            $legit_microsoft = "microsoft.com" ascii nocase
            $legit_windows = "windows.com" ascii nocase
            $legit_google = "google.com" ascii nocase
            $legit_android = "android.com" ascii nocase
            $legit_mozilla = "mozilla.org" ascii nocase
            $legit_gnu = "gnu.org" ascii nocase
            $legit_kernel = "kernel.org" ascii nocase
            $legit_debian = "debian.org" ascii nocase
            $legit_ubuntu = "ubuntu.com" ascii nocase
            $legit_redhat = "redhat.com" ascii nocase
            $legit_fedora = "fedoraproject.org" ascii nocase
            $legit_github = "github.com" ascii nocase
            $legit_gitlab = "gitlab.com" ascii nocase
            $legit_sourceforge = "sourceforge.net" ascii nocase
            $legit_python = "python.org" ascii nocase
            $legit_pypi = "pypi.org" ascii nocase
            $legit_npmjs = "npmjs.com" ascii nocase
            $legit_npmjs_org = "npmjs.org" ascii nocase
            $legit_rubygems = "rubygems.org" ascii nocase
            $legit_rust = "rust-lang.org" ascii nocase
            $legit_golang = "golang.org" ascii nocase
            $legit_cloudflare = "cloudflare.com" ascii nocase
            $legit_amazon = "amazon.com" ascii nocase
            $legit_aws = "amazonaws.com" ascii nocase
            $legit_icloud = "icloud.com" ascii nocase
            $legit_docker = "docker.com" ascii nocase
            $legit_openssl = "openssl.org" ascii nocase
            $legit_curl = "curl.se" ascii nocase
            $legit_ezgif = "ezgif.com" ascii nocase
          condition:
            $domain and not any of ($legit*)
        }

  - id: hardcoded-domain-suspicious
    description: "Hardcoded suspicious TLD domain (.ru, .cn, .xyz, .top, .pro)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      # Require subdomain or URL context to avoid matching Apple framework names
      regex: "\\b[a-zA-Z0-9][-a-zA-Z0-9]{0,62}\\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62}\\.(ru|cn|xyz|top|cc|ws|tk|ml|ga|cf|gq|pw|biz|club|date|download|racing|win|party|review|accountant|science|trade|webcam|bid|loan|pro)\\b|https?://[a-zA-Z0-9][-a-zA-Z0-9]*\\.(ru|cn|xyz|top|cc|ws|tk|ml|ga|cf|gq|pw|biz|club|work|date|stream|download|racing|pro)"

  - id: dynamic-dns-domain
    description: "Dynamic DNS domain (common C2 infrastructure)"
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      regex: "\\b[a-zA-Z0-9][-a-zA-Z0-9]*\\.(duckdns|no-ip|dynu|freedns|afraid|hopto|zapto|sytes|ddns|servebeer|servehttp|serveftp|servegame|servequake|redirectme|bounceme|myftp|myvnc)\\.[a-z]{2,6}\\b"

  - id: http-url-with-domain
    description: "Network URL with domain name"
    criticality: notable
    confidence: 0.7
    file_types: [all]
    condition:
      type: string
      regex: "(?:https?|wss?)://[a-zA-Z0-9][-a-zA-Z0-9]*\\.[a-zA-Z]{2,6}(?:/|$|:)"
      exclude_patterns:
        # Documentation/standards
        - "ezgif\\.com"
        - "w3\\.org"
        - "schemas\\.microsoft\\.com"
        - "www\\.google\\.com"
        - "googleapis\\.com"
        - "mdn\\.io"
        - "developer\\.mozilla\\.org"
        - "docs\\.github\\.com"
        - "nodejs\\.org"
        - "npmjs\\.com"
        - "npmjs\\.org"
        # CI/CD services
        - "travis-ci\\.org"
        - "travis-ci\\.com"
        - "circleci\\.com"
        - "github\\.com"
        - "gitlab\\.com"
        - "bitbucket\\.org"
        - "codecov\\.io"
        - "coveralls\\.io"
        - "snyk\\.io"
        # Package registries
        - "registry\\.npmjs\\.org"
        - "yarnpkg\\.com"
        - "unpkg\\.com"
        - "jsdelivr\\.net"
        - "cdnjs\\.cloudflare\\.com"
        # Major vendors
        - "apple\\.com"
        - "microsoft\\.com"
        - "amazon\\.com"
        - "aws\\.amazon\\.com"

  - id: url-path-payload
    description: "URL path suggesting payload download"
    criticality: suspicious
    confidence: 0.8
    attack: "T1105"  # Override: Ingress Tool Transfer
    condition:
      type: string
      regex: "(?:GET|POST|PUT)\\s+/[a-zA-Z0-9_./-]*\\.(bin|exe|sh|elf|dll|so|dat|payload|bot|drop)"

  - id: c2-domain
    description: "Likely C2 domain (suspicious TLD or dynamic DNS)"
    criticality: suspicious
    confidence: 0.85
    requires_any:
      - type: trait
        id: hardcoded-domain-suspicious
      - type: trait
        id: dynamic-dns-domain

traits:
  # Malicious file hosting domains
  - id: malware-hosting
    description: Contacts known malware/payload hosting service
    criticality: hostile
    confidence: 0.95
    attack: "T1105"
    file_types: [all]
    condition:
      type: string
      regex: '(bullethost\.cloud|anonfiles\.com|gofile\.io|transfer\.sh|tmpfiles\.org|catbox\.moe|uguu\.se|pomf\.cat|0x0\.st|file\.io|filedropper\.com)'

  # Cloud storage abuse for payload hosting
  - id: appwrite-storage
    description: Appwrite cloud storage (commonly abused for malware payloads)
    criticality: suspicious
    confidence: 0.85
    attack: "T1105"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.cloud\.appwrite\.io/v[0-9]+/storage/buckets/[a-z0-9]+/files/'

  - id: supabase-storage
    description: Supabase storage endpoint (can be abused for payloads)
    criticality: notable
    confidence: 0.75
    attack: "T1105"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9]+\.supabase\.co/storage/v[0-9]+/'

  - id: firebase-storage
    description: Firebase storage endpoint (can be abused for payloads)
    criticality: notable
    confidence: 0.7
    attack: "T1105"
    file_types: [all]
    condition:
      type: string
      regex: 'firebasestorage\.googleapis\.com/v[0-9]+/b/[^/]+/o/'

  # PHP collector scripts (common exfil pattern)
  - id: php-collector
    description: Contacts PHP data collection endpoint
    criticality: suspicious
    confidence: 0.85
    attack: "T1041"
    file_types: [all]
    condition:
      type: string
      regex: '/collect[_-]?(info|data|stats)?\.php|/log[_-]?(info|data)?\.php|/report\.php|/beacon\.php|/gate\.php'

  # Internal API probing
  - id: internal-api-probe
    description: Probes internal network API endpoints
    criticality: suspicious
    confidence: 0.9
    attack: "T1046"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: 'http://(internal|localhost|127\\.0\\.0\\.1|10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[01]))[-a-zA-Z0-9.]*/(api|ping|health|status)'

  # Hardcoded IP addresses
  - id: hardcoded-ip
    description: Hardcoded IP address (potential C2)
    criticality: suspicious
    confidence: 0.85
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: 'https?://\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}[:/]'

  # Serverless function URLs (common C2 vector)
  - id: serverless-function
    description: Contacts serverless function endpoint (Lambda, Azure, etc.)
    criticality: notable
    confidence: 0.7
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '(execute-api\.[a-z0-9-]+\.amazonaws\.com|[a-z0-9-]+\.azurewebsites\.net|[a-z0-9-]+\.cloudfunctions\.net|[a-z0-9-]+\.vercel\.app|[a-z0-9-]+\.netlify\.app)'

  # Ngrok tunnels
  - id: ngrok-tunnel
    description: Contacts ngrok tunnel endpoint
    criticality: suspicious
    confidence: 0.9
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9]+\.ngrok\.io|[a-z0-9]+\.ngrok-free\.app'

  # Pastebin-like services
  - id: paste-service
    description: Contacts paste/bin service (common payload host)
    criticality: suspicious
    confidence: 0.85
    attack: "T1102"
    file_types: [all]
    condition:
      type: string
      regex: '(pastebin\.com|hastebin\.com|ghostbin\.com|paste\.ee|dpaste\.com|privatebin\.net|rentry\.co)/[a-zA-Z0-9]+'

  # Vercel serverless C2 (elevated - commonly abused)
  - id: vercel-serverless
    description: Contacts Vercel serverless function (commonly abused for C2)
    criticality: suspicious
    confidence: 0.85
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.vercel\.app(?:/|$)'

  # Replit-hosted C2
  - id: replit-hosted
    description: Contacts Replit-hosted endpoint (commonly abused)
    criticality: suspicious
    confidence: 0.85
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.replit\.dev|[a-z0-9-]+\.repl\.co'

  # Glitch-hosted C2
  - id: glitch-hosted
    description: Contacts Glitch-hosted endpoint
    criticality: suspicious
    confidence: 0.8
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.glitch\.me'

  # Railway-hosted C2
  - id: railway-hosted
    description: Contacts Railway-hosted endpoint
    criticality: notable
    confidence: 0.75
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.railway\.app'

  # Render-hosted C2
  - id: render-hosted
    description: Contacts Render-hosted endpoint
    criticality: notable
    confidence: 0.75
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.onrender\.com'

  # Heroku-hosted C2
  - id: heroku-hosted
    description: Contacts Heroku-hosted endpoint
    criticality: notable
    confidence: 0.7
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.herokuapp\.com'

  # Serveo SSH tunnel
  - id: serveo-tunnel
    description: Serveo SSH tunnel endpoint (reverse shell infrastructure)
    criticality: hostile
    confidence: 0.95
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: 'serveo\.net'

  # Localtunnel
  - id: localtunnel
    description: Localtunnel endpoint (reverse shell infrastructure)
    criticality: suspicious
    confidence: 0.85
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.loca\.lt'

  # Localhost.run tunnel
  - id: localhost-run
    description: Localhost.run tunnel endpoint
    criticality: suspicious
    confidence: 0.85
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.localhost\.run'

  # Cloudflare tunnel
  - id: cloudflare-tunnel
    description: Cloudflare tunnel endpoint
    criticality: notable
    confidence: 0.7
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: '[a-z0-9-]+\.trycloudflare\.com'

  # Chisel tunnel binary
  - id: chisel-tunnel
    description: Chisel reverse tunnel infrastructure
    criticality: hostile
    confidence: 0.95
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: 'chisel\\s+(client|server)|jpillora/chisel'
