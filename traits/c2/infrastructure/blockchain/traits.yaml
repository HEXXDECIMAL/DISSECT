# Blockchain-Based C2 Infrastructure
# ATT&CK: T1102 (Web Service)
# Uses blockchain/smart contract storage for C2 URL retrieval

traits:
  # === Etherscan atomic indicators ===
  - id: etherscan-api-prefix
    desc: Etherscan API endpoint (api.etherscan.io)
    crit: notable
    conf: 0.8
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      exact: "api.etherscan.io"

  - id: etherscan-api-suffix
    desc: Etherscan API path (etherscan.io/api)
    crit: notable
    conf: 0.8
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      exact: "etherscan.io/api"

  # BSCScan API (Binance Smart Chain)
  - id: bscscan-api
    desc: Uses BSCScan API (potential blockchain-based C2)
    crit: suspicious
    conf: 0.85
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      regex: "api\\.bscscan\\.com|bscscan\\.com/api"

  # PolygonScan API
  - id: polygonscan-api
    desc: Uses PolygonScan API (potential blockchain-based C2)
    crit: suspicious
    conf: 0.85
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      regex: "api\\.polygonscan\\.com|polygonscan\\.com/api"

  # Generic blockchain explorer with contract read
  - id: contract-read
    desc: Reads smart contract storage (potential C2 retrieval)
    crit: notable
    conf: 0.75
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule contract_storage_read {
          strings:
            $eth_call = "eth_call" ascii
            $eth_storage = "eth_getStorageAt" ascii
            $contract = "contract" ascii nocase
            $address = /0x[a-fA-F0-9]{40}/ ascii
          condition:
            any of ($eth_call, $eth_storage) and ($contract or $address)
        }

  # Infura/Alchemy RPC with suspicious patterns
  - id: rpc-provider
    desc: Uses blockchain RPC provider (monitor for C2 abuse)
    crit: notable
    conf: 0.6
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      regex: "infura\\.io/v3/|alchemy\\.com/v2/|quicknode\\.com|ankr\\.com"

  # IPFS gateway (decentralized payload hosting)
  - id: ipfs-gateway
    desc: Uses IPFS gateway (decentralized content retrieval)
    crit: notable
    conf: 0.7
    attack: "T1102"
    for: [javascript, typescript, shell]
    if:
      type: string
      regex: "ipfs\\.io/ipfs/|gateway\\.pinata\\.cloud|cloudflare-ipfs\\.com|dweb\\.link"

  # === Arweave atomic indicators ===
  - id: arweave-net
    desc: Arweave.net gateway
    crit: inert
    conf: 0.6
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      exact: "arweave.net/"

  - id: ar-io-net
    desc: AR-IO.net gateway
    crit: inert
    conf: 0.6
    attack: "T1102"
    for: [javascript, typescript]
    if:
      type: string
      exact: "ar-io.net/"

composite_rules:
  # Etherscan API composite
  - id: etherscan-api
    desc: Uses Etherscan API (potential blockchain-based C2)
    crit: suspicious
    conf: 0.85
    attack: "T1102"
    for: [javascript, typescript]
    count: 1
    any:
      - id: etherscan-api-prefix
      - id: etherscan-api-suffix

  # Arweave gateway composite
  - id: arweave-gateway
    desc: Uses Arweave gateway (permanent content retrieval)
    crit: notable
    conf: 0.7
    attack: "T1102"
    for: [javascript, typescript]
    count: 1
    any:
      - id: arweave-net
      - id: ar-io-net
