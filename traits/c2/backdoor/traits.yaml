# Impact - Remote Access / Reverse Shells
# ATT&CK: T1059 (Command and Scripting Interpreter)
# MBC: B0022 (Remote Access)
# NOTE: Shell path traits (bin-sh, bin-bash) are defined in exec/command/shell/generic.yaml

traits:
  # === Atomic: Reverse Shell Indicators ===

  - id: reverse-shell-ref
    desc: Reverse shell terminology reference
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    platforms: [all]
    if:
      type: string
      regex: "reverse[_\\s]?shell|revshell|r[e3]v[e3]rs[e3][_\\s]*sh[e3]ll"
      case_insensitive: true

  - id: webshell-ref
    desc: Web shell terminology reference
    crit: suspicious
    conf: 0.9
    attack: "T1505.003"
    platforms: [all]
    if:
      type: string
      regex: "w[3e]b[_\\s]*sh[e3]ll"
      case_insensitive: true

  - id: backdoor-ref
    desc: Backdoor terminology reference
    crit: suspicious
    conf: 0.75
    attack: "T1059"
    platforms: [all]
    if:
      type: string
      regex: "\\b[Bb]ackdoor\\b"

  # === Atomic: Bash Reverse Shell ===

  - id: bash-dev-tcp
    desc: Bash /dev/tcp reverse shell
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "bash\\s+-i\\s+>&\\s*/dev/tcp/"

  - id: stdin-redirect
    desc: Stdin redirection (reverse shell indicator)
    crit: suspicious
    conf: 0.7
    attack: "T1059"
    platforms: [all]
    if:
      type: string
      exact: "0>&1"

  # === Atomic: mkfifo + Netcat ===

  - id: mkfifo
    desc: mkfifo command (named pipe for shell)
    crit: suspicious
    conf: 0.6
    attack: "T1059"
    platforms: [linux, macos, unix]
    # Exclude JS - syntax highlighters have shell command keywords
    for: [shell, elf, macho, python]
    if:
      type: string
      exact: "mkfifo"

  - id: sh-interactive
    desc: Interactive shell invocation
    crit: notable
    conf: 0.5
    attack: "T1059"
    platforms: [linux, macos, unix]
    if:
      type: string
      exact: "sh -i"

  - id: nc-pipe
    desc: Netcat with pipe
    crit: suspicious
    conf: 0.7
    attack: "T1059"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "\\|\\s*nc\\s"

  # === Atomic: Socket + Shell (Generic) ===

  - id: socket-ref
    desc: Socket reference
    crit: inert
    conf: 0.5
    platforms: [all]
    if:
      type: string
      exact: "socket"

  - id: reverse-keyword
    desc: Reverse keyword reference
    crit: inert
    conf: 0.3
    platforms: [all]
    if:
      type: string
      exact: "reverse"

  # === Atomic: Perl Reverse Shell ===

  - id: perl-socket-open
    desc: Perl socket with open (reverse shell pattern)
    crit: suspicious
    conf: 0.8
    attack: "T1059.006"
    platforms: [all]
    for: [all]
    if:
      type: yara
      source: |
        rule perl_rev_shell {
          strings:
            $socket = "socket("
            $open = "open("
            $redir = /["']>&/
            $sh_i = "sh -i"
          condition:
            all of them
        }

  # === Atomic: Ruby Reverse Shell ===

  - id: ruby-tcpsocket-spawn
    desc: Ruby TCPSocket with spawn (reverse shell)
    crit: suspicious
    conf: 0.9
    attack: "T1059.006"
    platforms: [all]
    for: [ruby]
    if:
      type: string
      regex: "spawn\\([\"']/bin/sh[\"'],.{0,64}TCPSocket"

  - id: ruby-tcpsocket-popen
    desc: Ruby TCPSocket with popen (reverse shell)
    crit: suspicious
    conf: 0.9
    attack: "T1059.006"
    platforms: [all]
    for: [ruby]
    if:
      type: string
      regex: "TCPSocket.{0,64}\\.gets.{0,64}IO.popen"

  # === Atomic: Go Reverse Shell Functions ===

  - id: go-cmd-run
    desc: Go os/exec.Cmd.Run
    crit: notable
    conf: 0.5
    platforms: [all]
    for: [elf, macho]
    if:
      type: string
      exact: "os/exec.(*Cmd).Run"

  - id: go-net-conn
    desc: Go net.conn.Write
    crit: notable
    conf: 0.5
    platforms: [all]
    for: [elf, macho]
    if:
      type: string
      exact: "net.(*conn).Write"

  - id: go-child-stdin
    desc: Go exec.Cmd.childStdin
    crit: suspicious
    conf: 0.7
    platforms: [all]
    for: [elf, macho]
    if:
      type: string
      exact: "os/exec.(*Cmd).childStdin"

  - id: go-dial-tcp
    desc: Go dialTCP
    crit: notable
    conf: 0.5
    platforms: [all]
    for: [elf, macho]
    if:
      type: string
      exact: "dialTCP"

composite_rules:
  - id: mkfifo-netcat-shell
    desc: Reverse shell via mkfifo and netcat
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    mbc: "B0022"
    platforms: [linux, macos, unix]
    all:
      - id: mkfifo
      - id: sh-interactive
      - id: nc-pipe

  - id: go-reverse-shell
    desc: Go reverse shell pattern
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    mbc: "B0022"
    platforms: [all]
    for: [elf, macho]
    any:
      - id: exec/command/shell/bin-bash
      - id: exec/command/shell/bin-sh
    all:
      - id: go-cmd-run
      - id: go-net-conn
      - id: go-child-stdin
      - id: go-dial-tcp

  - id: generic-reverse-shell
    desc: Generic reverse shell pattern (socket + shell)
    crit: suspicious
    conf: 0.8
    attack: "T1059"
    platforms: [all]
    all:
      - id: reverse-keyword
      - id: socket-ref
    any:
      - id: exec/command/shell/bin-bash
      - id: exec/command/shell/bin-sh
