# Supply Chain Binary Backdoor Detection
# Detects patterns consistent with supply chain attacks like XZ Utils (CVE-2024-3094)
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)
# MBC: B0025 (Compromise Software Supply Chain)

defaults:
  for: [elf, pe, macho]
  attack: "T1195.002"
  mbc: "B0025"

traits:
  # === Library identification (for exclusion patterns) ===
  - id: libssl-ref
    desc: libssl library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libssl"

  - id: libcrypto-ref
    desc: libcrypto library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libcrypto"

  - id: libcurl-ref
    desc: libcurl library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libcurl"

  - id: libssh-ref
    desc: libssh library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libssh"

  # === System exclusion patterns ===
  - id: gnu-coreutils-ref
    desc: GNU coreutils reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "GNU coreutils"

  - id: glibc-ref
    desc: glibc reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "glibc"

  - id: systemd-ref
    desc: systemd reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "systemd"

  # === Go runtime exclusion (Go always includes socket primitives) ===
  - id: go-runtime-goexit
    desc: Go runtime.goexit reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "runtime.goexit"

  - id: go-runtime-main
    desc: Go runtime.main reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "runtime.main"

  # === Supply-chain specific crypto patterns ===
  - id: aes-sbox-bytes
    desc: AES S-box start bytes
    crit: notable
    conf: 0.7
    if:
      type: hex
      pattern: "63 7C 77 7B F2 6B 6F C5"

  - id: ed25519-constant-bytes
    desc: ED25519 constant bytes (XZ backdoor indicator)
    crit: suspicious
    conf: 0.85
    if:
      type: hex
      pattern: "79 07 4D C9 D3 14 79 51"

  # === Memory manipulation patterns ===
  - id: rwx-prot-bytes
    desc: RWX protection bytes (PROT_READ|WRITE|EXEC)
    crit: notable
    conf: 0.6
    if:
      type: hex
      pattern: "07 00 00 00"

  # === Indirect call patterns (JIT indicators) ===
  - id: indirect-call-reg
    desc: Indirect call via register (call reg)
    crit: inert
    conf: 0.3
    if:
      type: hex
      pattern: "FF D?"

  - id: indirect-call-mem
    desc: Indirect call via memory (call [reg])
    crit: inert
    conf: 0.3
    if:
      type: hex
      pattern: "FF 1?"

  # === Obfuscation Indicators ===
  - id: high-entropy-strings
    desc: Large obfuscated data blob
    crit: suspicious
    conf: 0.7
    if:
      type: metrics
      field: binary.high_entropy_strings
      min: 20

  # === ELF section patterns ===
  - id: init-array-section
    desc: .init_array section reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: ".init_array"

  - id: fini-array-section
    desc: .fini_array section reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: ".fini_array"

  - id: ctors-section
    desc: .ctors section reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: ".ctors"

  - id: dtors-section
    desc: .dtors section reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: ".dtors"

  - id: preinit-array-section
    desc: .preinit_array section reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: ".preinit_array"

  # === Symbol interposition patterns ===
  - id: dlsym-ref
    desc: dlsym function reference
    crit: notable
    conf: 0.5
    if:
      type: symbol
      pattern: "dlsym"

  - id: rtld-next-ref
    desc: RTLD_NEXT macro reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "RTLD_NEXT"

  - id: rtld-default-ref
    desc: RTLD_DEFAULT macro reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "RTLD_DEFAULT"

  - id: gnu-version-section
    desc: .gnu.version section reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: ".gnu.version"

  # === Massive Code Injection Indicators ===
  - id: massive-code-blob
    desc: Extremely large average function size (massive code injection)
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: binary.avg_function_size
      min: 10000

  - id: many-huge-functions
    desc: Many huge functions (>64KB) - potential XZ-style injection
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: binary.huge_functions
      min: 4

  # === XZ Utils Backdoor Specific Patterns ===
  - id: xz-backdoor-entry
    desc: XZ backdoor entry pattern bytes
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: hex
      pattern: "F3 0F 1E FA 55 48 89 E5 41 55 41 54 53 48 83 EC 18"

  - id: lzma-crc64-table
    desc: lzma_crc64_table reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "lzma_crc64_table"

  - id: lzma-crc64
    desc: lzma_crc64 reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "lzma_crc64"

  - id: xz-obf-pattern
    desc: XZ obfuscated function marker bytes
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: hex
      pattern: "0F B6 ?? ?? 0F B6 ?? ?? 31 ?? 0F B6 ?? ?? 31"

  # === IFUNC resolver patterns ===
  - id: resolver-suffix
    desc: _resolver function suffix
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: "_resolver"

  - id: gnu-hash-section
    desc: .gnu.hash section reference
    crit: inert
    conf: 0.3
    for: [elf]
    if:
      type: string
      exact: ".gnu.hash"

  - id: libc-start-ref
    desc: __libc_start reference
    crit: inert
    conf: 0.3
    for: [elf]
    if:
      type: string
      exact: "__libc_start"

  - id: ifunc-ref
    desc: IFUNC reference
    crit: inert
    conf: 0.4
    for: [elf]
    if:
      type: string
      exact: "IFUNC"

  - id: cpuid-instr
    desc: CPUID instruction bytes
    crit: inert
    conf: 0.3
    for: [elf]
    if:
      type: hex
      pattern: "0F A2"

  - id: xgetbv-instr
    desc: XGETBV instruction bytes
    crit: inert
    conf: 0.3
    for: [elf]
    if:
      type: hex
      pattern: "0F 01 D0"

  - id: getauxval-ref
    desc: getauxval function reference
    crit: inert
    conf: 0.3
    for: [elf]
    if:
      type: symbol
      pattern: "getauxval"

  # === RSA in compression library patterns ===
  - id: rsa-public-decrypt
    desc: RSA_public_decrypt reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "RSA_public_decrypt"

  - id: rsa-public-encrypt
    desc: RSA_public_encrypt reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "RSA_public_encrypt"

  - id: evp-pkey-ref
    desc: EVP_PKEY reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "EVP_PKEY"

  - id: lzma-ref
    desc: lzma compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\blzma\\b"

  - id: xz-ref
    desc: xz compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\bxz\\b"

  - id: zlib-ref
    desc: zlib compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\bzlib\\b"

  # === SSH/Auth hooking patterns ===
  - id: libsystemd-ref
    desc: libsystemd reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "libsystemd"

  - id: sshd-ref
    desc: sshd reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "sshd"

  - id: mm-answer-keyallowed
    desc: mm_answer_keyallowed SSH function
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "mm_answer_keyallowed"

  - id: mm-answer-authpassword
    desc: mm_answer_authpassword SSH function
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "mm_answer_authpassword"

  - id: pubkey-auth-ref
    desc: pubkey_auth reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "pubkey_auth"

  # === glibc hijacking patterns ===
  - id: dlopen-ref
    desc: dlopen function reference
    crit: inert
    conf: 0.4
    if:
      type: symbol
      pattern: "dlopen"

  - id: rtld-global-ref
    desc: __rtld_global reference
    crit: notable
    conf: 0.6
    for: [elf]
    if:
      type: string
      exact: "__rtld_global"

  - id: la-symbind-ref
    desc: la_symbind audit hook
    crit: suspicious
    conf: 0.7
    for: [elf]
    if:
      type: string
      exact: "la_symbind"

composite_rules:
  # === Exclusion composites ===
  - id: network-lib-marker
    desc: Known network library markers
    crit: inert
    conf: 0.5
    count: 1
    any:
      - id: libssl-ref
      - id: libcrypto-ref
      - id: libcurl-ref
      - id: libssh-ref

  - id: system-lib-marker
    desc: Known system library markers
    crit: inert
    conf: 0.5
    count: 1
    any:
      - id: gnu-coreutils-ref
      - id: glibc-ref
      - id: systemd-ref

  - id: go-runtime-marker
    desc: Go runtime markers
    crit: inert
    conf: 0.5
    count: 1
    any:
      - id: go-runtime-goexit
      - id: go-runtime-main

  # === ELF constructor/destructor ===
  - id: constructor-destructor
    desc: ELF constructor/destructor functions
    crit: notable
    conf: 0.5
    for: [elf]
    count: 2
    any:
      - id: init-array-section
      - id: fini-array-section
      - id: ctors-section
      - id: dtors-section
      - id: preinit-array-section

  # === Symbol interposition ===
  - id: symbol-interposition
    desc: Symbol interposition/override pattern
    crit: suspicious
    conf: 0.7
    for: [elf]
    all:
      - id: dlsym-ref
    any:
      - id: rtld-next-ref
      - id: rtld-default-ref
      - id: gnu-version-section

  # === Compression library markers ===
  - id: compression-lib
    desc: Compression library markers
    crit: inert
    conf: 0.4
    count: 1
    any:
      - id: lzma-ref
      - id: xz-ref
      - id: zlib-ref

  # === RSA operations ===
  - id: rsa-operations
    desc: RSA cryptographic operations
    crit: notable
    conf: 0.6
    count: 1
    any:
      - id: rsa-public-decrypt
      - id: rsa-public-encrypt
      - id: evp-pkey-ref

  # === XZ CRC patterns ===
  - id: xz-crc-pattern
    desc: XZ CRC64 patterns
    crit: notable
    conf: 0.6
    for: [elf]
    count: 2
    any:
      - id: lzma-crc64-table
      - id: lzma-crc64

  # === XZ backdoor signature ===
  - id: xz-backdoor-signature
    desc: XZ Utils backdoor signature (CVE-2024-3094)
    crit: hostile
    conf: 0.99
    for: [elf]
    all:
      - id: xz-crc-pattern
    any:
      - id: xz-backdoor-entry
      - id: xz-obf-pattern

  # === IFUNC resolver helper composites ===
  - id: resolver-markers
    desc: Resolver function markers
    crit: inert
    conf: 0.4
    for: [elf]
    count: 1
    any:
      - id: resolver-suffix
      - id: gnu-hash-section
      - id: libc-start-ref

  - id: ifunc-markers
    desc: IFUNC-related markers
    crit: inert
    conf: 0.4
    for: [elf]
    count: 1
    any:
      - id: ifunc-ref
      - id: getauxval-ref

  # === IFUNC resolver pattern ===
  - id: xz-ifunc-pattern
    desc: IFUNC resolver pattern (potential function hooking)
    crit: suspicious
    conf: 0.8
    for: [elf]
    all:
      - id: cpuid-instr
      - id: resolver-markers
      - id: ifunc-markers

  # === CPUID fingerprinting ===
  - id: cpuid-fingerprinting
    desc: CPUID fingerprinting in library (potential anti-analysis)
    crit: inert
    conf: 0.4
    attack: "T1082"
    for: [elf]
    all:
      - id: cpuid-instr
      - id: xgetbv-instr

  # === RSA in compression library ===
  - id: rsa-in-compression-lib
    desc: RSA operations in compression library (backdoor indicator)
    crit: suspicious
    conf: 0.9
    all:
      - id: rsa-operations
      - id: compression-lib

  # === SSH hook patterns ===
  - id: ssh-hook-pattern
    desc: SSH authentication hooking pattern
    crit: suspicious
    conf: 0.85
    all:
      - id: sshd-ref
    any:
      - id: rsa-public-decrypt
      - id: mm-answer-keyallowed
      - id: mm-answer-authpassword
      - id: pubkey-auth-ref

  # === glibc hijack ===
  - id: glibc-hijack
    desc: glibc function hijacking patterns
    crit: suspicious
    conf: 0.7
    for: [elf]
    count: 2
    any:
      - id: dlsym-ref
      - id: dlopen-ref
      - id: rtld-global-ref
      - id: la-symbind-ref
      - type: trait
        id: os/linker/env/ld-preload
      - type: trait
        id: os/linker/env/ld-audit

  # === Unexpected capability combinations ===
  # References external traits for socket/process operations
  - id: unexpected-socket-ops
    desc: Socket operations in non-network library
    crit: notable
    conf: 0.6
    all:
      - type: trait
        id: comm/socket/create/create
      - type: trait
        id: comm/socket/create/connect
    none:
      - id: network-lib-marker
      - id: system-lib-marker
      - id: go-runtime-marker

  - id: unexpected-process-ops
    desc: Process operations in utility library
    crit: suspicious
    conf: 0.75
    count: 3
    any:
      - type: trait
        id: process/fork/fork
      - type: trait
        id: exec/command/shell/c-execve
      - type: trait
        id: exec/command/shell/c-system
      - type: trait
        id: exec/command/shell/c-popen
      - type: trait
        id: exec/command/shell/bin-sh

  - id: unexpected-crypto
    desc: Cryptographic operations in non-crypto library
    crit: suspicious
    conf: 0.75
    count: 2
    any:
      - id: aes-sbox-bytes
      - id: rsa-operations
      - id: ed25519-constant-bytes

  # === Unexpected capability combination ===
  - id: unexpected-capabilities
    desc: Unexpected capability combination in library
    crit: suspicious
    conf: 0.8
    count: 2
    any:
      - id: unexpected-socket-ops
      - id: unexpected-process-ops
      - id: unexpected-crypto

  # === Injected code pattern ===
  - id: injected-code-pattern
    desc: Injected code pattern in library
    crit: hostile
    conf: 0.85
    all:
      - id: high-entropy-strings
    any:
      - id: unexpected-crypto
      - id: unexpected-socket-ops

  # === XZ-style backdoor detection ===
  - id: xz-style-attack
    desc: XZ-style supply chain backdoor pattern
    crit: hostile
    conf: 0.9
    count: 2
    any:
      - id: many-huge-functions
      - id: cpuid-fingerprinting
      - id: xz-ifunc-pattern

  # === Potential code injection ===
  - id: potential-code-injection
    desc: Potential code injection indicators
    crit: suspicious
    conf: 0.8
    all:
      - id: massive-code-blob
    any:
      - id: many-huge-functions
      - id: glibc-hijack

  # === Authentication bypass ===
  - id: auth-bypass-indicator
    desc: Authentication bypass backdoor indicator
    crit: hostile
    conf: 0.95
    any:
      - id: ssh-hook-pattern
      - id: rsa-in-compression-lib

  # === Function hooking behavior ===
  - id: function-hooking-behavior
    desc: Dynamic function hooking patterns
    crit: suspicious
    conf: 0.8
    count: 2
    any:
      - id: xz-ifunc-pattern
      - id: glibc-hijack
      - id: cpuid-fingerprinting
