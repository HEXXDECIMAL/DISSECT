# Supply Chain Diff Indicators
# Traits that indicate suspicious changes in library updates
# These are particularly useful for dissect diff comparisons

defaults:
  for: [elf, pe, macho]
  attack: "T1195.002"
  mbc: "B0025"

traits:
  # === Unexpected Functionality in Libraries ===

  # NOTE: Go runtime always includes socket primitives - exclude Go binaries
  - id: unexpected-socket-ops
    desc: "Socket operations in non-network library"
    crit: notable
    conf: 0.6
    if:
      type: yara
      source: |
        rule unexpected_socket {
          strings:
            $sock1 = "socket" ascii
            $sock2 = "connect" ascii
            $sock3 = "bind" ascii
            $sock4 = "listen" ascii
            $sock5 = "accept" ascii
            $send1 = "send" ascii
            $recv1 = "recv" ascii
            // Exclude obvious network libraries
            $net_lib1 = "libssl" ascii
            $net_lib2 = "libcrypto" ascii
            $net_lib3 = "libcurl" ascii
            $net_lib4 = "libssh" ascii
            // Exclude coreutils and common system utilities
            $coreutils1 = "GNU coreutils" ascii
            $coreutils2 = "coreutils" ascii
            $coreutils3 = "glibc" ascii
            $systemd1 = "systemd" ascii
            // Exclude Go runtime (Go always includes socket primitives)
            $go1 = "runtime.goexit" ascii
            $go2 = "go.runtime" ascii
            $go3 = "runtime.main" ascii
          condition:
            (4 of ($sock*, $send*, $recv*)) and
            not any of ($net_lib*) and
            not any of ($coreutils*, $systemd1) and
            not any of ($go*)
        }

  - id: unexpected-process-ops
    desc: "Process operations in utility library"
    crit: suspicious
    conf: 0.75
    if:
      type: yara
      source: |
        rule unexpected_process {
          strings:
            $fork = "fork" ascii
            $exec1 = "execve" ascii
            $exec2 = "execl" ascii
            $exec3 = "system" ascii
            $popen = "popen" ascii
            $shell = "/bin/sh" ascii
          condition:
            3 of them
        }

  - id: unexpected-crypto
    desc: "Cryptographic operations in non-crypto library"
    crit: suspicious
    conf: 0.75
    if:
      type: yara
      source: |
        rule unexpected_crypto {
          strings:
            $aes1 = "AES_" ascii
            $aes2 = { 63 7C 77 7B F2 6B 6F C5 }  // AES S-box start
            $rsa1 = "RSA_" ascii
            $evp1 = "EVP_" ascii
            $sha1 = "SHA256" ascii
            $chacha = "chacha" ascii nocase
            // ED25519 constants (used in XZ backdoor)
            $ed1 = { 79 07 4D C9 D3 14 79 51 }
          condition:
            3 of them
        }

  - id: unexpected-env-access
    desc: "Environment variable access patterns"
    crit: notable
    conf: 0.65
    if:
      type: yara
      source: |
        rule env_access_pattern {
          strings:
            $env1 = "getenv" ascii
            $env2 = "setenv" ascii
            $env3 = "putenv" ascii
            // Suspicious env vars
            $ld1 = "LD_PRELOAD" ascii
            $ld2 = "LD_LIBRARY_PATH" ascii
            $ld3 = "LD_AUDIT" ascii
            $ld4 = "LD_DEBUG" ascii
          condition:
            any of ($env*) and any of ($ld*)
        }

  # === Memory/Code Manipulation ===

  - id: memory-protection-change
    desc: "Memory protection modification (self-modifying code)"
    crit: suspicious
    conf: 0.8
    attack: "T1055"
    if:
      type: yara
      source: |
        rule mem_protect_change {
          strings:
            $mprotect = "mprotect" ascii
            $mmap = "mmap" ascii
            $wx = { 07 00 00 00 }  // PROT_READ | PROT_WRITE | PROT_EXEC
          condition:
            ($mprotect and $wx) or
            ($mmap and $mprotect)
        }

  - id: jit-pattern
    desc: "JIT-like code generation pattern"
    crit: notable
    conf: 0.7
    if:
      type: yara
      source: |
        rule jit_pattern {
          strings:
            $mmap = "mmap" ascii
            $mprotect = "mprotect" ascii
            $memcpy = "memcpy" ascii
            // Indirect call patterns
            $icall1 = { FF D? }  // call reg
            $icall2 = { FF 1? }  // call [reg]
          condition:
            ($mmap and $mprotect and $memcpy) and
            (#icall1 + #icall2) > 10
        }

  # === Obfuscation Indicators ===

  - id: data-obfuscation
    desc: "Large obfuscated data blob"
    crit: suspicious
    conf: 0.7
    if:
      type: metrics
      field: binary.high_entropy_strings
      min: 20

  # === Suspicious Library Patterns ===

  - id: constructor-destructor
    desc: "ELF constructor/destructor functions"
    crit: notable
    conf: 0.5
    if:
      type: yara
      source: |
        rule elf_ctors_dtors {
          strings:
            $init = ".init_array" ascii
            $fini = ".fini_array" ascii
            $ctors = ".ctors" ascii
            $dtors = ".dtors" ascii
            $preinit = ".preinit_array" ascii
          condition:
            uint32(0) == 0x464c457f and
            2 of them
        }

  - id: symbol-interposition
    desc: "Symbol interposition/override pattern"
    crit: suspicious
    conf: 0.7
    if:
      type: yara
      source: |
        rule symbol_interpose {
          strings:
            $dlsym = "dlsym" ascii
            $rtld = "RTLD_NEXT" ascii
            $rtld2 = "RTLD_DEFAULT" ascii
            $versym = ".gnu.version" ascii
          condition:
            $dlsym and any of ($rtld, $rtld2, $versym)
        }

  # === Massive Code Injection Indicators ===

  - id: massive-code-blob
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    desc: "Extremely large average function size (massive code injection)"
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: binary.avg_function_size
      min: 10000

  - id: many-huge-functions
    desc: "Many huge functions (>64KB) - potential XZ-style injection"
    crit: suspicious
    conf: 0.9
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    if:
      type: metrics
      field: binary.huge_functions
      min: 4

  # === XZ Utils Backdoor Specific Patterns ===

  - id: xz-backdoor-signature
    desc: "XZ Utils backdoor signature (CVE-2024-3094)"
    crit: suspicious
    conf: 0.99
    for: [elf]
    attack: "T1195.002"
    mbc: "B0025"
    if:
      type: yara
      source: |
        rule xz_backdoor_cve_2024_3094 {
          meta:
            description = "XZ Utils backdoor CVE-2024-3094"
            reference = "https://www.openwall.com/lists/oss-security/2024/03/29/4"
          strings:
            // Backdoor entry patterns
            $entry1 = { F3 0F 1E FA 55 48 89 E5 41 55 41 54 53 48 83 EC 18 }
            // CRC64 hijack pattern
            $crc1 = "lzma_crc64_table" ascii
            $crc2 = "lzma_crc64" ascii
            // Obfuscated function markers
            $obf1 = { 0F B6 ?? ?? 0F B6 ?? ?? 31 ?? 0F B6 ?? ?? 31 }
            // Specific backdoor bytes
            $sig1 = { 48 8D 05 ?? ?? ?? ?? 48 89 C7 E8 ?? ?? ?? ?? 48 85 C0 74 }
          condition:
            uint32(0) == 0x464c457f and  // ELF magic
            (2 of ($crc*) and any of ($entry*, $obf*, $sig*))
        }

  - id: xz-ifunc-pattern
    desc: "IFUNC resolver pattern (potential function hooking)"
    crit: suspicious
    conf: 0.8
    for: [elf]
    attack: "T1195.002"
    mbc: "B0025"
    if:
      type: yara
      source: |
        rule ifunc_resolver_pattern {
          strings:
            $resolver1 = "_resolver" ascii
            $resolver2 = ".gnu.hash" ascii
            $resolver3 = "__libc_start" ascii
            $ifunc1 = "IFUNC" ascii
            // CPUID-based resolver (common in XZ)
            $cpuid = { 0F A2 }  // cpuid instruction
            $getauxval = "getauxval" ascii
          condition:
            uint32(0) == 0x464c457f and
            (any of ($resolver*) and $cpuid) or
            ($ifunc1 and $cpuid and $getauxval)
        }

  - id: rsa-in-compression-lib
    desc: "RSA operations in non-crypto library (backdoor indicator)"
    crit: suspicious
    conf: 0.9
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    if:
      type: yara
      source: |
        rule rsa_in_compression {
          strings:
            // RSA operations
            $rsa1 = "RSA_public_decrypt" ascii
            $rsa2 = "RSA_public_encrypt" ascii
            $rsa3 = "EVP_PKEY" ascii
            // Compression library markers
            $lzma1 = "lzma" ascii nocase
            $xz1 = "xz" ascii nocase
            $zlib1 = "zlib" ascii nocase
            $compress1 = "compress" ascii nocase
          condition:
            any of ($rsa*) and any of ($lzma*, $xz*, $zlib*, $compress*)
        }

  # === SSH/Auth Library Hooking ===

  - id: ssh-hook-pattern
    desc: "SSH authentication hooking pattern"
    crit: suspicious
    conf: 0.85
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    if:
      type: yara
      source: |
        rule ssh_auth_hook {
          strings:
            $ssh1 = "libsystemd" ascii
            $ssh2 = "sshd" ascii
            $auth1 = "RSA_public_decrypt" ascii
            $auth2 = "mm_answer_keyallowed" ascii
            $auth3 = "mm_answer_authpassword" ascii
            $auth4 = "pubkey_auth" ascii
          condition:
            any of ($ssh*) and any of ($auth*)
        }

  # === Hidden Code Patterns ===

  # CPUID/XGETBV are used by Go runtime for CPU feature detection
  # Only suspicious with many more occurrences and other backdoor indicators
  - id: cpuid-fingerprinting
    desc: "CPUID fingerprinting in library (potential anti-analysis)"
    crit: inert
    conf: 0.4
    for: [elf]
    attack: "T1082"
    if:
      type: yara
      source: |
        rule cpuid_in_lib {
          strings:
            $cpuid = { 0F A2 }  // cpuid instruction
            $xgetbv = { 0F 01 D0 }  // xgetbv instruction
          condition:
            uint32(0) == 0x464c457f and
            #cpuid > 20 and $xgetbv
        }

  - id: glibc-hijack
    desc: "glibc function hijacking patterns"
    crit: suspicious
    conf: 0.7
    for: [elf]
    attack: "T1195.002"
    mbc: "B0025"
    if:
      type: yara
      source: |
        rule glibc_hijack {
          strings:
            $dl1 = "dlsym" ascii
            $dl2 = "dlopen" ascii
            $rtld1 = "__rtld_global" ascii
            $audit = "la_symbind" ascii
            $preload = "LD_PRELOAD" ascii
            $audit2 = "LD_AUDIT" ascii
          condition:
            2 of them
        }

# Supply Chain Binary Backdoor Detection
# Detects patterns consistent with supply chain attacks like XZ Utils (CVE-2024-3094)
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)
# MBC: B0025 (Compromise Software Supply Chain)

composite_rules:
  # === Unexpected Capability Combination ===

  - id: unexpected-capabilities
    desc: "Unexpected capability combination in library"
    crit: suspicious
    conf: 0.8
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    count: 2
    any:
      - id: unexpected-socket-ops
      - id: unexpected-process-ops
      - id: unexpected-crypto

  - id: injected-code-pattern
    desc: "Injected code pattern in library"
    crit: hostile
    conf: 0.85
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    all:
      - id: data-obfuscation
    any:
      - id: unexpected-crypto
      - id: unexpected-socket-ops

  # === XZ-style Backdoor Detection ===

  - id: xz-style-attack
    desc: "XZ-style supply chain backdoor pattern"
    crit: hostile
    conf: 0.9
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    count: 2
    any:
      - id: many-huge-functions
      - id: cpuid-fingerprinting
      - id: xz-ifunc-pattern

  - id: potential-code-injection
    desc: "Potential code injection indicators"
    crit: suspicious
    conf: 0.8
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    all:
      - id: massive-code-blob
    any:
      - id: many-huge-functions
      - id: glibc-hijack

  - id: auth-bypass-indicator
    desc: "Authentication bypass backdoor indicator"
    crit: suspicious
    conf: 0.95
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    any:
      - id: ssh-hook-pattern
      - id: rsa-in-compression-lib

  - id: function-hooking-behavior
    desc: "Dynamic function hooking patterns"
    crit: suspicious
    conf: 0.8
    for: [elf, pe, macho]
    attack: "T1195.002"
    mbc: "B0025"
    count: 2
    any:
      - id: xz-ifunc-pattern
      - id: glibc-hijack
      - id: cpuid-fingerprinting
