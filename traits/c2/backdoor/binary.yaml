# Supply Chain Binary Backdoor Detection
# Detects patterns consistent with supply chain attacks like XZ Utils (CVE-2024-3094)
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)
# MBC: B0025 (Compromise Software Supply Chain)

defaults:
  for: [elf, pe, macho]
  attack: "T1195.002"
  mbc: "B0025"

traits:
  # === Supply-chain specific crypto patterns ===

  - id: ed25519-constant-bytes
    desc: ED25519 constant bytes (XZ backdoor indicator)
    crit: suspicious
    conf: 0.85
    if:
      type: hex
      pattern: "79 07 4D C9 D3 14 79 51"

  # === Obfuscation Indicators ===
  - id: high-entropy-strings
    desc: Large obfuscated data blob
    crit: suspicious
    conf: 0.7
    if:
      type: metrics
      field: binary.high_entropy_strings
      min: 20

  # === Symbol interposition patterns ===
  - id: dlsym-ref
    desc: dlsym function reference
    crit: notable
    conf: 0.5
    if:
      type: symbol
      pattern: "dlsym"

  - id: rtld-next-ref
    desc: RTLD_NEXT macro reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "RTLD_NEXT"

  # === Massive Code Injection Indicators ===
  - id: massive-code-blob
    desc: Extremely large average function size (massive code injection)
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: binary.avg_function_size
      min: 10000

  - id: many-huge-functions
    desc: Many huge functions (>64KB) - potential XZ-style injection
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: binary.huge_functions
      min: 4

  # === XZ Utils Backdoor Specific Patterns ===
  - id: xz-backdoor-entry
    desc: XZ backdoor entry pattern bytes
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: hex
      pattern: "F3 0F 1E FA 55 48 89 E5 41 55 41 54 53 48 83 EC 18"

  - id: lzma-crc64-table
    desc: lzma_crc64_table reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "lzma_crc64_table"

  - id: lzma-crc64
    desc: lzma_crc64 reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "lzma_crc64"

  - id: xz-obf-pattern
    desc: XZ obfuscated function marker bytes
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: hex
      pattern: "0F B6 ?? ?? 0F B6 ?? ?? 31 ?? 0F B6 ?? ?? 31"

  # === RSA in compression library patterns ===
  - id: rsa-public-decrypt
    desc: RSA_public_decrypt reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "RSA_public_decrypt"

  - id: rsa-public-encrypt
    desc: RSA_public_encrypt reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "RSA_public_encrypt"

  - id: evp-pkey-ref
    desc: EVP_PKEY reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "EVP_PKEY"

  # === SSH/Auth hooking patterns ===
  - id: libsystemd-ref
    desc: libsystemd reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "libsystemd"

  - id: mm-answer-keyallowed
    desc: mm_answer_keyallowed SSH function
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "mm_answer_keyallowed"

  - id: mm-answer-authpassword
    desc: mm_answer_authpassword SSH function
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "mm_answer_authpassword"

  - id: pubkey-auth-ref
    desc: pubkey_auth reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "pubkey_auth"

  # === glibc hijacking patterns ===
  - id: dlopen-ref
    desc: dlopen function reference
    crit: inert
    conf: 0.4
    if:
      type: symbol
      pattern: "dlopen"

  - id: rtld-global-ref
    desc: __rtld_global reference
    crit: notable
    conf: 0.6
    for: [elf]
    if:
      type: string
      exact: "__rtld_global"

  - id: la-symbind-ref
    desc: la_symbind audit hook
    crit: suspicious
    conf: 0.7
    for: [elf]
    if:
      type: string
      exact: "la_symbind"

composite_rules:
  # === Symbol interposition ===
  - id: symbol-interposition
    desc: Symbol interposition/override pattern
    crit: suspicious
    conf: 0.7
    for: [elf]
    all:
      - id: dlsym-ref
    any:
      - id: rtld-next-ref
      - id: feat/binary/elf/rtld-default-ref
      - id: feat/binary/elf/sections/gnu-version

  # === RSA operations (supply chain context) ===
  - id: rsa-operations
    desc: RSA cryptographic operations
    crit: notable
    conf: 0.6
    count: 1
    any:
      - id: rsa-public-decrypt
      - id: rsa-public-encrypt
      - id: evp-pkey-ref

  # === XZ CRC patterns ===
  - id: xz-crc-pattern
    desc: XZ CRC64 patterns
    crit: notable
    conf: 0.6
    for: [elf]
    count: 2
    any:
      - id: lzma-crc64-table
      - id: lzma-crc64

  # === XZ backdoor signature ===
  - id: xz-backdoor-signature
    desc: XZ Utils backdoor signature (CVE-2024-3094)
    crit: hostile
    conf: 0.99
    for: [elf]
    all:
      - id: xz-crc-pattern
    any:
      - id: xz-backdoor-entry
      - id: xz-obf-pattern

  # === IFUNC resolver pattern ===
  - id: xz-ifunc-pattern
    desc: IFUNC resolver pattern (potential function hooking)
    crit: suspicious
    conf: 0.8
    for: [elf]
    all:
      - id: feat/binary/x86/cpuid-instr
      - id: feat/binary/elf/resolver-markers
      - id: feat/binary/elf/ifunc-markers

  # === RSA in compression library ===
  - id: rsa-in-compression-lib
    desc: RSA operations in compression library (backdoor indicator)
    crit: suspicious
    conf: 0.9
    all:
      - id: rsa-operations
      - id: feat/library/compression-lib

  # === SSH hook patterns ===
  - id: ssh-hook-pattern
    desc: SSH authentication hooking pattern
    crit: suspicious
    conf: 0.85
    all:
      - id: os/service/ssh/sshd-ref
    any:
      - id: rsa-public-decrypt
      - id: mm-answer-keyallowed
      - id: mm-answer-authpassword
      - id: pubkey-auth-ref

  # === glibc hijack ===
  - id: glibc-hijack
    desc: glibc function hijacking patterns
    crit: suspicious
    conf: 0.7
    for: [elf]
    count: 2
    any:
      - id: dlsym-ref
      - id: dlopen-ref
      - id: rtld-global-ref
      - id: la-symbind-ref
      - id: os/linker/env/ld-preload
      - id: os/linker/env/ld-audit

  # === Unexpected capability combinations ===
  # References external traits for socket/process operations
  - id: unexpected-socket-ops
    desc: Socket operations in non-network library
    crit: notable
    conf: 0.6
    all:
      - id: comm/socket/create/create
      - id: comm/socket/create/connect
    none:
      - id: feat/library/network-lib-marker
      - id: feat/library/system-lib-marker
      - id: feat/runtime/go/go-runtime-marker

  - id: unexpected-process-ops
    desc: Process operations in utility library
    crit: suspicious
    conf: 0.75
    count: 3
    any:
      - id: process/fork/fork
      - id: exec/command/shell/c-execve
      - id: exec/command/shell/c-system
      - id: exec/command/shell/c-popen
      - id: exec/command/shell/bin-sh

  - id: unexpected-crypto
    desc: Cryptographic operations in non-crypto library
    crit: suspicious
    conf: 0.75
    count: 2
    any:
      - id: crypto/symmetric/aes/binary/aes-sbox-bytes
      - id: rsa-operations
      - id: ed25519-constant-bytes

  # === Unexpected capability combination ===
  - id: unexpected-capabilities
    desc: Unexpected capability combination in library
    crit: suspicious
    conf: 0.8
    count: 2
    any:
      - id: unexpected-socket-ops
      - id: unexpected-process-ops
      - id: unexpected-crypto

  # === Injected code pattern ===
  - id: injected-code-pattern
    desc: Injected code pattern in library
    crit: hostile
    conf: 0.85
    all:
      - id: high-entropy-strings
    any:
      - id: unexpected-crypto
      - id: unexpected-socket-ops

  # === XZ-style backdoor detection ===
  - id: xz-style-attack
    desc: XZ-style supply chain backdoor pattern
    crit: hostile
    conf: 0.9
    count: 2
    any:
      - id: many-huge-functions
      - id: feat/binary/x86/cpuid-fingerprinting
      - id: xz-ifunc-pattern

  # === Potential code injection ===
  - id: potential-code-injection
    desc: Potential code injection indicators
    crit: suspicious
    conf: 0.8
    all:
      - id: massive-code-blob
    any:
      - id: many-huge-functions
      - id: glibc-hijack

  # === Authentication bypass ===
  - id: auth-bypass-indicator
    desc: Authentication bypass backdoor indicator
    crit: hostile
    conf: 0.95
    any:
      - id: ssh-hook-pattern
      - id: rsa-in-compression-lib
      - id: symbol-interposition

  # === Function hooking behavior ===
  - id: function-hooking-behavior
    desc: Dynamic function hooking patterns
    crit: suspicious
    conf: 0.8
    count: 2
    any:
      - id: xz-ifunc-pattern
      - id: glibc-hijack
      - id: feat/binary/x86/cpuid-fingerprinting

  # === RWX memory with suspicious context ===
  - id: rwx-with-injection
    desc: RWX memory protection with code injection indicators
    crit: suspicious
    conf: 0.75
    all:
      - id: mem/protect/modify/rwx-prot-bytes
    any:
      - id: glibc-hijack
      - id: symbol-interposition
      - id: high-entropy-strings
