# Indirect Function (IFUNC) Hijacking Detection
# Detects patterns where IFUNC resolvers are used for suspicious purposes.
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)
# MBC: B0025 (Compromise Software Supply Chain)

defaults:
  for: [elf]
  attack: "T1195.002"
  mbc: "B0025"

composite_rules:
  # === Unexpected Library Context ===
  - id: ifunc-in-utility-lib
    desc: IFUNC resolver in non-standard utility library
    crit: suspicious
    conf: 0.7
    all:
      - id: feat/binary/elf/ifunc
    none:
      - id: feat/library/system-lib-marker  # Exclude glibc/libm
      - id: feat/runtime/go/go-runtime-marker

  # === Sensitive Target Functions ===
  - id: ifunc-security-resolver
    desc: IFUNC resolver for security-sensitive function
    crit: suspicious
    conf: 0.8
    all:
      - id: feat/binary/elf/ifunc
    any:
      - id: os/pam/pam-authenticate-symbol
      - id: crypto/asymmetric/rsa-public-decrypt

  # === Resolver Side Effects ===
  - id: ifunc-with-env-check
    desc: IFUNC resolver combined with environment checks
    crit: suspicious
    conf: 0.85
    all:
      - id: feat/binary/elf/ifunc
      - id: os/env/vars/env-access
    none:
      - id: feat/library/system-lib-marker

  - id: ifunc-with-process-discovery
    desc: IFUNC resolver combined with process discovery
    crit: suspicious
    conf: 0.85
    all:
      - id: feat/binary/elf/ifunc
      - id: process/info/getpid
    none:
      - id: feat/library/system-lib-marker