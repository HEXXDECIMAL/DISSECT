# PHP Webshell C2 Traits
# MBC: B0030 (C2 Communication)
# ATT&CK: T1505.003 (Web Shell)

defaults:
  for: [php]
  mbc: "B0030"

traits:
  - id: password-form
    desc: HTML password form in PHP (webshell login)
    crit: suspicious
    conf: 0.85
    attack: "T1505.003"
    if:
      type: string
      regex: "<input[^>]*type=['\"]password['\"]"

  - id: ajax-handler
    desc: AJAX request handler pattern
    crit: notable
    conf: 0.7
    if:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "\\$_(GET|POST)"
      regex: true

  - id: json-response
    desc: JSON API response pattern
    crit: notable
    conf: 0.7
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "json_encode"

  - id: hardcoded-hash-auth
    desc: Hardcoded MD5 hash authentication (backdoor)
    crit: suspicious
    conf: 0.95
    attack: "T1505.003"
    if:
      type: ast_pattern
      node_type: binary_expression
      pattern: "md5"

  - id: substr-hash-compare
    desc: Partial hash comparison (weak authentication)
    crit: suspicious
    conf: 0.9
    attack: "T1505.003"
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "substr"

  - id: error-suppress-prefix
    desc: Error suppression operator usage (@)
    crit: notable
    conf: 0.7
    mbc: "B0032"
    if:
      type: ast_pattern
      node_type: error_suppression_expression
      pattern: ".*"
      regex: true

  # === Proxy port atomic indicators ===
  - id: port-30000
    desc: Port 30000
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "\\b30000\\b"

  - id: port-31337-php
    desc: Port 31337 (leet)
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "\\b31337\\b"

  - id: port-4444-php
    desc: Port 4444 (Metasploit)
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "\\b4444\\b"

  - id: port-5555
    desc: Port 5555
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "\\b5555\\b"

  - id: port-6666
    desc: Port 6666
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "\\b6666\\b"

  - id: port-8080-php
    desc: Port 8080 (HTTP alt)
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "\\b8080\\b"

  - id: port-9999
    desc: Port 9999
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "\\b9999\\b"

  - id: ssrf-pattern
    desc: Server-Side Request Forgery pattern (URL from user input)
    crit: suspicious
    conf: 0.85
    attack: "T1090"
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "curl_init\\s*\\(.*\\$_(GET|POST|REQUEST)"
      regex: true

  - id: google-search-scrape
    desc: Google search results scraping
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "google\\.[a-z.]+/search\\?.*site:"

  - id: url-param-fetch
    desc: URL parameter fetched and executed
    crit: suspicious
    conf: 0.8
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "(curl_init|file_get_contents|fopen)\\s*\\(.*\\$_(GET|POST)"
      regex: true

  - id: dynamic-user-input-call
    desc: User input used as function name (dynamic backdoor)
    crit: suspicious
    conf: 0.98
    attack: "T1505.003"
    if:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "\\$_(GET|POST|REQUEST|COOKIE|SERVER)\\s*\\[[^]]+\\]\\s*\\("
      regex: true

composite_rules:
  - id: proxy-port
    desc: High port number (proxy/backdoor indicator)
    crit: suspicious
    conf: 0.8
    count: 1
    any:
      - id: port-30000
      - id: port-31337-php
      - id: port-4444-php
      - id: port-5555
      - id: port-6666
      - id: port-8080-php
      - id: port-9999
