# PHP Webshell C2 Traits
# MBC: B0030 (C2 Communication)
# ATT&CK: T1505.003 (Web Shell)

defaults:
  file_types: [php]
  mbc: "B0030"

traits:
  - id: password-form
    description: HTML password form in PHP (webshell login)
    criticality: suspicious
    confidence: 0.85
    attack: "T1505.003"
    condition:
      type: string
      regex: "<input[^>]*type=['\"]password['\"]"

  - id: ajax-handler
    description: AJAX request handler pattern
    criticality: notable
    confidence: 0.7
    condition:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "\\$_(GET|POST)"
      regex: true

  - id: json-response
    description: JSON API response pattern
    criticality: notable
    confidence: 0.7
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "json_encode"

  - id: hardcoded-hash-auth
    description: Hardcoded MD5 hash authentication (backdoor)
    criticality: suspicious
    confidence: 0.95
    attack: "T1505.003"
    condition:
      type: ast_pattern
      node_type: binary_expression
      pattern: "md5"

  - id: substr-hash-compare
    description: Partial hash comparison (weak authentication)
    criticality: suspicious
    confidence: 0.9
    attack: "T1505.003"
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "substr"

  - id: error-suppress-prefix
    description: Error suppression operator usage (@)
    criticality: notable
    confidence: 0.7
    mbc: "B0032"
    condition:
      type: ast_pattern
      node_type: error_suppression_expression
      pattern: ".*"
      regex: true

  - id: proxy-port
    description: High port number (proxy/backdoor indicator)
    criticality: suspicious
    confidence: 0.8
    condition:
      type: string
      regex: "\\b(30000|31337|4444|5555|6666|8080|9999)\\b"

  - id: ssrf-pattern
    description: Server-Side Request Forgery pattern (URL from user input)
    criticality: suspicious
    confidence: 0.85
    attack: "T1090"
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "curl_init\\s*\\(.*\\$_(GET|POST|REQUEST)"
      regex: true

  - id: google-search-scrape
    description: Google search results scraping
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "google\\.[a-z.]+/search\\?.*site:"

  - id: url-param-fetch
    description: URL parameter fetched and executed
    criticality: suspicious
    confidence: 0.8
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "(curl_init|file_get_contents|fopen)\\s*\\(.*\\$_(GET|POST)"
      regex: true

  - id: dynamic-user-input-call
    description: User input used as function name (dynamic backdoor)
    criticality: suspicious
    confidence: 0.98
    attack: "T1505.003"
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "\\$_(GET|POST|REQUEST|COOKIE|SERVER)\\s*\\[[^]]+\\]\\s*\\("
      regex: true
