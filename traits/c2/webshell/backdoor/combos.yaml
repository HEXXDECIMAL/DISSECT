# PHP Webshell Composite Detection Rules
# These rules combine multiple traits to identify webshell behavior patterns
# MBC: B0030 (C2 Communication)
# ATT&CK: T1505.003 (Server Software Component: Web Shell)

composite_rules:
  # High-confidence webshell detection
  - id: php-backdoor
    description: "PHP webshell: session-based backdoor with user input handling"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [all]
    requires_all:
      - type: trait
        id: persist/session
      - type: trait
        id: data/user-input
    requires_any:
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: fs/write
      - type: trait
        id: exec/command/exec

  # Dropper webshell (writes decoded payloads)
  - id: php-dropper
    description: "PHP dropper: decodes and writes payload files"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1105"
    file_types: [all]
    requires_all:
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: fs/write
    requires_any:
      - type: trait
        id: data/user-input
      - type: trait
        id: data/user-input

  # Self-destructing webshell
  - id: php-self-destruct
    description: "PHP webshell with self-deletion capability"
    criticality: suspicious
    confidence: 0.95
    mbc: "F0006"
    attack: "T1070.004"
    file_types: [all]
    requires_all:
      - type: trait
        id: evasion/self-destruct
      - type: trait
        id: data/user-input

  # SSRF/Proxy webshell
  - id: php-proxy
    description: "PHP proxy/SSRF webshell for fetching remote URLs"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0030"
    attack: "T1090"
    file_types: [all]
    requires_all:
      - type: trait
        id: comm/http/curl/init
    requires_any:
      - type: trait
        id: data/user-input
      - type: trait
        id: data/user-input
    requires_count: 1
    conditions:
      - type: trait
        id: comm/http/curl/ssl-verify-disable
      - type: trait
        id: comm/http/curl/ssl-host-disable
      - type: trait
        id: evasion/impersonate/ua-array

  # Bot impersonation webshell
  - id: php-bot-impersonate
    description: "PHP webshell with search engine bot impersonation"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0032"
    attack: "T1036"
    file_types: [all]
    requires_all:
      - type: trait
        id: comm/http/curl/init
    requires_any:
      - type: trait
        id: evasion/impersonate
      - type: trait
        id: evasion/impersonate/ua-array

  # Timestamp manipulation (anti-forensic)
  - id: php-timestomp
    description: "PHP webshell with timestamp manipulation for evasion"
    criticality: suspicious
    confidence: 0.9
    mbc: "F0006"
    attack: "T1070.006"
    file_types: [all]
    requires_all:
      - type: trait
        id: evasion/timestomp
      - type: trait
        id: fs/write

  # Hardcoded authentication backdoor
  - id: php-hardcoded-auth
    description: "PHP webshell with hardcoded hash authentication"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [all]
    requires_any:
      - type: trait
        id: c2/webshell/hardcoded-hash-auth
      - type: trait
        id: c2/webshell/substr-hash-compare

  # File upload webshell
  - id: php-uploader
    description: "PHP webshell with file upload capability"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0030"
    attack: "T1105"
    file_types: [all]
    requires_any:
      - type: trait
        id: data/user-input
      - type: trait
        id: comm/http/curl/file-upload
    requires_count: 1
    conditions:
      - type: trait
        id: fs/write
      - type: trait
        id: fs/write

  # Command execution webshell
  - id: php-rce
    description: "PHP webshell with remote command execution"
    criticality: suspicious
    confidence: 0.95
    mbc: "E1059"
    attack: "T1059.004"
    file_types: [all]
    requires_any:
      - type: trait
        id: exec/command/exec-user-input
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: anti-static/obfuscation
    requires_count: 1
    conditions:
      - type: trait
        id: data/user-input
      - type: trait
        id: data/user-input

  # Web UI webshell (has HTML interface)
  - id: php-web-ui
    description: "PHP webshell with web-based user interface"
    criticality: suspicious
    confidence: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [all]
    requires_all:
      - type: trait
        id: c2/webshell/password-form
    requires_any:
      - type: trait
        id: persist/session
      - type: trait
        id: data/user-input

  # Google scraping webshell (SEO spam tool)
  - id: php-seo-tool
    description: "PHP SEO spam tool with Google scraping capability"
    criticality: suspicious
    confidence: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [php]
    requires_all:
      - type: trait
        id: c2/webshell/google-search-scrape
      - type: trait
        id: comm/http/curl/init

  # Obfuscated payload webshell
  - id: php-obfuscated
    description: "PHP webshell with heavily obfuscated payload"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0032"
    attack: "T1027"
    file_types: [all]
    requires_count: 2
    conditions:
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: anti-static/obfuscation

  # Decompressed code execution
  - id: php-gz-eval
    description: "PHP: decompresses and executes code (obfuscated backdoor)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_all:
      - type: trait
        id: anti-static/obfuscation/encoding/gzinflate
      - type: trait
        id: anti-static/obfuscation/encoding/eval

  # Obfuscated dynamic backdoor
  - id: php-obfuscated-dynamic-backdoor
    description: "PHP: obfuscated dynamic backdoor (dynamic calls + obfuscation metrics)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/dynamic-call
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-obfuscated-vars
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-encoded-strings
      - type: trait
        id: anti-static/obfuscation/encoding

  # Non-ASCII dynamic backdoor
  - id: php-non-ascii-backdoor
    description: "PHP: non-ASCII dynamic backdoor (dynamic calls + binary content)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/dynamic-call
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-high-non-ascii-ratio

  - id: php-non-ascii-identifiers-backdoor
    description: "PHP: backdoor using non-ASCII identifiers"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-non-ascii-call
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-non-ascii-variable
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-non-ascii-name

  - id: php-shell-functional
    description: "PHP: functional webshell (exec + input + obfuscation/file ops)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/dynamic-call
    requires_any:
      - type: trait
        id: data/user-input/request/get
      - type: trait
        id: data/user-input/request/post
      - type: trait
        id: data/user-input/request/request
      - type: trait
        id: data/user-input/request/cookie
      - type: trait
        id: data/user-input/request/server
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: anti-static/obfuscation
      - type: trait
        id: fs/read/file
      - type: trait
        id: fs/write/file

  # Functional PHP shell
  - id: php-shell
    description: "PHP: functional webshell (exec + user input + file ops)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/command/shell
      - type: trait
        id: data/user-input/request
    requires_any:
      - type: trait
        id: fs/read/file
      - type: trait
        id: fs/write/file
      - type: trait
        id: anti-static/obfuscation/encoding
