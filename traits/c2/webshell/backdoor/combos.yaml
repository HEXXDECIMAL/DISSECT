# PHP Webshell Composite Detection Rules
# These rules combine multiple traits to identify webshell behavior patterns
# MBC: B0030 (C2 Communication)
# ATT&CK: T1505.003 (Server Software Component: Web Shell)

composite_rules:
  # High-confidence webshell detection
  - id: c2/webshell/php-backdoor
    description: "PHP webshell: session-based backdoor with user input handling"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [all]
    requires_all:
      - type: trait
        id: persistence/session/start
      - type: trait
        id: data/user-input/post
    requires_any:
      - type: trait
        id: anti-static/obfuscation/base64-decode
      - type: trait
        id: fs/write/file-put-contents
      - type: trait
        id: exec/command/exec

  # Dropper webshell (writes decoded payloads)
  - id: c2/webshell/php-dropper
    description: "PHP dropper: decodes and writes payload files"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1105"
    file_types: [all]
    requires_all:
      - type: trait
        id: anti-static/obfuscation/base64-decode
      - type: trait
        id: fs/write/file-put-contents
    requires_any:
      - type: trait
        id: data/user-input/post
      - type: trait
        id: data/user-input/get

  # Self-destructing webshell
  - id: c2/webshell/php-self-destruct
    description: "PHP webshell with self-deletion capability"
    criticality: suspicious
    confidence: 0.95
    mbc: "F0006"
    attack: "T1070.004"
    file_types: [all]
    requires_all:
      - type: trait
        id: evasion/self-destruct/unlink
      - type: trait
        id: data/user-input/script-filename

  # SSRF/Proxy webshell
  - id: c2/webshell/php-proxy
    description: "PHP proxy/SSRF webshell for fetching remote URLs"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0030"
    attack: "T1090"
    file_types: [all]
    requires_all:
      - type: trait
        id: net/http/curl/init
    requires_any:
      - type: trait
        id: data/user-input/post
      - type: trait
        id: data/user-input/get
    requires_count: 1
    conditions:
      - type: trait
        id: net/http/curl/ssl-verify-disable
      - type: trait
        id: net/http/curl/ssl-host-disable
      - type: trait
        id: evasion/impersonate/ua-array

  # Bot impersonation webshell
  - id: c2/webshell/php-bot-impersonate
    description: "PHP webshell with search engine bot impersonation"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0032"
    attack: "T1036"
    file_types: [all]
    requires_all:
      - type: trait
        id: net/http/curl/init
    requires_any:
      - type: trait
        id: evasion/impersonate/googlebot
      - type: trait
        id: evasion/impersonate/ua-array

  # Timestamp manipulation (anti-forensic)
  - id: c2/webshell/php-timestomp
    description: "PHP webshell with timestamp manipulation for evasion"
    criticality: suspicious
    confidence: 0.9
    mbc: "F0006"
    attack: "T1070.006"
    file_types: [all]
    requires_all:
      - type: trait
        id: evasion/timestomp/touch
      - type: trait
        id: fs/write/file-put-contents

  # Hardcoded authentication backdoor
  - id: c2/webshell/php-hardcoded-auth
    description: "PHP webshell with hardcoded hash authentication"
    criticality: suspicious
    confidence: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [all]
    requires_any:
      - type: trait
        id: c2/webshell/hardcoded-hash-auth
      - type: trait
        id: c2/webshell/substr-hash-compare

  # File upload webshell
  - id: c2/webshell/php-uploader
    description: "PHP webshell with file upload capability"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0030"
    attack: "T1105"
    file_types: [all]
    requires_any:
      - type: trait
        id: data/user-input/files
      - type: trait
        id: net/http/curl/file-upload
    requires_count: 1
    conditions:
      - type: trait
        id: fs/write/move-uploaded-file
      - type: trait
        id: fs/write/file-put-contents

  # Command execution webshell
  - id: c2/webshell/php-rce
    description: "PHP webshell with remote command execution"
    criticality: suspicious
    confidence: 0.95
    mbc: "E1059"
    attack: "T1059.004"
    file_types: [all]
    requires_any:
      - type: trait
        id: exec/command/exec-user-input
      - type: trait
        id: anti-static/obfuscation/eval
      - type: trait
        id: anti-static/obfuscation/preg-replace-e
    requires_count: 1
    conditions:
      - type: trait
        id: data/user-input/get
      - type: trait
        id: data/user-input/post

  # Web UI webshell (has HTML interface)
  - id: c2/webshell/php-web-ui
    description: "PHP webshell with web-based user interface"
    criticality: suspicious
    confidence: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [all]
    requires_all:
      - type: trait
        id: c2/webshell/password-form
    requires_any:
      - type: trait
        id: persistence/session/start
      - type: trait
        id: data/user-input/post

  # Google scraping webshell (SEO spam tool)
  - id: c2/webshell/php-seo-tool
    description: "PHP SEO spam tool with Google scraping capability"
    criticality: suspicious
    confidence: 0.85
    file_types: [all]
    requires_all:
      - type: trait
        id: c2/webshell/google-search-scrape
      - type: trait
        id: net/http/curl/init

  # Obfuscated payload webshell
  - id: c2/webshell/php-obfuscated
    description: "PHP webshell with heavily obfuscated payload"
    criticality: suspicious
    confidence: 0.9
    mbc: "B0032"
    attack: "T1027"
    file_types: [all]
    requires_count: 2
    conditions:
      - type: trait
        id: anti-static/obfuscation/base64-decode
      - type: trait
        id: anti-static/obfuscation/gzinflate
      - type: trait
        id: anti-static/obfuscation/gzuncompress
      - type: trait
        id: anti-static/obfuscation/rot13
      - type: trait
        id: anti-static/obfuscation/eval

  # Decompressed code execution
  - id: c2/webshell/php-gz-eval
    description: "PHP: decompresses and executes code (obfuscated backdoor)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_all:
      - type: trait
        id: anti-static/obfuscation/encoding/gzinflate
      - type: trait
        id: anti-static/obfuscation/encoding/eval

  # Obfuscated dynamic backdoor
  - id: c2/webshell/php-obfuscated-dynamic-backdoor
    description: "PHP: obfuscated dynamic backdoor (dynamic calls + obfuscation metrics)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/dynamic-call
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-obfuscated-vars
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-encoded-strings
      - type: trait
        id: anti-static/obfuscation/encoding

  # Non-ASCII dynamic backdoor
  - id: c2/webshell/php-non-ascii-backdoor
    description: "PHP: non-ASCII dynamic backdoor (dynamic calls + binary content)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/dynamic-call
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-high-non-ascii-ratio

  - id: c2/webshell/php-non-ascii-identifiers-backdoor
    description: "PHP: backdoor using non-ASCII identifiers"
    criticality: hostile
    confidence: 0.98
    mbc: "B0032"
    attack: "T1027"
    file_types: [php]
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-non-ascii-call
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-non-ascii-variable
      - type: trait
        id: anti-static/obfuscation/code-metrics/php-non-ascii-name

  - id: c2/webshell/php-shell-functional
    description: "PHP: functional webshell (exec + input + obfuscation/file ops)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/dynamic-call
    requires_any:
      - type: trait
        id: data/user-input/request/get
      - type: trait
        id: data/user-input/request/post
      - type: trait
        id: data/user-input/request/request
      - type: trait
        id: data/user-input/request/cookie
      - type: trait
        id: data/user-input/request/server
      - type: trait
        id: anti-analysis/obfuscation
      - type: trait
        id: anti-analysis/obfuscation/non-ascii-call
      - type: trait
        id: fs/read/file
      - type: trait
        id: fs/write/file

  # Functional PHP shell
  - id: c2/webshell/php-shell
    description: "PHP: functional webshell (exec + user input + file ops)"
    criticality: hostile
    confidence: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    file_types: [php]
    requires_all:
      - type: trait
        id: exec/command/shell
      - type: trait
        id: data/user-input/request
    requires_any:
      - type: trait
        id: fs/read/file
      - type: trait
        id: fs/write/file
      - type: trait
        id: anti-static/obfuscation/encoding
