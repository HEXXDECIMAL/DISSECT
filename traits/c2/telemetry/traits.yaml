# C2 - Operator Telemetry/Monitoring
# Detects malware using error tracking services (Sentry, etc.) for operator monitoring
# This is a technique where malware authors use legitimate services to track their malware's health
# ATT&CK: T1102 (Web Service)

defaults:
  attack: "T1102"

traits:
  # === Sentry Error Tracking ===
  - id: sentry-dsn
    desc: Sentry DSN configuration (operator telemetry)
    crit: suspicious
    conf: 0.85
    if:
      type: string
      # Sentry DSN format: https://<key>@<org>.ingest.sentry.io/<project>
      regex: "https://[a-f0-9]+@[a-z0-9.-]+\\.ingest\\.sentry\\.io/\\d+"

  - id: sentry-sdk-pkg
    desc: Sentry SDK package reference
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: '\bsentry[_-]sdk\b'

  - id: sentry-js-import
    desc: Sentry JavaScript import
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "@sentry/"

  - id: sentry-io-domain
    desc: Sentry.io domain
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "sentry.io"

  - id: sentry-init-js
    desc: Sentry.init JavaScript
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "Sentry.init"

  - id: sentry-init-py
    desc: sentry.init Python
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "sentry.init"

  - id: sentry-init-c
    desc: sentry_init C/Rust
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "sentry_init"

  - id: capture-exception
    desc: capture_exception function
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "capture_exception"

  - id: capture-message
    desc: capture_message function
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "capture_message"

  - id: capture-exception-js
    desc: captureException JavaScript
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "captureException"

  - id: capture-message-js
    desc: captureMessage JavaScript
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "captureMessage"

  # === Bugsnag ===
  - id: bugsnag-domain
    desc: Bugsnag domain
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bugsnag.com"

  - id: bugsnag-notify
    desc: Bugsnag.notify function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "Bugsnag.notify"

  # === Rollbar ===
  - id: rollbar-domain
    desc: Rollbar domain
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "rollbar.com"

  - id: rollbar-error
    desc: Rollbar.error function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "Rollbar.error"

  # === Raygun ===
  - id: raygun-com
    desc: Raygun.com domain
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "raygun.com"

  - id: raygun-io
    desc: Raygun.io domain
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "raygun.io"

  # === Stacktrace Keywords ===
  - id: stacktrace-attach
    desc: Attach stacktrace configuration
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "attach-stacktrace"

  - id: stacktrace-process
    desc: Process stacktrace function
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "process-stacktrace"

composite_rules:
  - id: sentry-sdk
    desc: Sentry SDK integration
    crit: notable
    conf: 0.7
    count: 1
    any:
      - id: sentry-sdk-pkg
      - id: sentry-js-import
      - id: sentry-io-domain

  - id: sentry-init
    desc: Sentry initialization function
    crit: notable
    conf: 0.7
    count: 1
    any:
      - id: sentry-init-js
      - id: sentry-init-py
      - id: sentry-init-c

  - id: sentry-capture
    desc: Sentry error capture
    crit: notable
    conf: 0.6
    count: 1
    any:
      - id: capture-exception
      - id: capture-message
      - id: capture-exception-js
      - id: capture-message-js

  - id: bugsnag
    desc: Bugsnag error tracking
    crit: notable
    conf: 0.7
    count: 1
    any:
      - id: bugsnag-domain
      - id: bugsnag-notify

  - id: rollbar
    desc: Rollbar error tracking
    crit: notable
    conf: 0.7
    count: 1
    any:
      - id: rollbar-domain
      - id: rollbar-error

  - id: raygun
    desc: Raygun error tracking
    crit: notable
    conf: 0.7
    count: 1
    any:
      - id: raygun-com
      - id: raygun-io

  - id: sentry-operator-monitoring
    desc: Sentry error tracking for operator monitoring
    crit: suspicious
    conf: 0.85
    any:
      - id: sentry-dsn
      - id: sentry-sdk
      - id: sentry-init

  - id: bugsnag-operator-monitoring
    desc: Bugsnag error tracking with stacktrace capture
    crit: suspicious
    conf: 0.8
    any:
      - id: bugsnag

  - id: rollbar-operator-monitoring
    desc: Rollbar error tracking with stacktrace capture
    crit: suspicious
    conf: 0.8
    any:
      - id: rollbar

  - id: operator-monitoring
    desc: Malware operator monitoring via error tracking service
    crit: suspicious
    conf: 0.85
    any:
      - id: sentry-operator-monitoring
      - id: bugsnag-operator-monitoring
      - id: rollbar-operator-monitoring
