# DNS-based C2 and Exfiltration Traits (Node.js)
# Detects DNS tunneling and data exfiltration via DNS queries
# MBC: C0002 (DNS Communication), E1591 (Data Exfiltration)
# ATT&CK: T1071.004 (DNS), T1048 (Exfiltration Over Alternative Protocol)

traits:
  # === DNS resolve atomic indicators ===
  - id: dns-resolve-call
    desc: dns.resolve call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "dns.resolve"

  - id: dns-resolve4-call
    desc: dns.resolve4 call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "dns.resolve4"

  - id: dns-resolve6-call
    desc: dns.resolve6 call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "dns.resolve6"

  # === DNS TXT resolve atomic indicators ===
  - id: dns-resolveTxt-method
    desc: dns.resolveTxt method
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "dns.resolveTxt"

  - id: resolveTxt-call
    desc: resolveTxt call
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "resolveTxt\\("

  - id: txt-record-single-quote
    desc: "TXT string (single quoted)"
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "'TXT'"

  - id: txt-record-double-quote
    desc: "TXT string (double quoted)"
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: '"TXT"'

  - id: dns-promises
    desc: DNS promises API (async DNS operations)
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: string
      exact: "dns/promises"

  # DNS Tunneling Patterns
  - id: subdomain-encoding
    desc: Subdomain-based data encoding pattern
    crit: suspicious
    conf: 0.85
    mbc: "C0002"
    attack: "T1048"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule dns_subdomain_encoding {
          strings:
            $encode1 = /\.\w+\.(com|net|org|io)/
            $dns = "resolveTxt" nocase
            $split = ".split"
            $join = ".join"
          condition:
            $encode1 and $dns and ($split or $join)
        }

  - id: dns-with-crypto
    desc: DNS combined with encryption (encrypted C2 channel)
    crit: suspicious
    conf: 0.9
    mbc: "C0002"
    attack: "T1573"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule dns_encrypted_c2 {
          strings:
            $dns1 = "resolveTxt"
            $dns2 = "dns.resolve"
            $crypto1 = "createCipheriv"
            $crypto2 = "createDecipheriv"
            $crypto3 = "aes-128"
            $crypto4 = "aes-256"
          condition:
            any of ($dns*) and any of ($crypto*)
        }

  - id: dns-polling-loop
    desc: DNS polling loop (C2 beacon pattern)
    crit: suspicious
    conf: 0.85
    mbc: "C0002"
    attack: "T1071.004"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule dns_polling {
          strings:
            $dns = "resolveTxt"
            $interval1 = "setInterval"
            $interval2 = "setTimeout"
            $loop = "while"
          condition:
            $dns and any of ($interval*, $loop)
        }

composite_rules:
  - id: dns-resolve
    desc: Node.js DNS resolve function (potential DNS tunneling)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    count: 1
    any:
      - id: dns-resolve-call
      - id: dns-resolve4-call
      - id: dns-resolve6-call

  - id: dns-resolve-txt
    desc: DNS TXT record resolution (common C2 channel)
    crit: suspicious
    conf: 0.9
    mbc: "C0002"
    attack: "T1071.004"
    for: [javascript, typescript]
    count: 1
    any:
      - id: dns-resolveTxt-method
      - id: resolveTxt-call
      - id: txt-record-single-quote
      - id: txt-record-double-quote
