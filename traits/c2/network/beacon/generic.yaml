# C2 Network Communication Patterns
# MBC: B0030 (C2 Communication)
# ATT&CK: T1071.001 (Web Protocols)

traits:
  # === HTTP template atomic indicators ===
  - id: post-template
    desc: POST template with placeholder
    crit: inert
    conf: 0.6
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "POST\\s+%s\\s+HTTP"

  - id: get-template
    desc: GET template with placeholder
    crit: inert
    conf: 0.6
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "GET\\s+%s\\s+HTTP"

  - id: hardcoded-ip
    desc: Hardcoded IP address (potential C2
    crit: suspicious
    conf: 0.75
    mbc: "B0030"
    if:
      type: string
      # Strict IPv4 regex: no leading zeros allowed (prevents FP from version strings)
      # Each octet: 0-9, 10-99, 100-199, 200-249, 250-255
      # Uses negative lookbehind/lookahead to exclude OID-like patterns (e.g., 1.2.840.113635.100.6.1.9)
      regex: "(?<![0-9.])(?:(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])(?![0-9.])"
      exclude_patterns:
        - "^127\\."
        - "^0\\."
        - "^255\\."
        - "^192\\.168\\."
        - "^10\\."
        - "^172\\.(1[6-9]|2[0-9]|3[01])\\."

  - id: user-agent-rotation
    desc: Multiple User-Agent strings (evasion technique)
    crit: suspicious
    conf: 0.80
    mbc: "F0001.004"
    attack: "T1036"
    if:
      type: string
      regex: "User-Agent:"
      count_min: 3
  # === Bot User-Agent atomic indicators ===
  - id: googlebot-ua
    desc: Googlebot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "Googlebot"

  - id: bingbot-ua
    desc: bingbot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "bingbot"

  - id: baiduspider-ua
    desc: Baiduspider User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "Baiduspider"

  - id: yandexbot-ua
    desc: YandexBot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "YandexBot"

  - id: duckduckbot-ua
    desc: DuckDuckBot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "DuckDuckBot"

  - id: wget-download
    desc: wget download command (payload fetching)
    crit: suspicious
    conf: 0.80
    mbc: "E1105"
    attack: "T1105"
    if:
      type: string
      regex: "wget\\s+https?://"

composite_rules:
  # HTTP template composite
  - id: http-template
    desc: HTTP request template with placeholders
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    count_min: 1
    any:
      - id: post-template
      - id: get-template

  - id: bot-user-agent
    desc: Search engine bot User-Agent (DDoS/evasion)
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    count_min: 1
    any:
      - id: googlebot-ua
      - id: bingbot-ua
      - id: baiduspider-ua
      - id: yandexbot-ua
      - id: duckduckbot-ua
