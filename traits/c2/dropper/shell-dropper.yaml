# Shell Dropper Detection
# Detects download-chmod-execute patterns common in supply chain attacks
# ATT&CK: T1059.004 (Command and Scripting Interpreter: Unix Shell)

traits:
  - id: wget-output-file
    description: Wget downloading to file
    criticality: notable
    confidence: 0.8
    mbc: "C0002"
    attack: "T1105"
    file_types: [all]
    condition:
      type: string
      regex: "wget .* -O |wget .*--output-document"
      search_raw: true

  - id: curl-output-file
    description: Curl downloading to file
    criticality: notable
    confidence: 0.8
    mbc: "C0002"
    attack: "T1105"
    file_types: [all]
    condition:
      type: string
      regex: "curl .* -o |curl .*--output"
      search_raw: true

  - id: chmod-plus-x
    description: Making file executable
    criticality: notable
    confidence: 0.75
    mbc: "C0047"
    attack: "T1222.002"
    file_types: [all]
    condition:
      type: string
      regex: "chmod \\+x|chmod 7[0-9][0-9]"
      search_raw: true

  - id: download-and-execute-chain
    description: Download, chmod, and execute in one command
    criticality: hostile
    confidence: 0.95
    mbc: "B0024"
    attack: "T1059.004"
    file_types: [all]
    condition:
      type: string
      regex: "(wget|curl).*(&&|;).*chmod.*(&&|;)"
      search_raw: true

composite_rules:
  - id: c2/dropper/shell-download-execute
    description: "Shell dropper: downloads, makes executable, and runs payload"
    confidence: 0.95
    criticality: hostile
    platforms:
      - linux
      - macos
    file_types:
      - javascript
      - python
      - shell
      - ruby
    requires_count: 3
    conditions:
      - type: trait
        id: wget-output-file
      - type: trait
        id: curl-output-file
      - type: trait
        id: chmod-plus-x
      - type: trait
        id: hidden-file-write
      - type: trait
        id: hidden-file-execute
      - type: trait
        id: all-output-suppressed
