# Credential Access Capabilities
# Covers password theft, keylogging, credential dumping, etc.

simple_rules:
  # macOS Keychain access
  - symbol: SecKeychainFindGenericPassword
    capability: credential/keychain/read
    description: Read passwords from macOS Keychain
    confidence: 0.9
    platforms: [macos]
    file_types: [macho, dylib]

  - symbol: SecKeychainFindInternetPassword
    capability: credential/keychain/read
    description: Read internet passwords from macOS Keychain
    confidence: 0.9
    platforms: [macos]
    file_types: [macho, dylib]

  - symbol: SecKeychainItemCopyContent
    capability: credential/keychain/read
    description: Copy Keychain item contents
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib]

  # Unix password database access
  - symbol: getpwnam
    capability: credential/password-file/read
    description: Read user password database
    confidence: 0.7  # Common in legitimate code
    platforms: [unix, linux, macos]

  - symbol: getpwuid
    capability: credential/password-file/read
    description: Read user password database by UID
    confidence: 0.7
    platforms: [unix, linux, macos]

  - symbol: getspnam
    capability: credential/shadow/read
    description: Read shadow password file
    confidence: 1.0
    platforms: [linux, unix]
    file_types: [elf]

  # Environment variables (may contain secrets)
  - symbol: getenv
    capability: credential/env-vars/read
    description: Read environment variables
    confidence: 0.5  # Very common, low signal
    platforms: [all]

  - symbol: setenv
    capability: credential/env-vars/modify
    description: Modify environment variables
    confidence: 0.6
    platforms: [all]

  - symbol: putenv
    capability: credential/env-vars/modify
    description: Modify environment variables
    confidence: 0.6
    platforms: [all]

composite_rules:
  # macOS Keychain credential theft
  - capability: credential/keychain/steal
    description: Steal credentials from macOS Keychain
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib, shellscript]

    requires_count: 2
    conditions:
      # Keychain read operations
      - type: symbol_or_string
        any:
          - SecKeychainFindGenericPassword
          - SecKeychainFindInternetPassword
          - SecKeychainItemCopyContent
          - security

      # Data exfiltration or output
      - type: symbol_or_string
        any:
          - socket
          - fwrite
          - write
          - NSURLSession
          - printf
          - 'dump-keychain'
          - 'dump_keychain'

  # Linux shadow file theft
  - capability: credential/shadow/steal
    description: Read and exfiltrate shadow password file
    confidence: 0.9
    platforms: [linux]
    file_types: [elf, shellscript]

    requires_all:
      # Shadow file access
      - type: string
        exact: '/etc/shadow'

      # File read capability
      - type: symbol_or_string
        any:
          - fopen
          - open
          - read
          - cat

      # Data exfiltration (optional but raises confidence)
      - type: symbol_or_string
        any:
          - socket
          - curl
          - wget
          - write

  # Browser credential theft
  - capability: credential/browser/steal
    description: Steal passwords from web browsers
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Browser profile/database paths
      - type: string
        regex: '(Chrome|Firefox|Safari|Edge).*(Login|Cookies|Passwords)'
        case_insensitive: true

      # Database access
      - type: symbol_or_string
        any:
          - sqlite3_open
          - sqlite3_exec
          - NSFileManager

      # Crypto (browsers encrypt passwords)
      - type: symbol_or_string
        any:
          - CCCrypt
          - AES_decrypt
          - CryptUnprotectData

  # SSH key theft
  - capability: credential/ssh/steal
    description: Steal SSH private keys
    confidence: 0.85
    platforms: [unix, linux, macos]

    requires_all:
      # SSH key paths
      - type: string
        regex: '\.ssh/(id_rsa|id_ecdsa|id_ed25519)'

      # File read operations
      - type: symbol_or_string
        any:
          - fopen
          - open
          - read

  # Keylogger detection
  - capability: collection/keylogger
    description: Keyboard input logging
    confidence: 0.9
    platforms: [all]

    requires_any:
      # YARA detection
      - type: yara_match
        namespace: credential.keylogger

      # macOS keylogging APIs
      - type: symbol
        pattern: 'CGEventTapCreate|IOHIDManager'
        platforms: [macos]

      # Linux input device access
      - type: string
        regex: '/dev/input/event[0-9]'
        platforms: [linux]

      # Windows keylogging
      - type: symbol
        pattern: 'SetWindowsHookEx|GetAsyncKeyState'
        platforms: [windows]

  # Credential dumping from memory
  - capability: credential/memory/dump
    description: Dump credentials from process memory
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # Process memory access
      - type: symbol_or_string
        any:
          - ptrace
          - task_for_pid
          - mach_vm_read
          - ReadProcessMemory
          - '/proc/[0-9]+/mem'

      # Credential-related strings
      - type: string
        regex: '(password|credential|login|auth|token)'
        case_insensitive: true

      # Common credential dump tools
      - type: string
        regex: '(mimikatz|lsass|sam|security\.sav)'
        case_insensitive: true

  # AWS/Cloud credential theft
  - capability: credential/cloud/aws
    description: Steal AWS credentials
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # AWS credential file paths
      - type: string
        regex: '\.aws/(credentials|config)'

      # AWS environment variables
      - type: string
        regex: 'AWS_(ACCESS_KEY|SECRET|SESSION_TOKEN)'

      # File or env var access
      - type: symbol
        pattern: 'fopen|getenv'

  # GCP credential theft
  - capability: credential/cloud/gcp
    description: Steal Google Cloud credentials
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # GCP paths
      - type: string
        regex: 'gcloud/(credentials|application_default_credentials)'

      # GCP env vars
      - type: string
        regex: 'GOOGLE_APPLICATION_CREDENTIALS|CLOUDSDK_'

      # File access
      - type: symbol
        pattern: 'fopen|open'

  # Token/API key exfiltration
  - capability: credential/token/steal
    description: Steal API tokens or keys
    confidence: 0.75
    platforms: [all]

    requires_all:
      # Token patterns
      - type: string
        regex: '(api[_-]?key|api[_-]?token|bearer|authorization)'
        case_insensitive: true

      # Network exfiltration
      - type: symbol_or_string
        any:
          - socket
          - connect
          - curl
          - URLSession
          - 'http://'
          - 'https://'

  # Cookie theft
  - capability: credential/browser/cookies
    description: Steal browser cookies
    confidence: 0.8
    platforms: [all]

    requires_all:
      # Cookie file paths
      - type: string
        regex: '(Cookies|cookies\.sqlite|Cookies\.binarycookies)'

      # File read
      - type: symbol_or_string
        any:
          - fopen
          - open
          - sqlite3_open

  # Password dumping from SAM (Windows)
  - capability: credential/sam/dump
    description: Dump passwords from Windows SAM
    confidence: 0.95
    platforms: [windows]
    file_types: [pe, dll]

    requires_all:
      # SAM registry paths
      - type: string
        regex: 'SAM\\\\Domains\\\\Account|SYSTEM\\\\CurrentControlSet'

      # Registry access
      - type: symbol
        pattern: 'RegOpenKeyEx|RegQueryValueEx'

  # Clipboard password scraping
  - capability: credential/clipboard
    description: Scrape passwords from clipboard
    confidence: 0.85
    platforms: [all]

    requires_all:
      # YARA match
      - type: yara_match
        namespace: credential.clipboard

      # Clipboard access
      - type: symbol_or_string
        any:
          - NSPasteboard
          - GetClipboardData
          - XGetSelectionOwner
          - clipboard

      # Password-related strings
      - type: string
        regex: '(password|passwd|pwd|credential)'
        case_insensitive: true

  # Wifi password theft
  - capability: credential/wifi/steal
    description: Steal saved WiFi passwords
    confidence: 0.9
    platforms: [macos, windows, linux]

    requires_all:
      # WiFi-related paths/commands
      - type: symbol_or_string
        any:
          - 'networksetup -getairportnetwork'
          - 'netsh wlan show profile'
          - '/etc/NetworkManager/system-connections'
          - 'security find-generic-password.*AirPort'

      # Command execution or file read
      - type: symbol_or_string
        any:
          - system
          - popen
          - fopen
          - open
