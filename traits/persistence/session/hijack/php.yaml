# PHP Session Persistence Traits
# MBC: B0028 (Persistence)
# ATT&CK: T1071

traits:
  - id: persistence/session/hijack/start
    description: PHP session initialization for state persistence
    criticality: notable
    confidence: 0.7
    mbc: "B0028"
    file_types: [all]
    condition:
      type: string
      exact: session_start

  - id: persistence/session/hijack/destroy
    description: PHP session destruction
    criticality: notable
    confidence: 0.7
    file_types: [all]
    condition:
      type: string
      exact: session_destroy

  - id: persistence/session/hijack/regenerate
    description: PHP session ID regeneration
    criticality: notable
    confidence: 0.75
    file_types: [all]
    condition:
      type: string
      exact: session_regenerate_id

  - id: persistence/session/hijack/id-access
    description: Direct session ID manipulation
    criticality: suspicious
    confidence: 0.8
    mbc: "B0028"
    file_types: [all]
    condition:
      type: string
      regex: "session_id\\s*\\("

  - id: persistence/php/no-time-limit
    description: Disables PHP script time limit (webshell indicator)
    criticality: notable
    confidence: 0.85
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "set_time_limit"

  - id: persistence/php/ignore-abort
    description: Ignores client abort (webshell indicator)
    criticality: notable
    confidence: 0.85
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "ignore_user_abort"

  - id: evasion/php/output-buffering
    description: Uses output buffering (potential evasion)
    criticality: notable
    confidence: 0.7
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "ob_start"

  - id: evasion/php/error-reporting-off
    description: Disables error reporting (stealth)
    criticality: notable
    confidence: 0.8
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "error_reporting"

  - id: evasion/php/display-errors-off
    description: Disables error display (stealth)
    criticality: notable
    confidence: 0.8
    condition:
      type: ast_pattern
      node_type: member_call_expression
      pattern: "ini_set"
