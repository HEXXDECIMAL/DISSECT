# Unix Daemon Persistence
# Detects daemon/background process behavior common in malware
# ATT&CK: T1543 (Create or Modify System Process)

traits:
  - id: persistence/daemon/init/daemon-fork
    description: "Process forking for daemon behavior"
    criticality: notable
    confidence: 0.4
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bfork\\b|\\bdaemon\\b"

  - id: persistence/daemon/init/daemon-setsid
    description: "Session creation (setsid) for daemon"
    criticality: notable
    confidence: 0.5
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: symbol
      pattern: "\\bsetsid\\b"

  - id: persistence/daemon/init/daemon-dev-null
    description: "Redirects I/O to /dev/null (daemon behavior)"
    criticality: notable
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: string
      exact: "/dev/null"

  - id: persistence/daemon/init/daemon-chdir-root
    description: "Change directory to root (daemon behavior)"
    criticality: notable
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bchdir\\b"

  - id: persistence/daemon/init/daemon-proc-self
    description: "Reads /proc/self (process introspection)"
    criticality: notable
    confidence: 0.5
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "/proc/self(/|$)"

composite_rules:
  - id: persistence/daemon/full-daemon
    description: "Full daemon behavior (fork + setsid + /dev/null)"
    criticality: suspicious
    confidence: 0.8
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    requires_all:
      - type: trait
        id: daemon-dev-null
    requires_any:
      - type: trait
        id: daemon-fork
      - type: trait
        id: daemon-setsid

  - id: persistence/daemon/stealth-daemon
    description: "Stealthy daemon (daemon + proc introspection)"
    criticality: suspicious
    confidence: 0.75
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    requires_all:
      - type: trait
        id: daemon-proc-self
    requires_any:
      - type: trait
        id: daemon-fork
      - type: trait
        id: daemon-setsid
