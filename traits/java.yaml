# Java Language Traits and Capabilities
# Detection rules for Java programs covering reflection, deserialization, execution, and supply chain risks

# ============================================================================
# TRAITS: Atomic Observations
# ============================================================================

traits:
  # ==========================================
  # Command Execution
  # ==========================================

  - id: exec/java/runtime-exec
    description: Runtime.exec() command execution
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: Runtime.exec
    platforms: [all]

  - id: exec/java/processbuilder
    description: ProcessBuilder for process execution
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: ProcessBuilder
    platforms: [all]

  - id: exec/java/processbuilder-start
    description: Start process via ProcessBuilder
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: .start()
    platforms: [all]

  # ==========================================
  # Reflection (Critical for Java Attacks)
  # ==========================================

  - id: reflection/java/class-forname
    description: Dynamic class loading
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: Class.forName
    platforms: [all]

  - id: reflection/java/method-invoke
    description: Dynamic method invocation
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: Method.invoke
    platforms: [all]

  - id: reflection/java/getmethod
    description: Get method by reflection
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: .getMethod
    platforms: [all]

  - id: reflection/java/getdeclaredmethod
    description: Get declared method (bypasses access control)
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: .getDeclaredMethod
    platforms: [all]

  - id: reflection/java/setaccessible
    description: Bypass access control
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: .setAccessible
    platforms: [all]

  - id: reflection/java/newinstance
    description: Create object via reflection
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: .newInstance
    platforms: [all]

  # ==========================================
  # Deserialization (Major Attack Vector)
  # ==========================================

  - id: deserialization/java/objectinputstream
    description: Object deserialization
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: ObjectInputStream
    platforms: [all]

  - id: deserialization/java/readobject
    description: Read serialized object
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: .readObject
    platforms: [all]

  - id: deserialization/java/readunshared
    description: Read unshared object
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: .readUnshared
    platforms: [all]

  - id: deserialization/java/xmldecoder
    description: XML deserialization
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: XMLDecoder
    platforms: [all]

  - id: deserialization/java/xstream
    description: XStream deserialization library
    capability: true
    criticality: high
    confidence: 0.85
    type: symbol
    pattern: com.thoughtworks.xstream
    platforms: [all]

  # ==========================================
  # JNDI Injection (Log4Shell-style)
  # ==========================================

  - id: jndi/java/lookup
    description: JNDI lookup (injection risk)
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: .lookup
    platforms: [all]

  - id: jndi/java/initialcontext
    description: JNDI InitialContext
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: InitialContext
    platforms: [all]

  - id: jndi/java/ldap-string
    description: LDAP protocol in string
    criticality: none
    confidence: 0.9
    type: string
    regex: 'ldap://'
    platforms: [all]

  - id: jndi/java/rmi-string
    description: RMI protocol in string
    criticality: none
    confidence: 0.85
    type: string
    regex: 'rmi://'
    platforms: [all]

  # ==========================================
  # Native Methods (JNI)
  # ==========================================

  - id: jni/java/native-method
    description: Native method declaration
    capability: true
    criticality: medium
    confidence: 0.95
    type: symbol
    pattern: native
    platforms: [all]

  - id: jni/java/loadlibrary
    description: Load native library
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: System.loadLibrary
    platforms: [all]

  - id: jni/java/load
    description: Load native library from path
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: System.load
    platforms: [all]

  # ==========================================
  # Network Operations
  # ==========================================

  - id: net/java/url-connection
    description: URL connection
    capability: true
    criticality: low
    confidence: 0.8
    type: symbol
    pattern: URLConnection
    platforms: [all]

  - id: net/java/httpurlconnection
    description: HTTP connection
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: HttpURLConnection
    platforms: [all]

  - id: net/java/socket
    description: Socket creation
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: new Socket
    platforms: [all]

  - id: net/java/serversocket
    description: Server socket
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: ServerSocket
    platforms: [all]

  # ==========================================
  # File Operations
  # ==========================================

  - id: fs/java/file-read
    description: File reading
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: FileInputStream
    platforms: [all]

  - id: fs/java/file-write
    description: File writing
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: FileOutputStream
    platforms: [all]

  - id: fs/java/file-delete
    description: File deletion
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: .delete()
    platforms: [all]

  - id: fs/java/files-walk
    description: Directory tree traversal
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: Files.walk
    platforms: [all]

  # ==========================================
  # Cryptography
  # ==========================================

  - id: crypto/java/cipher
    description: Cipher operations
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: Cipher.getInstance
    platforms: [all]

  - id: crypto/java/keygenerator
    description: Key generation
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: KeyGenerator
    platforms: [all]

  - id: crypto/java/messagedigest
    description: Message digest/hashing
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: MessageDigest
    platforms: [all]

  # ==========================================
  # Class Loading (Supply Chain Risk)
  # ==========================================

  - id: classloader/java/urlclassloader
    description: URL-based class loading
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: URLClassLoader
    platforms: [all]

  - id: classloader/java/defineclass
    description: Define class from bytes
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: defineClass
    platforms: [all]

  - id: classloader/java/loadclass
    description: Load class dynamically
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: .loadClass
    platforms: [all]

  # ==========================================
  # Script Engines
  # ==========================================

  - id: exec/java/scriptengine
    description: Script engine execution
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: ScriptEngine
    platforms: [all]

  - id: exec/java/scriptenginemanager
    description: Script engine manager
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: ScriptEngineManager
    platforms: [all]

  # ==========================================
  # Encoding/Obfuscation
  # ==========================================

  - id: encoding/java/base64-decode
    description: Base64 decoding
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: Base64.getDecoder
    platforms: [all]

  - id: encoding/java/base64-encode
    description: Base64 encoding
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: Base64.getEncoder
    platforms: [all]

  # ==========================================
  # Shell References
  # ==========================================

  - id: exec/shell/sh
    description: References /bin/sh
    criticality: none
    confidence: 1.0
    type: string
    exact: '/bin/sh'
    platforms: [unix, linux, macos]

  - id: exec/shell/bash
    description: References /bin/bash
    criticality: none
    confidence: 1.0
    type: string
    exact: '/bin/bash'
    platforms: [unix, linux, macos]

  - id: exec/shell/cmd
    description: References cmd.exe
    criticality: none
    confidence: 1.0
    type: string
    exact: 'cmd.exe'
    platforms: [windows]

  - id: exec/shell/powershell
    description: References PowerShell
    criticality: none
    confidence: 1.0
    type: string
    regex: 'powershell\.exe'
    platforms: [windows]

# ============================================================================
# COMPOSITE CAPABILITIES: Behavioral Interpretations
# ============================================================================

capabilities:
  # ==========================================
  # Reverse Shell Patterns
  # ==========================================

  - id: c2/java/reverse-shell
    description: Reverse shell pattern (socket + shell execution)
    confidence: 0.98
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: net/java/socket
      - type: trait
        id: exec/java/runtime-exec
      - type: trait
        id: exec/shell/sh
  - id: c2/java/reverse-shell-processbuilder
    description: Reverse shell via ProcessBuilder
    confidence: 0.98
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: net/java/socket
      - type: trait
        id: exec/java/processbuilder
      - type: trait
        id: exec/shell/bash
  # ==========================================
  # JNDI Injection (Log4Shell-style)
  # ==========================================

  - id: jndi/java/injection-ldap
    description: JNDI LDAP injection pattern
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: jndi/java/initialcontext
      - type: trait
        id: jndi/java/lookup
      - type: trait
        id: jndi/java/ldap-string
  - id: jndi/java/injection-rmi
    description: JNDI RMI injection pattern
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: jndi/java/initialcontext
      - type: trait
        id: jndi/java/lookup
      - type: trait
        id: jndi/java/rmi-string
  # ==========================================
  # Deserialization Gadgets
  # ==========================================

  - id: deserialization/java/gadget-exec
    description: Deserialization with execution (gadget chain)
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: deserialization/java/objectinputstream
      - type: trait
        id: deserialization/java/readobject
      - type: trait
        id: exec/java/runtime-exec
  - id: deserialization/java/gadget-reflection
    description: Deserialization with reflection (potential gadget)
    confidence: 0.90
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: deserialization/java/objectinputstream
      - type: trait
        id: reflection/java/method-invoke
  # ==========================================
  # Reflection-Based Execution
  # ==========================================

  - id: exec/java/reflection-exec
    description: Reflection-based command execution (bypass)
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: reflection/java/class-forname
      - type: trait
        id: reflection/java/method-invoke
      - type: trait
        id: reflection/java/setaccessible
  # ==========================================
  # Dynamic Code Loading
  # ==========================================

  - id: exec/java/remote-class-load
    description: Remote class loading (supply chain risk)
    confidence: 0.92
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: classloader/java/urlclassloader
      - type: trait
        id: net/java/url-connection
  - id: exec/java/defineclass-exec
    description: Runtime class definition with execution
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: classloader/java/defineclass
      - type: trait
        id: exec/java/runtime-exec
  # ==========================================
  # Obfuscated Execution
  # ==========================================

  - id: exec/java/obfuscated-base64
    description: Base64-obfuscated command execution
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: encoding/java/base64-decode
      - type: trait
        id: exec/java/runtime-exec
  - id: exec/java/script-engine-exec
    description: Script engine code execution
    confidence: 0.92
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: exec/java/scriptengine
      - type: trait
        id: encoding/java/base64-decode
  # ==========================================
  # Ransomware Patterns
  # ==========================================

  - id: crypto/java/ransomware
    description: File encryption pattern (crypto + directory walking)
    confidence: 0.90
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: crypto/java/cipher
      - type: trait
        id: fs/java/files-walk
      - type: trait
        id: fs/java/file-write
  # ==========================================
  # Native Code Injection
  # ==========================================

  - id: exec/java/jni-injection
    description: Native code injection via JNI
    confidence: 0.88
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: jni/java/loadlibrary
      - type: trait
        id: jni/java/native-method
      - type: trait
        id: reflection/java/setaccessible