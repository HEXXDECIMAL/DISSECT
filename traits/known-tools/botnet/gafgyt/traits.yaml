# Malware Family - Gafgyt IoT Botnet
# Reference: https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/gafgyt
# ATT&CK: T1583.005 (Botnet)
# NOTE: DDoS flood traits (udp_flood, syn_flood, etc.) are defined in impact/ddos/flood/generic.yaml
# NOTE: botkill is defined in c2/botkill/traits.yaml
# NOTE: /bin/bash is defined in exec/command/shell/generic.yaml

traits:
  # NOTE: /sys/devices/system/cpu is present in glibc - this trait alone is NOT
  # a reliable botnet indicator. Only meaningful when combined with other Gafgyt indicators.
  - id: botnet/gafgyt/cpu-enumeration
    description: CPU device enumeration (requires context)
    crit: notable
    conf: 0.3
    attack: "T1082"
    file_types: [elf]
    condition:
      type: string
      exact: "/sys/devices/system/cpu"

  # Gafgyt-specific: tcpraw_flood (not in generic DDoS traits)
  - id: botnet/gafgyt/tcpraw-flood
    description: Gafgyt TCP raw flood function
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1498"
    file_types: [elf]
    condition:
      type: string
      exact: "tcpraw_flood"

  # Main detection via YARA with ELF magic check
  - id: botnet/gafgyt/detected
    description: Gafgyt IoT botnet
    crit: suspicious
    conf: 0.95
    family: true
    reference: "https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/gafgyt"
    attack: "T1583.005"
    mbc: "OB0004"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule gafgyt_botnet {
          strings:
            $botkill = "botkill"
            $bash = "/bin/bash"
            $cpu = "/sys/devices/system/cpu"
            $udp_flood = "udp_flood"
            $tcp_flood = "tcpraw_flood"
            $syn_flood = "syn_flood"
            $ack_flood = "ack_flood"
          condition:
            uint32(0) == 0x464C457F and
            filesize < 500KB and
            $botkill and 3 of them
        }

composite_rules:
  # DDoS capability detection - references generic DDoS traits
  - id: botnet/gafgyt/ddos-capability
    description: Gafgyt DDoS capability
    crit: hostile
    conf: 0.9
    attack: "T1498"
    mbc: "B0008"
    file_types: [elf]
    requires_count: 2
    any:
      - id: impact/ddos/flood/udp-flood
      - id: botnet/gafgyt/tcpraw-flood
      - id: impact/ddos/flood/syn-flood
      - id: impact/ddos/flood/ack-flood
