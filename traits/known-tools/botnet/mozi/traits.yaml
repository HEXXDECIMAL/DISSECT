# Mozi P2P Botnet Detection
# ATT&CK: T1071.001 (Application Layer Protocol: Web Protocols)
# MBC: B0030 (Remote Access)

defaults:
  file_types: [elf, macho, so, dylib]

traits:
  # Mozi DHT-based communication
  - id: botnet/mozi/dht-p2p
    description: Mozi DHT-based P2P communication patterns
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule mozi_dht {
          strings:
            $dht1 = "get_peers" ascii
            $dht2 = "announce_peer" ascii
            $dht3 = "find_node" ascii
            $dht4 = "info_hash" ascii
            $udp1 = "udp://" ascii
            $bencode1 = "d1:" ascii
            $bencode2 = "e1:" ascii
            // Mozi magic
            $magic1 = { 4D 6F 7A 69 }  // "Mozi"
          condition:
            $magic1 or 3 of ($dht*) or (2 of ($dht*) and any of ($bencode*)) or ($udp1 and any of ($dht*))
        }

  # Mozi XOR encryption
  - id: botnet/mozi/xor-config
    description: Mozi XOR encrypted configuration
    criticality: suspicious
    confidence: 0.85
    mbc: "B0030"
    attack: "T1027"
    condition:
      type: yara
      source: |
        rule mozi_xor {
          strings:
            // XOR decryption loop patterns
            $xor1 = { 31 ?? 88 ?? 4? 83 ?? ?? 7? }
            $xor2 = { 30 ?? 40 3? ?? 7? }
            // Config markers
            $cfg1 = "[ss]" ascii
            $cfg2 = "[cpu]" ascii
            $cfg3 = "[count]" ascii
            $cfg4 = "[dk]" ascii
          condition:
            any of ($xor*) and any of ($cfg*)
        }

  # Mozi Mirai-derived functionality
  - id: botnet/mozi/mirai-derived
    description: Mozi Mirai-derived attack capabilities
    criticality: hostile
    confidence: 0.85
    mbc: "B0030"
    attack: "T1498"
    condition:
      type: yara
      source: |
        rule mozi_mirai {
          strings:
            $attack1 = "udp_flood" ascii
            $attack2 = "tcp_flood" ascii
            $attack3 = "http_flood" ascii
            $attack4 = "syn_flood" ascii
            $scan1 = "scanner" ascii
            $scan2 = "telnet" ascii
            $table = "table" ascii
          condition:
            2 of ($attack*) or (any of ($scan*) and any of ($attack*)) or ($table and any of ($attack*))
        }

composite_rules:
  # Full Mozi detection
  - id: botnet/mozi/detected
    description: Mozi P2P botnet detected
    criticality: hostile
    confidence: 0.95
    requires_count: 2
    conditions:
      - type: trait
        id: botnet/mozi/dht-p2p
      - type: trait
        id: botnet/mozi/xor-config
      - type: trait
        id: botnet/mozi/mirai-derived