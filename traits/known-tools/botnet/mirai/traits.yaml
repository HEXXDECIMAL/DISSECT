# Malware Family - Mirai IoT Botnet
# Reference: https://www.cloudflare.com/learning/ddos/glossary/mirai-botnet/
# ATT&CK: T1583.005 (Botnet)

traits:
  # === Behavioral Indicators ===
  # Individual strings are suspicious, not hostile - detection requires combination

  - id: cnc-connect
    description: Mirai C2 connection function signature
    crit: suspicious
    conf: 0.8
    attack: "T1071"
    file_types: [elf]
    condition:
      type: string
      exact: "connectToCNC"

  - id: scanner-cookie
    description: Mirai scanner module reference
    crit: suspicious
    conf: 0.75
    attack: "T1046"
    file_types: [elf]
    condition:
      type: string
      exact: "__scan_cookie.c"

  - id: anti-reinfect
    description: Mirai anti-reinfection marker
    crit: suspicious
    conf: 0.8
    attack: "T1480"
    file_types: [elf]
    condition:
      type: string
      exact: "been_there_done_that"

  - id: dvr-helper
    description: Mirai DVR exploitation helper function
    crit: suspicious
    conf: 0.8
    attack: "T1190"
    file_types: [elf]
    condition:
      type: string
      exact: "dvrHelper"

  - id: brand-name
    description: Mirai botnet brand string
    crit: suspicious
    conf: 0.7
    family: true
    attack: "T1583.005"
    file_types: [elf]
    condition:
      type: string
      regex: "\\bMIRAI\\b"

  - id: read-module
    description: Mirai _READ.c module reference
    crit: suspicious
    conf: 0.7
    family: true
    file_types: [elf]
    condition:
      type: string
      exact: "_READ.c"

  - id: write-module
    description: Mirai _WRITE.c module reference
    crit: suspicious
    conf: 0.7
    family: true
    file_types: [elf]
    condition:
      type: string
      exact: "_WRITE.c"

  - id: killer-module
    description: Mirai killer module initialization
    crit: suspicious
    conf: 0.75
    family: true
    attack: "T1489"
    file_types: [elf]
    condition:
      type: string
      exact: "killer_init"

  - id: attack-module
    description: Mirai attack module initialization
    crit: suspicious
    conf: 0.75
    family: true
    attack: "T1498"
    file_types: [elf]
    condition:
      type: string
      exact: "attack_init"

  # === Proc filesystem indicators ===
  - id: proc-format
    description: Mirai proc format string
    crit: inert
    conf: 0.5
    file_types: [elf]
    condition:
      type: string
      exact: "/proc/%d"

  - id: proc-cpuinfo
    description: Mirai proc cpuinfo access
    crit: inert
    conf: 0.5
    file_types: [elf]
    condition:
      type: string
      exact: "/proc/cpuinfo"

  - id: proc-self-fd
    description: Mirai proc self fd access
    crit: inert
    conf: 0.5
    file_types: [elf]
    condition:
      type: string
      exact: "/proc/self/fd"

  - id: http-1-0
    description: HTTP/1.0 protocol string
    crit: inert
    conf: 0.5
    file_types: [elf]
    condition:
      type: string
      exact: "HTTP/1.0"

composite_rules:
  # Main Mirai detection - requires 6 of 12 indicators plus size constraints
  - id: detected
    description: Mirai IoT botnet detected
    crit: suspicious
    conf: 0.95
    family: true
    reference: "https://www.cloudflare.com/learning/ddos/glossary/mirai-botnet/"
    attack: "T1583.005"
    mbc: "OB0004"
    file_types: [elf]
    min_size: 40960      # 40KB - Mirai binaries are typically 40-150KB
    max_size: 153600     # 150KB
    requires_count: 6
    any:
      - id: proc-format
      - id: proc-cpuinfo
      - id: proc-self-fd
      - id: cnc-connect
      - id: scanner-cookie
      - id: anti-reinfect
      - id: read-module
      - id: write-module
      - id: killer-module
      - id: attack-module

  # Mirai DVR helper variant - requires brand + dvr + HTTP
  - id: dvr-helper-detected
    description: Mirai DVR exploitation helper variant
    crit: hostile
    conf: 0.95
    family: true
    attack: "T1190"
    mbc: "OB0004"
    file_types: [elf]
    requires_all:
      - id: brand-name
      - id: dvr-helper
      - id: http-1-0

  # Behavioral variant detection (no brand string required)
  - id: variant
    description: Mirai botnet variant (behavioral match)
    crit: hostile
    conf: 0.9
    attack: "T1583.005"
    mbc: "OB0004"
    file_types: [elf]
    requires_all:
      - id: cnc-connect
    requires_count: 2
    any:
      - id: scanner-cookie
      - id: anti-reinfect
      - id: killer-module
      - id: attack-module
