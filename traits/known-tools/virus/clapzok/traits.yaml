# Malware Family - Clapzok Multi-platform Virus
# Reference: https://www.virusbulletin.com/virusbulletin/2013/06/multiplatform-madness
# ATT&CK: T1204 (User Execution)

traits:
  - id: virus/clapzok/sfc-protected
    description: Clapzok SfcIsFileProtected marker
    crit: suspicious
    confidence: 0.95
    family: true
    attack: "T1204"
    file_types: [macho]
    condition:
      type: string
      exact: "SfcIsFileProtected"

  - id: virus/clapzok/macho-structure
    description: Clapzok virus YARA pattern for Mach-O binaries
    crit: suspicious
    confidence: 0.95
    family: true
    attack: "T1204"
    mbc: "B0009"
    file_types: [macho]
    condition:
      type: yara
      source: |
        rule clapzok_macho {
          strings:
            $ref = "SfcIsFileProtected"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE or
             uint32(0) == 0xBEBAFECA or uint32(0) == 0xCAFEBABE) and
            filesize < 10MB and $ref in (filesize - 2200..filesize - 100)
        }

composite_rules:
  - id: virus/clapzok/detected
    description: Clapzok multi-platform virus
    crit: suspicious
    confidence: 0.95
    family: true
    reference: "https://www.virusbulletin.com/virusbulletin/2013/06/multiplatform-madness"
    attack: "T1204"
    mbc: "B0009"
    file_types: [macho]
    all:
      - id: virus/clapzok/macho-structure
