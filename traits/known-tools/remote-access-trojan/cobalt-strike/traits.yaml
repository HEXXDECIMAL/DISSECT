# Malware Family - Cobalt Strike
# Commercial adversary simulation / C2 framework commonly abused by threat actors
# ATT&CK: T1071 (Application Layer Protocol)

composite_rules:
  # === Family Signature (Atomic) ===

  - id: c2-framework/cobalt-strike/format-string
    description: Cobalt Strike format string indicator
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1071"
    platforms: [all]
    condition:
      type: string
      exact: "%s as %s\\%s: %d"

  - id: c2-framework/cobalt-strike/beacon-ref
    description: Cobalt Strike beacon reference
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1071"
    platforms: [all]
    condition:
      type: string
      # Require Cobalt Strike specific context - "beacon" alone matches 802.11, BLE, etc.
      regex: "beacon\\.(dll|exe|bin)|beacon[_\\s]?(config|metadata|payload|command|task)|cobaltstrike.*beacon|beacon.*cobaltstrike|ReflectiveLoader.*beacon"

  - id: c2-framework/cobalt-strike/pipe-name
    description: Cobalt Strike named pipe pattern
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1071"
    platforms: [windows]
    condition:
      type: string
      regex: "\\\\\\\\.\\\\pipe\\\\msagent_"

  - id: c2-framework/cobalt-strike/detected
    description: Cobalt Strike C2 framework
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1071"
    mbc: "B0030"
    platforms: [all]
    requires_any:
      - type: trait
        id: c2-framework/cobalt-strike/format-string
      - type: trait
        id: c2-framework/cobalt-strike/pipe-name

  # macOS beacon detection via syscall combination + entropy
  - id: c2-framework/cobalt-strike/macos-beacon
    description: Cobalt Strike macOS beacon
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1071"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: yara
      source: |
        import "math"
        rule cs_macos_beacon {
          strings:
            $daemon = "@_daemon$1050"
            $execvp = "@_execvp"
            $popen = "@_popen"
            $pclose = "@_pclose"
            $shm_open = "@_shm_open"
            $inet_addr = "@_inet_addr"
            $gethostbyname = "@_gethostbyname"
            $openssl = "OpenSSL"
          condition:
            filesize > 3MB and filesize < 6MB and
            6 of them and
            math.entropy(1, filesize) > 6
        }
