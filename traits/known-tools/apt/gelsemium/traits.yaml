# Malware Family - Gelsemium/Wolfsbane
# Reference: https://www.welivesecurity.com/en/eset-research/unveiling-wolfsbane-gelsemiums-linux-counterpart-to-gelsevirine/
# ATT&CK: T1071 (Application Layer Protocol)

traits:
  - id: apt/gelsemium/clientpath
    description: Wolfsbane clientpath config
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    for: [elf]
    condition:
      type: string
      exact: "clientpath"

  - id: apt/gelsemium/hiderpath
    description: Wolfsbane hiderpath config
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1564"
    for: [elf]
    condition:
      type: string
      exact: "hiderpath"

  - id: apt/gelsemium/pluginkey
    description: Wolfsbane pluginkey config
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    for: [elf]
    condition:
      type: string
      exact: "pluginkey"

  - id: apt/gelsemium/mainpath
    description: Wolfsbane mainpath config
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1071"
    for: [elf]
    condition:
      type: string
      exact: "mainpath"

  - id: apt/gelsemium/rc4-key
    description: Wolfsbane RC4 encryption key
    crit: suspicious
    conf: 0.99
    family: true
    attack: "T1573"
    for: [elf]
    condition:
      type: string
      exact: "8825FC47153E264D"

  # NOTE: Cannot fully migrate - requires ELF magic check (uint32(0) == 0x464C457F) and filesize limit
  #  These checks require YARA. Atomic traits added for the string parts.
  - id: apt/gelsemium/clientpath-wide
    description: clientpath config (wide)
    crit: notable
    conf: 0.7
    family: true
    for: [elf]
    condition:
      type: string
      exact: "clientpath"
      search_raw: true

  - id: apt/gelsemium/hiderpath-wide
    description: hiderpath config (wide)
    crit: notable
    conf: 0.7
    family: true
    for: [elf]
    condition:
      type: string
      exact: "hiderpath"
      search_raw: true

  - id: apt/gelsemium/pluginkey-wide
    description: pluginkey config (wide)
    crit: notable
    conf: 0.7
    family: true
    for: [elf]
    condition:
      type: string
      exact: "pluginkey"
      search_raw: true

  - id: apt/gelsemium/mainpath-wide
    description: mainpath config (wide)
    crit: notable
    conf: 0.7
    family: true
    for: [elf]
    condition:
      type: string
      exact: "mainpath"
      search_raw: true

  - id: apt/gelsemium/config-yara
    description: Wolfsbane config strings via YARA
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    mbc: "B0030"
    for: [elf]
    condition:
      type: yara
      source: |
        rule wolfsbane_config {
          strings:
            $config_clientpath = "clientpath" wide
            $config_hiderpath = "hiderpath" wide
            $config_pluginkey = "pluginkey" wide
            $config_mainpath = "mainpath" wide
          condition:
            uint32(0) == 0x464C457F and
            filesize < 10MB and all of them
        }

composite_rules:
  - id: apt/gelsemium/detected
    description: Wolfsbane/Gelsemium (RC4 + config)
    crit: suspicious
    conf: 0.99
    family: true
    attack: "T1573"
    mbc: "C0027"
    for: [elf]
    count: 1
    any:
      - id: apt/gelsemium/rc4-key
      - id: apt/gelsemium/config-yara
