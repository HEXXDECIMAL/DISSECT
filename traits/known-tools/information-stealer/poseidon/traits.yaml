# Malware Family - Poseidon Infostealer
# macOS infostealer targeting credentials
# Reference: https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/
# ATT&CK: T1555 (Credentials from Password Stores)

traits:
  - id: stealer/poseidon/c2-url
    description: Poseidon C2 update check URL
    criticality: suspicious
    confidence: 0.99
    family: true
    attack: "T1071.001"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      exact: "https://forked-project.com/check_updates"

  - id: stealer/poseidon/mangled-string
    description: Poseidon mangled C++ string pattern
    criticality: suspicious
    confidence: 0.7
    family: true
    attack: "T1555"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      exact: "cEEE8max_sizeB8ue170006IS2_vEEmRKS2_"

composite_rules:
  # URL-based detection (high confidence)
  - id: stealer/poseidon/url-detected
    description: Poseidon infostealer (C2 URL)
    criticality: suspicious
    confidence: 0.99
    family: true
    reference: "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
    attack: "T1555"
    mbc: "B0028"
    platforms: [macos]
    file_types: [macho]
    requires_any:
      - id: stealer/poseidon/c2-url

  # Behavioral detection via YARA (filesize + entropy)
  - id: stealer/poseidon/detected
    description: Poseidon macOS infostealer
    criticality: suspicious
    confidence: 0.9
    family: true
    reference: "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
    attack: "T1555"
    mbc: "B0028"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: yara
      source: |
        import "math"
        rule poseidon_stealer {
          strings:
            $not_jar = "META-INF/"
            $not_dwarf = "_DWARF"
            $not_kext = "_.SYMDEF SORTED"
            $le = "cEEE8max_sizeB8ue170006IS2_vEEmRKS2_" fullword
            $sy = "@_system" fullword
            $sy2 = "_system" fullword
            $bs = "basic_string" fullword
            $ve = "vector" fullword
          condition:
            filesize > 190KB and filesize < 400KB and
            (uint32(0) == 4277009102 or uint32(0) == 3472551422 or
             uint32(0) == 4277009103 or uint32(0) == 3489328638 or
             uint32(0) == 3405691582 or uint32(0) == 3199925962 or
             uint32(0) == 3405691583 or uint32(0) == 3216703178) and
            none of ($not*) and all of ($le, $sy, $sy2, $bs, $ve) and
            math.entropy(20000, 50000) >= 2.5
        }
