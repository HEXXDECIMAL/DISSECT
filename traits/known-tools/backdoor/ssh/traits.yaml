# SSH Backdoor Detection Patterns
# ATT&CK: T1556.004 (Modify Authentication Process: SSH)

defaults:
  file_types: [elf, macho, so, dylib]

traits:
  # === SSH backdoor-SPECIFIC markers (ONLY these belong here) ===
  - id: backdoor/ssh/sshdoor-word
    desc: sshdoor backdoor name
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      word: "sshdoor"

  - id: backdoor/ssh/sshkit-word
    desc: sshkit backdoor toolkit name
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      word: "sshkit"

  - id: backdoor/ssh/master-password
    desc: master_password hardcoded credential
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      exact: "master_password"

  - id: backdoor/ssh/backdoor-pass
    desc: backdoor_pass hardcoded credential
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      exact: "backdoor_pass"

  - id: backdoor/ssh/magic-password
    desc: magic_password hardcoded credential
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      exact: "magic_password"

  - id: backdoor/ssh/auth-bypass
    desc: auth_bypass function marker
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      exact: "auth_bypass"

  - id: backdoor/ssh/skip-auth
    desc: skip_auth function marker
    crit: suspicious
    conf: 0.9
    condition:
      type: string
      exact: "skip_auth"

  - id: backdoor/ssh/password-log
    desc: password_log credential logging
    crit: suspicious
    conf: 0.85
    condition:
      type: string
      exact: "password_log"

  - id: backdoor/ssh/cred-log
    desc: cred_log credential logging
    crit: suspicious
    conf: 0.85
    condition:
      type: string
      exact: "cred_log"

composite_rules:
  # === Helper composites ===
  - id: ssh-backdoor-names
    desc: SSH backdoor family names
    any:
      - type: trait
        id: backdoor/ssh/sshdoor-word
      - type: trait
        id: backdoor/ssh/sshkit-word

  - id: ssh-hardcoded-creds
    desc: Hardcoded SSH credential strings
    any:
      - type: trait
        id: backdoor/ssh/master-password
      - type: trait
        id: backdoor/ssh/backdoor-pass
      - type: trait
        id: backdoor/ssh/magic-password

  - id: ssh-auth-bypass
    desc: SSH auth bypass markers
    any:
      - type: trait
        id: backdoor/ssh/auth-bypass
      - type: trait
        id: backdoor/ssh/skip-auth

  - id: ssh-cred-logging
    desc: SSH credential logging
    any:
      - type: trait
        id: backdoor/ssh/password-log
      - type: trait
        id: backdoor/ssh/cred-log

  # === Detection rules ===
  - id: backdoor/ssh/generic
    description: SSH backdoor patterns
    crit: suspicious
    conf: 0.85
    attack: "T1556.004"
    any:
      - type: trait
        id: ssh-backdoor-names
      - type: trait
        id: ssh-hardcoded-creds
      - type: trait
        id: ssh-auth-bypass

  - id: backdoor/ssh/cred-capture
    description: SSH credential logging backdoor
    crit: suspicious
    conf: 0.9
    attack: "T1556.004"
    all:
      - type: trait
        id: ssh-cred-logging

  # === Main detection rule ===
  - id: backdoor/ssh/detected
    description: SSH backdoor detected
    crit: hostile
    conf: 0.95
    attack: "T1556.004"
    mbc: "B0022"
    count: 2
    any:
      - type: trait
        id: backdoor/ssh/generic
      - type: trait
        id: backdoor/ssh/cred-capture
      - type: trait
        id: ssh-backdoor-names
      - type: trait
        id: ssh-hardcoded-creds
