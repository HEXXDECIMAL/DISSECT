# Malware Family - VShell / Agent-CNO Trojan
# Reference: https://malpedia.caad.fkie.fraunhofer.de/details/elf.vshell
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  - id: backdoor/vshell/send-vshell
    description: VShell send function marker
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1059"
    file_types: [elf]
    condition:
      type: string
      exact: ".SendVShell"

  - id: backdoor/vshell/sockopt-fprog
    description: VShell BPF socket filter
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1205"
    file_types: [elf]
    condition:
      type: string
      exact: ".SetsockoptSockFprog"

composite_rules:
  - id: backdoor/vshell/detected
    description: VShell / Agent-CNO Trojan
    criticality: hostile
    confidence: 0.95
    family: true
    reference: "https://malpedia.caad.fkie.fraunhofer.de/details/elf.vshell"
    attack: "T1059"
    mbc: "B0022"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule vshell_trojan {
          strings:
            $send_vshell = ".SendVShell"
            $sockopt = ".SetsockoptSockFprog"
          condition:
            uint32(0) == 0x464C457F and
            filesize < 20MB and all of them
        }
