# Generalized Go Reverse Shell & SOCKS Proxy
# Detects the combination of PTY shell, SOCKS proxying, and reverse connection capabilities common in Go backdoors.
# ATT&CK: T1059 (Command and Scripting Interpreter), T1090 (Proxy)

traits:
  - id: backdoor/generic/go-pty-shell
    description: "Go PTY interactive shell capability"
    criticality: suspicious
    confidence: 0.8
    file_types: [elf, macho, go]
    condition:
      type: yara
      source: |
        rule go_pty {
          strings:
            $pty_start = "StartWithSize" ascii
            $pty_open = "ptmx" ascii
            $pty_resize = "Setsize" ascii
            $shell = "/bin/bash" ascii
            $shell2 = "/bin/sh" ascii
          condition:
            (($pty_start and $pty_open) or ($pty_resize and $pty_open)) and ($shell or $shell2)
        }

  - id: backdoor/generic/go-socks-proxy
    description: "Go SOCKS5 proxy implementation"
    criticality: suspicious
    confidence: 0.8
    file_types: [go]
    condition:
      type: yara
      source: |
        rule go_socks {
          strings:
            $socks_ver = { 05 01 00 } // SOCKS5 handshake
            $socks_auth = "socksUsernamePassword" ascii
            $socks_dial = "socksNewDialer" ascii
            $socks_cmd = "socksCommand" ascii
            $socks_addr = "socksAddr" ascii
          condition:
            ($socks_ver and any of ($socks_*)) or 2 of ($socks_*)
        }

  - id: backdoor/generic/go-reverse-connect
    description: "Go reverse connection capability"
    criticality: notable
    confidence: 0.7
    file_types: [go]
    condition:
      type: yara
      source: |
        rule go_reverse {
          strings:
            $dial = "net.Dial" ascii
            $dial_tcp = "DialTCP" ascii
            $tcp = "tcp" ascii
            $connect = "connect" ascii
          condition:
            ($dial or $dial_tcp) and ($tcp or $connect)
        }

composite_rules:
  - id: backdoor/generic/go-reverse-socks
    description: "Go-based Reverse Shell with SOCKS Proxy"
    criticality: hostile
    confidence: 0.9
    attack: "T1090"
    mbc: "B0022"
    file_types: [elf, macho]
    requires_all:
      - id: backdoor/generic/go-pty-shell
      - id: backdoor/generic/go-socks-proxy
      - id: backdoor/generic/go-reverse-connect
