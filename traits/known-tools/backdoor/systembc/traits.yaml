# SystemBC Backdoor Detection
# ATT&CK: T1090.001 (Proxy: Internal Proxy)
# MBC: B0030 (Remote Access)

traits:
  # === SystemBC artifact atomic indicators ===
  - id: backdoor/systembc/name
    description: systembc string reference
    crit: inert
    conf: 0.6
    condition:
      type: string
      exact: "systembc"

  - id: backdoor/systembc/socks5
    description: socks5_proxy string reference
    crit: inert
    conf: 0.6
    condition:
      type: string
      exact: "socks5_proxy"

  # SystemBC SOCKS5 proxy capability
  - id: comm/proxy/socks5-server
    description: SOCKS5 proxy server implementation
    crit: notable
    conf: 0.8
    mbc: "B0030"
    attack: "T1090.001"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule socks5_server {
          strings:
            $proxy1 = "SOCKS5" ascii fullword
            $proxy2 = "socks5" ascii fullword
            $conn1 = "proxy" ascii nocase
            $conn2 = "tunnel" ascii nocase
          condition:
            (any of ($proxy*) and any of ($conn*))
        }

  # SystemBC RC4 encryption
  - id: crypto/rc4/communication
    description: RC4 encryption for network communication
    crit: suspicious
    conf: 0.8
    mbc: "B0030"
    attack: "T1573"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule rc4_network {
          strings:
            // RC4 key schedule
            $rc4_1 = { 8A ?? ?? 8A ?? ?? 02 ?? 88 ?? ?? 88 ?? ?? }
            // RC4 encrypt loop
            $rc4_2 = { 30 ?? 4? 83 ?? FF 75 }
            $key1 = "rc4" ascii nocase
            $key2 = "crypt" ascii nocase
          condition:
            any of ($rc4*) or ($key1 and $key2)
        }

  # SystemBC command shell
  - id: exec/remote-shell/socks-context
    description: Remote shell access within proxy context
    crit: suspicious
    conf: 0.75
    mbc: "B0030"
    attack: "T1059"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule remote_shell_proxy {
          strings:
            $shell1 = "/bin/sh" ascii
            $shell2 = "/bin/bash" ascii
            $exec1 = "popen" ascii
            $pipe1 = "pipe" ascii
            $pipe2 = "dup2" ascii
            // Require SOCKS context
            $socks1 = "SOCKS" ascii
            $socks2 = "socks" ascii
            $socks3 = "proxy" ascii nocase
          condition:
            (any of ($shell*) and any of ($exec*, $pipe*)) and any of ($socks*)
        }

composite_rules:
  # SystemBC artifact composite
  - id: backdoor/systembc/artifact
    description: SystemBC backdoor identifier
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: backdoor/systembc/name
      - id: backdoor/systembc/socks5

  - id: backdoor/systembc/proxy-shell
    description: SystemBC proxy shell behavior
    crit: hostile
    conf: 0.9
    attack: "T1090.001"
    mbc: "B0030"
    file_types: [elf, macho, pe, so, dylib, dll]
    requires_all:
      - id: comm/proxy/socks5-server
      - id: exec/remote-shell/socks-context
      - id: crypto/rc4/communication

  # Full SystemBC detection
  - id: backdoor/systembc/detected
    description: SystemBC backdoor detected
    crit: hostile
    conf: 0.95
    attack: "T1090.001"
    mbc: "B0030"
    file_types: [elf, macho, pe, so, dylib, dll]
    requires_count: 2
    any:
      - id: backdoor/systembc/artifact
      - id: crypto/rc4/communication
      - id: comm/proxy/socks5-server
      - id: exec/remote-shell/socks-context
