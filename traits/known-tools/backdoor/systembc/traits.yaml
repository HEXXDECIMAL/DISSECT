# SystemBC Backdoor Detection
# ATT&CK: T1090.001 (Proxy: Internal Proxy)
# MBC: B0030 (Remote Access)

traits:
  # === SystemBC-specific artifact indicators (ONLY these belong here) ===
  - id: backdoor/systembc/name
    description: systembc string reference
    crit: notable
    conf: 0.8
    condition:
      type: string
      exact: "systembc"

  - id: backdoor/systembc/socks5-proxy
    description: socks5_proxy SystemBC-specific string
    crit: notable
    conf: 0.8
    condition:
      type: string
      exact: "socks5_proxy"

  # NOTE: Cannot fully migrate - requires RC4 byte patterns
  # RC4 key schedule: { 8A ?? ?? 8A ?? ?? 02 ?? 88 ?? ?? 88 ?? ?? }
  # RC4 encrypt loop: { 30 ?? 4? 83 ?? FF 75 }
  - id: crypto/rc4/communication
    description: RC4 encryption for network communication
    crit: suspicious
    conf: 0.8
    mbc: "B0030"
    attack: "T1573"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule rc4_network {
          strings:
            // RC4 key schedule
            $rc4_1 = { 8A ?? ?? 8A ?? ?? 02 ?? 88 ?? ?? 88 ?? ?? }
            // RC4 encrypt loop
            $rc4_2 = { 30 ?? 4? 83 ?? FF 75 }
            $key1 = "rc4" ascii nocase
            $key2 = "crypt" ascii nocase
          condition:
            any of ($rc4*) or ($key1 and $key2)
        }

composite_rules:
  # === SystemBC artifact composite ===
  - id: backdoor/systembc/artifact
    description: SystemBC backdoor identifier
    crit: notable
    conf: 0.8
    any:
      - type: trait
        id: backdoor/systembc/name
      - type: trait
        id: backdoor/systembc/socks5-proxy

  # === Detection composites referencing generic traits ===
  # Helper: shell + pipe execution pattern
  - id: systembc-shell-exec
    desc: Shell execution with pipe functions
    all:
      - type: trait
        id: bin-sh
      - type: trait
        id: c-popen

  # Helper: SOCKS proxy with shell
  - id: systembc-proxy-shell
    desc: SOCKS proxy with shell execution
    all:
      - type: trait
        id: socks5-proto
      - type: trait
        id: systembc-shell-exec

  - id: backdoor/systembc/proxy-shell
    description: SystemBC proxy shell behavior
    crit: suspicious
    conf: 0.9
    attack: "T1090.001"
    mbc: "B0030"
    file_types: [elf, macho, pe, so, dylib, dll]
    all:
      - type: trait
        id: systembc-proxy-shell
      - type: trait
        id: crypto/rc4/communication

  # Full SystemBC detection
  - id: backdoor/systembc/detected
    description: SystemBC backdoor detected
    crit: hostile
    conf: 0.95
    attack: "T1090.001"
    mbc: "B0030"
    file_types: [elf, macho, pe, so, dylib, dll]
    count: 2
    any:
      - type: trait
        id: backdoor/systembc/artifact
      - type: trait
        id: crypto/rc4/communication
      - type: trait
        id: socks5-proto
      - type: trait
        id: backdoor/systembc/proxy-shell
