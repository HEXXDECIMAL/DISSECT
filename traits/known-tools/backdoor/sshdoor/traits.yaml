# Malware Family - SSHDoor Backdoor
# Backdoored SSH daemon for credential theft
# ATT&CK: T1556.003 (Pluggable Authentication Modules)

traits:
  # === Atomic Traits ===

  - id: backdoor/sshdoor/krb5-ccname
    description: SSHDoor Kerberos credential cache reference
    crit: suspicious
    conf: 0.5
    attack: "T1558"
    file_types: [elf]
    condition:
      type: string
      exact: "KRB5CCNAME"

  - id: backdoor/sshdoor/rm-var-tmp
    description: SSHDoor temp file cleanup pattern
    crit: suspicious
    conf: 0.85
    family: true
    attack: "T1070.004"
    file_types: [elf]
    condition:
      type: string
      regex: "rm /var/tmp/\\.\\w{0,16}"

  - id: backdoor/sshdoor/group-json
    description: SSHDoor group JSON key
    crit: suspicious
    conf: 0.6
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: '"Group"'

  - id: backdoor/sshdoor/password-json
    description: SSHDoor password JSON key
    crit: suspicious
    conf: 0.6
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: '"Password"'

  - id: backdoor/sshdoor/login-lock
    description: SSHDoor login lock file
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: ".login_lock"

  - id: backdoor/sshdoor/login-format
    description: SSHDoor login format string
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: "%s:Login to %s:%s"

  - id: backdoor/sshdoor/server-locked
    description: SSHDoor server locked message
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: "ssh server is locked"

composite_rules:
  # === Helper composite ===
  - id: sshdoor-indicators
    description: SSHDoor-specific string indicators
    for: [elf]
    any:
      - id: backdoor/sshdoor/rm-var-tmp
      - id: backdoor/sshdoor/group-json
      - id: backdoor/sshdoor/password-json
      - id: backdoor/sshdoor/login-lock
      - id: backdoor/sshdoor/login-format
      - id: backdoor/sshdoor/server-locked

  # === Migrated from YARA ===
  # Original YARA: KRB5CCNAME AND 2 of (6 other patterns)
  # Note: uint32(0) == 0x464C457F (ELF magic) and filesize < 2MB constraints
  # cannot be translated to DISSECT trait system
  - id: backdoor/sshdoor/yara-signature
    description: SSHDoor backdoored SSH daemon YARA signature
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1556.003"
    mbc: "B0022"
    for: [elf]
    all:
      - id: backdoor/sshdoor/krb5-ccname
      - id: sshdoor-indicators
        count: 2

  - id: backdoor/sshdoor/detected
    description: SSHDoor backdoored SSH daemon
    crit: hostile
    conf: 0.95
    family: true
    attack: "T1556.003"
    mbc: "B0022"
    for: [elf]
    count: 3
    any:
      - id: backdoor/sshdoor/krb5-ccname
      - id: backdoor/sshdoor/rm-var-tmp
      - id: backdoor/sshdoor/login-lock
      - id: backdoor/sshdoor/login-format
      - id: backdoor/sshdoor/server-locked
      - id: backdoor/sshdoor/yara-signature
