# Malware Family - SSHDoor Backdoor
# Backdoored SSH daemon for credential theft
# ATT&CK: T1556.003 (Pluggable Authentication Modules)

traits:
  # === Atomic Traits ===

  - id: backdoor/sshdoor/krb5-ccname
    description: SSHDoor Kerberos credential cache reference
    criticality: suspicious
    confidence: 0.5
    attack: "T1558"
    file_types: [elf]
    condition:
      type: string
      exact: "KRB5CCNAME"

  - id: backdoor/sshdoor/rm-var-tmp
    description: SSHDoor temp file cleanup pattern
    criticality: suspicious
    confidence: 0.85
    family: true
    attack: "T1070.004"
    file_types: [elf]
    condition:
      type: string
      regex: "rm /var/tmp/\\.\\w{0,16}"

  - id: backdoor/sshdoor/group-json
    description: SSHDoor group JSON key
    criticality: suspicious
    confidence: 0.6
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: "\"Group\""

  - id: backdoor/sshdoor/password-json
    description: SSHDoor password JSON key
    criticality: suspicious
    confidence: 0.6
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: "\"Password\""

  - id: backdoor/sshdoor/login-lock
    description: SSHDoor login lock file
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: ".login_lock"

  - id: backdoor/sshdoor/login-format
    description: SSHDoor login format string
    criticality: suspicious
    confidence: 0.95
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: "%s:Login to %s:%s"

  - id: backdoor/sshdoor/server-locked
    description: SSHDoor server locked message
    criticality: suspicious
    confidence: 0.95
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: "ssh server is locked"

  # SSHDoor detection - YARA-based trait for comprehensive detection
  - id: backdoor/sshdoor/yara-signature
    description: SSHDoor backdoored SSH daemon YARA signature
    criticality: suspicious
    confidence: 0.95
    family: true
    attack: "T1556.003"
    mbc: "B0022"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule sshdoor_backdoor {
          strings:
            $KRB5CCNAME = "KRB5CCNAME"
            $o_rm_var_tmp = /rm \/var\/tmp\/\.\w{0,16}/
            $o_group = "\"Group\""
            $o_pw = "\"Password\""
            $o_login_lock = ".login_lock"
            $o_string = "%s:Login to %s:%s"
            $o_locked = "ssh server is locked"
          condition:
            uint32(0) == 0x464C457F and
            filesize < 2MB and $KRB5CCNAME and 2 of ($o*)
        }

composite_rules:
  - id: backdoor/sshdoor/detected
    description: SSHDoor backdoored SSH daemon
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1556.003"
    mbc: "B0022"
    file_types: [elf]
    requires_count: 3
    conditions:
      - id: backdoor/sshdoor/krb5-ccname
      - id: backdoor/sshdoor/rm-var-tmp
      - id: backdoor/sshdoor/login-lock
      - id: backdoor/sshdoor/login-format
      - id: backdoor/sshdoor/server-locked
      - id: backdoor/sshdoor/yara-signature
