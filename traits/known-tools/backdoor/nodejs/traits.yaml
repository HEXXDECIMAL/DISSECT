# NodeJS-based Backdoor Detections
# ATT&CK: T1059.003 (Command and Scripting Interpreter: JavaScript), T1071 (Application Layer Protocol)

defaults:
  file_types: [elf, macho, so, dylib]

traits:
  # === Packaging Markers (Boring/Inert) ===
  
  - id: nodejs/pkg-marker
    description: "NodeJS binary packaged with 'pkg'"
    criticality: notable
    confidence: 1.0
    condition:
      type: string
      exact: "/snapshot/"

  - id: nodejs/nexe-marker
    description: "NodeJS binary packaged with 'nexe'"
    criticality: notable
    confidence: 1.0
    condition:
      type: string
      exact: "nexe.js"

  - id: nodejs/lpstub-section
    description: "NodeJS binary with 'lpstub' (hugepages support) section"
    criticality: inert
    confidence: 1.0
    condition:
      type: yara
      source: |
        import "elf"
        rule nodejs_lpstub {
          condition:
            for any i in (0..elf.number_of_sections-1) : (
              elf.sections[i].name == "lpstub"
            )
        }

  # === Suspicious Indicators ===

  - id: backdoor/nodejs/suspicious-c2
    description: "Suspicious NodeJS C2 endpoint (securitytrails.pro)"
    criticality: hostile
    confidence: 1.0
    condition:
      type: string
      exact: "ws://securitytrails.pro:2052"

  - id: backdoor/nodejs/exfil-pattern
    description: "NodeJS combination of WebSockets and Archiver (likely exfiltration)"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule nodejs_exfil {
          strings:
            $s1 = "archiver" ascii
            $s2 = "ws" ascii
            $s3 = "snapshot" ascii
          condition:
            all of them
        }

composite_rules:
  - id: backdoor/nodejs/detected
    description: "NodeJS-based Backdoor detected"
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: trait
        id: nodejs/pkg-marker
    requires_any:
      - type: trait
        id: backdoor/nodejs/suspicious-c2
      - type: trait
        id: backdoor/nodejs/exfil-pattern
      - type: trait
        id: c2/client/generic/marker
      - type: trait
        id: exec/remote-command/generic
      - type: trait
        id: data/archive/zip/generic
