# NodeJS-based Backdoor Detections
# ATT&CK: T1059.003 (Command and Scripting Interpreter: JavaScript), T1071 (Application Layer Protocol)

defaults:
  file_types: [elf, macho, so, dylib]

traits:
  # === Packaging Markers (Boring/Inert) ===
  
  - id: nodejs/pkg-marker
    description: "NodeJS binary packaged with 'pkg'"
    crit: notable
    conf: 1.0
    condition:
      type: string
      exact: "/snapshot/"

  - id: nodejs/nexe-marker
    description: "NodeJS binary packaged with 'nexe'"
    crit: notable
    conf: 1.0
    condition:
      type: string
      exact: "nexe.js"

  # NOTE: Cannot be migrated - requires YARA ELF module for section enumeration
  - id: nodejs/lpstub-section
    description: "NodeJS binary with 'lpstub' (hugepages support) section"
    crit: inert
    conf: 1.0
    condition:
      type: yara
      source: |
        import "elf"
        rule nodejs_lpstub {
          condition:
            for any i in (0..elf.number_of_sections-1) : (
              elf.sections[i].name == "lpstub"
            )
        }

  # === Suspicious Indicators ===

  - id: backdoor/nodejs/suspicious-c2
    description: "Suspicious NodeJS C2 endpoint (securitytrails.pro)"
    crit: suspicious
    conf: 1.0
    attack: "T1071"
    condition:
      type: string
      exact: "ws://securitytrails.pro:2052"


composite_rules:
  # Migrated from YARA nodejs_exfil - references generic traits
  - id: backdoor/nodejs/exfil-pattern
    desc: NodeJS combination of WebSockets and Archiver (likely exfiltration)
    crit: suspicious
    conf: 0.8
    all:
      - type: trait
        id: data/archive/archiver
      - type: trait
        id: comm/websocket/ws
      - type: trait
        id: nodejs/pkg-marker

  # Helper: any backdoor behavior indicator
  - id: nodejs-backdoor-behavior
    desc: NodeJS backdoor behavior indicators
    any:
      - type: trait
        id: backdoor/nodejs/suspicious-c2
      - type: trait
        id: backdoor/nodejs/exfil-pattern
      - type: trait
        id: c2/client/generic/marker
      - type: trait
        id: exec/remote-command/generic
      - type: trait
        id: data/archive/zip/generic

  - id: backdoor/nodejs/detected
    description: "NodeJS-based Backdoor detected"
    crit: suspicious
    conf: 0.95
    attack: "T1059.003"
    mbc: "B0022"
    all:
      - type: trait
        id: nodejs/pkg-marker
      - type: trait
        id: nodejs-backdoor-behavior
