# Melofee Linux Backdoor Detection
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: B0030 (Remote Access)

defaults:
  for: [elf, macho, pe, so, dylib, dll, python, shell, javascript]

traits:
  # === Melofee Name Variants (case-insensitive via variants) ===
  - id: melofee-lower
    desc: melofee name (lowercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "melofee"

  - id: melofee-upper
    desc: MELOFEE name (uppercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "MELOFEE"

  - id: melofee-title
    desc: Melofee name (title case)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "Melofee"

  # Winnti variants
  - id: winnti-lower
    desc: winnti name (lowercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "winnti"

  - id: winnti-upper
    desc: WINNTI name (uppercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "WINNTI"

  - id: winnti-title
    desc: Winnti name (title case)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "Winnti"

  # Melo/Fee prefixes
  - id: melo-prefix
    desc: melo_ prefix
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "melo_"

  - id: fee-prefix
    desc: fee_ prefix
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "fee_"

  # === Kernel Process Hiding ===
  - id: list-del-init
    desc: list_del_init kernel function
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "list_del_init"

  - id: this-module
    desc: THIS_MODULE kernel macro
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "THIS_MODULE"

  - id: hide-pid-string
    desc: hide_pid string
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "hide_pid"

  - id: hidden-pids-string
    desc: hidden_pids string
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "hidden_pids"

  # === C2 Heartbeat/Beacon ===
  - id: heartbeat-string
    desc: heartbeat C2 string
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "heartbeat"

  - id: checkin-string
    desc: checkin C2 string
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "checkin"

  - id: beacon-string
    desc: beacon C2 string
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "beacon"

  - id: shell-exec-string
    desc: shell_exec command
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "shell_exec"

  - id: file-upload-string
    desc: file_upload command
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "file_upload"

  - id: aes-encrypt-string
    desc: aes_encrypt function
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "aes_encrypt"

composite_rules:
  # === Helper composites ===
  - id: melofee-names
    description: Melofee name (case variants)
    any:
      - id: melofee-lower
      - id: melofee-upper
      - id: melofee-title

  - id: winnti-names
    description: Winnti name (case variants)
    any:
      - id: winnti-lower
      - id: winnti-upper
      - id: winnti-title

  - id: melo-fee-prefixes
    description: melo_ or fee_ prefixes
    any:
      - id: melo-prefix
      - id: fee-prefix

  - id: kernel-functions
    description: Kernel list manipulation functions
    any:
      - id: list-del-init
      - id: this-module

  - id: hiding-strings
    description: Process hiding strings
    any:
      - id: hide-pid-string
      - id: hidden-pids-string

  - id: c2-protocols
    description: C2 heartbeat/beacon protocols
    any:
      - id: heartbeat-string
      - id: checkin-string
      - id: beacon-string

  - id: backdoor-commands
    description: Backdoor command strings
    any:
      - id: shell-exec-string
      - id: file-upload-string

  # === Migrated from YARA ===
  - id: backdoor/melofee/artifact
    description: Melofee backdoor identifier string
    crit: notable
    conf: 0.7
    any:
      - id: melofee-names
      - id: winnti-names
      - id: melo-fee-prefixes

  - id: kernel/rootkit/process-hiding
    description: Kernel-level process hiding logic
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1014"
    all:
      - id: kernel-functions
      - id: hiding-strings

  - id: comm/c2/heartbeat-protocol
    description: C2 heartbeat/beacon protocol implementation
    crit: suspicious
    conf: 0.8
    all:
      - id: c2-protocols
      - id: backdoor-commands
      - id: aes-encrypt-string

  - id: melofee-behavior
    description: Melofee backdoor behavior (rootkit or C2)
    any:
      - id: kernel/rootkit/process-hiding
      - id: comm/c2/heartbeat-protocol

  # Melofee detection
  - id: backdoor/melofee/detected
    description: Melofee backdoor detected
    crit: suspicious
    conf: 0.95
    attack: "T1071"
    mbc: "B0030"
    all:
      - id: backdoor/melofee/artifact
      - id: melofee-behavior
