# Kinsing Cryptominer Detection
# ATT&CK: T1496 (Resource Hijacking)
# MBC: B0030 (Remote Access)

traits:
  # Kinsing cryptominer indicators
  - id: cryptominer/kinsing/generic
    description: Kinsing cryptominer patterns
    criticality: hostile
    confidence: 0.9
    attack: "T1496"
    file_types: [elf, go]
    condition:
      type: yara
      source: |
        rule kinsing_miner {
          strings:
            $name1 = "kinsing" ascii nocase
            $name2 = "Kinsing" ascii
            $name3 = "kdevtmpfsi" ascii
            // Go module paths
            $go1 = "kinsing/main" ascii
            $go2 = "main.Kinsing" ascii
          condition:
            (any of ($name*) and any of ($go*)) or (all of ($go*)) or ($name1 and $name3)
        }

  # Kinsing container targeting
  - id: cryptominer/kinsing/container
    description: Kinsing container/K8s targeting
    criticality: hostile
    confidence: 0.85
    attack: "T1610"
    file_types: [elf, go, shell]
    condition:
      type: yara
      source: |
        rule kinsing_container {
          strings:
            $name = "kinsing" ascii nocase
            // Container escape
            $cont1 = "/var/run/docker.sock" ascii
            $cont2 = "/.dockerenv" ascii
            // Kubernetes
            $k8s1 = "KUBERNETES_SERVICE" ascii
            $k8s2 = "/var/run/secrets/kubernetes" ascii
            // Cloud metadata
            $cloud1 = "169.254.169.254" ascii
            $cloud2 = "metadata.google" ascii
          condition:
            ($name and (any of ($cont*) or any of ($k8s*) or any of ($cloud*))) or
            (any of ($cont*) and any of ($k8s*) and any of ($cloud*))
        }

  # Kinsing spreading
  - id: cryptominer/kinsing/spreading
    description: Kinsing lateral movement
    criticality: hostile
    confidence: 0.85
    attack: "T1021"
    file_types: [elf, go, shell]
    condition:
      type: yara
      source: |
        rule kinsing_spread {
          strings:
            $name = "kinsing" ascii nocase
            // SSH spreading
            $ssh1 = "/.ssh/known_hosts" ascii
            $ssh2 = "/.ssh/id_rsa" ascii
            // Mass scanning
            $scan1 = "masscan" ascii
            $scan2 = "pnscan" ascii
            // Redis exploit
            $redis1 = "redis-cli" ascii
            $redis2 = "SLAVEOF" ascii
          condition:
            ($name and (any of ($ssh*) or any of ($scan*) or any of ($redis*))) or
            (all of ($ssh*) and (any of ($scan*) or any of ($redis*)))
        }

  # Kinsing mining
  - id: cryptominer/kinsing/mining
    description: Kinsing XMRig deployment
    criticality: hostile
    confidence: 0.9
    attack: "T1496"
    file_types: [elf, go, shell]
    condition:
      type: yara
      source: |
        rule kinsing_xmrig {
          strings:
            $name = "kinsing" ascii nocase
            // XMRig patterns
            $xmr1 = "xmrig" ascii nocase
            $xmr2 = "stratum+" ascii
            $xmr3 = "pool.minexmr" ascii
            $xmr4 = "moneroocean" ascii
            // Mining config
            $cfg1 = "donate-level" ascii
            $cfg2 = "cpu-priority" ascii
          condition:
            $name and (any of ($xmr*) or any of ($cfg*)) or
            (any of ($xmr*) and any of ($cfg*))
        }

composite_rules:
  - id: cryptominer/kinsing/detected
    description: Kinsing cryptominer detected
    criticality: hostile
    confidence: 0.95
    file_types: [elf, go]
    requires_any:
      - type: trait
        id: cryptominer/kinsing/generic
      - type: trait
        id: cryptominer/kinsing/mining