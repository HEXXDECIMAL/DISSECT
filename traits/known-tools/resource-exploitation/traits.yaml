# Cryptominer Detection
# Detects cryptocurrency mining malware
# ATT&CK: T1496 (Resource Hijacking)

traits:
  # XMRig miner
  - id: cryptominer/xmrig
    description: XMRig cryptocurrency miner
    crit: suspicious
    confidence: 0.95
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule xmrig {
          strings:
            $xmrig = "xmrig" ascii nocase
            $randomx = "RandomX" ascii
            $cn_variant = "cn/" ascii
            $pool = "stratum+tcp://" ascii
          condition:
            $xmrig or ($randomx and $pool) or ($cn_variant and $pool)
        }

  # Generic Stratum mining protocol
  - id: cryptominer/stratum
    description: Stratum mining protocol usage
    crit: suspicious
    confidence: 0.85
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: yara
      source: |
        rule stratum_protocol {
          strings:
            $stratum = "stratum" ascii nocase
            $mining_subscribe = "mining.subscribe" ascii
            $mining_authorize = "mining.authorize" ascii
            $mining_submit = "mining.submit" ascii
            $pool_port = ":3333" ascii
            $pool_port2 = ":14433" ascii
          condition:
            $stratum or any of ($mining_*) or any of ($pool_port*)
        }

  # Monero wallet patterns
  # NOTE: Monero wallets are 95 chars starting with 4 or 8, using Base58
  # Base58 alphabet excludes: 0, O, I, l (to avoid confusion)
  # IMPORTANT: Go binaries have type strings like "8uintchanfunc..." that match regex
  # Require stronger mining context to avoid false positives
  - id: cryptominer/monero-wallet
    desc: Monero wallet address pattern
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: yara
      source: |
        rule monero_wallet {
          strings:
            // Monero wallets: 95 chars starting with 4 or 8
            // Use proper Base58 alphabet (no 0, O, I, l)
            $wallet_4 = /4[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]{94}/ ascii
            $wallet_8 = /8[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]{94}/ ascii
            // Require strong mining context - "pool" alone is too generic (sync.Pool)
            $mining_ctx1 = "stratum" ascii nocase
            $mining_ctx2 = "xmrig" ascii nocase
            $mining_ctx3 = "miner" ascii nocase
            $mining_ctx4 = "mining.subscribe" ascii
            $mining_ctx5 = "cryptonight" ascii nocase
            // Go runtime markers (exclude)
            $go1 = "runtime.goexit" ascii
            $go2 = "go.runtime" ascii
          condition:
            not any of ($go*) and
            (any of ($wallet*)) and (any of ($mining_ctx*))
        }

  # CPU/GPU mining indicators
  # NOTE: hugepages+threads alone is NOT sufficient - glibc and Go runtime contain these strings
  # Requires strong mining-specific context to avoid false positives
  - id: cryptominer/hardware-mining
    description: Hardware mining configuration
    crit: suspicious
    confidence: 0.8
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule hardware_mining {
          strings:
            $hugepages = "hugepages" ascii nocase
            $threads = "threads" ascii
            $opencl = "OpenCL" ascii
            $cuda = "CUDA" ascii
            $hashrate = "hashrate" ascii nocase
            // Mining-specific context - "pool" alone is too generic (sync.Pool, etc)
            // Require stronger mining indicators
            $miner_ctx1 = "RandomX" ascii
            $miner_ctx2 = "stratum" ascii nocase
            $miner_ctx3 = "mining" ascii nocase
            $miner_ctx4 = "cn/" ascii
            $miner_ctx5 = "xmrig" ascii nocase
            $miner_ctx6 = "miner" ascii nocase
            $miner_ctx7 = "hashrate" ascii nocase
            // Go runtime markers (exclude)
            $go1 = "runtime.goexit" ascii
            $go2 = "go.runtime" ascii
          condition:
            not any of ($go*) and
            ((($opencl or $cuda) and $hashrate) or
             (($hugepages or $threads) and 2 of ($miner_ctx*)))
        }

  # Known mining pools
  - id: cryptominer/known-pools
    description: Known cryptocurrency mining pool domains
    crit: suspicious
    confidence: 0.9
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: yara
      source: |
        rule known_pools {
          strings:
            $pool1 = "xmrpool.eu" ascii
            $pool2 = "minexmr.com" ascii
            $pool3 = "supportxmr.com" ascii
            $pool4 = "nanopool.org" ascii
            $pool5 = "f2pool.com" ascii
            $pool6 = "hashvault.pro" ascii
            $pool7 = "pool.minergate.com" ascii
            $pool8 = "moneroocean.stream" ascii
          condition:
            any of them
        }

composite_rules:
  # Full cryptominer deployment
  - id: cryptominer/active-miner
    description: Active cryptocurrency miner
    crit: hostile
    confidence: 0.95
    mbc: "B0014"
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    requires_any:
      - id: cryptominer/xmrig
      - id: cryptominer/stratum
    requires_all:
      - id: cryptominer/known-pools
