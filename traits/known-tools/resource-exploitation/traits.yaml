# Cryptominer Detection
# Detects cryptocurrency mining malware
# ATT&CK: T1496 (Resource Hijacking)

traits:
  # XMRig miner
  - id: cryptominer/xmrig
    description: XMRig cryptocurrency miner
    crit: suspicious
    confidence: 0.95
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule xmrig {
          strings:
            $xmrig = "xmrig" ascii nocase
            $randomx = "RandomX" ascii
            $cn_variant = "cn/" ascii
            $pool = "stratum+tcp://" ascii
          condition:
            $xmrig or ($randomx and $pool) or ($cn_variant and $pool)
        }

  # Generic Stratum mining protocol
  - id: cryptominer/stratum
    description: Stratum mining protocol usage
    crit: suspicious
    confidence: 0.85
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: yara
      source: |
        rule stratum_protocol {
          strings:
            $stratum = "stratum" ascii nocase
            $mining_subscribe = "mining.subscribe" ascii
            $mining_authorize = "mining.authorize" ascii
            $mining_submit = "mining.submit" ascii
            $pool_port = ":3333" ascii
            $pool_port2 = ":14433" ascii
          condition:
            $stratum or any of ($mining_*) or any of ($pool_port*)
        }

  # Monero wallet patterns
  # NOTE: Monero wallets are 95 chars starting with 4 or 8, but hex-encoded URLs
  # can accidentally match this pattern. Require wallet-like context to reduce FPs.
  - id: cryptominer/monero-wallet
    description: Monero wallet address pattern
    crit: suspicious
    confidence: 0.9
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: yara
      source: |
        rule monero_wallet {
          strings:
            // Monero wallets: 95 chars starting with 4 or 8
            $wallet_4 = /4[0-9A-HJ-NP-Za-km-z]{94}/ ascii
            $wallet_8 = /8[0-9A-HJ-NP-Za-km-z]{94}/ ascii
            // Context to reduce false positives from hex-encoded URLs
            // Hex URLs often contain sequences like "3a2f2f" (://), "2e" (.), "2f" (/)
            $hex_url_marker1 = "3a2f2f" ascii  // ://
            $hex_url_marker2 = "68747470" ascii  // http
            $hex_url_marker3 = "2f66696c65" ascii  // /file
            // Mining context (increases confidence)
            $mining_ctx1 = "pool" ascii nocase
            $mining_ctx2 = "stratum" ascii nocase
            $mining_ctx3 = "xmrig" ascii nocase
            $mining_ctx4 = "miner" ascii nocase
            $mining_ctx5 = "wallet" ascii nocase
          condition:
            (any of ($wallet*)) and
            (none of ($hex_url_marker*)) and
            (any of ($mining_ctx*) or filesize < 50KB)
        }

  # CPU/GPU mining indicators
  # NOTE: hugepages+threads alone is NOT sufficient - glibc contains these strings
  # Requires additional mining-specific context to avoid false positives
  - id: cryptominer/hardware-mining
    description: Hardware mining configuration
    crit: suspicious
    confidence: 0.8
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule hardware_mining {
          strings:
            $hugepages = "hugepages" ascii nocase
            $threads = "threads" ascii
            $opencl = "OpenCL" ascii
            $cuda = "CUDA" ascii
            $hashrate = "hashrate" ascii nocase
            // Mining-specific context required to avoid glibc false positives
            $miner_ctx1 = "RandomX" ascii
            $miner_ctx2 = "stratum" ascii nocase
            $miner_ctx3 = "mining" ascii nocase
            $miner_ctx4 = "pool" ascii
            $miner_ctx5 = "cn/" ascii
            $miner_ctx6 = "xmrig" ascii nocase
          condition:
            (($opencl or $cuda) and $hashrate) or
            (($hugepages or $threads) and any of ($miner_ctx*))
        }

  # Known mining pools
  - id: cryptominer/known-pools
    description: Known cryptocurrency mining pool domains
    crit: suspicious
    confidence: 0.9
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: yara
      source: |
        rule known_pools {
          strings:
            $pool1 = "xmrpool.eu" ascii
            $pool2 = "minexmr.com" ascii
            $pool3 = "supportxmr.com" ascii
            $pool4 = "nanopool.org" ascii
            $pool5 = "f2pool.com" ascii
            $pool6 = "hashvault.pro" ascii
            $pool7 = "pool.minergate.com" ascii
            $pool8 = "moneroocean.stream" ascii
          condition:
            any of them
        }

composite_rules:
  # Full cryptominer deployment
  - id: cryptominer/active-miner
    description: Active cryptocurrency miner
    crit: hostile
    confidence: 0.95
    mbc: "B0014"
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    requires_any:
      - id: cryptominer/xmrig
      - id: cryptominer/stratum
    requires_all:
      - id: cryptominer/known-pools
