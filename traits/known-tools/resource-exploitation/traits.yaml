# Cryptominer Detection
# Detects cryptocurrency mining malware
# ATT&CK: T1496 (Resource Hijacking)

traits:
  # === XMRig Miner ===
  - id: xmrig-lower
    desc: xmrig string (lowercase)
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "xmrig"

  - id: xmrig-title
    desc: Xmrig string (title case)
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "Xmrig"

  - id: xmrig-upper
    desc: XMRIG string (uppercase)
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "XMRIG"

  - id: randomx
    desc: RandomX mining algorithm
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "RandomX"

  - id: cn-variant
    desc: CryptoNight variant prefix
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      exact: "cn/"

  - id: stratum-tcp-pool
    desc: stratum+tcp:// pool connection string
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "stratum+tcp://"

  # === Stratum Protocol ===
  - id: stratum-lower
    desc: stratum string (lowercase)
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "stratum"

  - id: stratum-title
    desc: Stratum string (title case)
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Stratum"

  - id: stratum-upper
    desc: STRATUM string (uppercase)
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "STRATUM"

  - id: mining-subscribe
    desc: mining.subscribe Stratum method
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "mining.subscribe"

  - id: mining-authorize
    desc: mining.authorize Stratum method
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "mining.authorize"

  - id: mining-submit
    desc: mining.submit Stratum method
    crit: inert
    conf: 0.8
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "mining.submit"

  - id: pool-port-3333
    desc: ":3333 common mining pool port"
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: ":3333"

  - id: pool-port-14433
    desc: ":14433 common mining pool port"
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: ":14433"

  # === Monero Wallet Patterns ===
  # NOTE: Monero wallets are 95 chars starting with 4 or 8, using Base58
  # Base58 alphabet excludes: 0, O, I, l (to avoid confusion)
  # IMPORTANT: Go binaries have type strings like "8uintchanfunc..." that match regex
  - id: monero-wallet-4
    desc: Monero wallet address starting with 4
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: "4[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]{94}"

  - id: monero-wallet-8
    desc: Monero wallet address starting with 8
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: "8[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]{94}"

  # === Mining Context Strings ===
  - id: miner-lower
    desc: miner string (lowercase)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "miner"

  - id: miner-title
    desc: Miner string (title case)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Miner"

  - id: miner-upper
    desc: MINER string (uppercase)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "MINER"

  - id: cryptonight-lower
    desc: cryptonight algorithm (lowercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "cryptonight"

  - id: cryptonight-title
    desc: CryptoNight algorithm (title case)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "CryptoNight"

  - id: cryptonight-upper
    desc: CRYPTONIGHT algorithm (uppercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "CRYPTONIGHT"

  # === Go Runtime Markers (for exclusion) ===
  - id: runtime-goexit
    desc: runtime.goexit Go runtime marker
    crit: inert
    conf: 0.5
    for: [elf, macho, pe]
    if:
      type: string
      exact: "runtime.goexit"

  - id: go-runtime
    desc: go.runtime Go runtime marker
    crit: inert
    conf: 0.5
    for: [elf, macho, pe]
    if:
      type: string
      exact: "go.runtime"

  # === Hardware Mining Indicators ===
  - id: hugepages-lower
    desc: hugepages string (lowercase)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "hugepages"

  - id: hugepages-title
    desc: Hugepages string (title case)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "Hugepages"

  - id: hugepages-upper
    desc: HUGEPAGES string (uppercase)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "HUGEPAGES"

  - id: threads-string
    desc: threads string
    crit: inert
    conf: 0.5
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "threads"

  - id: opencl-string
    desc: OpenCL GPU computing framework
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "OpenCL"

  - id: cuda-string
    desc: CUDA GPU computing framework
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "CUDA"

  - id: hashrate-lower
    desc: hashrate metric (lowercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "hashrate"

  - id: hashrate-title
    desc: Hashrate metric (title case)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "Hashrate"

  - id: hashrate-upper
    desc: HASHRATE metric (uppercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      word: "HASHRATE"

  - id: mining-lower
    desc: mining string (lowercase)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "mining"

  - id: mining-title
    desc: Mining string (title case)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Mining"

  - id: mining-upper
    desc: MINING string (uppercase)
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "MINING"

  # === Known Mining Pool Domains ===
  - id: xmrpool-eu
    desc: xmrpool.eu mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "xmrpool.eu"

  - id: minexmr-com
    desc: minexmr.com mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "minexmr.com"

  - id: supportxmr-com
    desc: supportxmr.com mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "supportxmr.com"

  - id: nanopool-org
    desc: nanopool.org mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "nanopool.org"

  - id: f2pool-com
    desc: f2pool.com mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "f2pool.com"

  - id: hashvault-pro
    desc: hashvault.pro mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "hashvault.pro"

  - id: pool-minergate-com
    desc: pool.minergate.com mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "pool.minergate.com"

  - id: moneroocean-stream
    desc: moneroocean.stream mining pool
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "moneroocean.stream"

composite_rules:
  # === Helper composites ===
  - id: xmrig-keyword
    description: XMRig keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: xmrig-lower
      - id: xmrig-title
      - id: xmrig-upper

  - id: stratum-keyword
    description: Stratum keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: stratum-lower
      - id: stratum-title
      - id: stratum-upper

  - id: mining-methods
    description: Stratum mining RPC methods
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: mining-subscribe
      - id: mining-authorize
      - id: mining-submit

  - id: pool-ports
    description: Common mining pool ports
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: pool-port-3333
      - id: pool-port-14433

  - id: monero-wallets
    description: Monero wallet address patterns
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: monero-wallet-4
      - id: monero-wallet-8

  - id: miner-keyword
    description: Miner keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: miner-lower
      - id: miner-title
      - id: miner-upper

  - id: cryptonight-keyword
    description: CryptoNight keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: cryptonight-lower
      - id: cryptonight-title
      - id: cryptonight-upper

  - id: mining-context
    description: Mining-specific context strings
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: stratum-keyword
      - id: xmrig-keyword
      - id: miner-keyword
      - id: mining-subscribe
      - id: cryptonight-keyword
      - id: randomx
      - id: cn-variant

  - id: go-runtime-markers
    description: Go runtime markers (for exclusion)
    for: [elf, macho, pe]
    any:
      - id: runtime-goexit
      - id: go-runtime

  - id: hugepages-keyword
    description: Hugepages keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: hugepages-lower
      - id: hugepages-title
      - id: hugepages-upper

  - id: hashrate-keyword
    description: Hashrate keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: hashrate-lower
      - id: hashrate-title
      - id: hashrate-upper

  - id: gpu-frameworks
    description: GPU computing frameworks
    for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: opencl-string
      - id: cuda-string

  - id: mining-keyword
    description: Mining keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: mining-lower
      - id: mining-title
      - id: mining-upper

  - id: known-pool-domains
    description: Known mining pool domains
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: xmrpool-eu
      - id: minexmr-com
      - id: supportxmr-com
      - id: nanopool-org
      - id: f2pool-com
      - id: hashvault-pro
      - id: pool-minergate-com
      - id: moneroocean-stream

  # === Helper composites ===
  - id: randomx-stratum
    description: RandomX with Stratum pool
    all:
      - id: randomx
      - id: stratum-tcp-pool

  - id: cn-variant-stratum
    description: CryptoNight variant with Stratum pool
    all:
      - id: cn-variant
      - id: stratum-tcp-pool

  # === Migrated from YARA ===
  - id: cryptominer/xmrig
    description: XMRig cryptocurrency miner
    crit: suspicious
    conf: 0.95
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: xmrig-keyword
      - id: randomx-stratum
      - id: cn-variant-stratum

  - id: cryptominer/stratum
    description: Stratum mining protocol usage
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: stratum-keyword
      - id: mining-methods
      - id: pool-ports

  - id: cryptominer/monero-wallet
    desc: Monero wallet address pattern with mining context
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    all:
      - id: monero-wallets
      - id: mining-context
    none:
      - id: go-runtime-markers

  # Helper composites
  - id: gpu-hashrate
    description: GPU framework with hashrate
    all:
      - id: gpu-frameworks
      - id: hashrate-keyword

  - id: hugepages-or-threads
    description: Hugepages or threads configuration
    any:
      - id: hugepages-keyword
      - id: threads-string

  - id: mining-config
    description: Mining configuration with context
    all:
      - id: hugepages-or-threads
      - id: mining-context
        count_min: 2
  - id: cryptominer/hardware-mining
    description: Hardware mining configuration
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: gpu-hashrate
      - id: mining-config
    none:
      - id: go-runtime-markers


  # Helper composite
  - id: miner-type
    description: Cryptocurrency miner type
    any:
      - id: cryptominer/xmrig
      - id: cryptominer/stratum

  # Full cryptominer deployment
  - id: cryptominer/active-miner
    description: Active cryptocurrency miner
    crit: suspicious
    conf: 0.95
    mbc: "B0014"
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    all:
      - id: miner-type
      - id: cryptominer/known-pools
