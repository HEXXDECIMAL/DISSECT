# Hadooken Malware Detection
# ATT&CK: T1059 (Command and Scripting Interpreter)
# MBC: B0030 (Remote Access)

traits:
  # === Hadooken Name Variants ===
  - id: hadooken-lower
    desc: hadooken string (lowercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "hadooken"

  - id: hadooken-title
    desc: Hadooken string (title case)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Hadooken"

  - id: hadooken-upper
    desc: HADOOKEN string (uppercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "HADOOKEN"

  - id: hadouken-lower
    desc: hadouken string (lowercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "hadouken"

  - id: hadouken-title
    desc: Hadouken string (title case)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Hadouken"

  - id: hadouken-upper
    desc: HADOUKEN string (uppercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "HADOUKEN"

  # === Street Fighter References ===
  - id: shoryuken-lower
    desc: shoryuken string (lowercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "shoryuken"

  - id: shoryuken-title
    desc: Shoryuken string (title case)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Shoryuken"

  - id: shoryuken-upper
    desc: SHORYUKEN string (uppercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "SHORYUKEN"

  - id: tatsumaki-lower
    desc: tatsumaki string (lowercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "tatsumaki"

  - id: tatsumaki-title
    desc: Tatsumaki string (title case)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Tatsumaki"

  - id: tatsumaki-upper
    desc: TATSUMAKI string (uppercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "TATSUMAKI"

  # === Dropper Patterns ===
  - id: download-and-execute
    desc: download_and_execute function
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "download_and_execute"

  - id: wget-output
    desc: wget -O download command
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "wget -O"

  - id: curl-output
    desc: curl -o download command
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "curl -o"

  # === Mining Tools ===
  # Note: xmrig case variants already defined in parent traits file
  - id: minerd-tool
    desc: minerd mining daemon
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "minerd"

  - id: cpuminer-tool
    desc: cpuminer mining tool
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "cpuminer"

  # === Pool Configuration ===
  # Note: stratum+ already defined in kinsing traits
  - id: pool-dot
    desc: pool. domain prefix pattern
    crit: inert
    conf: 0.65
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "pool."

  # === Persistence Mechanisms ===
  - id: crontab-command
    desc: crontab cron scheduling command
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "crontab"

  - id: etc-cron-path
    desc: /etc/cron directory path
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "/etc/cron"

  # === IRC Bot Commands ===
  - id: irc-privmsg
    desc: PRIVMSG IRC command
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "PRIVMSG"

  - id: irc-nick
    desc: NICK IRC command with space
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "NICK "

  - id: irc-join
    desc: JOIN # IRC channel join
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "JOIN #"

  # === Shell Execution Functions ===
  - id: system-call
    desc: system( function call
    crit: inert
    conf: 0.65
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "system("

  - id: exec-call
    desc: exec( function call
    crit: inert
    conf: 0.65
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "exec("

  - id: popen-call
    desc: popen( function call
    crit: inert
    conf: 0.65
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      exact: "popen("

composite_rules:
  # === Helper composites ===
  - id: hadooken-keyword
    description: Hadooken keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-lower
      - id: hadooken-title
      - id: hadooken-upper

  - id: hadouken-keyword
    description: Hadouken keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadouken-lower
      - id: hadouken-title
      - id: hadouken-upper

  - id: hadooken-names
    description: Hadooken name variants
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-keyword
      - id: hadouken-keyword

  - id: shoryuken-keyword
    description: Shoryuken keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: shoryuken-lower
      - id: shoryuken-title
      - id: shoryuken-upper

  - id: tatsumaki-keyword
    description: Tatsumaki keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: tatsumaki-lower
      - id: tatsumaki-title
      - id: tatsumaki-upper

  - id: street-fighter-refs
    description: Street Fighter references
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: shoryuken-keyword
      - id: tatsumaki-keyword

  - id: dropper-patterns
    description: Download and execute patterns
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: download-and-execute
      - id: wget-output
      - id: curl-output

  - id: mining-tools
    description: Cryptocurrency mining tools
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: minerd-tool
      - id: cpuminer-tool

  - id: pool-config
    description: Mining pool configuration patterns
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: pool-dot

  - id: persistence-methods
    description: Persistence mechanisms
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: crontab-command
      - id: etc-cron-path

  - id: irc-commands
    description: IRC bot commands
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: irc-privmsg
      - id: irc-nick
      - id: irc-join

  - id: shell-execution
    description: Shell command execution functions
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: system-call
      - id: exec-call
      - id: popen-call

  # === Helper composite ===
  - id: street-fighter-dropper
    description: Street Fighter references with dropper patterns
    all:
      - id: street-fighter-refs
      - id: dropper-patterns

  # === Migrated from YARA ===
  - id: dropper/hadooken/generic
    description: Hadooken malware dropper patterns
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1059"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-names
      - id: street-fighter-dropper

  - id: mining-deployment
    description: Mining tools with pool config and persistence
    all:
      - id: mining-tools
      - id: pool-config
      - id: persistence-methods

  - id: dropper/hadooken/miner
    description: Hadooken cryptominer deployment
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-keyword
      - id: mining-deployment

  - id: irc-webshell
    description: IRC commands with shell execution
    all:
      - id: irc-commands
        count: 2
      - id: shell-execution

  - id: dropper/hadooken/webshell
    description: Hadooken webshell deployment
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-keyword
      - id: irc-webshell

  # Hadooken detection
  - id: dropper/hadooken/detected
    description: Hadooken malware detected
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1059"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: dropper/hadooken/generic
      - id: dropper/hadooken/miner
      - id: dropper/hadooken/webshell
