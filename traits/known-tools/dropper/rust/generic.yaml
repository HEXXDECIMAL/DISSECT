# Generalized Rust Dropper/Stager
# Detects Rust binaries combining HTTP downloads with file system and execution capabilities.
# ATT&CK: T1105 (Ingress Tool Transfer), T1059 (Command and Scripting Interpreter)

traits:
  - id: dropper/rust/http-client
    description: "Rust HTTP client library detected (binary-based)"
    crit: inert
    conf: 0.8
    condition:
      type: yara
      source: |
        rule rust_http_libs {
          strings:
            $reqwest = "reqwest" ascii
            $ureq = "ureq" ascii
            $hyper = "hyper" ascii
            $surf = "surf" ascii
            $curl = "curl-rust" ascii
          condition:
            any of them
        }

  - id: dropper/rust/file-execution
    description: "Rust process execution capability"
    crit: inert
    conf: 0.8
    condition:
      type: yara
      source: |
        rule rust_exec {
          strings:
            $s1 = "std::process::Command" ascii
            $s2 = "Command::new" ascii
            $s3 = "std::process::Child" ascii
          condition:
            any of them
        }

  - id: dropper/rust/fs-ops
    description: "Rust file system operations (write/create)"
    crit: inert
    conf: 0.8
    condition:
      type: yara
      source: |
        rule rust_fs {
          strings:
            $s1 = "std::fs::File::create" ascii
            $s2 = "std::fs::write" ascii
            $s3 = "std::fs::OpenOptions" ascii
            $s4 = "std::io::copy" ascii
          condition:
            any of them
        }

  - id: dropper/rust/small-binary
    description: "Small Rust binary (typical of droppers/stagers)"
    crit: inert
    conf: 0.6
    condition:
      type: yara
      source: |
        rule rust_small_binary {
          condition:
            filesize < 5MB
        }

  - id: dropper/rust/vget-specific
    description: "Rust-based downloader (ureq) with specific artifacts"
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    file_types: [elf, macho, pe]
    condition:
      type: yara
      source: |
        rule rust_vget {
          strings:
            $lib1 = "ureq-2.12.1/src/body.rs" ascii
            $lib2 = "ureq-2.12.1/src/chunked/decoder.rs" ascii
            $lib3 = "ureq-2.12.1/src/pool.rs" ascii
            $url = "https://fixupcount.s3.dualstack.ap-northeast-1.amazonaws.com/wehn/rich.png" ascii
            $user = "/Users/cosmanking/.cargo/registry/src/" ascii
          condition:
            $url or ($user and 2 of ($lib*))
        }

  - id: dropper/rust/stager/ureq-user-agent
    description: "Specific User-Agent string from ureq/vget"
    crit: notable
    conf: 0.7
    condition:
      type: string
      exact: "User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_8; en-us) AppleWebKit/534.50 (KHTML, like Gecko) Version/5.1 Safari/534.50"

  - id: dropper/rust/stager/s3-url
    description: "Reference to S3 bucket used for staging"
    crit: suspicious
    conf: 0.8
    condition:
      type: string
      regex: "s3.{0,50}amazonaws.com"

  - id: dropper/rust/stager/static-pie
    description: "Rust static PIE binary (evasive build type)"
    crit: notable
    conf: 0.7
    condition:
      type: yara
      source: |
        rule rust_static_pie {
          strings:
            $rust = "rustc" ascii
            $static = "static-pie" ascii
          condition:
            $rust and $static
        }

  - id: dropper/rust/https-url
    description: "HTTPS URL reference"
    crit: inert
    conf: 0.5
    condition:
      type: string
      exact: "https://"

composite_rules:
  - id: dropper/rust/stager-behavior
    description: "Rust-based Downloader/Stager behavior detected"
    crit: hostile
    conf: 0.9
    mbc: "B0030"
    attack: "T1105"
    file_types: [elf, macho, pe]
    requires_all:
      - id: dropper/rust/http-client
    requires_any:
      - id: dropper/rust/file-execution
      - id: dropper/rust/fs-ops

  - id: dropper/rust/likely-stager
    description: "Likely Rust-based stager (small binary with HTTP/exec capabilities)"
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1105"
    file_types: [elf, macho, pe]
    requires_all:
      - id: dropper/rust/http-client
      - id: dropper/rust/https-url
    requires_count: 1
    any:
      - id: dropper/rust/file-execution
      - id: dropper/rust/fs-ops