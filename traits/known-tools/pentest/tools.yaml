# Security Tools - Penetration Testing Frameworks
# Used for both legitimate security testing and malicious purposes

traits:
  # === Atomic: Metasploit ===

  - id: metasploit-ref
    description: Metasploit framework reference
    criticality: suspicious
    confidence: 0.8
    attack: "T1588.002"
    platforms: [all]
    condition:
      type: string
      exact: "metasploit"
      case_insensitive: true

  - id: msfpayload
    description: Metasploit payload generator reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1587.001"
    platforms: [all]
    condition:
      type: string
      exact: "msfpayload"

  - id: metasploit-url
    description: Metasploit website reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1588.002"
    platforms: [all]
    condition:
      type: string
      regex: "metasploit\\.com"

  - id: meterpreter
    description: Meterpreter payload reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1059"
    platforms: [windows]
    condition:
      type: string
      regex: "/meterpreter/"

  - id: payload-label
    description: Payload label string
    criticality: inert
    confidence: 0.6
    platforms: [all]
    condition:
      type: string
      exact: "Payload: "

  - id: shh-bin-path
    description: Suspicious /shh/bin path (typosquat)
    criticality: notable
    confidence: 0.7
    platforms: [all]
    condition:
      type: string
      exact: "/shh/bin"

  # === Atomic: Network Scanners ===

  - id: nmap-ref
    description: Nmap port scanner reference
    criticality: notable
    confidence: 0.6
    attack: "T1046"
    platforms: [all]
    condition:
      type: string
      # Word boundaries to avoid matching substrings like "dynmap", "unmap", etc.
      regex: "\\bnmap\\b"

  - id: masscan-ref
    description: Masscan port scanner reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1046"
    platforms: [all]
    condition:
      type: string
      exact: "masscan"

  - id: masscan-config
    description: Masscan configuration patterns
    criticality: suspicious
    confidence: 0.85
    attack: "T1046"
    platforms: [all]
    condition:
      type: yara
      source: |
        rule masscan_config {
          strings:
            $adapter_ip = "adapter-ip"
            $nocapture = "nocapture"
            $output_format = "output-format"
            $randomize_hosts = "randomize-hosts"
          condition:
            3 of them
        }

  - id: execve-symbol
    description: execve system call symbol
    criticality: inert
    confidence: 0.9
    platforms: [linux]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "^_?execve$"

  - id: system-symbol
    description: system() function symbol
    criticality: inert
    confidence: 0.9
    platforms: [linux, macos]
    file_types: [elf, macho]
    condition:
      type: symbol
      pattern: "^_?system$"

  - id: go-exec-cmd-run
    description: Go exec.Cmd.Run method
    criticality: inert
    confidence: 0.8
    platforms: [all]
    condition:
      type: string
      exact: "exec.(*Cmd).Run"

  # === Atomic: Tunneling Tools ===

  - id: chisel-ref
    description: Chisel TCP/UDP tunnel tool
    criticality: suspicious
    confidence: 0.9
    attack: "T1572"
    platforms: [all]
    condition:
      type: string
      exact: "jpillora/chisel"

  - id: chisel-functions
    description: Chisel tunnel tool function signatures
    criticality: suspicious
    confidence: 0.85
    attack: "T1572"
    platforms: [all]
    condition:
      type: yara
      source: |
        rule chisel_functions {
          strings:
            $f1 = "tlsLetsEncrypt"
            $f2 = "authUser"
            $f3 = "handleWebsocket"
            $f4 = "tlsKeyCert"
            $f5 = "tunnel_out_ssh"
          condition:
            3 of them
        }

  # === Atomic: Venom RAT ===

  - id: venom-dliv3
    description: Venom Dliv3 GitHub reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1090"
    platforms: [all]
    condition:
      type: string
      exact: "Dliv3/Venom"

  - id: venom-agent-path
    description: Venom agent path reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1090"
    platforms: [all]
    condition:
      type: string
      exact: "/Venom/agent"

  - id: venom-agent-name
    description: Venom agent name reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1090"
    platforms: [all]
    condition:
      type: string
      exact: "venom_agent"

  # === Atomic: Web Recon ===

  - id: dirbuster
    description: DirBuster directory brute-force tool
    criticality: suspicious
    confidence: 0.8
    attack: "T1595.003"
    platforms: [all]
    condition:
      type: string
      exact: "dirbuster"

  # === Atomic: SMB Tools ===

  - id: smbexec-ntlm
    description: SMBExec NTLM HASH indicator
    criticality: suspicious
    confidence: 0.85
    attack: "T1021.002"
    platforms: [all]
    condition:
      type: string
      exact: "NTLM HASH"

  - id: smbexec-hashpass
    description: SMBExec HASH PASS substitution indicator
    criticality: suspicious
    confidence: 0.85
    attack: "T1021.002"
    platforms: [all]
    condition:
      type: string
      exact: "HASH PASS: Substituting"

  # === Atomic: Process Snooping ===

  - id: pspy-ref
    description: pspy process snooping tool
    criticality: suspicious
    confidence: 0.9
    attack: "T1057"
    platforms: [linux]
    condition:
      type: string
      exact: "dominicbreuker/pspy"

  - id: pspy-functions
    description: pspy tool function signatures
    criticality: suspicious
    confidence: 0.8
    attack: "T1057"
    platforms: [linux]
    condition:
      type: yara
      source: |
        rule pspy_functions {
          strings:
            $f1 = "startFSW"
            $f2 = "startPSS"
            $f3 = "triggerEvery"
          condition:
            2 of them
        }

composite_rules:
  # Venom RAT composite
  - id: venom-ref
    description: Venom multi-hop proxy/RAT reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1090"
    platforms: [all]
    requires_count: 1
    conditions:
      - id: venom-dliv3
      - id: venom-agent-path
      - id: venom-agent-name

  # SMBExec composite
  - id: smbexec
    description: SMBExec remote command execution
    criticality: suspicious
    confidence: 0.9
    attack: "T1021.002"
    platforms: [all]
    requires_count: 1
    conditions:
      - id: smbexec-ntlm
      - id: smbexec-hashpass

  # Execution capability group
  - id: exec-capability
    description: Command execution capability
    criticality: inert
    confidence: 0.7
    requires_count: 1
    conditions:
      - id: execve-symbol
      - id: system-symbol
      - id: go-exec-cmd-run

  - id: metasploit-payload
    description: Metasploit payload detected
    criticality: suspicious
    confidence: 0.95
    attack: "T1587.001"
    file_types: [all]
    requires_count: 2
    conditions:
      - id: msfpayload
      - id: metasploit-url
      - id: payload-label
      - id: shh-bin-path

  - id: masscan-execution
    description: Masscan scanner execution
    criticality: suspicious
    confidence: 0.9
    attack: "T1046"
    platforms: [linux]
    file_types: [elf]
    requires_all:
      - id: masscan-ref
      - id: exec-capability
