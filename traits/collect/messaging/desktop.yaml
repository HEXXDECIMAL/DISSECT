# Desktop Messaging Application Data Collection
# Detects theft of messaging app local data
# ATT&CK: T1005 (Data from Local System)

defaults:
  attack: "T1005"
  criticality: suspicious

traits:
  # === Telegram Desktop ===

  - id: telegram-tdata
    description: "Telegram Desktop tdata directory"
    confidence: 0.9
    condition:
      type: string
      regex: "Telegram Desktop/tdata|Telegram/tdata"

  - id: telegram-key-datas
    description: "Telegram Desktop key_datas file"
    confidence: 0.9
    condition:
      type: string
      exact: "key_datas"

  - id: telegram-map
    description: "Telegram Desktop map files"
    confidence: 0.85
    condition:
      type: string
      regex: "D877F783D5D3EF8C|map[0-9]"

  # === Discord Desktop ===

  - id: discord-leveldb
    description: "Discord LevelDB storage"
    confidence: 0.85
    condition:
      type: string
      regex: "discord/Local Storage/leveldb|Discord/Local Storage/leveldb"

  - id: discord-ldb
    description: "Discord LDB database files"
    confidence: 0.8
    condition:
      type: string
      regex: "\\.ldb$|\\.log$"

  # === Signal Desktop ===

  - id: signal-config
    description: "Signal Desktop configuration"
    confidence: 0.85
    condition:
      type: string
      regex: "Signal/config\\.json|Signal/sql/db\\.sqlite"

  # === Slack Desktop ===

  - id: slack-storage
    description: "Slack Desktop storage"
    confidence: 0.85
    condition:
      type: string
      regex: "Slack/storage|Slack/IndexedDB"

  # === WhatsApp Desktop ===

  - id: whatsapp-storage
    description: "WhatsApp Desktop storage"
    confidence: 0.85
    condition:
      type: string
      regex: "WhatsApp/IndexedDB|WhatsApp/Local Storage"

composite_rules:
  # Telegram data theft
  - id: telegram-theft
    description: "Telegram Desktop session/data theft"
    criticality: suspicious
    confidence: 0.95
    attack: "T1005"
    file_types: [shell, python, applescript, macho, elf, pe]
    requires_all:
      - {id: telegram-tdata}

  # Discord data theft
  - id: discord-theft
    description: "Discord Desktop data theft"
    criticality: suspicious
    confidence: 0.9
    attack: "T1005"
    file_types: [shell, python, javascript, macho, elf, pe]
    requires_all:
      - {id: discord-leveldb}

  # Multi-messenger theft
  - id: multi-messenger
    description: "Multiple messaging apps targeted"
    criticality: suspicious
    confidence: 0.95
    attack: "T1005"
    file_types: [shell, python, applescript, macho, elf, pe]
    requires_count: 2
    conditions:
      - {id: telegram-tdata}
      - {id: discord-leveldb}
      - {id: signal-config}
      - {id: slack-storage}
      - {id: whatsapp-storage}
