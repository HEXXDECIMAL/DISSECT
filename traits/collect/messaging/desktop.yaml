# Desktop Messaging Application Data Collection
# Detects theft of messaging app local data
# ATT&CK: T1005 (Data from Local System)

defaults:
  attack: "T1005"
  crit: suspicious

traits:
  # === Telegram Desktop atomic indicators ===

  - id: telegram-tdata-desktop
    desc: Telegram Desktop tdata path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Telegram Desktop/tdata"

  - id: telegram-tdata-short
    desc: Telegram tdata path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Telegram/tdata"

  - id: telegram-key-datas
    desc: "Telegram Desktop key_datas file"
    conf: 0.9
    if:
      type: string
      exact: "key_datas"

  - id: telegram-map-hash
    desc: Telegram map file hash
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "D877F783D5D3EF8C"

  - id: telegram-map-numbered
    desc: Telegram numbered map files
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "/map[0-9]{1,2}"

  # === Discord Desktop atomic indicators ===

  - id: discord-leveldb-lower
    desc: Discord LevelDB storage (lowercase)
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "discord/Local Storage/leveldb"

  - id: discord-leveldb-upper
    desc: Discord LevelDB storage (capitalized)
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Discord/Local Storage/leveldb"

  - id: discord-ldb-ext
    desc: LDB database extension
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "\\.ldb$"

  - id: discord-log-ext
    desc: Log file extension
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "\\.log$"

  # === Signal Desktop atomic indicators ===

  - id: signal-config-json
    desc: Signal config.json path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Signal/config.json"

  - id: signal-sql-db
    desc: Signal SQLite database path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Signal/sql/db.sqlite"

  # === Slack Desktop atomic indicators ===

  - id: slack-storage-path
    desc: Slack storage path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Slack/storage"

  - id: slack-indexeddb-path
    desc: Slack IndexedDB path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Slack/IndexedDB"

  # === WhatsApp Desktop atomic indicators ===

  - id: whatsapp-indexeddb-path
    desc: WhatsApp IndexedDB path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "WhatsApp/IndexedDB"

  - id: whatsapp-localstorage-path
    desc: WhatsApp Local Storage path
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "WhatsApp/Local Storage"

composite_rules:
  # Telegram tdata composite
  - id: telegram-tdata
    desc: Telegram Desktop tdata directory
    crit: suspicious
    conf: 0.9
    count: 1
    any:
      - id: telegram-tdata-desktop
      - id: telegram-tdata-short

  # Telegram map composite
  - id: telegram-map
    desc: Telegram Desktop map files
    crit: suspicious
    conf: 0.85
    all:
      - id: telegram-tdata
    any:
      - id: telegram-map-hash
      - id: telegram-map-numbered

  # Discord leveldb composite
  - id: discord-leveldb
    desc: Discord LevelDB storage
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: discord-leveldb-lower
      - id: discord-leveldb-upper

  # Discord ldb composite
  - id: discord-ldb
    desc: Discord LDB database files
    crit: notable
    conf: 0.8
    count: 1
    any:
      - id: discord-ldb-ext
      - id: discord-log-ext

  # Signal config composite
  - id: signal-config
    desc: Signal Desktop configuration
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: signal-config-json
      - id: signal-sql-db

  # Slack storage composite
  - id: slack-storage
    desc: Slack Desktop storage
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: slack-storage-path
      - id: slack-indexeddb-path

  # WhatsApp storage composite
  - id: whatsapp-storage
    desc: WhatsApp Desktop storage
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: whatsapp-indexeddb-path
      - id: whatsapp-localstorage-path

  # Telegram data theft
  - id: telegram-theft
    desc: "Telegram Desktop session/data theft"
    crit: suspicious
    conf: 0.95
    attack: "T1005"
    for: [shell, python, applescript, macho, elf, pe]
    all:
      - id: telegram-tdata

  # Discord data theft
  - id: discord-theft
    desc: "Discord Desktop data theft"
    crit: suspicious
    conf: 0.9
    attack: "T1005"
    for: [shell, python, javascript, macho, elf, pe]
    all:
      - id: discord-leveldb

  # Multi-messenger theft
  - id: multi-messenger
    desc: "Multiple messaging apps targeted"
    crit: suspicious
    conf: 0.95
    attack: "T1005"
    for: [shell, python, applescript, macho, elf, pe]
    count: 2
    any:
      - id: telegram-tdata
      - id: discord-leveldb
      - id: signal-config
      - id: slack-storage
      - id: whatsapp-storage