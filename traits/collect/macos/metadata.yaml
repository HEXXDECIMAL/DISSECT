# macOS Metadata and System Files Collection
# Detects targeting of macOS-specific files and directories
# ATT&CK: T1083 (File and Directory Discovery), T1005 (Data from Local System)

defaults:
  platforms: [macos]
  attack: "T1083"
  crit: notable

traits:
  # === macOS metadata files ===
  - id: ds-store
    desc: ".DS_Store metadata files"
    crit: notable
    conf: 0.8
    attack: "T1083"
    if:
      type: string
      exact: ".DS_Store"

  - id: localized-folder
    desc: ".localized folder marker"
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: ".localized"

  # === macOS system directories ===
  - id: applications-dir
    desc: "/Applications directory reference"
    crit: notable
    conf: 0.7
    attack: "T1083"
    if:
      type: string
      exact: "/Applications"

  - id: library-dir
    desc: "~/Library directory reference"
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "/Library\\b|~/Library"

  - id: downloads-dir
    desc: "~/Downloads directory reference"
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "/Downloads\\b|~/Downloads"

  - id: documents-dir
    desc: "~/Documents directory reference"
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "/Documents\\b|~/Documents"

  # === Environment variable access ===
  - id: home-env
    desc: "HOME environment variable"
    crit: inert
    conf: 0.5
    attack: "T1083"
    if:
      type: string
      exact: "HOME"

  - id: getenv-func
    desc: "Reads variables via getenv"
    crit: inert
    conf: 0.4
    for: [macho]
    if:
      type: symbol
      pattern: "getenv"

composite_rules:
  # macOS user directory enumeration
  - id: user-directory-enum
    desc: "Enumerates macOS user directories"
    crit: notable
    conf: 0.8
    attack: "T1083"
    count_min: 2
    any:
      - id: applications-dir
      - id: library-dir
      - id: downloads-dir
      - id: documents-dir
      - id: home-env

  # Metadata collection pattern
  - id: metadata-collection
    desc: "Collects macOS metadata files"
    crit: suspicious
    conf: 0.85
    attack: "T1083"
    all:
      - id: ds-store
    count_min: 1
    any:
      - id: user-directory-enum
      - id: fs/directory/traverse
