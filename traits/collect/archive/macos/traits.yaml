# macOS Data Collection and Archiving Detection
# Detects data staging techniques on macOS
# ATT&CK: T1560 (Archive Collected Data), T1074 (Data Staged)

defaults:
  attack: "T1560"
  platforms: [macos]

traits:
  # === ditto compression atomic indicators ===
  - id: ditto-ck-flags
    description: ditto -c -k compression flags
    criticality: inert
    confidence: 0.7
    attack: "T1560.001"
    condition:
      type: string
      regex: "ditto\\s+-c\\s+-k"

  - id: ditto-sequester
    description: ditto --sequesterRsrc flag
    criticality: inert
    confidence: 0.7
    attack: "T1560.001"
    condition:
      type: string
      exact: "--sequesterRsrc"

  - id: ditto-zip-output
    description: ditto with .zip output
    criticality: inert
    confidence: 0.7
    attack: "T1560.001"
    condition:
      type: string
      regex: "ditto.*\\.zip"

  # ditto for directory copy
  - id: ditto-copy
    description: "macOS ditto directory copy"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "ditto\\s+[^-]"

  # hdiutil for disk image creation
  - id: hdiutil-create
    description: "macOS disk image creation"
    criticality: notable
    confidence: 0.75
    attack: "T1560.001"
    condition:
      type: string
      regex: "hdiutil\\s+create|hdiutil.*-format"

  # === tar/gzip atomic indicators ===
  - id: tar-create-flag
    description: tar create/compress flags
    criticality: inert
    confidence: 0.5
    attack: "T1560.001"
    condition:
      type: string
      regex: "tar\\s+-[a-z]*[cz]"

  - id: tar-create-long
    description: tar --create long option
    criticality: inert
    confidence: 0.5
    attack: "T1560.001"
    condition:
      type: string
      exact: "tar --create"

  - id: gzip-compress
    description: gzip compression
    criticality: inert
    confidence: 0.5
    attack: "T1560.001"
    condition:
      type: string
      regex: "gzip\\s+-"

  # zip command
  - id: zip-compress
    description: "zip archive creation"
    criticality: notable
    confidence: 0.65
    attack: "T1560.001"
    condition:
      type: string
      regex: "\\bzip\\s+-[r0-9]|unzip\\s+-o"

  # === /tmp staging atomic indicators ===
  - id: tmp-zip-file
    description: .zip file in /tmp
    criticality: inert
    confidence: 0.6
    attack: "T1074.001"
    condition:
      type: string
      regex: "/tmp/.*\\.zip"

  - id: tmp-tar-file
    description: .tar file in /tmp
    criticality: inert
    confidence: 0.6
    attack: "T1074.001"
    condition:
      type: string
      regex: "/tmp/.*\\.tar"

  - id: tmp-gz-file
    description: .gz file in /tmp
    criticality: inert
    confidence: 0.6
    attack: "T1074.001"
    condition:
      type: string
      regex: "/tmp/.*\\.gz"

  - id: tmp-dmg-file
    description: .dmg file in /tmp
    criticality: inert
    confidence: 0.6
    attack: "T1074.001"
    condition:
      type: string
      regex: "/tmp/.*\\.dmg"

  - id: tmp-out-file
    description: /tmp/out. output file
    criticality: inert
    confidence: 0.6
    attack: "T1074.001"
    condition:
      type: string
      exact: "/tmp/out."

  # === Network upload atomic indicators ===
  - id: curl-cmd
    description: curl command
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      exact: "curl"

  - id: wget-cmd
    description: wget command
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      exact: "wget"

  - id: http-post-method
    description: HTTP POST method
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      exact: "POST"

  - id: upload-keyword
    description: upload keyword
    criticality: inert
    confidence: 0.4
    condition:
      type: string
      exact: "upload"

  # Temp zip file staging
  - id: tmp-zip-staging
    description: "Zip file staged in /tmp directory"
    criticality: notable
    confidence: 0.7
    attack: "T1074.001"
    condition:
      type: string
      regex: "/tmp/.*\\.zip"

composite_rules:
  # ditto compression composite
  - id: ditto-compress
    description: "macOS ditto archive compression"
    criticality: suspicious
    confidence: 0.85
    attack: "T1560.001"
    requires_count: 1
    conditions:
      - id: ditto-ck-flags
      - id: ditto-sequester
      - id: ditto-zip-output

  # tar/gzip compression composite
  - id: tar-compress
    description: "tar archive creation"
    criticality: notable
    confidence: 0.6
    attack: "T1560.001"
    requires_count: 1
    conditions:
      - id: tar-create-flag
      - id: tar-create-long
      - id: gzip-compress

  # /tmp staging composite
  - id: tmp-directory
    description: "Data staging in /tmp"
    criticality: notable
    confidence: 0.7
    attack: "T1074.001"
    requires_count: 1
    conditions:
      - id: tmp-zip-file
      - id: tmp-tar-file
      - id: tmp-gz-file
      - id: tmp-dmg-file
      - id: tmp-out-file

  # Network upload composite
  - id: network-upload
    description: "Network upload or exfiltration command"
    criticality: notable
    confidence: 0.7
    requires_count: 1
    conditions:
      - id: curl-cmd
      - id: wget-cmd
      - id: http-post-method
      - id: upload-keyword

  # Archive + exfiltration pattern
  - id: stealer-pattern
    description: "Data collection and archiving for exfiltration"
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1560.001"
    file_types: [shell]
    requires_all:
      - id: ditto-compress
    requires_any:
      - id: network-upload
      - id: tmp-zip-staging
