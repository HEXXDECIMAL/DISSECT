# Collection - Archive Operations
# ATT&CK: T1560 (Archive Collected Data)

defaults:
  # Archive commands can be embedded in any file type
  for: ["*"]

traits:
  # === Tar Operations ===

  - id: tar-create
    desc: Creates tar archive
    crit: notable
    conf: 0.6
    attack: "T1560"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "tar\\s+-c"

  - id: tar-current-dir
    desc: Archives current directory
    crit: suspicious
    conf: 0.75
    attack: "T1560"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "tar\\s+-c\\w*\\s+\\."

  - id: tar-from-file
    desc: Tar with file list input
    crit: suspicious
    conf: 0.7
    attack: "T1560"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "tar\\s+-[rT]"

  # === Zip Operations ===

  - id: zip-create
    desc: Creates zip archive
    crit: notable
    conf: 0.6
    attack: "T1560"
    platforms: [all]
    if:
      type: string
      regex: "zip\\s+-[rX]"

  # === Zip library atomic indicators ===
  - id: go-archive-zip
    desc: Go archive/zip package
    crit: inert
    conf: 0.5
    attack: "T1560"
    platforms: [all]
    for: [go, elf, macho, pe]
    if:
      type: string
      exact: "archive/zip"

  - id: rust-zip-writer
    desc: Rust zip_writer usage
    crit: inert
    conf: 0.5
    attack: "T1560"
    platforms: [all]
    for: [rust, elf, macho, pe]
    if:
      type: string
      exact: "zip_writer"

  - id: python-zipfile
    desc: Python zipfile module
    crit: inert
    conf: 0.5
    attack: "T1560"
    platforms: [all]
    for: [python, elf, macho, pe]
    if:
      type: string
      exact: "zipfile"

  - id: zip64-format
    desc: ZIP64 format reference
    crit: inert
    conf: 0.5
    attack: "T1560"
    platforms: [all]
    if:
      type: string
      exact: "ZIP64"

  # === Unarchive ===

  - id: unarchive
    desc: Unarchive operation
    crit: notable
    conf: 0.5
    platforms: [all]
    if:
      type: string
      regex: "[Uu]narchive"

composite_rules:
  # Zip library composite
  - id: zip-library
    desc: ZIP library usage
    crit: notable
    conf: 0.6
    attack: "T1560"
    platforms: [all]
    count: 1
    any:
      - id: go-archive-zip
      - id: rust-zip-writer
      - id: python-zipfile
      - id: zip64-format

  - id: binary-tar-exec
    desc: Binary executes tar command (not script)
    crit: suspicious
    conf: 0.8
    attack: "T1560"
    platforms: [linux, macos, unix]
    for: [elf, macho]
    any:
      - id: tar-create
      - id: tar-from-file
