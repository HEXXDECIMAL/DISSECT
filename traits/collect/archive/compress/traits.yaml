# Collection - Archive Operations
# ATT&CK: T1560 (Archive Collected Data)

defaults:
  # Archive commands can be embedded in any file type
  file_types: [*]

traits:
  # === Tar Operations ===

  - id: tar-create
    description: Creates tar archive
    criticality: notable
    confidence: 0.6
    attack: "T1560"
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "tar\\s+-c"

  - id: tar-current-dir
    description: Archives current directory
    criticality: suspicious
    confidence: 0.75
    attack: "T1560"
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "tar\\s+-c\\w*\\s+\\."

  - id: tar-from-file
    description: Tar with file list input
    criticality: suspicious
    confidence: 0.7
    attack: "T1560"
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "tar\\s+-[rT]"

  # === Zip Operations ===

  - id: zip-create
    description: Creates zip archive
    criticality: notable
    confidence: 0.6
    attack: "T1560"
    platforms: [all]
    condition:
      type: string
      regex: "zip\\s+-[rX]"

  # === Zip library atomic indicators ===
  - id: go-archive-zip
    description: Go archive/zip package
    criticality: inert
    confidence: 0.5
    attack: "T1560"
    platforms: [all]
    file_types: [go, elf, macho, pe]
    condition:
      type: string
      exact: "archive/zip"

  - id: rust-zip-writer
    description: Rust zip_writer usage
    criticality: inert
    confidence: 0.5
    attack: "T1560"
    platforms: [all]
    file_types: [rust, elf, macho, pe]
    condition:
      type: string
      exact: "zip_writer"

  - id: python-zipfile
    description: Python zipfile module
    criticality: inert
    confidence: 0.5
    attack: "T1560"
    platforms: [all]
    file_types: [python, elf, macho, pe]
    condition:
      type: string
      exact: "zipfile"

  - id: zip64-format
    description: ZIP64 format reference
    criticality: inert
    confidence: 0.5
    attack: "T1560"
    platforms: [all]
    condition:
      type: string
      exact: "ZIP64"

  # === Unarchive ===

  - id: unarchive
    description: Unarchive operation
    criticality: notable
    confidence: 0.5
    platforms: [all]
    condition:
      type: string
      regex: "[Uu]narchive"

composite_rules:
  # Zip library composite
  - id: zip-library
    description: ZIP library usage
    criticality: notable
    confidence: 0.6
    attack: "T1560"
    platforms: [all]
    requires_count: 1
    conditions:
      - id: go-archive-zip
      - id: rust-zip-writer
      - id: python-zipfile
      - id: zip64-format

  - id: binary-tar-exec
    description: Binary executes tar command (not script)
    criticality: suspicious
    confidence: 0.8
    attack: "T1560"
    platforms: [linux, macos, unix]
    file_types: [elf, macho]
    requires_any:
      - id: tar-create
      - id: tar-from-file
