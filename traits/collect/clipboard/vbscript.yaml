---
# VBScript Clipboard Hijacker Detection
# Detects clipboard monitoring and cryptocurrency address replacement
# ATT&CK: T1115 (Clipboard Data), T1649 (Steal Crypto Wallet)

defaults:
  for: [all]
  platforms: [windows]

traits:
  # === Clipboard Data Access ===
  - id: vbs-clipboard-get
    desc: Clipboard data retrieval
    crit: suspicious
    conf: 0.85
    attack: "T1115"
    if:
      type: string
      regex: 'ClipboardData\.GetData|ParentWindow\.ClipboardData'

  # === Clipboard Monitoring Loop ===
  - id: vbs-clipboard-loop
    desc: Continuous clipboard monitoring
    crit: suspicious
    conf: 0.90
    attack: "T1115"
    if:
      type: string
      regex: 'Do.*Loop|While.*True.*Clipboard|Clipboard.*sleep'

  # === Bitcoin Address Pattern ===
  - id: bitcoin-address
    desc: Bitcoin address embedded
    crit: notable
    conf: 0.80
    attack: "T1649"
    if:
      type: string
      regex: 'bc1[a-zA-Z0-9]{20,50}|1[a-zA-Z0-9]{25,35}|3[a-zA-Z0-9]{25,35}'

  # === Monero Address Pattern ===
  - id: monero-address
    desc: Monero address embedded
    crit: notable
    conf: 0.80
    attack: "T1649"
    if:
      type: string
      regex: '4[0-9AB][1-9A-HJ-NP-Za-km-z]{93}'

  # === Ethereum Address Pattern ===
  - id: ethereum-address
    desc: Ethereum address embedded
    crit: notable
    conf: 0.80
    attack: "T1649"
    if:
      type: string
      regex: '0x[a-fA-F0-9]{40}'

  # === Cryptocurrency Address Check ===
  - id: crypto-address-check
    desc: Cryptocurrency address validation
    crit: suspicious
    conf: 0.85
    attack: "T1649"
    if:
      type: string
      regex: 'Left\(.*1\)|Len\(.*26|Len\(.*35|Len\(.*95'

  # === Address Replacement ===
  - id: address-replacement
    desc: Clipboard content replacement
    crit: suspicious
    conf: 0.90
    attack: "T1649"
    if:
      type: string
      regex: 'echo.*clip|\.run.*clip|replace.*address'

  # === HTMLFile Object ===
  - id: htmlfile-object
    desc: HTMLFile object for clipboard access
    crit: notable
    conf: 0.75
    attack: "T1115"
    if:
      type: string
      regex: 'HTMLfile|CreateObject.*HTML'

composite_rules:
  # === Cryptocurrency Clipboard Hijacker ===
  - id: crypto-clipboard-hijacker
    desc: Cryptocurrency clipboard hijacker
    crit: suspicious
    conf: 0.95
    attack: "T1649"
    count_min: 4
    any:
      - id: vbs-clipboard-get
      - id: vbs-clipboard-loop
      - id: bitcoin-address
      - id: monero-address
      - id: ethereum-address
      - id: crypto-address-check
      - id: address-replacement

  # === Clipboard Monitor ===
  - id: vbs-clipboard-monitor
    desc: VBScript clipboard monitor
    crit: suspicious
    conf: 0.88
    attack: "T1115"
    count_min: 2
    any:
      - id: vbs-clipboard-get
      - id: vbs-clipboard-loop
      - id: htmlfile-object
