traits:
- id: eval-call-js
  desc: eval() function call
  crit: notable
  conf: 0.7
  attack: T1059.007
  for:
  - javascript
  - typescript
  if:
    type: symbol
    exact: eval
- id: eval-as-first-arg
  desc: eval as first argument (eval,
  crit: notable
  conf: 0.7
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    regex: \(eval\s*,
- id: eval-as-last-arg
  desc: eval as last argument ,eval)
  crit: notable
  conf: 0.7
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    regex: ',\s*eval\)'
- id: eval-variable
  desc: eval with variable argument
  crit: suspicious
  conf: 0.9
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    regex: eval\s*\(\s*[a-zA-Z_$][a-zA-Z0-9_$]*\s*\)
- id: new-function-constructor
  desc: new Function() constructor
  crit: notable
  conf: 0.8
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    regex: new\s+Function\s*\(
- id: function-constructor-call
  desc: Function() constructor call
  crit: notable
  conf: 0.8
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    regex: (?:^|[^a-zA-Z0-9_\[])Function\s*\(
- id: constructor-property-access
  desc: Constructor property access
  crit: suspicious
  conf: 0.75
  attack: T1059.007
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: \[\s*["']constructor["']\s*\]
- id: bracket-function-access
  desc: Function access via bracket notation
  crit: notable
  conf: 0.65
  attack: T1027.002
  for:
  - javascript
  if:
    type: raw
    regex: \w+\[\w+\]\s*\(
- id: bracket-property-access-var
  desc: Bracket property access with variable index
  crit: notable
  conf: 0.6
  for:
  - javascript
  if:
    type: raw
    regex: \b\w+\[[a-zA-Z_$][a-zA-Z0-9_$]*\]
    not:
      regex: \b(arr|array|coll|tasks|listeners|console|Object|this|exports|module|window)\[|\[(i|j|k|n|m|o|p|t|e|key|prop|index|idx|it)\]
  unless:
  - id: metadata/dev/testing::is-test
- id: vm-runIn-method
  desc: vm.runIn method
  crit: notable
  conf: 0.7
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    regex: vm\.runIn
- id: runInContext-call
  desc: runInContext call
  crit: notable
  conf: 0.7
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    substr: runInContext
- id: runInNewContext-call
  desc: runInNewContext call
  crit: notable
  conf: 0.7
  attack: T1059.007
  for:
  - javascript
  if:
    type: string
    substr: runInNewContext
- id: iife-pattern
  desc: Immediately invoked function expression
  crit: notable
  conf: 0.9
  for:
  - javascript
  if:
    type: raw
    regex: \(\s*(?:async\s+)?function\s*\([^)]{0,50}\)\s*\{
- id: variable-immediate-call
  desc: Variable called immediately as function
  crit: notable
  conf: 0.7
  for:
  - javascript
  if:
    type: raw
    regex: var\s+\w+\s*=\s*function\s*\([^)]{0,120}\)\s*\{|var\s+\w+\s*=\s*\(\s*\)\s*=>
- id: eval-function-definition
  desc: eval() compiling a function string
  crit: notable
  conf: 0.8
  for:
  - javascript
  if:
    type: raw
    regex: eval\s*\(\s*["']\[?function
- id: function-constructor-from-typeof
  desc: Function constructor derived from typeof
  crit: suspicious
  conf: 0.85
  attack: T1059.007
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: typeof.{0,80}charAt\(0\)\.toUpperCase\(\).{0,60}typeof.{0,80}\.slice\(1\)
composite_rules:
- id: eval-function-reference
  desc: eval passed as function reference
  crit: suspicious
  conf: 0.95
  attack: T1059.007
  for:
  - javascript
  any:
  - id: eval-as-first-arg
  - id: eval-as-last-arg
- id: Function-constructor
  desc: Function constructor usage
  crit: suspicious
  conf: 0.9
  attack: T1059.007
  mbc: B0009.016
  for:
  - javascript
  any:
  - id: new-function-constructor
  - id: function-constructor-call
  - id: constructor-property-access
  - id: function-constructor-from-typeof
  unless:
  - id: metadata/library/jquery::domain
  - id: metadata/library/jquery::version-string
  - id: metadata/library/jquery::copyright
  - id: metadata/library/jquery::fn-extend
  - id: metadata/library/d3::d3-detection
