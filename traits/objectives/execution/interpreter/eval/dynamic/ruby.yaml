# Ruby Dynamic Code Execution Detection
# Detects eval, instance_eval, and other dynamic code execution patterns
# ATT&CK: T1059.005 (Command and Scripting Interpreter: Ruby)

defaults:
  crit: notable
  attack: "T1059"
  for: [ruby]

traits:
  # === Basic Eval Patterns ===
  - id: eval-call-ruby
    desc: Ruby eval call
    crit: notable
    conf: 0.90
    if:
      type: symbol
      exact: "eval"

  - id: instance-eval
    desc: Ruby instance_eval call
    crit: notable
    conf: 0.90
    if:
      type: string
      word: "instance_eval"

  - id: class-eval
    desc: Ruby class_eval call
    crit: notable
    conf: 0.90
    if:
      type: symbol
      regex: "class_eval"

  - id: module-eval
    desc: Ruby module_eval call
    crit: notable
    conf: 0.90
    if:
      type: symbol
      regex: "module_eval"

  # === Module Monkey Patching ===
  - id: prepend-module
    desc: Ruby Module prepend
    crit: notable
    conf: 0.85
    if:
      type: raw
      regex: "\\.prepend\\s+Module\\.new"

  - id: define-method-dynamic
    desc: Ruby dynamic method definition
    crit: notable
    conf: 0.80
    if:
      type: raw
      regex: "define_method\\s*\\(\\s*:[a-z_]+"
