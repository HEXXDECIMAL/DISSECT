# Obfuscated WSH String Fragments
# Detects fragmented strings common in JScript obfuscation

defaults:
  crit: notable
  conf: 0.8
  for: [javascript, typescript, shell, vbs, html]

traits:
  - id: wscript-shell-fragment-1
    desc: WScript.Shell string fragment (WScrip/WScr)
    if:
      type: raw
      substr: 'WScr'

  - id: wscript-shell-fragment-2
    desc: WScript.Shell string fragment (Shell/Shel)
    if:
      type: raw
      regex: 't\.Shell|t\.She|\.Shel|pt\.She'

  - id: adodb-fragment-1
    desc: ADODB.Stream string fragment (ADODB/ADO)
    if:
      type: raw
      substr: 'ADO'

  - id: adodb-fragment-2
    desc: ADODB.Stream string fragment (B.Str/B.St/DB.St/ODB.St)
    if:
      type: raw
      regex: 'B\.Str|B\.St|DB\.St|ODB\.St'

  - id: filesystemobject-fragment-1a
    desc: FileSystemObject string fragment (SystemObj)
    if:
      type: raw
      substr: 'SystemObj'

  - id: filesystemobject-fragment-1b
    desc: FileSystemObject string fragment (temObj)
    if:
      type: raw
      substr: 'temObj'

  - id: filesystemobject-fragment-2
    desc: FileSystemObject string fragment (FileSystem)
    if:
      type: raw
      word: 'FileSystem'

  - id: expand-env-fragment-1
    desc: ExpandEnvironmentStrings fragment (xpandE)
    if:
      type: raw
      substr: 'xpandE'
    unless:
      - id: micro-behaviors/data/text/keywords::environment-keyword

  - id: expand-env-fragment-2
    desc: ExpandEnvironmentStrings fragment (nviron)
    if:
      type: raw
      substr: 'nviron'
    unless:
      - id: micro-behaviors/data/text/keywords::environment-keyword

  - id: response-body-fragment-1
    desc: ResponseBody fragment (ResponseB/Response)
    if:
      type: raw
      substr: 'Response'

  - id: response-body-fragment-2a
    desc: ResponseBody fragment (nseBody)
    if:
      type: raw
      substr: 'nseBody'

  - id: response-body-fragment-2b
    desc: ResponseBody fragment (onseB)
    if:
      type: raw
      substr: 'onseB'

  - id: script-fullname-fragment
    desc: WScript.ScriptFullName fragment
    if:
      type: raw
      regex: 'riptFull|tFullN|ptFul{1,2}|lName'

composite_rules:
  - id: wscript-shell-fragment
    desc: WScript.Shell string fragment
    any:
      - id: wscript-shell-fragment-1
      - id: wscript-shell-fragment-2

  - id: adodb-fragment
    desc: ADODB.Stream string fragment
    any:
      - id: adodb-fragment-1
      - id: adodb-fragment-2

  - id: filesystemobject-fragment-1
    desc: FileSystemObject string fragment (SystemObj/temObj)
    any:
      - id: filesystemobject-fragment-1a
      - id: filesystemobject-fragment-1b

  - id: filesystemobject-fragment
    desc: FileSystemObject string fragment
    any:
      - id: filesystemobject-fragment-1
      - id: filesystemobject-fragment-2

  - id: expand-env-fragment
    desc: ExpandEnvironmentStrings fragment
    any:
      - id: expand-env-fragment-1
      - id: expand-env-fragment-2

  - id: response-body-fragment-2
    desc: ResponseBody fragment (nseBody/onseB)
    any:
      - id: response-body-fragment-2a
      - id: response-body-fragment-2b

  - id: response-body-fragment
    desc: ResponseBody fragment
    any:
      - id: response-body-fragment-1
      - id: response-body-fragment-2
