# More Obfuscated WSH String Fragments
defaults:
  crit: notable
  conf: 0.8
  for: [javascript, typescript, shell, vbs, html]

traits:
  # save-to-file fragments
  - id: save-to-file-fragment-saveto
    desc: SaveToFile string fragment (saveTo)
    if:
      type: raw
      substr: 'saveTo'

  - id: save-to-file-fragment-veto
    desc: SaveToFile string fragment (veTo)
    if:
      type: raw
      substr: 'veTo'

  - id: save-to-file-fragment-etof
    desc: SaveToFile string fragment (eToF)
    if:
      type: raw
      substr: 'eToF'

  # ADODB Type
  - id: type-binary-fragment
    desc: ADODB Type assignment fragment (ype =)
    if:
      type: raw
      substr: 'ype ='

  # String.fromCharCode
  - id: from-char-code-fragment-romchar
    desc: String.fromCharCode fragment (romChar)
    if:
      type: raw
      substr: 'romChar'

  - id: from-char-code-fragment-charcode
    desc: String.fromCharCode fragment (CharCode)
    if:
      type: raw
      substr: 'CharCode'

  - id: msxml-fragment-msxml
    desc: MSXML2.XMLHTTP string fragment (MSXML)
    if:
      type: raw
      word: 'MSXML'

  # WScript.Shell fragments
  - id: wscript-shell-fragment-shell
    desc: Shell string fragment
    if:
      type: raw
      word: 'Shell'

  # ADODB fragments
  - id: adodb-fragment-adodb
    desc: ADODB string fragment
    if:
      type: raw
      word: 'ADODB'

  - id: adodb-fragment-stream
    desc: Stream string fragment
    if:
      type: raw
      word: 'Stream'

composite_rules:
  - id: from-char-code-fragment
    desc: String.fromCharCode fragment
    any:
      - id: from-char-code-fragment-romchar
      - id: from-char-code-fragment-charcode
      - id: micro-behaviors/data/source/syntax/keyword::js-keyword-fromcharcode

  - id: save-to-file-fragment
    desc: SaveToFile string fragment
    any:
      - id: save-to-file-fragment-saveto
      - id: save-to-file-fragment-veto
      - id: save-to-file-fragment-etof

  - id: msxml-fragment-short
    desc: MSXML string fragment (short)
    any:
      - id: msxml-fragment-msxml
      - id: micro-behaviors/communications/http/client::http-client-any

  - id: msxml-fragment
    desc: MSXML2.XMLHTTP string fragment
    any:
      - id: msxml-fragment-short
      - id: micro-behaviors/communications/http/client::http-client-xml2-fragment

  - id: wscript-shell-fragment-short
    desc: WScript.Shell string fragment (short)
    any:
      - id: micro-behaviors/host/interpreter/jscript::is-jscript # WScript
      - id: wscript-shell-fragment-shell

  - id: adodb-fragment-short
    desc: ADODB.Stream string fragment (short)
    any:
      - id: adodb-fragment-adodb
      - id: adodb-fragment-stream

  - id: expand-env-fragment-short
    desc: ExpandEnvironmentStrings string fragment (short)
    any:
      - id: objectives/execution/interpreter/script/wsh::wsh-expand-env-strings # ExpandEnvironmentStrings
      - id: micro-behaviors/data/text/keywords::environment-keyword
