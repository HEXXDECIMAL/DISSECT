# Exact Tiny Obfuscated WSH Fragments (Variant 5)
# Detects exact tiny string constants used in fragmented obfuscation.
# High precision due to exact match requirement.

defaults:
  crit: suspicious
  conf: 0.9
  for: [javascript]

traits:
  - id: adodb-fragment-tiny-exact
    desc: Exact tiny ADODB fragments (AD, OD, DB,
    crit: notable
    if:
      type: string
      regex: '^(AD|OD|DB\.St)$'
    unless:
      - id: metadata/quality/help::usage-title

  - id: xmlhttp-fragment-tiny-exact
    desc: Exact tiny XMLHTTP fragments (XMLH, XML2., MS)
    crit: notable
    if:
      type: string
      regex: '^(XMLH|XML2\.|MS|TTP)$'
    unless:
      - id: metadata/library/jquery::domain
      - id: metadata/quality/help::usage-title

  - id: readystate-fragment-tiny-exact
    desc: Exact tiny readyState fragments (rea, dy, tate)
    crit: notable
    if:
      type: string
      regex: '^(rea|dy|tate)$'
    unless:
      - id: metadata/library/jquery::domain
      - id: metadata/quality/help::usage-title

  - id: wscript-shell-fragment-tiny-exact-1
    desc: Exact tiny WScript fragments (WScr, ipt.)
    crit: notable
    if:
      type: string
      exact: 'ipt.'
    unless:
      - id: metadata/quality/help::usage-title

  - id: wscript-shell-fragment-tiny-exact-2
    desc: Exact tiny WScript fragments (She, ll)
    crit: notable
    if:
      type: string
      regex: '^(She|ll)$'
    unless:
      - id: metadata/quality/help::usage-title

  - id: timing-fragment-tiny-exact-1
    desc: Tiny timing fragments (Sl, eep, Date)
    crit: notable
    if:
      type: string
      regex: '^(Sl|eep|Date)$'
    unless:
      - id: metadata/quality/help::usage-title

  - id: timing-fragment-tiny-exact-2
    desc: Tiny timing fragments (Mill, illi, onds)
    crit: notable
    if:
      type: string
      regex: '^(Mill|illi|onds)$'
    unless:
      - id: metadata/quality/help::usage-title

  - id: payload-handling-fragment-tiny-exact-1
    desc: Tiny payload fragments (Respo, nseBo, saveT)
    crit: notable
    if:
      type: string
      regex: '^(Respo|nseBo|saveT)$'
    unless:
      - id: metadata/quality/help::usage-title

  - id: payload-handling-fragment-tiny-exact-2
    desc: Tiny payload fragments (oFile, Expa, ndEn, viron)
    crit: notable
    if:
      type: string
      regex: '^(oFile|Expa|ndEn|viron)$'
    unless:
      - id: metadata/quality/help::usage-title

composite_rules:
  - id: wscript-shell-fragment-tiny-exact
    desc: Exact tiny WScript fragments
    crit: notable
    any:
      - id: wscript-shell-fragment-tiny-exact-1
      - id: wscript-shell-fragment-tiny-exact-2

  - id: timing-fragment-tiny-exact
    desc: Exact tiny timing/delay fragments
    crit: notable
    any:
      - id: timing-fragment-tiny-exact-1
      - id: timing-fragment-tiny-exact-2

  - id: payload-handling-fragment-tiny-exact
    desc: Exact tiny payload handling fragments
    crit: notable
    any:
      - id: payload-handling-fragment-tiny-exact-1
      - id: payload-handling-fragment-tiny-exact-2
