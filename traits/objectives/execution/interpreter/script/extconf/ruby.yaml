defaults:
  for: [ruby]

traits:
  - id: calls-create-makefile-1
    desc: Calls create_makefile (standard extconf behavior)
    crit: notable
    conf: 0.8
    if:
      type: string
      word: "create_makefile"

  - id: calls-create-makefile-2
    desc: Calls create_header (standard extconf behavior)
    crit: notable
    conf: 0.8
    if:
      type: string
      word: "create_header"

  - id: calls-create-makefile-3
    desc: References mkmf (standard extconf behavior)
    crit: notable
    conf: 0.8
    if:
      type: string
      word: "mkmf"

  - id: ast-httparty-get
    desc: HTTParty GET request invocation
    crit: notable
    conf: 0.9
    if:
      type: ast
      query: |
        ((call
          receiver: (constant) @recv
          method: (identifier) @method
          arguments: (argument_list (_) @arg))
         (#eq? @recv "HTTParty")
         (#eq? @method "get"))

composite_rules:
  - id: calls-create-makefile
    desc: Calls create_makefile (standard extconf behavior)
    crit: notable
    conf: 0.8
    any:
      - id: calls-create-makefile-1
      - id: calls-create-makefile-2
      - id: calls-create-makefile-3

  - id: extconf-http-fetch
    desc: extconf.rb performs HTTParty fetch during build
    crit: suspicious
    conf: 0.95
    all:
      - id: objectives/execution/dropper/script::filename-extconf
      - id: ast-httparty-get
