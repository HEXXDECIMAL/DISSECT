# Detects Ruby droppers using iplogger/tracking services
# Commonly seen in TacoBell malware family variants
# ATT&CK: T1105 (Ingress Tool Transfer), T1071 (Application Layer Protocol)

defaults:
  crit: hostile
  conf: 1.0

composite_rules:
  - id: ruby-iplogger-dropper
    desc: Ruby script (extconf.rb) drops executable and contacts tracking service
    all:
      - id: objectives/execution/dropper/script::filename-extconf
      - id: objectives/execution/dropper/script::ruby-ast-rename-to-exe
      - id: micro-traits/process/create/shell::shell-execution-indicators
    any:
      - id: objectives/command-and-control/domain/tracking::iplogger-http
      - id: objectives/discovery/network/scan::iplogger-keyword
      - id: objectives/command-and-control/infrastructure/network::ruby-ast-fragmented-iplogger
      - id: objectives/command-and-control/infrastructure/network::ruby-ast-fragmented-iplogger-alt
      - id: objectives/anti-static/obfuscation/string::ruby-concatenated-iplogger
      - id: objectives/anti-static/obfuscation/string::ruby-concatenated-iplogger-alt
