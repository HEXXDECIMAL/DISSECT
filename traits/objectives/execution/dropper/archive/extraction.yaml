defaults:
  crit: suspicious
  attack: T1105
  mbc: E1105
  for:
  - python
  - shell
  - javascript
traits:
- id: tar-extract-x
  desc: tar archive extraction (x flag)
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: tar\s+x[fzv]*
- id: tar-extract-word
  desc: tar archive extraction (word)
  crit: notable
  conf: 0.7
  if:
    type: string
    substr: "tar extract"
- id: tar-gzip-extract
  desc: tar.gz extraction command
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: tar.{0,10}gz|\.tar\.gz
- id: tar-execute
  desc: tar extract and execute
  crit: suspicious
  conf: 0.85
  if:
    type: string
    regex: tar.{0,15}-C.{0,15}exec|extract.{0,15}exec
- id: unzip-command
  desc: unzip archive extraction
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: unzip\s+-|extract.{0,15}\.zip
- id: zipfile-module
  desc: Python zipfile module
  crit: notable
  conf: 0.7
  if:
    type: string
    substr: zipfile
- id: temp-archive-path
  desc: Temporary directory archive
  crit: notable
  conf: 0.65
  if:
    type: string
    regex: (temp|tmp).{0,15}\.(tar|zip|gz)
- id: hidden-archive-path
  desc: Hidden path archive extraction
  crit: suspicious
  conf: 0.8
  if:
    type: string
    regex: \/\.[^.].{0,20}\.(tar|gz|zip)
- id: extract-to-temp
  desc: Extract payload to temp
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: (tempdir|gettempdir).{0,15}extract|extract.{0,15}tempdir
- id: extract-then-execute-arch
  desc: Extract then execute pattern (archive)
  crit: inert
  conf: 0.9
  if:
    type: string
    regex: (?:extract|unzip|tar).{0,80}
- id: extract-then-execute-run-1
  desc: Extract then execute pattern (exec/run/sub)
  crit: inert
  conf: 0.9
  if:
    type: string
    regex: (?:exec|run|subprocess)
- id: extract-then-execute-run-2
  desc: Extract then execute pattern (shell/python)
  crit: inert
  conf: 0.9
  if:
    type: string
    regex: \b(?:bash|python|sh\b)
composite_rules:
- id: tar-extract
  desc: tar archive extraction
  crit: notable
  conf: 0.7
  any:
  - id: tar-extract-x
  - id: tar-extract-word
- id: extract-then-execute
  desc: Extract then execute pattern
  crit: suspicious
  conf: 0.9
  all:
  - id: extract-then-execute-arch
  any:
  - id: extract-then-execute-run-1
  - id: extract-then-execute-run-2
- id: archive-extraction
  desc: Archive extraction capability
  crit: notable
  conf: 0.75
  attack: T1105
  needs: 2
  any:
  - id: tar-extract
  - id: tar-gzip-extract
  - id: unzip-command
  - id: zipfile-module
- id: payload-extraction
  desc: Payload extraction behavior
  crit: suspicious
  conf: 0.85
  attack: T1105
  for:
  - python
  - shell
  needs: 2
  any:
  - id: temp-archive-path
  - id: hidden-archive-path
  - id: extract-to-temp
  all:
  - id: archive-extraction
- id: extract-and-execute
  desc: Extract and execute payload
  crit: suspicious
  conf: 0.95
  attack: T1204
  mbc: E1105
  platforms:
  - all
  needs: 2
  all:
  - id: archive-extraction
  - id: extract-then-execute
- id: extract-and-chmod
  desc: Extract archive and make executable
  crit: suspicious
  conf: 0.85
  attack: T1204
  mbc: E1105
  for:
  - shell
  all:
  - id: objectives/execution/dropper/script::chmod-plus-x-cmd
  any:
  - id: unzip-command
  - id: tar-extract
