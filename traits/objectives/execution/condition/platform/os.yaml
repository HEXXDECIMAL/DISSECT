# Multi-Platform Execution Logic
# Detects scripts that check for multiple OSs and execute commands
# Common in supply chain attacks to maximize impact
# ATT&CK: T1204.002

composite_rules:
  - id: has-os-check
    desc: Checks for OS platform
    crit: notable
    conf: 0.6
    any:
      - id: objectives/discovery/host/system/hardware-fingerprint::process-platform-content
      - id: objectives/discovery/host/system/os-fingerprint::os-check-windows
      - id: objectives/discovery/host/system/os-fingerprint::os-check-linux

  - id: has-execution-capability
    desc: Has code execution capability
    crit: notable
    conf: 0.6
    any:
      - id: micro-traits/process/create

  - id: executes-scripts
    desc: Executes script files
    crit: notable
    conf: 0.6
    any:
      - id: micro-traits/process/create/script
      - id: micro-traits/process/create/shell::cmd-exe

  - id: os-specific-execution
    desc: Executes different commands based on OS platform
    crit: notable
    conf: 0.85
    attack: T1204.002
    all:
      - id: has-os-check
      - id: has-execution-capability
      - id: executes-scripts
