# ActiveX COM Object Instantiation
# Detects Windows COM object creation for various malware purposes
# Generic indicator for VBScript/JScript malware

defaults:
  crit: notable
  conf: 0.8
  platforms: [windows]
  for: [javascript]
  attack: "T1059.005"
  mbc: "E1243"

traits:
  - id: activex-filesystem
    desc: FileSystemObject COM
    if:
      type: string
      substr: "Scripting.FileSystemObject"

  - id: activex-shell-app
    desc: Shell.Application COM
    if:
      type: string
      substr: "Shell.Application"

  - id: activex-winhttp
    desc: WinHTTP request object
    if:
      type: string
      substr: "WinHTTP.WinHTTPRequest"

  - id: activex-wmi
    desc: WbemScripting.SWbemLocator
    if:
      type: string
      substr: "WbemScripting.SWbemLocator"
    attack: "T1047"
    mbc: "E1043"

  - id: activex-object-create
    desc: new ActiveXObject pattern
    if:
      type: string
      substr: "new ActiveXObject("
    attack: "T1202"

composite_rules:
  - id: activex-network-access
    desc: ActiveX network capability
    conf: 0.8
    attack: "T1071"
    mbc: "C0005"
    any:
      - id: micro-behaviors/os/com/object::clsid-xmlhttp-generic
      - id: activex-winhttp

  - id: activex-file-network
    desc: File + network operations
    crit: suspicious
    conf: 0.85
    attack: "T1071"
    all:
      - id: activex-filesystem
      - id: activex-network-access

  - id: activex-shell-execution
    desc: Shell command execution via COM
    crit: notable
    conf: 0.85
    any:
      - id: micro-behaviors/os/com/object::wscript-shell-literal
      - id: activex-shell-app
      - id: activex-wmi
