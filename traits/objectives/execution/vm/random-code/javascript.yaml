traits:
  - id: random-code-generation
    desc: Detects random code generation via Math.random
    crit: suspicious
    conf: 1.0
    attack: T1027
    mbc: B0032
    if:
      type: raw
      regex: "(?s)(Math\\.random\\(\\).{0,500}\\bnew Function\\b|\\bnew Function\\b.{0,500}Math\\.random\\(\\)|Math\\.random\\(\\).{0,500}\\beval\\s*\\(|\\beval\\s*\\(.{0,500}Math\\.random\\(\\))"
    downgrade:
      any:
        - id: metadata/library/jquery::domain
        - id: metadata/library/jquery::version-string
        - id: metadata/library/jquery::copyright
        - id: metadata/library/jquery::fn-extend
        - id: metadata/library/d3::d3-detection

  - id: math-random-index
    desc: Math.random used for indexing (probabilistic character selection)
    crit: suspicious
    conf: 1.0
    attack: T1027
    mbc: B0032
    if:
      type: ast
      language: javascript
      query: |
        (subscript_expression
          index: (call_expression
            function: (member_expression
              object: (identifier) @math
              property: (property_identifier) @floor
              (#eq? @math "Math")
              (#eq? @floor "floor")
            )
            arguments: (arguments
              (binary_expression
                left: (call_expression
                  function: (member_expression
                    object: (identifier) @math2
                    property: (property_identifier) @random
                    (#eq? @math2 "Math")
                    (#eq? @random "random")
                  )
                )
              )
            )
          )
        )
