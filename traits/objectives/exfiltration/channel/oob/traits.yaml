# Exfiltration - Out-of-Band (OOB) Data Exfiltration
# ATT&CK: T1048 (Exfiltration Over Alternative Protocol)

traits:
  # === OOB domain atomic indicators ===
  - id: interactsh-domain
    desc: Interactsh OOB domain
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9]{8,64}\\.interactsh"

  - id: burpcollaborator-domain
    desc: Burp Collaborator OOB domain
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9]{8,32}\\.burpcollaborator\\.net"

  - id: oastify-domain
    desc: Oastify OOB domain
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9]{8,32}\\.oastify\\.com"

  - id: oast-fun-domain
    desc: OAST.fun OOB domain
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9]{8,32}\\.oast\\.fun"

  - id: pipedream-domain
    desc: Pipedream OOB domain
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9]{8,32}\\.m\\.pipedream\\.net"

  # === Ngrok atomic indicators ===
  - id: ngrok-tcp
    desc: Ngrok TCP tunnel
    crit: notable
    conf: 0.7
    attack: "T1572"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.tcp\\.[a-z]+\\.ngrok\\.io"

  - id: ngrok-http
    desc: Ngrok HTTP tunnel
    crit: notable
    conf: 0.7
    attack: "T1572"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.http\\.[a-z]+\\.ngrok\\.io"

  - id: ngrok-https
    desc: Ngrok HTTPS tunnel
    crit: notable
    conf: 0.7
    attack: "T1572"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.https\\.[a-z]+\\.ngrok\\.io"

  - id: bytedance-dast
    desc: Exfiltrates data to Bytedance DAST
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.byted-dast\\.com"

  - id: workers-dev
    desc: Communication with Cloudflare Workers (common
    crit: notable
    conf: 0.7
    attack: "T1071"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.workers\\.dev"

  # === Requestbin atomic indicators ===
  - id: requestbin-com
    desc: RequestBin.com OOB endpoint
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      substr: "requestbin.com"

  - id: requestbin-net
    desc: RequestBin.net OOB endpoint
    crit: notable
    conf: 0.7
    attack: "T1048"
    for: [all]
    if:
      type: string
      substr: "requestbin.net"

  - id: webhook-site
    desc: Exfiltrates data to Webhook.site OOB
    crit: suspicious
    conf: 0.9
    attack: "T1048"
    for: [all]
    if:
      type: string
      substr: "webhook.site"

  - id: dnslog-cn
    desc: Exfiltrates data to DNSLog.cn OOB
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    for: [all]
    if:
      type: string
      substr: "dnslog.cn"

  - id: canarytokens
    desc: Accesses Canarytokens OOB domain (potential
    crit: suspicious
    conf: 0.9
    attack: "T1048"
    for: [all]
    if:
      type: string
      substr: "canarytokens.com"

  - id: oastify-b64
    desc: Base64-encoded Oastify OOB domain indicator
    crit: suspicious
    conf: 0.9
    for: [python, javascript]
    if:
      type: string
      substr: "b2FzdGlmeS5jb20"

  - id: oast-fun-b64
    desc: Base64-encoded OAST.fun OOB domain indicator
    crit: suspicious
    conf: 0.9
    for: [python, javascript]
    if:
      type: string
      substr: "b2FzdC5mdW4"

  - id: http-b64
    desc: Base64-encoded HTTP protocol indicator
    crit: notable
    conf: 0.7
    for: [python, javascript]
    if:
      type: string
      substr: "aHR0cDovL"

  - id: https-b64
    desc: Base64-encoded HTTPS protocol indicator
    crit: notable
    conf: 0.7
    for: [python, javascript]
    if:
      type: string
      substr: "aHR0cHM6Ly"

  # NOTE: Discord webhook traits are defined in comm/messaging/discord/
  # NOTE: Telegram bot traits are defined in comm/messaging/telegram/
  # Use those directory references in composite rules

  # Slack webhook exfiltration
  - id: slack-webhook
    desc: Slack webhook exfiltration endpoint
    crit: notable
    conf: 0.8
    attack: "T1567"
    for: [javascript, typescript, python]
    if:
      type: string
      regex: "hooks\\.slack\\.com/services/T[A-Z0-9]+/B[A-Z0-9]+/[A-Za-z0-9]+"

  # Ngrok free tunnel detection
  - id: ngrok-free
    desc: Ngrok free tunnel endpoint
    crit: suspicious
    conf: 0.9
    attack: "T1572"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.ngrok-free\\.app"

  # === NPM preinstall atomic indicators ===
  # Moved to objectives/execution/package-manager/npm.yaml

composite_rules:
  # Helper composite for all OOB domain patterns
  - id: oob-domains
    desc: Any OOB domain pattern
    for: [all]
    any:
      - { id: interactsh-domain }
      - { id: burpcollaborator-domain }
      - { id: oastify-domain }
      - { id: oast-fun-domain }
      - { id: pipedream-domain }
    crit: notable

  # Helper composite for all ngrok tunnels
  - id: ngrok-tunnels
    desc: Ngrok tunnel patterns
    for: [all]
    any:
      - { id: ngrok-tcp }
      - { id: ngrok-http }
      - { id: ngrok-https }
      - { id: ngrok-free }
    crit: notable

  # Helper composite for requestbin endpoints
  - id: requestbin-endpoints
    desc: RequestBin OOB endpoints
    for: [all]
    any:
      - { id: requestbin-com }
      - { id: requestbin-net }
    crit: notable


  # Migrated from YARA
  - id: preinstall-exfil
    desc: OOB exfiltration from npm preinstall
    crit: suspicious
    conf: 0.99
    attack: "T1048"
    mbc: "B0030"
    for: [javascript]
    all:
      - { id: objectives/execution/interpreter/script/npm::npm-preinstall-script }
      - { id: oob-domains }

  # Migrated from YARA
  - id: crypto-exfil
    desc: Encrypted OOB exfiltration via crypto
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    mbc: "B0030"
    for: [javascript]
    all:
      - { id: micro-traits/crypto/symmetric/aes::crypto-require-call }
      - { id: oob-domains }

  - id: multiple-encoded-indicators
    desc: "Multiple encoded indicators"
    crit: notable
    conf: 0.85

  # Helper composite for encoded OOB indicators
  - id: encoded-oob-indicators
    desc: Base64-encoded OOB domain indicators
    for: [python, javascript]
    any:
      - { id: oastify-b64 }
      - { id: oast-fun-b64 }
    crit: notable

  - id: encoded-oob-exfil
    desc: "Base64-encoded OOB domain with HTTP"
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    mbc: "B0030"
    for: [python, javascript]
    all:
      - { id: micro-traits/comm/http/request }
      - { id: encoded-oob-indicators }
