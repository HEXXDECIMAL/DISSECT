# Exfiltration - Out-of-Band (OOB) Data Exfiltration
# ATT&CK: T1048 (Exfiltration Over Alternative Protocol)

traits:
  # === Workers and DAST (often used for gathering) ===
  - id: bytedance-dast
    desc: Exfiltrates data to Bytedance DAST
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.byted-dast\\.com"

  - id: workers-dev
    desc: Communication with Cloudflare Workers
    crit: notable
    conf: 0.7
    attack: "T1071"
    for: [all]
    if:
      type: string
      regex: "[a-z0-9-]+\\.workers\\.dev"

  # === Base64 Encoded Indicators ===
  - id: oastify-b64
    desc: Base64-encoded Oastify OOB domain indicator
    crit: suspicious
    conf: 0.9
    for: [python, javascript]
    if:
      type: string
      substr: "b2FzdGlmeS5jb20"

  - id: oast-fun-b64
    desc: Base64-encoded OAST.fun OOB domain indicator
    crit: suspicious
    conf: 0.9
    for: [python, javascript]
    if:
      type: string
      substr: "b2FzdC5mdW4"

  - id: http-b64
    desc: Base64-encoded HTTP protocol indicator
    crit: notable
    conf: 0.7
    for: [python, javascript]
    if:
      type: string
      substr: "aHR0cDovL"

  - id: https-b64
    desc: Base64-encoded HTTPS protocol indicator
    crit: notable
    conf: 0.7
    for: [python, javascript]
    if:
      type: string
      substr: "aHR0cHM6Ly"

  # Slack webhook exfiltration
  - id: slack-webhook
    desc: Slack webhook exfiltration endpoint
    crit: notable
    conf: 0.8
    attack: "T1567"
    for: [javascript, typescript, python]
    if:
      type: string
      regex: "hooks\\.slack\\.com/services/T[A-Z0-9]+/B[A-Z0-9]+/[A-Za-z0-9]+"

composite_rules:
  # Helper composite for all OOB domain patterns
  - id: oob-domains
    desc: Any OOB domain pattern
    for: [all]
    any:
      - id: objectives/exfiltration/channel/callback/
      - id: objectives/discovery/network/ip-tracker/
      - id: bytedance-dast
      - id: workers-dev
    crit: notable

  # Migrated from YARA
  - id: preinstall-exfil
    desc: OOB exfiltration from npm preinstall
    crit: suspicious
    conf: 0.99
    attack: "T1048"
    mbc: "B0030"
    for: [javascript]
    all:
      - id: objectives/execution/interpreter/script/npm::npm-preinstall-script
      - id: oob-domains

  # Migrated from YARA
  - id: crypto-exfil
    desc: Encrypted OOB exfiltration via crypto
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    mbc: "B0030"
    for: [javascript]
    all:
      - id: micro-behaviors/crypto/symmetric/aes::crypto-require-call
      - id: oob-domains

  # Helper composite for encoded OOB indicators
  - id: encoded-oob-indicators
    desc: Base64-encoded OOB domain indicators
    for: [python, javascript]
    any:
      - id: oastify-b64
      - id: oast-fun-b64
    crit: notable

  - id: encoded-oob-exfil
    desc: "Base64-encoded OOB domain with HTTP"
    crit: suspicious
    conf: 0.95
    attack: "T1048"
    mbc: "B0030"
    for: [python, javascript]
    all:
      - id: micro-behaviors/communications/http/request
      - id: encoded-oob-indicators
