# Data Exfiltration Patterns for Info-Stealers
# Detects C2 communication patterns common in credential stealers
# ATT&CK: T1041 (Exfiltration Over C2 Channel)

defaults:
  attack: "T1041"
  crit: suspicious
  # curl/wget commands can be embedded in any file type
  for: ["*"]

traits:
  # === Gate URL atomic (EXFIL-SPECIFIC) ===
  - id: gate-var-http
    desc: gate = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bgate\\s*=\\s*[\"']http"

  - id: c2-var-http
    desc: c2 = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bc2\\s*=\\s*[\"']http"

  - id: panel-var-http
    desc: panel = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bpanel\\s*=\\s*[\"']http"

composite_rules:
  # Gate URL (exfil-specific)
  - id: gate-url
    desc: Hardcoded gate/C2 URL variable
    crit: suspicious
    conf: 0.85
    for: [shell, python, javascript]
    any:
      - id: gate-var-http
      - id: c2-var-http
      - id: panel-var-http

  # curl POST with custom headers
  # NOTE: This is suspicious because legitimate downloads don't use custom POST headers
  - id: multipart-upload
    desc: Multipart upload with stealer context
    crit: suspicious
    conf: 0.75
    for: [shell, python, javascript]
    all:
      - id: micro-behaviors/comm/http/headers::multipart-upload
    any:
      - id: gate-url
      - id: micro-behaviors/comm/http/headers::bot-headers
      - id: micro-behaviors/comm/http/client
    none:
      - id: objectives/lateral-movement/supply-chain/npm/testing::wpt-test-file
      - id: objectives/lateral-movement/supply-chain/npm/testing::jest-test-file
      - id: objectives/lateral-movement/supply-chain/npm/testing::mocha-test-file
      - id: objectives/lateral-movement/supply-chain/npm/testing::test-filename-pattern
      - id: objectives/lateral-movement/supply-chain/npm/testing::test-fixtures

  # Full exfiltration pattern: must have POST with custom headers or C2 indicators
  # NOTE: Simple curl downloads (without POST/upload indicators) won't trigger this
  - id: stealer-exfil
    desc: Stealer data exfiltration pattern
    crit: notable
    conf: 0.95
    mbc: "C0001"
    for: [shell]
    needs: 3
    any:
      - id: micro-behaviors/comm/http/client::curl-post
      - id: micro-behaviors/comm/http/client::curl-upload
      - id: micro-behaviors/comm/http/headers::bot-headers
      - id: gate-url
      - id: micro-behaviors/comm/http/upload::zip-upload
