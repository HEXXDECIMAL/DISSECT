defaults:
  for:
  - '*'
traits:
- id: cve-mention
  desc: References a CVE identifier
  crit: notable
  conf: 0.8
  attack: T1068
  if:
    type: string
    regex: CVE-20[12]\d-\d{4,7}
- id: cve-poc
  desc: References a CVE proof-of-concept
  crit: notable
  conf: 0.9
  attack: T1068
  if:
    type: string
    regex: (CVE[-_]POC|POC[-_]CVE)-20[12]\d-\d+
- id: pwnkit-name
  desc: PwnKit exploit identifier
  crit: notable
  conf: 0.95
  attack: T1068
  for:
  - elf
  - python
  - shell
  if:
    type: string
    regex: (?i)pwnkit
- id: pwnkit-cve
  desc: PwnKit CVE reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)cve[-_]?2021[-_]?4034
- id: pkexec-exploit
  desc: pkexec exploitation marker
  crit: notable
  conf: 0.9
  attack: T1068
  for:
  - elf
  if:
    type: string
    substr: pkexec
- id: gconv-path-dot
  desc: GCONV_PATH override to current directory
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    substr: GCONV_PATH=.
- id: gconv-init
  desc: GCONV initialization hook (requires context)
  crit: notable
  conf: 0.4
  attack: T1068
  for:
  - elf
  if:
    type: string
    substr: gconv_init
- id: glibc-tunables
  desc: GLIBC_TUNABLES environment variable (requires context)
  crit: notable
  conf: 0.3
  attack: T1068
  if:
    type: string
    substr: GLIBC_TUNABLES
- id: looney-tunables
  desc: Looney Tunables exploit reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)looney.?tunables
- id: cve-2023-4911
  desc: GLIBC_TUNABLES CVE reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)cve[-_]?2023[-_]?4911
- id: shellcode-ref
  desc: Shellcode reference
  crit: notable
  conf: 0.85
  attack: T1068
  if:
    type: string
    substr: shellcode
- id: exec-shellcode
  desc: Shellcode execution function
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: exec(ute)?[_-]?shellcode
- id: nop-sled
  desc: NOP sled reference
  crit: notable
  conf: 0.9
  attack: T1068
  if:
    type: string
    regex: (?i)nop[_-]?sled
- id: payload-so
  desc: Payload shared object
  crit: notable
  conf: 0.9
  attack: T1068
  for:
  - elf
  if:
    type: string
    substr: payload.so
- id: dirtypipe
  desc: DirtyPipe exploit reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)dirty.?pipe
- id: cve-2022-0847
  desc: DirtyPipe CVE reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)cve[-_]?2022[-_]?0847
- id: dirtycow
  desc: DirtyCow exploit reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)dirty.?cow
- id: cve-2016-5195
  desc: DirtyCow CVE reference
  crit: notable
  conf: 0.95
  attack: T1068
  if:
    type: string
    regex: (?i)cve[-_]?2016[-_]?5195
- id: reverse-shell-ref
  desc: Reverse shell reference in exploit
  crit: notable
  conf: 0.8
  attack: T1068
  for:
  - elf
  - python
  - shell
  if:
    type: string
    substr: reverse_shell
- id: poc-ref
  desc: Proof of concept reference
  crit: notable
  conf: 0.6
  attack: T1068
  if:
    type: string
    regex: (?i)proof.?of.?concept
- id: pwnkit-yara
  desc: PwnKit exploit via YARA
  crit: notable
  conf: 0.95
  attack: T1068
  mbc: E1068
  for:
  - elf
  - python
  - shell
  if:
    type: yara
    source: "rule pwnkit_exploit {\n  strings:\n    $pwnkit1 = \"PwnKit\" nocase\n\
      \    $pwnkit2 = \"pwnkit\" nocase\n    $cve = /cve[-_]?2021[-_]?4034/i\n   \
      \ $path = \"PATH\" fullword\n    $pkexec = \"pkexec\"\n    $gconv_path = \"\
      GCONV_PATH=.\"\n    $gconv_init = \"gconv_init\"\n    $payload = \"payload.so\"\
      \n    $revshell = \"reverse_shell\"\n  condition:\n    filesize < 5MB and\n\
      \    (any of ($pwnkit*, $cve) and any of ($path, $pkexec, $revshell)) or\n \
      \   (4 of ($path, $pkexec, $gconv_path, $gconv_init, $payload))\n}\n"
- id: buffer-overflow-yara
  desc: Buffer overflow exploit via YARA
  crit: notable
  conf: 0.9
  attack: T1068
  mbc: E1068
  if:
    type: yara
    source: "rule buffer_overflow_exploit {\n  strings:\n    $shellcode = \"shellcode\"\
      \ fullword\n    $n_padding = \"padding\" fullword\n    $n_address = \"address\"\
      \ fullword\n    $n_offset = \"offset\" fullword\n    $n_overflow = \"overflow\"\
      \ fullword\n    $n_rop = \"ROP\" fullword\n    $n_gadget = \"gadget\" fullword\n\
      \    $not_fishshell = \"fishshell\"\n    $not_powershell = \"powershell\"\n\
      \  condition:\n    filesize < 3MB and $shellcode and 2 of ($n*) and none of\
      \ ($not*)\n}\n"
- id: looney-tunables-yara
  desc: Looney Tunables exploit via YARA
  crit: notable
  conf: 0.95
  attack: T1068
  mbc: E1068
  for:
  - elf
  - python
  - shell
  if:
    type: yara
    source: "rule looney_tunables {\n  strings:\n    // Explicit exploit references\
      \ (high confidence)\n    $name = /looney.?tunables/i\n    $cve = /cve[-_]?2023[-_]?4911/i\n\
      \    // Exploit code patterns\n    $tunables = \"GLIBC_TUNABLES\"\n    $overflow\
      \ = \"overflow\"\n    $exploit = \"exploit\"\n    $payload = \"payload\"\n \
      \   $shellcode = \"shellcode\"\n    $poc = /proof.?of.?concept/i\n  condition:\n\
      \    filesize < 5MB and\n    // Only match if explicit exploit reference OR\
      \ exploit patterns\n    any of ($name, $cve) or\n    ($tunables and any of ($overflow,\
      \ $exploit, $payload, $shellcode, $poc))\n}\n"
- id: path-env-var
  desc: PATH environment variable manipulation
  crit: notable
  conf: 0.5
  attack: T1068
  for:
  - elf
  - python
  - shell
  if:
    type: string
    regex: PATH=|setenv.{0,30}PATH|putenv.{0,30}PATH|getenv.{0,30}PATH.{0,20}:|PATH[+]?=
composite_rules:
- id: pwnkit-name-with-context
  desc: PwnKit exploit with execution context
  crit: suspicious
  conf: 0.9
  attack: T1068
  mbc: E1068
  for:
  - elf
  - python
  - shell
  any:
  - id: pwnkit-name
  - id: pwnkit-cve
  all:
  - id: pkexec-exploit
- id: gconv-path-exploit
  desc: GCONV_PATH exploitation pattern
  crit: suspicious
  conf: 0.9
  attack: T1068
  mbc: E1068
  for:
  - elf
  - shell
  all:
  - id: gconv-path-dot
  - id: gconv-init
  - id: payload-so
- id: looney-tunables-explicit
  desc: Looney Tunables with explicit exploit
  crit: suspicious
  conf: 0.95
  attack: T1068
  mbc: E1068
  for:
  - elf
  - python
  - shell
  any:
  - id: looney-tunables
  - id: cve-2023-4911
- id: looney-tunables-with-exploit-pattern
  desc: GLIBC_TUNABLES with exploit indicators
  crit: notable
  conf: 0.85
  attack: T1068
  mbc: E1068
  for:
  - elf
  - python
  - shell
  all:
  - id: glibc-tunables
  any:
  - id: micro-traits/data/text/keywords
  - id: shellcode-ref
  - id: poc-ref
- id: dirtypipe-detected
  desc: DirtyPipe exploit detected
  crit: suspicious
  conf: 0.95
  attack: T1068
  mbc: E1068
  for:
  - all
  any:
  - id: dirtypipe
  - id: cve-2022-0847
- id: dirtycow-detected
  desc: DirtyCow exploit detected
  crit: suspicious
  conf: 0.95
  attack: T1068
  mbc: E1068
  for:
  - all
  any:
  - id: dirtycow
  - id: cve-2016-5195
- id: shellcode-with-rop
  desc: Shellcode with ROP exploitation
  crit: suspicious
  conf: 0.9
  attack: T1068
  mbc: E1068
  for:
  - all
  all:
  - id: shellcode-ref
  any:
  - id: micro-traits/data/exploitation/memory::rop-ref
  - id: micro-traits/data/exploitation/memory::gadget-ref
