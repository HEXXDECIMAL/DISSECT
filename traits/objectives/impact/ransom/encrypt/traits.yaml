defaults:
  for:
  - all
traits:
- id: encryption-complete-msg
  desc: Ransomware completion status message
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: (Encryption|Encrypting).{0,20}complete
    case_insensitive: true
  downgrade:
    any:
    - id: metadata/signed/platform::apple
- id: encrypt-func-symbol
  desc: File encryption function symbols
  crit: suspicious
  conf: 0.9
  for:
  - elf
  - pe
  - macho
  if:
    type: symbol
    regex: ^encrypt_(file|directory|folder|data|content)s?$
- id: ransomware-source-path
  desc: Ransomware source file path
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: (ransomware|ransom|locker|crypter)\.(c|cpp|rs|go)$
    case_insensitive: true
- id: locker-namespace
  desc: Ransomware locker module namespace
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: 'locker::(core|lib|app)::'
- id: encrypt-lib-path
  desc: Encryption library source paths
  crit: suspicious
  conf: 0.9
  if:
    type: string
    regex: library/(encrypt-lib|locker)/src/
- id: config-note-fields
  desc: Ransomware note config fields
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: note_file_name|note_full_text|note_short_text
- id: config-cipher-fields
  desc: Ransomware cipher config fields
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: default_file_cipher|default_file_mode
- id: template-placeholders
  desc: Ransomware config template variables (EXTENSION, NOTE_FILE_NAME, ACCESS_KEY)
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: \$\{(EXTENSION|NOTE_FILE_NAME|ACCESS_KEY)\}
- id: vm-kill-config
  desc: VM kill configuration fields
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: enable_esxi_vm_kill|enable_esxi_vm_snapshot_kill|esxi_vm_kill_exclude
- id: kill-services-config
  desc: Service kill config for ransomware
  crit: suspicious
  conf: 0.85
  if:
    type: string
    regex: kill_services|kill_processes
- id: ransom-extension
  desc: Ransomware file extension markers
  crit: notable
  conf: 0.85
  if:
    type: string
    regex: '[a-zA-Z0-9_]{2,}\.(crypt|encrypted|locked|enc|crypted|cry)$'
  unless:
  - type: string
    regex: ^(matplotlib|tex)$
- id: babuk-config-marker
  desc: Babuk ransomware configuration memory marker (16x 0xAF)
  crit: suspicious
  conf: 0.98
  for:
  - elf
  if:
    type: hex
    pattern: af af af af af af af af af af af af af af af af
- id: crypto-openssl-encrypt
  desc: OpenSSL encryption functions
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: EVP_(Encrypt|Cipher)Init_ex|AES_set_encrypt_key|AES_cbc_encrypt
- id: crypto-openssl-asymmetric
  desc: OpenSSL asymmetric key operations
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: ECDH_compute_key|EC_KEY_generate_key|RSA_public_encrypt
- id: file-locked-message
  desc: File locked status message
  crit: suspicious
  conf: 0.9
  if:
    type: string
    regex: File Locked|locked.{0,20}PID|error.{0,20}encrypt.{0,20}rename
- id: crypted-counter
  desc: Encryption counter message
  crit: suspicious
  conf: 0.9
  if:
    type: string
    regex: 'Total (Crypted|Encrypted)|Crypted:.{0,20}Error:|Files Encrypted:'
- id: payment-status-check
  desc: Ransomware payment verification
  crit: suspicious
  conf: 0.9
  for:
  - elf
  - pe
  - macho
  if:
    type: string
    regex: (getHasPayed|checkPayment|isPaid|payment.{0,20}status|verify.{0,20}payment)
    case_insensitive: true
- id: desktop-note-path
  desc: Ransom note file dropped to Desktop directory
  crit: suspicious
  conf: 0.9
  if:
    type: string
    regex: (/Desktop/|\\Desktop\\)[^/\\]{1,50}\.(html?|txt)
- id: babuk-file-status-logging
  desc: Ransomware file encryption status logging
  crit: suspicious
  conf: 0.9
  for:
  - elf
  - macho
  if:
    type: string
    regex: \[[+!]\]\s+File\s+(?:not\s+)?encrypted
- id: babuk-file-io-errors
  desc: Ransomware file access error logging
  crit: notable
  conf: 0.8
  for:
  - elf
  - macho
  if:
    type: string
    regex: \[!\]\s+Can`t\s+(?:run for|open)\s+file
- id: ransom-note-text
  desc: Ransom note message patterns
  crit: suspicious
  conf: 0.95
  if:
    type: string
    case_insensitive: true
    regex: your files.{0,30}(have been|were).{0,20}encrypted|files (have been|were).{0,20}encrypted|decrypt.{0,20}(your|all
      your|the) files|pay.{0,30}(ransom|bitcoin)|ransom.{0,30}(note|payment)|tor browser|\.onion/|irreversibly
      encrypted
- id: encryption-pipeline
  desc: File encryption pipeline patterns
  crit: suspicious
  conf: 0.9
  if:
    type: string
    regex: File already has encrypted extension|Starting File Processing Pipeline|Files
      processed.{0,50}Files scanned
- id: ransom-note-filename
  desc: Ransom note filename patterns
  crit: suspicious
  conf: 0.9
  if:
    type: string
    case_insensitive: true
    regex: README.{0,20}RESTORE|DECRYPT.{0,20}INSTRUCTIONS|HOW[_\-\.].{0,18}RECOVER|RANSOM.{0,20}NOTE|_readme\.txt
- id: locker-config-fields
  desc: Ransomware locker configuration schema fields
  crit: suspicious
  conf: 0.95
  if:
    type: string
    regex: vecFullEncryptionExtensions|vecSkipFileExtensions|nEncryptionLimitBytes|nEncryptionBlockBytes|nEncryptionSkipBytes|sMasterPublicKey|sEncryptedFileExtension|vecPreRunCommands|vecPostRunCommands
composite_rules:
- id: locker-behavioral-indicators
  desc: Ransomware behavioral indicators (logging and schema)
  crit: suspicious
  conf: 0.9
  any:
  - id: babuk-file-status-logging
  - id: locker-config-fields
  - id: babuk-file-io-errors
  needs: 2
- id: ransomware-basic
  desc: Ransomware encryption pattern
  crit: hostile
  conf: 0.95
  for:
  - elf
  - pe
  - macho
  all:
  - id: crypto-openssl-encrypt
  - id: ransom-note-text
  any:
  - id: ransom-note-filename
  - id: ransom-extension
  - id: crypted-counter
  - id: file-locked-message
- id: ransomware-with-note
  desc: Ransomware with ransom note
  crit: hostile
  conf: 0.98
  for:
  - elf
  - pe
  - macho
  all:
  - id: ransom-note-text
  - id: ransom-extension
  any:
  - id: crypto-openssl-encrypt
  - id: crypto-openssl-asymmetric
  - id: crypted-counter
- id: ransomware-locker
  desc: Rust-based ransomware locker
  crit: hostile
  conf: 0.95
  for:
  - elf
  - pe
  - macho
  all:
  - id: locker-namespace
  - id: config-note-fields
  - id: config-cipher-fields
  any:
  - id: template-placeholders
  - id: encryption-pipeline
  - id: vm-kill-config
  - id: encrypt-lib-path
- id: ransomware-locker-esxi
  desc: ESXi-targeting ransomware locker
  crit: hostile
  conf: 0.98
  for:
  - elf
  all:
  - id: locker-namespace
  - id: config-note-fields
  - id: vm-kill-config
  - id: micro-traits/vm/detect/vmware::esxcli-vm-kill
  any:
  - id: config-cipher-fields
  - id: encrypt-lib-path
- id: ransomware-encrypt-funcs
  desc: Ransomware with encryption functions
  crit: hostile
  conf: 0.95
  for:
  - elf
  - pe
  - macho
  all:
  - id: encrypt-func-symbol
  - id: ransom-note-text
  any:
  - id: encryption-complete-msg
  - id: ransomware-source-path
  - id: crypted-counter
  - id: ransom-note-filename
- id: rust-file-encryptor
  desc: Rust stream cipher file encryptor
  crit: hostile
  conf: 0.92
  for:
  - elf
  all:
  - id: micro-traits/crypto/symmetric/stream::chacha-salsa-constant
  - id: micro-traits/process/threading/operations::pthread
  - id: micro-traits/fs/proc/info::process-pid-exe
  - id: micro-traits/fs/file/read
- id: c-file-encryptor
  desc: C/C++ file encryption ransomware with payment verification
  crit: hostile
  conf: 0.95
  for:
  - elf
  - pe
  - macho
  all:
  - id: ransom-note-text
  - id: desktop-note-path
  - id: payment-status-check
  any:
  - id: data-loss-threat
  - id: micro-traits/fs/proc/info::process-pid-exe
- id: data-loss-threat
  desc: Ransomware data loss threat
  crit: suspicious
  conf: 0.9
  unless:
  - id: objectives/impact/ransom/encrypt::inline__data-loss-threat__unless_1
  any:
  - id: objectives/impact/ransom/encrypt::inline__data-loss-threat__any_1
  - id: objectives/impact/ransom/encrypt::inline__data-loss-threat__any_2
  - id: objectives/impact/ransom/encrypt::inline__data-loss-threat__any_3
  - id: objectives/impact/ransom/encrypt::inline__data-loss-threat__any_4
