---
# Ruby Ransomware Detection
# Detects file encryption ransomware and ransom note behaviors
# ATT&CK: T1486 (Data Encrypted for Impact)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Chilkat Crypto Library ===
  - id: chilkat-crypto-lib
    desc: Chilkat crypto library usage
    crit: suspicious
    conf: 0.85
    attack: "T1486"
    if:
      type: string
      regex: 'require.{0,50}chilkat|Chilkat|chilkat'

  # === Encrypt Module ===
  - id: encrypt-module
    desc: Encryption module import
    crit: notable
    conf: 0.80
    attack: "T1486"
    if:
      type: string
      regex: 'Encrypt\.rb|Enc\.new|dec\.cry'

  # === Decrypt Module ===
  - id: decrypt-module
    desc: Decryption module import
    crit: notable
    conf: 0.80
    attack: "T1486"
    if:
      type: string
      regex: 'Decrypt.rb|decrypt|Dec.new|dec\.dec'

  # === Directory File Enumeration ===
  - id: dir-file-enum
    desc: Directory file enumeration
    crit: notable
    conf: 0.75
    attack: "T1083"
    if:
      type: string
      regex: 'Dir\[.{0,50}\*\*.{0,50}\*\.\*|input.{0,50}\*\*'

  # === File Operation Loop ===
  - id: file-operation-loop
    desc: File operation loop
    crit: notable
    conf: 0.75
    attack: "T1486"
    if:
      type: string
      regex: 'for i in input|\.each.{0,50}file|loop.{0,50}encrypt'

  # === Ransom Note Creation ===
  - id: ransom-note-create
    desc: Ransom note file creation
    crit: suspicious
    conf: 0.90
    attack: "T1491"
    if:
      type: string
      regex: 'Readme\.txt|hackend.{0,50}encrypted'

  - id: ransom-note-create-extra
    desc: Ransom note file creation (extra markers)
    crit: suspicious
    conf: 0.90
    attack: "T1491"
    if:
      type: string
      regex: 'README.{0,50}PUTS|\.puts.{0,50}banner'

  # === Ransom Banner/Art ===
  - id: ransomware-banner
    desc: Ransomware ASCII art banner
    crit: notable
    conf: 0.70
    attack: "T1491"
    if:
      type: string
      regex: '████'

  # === System Clear Screen ===
  # Removed clear-screen duplicate - use objectives/execution/interactive/terminal/ruby::cli-clear-screen

  # === Recursive Directory Access ===
  - id: recursive-dir-access
    desc: Recursive directory access
    crit: notable
    conf: 0.80
    attack: "T1083"
    if:
      type: string
      regex: '\*\*/\*\..{0,50}|Dir\.pwd|\.pwd'

composite_rules:
  # === Ransomware Tool ===
  - id: ransomware-tool
    desc: File encryption ransomware tool
    crit: suspicious
    conf: 0.95
    attack: "T1486"
    needs: 5
    any:
      - id: chilkat-crypto-lib
      - id: encrypt-module
      - id: decrypt-module
      - id: dir-file-enum
      - id: file-operation-loop
      - id: ransom-note-create
      - id: ransom-note-create-extra
      - id: recursive-dir-access

  # === Ransomware Note Dropper ===
  - id: ransomware-note-dropper
    desc: Ransom note creation behavior
    crit: suspicious
    conf: 0.90
    attack: "T1491"
    needs: 2
    any:
      - id: ransom-note-create
      - id: ransom-note-create-extra
      - id: ransomware-banner
      - id: file-operation-loop

  # === File Encryption Loop ===
  - id: file-encryption-loop
    desc: Bulk file encryption behavior
    crit: suspicious
    conf: 0.92
    attack: "T1486"
    needs: 3
    any:
      - id: dir-file-enum
      - id: file-operation-loop
      - id: encrypt-module
      - id: decrypt-module
