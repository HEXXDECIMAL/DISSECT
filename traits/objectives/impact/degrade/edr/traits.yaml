# Impact - EDR/Antivirus Degradation
# ATT&CK: T1562.001 (Impair Defenses: Disable or Modify Tools)

defaults:
  attack: "T1562.001"

traits:
  - id: stopper
    desc: EDR/Antivirus service stopper
    crit: suspicious
    conf: 0.95
    for: [pe, shell]
    if:
      type: string
      substr: "stopservice"

  # Removed terminate-process-api duplicate - use micro-traits/process/terminate/kill::terminate-process (symbol is more precise)

  # === EDR/AV process termination verbs (atomic) ===
  # Removed duplicate - use micro-traits/process/terminate/signal::kill

  # NOTE: "terminate" alone is too broad - matches C++ std::terminate,
  # terminate_handler, and many other legitimate uses. Match only in
  # process termination contexts.
  - id: terminate-keyword
    desc: terminate in process context
    crit: notable
    conf: 0.4
    for: [elf, pe]
    if:
      type: string
      # Match terminate in process/service termination contexts, not std::terminate
      regex: "(?i)\\b(terminate[_-]?(process|service|task)|process[_-]?terminate)\\b"

  # === EDR/AV product names (atomic) ===
  - id: defender-name
    desc: Windows Defender reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: defender
      case_insensitive: true

  - id: malwarebytes-name
    desc: Malwarebytes reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: malwarebytes
      case_insensitive: true

  - id: kaspersky-name
    desc: Kaspersky reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: kaspersky
      case_insensitive: true

  - id: bitdefender-name
    desc: Bitdefender reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: bitdefender
      case_insensitive: true

  # Avast AV detection - must be specific to avoid nautical term "avast" (meaning "stop")
  - id: avast-service-bin
    desc: Avast service reference (binaries)
    crit: notable
    conf: 0.7
    for: [pe, elf]
    if:
      type: string
      regex: "(?i)avast(svc|ui|setup|\\.exe)"

  - id: avast-service-other
    desc: Avast service reference (terms)
    crit: notable
    conf: 0.7
    for: [pe, elf]
    if:
      type: string
      regex: "(?i)avast(antivirus|software|service)"

  - id: avast-path
    desc: Avast installation path
    crit: notable
    conf: 0.7
    for: [pe, elf]
    if:
      type: string
      regex: "(?i)(program files|avast software).{0,50}avast"

  - id: norton-name
    desc: Norton reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: norton
      case_insensitive: true

  - id: mcafee-name
    desc: McAfee reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: mcafee
      case_insensitive: true

  - id: sophos-name
    desc: Sophos reference
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      substr: sophos
      case_insensitive: true

  - id: eset-lower
    desc: eset reference (lowercase)
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      word: "eset"

  - id: eset-upper
    desc: ESET reference (uppercase brand name)
    crit: notable
    conf: 0.5
    for: [pe, elf]
    if:
      type: string
      word: "ESET"

composite_rules:
  - id: avast-service
    desc: Avast service reference
    crit: notable
    conf: 0.7
    any:
      - id: avast-service-bin
      - id: avast-service-other

  # EDR/AV product names composite
  - id: edr-product-name
    desc: EDR/Antivirus product name reference
    crit: notable
    conf: 0.8
    for: [pe, elf]
    any:
      - id: defender-name
      - id: malwarebytes-name
      - id: kaspersky-name
      - id: bitdefender-name
      - id: avast-service
      - id: avast-path
      - id: norton-name
      - id: mcafee-name
      - id: sophos-name
      - id: eset-lower
      - id: eset-upper

  # EDR termination verbs composite
  - id: termination-verbs
    desc: Process termination verbs
    crit: notable
    conf: 0.5
    for: [elf, pe]
    any:
      - id: micro-traits/process/terminate/signal::kill
      - id: terminate-keyword

  # EDR process termination (verb + product name)
  - id: kill
    desc: EDR process termination
    crit: suspicious
    conf: 0.9
    for: [elf, pe]
    all:
      - id: termination-verbs
      - id: edr-product-name

  - id: bypass-detected
    desc: EDR/Antivirus bypass attempt
    crit: suspicious
    conf: 0.95
    mbc: "F0004"
    for: [pe, elf]
    any:
      - id: stopper
      - id: micro-traits/process/terminate/kill::terminate-process
    all:
      - id: edr-product-name
