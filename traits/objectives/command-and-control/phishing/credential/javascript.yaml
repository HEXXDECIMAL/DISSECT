# Phishing / Credential Harvesting - JavaScript
# Detects phishing pages and credential harvesting scripts
# ATT&CK: T1566.002 (Phishing: Spearphishing Link), T1056 (Input Capture)

defaults:
  for: [javascript]

traits:
  - id: js-microsoft-logo
    desc: Microsoft logo reference
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "Microsoft_logo.svg"

  - id: js-microsoft-login-text
    desc: Microsoft login branding
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: 'Microsoft\s+(account|login|sign.?in|365)'
    unless:
      - type: string
        regex: 'Microsoft\s+(Visual|C\+\+|Windows|Edge|Corporation)'

  - id: js-fake-login
    desc: Fake login form logic
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: 'id="emailInput"|id="passwordInput"|name="login-password"|id="login_form"'
    downgrade:
      any:
        - id: metadata/quality/testing::ruby-test-file
        - id: metadata/quality/testing::ruby-integration-test

  - id: js-bot-detection
    desc: Browser bot detection logic
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: 'navigator\.webdriver|headless|HeadlessChrome'

  - id: js-honeypot-field
    desc: Honeypot form field (anti-bot)
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: 'honeypot-field|class="honeypot"'

  - id: js-document-lure
    desc: Document sharing/preview lure
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: 'securely shared|Specification\.pdf|Project descriptions'

composite_rules:
  - id: js-ms-branding-indicators
    desc: Microsoft branding indicators
    crit: notable
    any:
      - id: js-microsoft-logo
      - id: js-microsoft-login-text

  - id: js-microsoft-phishing-page
    desc: Microsoft credential phishing page
    crit: hostile
    conf: 0.98
    attack: "T1566.002"
    all:
      - id: js-ms-branding-indicators
      - id: js-fake-login
    any:
      - id: js-bot-detection
      - id: js-document-lure
      - id: js-honeypot-field
