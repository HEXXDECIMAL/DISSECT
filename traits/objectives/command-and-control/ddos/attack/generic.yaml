# Generic DDoS Detection Patterns
# Detects common techniques used in DDoS tools:
# 1. High-concurrency network workers
# 2. Header/User-Agent rotation
# 3. DDoS-specific terminology (pps, bps, flood types)
# 4. Telemetry (packets sent, success rate)

defaults:
  for: [all]
  attack: "T1498" # Network Denial of Service
  mbc: "B0009" # Denial of Service

traits:
  # NOTE: Worker pool detection is handled by feat/concurrency/worker-pool (inert)
  # The command-and-control/ddos/worker-pool trait was removed because worker pools alone are not
  # indicators of DDoS - they're used legitimately by compilers, build tools, etc.
  # DDoS detection now requires additional context via composite rules.

  # === User-Agent Rotation ===
  - id: ua-list-large
    desc: Large list of browser User-Agents
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "Mozilla/5\\.0\\s*\\(|python-requests/[0-9]|curl/[0-9]|Wget/[0-9]"
      count_min: 12
  # === DDoS Terminology ===
  - id: attack-metrics-a
    desc: Performance metrics typical of DDoS
    crit: notable
    conf: 0.7
    if:
      type: string
      # Match performance metrics in context (e.g., "100 pps", "sent: 1000 bps")
      # Excludes standalone abbreviations that could appear in documentation
      regex: "\\b[0-9]+\\s*(pps|bps|qps)\\b"
      case_insensitive: true

  - id: attack-metrics-b
    desc: Performance metrics typical of DDoS
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\b(pps|bps|qps)\\s*[=:]\\s*[0-9]+"
      case_insensitive: true

  - id: syn-flood
    desc: SYN flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "[sS][yY][nN][_-]?flood"

  - id: udp-flood
    desc: UDP flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "[uU][dD][pP][_-]?[fF]lood"

  - id: http-flood
    desc: HTTP flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "[hH][tT][tT][pP][_-]?flood"

  - id: icmp-flood
    desc: ICMP flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "[iI][cC][mM][pP][_-]?flood"

  - id: slowloris-flood
    desc: Slowloris flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)slowloris[_-]?flood"

  - id: post-flood
    desc: POST flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)post[_-]?flood"

  - id: get-flood
    desc: GET flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)get[_-]?flood"

  - id: dns-flood
    desc: DNS flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)dns[_-]?flood"

  - id: memcached-flood
    desc: Memcached flood terminology
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)memcached[_-]?flood"

  - id: ddos-attack-ddos
    desc: DDOS attack terminology
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)ddos[_-]?attack"

  - id: ddos-attack-syn
    desc: SYN attack terminology
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)syn[_-]?attack"

  - id: ddos-attack-target-mode-type
    desc: Attack target/mode/type terminology
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)attack[_-]?(target|mode|type)"

  # === Telemetry ===
  - id: attack-telemetry-a1
    desc: Telemetry counters for attack progress
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\b(packets|requests)[_-](sent|total|count)\\b"
      case_insensitive: true

  - id: attack-telemetry-a2
    desc: Telemetry counters for attack progress
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\b(bytes|payloads)[_-](sent|total|count)\\b"
      case_insensitive: true

  - id: attack-telemetry-b1
    desc: Telemetry counters for attack progress
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\b(packets|requests)[_-](success|fail)\\b"
      case_insensitive: true

  - id: attack-telemetry-b2
    desc: Telemetry counters for attack progress
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\b(bytes|payloads)[_-](success|fail)\\b"
      case_insensitive: true

composite_rules:
  - id: attack-metrics
    desc: Performance metrics typical of DDoS
    crit: notable
    conf: 0.7
    any:
      - id: attack-metrics-a
      - id: attack-metrics-b

  - id: flood-types
    desc: Specific flood attack types
    crit: notable
    conf: 0.8
    any:
      - id: syn-flood
      - id: udp-flood
      - id: http-flood
      - id: icmp-flood
      - id: slowloris-flood
      - id: post-flood
      - id: get-flood
      - id: dns-flood
      - id: memcached-flood

  - id: attack-telemetry
    desc: Telemetry counters for attack progress
    crit: notable
    conf: 0.7
    any:
      - id: attack-telemetry-a1
      - id: attack-telemetry-a2
      - id: attack-telemetry-b1
      - id: attack-telemetry-b2

  - id: ddos-attack-terminology
    desc: Additional DDoS attack terminology
    crit: notable
    conf: 0.7
    any:
      - id: ddos-attack-ddos
      - id: ddos-attack-syn
      - id: ddos-attack-target-mode-type

  # Helper: Attack terminology
  - id: ddos-terminology
    desc: "DDoS-specific terminology detected"
    any:
      - id: flood-types
      - id: attack-metrics
    crit: notable

  # Helper: Bot mechanics
  - id: ddos-mechanics
    desc: "DDoS-specific operational mechanics detected"
    any:
      - id: micro-behaviors/process/create/workers/
      - id: attack-telemetry
    crit: notable

  # Helper: HTTP Methods
  - id: http-methods
    desc: "HTTP request methods detected"
    any:
      - id: micro-behaviors/communications/http/post
      - id: micro-behaviors/communications/http/request::request
      - id: micro-behaviors/communications/http/request::request-python
    crit: notable

  # High-confidence DDoS capability
  - id: ddos-capability
    desc: "Probable DDoS attack tool (Attack"
    crit: suspicious
    conf: 0.9
    all:
      - id: ddos-terminology
      - id: ddos-mechanics
      - id: micro-behaviors/communications/socket/create

  # Layer 7 DDoS (Application Layer)
  - id: layer7-ddos
    desc: "Layer 7 (HTTP) DDoS tool"
    crit: suspicious
    conf: 0.95
    all:
      - id: ua-list-large
      - id: http-methods
      - id: ddos-terminology
