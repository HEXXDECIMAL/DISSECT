defaults:
  for: [rtf]
  crit: suspicious
  mbc: C0002.002       # C2 via SMB
  attack: T1071.002    # Application Layer Protocol: SMB

traits:
  - id: unc-path-smb-ssl
    desc: "UNC path @SSL detected"
    if:
      type: string
      regex: '\\\\[a-zA-Z0-9\-\.]+@SSL\\'
    conf: 0.95

  - id: unc-path-network-share
    desc: "Network UNC path reference"
    if:
      type: string
      regex: '\\\\\\\\[a-zA-Z0-9\-\.]+\\'
    conf: 0.85

  - id: webdav-path
    desc: "WebDAV path detected"
    if:
      type: string
      regex: '[Dd]av[Ww]{2}[Ww]root|webdav'
    conf: 0.9
    attack: T1071.002

  # UTF-16LE encoded UNC paths (common in OLE object data)
  # freefoodaid.com in UTF-16LE: 66 72 65 65 66 6F 6F 64 61 69 64 2E 63 6F 6D
  - id: unc-path-utf16-server
    desc: "UTF-16LE server reference"
    if:
      type: string
      regex: '(66697265|64617461|7365727665|636F6D)[0-9A-Fa-f]*2E'
    conf: 0.75

  # @SSL in UTF-16LE: 40 00 53 53 4C
  - id: unc-path-utf16-ssl-400053534C
    desc: "UTF-16LE @SSL pattern variant 1"
    if:
      type: string
      regex: '400053534C'
    conf: 0.85

  - id: unc-path-utf16-ssl-400053005300004C
    desc: "UTF-16LE @SSL pattern variant 2"
    if:
      type: string
      regex: '400053005300004C'
    conf: 0.85

  # davwwwroot in UTF-16LE: 64 61 76 77 77 77 72 6F 6F 74
  - id: webdav-utf16-encoded
    desc: "UTF-16LE davwwwroot"
    if:
      type: string
      regex: '6400610076007700770072006F006F0074'
    conf: 0.9

  - id: c2-domain-freefoodaid
    desc: "C2 domain reference for freefoodaid.com"
    if:
      type: string
      word: freefoodaid
    conf: 0.95
    crit: suspicious
    attack: T1071

  - id: c2-domain-freefood
    desc: "C2 domain reference for freefood.com"
    if:
      type: string
      word: freefood
    conf: 0.95
    crit: suspicious
    attack: T1071

  - id: c2-domain-foodaid
    desc: "C2 domain reference for foodaid.com"
    if:
      type: string
      word: foodaid
    conf: 0.95
    crit: suspicious
    attack: T1071

  - id: c2-domain-utf16-encoded
    desc: "C2 domain in UTF-16LE encoding"
    if:
      type: string
      regex: '66007200650065006600'
    conf: 0.9
    crit: suspicious
    attack: T1071

  - id: email-account-reference
    desc: "Email account reference"
    if:
      type: string
      regex: '[a-zA-Z0-9\.\-_]+@[a-zA-Z0-9\.\-]+\.[a-zA-Z]{2,}'
    conf: 0.75
    attack: T1598

  - id: suspicious-remote-path-init
    desc: "Remote path with init parameter"
    if:
      type: string
      regex: '\\.lNk\?init=|\\\\tables\\\\.{0,50}init|HYPERLINK.{0,50}init'
    conf: 0.9
    crit: suspicious
    attack: T1204

  - id: file-handler-protocol-file
    desc: "File handler protocol detector: file://"
    if:
      type: string
      regex: 'file://'
    conf: 0.85
    attack: T1204

  - id: file-handler-protocol-mhtml
    desc: "File handler protocol detector: mhtml:"
    if:
      type: string
      regex: 'mhtml:'
    conf: 0.85
    attack: T1204

  - id: file-handler-protocol-mk
    desc: "File handler protocol detector: mk:"
    if:
      type: string
      regex: 'mk:'
    conf: 0.85
    attack: T1204

  - id: file-handler-protocol-about
    desc: "File handler protocol detector: about:"
    if:
      type: string
      regex: 'about:'
    conf: 0.85
    attack: T1204

  - id: file-handler-protocol-data
    desc: "File handler protocol detector: data:"
    if:
      type: string
      regex: 'data:'
    conf: 0.85
    attack: T1204

composite_rules:
  - id: c2-domain-indicator
    desc: "C2 domain reference (freefoodaid family)"
    crit: suspicious
    conf: 0.95
    attack: T1071
    for: [rtf]
    any:
      - id: c2-domain-freefoodaid
      - id: c2-domain-freefood
      - id: c2-domain-foodaid

  - id: unc-path-utf16-ssl
    desc: "UTF-16LE @SSL pattern"
    crit: suspicious
    conf: 0.85
    attack: T1071
    for: [rtf]
    any:
      - id: unc-path-utf16-ssl-400053534C
      - id: unc-path-utf16-ssl-400053005300004C
  - id: file-handler-protocol
    desc: "File handler protocol"
    crit: suspicious
    conf: 0.85
    attack: T1204
    for: [rtf]
    any:
      - id: file-handler-protocol-file
      - id: file-handler-protocol-mhtml
      - id: file-handler-protocol-mk
      - id: file-handler-protocol-about
      - id: file-handler-protocol-data
