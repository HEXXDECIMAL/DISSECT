defaults:
  crit: notable
  attack: T1071.001
  mbc: B0030
  for:
  - python
  - javascript
  - shell
traits:
- id: json-charset-utf8
  desc: JSON with UTF-8 charset
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: application/json.{0,50}charset=utf-8
- id: requests-json-headers
  desc: requests with JSON headers
  crit: suspicious
  conf: 0.8
  if:
    type: string
    regex: headers.{0,50}json|json.{0,50}headers
- id: http-post-json
  desc: HTTP POST with JSON
  crit: suspicious
  conf: 0.8
  size_max: 5000
  if:
    type: string
    regex: post.{0,50}json|json.{0,50}post
  unless:
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_requests
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_test
- id: json-data-post
  desc: JSON data POST exfiltration
  crit: suspicious
  conf: 0.85
  size_max: 5000
  if:
    type: string
    regex: requests\.post.{0,50}data.{0,50}json|post.{0,50}data=.{0,50}b64
  unless:
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_requests
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_test
- id: base64-json-payload
  desc: Base64 in JSON payload
  crit: suspicious
  conf: 0.85
  size_max: 5000
  if:
    type: string
    regex: json.{0,50}b64encode|b64encode.{0,50}data
  unless:
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_requests
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_test
- id: json-response-parse
  desc: JSON response parsing
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: response\.json|json\(response
- id: inline__json-exfiltration__unless_requests
  desc: Raw editor token 'requests' seen
  crit: notable
  conf: 0.4
  if:
    type: raw
    word: requests
- id: inline__json-exfiltration__unless_test
  desc: Raw editor token 'test' seen
  crit: notable
  conf: 0.4
  if:
    type: raw
    word: test
- id: http-response-text
  desc: HTTP response text extraction
  crit: notable
  conf: 0.65
  if:
    type: string
    regex: response\.text|text.{0,50}response
composite_rules:
- id: json-c2-headers
  desc: JSON C2 communication headers
  crit: notable
  conf: 0.85
  attack: T1071.001
  needs: 3
  any:
  - id: micro-behaviors/communications/http/request::application-json
  - id: json-charset-utf8
  - id: requests-json-headers
- id: json-exfiltration
  desc: JSON data exfiltration
  crit: suspicious
  conf: 0.9
  attack: T1041
  mbc: B0030
  for:
  - python
  - javascript
  size_max: 5000
  needs: 3
  any:
  - id: json-data-post
  - id: base64-json-payload
  - id: http-post-json
  all:
  - id: micro-behaviors/communications/http/request::application-json
  unless:
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_requests
  - id: objectives/command-and-control/network/beacon/json-c2::inline__json-exfiltration__unless_test
- id: json-c2-protocol
  desc: JSON C2 communication protocol
  crit: suspicious
  conf: 0.95
  attack: T1071.001
  mbc: B0030
  platforms:
  - all
  needs: 2
  all:
  - id: json-c2-headers
  - id: json-exfiltration
