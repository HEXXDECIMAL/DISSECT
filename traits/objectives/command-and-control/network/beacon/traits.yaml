defaults:
  for:
  - all
traits:
- id: post-template
  desc: POST HTTP template with format specifier
  crit: notable
  conf: 0.6
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: POST\s+%s\s+HTTP
- id: get-template
  desc: GET HTTP template with format specifier
  crit: notable
  conf: 0.6
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: GET\s+%s\s+HTTP
- id: compact-beacon-a
  desc: Dense C2 patterns in compact binary
  crit: suspicious
  conf: 0.88
  mbc: B0030
  attack: T1071.001
  for:
  - elf
  - macho
  - pe
  size_max: 100000
  if:
    type: string
    regex: (User-Agent|POST\s+|GET\s+|HTTP/1\.)
    count_min: 5
    per_kb_min: 0.5
- id: compact-beacon-b
  desc: Dense C2 patterns in compact binary
  crit: suspicious
  conf: 0.88
  mbc: B0030
  attack: T1071.001
  for:
  - elf
  - macho
  - pe
  size_max: 100000
  if:
    type: string
    regex: Content-Type
    count_min: 5
    per_kb_min: 0.5
- id: user-agent-header-multiple
  desc: Multiple User-Agent header entries
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: 'User-Agent:'
    count_min: 3
- id: googlebot-ua
  desc: Googlebot User-Agent
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (?i)Googlebot/\d|Mozilla/5\.0\s+\+http://www\.google\.com/bot\.html
- id: bingbot-ua
  desc: bingbot User-Agent
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (?i)bingbot/\d
- id: baiduspider-ua
  desc: Baiduspider User-Agent
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (?i)Baiduspider/\d
- id: yandexbot-ua
  desc: YandexBot User-Agent
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (?i)YandexBot/\d
- id: duckduckbot-ua
  desc: DuckDuckBot User-Agent
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (?i)DuckDuckBot/\d
- id: wget-download
  desc: wget download command (payload fetching)
  crit: suspicious
  conf: 0.8
  mbc: E1105
  attack: T1105
  if:
    type: string
    regex: wget\s+https?://
- id: typosquat-git-hub
  desc: Git typosquat domain
  crit: suspicious
  conf: 0.95
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    substr: git-hub
- id: typosquat-domain-pattern-a
  desc: Typosquat domain pattern
  crit: suspicious
  conf: 0.8
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: githuk\.|gihub\.|gthub\.|githhub\.
  not:
  - substr: github.com
  - substr: github.io
  - substr: github.org
- id: typosquat-domain-pattern-b
  desc: Typosquat domain pattern
  crit: suspicious
  conf: 0.8
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: githab\.|githyb\.|github\.[a-z]{2,}
  not:
  - substr: github.com
  - substr: github.io
  - substr: github.org
- id: c2-command-pattern-numeric
  desc: Numeric C2 command protocol
  crit: suspicious
  conf: 0.85
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: cmd[_-]?type.{0,5}=.{0,5}["']?[0-9]{3}["']?
- id: c2-response-pattern-numeric
  desc: C2 response code parsing
  crit: suspicious
  conf: 0.85
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: res\[.{0,10}:.{0,10}\+.{0,5}[0-9]{3}
- id: sleep-in-while-true
  desc: Infinite loop with sleep delay
  crit: suspicious
  conf: 0.85
  mbc: B0030
  attack: T1071.001
  for:
  - python
  - javascript
  - shell
  if:
    type: string
    regex: while\s+True:.*?sleep\s*\(
- id: c2-polling-loop
  desc: C2 polling with sleep interval
  crit: suspicious
  conf: 0.8
  mbc: B0030
  attack: T1071.001
  for:
  - python
  - javascript
  - shell
  if:
    type: string
    regex: while\s+1.{0,50}sleep
- id: json-content-type-header
  desc: JSON content-type for C2 communication
  crit: notable
  conf: 0.7
  mbc: B0030
  attack: T1071.001
  if:
    type: string
    regex: application/json.{0,50}charset
- id: user-agent-literal-pool
  desc: Multiple concrete User-Agent literals
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: User-Agent:\s*(Mozilla/5\.0|curl/[0-9]|Wget/[0-9]|python-requests/[0-9])
    count_min: 2
- id: user-agent-rotation-keywords-a
  desc: User-Agent randomization or rotation terms
  crit: notable
  conf: 0.75
  if:
    type: string
    case_insensitive: true
    regex: user.?agent.{0,20}(?:rotate|random|pool|list)
- id: user-agent-rotation-keywords-b
  desc: User-Agent randomization or rotation terms
  crit: notable
  conf: 0.75
  if:
    type: string
    case_insensitive: true
    regex: random\.choice\(.{0,40}user.?agent
composite_rules:
- id: http-template
  desc: HTTP request template with placeholders
  crit: suspicious
  conf: 0.85
  mbc: B0030
  attack: T1071.001
  any:
  - id: post-template
  - id: get-template
- id: bot-user-agent
  desc: Search engine bot User-Agent (DDoS/evasion)
  crit: notable
  conf: 0.85
  mbc: B0030
  attack: T1071.001
  any:
  - id: googlebot-ua
  - id: bingbot-ua
  - id: baiduspider-ua
  - id: yandexbot-ua
  - id: duckduckbot-ua
- id: user-agent-rotation
  desc: Multiple User-Agent strings (evasion technique)
  crit: suspicious
  conf: 0.82
  mbc: F0001.004
  attack: T1036
  all:
  - id: user-agent-header-multiple
  - id: user-agent-literal-pool
  - id: user-agent-rotation-keywords
- id: compact-beacon
  desc: Dense C2 patterns in compact binary
  crit: suspicious
  conf: 0.88
  mbc: B0030
  attack: T1071.001
  for:
  - elf
  - macho
  - pe
  any:
  - id: compact-beacon-a
  - id: compact-beacon-b
- id: typosquat-domain-pattern
  desc: Typosquat domain pattern
  crit: suspicious
  conf: 0.8
  mbc: B0030
  attack: T1071.001
  any:
  - id: typosquat-domain-pattern-a
  - id: typosquat-domain-pattern-b
- id: user-agent-rotation-keywords
  desc: User-Agent randomization or rotation terms
  crit: notable
  conf: 0.75
  any:
  - id: user-agent-rotation-keywords-a
  - id: user-agent-rotation-keywords-b
- id: direct-http-c2
  desc: Direct HTTP C2 infrastructure
  crit: notable
  conf: 0.95
  mbc: B0030
  attack: T1071.001
  size_max: 1500000
  all:
  - id: objectives/command-and-control/infrastructure/ip
- id: c2-http-ip-binary
  desc: HTTP IP-based C2 in binary
  crit: notable
  conf: 0.95
  mbc: B0030
  attack: T1071.001
  for:
  - elf
  - macho
  - pe
  size_max: 1500000
  all:
  - id: direct-http-c2
  - id: micro-traits/process/create/
  - id: micro-traits/comm/socket/
- id: hardcoded-ip
  desc: Hardcoded IP endpoint
  crit: suspicious
  conf: 0.75
  mbc: B0030
  for:
  - elf
  - macho
  - pe
  size_max: 150000
  downgrade:
    any:
    - type: string
      substr: Certificate
    - type: string
      substr: DigiCert
    - type: string
      substr: Python Software Foundation
    - type: string
      substr: schemas-microsoft-com:asm
    - type: string
      substr: Microsoft Corporation
    - type: string
      substr: "Microsoft\xAE Windows\xAE Operating System"
  unless:
  - id: objectives/command-and-control/network/beacon/traits::inline__hardcoded-ip__unless_1
  any:
  - id: objectives/c2/network/beacon::inline__hardcoded-ip__any_1
  - id: objectives/c2/network/beacon::inline__hardcoded-ip__any_2
- id: multiple-hardcoded-ips
  desc: Multiple hardcoded IP endpoints (C2 redundancy)
  crit: suspicious
  conf: 0.9
  mbc: B0030
  attack: T1071.001
  for:
  - elf
  - macho
  - pe
  size_max: 500000
  downgrade:
    any:
    - type: string
      substr: Certificate
    - type: string
      substr: DigiCert
    - type: string
      substr: Python Software Foundation
    - type: string
      substr: schemas-microsoft-com:asm
    - type: string
      substr: Microsoft Corporation
    - type: string
      substr: "Microsoft\xAE Windows\xAE Operating System"
  unless:
  - id: objectives/command-and-control/network/beacon/traits::inline__multiple-hardcoded-ips__unless_1
  - id: objectives/command-and-control/network/beacon/traits::inline__multiple-hardcoded-ips__unless_2
  any:
  - id: objectives/c2/network/beacon::inline__multiple-hardcoded-ips__any_1
  - id: objectives/c2/network/beacon::inline__multiple-hardcoded-ips__any_2
