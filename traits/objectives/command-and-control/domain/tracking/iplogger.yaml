defaults:
  for: [all]

traits:
  - id: iplogger-domain-a
    desc: "Detects iplogger tracking domains"
    crit: suspicious
    if:
      type: string
      regex: "iplogger\\.(?:org|com|net|ru)"

  - id: iplogger-domain-b
    desc: "Detects iplogger tracking domains"
    crit: suspicious
    if:
      type: string
      regex: "2no\\.co|yip\\.su"

  - id: tracking-services-domain-a
    desc: "Detects tracking domains in malware beacons"
    crit: suspicious
    if:
      type: string
      regex: "(grabify\\.link|blasze\\.com|canarytokens\\.com)"

  - id: tracking-services-domain-b
    desc: "Detects tracking domains in malware beacons"
    crit: suspicious
    if:
      type: string
      regex: "(bitly\\.com|tinyurl\\.com)"

  # Removed iplogger-string duplicate - use objectives/discovery/network/scan::iplogger-keyword (more complete, has attack mapping)

  - id: iplogger-http-http
    desc: "Detects HTTP indicators often with iplogger"
    crit: notable
    if:
      type: string
      word: "http"

  - id: iplogger-http-get
    desc: "Detects HTTP indicators often with iplogger"
    crit: notable
    if:
      type: string
      word: "get"

  - id: iplogger-http-post
    desc: "Detects HTTP indicators often with iplogger"
    crit: notable
    if:
      type: string
      word: "post"

  - id: iplogger-http-request
    desc: "Detects HTTP indicators often with iplogger"
    crit: notable
    if:
      type: string
      word: "request"

composite_rules:
  - id: iplogger-domain
    desc: "Detects iplogger tracking domains"
    crit: suspicious
    any:
      - id: iplogger-domain-a
      - id: iplogger-domain-b

  - id: tracking-services-domain
    desc: "Detects tracking domains in malware beacons"
    crit: suspicious
    any:
      - id: tracking-services-domain-a
      - id: tracking-services-domain-b

  - id: iplogger-keyword-context
    desc: "Detects 'iplogger' keyword with HTTP indicators"
    crit: suspicious
    all:
      - id: objectives/discovery/network/scan::iplogger-keyword
      - id: iplogger-http

  - id: fragmented-tracking-beacon
    desc: "Detects fragmented tracking/logging URL construction"
    crit: suspicious
    all:
      - id: micro-traits/comm/http/lib/netlib
    any:
      - id: objectives/discovery/network/scan::iplogger-keyword
      - id: iplogger-domain
      - id: tracking-services-domain

  - id: iplogger-http
    desc: "Detects HTTP indicators often with iplogger"
    crit: notable
    any:
      - id: iplogger-http-http
      - id: iplogger-http-get
      - id: iplogger-http-post
      - id: iplogger-http-request
