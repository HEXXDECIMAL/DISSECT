defaults:
  crit: suspicious
  attack: T1105
  mbc: B0030
  for:
  - shell
traits:
- id: download-execute
  desc: Downloads and executes remote script
  crit: suspicious
  conf: 0.95
  attack: T1059.004
  if:
    type: raw
    regex: (curl|wget)\s+[^|]{0,50}\|\s*sh
- id: download-execute-quiet
  desc: Silent download and execute
  crit: suspicious
  conf: 0.95
  attack: T1059.004
  if:
    type: raw
    regex: (curl\s+-[so]|wget\s+-[qO])\s+[^|]{0,50}\|\s*sh
- id: download-save-execute
  desc: Downloads, saves, and executes
  crit: suspicious
  conf: 0.9
  if:
    type: raw
    regex: (curl\s+-o|wget\s+-O)\s+\S+[^&]{0,50}&&[^&]{0,30}chmod\s+\+x
- id: download-url-hardcoded
  desc: Hardcoded download URL
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: (curl|wget)\s+[^\n]{0,50}https?://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+
  unless:
  - type: raw
    regex: 127\.0\.0\.1|0\.0\.0\.0
- id: md5-verification
  desc: MD5 checksum verification
  crit: notable
  conf: 0.8
  if:
    type: raw
    regex: md5sum\s+\S+\s*\|\s*awk
- id: payload-checksum-compare
  desc: Payload integrity verification
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: \$MD5[^=]{0,20}=[^$]{0,20}\$sum|\$sum[^=]{0,20}=[^$]{0,20}\$MD5|checkExists
- id: loader-selection-command-test
  desc: Checks command -v for curl or wget
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: command\s+-v\s+(curl|wget)
- id: loader-selection-env-var
  desc: LDR/WGET/DL env var for curl/wget
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: \b(LDR|WGET|DL)\s*=\s*(curl|wget)
composite_rules:
- id: loader-selection
  desc: Selects curl or wget dynamically
  crit: suspicious
  conf: 0.85
  any:
    - id: loader-selection-command-test
    - id: loader-selection-env-var

- id: verified-dropper
  desc: Verified payload dropper
  crit: hostile
  conf: 0.95
  attack: T1105
  all:
  - id: loader-selection
  - id: download-url-hardcoded
  - id: payload-checksum-compare
  - id: download-save-execute
- id: simple-dropper
  desc: Simple download-execute dropper
  crit: suspicious
  conf: 0.9
  attack: T1105
  all:
  - id: download-execute
  - id: download-url-hardcoded
