# Windows Batch Dropper Objectives
# Combines batch dropper techniques with C2 indicators and defense evasion
# MBC: B0030 (Dropper), C0002 (Download)
# ATT&CK: T1059.003, T1105, T1562.001

composite_rules:
  # Download + Execute + Security Bypass (AV disable/exclusion)
  # This is the classic malware dropper pattern:
  # 1. Disable/bypass security tools
  # 2. Download payload from remote URL
  # 3. Execute the downloaded payload
  # Complexity: all(3) + file_types(1) = 4 -> hostile
  - id: security-bypass-dropper
    desc: Dropper with security tool bypass
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1562.001"
    for: [batch, shell]
    all:
      - id: objectives/anti-analysis/security-bypass/platform::bypass
      - id: objectives/execution/dropper/script::download-tool
      - id: objectives/execution/dropper/script::exec-cmd

  # Download + Execute + Defender Exclusion specifically
  # Complexity: all(3) + file_types(1) = 4 -> hostile
  - id: defender-exclusion-dropper
    desc: Dropper with Defender exclusion
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1562.001"
    for: [batch, shell, powershell]
    all:
      - id: objectives/anti-analysis/security-bypass/platform::defender-exclusion
      - id: objectives/execution/dropper/script::download-file-ps
      - id: objectives/execution/dropper/script::exec-cmd

  # PowerShell download cradle in batch with security bypass
  # Complexity: all(3) + file_types(1) = 4 -> hostile
  - id: ps-cradle-security-bypass
    desc: PowerShell cradle with security bypass
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1059.001"
    for: [batch, shell]
    all:
      - id: objectives/anti-analysis/security-bypass/platform::bypass
      - id: objectives/execution/dropper/script::powershell-download
      - id: objectives/execution/dropper/script::exec-cmd

  # UAC bypass + Download + Execute
  # Complexity: all(3) + file_types(1) = 4 -> hostile
  - id: uac-bypass-dropper
    desc: UAC bypass dropper
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1548.002"
    for: [batch, shell, powershell]
    all:
      - id: objectives/anti-analysis/security-bypass/platform::start-process-runas
      - id: objectives/execution/dropper/script::download-tool
      - id: objectives/execution/dropper/script::exec-cmd

  # AV check (tasklist) + Security bypass + dropper
  # Classic pattern: check for AV, disable it, then download/execute
  # Complexity: all(4) = 4 -> hostile
  - id: av-aware-dropper
    desc: AV-aware dropper with bypass
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1562.001"
    for: [batch, shell]
    all:
      - id: objectives/anti-analysis/security-bypass/platform::tasklist-av-check
      - id: objectives/anti-analysis/security-bypass/platform::bypass
      - id: objectives/execution/dropper/script::download-tool
      - id: objectives/execution/dropper/script::exec-cmd

  # Malwarebytes disable + dropper
  # Complexity: all(3) + file_types(1) = 4 -> hostile
  - id: malwarebytes-bypass-dropper
    desc: Malwarebytes bypass dropper
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1562.001"
    for: [batch, shell]
    all:
      - id: objectives/anti-analysis/security-bypass/platform::malwarebytes-stop-service
      - id: objectives/execution/dropper/script::download-tool
      - id: objectives/execution/dropper/script::exec-cmd

  # MSHTA remote fetch with obfuscated IP address
  # LOLBin proxy execution + IP evasion = strong dropper signal
  # Precision: all(2 traits) -> sum of both trait precisions > 4.0
  - id: mshta-obfuscated-dropper
    desc: MSHTA dropper with obfuscated IP
    crit: hostile
    conf: 0.95
    mbc: "E1218.005"
    attack: "T1218.005"
    for: [batch, shell, powershell]
    all:
      - id: objectives/execution/dropper/loader::mshta-remote-url
      - id: objectives/anti-static/obfuscation/ip-notation::hex-octal-ip-in-url

  # Heavy Obfuscation + PowerShell Execution + MOTW Removal
  # Complexity: all(3) + file_types(1) = 4 -> hostile
  - id: obfuscated-powershell-loader
    desc: Obfuscated PowerShell loader in batch
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [batch, shell]
    all:
      - id: objectives/anti-static/obfuscation/strings/concatenation::batch-heavy-obfuscation
      - id: objectives/execution/dropper/script::powershell-exe
      - id: objectives/anti-forensics/evidence-removal/cleanup::motw-removal-stream
