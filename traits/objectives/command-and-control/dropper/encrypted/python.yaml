# Encrypted Payload Dropper Detection
# Detects Python droppers that decrypt and load encrypted payloads
# ATT&CK: T1027.002 (Software Packing), T1620 (Reflective Code Loading)

composite_rules:
  # Hostile encrypted payload loader (complexity >= 4)
  # Complexity: file_types=1 + all=2 + any=1 = 4
  - id: encrypted-payload-loader
    desc: Encrypted payload dropper with dynamic loading
    crit: hostile
    conf: 0.98
    for: [python]
    mbc: "B0024"
    attack: "T1027.002"
    all:
      - id: objectives/execution/reflection/class::python-zipimporter-load
      - id: micro-traits/data/encode/base64::b64decode-string
    any:
      - id: micro-traits/crypto/symmetric/aes::pyaes-usage
      - id: micro-traits/crypto/symmetric/aes::pycrypto-usage
      - id: micro-traits/crypto/symmetric/fernet::decrypt
