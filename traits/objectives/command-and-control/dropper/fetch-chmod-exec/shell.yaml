# Shell Dropper Objective
# Combines shell dropper techniques with C2 indicators
# MBC: B0030 (Dropper), C0002 (Download)
# ATT&CK: T1059.004, T1105

composite_rules:
  # Download from raw IP + execute
  # Complexity: all(3) = 3 -> suspicious
  - id: raw-ip-dropper
    desc: Download from raw IP and execute
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1105"
    for: [shell]
    all:
      - id: objectives/command-and-control/infrastructure/ip::http-raw-ip-url
      - id: objectives/execution/dropper/script::curl-download
      - id: micro-behaviors/fs/file/executable::chmod-plus-x

  # Download from raw IP + Gatekeeper bypass + execute
  # Complexity: all(4) = 4 -> hostile
  - id: raw-ip-gatekeeper-dropper
    desc: Raw IP dropper with Gatekeeper bypass
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1553.001"
    for: [shell]
    all:
      - id: objectives/command-and-control/infrastructure/ip::http-raw-ip-url
      - id: objectives/execution/dropper/script::curl-download
      - id: micro-behaviors/fs/attributes/xattr::xattr-clear
      - id: objectives/execution/dropper/script::execute-dot-slash

  # Temp directory staging dropper
  # Complexity: all(4) = 4 -> hostile
  - id: tmpdir-staged-dropper
    desc: Download to temp dir and execute
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1059.004"
    for: [shell]
    all:
      - id: tmpdir-variable
      - id: objectives/execution/dropper/script::curl-download
      - id: micro-behaviors/fs/file/executable::chmod-plus-x
      - id: objectives/execution/dropper/script::execute-dot-slash

  # Download from external URL + chmod + execute
  # Complexity: all(4) = 4 -> hostile
  - id: url-dropper
    desc: Download from URL, chmod, and execute
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1105"
    for: [shell]
    all:
      - id: objectives/command-and-control/infrastructure/domain::http-url-script
      - id: objectives/execution/dropper/script::curl-download-file
      - id: micro-behaviors/fs/file/executable::chmod-plus-x
      - id: objectives/execution/dropper/script::execute-dot-slash

  # Download file + make executable + detached execution
  # Precision: all(4) + any(1) + for(1) >= 4 -> hostile
  - id: fetch-chmod-background-exec
    desc: Download, chmod, and execute detached
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1105"
    for: [shell]
    all:
      - id: objectives/execution/dropper/script::curl-download-file
      - id: objectives/execution/dropper/script::execute-dot-slash
      - id: objectives/execution/background/daemon::nohup-command
    any:
      - id: micro-behaviors/fs/file/executable::chmod-plus-x
      - id: micro-behaviors/fs/file/executable::chmod-755

traits:
  - id: tmpdir-variable
    desc: $TMPDIR environment variable usage
    crit: notable
    conf: 0.7
    for: [shell]
    if:
      type: raw
      regex: '\$TMPDIR|\$\{TMPDIR\}'
