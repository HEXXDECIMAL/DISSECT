# Go RAT/Implant Detection
# Detects Go binaries with RAT characteristics including:
# - Remote shell execution modules
# - SOCKS5 proxy functionality
# - File upload/download
# - History cleaning (anti-forensics)
# - Timestomping
# MBC: B0024 (Remote Access), B0030 (C2 Communication)
# ATT&CK: T1059.004 (Unix Shell), T1090.001 (Internal Proxy)

defaults:
  for: [elf, macho, pe]
  mbc: "B0024"

traits:
  # Go module path for shell execution (common RAT pattern)
  - id: go-shell-module
    desc: Go shell execution module path
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: 'mode/(httpAndTcp/)?shell[./]|/shell/Shell(Linux|Windows|Darwin)\.'

  # Go SOCKS5 proxy module (tunneling capability)
  - id: go-socks-proxy-module
    desc: Go SOCKS5 proxy module
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1090.001"
    if:
      type: string
      regex: "socket5Quick|socks5Quick|proxy/socks|socksProxy"

  # Go port forwarding module (inForward variants)
  - id: go-port-forward-inforward
    desc: Go inForward port forwarding module
    crit: notable
    conf: 0.9
    attack: "T1090"
    if:
      type: string
      regex: 'inForward\.(Start|Stop|addTask)'

  - id: go-port-forward-portforward
    desc: Go portForward module
    crit: notable
    conf: 0.9
    attack: "T1090"
    if:
      type: string
      exact: "portForward"

  - id: go-port-forward-tunnelforward
    desc: Go tunnelForward module
    crit: notable
    conf: 0.9
    attack: "T1090"
    if:
      type: string
      exact: "tunnelForward"

  # Go history cleaning function (anti-forensics)
  - id: go-clean-history-cleanhistory
    desc: Go history cleaning function
    crit: suspicious
    conf: 0.95
    attack: "T1070.003"
    if:
      type: string
      exact: "CleanHistory"

  - id: go-clean-history-clearhistory
    desc: Go history cleaning function
    crit: suspicious
    conf: 0.95
    attack: "T1070.003"
    if:
      type: string
      exact: "clearHistory"

  - id: go-clean-history-historyclear
    desc: Go history cleaning function
    crit: suspicious
    conf: 0.95
    attack: "T1070.003"
    if:
      type: string
      exact: "HistoryClear"

  # Go timestomping function
  - id: go-timestomp-change-self-time
    desc: Go timestomping function
    crit: suspicious
    conf: 0.95
    attack: "T1070.006"
    if:
      type: string
      exact: "ChangeSelfTime"

  - id: go-timestomp-modify-timestamp
    desc: Go timestomping function
    crit: suspicious
    conf: 0.95
    attack: "T1070.006"
    if:
      type: string
      exact: "modifyTimestamp"

  - id: go-timestomp-touch-time
    desc: Go timestomping function
    crit: suspicious
    conf: 0.95
    attack: "T1070.006"
    if:
      type: string
      exact: "TouchTime"

  # Go file transfer utilities (C2 feature)
  - id: go-file-utils
    desc: Go file transfer utilities
    crit: notable
    conf: 0.85
    attack: "T1105"
    if:
      type: string
      regex: 'utils\.(Upload|Download|SendDataByPost)'

  # Go system info gathering
  - id: go-system-recon
    desc: Go system information gathering
    crit: notable
    conf: 0.85
    attack: "T1082"
    if:
      type: string
      regex: "(getSystemInfo|UpdateSysteminfo|makeSystemInfo|ProcessTask)"

  # Go directory listing (recon)
  - id: go-dir-enum-get-dir-list
    desc: Go directory enumeration
    crit: notable
    conf: 0.8
    attack: "T1083"
    if:
      type: string
      exact: "GetDirList"

  - id: go-dir-enum-list-directory
    desc: Go directory enumeration
    crit: notable
    conf: 0.8
    attack: "T1083"
    if:
      type: string
      exact: "ListDirectory"

  - id: go-dir-enum-read-dir
    desc: Go directory enumeration
    crit: notable
    conf: 0.8
    attack: "T1083"
    if:
      type: string
      exact: "ReadDir"

  # Interactive shell string indicators
  - id: interactive-shell-string-interactive
    desc: Interactive shell mode strings
    crit: notable
    conf: 0.85
    if:
      type: string
      exact: "interactive_shell"

  - id: interactive-shell-string-exec-shell
    desc: Interactive shell mode strings
    crit: notable
    conf: 0.85
    if:
      type: string
      exact: "Exec_shell"

  - id: interactive-shell-string-execshell
    desc: Interactive shell mode strings
    crit: notable
    conf: 0.85
    if:
      type: string
      exact: "execShell"

  # Socket quick start/stop (backdoor control)
  - id: socket-quick-control
    desc: Socket quick control functions
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "socket_quick_(start|stop)|StartProxy|StopProxy"

composite_rules:
  - id: go-port-forward-module
    desc: Go port forwarding module
    crit: notable
    conf: 0.9
    attack: "T1090"
    any:
      - id: go-port-forward-inforward
      - id: go-port-forward-direct

  - id: go-port-forward-direct
    desc: Go portForward/tunnelForward module
    crit: notable
    conf: 0.9
    attack: "T1090"
    any:
      - id: go-port-forward-portforward
      - id: go-port-forward-tunnelforward

  # Go RAT with shell + proxy (common combination)
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: go-rat-shell-proxy
    desc: Go RAT with shell and SOCKS proxy
    crit: hostile
    conf: 0.98
    mbc: "B0024"
    attack: "T1059.004"
    for: [elf, macho, pe]
    all:
      - id: go-shell-module
      - id: go-socks-proxy-module
      - id: micro-behaviors/process/create/shell::go-shell-strings

  # Go RAT with full capability set
  # Complexity: all(4) + for(1) = 5 >= 4 HOSTILE
  - id: go-rat-full
    desc: Go RAT with full C2 capabilities
    crit: hostile
    conf: 0.98
    mbc: "B0024"
    attack: "T1059.004"
    for: [elf, macho, pe]
    all:
      - id: go-shell-module
      - id: go-file-utils
      - id: go-system-recon
      - id: micro-behaviors/process/create/shell::go-shell-strings

  # Go RAT with anti-forensics
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: go-rat-antiforensics
    desc: Go RAT with anti-forensics capabilities
    crit: hostile
    conf: 0.98
    mbc: "B0024"
    attack: "T1070"
    for: [elf, macho, pe]
    all:
      - id: go-shell-module
      - id: go-clean-history
      - id: micro-behaviors/process/create/shell::go-shell-strings

  # Go RAT with timestomping
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: go-rat-timestomp
    desc: Go RAT with timestomping
    crit: hostile
    conf: 0.98
    mbc: "B0024"
    attack: "T1070.006"
    for: [elf, macho, pe]
    all:
      - id: go-shell-module
      - id: go-timestomp
      - id: micro-behaviors/process/create/shell::go-shell-strings

  # Go implant with proxy + file transfer
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: go-implant-proxy-transfer
    desc: Go implant with proxy and file transfer
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1090.001"
    for: [elf, macho, pe]
    all:
      - id: go-socks-proxy-module
      - id: go-file-utils
      - id: micro-behaviors/process/create/shell::go-shell-strings

  - id: go-clean-history
    desc: Go history cleaning function
    crit: suspicious
    conf: 0.95
    attack: "T1070.003"
    any:
      - id: go-clean-history-cleanhistory
      - id: go-clean-history-clearhistory
      - id: go-clean-history-historyclear

  - id: go-timestomp
    desc: Go timestomping function
    crit: suspicious
    conf: 0.95
    attack: "T1070.006"
    any:
      - id: go-timestomp-change-self-time
      - id: go-timestomp-modify-timestamp
      - id: go-timestomp-touch-time

  - id: go-dir-enum
    desc: Go directory enumeration
    crit: notable
    conf: 0.8
    attack: "T1083"
    any:
      - id: go-dir-enum-get-dir-list
      - id: go-dir-enum-list-directory
      - id: go-dir-enum-read-dir

  - id: interactive-shell-string
    desc: Interactive shell mode strings
    crit: notable
    conf: 0.85
    any:
      - id: interactive-shell-string-interactive
      - id: interactive-shell-string-exec-shell
      - id: interactive-shell-string-execshell
