# PHP Webshell Composite Detection Rules
# These rules combine multiple traits to identify webshell behavior patterns
# MBC: B0030 (C2 Communication)
# ATT&CK: T1505.003 (Server Software Component: Web Shell)

composite_rules:
  # High-confidence webshell detection
  - id: php-backdoor
    desc: "PHP webshell: session-based backdoor with"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/persistence/session
      - id: micro-behaviors/data/user-input/
    any:
      - id: objectives/anti-static/obfuscation/
      - id: micro-behaviors/fs/write/
      - id: micro-behaviors/process/create/shell

  # Dropper webshell (writes decoded payloads)
  - id: php-dropper
    desc: "PHP dropper: decodes and writes"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1105"
    for: [php]
    all:
      - id: objectives/anti-static/obfuscation/
      - id: micro-behaviors/fs/write/
    any:
      - id: micro-behaviors/data/user-input/
      - id: micro-behaviors/data/user-input/

  # Self-destructing webshell
  - id: php-self-destruct
    desc: "PHP webshell with self-deletion capability"
    crit: suspicious
    conf: 0.95
    mbc: "F0006"
    attack: "T1070.004"
    for: [php]
    all:
      - id: objectives/evasion/self-destruct/script::script-self-delete
      - id: micro-behaviors/data/user-input/

  # SSRF/Proxy webshell
  - id: php-proxy
    desc: "PHP proxy/SSRF webshell for fetching"
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1090"
    for: [php]
    all:
      - id: micro-behaviors/communications/http/curl::init
    any:
      - id: micro-behaviors/data/user-input/
      - id: micro-behaviors/data/user-input/
      - id: micro-behaviors/communications/http/curl::ssl-verify-disable
      - id: micro-behaviors/communications/http/curl::ssl-host-disable

    needs: 1

  # Timestamp manipulation (anti-forensic)
  - id: php-timestomp
    desc: "PHP webshell with timestamp manipulation"
    crit: suspicious
    conf: 0.9
    mbc: "F0006"
    attack: "T1070.006"
    for: [php]
    all:
      - id: objectives/evasion/timestomp/modify::timestomp
      - id: micro-behaviors/fs/write/

  # Hardcoded authentication backdoor
  - id: php-hardcoded-auth
    desc: "PHP webshell with hardcoded hash"
    crit: notable
    conf: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    any:
      - id: objectives/command-and-control/webshell/backdoor::hardcoded-hash-auth
      - id: objectives/command-and-control/webshell/backdoor::substr-hash-compare

  # File upload webshell
  - id: php-uploader
    desc: "PHP webshell with file upload"
    crit: notable
    conf: 0.9
    mbc: "B0030"
    attack: "T1105"
    for: [php]
    any:
      - id: micro-behaviors/data/user-input/
      - id: micro-behaviors/communications/http/curl::file-upload
      - id: micro-behaviors/fs/write/
      - id: micro-behaviors/fs/write/
  # Command execution webshell
  - id: php-rce
    desc: "PHP webshell with remote command"
    crit: notable
    conf: 0.95
    mbc: "E1059"
    attack: "T1059.004"
    for: [php]
    any:
      - id: micro-behaviors/process/create/shell
      - id: objectives/anti-static/obfuscation/
      - id: micro-behaviors/data/user-input/

  # HOSTILE: eval(base64_decode(...)) pattern - classic PHP backdoor
  # This pattern has no legitimate use and is a hallmark of PHP webshells
  - id: php-eval-base64-backdoor
    desc: "PHP backdoor: eval of base64 payload"
    crit: suspicious
    conf: 0.99
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/command-and-control/webshell/backdoor::eval-base64-large-payload
      - id: objectives/anti-static/obfuscation/code-metrics::php-webshell-pattern
  # Web UI webshell (has HTML interface)
  - id: php-web-ui
    desc: "PHP webshell with web-based user"
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/command-and-control/webshell/backdoor::password-form
    any:
      - id: objectives/persistence/session
      - id: micro-behaviors/data/user-input/

  # Google scraping webshell (SEO spam tool)
  - id: php-seo-tool
    desc: "PHP SEO spam tool with"
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/command-and-control/webshell/backdoor::google-search-scrape
      - id: micro-behaviors/communications/http/curl::init

  # Obfuscated payload webshell
  - id: php-obfuscated
    desc: "PHP webshell with heavily obfuscated"
    crit: notable
    conf: 0.9
    mbc: "B0032"
    attack: "T1027"
    for: [php]
    all:
      - id: objectives/anti-static/obfuscation/

  # Decompressed code execution
  - id: php-gz-eval
    desc: "PHP: decompresses and executes code"
    crit: suspicious
    conf: 0.98
    mbc: "B0032"
    attack: "T1027"
    for: [php]
    all:
      - id: objectives/anti-static/obfuscation/encoding::gzinflate
      - id: objectives/anti-static/obfuscation/encoding::eval

  # Obfuscated dynamic backdoor
  - id: php-obfuscated-dynamic-backdoor
    desc: "PHP: obfuscated dynamic backdoor (dynamic"
    crit: suspicious
    conf: 0.98
    mbc: "B0032"
    attack: "T1027"
    for: [php]
    all:
      - id: micro-behaviors/process/create/shell/
    any:
      - id: objectives/anti-static/obfuscation/code-metrics::php-obfuscated-vars
      - id: objectives/anti-static/obfuscation/code-metrics::php-encoded-strings
      - id: objectives/anti-static/obfuscation/encoding

  # Non-ASCII dynamic backdoor
  - id: php-non-ascii-backdoor
    desc: "PHP: non-ASCII dynamic backdoor (dynamic"
    crit: suspicious
    conf: 0.98
    mbc: "B0032"
    attack: "T1027"
    for: [php]
    all:
      - id: micro-behaviors/process/create/shell/
      - id: objectives/anti-static/obfuscation/code-metrics::php-high-non-ascii-ratio

  - id: php-non-ascii-identifiers-backdoor
    desc: "PHP: backdoor using non-ASCII identifiers"
    crit: notable
    conf: 0.98
    mbc: "B0032"
    attack: "T1027"
    for: [php]
    any:
      - id: objectives/anti-static/obfuscation/code-metrics::php-high-non-ascii-ratio
      - id: objectives/anti-static/obfuscation/code-metrics::php-non-ascii-variable
      - id: objectives/anti-static/obfuscation/code-metrics::php-non-ascii-name

  - id: php-shell-functional
    desc: "PHP: functional webshell (exec + user input)"
    crit: suspicious
    conf: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: micro-behaviors/process/create/shell
      - id: micro-behaviors/data/user-input/request
    any:
      - id: objectives/anti-static/obfuscation/
      - id: micro-behaviors/fs/read/file
      - id: micro-behaviors/fs/write/file
    none:
      - id: metadata/purpose/test-tool::php-test-runner
      - id: objectives/command-and-control/rat/script::localhost-socket-uri

  # Functional PHP shell
  - id: php-shell
    desc: "PHP: functional webshell (exec +"
    crit: suspicious
    conf: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: micro-behaviors/process/create/shell
      - id: micro-behaviors/data/user-input/request
    any:
      - id: micro-behaviors/fs/read/file
      - id: micro-behaviors/fs/write/file
      - id: objectives/anti-static/obfuscation/encoding

  # === HOSTILE: Full-featured webshell with direct RCE ===
  # Combines direct user input execution + multiple shell methods + webshell family indicators

  # Hostile: Direct user input used as function call (variable function)
  # This pattern has no legitimate use - user input directly calls arbitrary functions
  - id: php-variable-function-backdoor
    desc: "PHP webshell: user input as function call"
    crit: suspicious
    conf: 0.99
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/command-and-control/webshell/backdoor::dynamic-user-input-call # $_POST['x']() pattern
      - id: micro-behaviors/process/create/shell # has shell execution capability
    any:
      - id: micro-behaviors/data/user-input/request
      - id: micro-behaviors/fs/write/
      - id: micro-behaviors/fs/read

  # Hostile: Webshell with backtick RCE from user input
  - id: php-backtick-rce
    desc: "PHP webshell: backtick RCE from user input"
    crit: suspicious
    conf: 0.98
    mbc: "E1059"
    attack: "T1059.004"
    for: [php]
    all:
      - id: micro-behaviors/process/create/shell/lang::backtick
      - id: micro-behaviors/data/user-input/request
    any:
      - id: micro-behaviors/process/create/shell
      - id: micro-behaviors/fs/write/
      - id: objectives/persistence/session

  # Hostile: WSO webshell family with command execution
  - id: wso-webshell
    desc: "WSO webshell family detected"
    crit: suspicious
    conf: 0.99
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/command-and-control/webshell/script::wso-version
      - id: micro-behaviors/process/create/shell
    any:
      - id: micro-behaviors/data/user-input/request
      - id: micro-behaviors/fs/write/
      - id: objectives/persistence/session

  # Hostile: Full-featured webshell (multiple indicators)
  # File manager + shell execution + user input + multiple exec methods
  - id: php-full-webshell
    desc: "Full-featured PHP webshell"
    crit: suspicious
    conf: 0.98
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: micro-behaviors/process/create/shell # shell execution
      - id: micro-behaviors/data/user-input/request # user input handling
      - id: micro-behaviors/fs/write/ # file write capability
      - id: objectives/command-and-control/webshell # webshell family indicators
      - id: objectives/command-and-control/webshell/backdoor::dynamic-user-input-call # variable function backdoor
      - id: micro-behaviors/process/create/shell/lang::backtick # backtick RCE

  # WordPress CMS backdoor - creates admin user with obfuscated code
  - id: php-wordpress-backdoor
    desc: "WordPress backdoor: admin user creation"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1505.003"
    for: [php]
    all:
      - id: objectives/command-and-control/webshell/backdoor::wp-user-creation
      - id: objectives/command-and-control/webshell/backdoor::wp-role-assignment
    any:
      - id: objectives/anti-static/obfuscation/encoding::strrev-chained
      - id: objectives/anti-static/obfuscation/encoding::base64-admin-role
      - id: objectives/command-and-control/webshell/backdoor::wp-plugin-path-encoded
