# Reverse Shell Detection - Go
# MBC: B0033 (Adversary-in-the-Middle)
# ATT&CK: T1059

defaults:
  for: [go, elf, macho, pe]

traits:
  - id: cmd-plain
    desc: Windows cmd shell reference
    crit: notable
    conf: 0.6
    if:
      id: micro-behaviors/process/create/shell::cmd-name

composite_rules:
  # Go connection composite
  - id: go-net-connection
    desc: Go network connection
    crit: notable
    conf: 0.6
    all:
      - id: micro-behaviors/communications/socket/

  # Go exec composite
  - id: go-exec
    desc: Go command execution
    crit: notable
    conf: 0.6
    any:
      - id: micro-behaviors/process/create/shell::go-os-exec
      - id: micro-behaviors/process/create/shell/lang::exec-cmd-start
      - id: micro-behaviors/process/create/shell/lang::exec-cmd-run
      - id: micro-behaviors/process/create/direct::exec-command

  # Shell composite
  - id: shell-path
    desc: Shell path reference
    crit: notable
    conf: 0.5
    any:
      - id: micro-behaviors/process/create/shell::bin-sh
      - id: micro-behaviors/process/create/shell::bin-bash
      - id: micro-behaviors/process/create/shell::cmd-exe
      - id: cmd-plain

  # Go reverse shell (migrated from YARA)
  - id: go-reverse-shell
    desc: Go reverse shell implementation patterns
    crit: suspicious
    conf: 0.85
    mbc: "B0033"
    attack: "T1059"
    all:
      - id: go-net-connection
      - id: go-exec
    any:
      - id: micro-behaviors/process/create/shell/lang::pipe-redirection
      - id: shell-path
