# Remote Shell Backdoor Installation
# Detects installation of telnet and SSH backdoors for persistent access
# ATT&CK: T1021.004 (Remote Services: SSH)
# MBC: E1037 (Communication)

traits:
  # === Telnet Backdoor ===
  - id: telnet-service
    desc: "Telnet service for remote access"
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      word: "telnet"
    not:
      # Exclude help text/protocol listings from multi-protocol clients
      - "telnet-option"
      - "--telnet"
      - "TELNET proto"
      - "telnet TELNET"
    unless:
      # Exclude curl/libcurl which supports telnet as a client protocol
      - id: micro-behaviors/communications/download/curl::curl-easy-init
    attack: "T1021.004"

  - id: telnetd-daemon
    desc: "Telnet daemon for remote access"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      word: "telnetd"
    attack: "T1021.004"

  # === SSH Backdoor ===
  # Removed sshd-service duplicate - use micro-behaviors/os/service/remote::sshd-ref (same pattern, canonical location)

  - id: dropbear-lightweight-ssh
    desc: "Dropbear SSH server"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      word: "dropbear"
    attack: "T1021.004"

  # === Shell Access ===

composite_rules:
  - id: telnet-backdoor-setup
    desc: "Telnet backdoor setup"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1021.004"
    mbc: "E1037"
    any:
      - id: telnet-service
      - id: telnetd-daemon

  - id: ssh-backdoor-setup
    desc: "SSH backdoor setup"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1021.004"
    mbc: "E1037"
    any:
      - id: micro-behaviors/os/service/remote::sshd-ref
      - id: dropbear-lightweight-ssh

  - id: remote-shell-backdoor
    desc: "Remote shell backdoor"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1021.004"
    mbc: "E1037"
    all:
      - id: telnet-backdoor-setup
      - id: ssh-backdoor-setup

  - id: mirai-telnet-ssh-backdoor
    desc: "Mirai remote shell backdoor"
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1021.004"
    mbc: "E1037"
    all:
      - id: well-known/malware/botnet/mirai
      - id: remote-shell-backdoor
