# LaunchDaemon/LaunchAgent Persistence (macOS)
# MBC: B0028 (Scheduled Task/Job)
# ATT&CK: T1543.004

defaults:
  for: [all]

traits:
  - id: launch-agents
    desc: LaunchAgents directory (user-level services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      substr: "LaunchAgents"

  - id: launch-daemons
    desc: LaunchDaemons directory (system-level services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      substr: "LaunchDaemons"

  - id: launchctl-command
    desc: launchctl command (manage launchd services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      word: "launchctl"

  - id: plist-extension
    desc: .plist file extension (property list)
    crit: notable
    conf: 0.6
    attack: T1543.004
    if:
      type: string
      substr: ".plist"

  - id: run-at-load
    desc: RunAtLoad key (start service at load)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1543.004
    if:
      type: kv
      path: "RunAtLoad"

  - id: keep-alive
    desc: KeepAlive key (ensure service is always running)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1543.004
    if:
      type: kv
      path: "KeepAlive"

  - id: throttle-interval
    desc: ThrottleInterval key (min time between spawns)
    crit: notable
    conf: 0.5
    if:
      type: kv
      path: "ThrottleInterval"

  - id: start-interval
    desc: StartInterval key (scheduled execution)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1053.003
    if:
      type: kv
      path: "StartInterval"

  - id: start-calendar-interval
    desc: StartCalendarInterval key (scheduled execution)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1053.003
    if:
      type: kv
      path: "StartCalendarInterval"

  - id: stdout-path
    desc: StandardOutPath key (log redirection)
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "StandardOutPath"

  - id: stderr-path
    desc: StandardErrorPath key (log redirection)
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "StandardErrorPath"

  - id: env-vars
    desc: EnvironmentVariables key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "EnvironmentVariables"

  - id: mach-services
    desc: MachServices key (XPC service registration)
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "MachServices"

  - id: sockets
    desc: Sockets key (network socket activation)
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "Sockets"

  - id: service-ipc
    desc: ServiceIPC key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "ServiceIPC"

  - id: process-type
    desc: ProcessType key (Background, App, etc.)
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "ProcessType"

  - id: associated-bundles
    desc: AssociatedBundleIdentifiers key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "AssociatedBundleIdentifiers"

  - id: working-directory
    desc: WorkingDirectory key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "WorkingDirectory"

  - id: launch-events
    desc: LaunchEvents key (event-based activation)
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "LaunchEvents"

  - id: spawn-type
    desc: POSIXSpawnType key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "POSIXSpawnType"

  - id: soft-resource-limits
    desc: SoftResourceLimits key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "SoftResourceLimits"

  - id: hard-resource-limits
    desc: HardResourceLimits key
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "HardResourceLimits"

  - id: sock-service-name
    desc: SockServiceName key (launchd socket activation)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1543.004
    if:
      type: raw
      substr: "SockServiceName"

  - id: inetd-compat
    desc: inetdCompatibility key (socket handoff)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1543.004
    if:
      type: raw
      substr: "inetdCompatibility"

  - id: shell-program
    desc: Shell as launchd Program (/bin/sh)
    crit: notable
    conf: 0.7
    attack: T1059.004
    platforms: [macos]
    for: [plist]
    if:
      type: raw
      regex: "/bin/(sh|bash|zsh)"

  # Embedded plist template traits (non-plist files containing plist data)
  - id: embedded-plist-shell
    desc: Embedded plist template with shell program
    crit: notable
    conf: 0.8
    for: [c, macho, elf]
    platforms: [macos]
    if:
      type: string
      substr: "<key>Program</key>"

  - id: embedded-plist-shell-sh
    desc: Embedded plist /bin/sh string element
    crit: notable
    conf: 0.8
    for: [c, macho, elf]
    platforms: [macos]
    if:
      type: string
      substr: "<string>/bin/sh</string>"

  - id: embedded-sock-service
    desc: Embedded SockServiceName plist key
    crit: notable
    conf: 0.8
    for: [c, macho, elf]
    platforms: [macos]
    if:
      type: string
      substr: "SockServiceName"

  - id: fake-apple-label
    desc: Fake com.apple identifier in non-Apple binary
    crit: suspicious
    conf: 0.85
    for: [c, macho, elf]
    platforms: [macos]
    if:
      type: string
      regex: 'com\.apple\.[A-Z][A-Za-z]+'
    unless:
      - id: metadata/sign/anchor-apple

  - id: fake-homebrew-label
    desc: Fake homebrew identifier (com.homebrew)
    crit: suspicious
    conf: 0.9
    for: [macho, elf, c]
    platforms: [macos]
    if:
      type: string
      substr: "com.homebrew"

  # Masquerading Traits
  - id: label-apple
    desc: Launchd Label starting with com.apple
    crit: notable
    conf: 0.9
    for: [plist]
    if:
      type: kv
      path: "Label"
      regex: "^com\\.apple\\."

  - id: label-zoom
    desc: Launchd Label starting with com.zoom
    crit: notable
    conf: 0.9
    for: [plist]
    if:
      type: kv
      path: "Label"
      regex: "^com\\.zoom\\."

  - id: label-google
    desc: Launchd Label starting with com.google
    crit: notable
    conf: 0.9
    for: [plist]
    if:
      type: kv
      path: "Label"
      regex: "^com\\.google\\."

  - id: label-microsoft
    desc: Launchd Label starting with com.microsoft
    crit: notable
    conf: 0.9
    for: [plist]
    if:
      type: kv
      path: "Label"
      regex: "^com\\.microsoft\\."

  - id: label-adobe
    desc: Launchd Label starting with com.adobe
    crit: notable
    conf: 0.9
    for: [plist]
    if:
      type: kv
      path: "Label"
      regex: "^com\\.adobe\\."

  - id: label-oracle
    desc: Launchd Label starting with com.oracle
    crit: notable
    conf: 0.9
    for: [plist]
    if:
      type: kv
      path: "Label"
      regex: "^com\\.oracle\\."

  - id: stdout-tmp
    desc: StandardOutPath in /tmp/
    crit: suspicious
    conf: 0.8
    for: [plist]
    if:
      type: kv
      path: "StandardOutPath"
      regex: "^/(tmp|var/tmp|private/tmp)/"

  - id: stderr-tmp
    desc: StandardErrorPath in /tmp/
    crit: suspicious
    conf: 0.8
    for: [plist]
    if:
      type: kv
      path: "StandardErrorPath"
      regex: "^/(tmp|var/tmp|private/tmp)/"

  - id: program-tmp
    desc: Program in /tmp/
    crit: suspicious
    conf: 0.8
    for: [plist]
    if:
      type: kv
      path: "Program"
      regex: "^/(tmp|var/tmp|private/tmp)/"

  - id: args-tmp
    desc: ProgramArguments[0] in /tmp/
    crit: suspicious
    conf: 0.8
    for: [plist]
    if:
      type: kv
      path: "ProgramArguments[0]"
      regex: "^/(tmp|var/tmp|private/tmp)/"

  - id: program-shared
    desc: Program in /Users/Shared/
    crit: suspicious
    conf: 0.7
    for: [plist]
    if:
      type: kv
      path: "Program"
      regex: "^/Users/Shared/"

  - id: args-shared
    desc: ProgramArguments[0] in /Users/Shared/
    crit: suspicious
    conf: 0.7
    for: [plist]
    if:
      type: kv
      path: "ProgramArguments[0]"
      regex: "^/Users/Shared/"

  - id: program-hidden
    desc: Hidden Program executable
    crit: suspicious
    conf: 0.7
    for: [plist]
    if:
      type: kv
      path: "Program"
      regex: "/\\.[^/]{1,120}$"

  - id: args-hidden
    desc: Hidden ProgramArguments[0] executable
    crit: suspicious
    conf: 0.7
    for: [plist]
    if:
      type: kv
      path: "ProgramArguments[0]"
      regex: "/\\.[^/]{1,120}$"

composite_rules:
  - id: launchd
    desc: macOS launchd persistence (2+ indicators)
    crit: notable
    conf: 0.66
    mbc: B0028
    attack: T1543.004
    needs: 2
    any:
      - id: launch-agents
      - id: launch-daemons
      - id: launchctl-command
      - id: plist-extension
      - id: run-at-load
      - id: keep-alive
      - id: start-interval
      - id: start-calendar-interval
      - id: stdout-path
      - id: stderr-path
      - id: env-vars
      - id: mach-services
      - id: sockets
      - id: service-ipc
      - id: process-type
      - id: associated-bundles
      - id: working-directory
      - id: launch-events
      - id: spawn-type
      - id: soft-resource-limits
      - id: hard-resource-limits
      - id: sock-service-name
      - id: inetd-compat

  - id: launchd-bind-shell
    desc: Launchd socket-activated bind shell
    crit: suspicious
    conf: 0.9
    mbc: B0028
    attack: T1543.004
    all:
      - id: sock-service-name
      - id: inetd-compat
      - id: shell-program

  - id: embedded-plist-bind-shell
    desc: Embedded plist bind-shell template in binary
    crit: suspicious
    conf: 0.85
    mbc: B0028
    attack: T1543.004
    for: [c, macho, elf]
    all:
      - id: embedded-plist-shell-sh
      - id: embedded-sock-service

  - id: launchd-dropper
    desc: Launchd persistence installer via system commands
    crit: hostile
    conf: 0.9
    mbc: B0028
    attack: T1543.004
    for: [c, macho]
    all:
      - id: launch-agents
      - id: launchctl-command
      - id: micro-behaviors/process/create/shell::system-fn
      - id: objectives/execution/fileless/memory::exec-function

  # Embedded bind-shell plist dropper: binary/source contains full plist template
  # with socket-activated shell + drops to LaunchAgents
  # Complexity: all(3) + for(1) = 4 (meets hostile threshold)
  - id: launchd-embedded-bind-shell
    desc: Embedded plist bind-shell dropped to LaunchAgents
    crit: hostile
    conf: 0.95
    mbc: B0028
    attack: T1543.004
    for: [c, macho]
    all:
      - id: embedded-plist-bind-shell
      - id: launch-agents
      - id: micro-behaviors/process/create/shell::system-fn

  - id: launchd-app-trojan
    desc: Launchd persistence with app bundle hijacking
    crit: hostile
    conf: 0.95
    mbc: B0028
    attack: T1543.004
    for: [c, macho]
    all:
      - id: launchd
      - id: objectives/lateral-movement/trojanize/app::app-bundle-hijack
      - id: micro-behaviors/process/create/shell::system-fn

  # Masquerading Composites
  - id: output-suspicious-location
    desc: Launchd StandardOutPath/StandardErrorPath in unusual location
    crit: suspicious
    conf: 0.8
    any:
      - id: stdout-tmp
      - id: stderr-tmp

  - id: program-unusual-location
    desc: Launchd Program/ProgramArguments in unusual location
    crit: notable
    conf: 0.7
    any:
      - id: program-tmp
      - id: args-tmp
      - id: program-shared
      - id: args-shared
      - id: program-hidden
      - id: args-hidden

  - id: launchd-masquerading-apple
    desc: Apple-labeled Launchd item launching from unusual location
    crit: hostile
    conf: 0.9
    all:
      - id: label-apple
      - id: program-unusual-location
    unless:
      # Exclude legitimate Apple paths
      - type: kv
        path: "Program"
        regex: "^(/System/Library/|/usr/libexec/|/usr/bin/|/System/Applications/|/Library/Internet Plug-Ins/)"
      - type: kv
        path: "ProgramArguments[0]"
        regex: "^(/System/Library/|/usr/libexec/|/usr/bin/|/System/Applications/|/Library/Internet Plug-Ins/)"

  - id: launchd-masquerading-zoom
    desc: Zoom-labeled Launchd item launching from unusual location
    crit: hostile
    conf: 0.9
    all:
      - id: label-zoom
      - id: program-unusual-location
    unless:
      # Exclude legitimate Zoom path
      - type: kv
        path: "Program"
        regex: "^/Applications/zoom\\.us\\.app/"
      - type: kv
        path: "ProgramArguments[0]"
        regex: "^/Applications/zoom\\.us\\.app/"

  - id: launchd-masquerading-google
    desc: Google-labeled Launchd item launching from unusual location
    crit: hostile
    conf: 0.9
    all:
      - id: label-google
      - id: program-unusual-location
    unless:
      # Exclude legitimate Google path
      - type: kv
        path: "Program"
        regex: "^(/Library/Google/|/Applications/Google)"
      - type: kv
        path: "ProgramArguments[0]"
        regex: "^(/Library/Google/|/Applications/Google)"

  - id: launchd-masquerading-microsoft
    desc: Microsoft-labeled Launchd item launching from unusual location
    crit: hostile
    conf: 0.9
    all:
      - id: label-microsoft
      - id: program-unusual-location
    unless:
      - type: kv
        path: "Program"
        regex: "^(/Library/Application Support/Microsoft/|/Applications/Microsoft)"
      - type: kv
        path: "ProgramArguments[0]"
        regex: "^(/Library/Application Support/Microsoft/|/Applications/Microsoft)"

  - id: launchd-masquerading-oracle
    desc: Oracle-labeled Launchd item launching from unusual location
    crit: hostile
    conf: 0.9
    all:
      - id: label-oracle
      - id: program-unusual-location
    unless:
      - type: kv
        path: "Program"
        regex: "^/Library/Internet Plug-Ins/JavaAppletPlugin\\.plugin/"
      - type: kv
        path: "ProgramArguments[0]"
        regex: "^/Library/Internet Plug-Ins/JavaAppletPlugin\\.plugin/"

  - id: launchd-persistent-unusual
    desc: Persistent Launchd item (KeepAlive) launching from unusual location
    crit: suspicious
    conf: 0.8
    all:
      - id: keep-alive
      - id: program-unusual-location
