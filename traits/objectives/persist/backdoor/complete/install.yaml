# Complete Backdoor Installation Chains
# Detects multi-step attack sequences combining account creation with persistent access
# Generic indicator for comprehensive system compromise

composite_rules:
  - id: account-ssh-key-injection
    desc: Account creation with SSH key injection
    crit: hostile
    conf: 0.92
    for: [elf, shell]
    attack: "T1098.004"
    mbc: "E1015"
    all:
      - id: objectives/persist/account/create::useradd-command
      - id: objectives/persist/account/create::user-bash-shell
      - id: objectives/lateral-movement/ssh-backdoor-installation/deploy::authorized-keys-path

  - id: password-set-privilege-escalation
    desc: Password setting with privilege escalation
    crit: hostile
    conf: 0.90
    for: [elf, shell]
    attack: "T1136.001"
    mbc: "E1015"
    all:
      - id: objectives/persist/account/create::chpasswd-command
      - id: objectives/persist/account/create::privilege-escalation-setup

  - id: complete-backdoor-installation
    desc: Complete backdoor account and SSH setup
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1098.004"
    mbc: "E1015"
    all:
      - id: objectives/persist/account/create::account-creation
      - id: objectives/persist/account/create::privilege-escalation-setup
      - id: objectives/lateral-movement/ssh-backdoor-installation/deploy::authorized-keys-path
      - id: objectives/lateral-movement/ssh-backdoor-installation/deploy::sshd-restart
