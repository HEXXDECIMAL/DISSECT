traits:
- id: useradd-command
  desc: useradd user creation command
  crit: notable
  conf: 0.75
  for:
  - elf
  - shell
  if:
    type: string
    regex: (useradd|adduser|/usr/sbin/useradd|useradd -m|adduser --disabled-password)
  attack: T1136.001
- id: user-bash-shell
  desc: Create user with bash shell
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  if:
    type: string
    regex: (-s /bin/bash|--shell /bin/bash|-s /bin/sh)
  attack: T1136.001
- id: user-creation-ok
  desc: User creation success indicator
  crit: notable
  conf: 0.7
  for:
  - elf
  - shell
  if:
    type: string
    substr: useradd OK
- id: usermod-wheel
  desc: usermod add to wheel group
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: (usermod -aG wheel|usermod -G wheel|usermod\s+.{0,80}wheel)
  attack: T1548.004
- id: usermod-sudo
  desc: usermod add to sudo group
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: (usermod -aG sudo|usermod -G sudo|usermod\s+.{0,80}sudo)
  attack: T1548.004
- id: chpasswd-command
  desc: chpasswd password change command
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  if:
    type: string
    regex: (chpasswd|echo '%s:%s' \| chpasswd)
  attack: T1136.001
- id: passwd-command
  desc: passwd password change command
  crit: notable
  conf: 0.5
  for:
  - elf
  - shell
  if:
    type: string
    word: passwd
- id: visudo-check
  desc: visudo configuration check
  crit: notable
  conf: 0.7
  for:
  - elf
  - shell
  if:
    type: string
    regex: (visudo -c|visudo -q)
  attack: T1548.004
- id: sudo-nopasswd
  desc: NOPASSWD sudo directive
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    substr: NOPASSWD
  attack: T1548.004
- id: openssl-passwd
  desc: openssl password hashing
  crit: notable
  conf: 0.7
  for:
  - elf
  - shell
  if:
    type: string
    regex: (openssl passwd|openssl passwd -6)
  attack: T1136.001
- id: skel-profile-setup
  desc: User profile skeleton setup
  crit: notable
  conf: 0.75
  for:
  - elf
  - shell
  if:
    type: string
    substr: cp -r /etc/skel
composite_rules:
- id: account-creation
  desc: User account creation
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  attack: T1136.001
  needs: 2
  any:
  - id: useradd-command
  - id: user-bash-shell
  - id: chpasswd-command
  - id: openssl-passwd
- id: privilege-escalation-setup
  desc: Privilege escalation configuration
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  attack: T1548.004
  needs: 2
  any:
  - id: usermod-wheel
  - id: usermod-sudo
  - id: sudo-nopasswd
  - id: visudo-check
- id: account-privilege-escalation-combo
  desc: Account creation + privilege escalation
  crit: hostile
  conf: 0.9
  for:
  - elf
  - shell
  attack: T1136.001
  mbc: E1015
  all:
  - id: account-creation
  - id: privilege-escalation-setup
