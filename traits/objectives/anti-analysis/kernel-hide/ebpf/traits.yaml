defaults:
  for:
    - all
traits:
  - id: sec-syscall-enter
    desc: SEC("tp/syscalls/sys_enter_") tracepoint
    crit: notable
    conf: 0.8
    for:
      - c
      - elf
    if:
      type: string
      regex: SEC\("t(p|racepoint)/syscalls/sys_enter_
  - id: sec-syscall-exit
    desc: SEC("tp/syscalls/sys_exit_") tracepoint
    crit: notable
    conf: 0.8
    for:
      - c
      - elf
    if:
      type: string
      regex: SEC\("t(p|racepoint)/syscalls/sys_exit_
  - id: sec-uprobe
    desc: SEC("uprobe/") section marker
    crit: notable
    conf: 0.8
    for:
      - c
      - elf
    if:
      type: string
      substr: SEC("uprobe/
  - id: xdp-md-struct
    desc: struct xdp_md packet context
    crit: notable
    conf: 0.7
    for:
      - c
      - elf
    if:
      type: string
      substr: struct xdp_md
  - id: xdp-data-end
    desc: XDP data_end pointer
    crit: notable
    conf: 0.5
    for:
      - c
      - elf
    if:
      type: string
      substr: data_end
  - id: xdp-iph
    desc: IP header struct reference
    crit: notable
    conf: 0.5
    for:
      - c
      - elf
    if:
      type: string
      exact: iph
  - id: xdp-tcph
    desc: TCP header struct reference
    crit: notable
    conf: 0.5
    for:
      - c
      - elf
    if:
      type: string
      exact: tcph
  - id: xdp-payload-xdp-packet
    desc: XDP or packet payload reference
    crit: notable
    conf: 0.5
    for:
      - c
    if:
      type: string
      regex: (xdp|packet)[_-]?(payload|data)

  - id: xdp-payload-ctx
    desc: Context payload or data reference
    crit: notable
    conf: 0.5
    for:
      - c
    if:
      type: string
      regex: ctx[_-]?(payload|data)

  - id: xdp-payload-pointer
    desc: Payload pointer offset or length
    crit: notable
    conf: 0.5
    for:
      - c
    if:
      type: string
      regex: payload[_-]?(ptr|offset|len)
  - id: cilium-ebpf
    desc: github.com/cilium/ebpf library
    crit: notable
    conf: 0.85
    for:
      - go
    if:
      type: string
      substr: github.com/cilium/ebpf
  - id: libbpfgo
    desc: github.com/aquasecurity/libbpfgo library
    crit: notable
    conf: 0.85
    for:
      - go
    if:
      type: string
      substr: github.com/aquasecurity/libbpfgo
  - id: datadog-ebpf
    desc: github.com/DataDog/ebpf library
    crit: notable
    conf: 0.85
    for:
      - go
    if:
      type: string
      substr: github.com/DataDog/ebpf
  - id: ebpf-new-collection
    desc: ebpf.NewCollection function
    crit: notable
    conf: 0.85
    for:
      - go
    if:
      type: string
      substr: ebpf.NewCollection
  - id: ebpf-new-program
    desc: ebpf.NewProgram function
    crit: notable
    conf: 0.85
    for:
      - go
    if:
      type: string
      substr: ebpf.NewProgram
  - id: load-pinned-program
    desc: LoadPinnedProgram function
    crit: notable
    conf: 0.85
    for:
      - go
    if:
      type: string
      substr: LoadPinnedProgram
  - id: rootkit-string
    desc: Rootkit string reference
    crit: suspicious
    conf: 0.8
    if:
      type: string
      word: rootkit
      case_insensitive: true
  - id: bpf-probe-write-user
    desc: bpf_probe_write_user function (memory patching)
    crit: suspicious
    conf: 1.0
    attack: T1562.001
    for:
      - c
      - elf
    if:
      type: raw
      regex: bpf_probe_write_user
  - id: getdents64-tracepoint
    desc: tp/syscalls/sys_exit_getdents64 tracepoint
    crit: suspicious
    conf: 0.9
    for:
      - c
      - elf
    if:
      type: string
      substr: tp/syscalls/sys_exit_getdents64
  - id: crypt-verify
    desc: crypt_verify function reference
    crit: notable
    conf: 0.7
    for:
      - c
      - elf
    if:
      type: string
      substr: crypt_verify
  - id: http-routes
    desc: http_routes manipulation
    crit: notable
    conf: 0.7
    for:
      - c
      - elf
    if:
      type: string
      substr: http_routes
  - id: http-edit
    desc: HTTP_EDIT action
    crit: suspicious
    conf: 0.8
    for:
      - c
      - elf
    if:
      type: string
      substr: HTTP_EDIT
  - id: http-drop
    desc: HTTP_DROP action
    crit: suspicious
    conf: 0.8
    for:
      - c
      - elf
    if:
      type: string
      substr: HTTP_DROP
  - id: http-string-action-a
    desc: HTTP action edit or drop
    crit: notable
    conf: 0.3
    for:
      - c
    if:
      type: string
      regex: HTTP[_-](EDIT|DROP)

  - id: http-string-action-b
    desc: HTTP action pass or redirect
    crit: notable
    conf: 0.3
    for:
      - c
    if:
      type: string
      regex: HTTP[_-](PASS|REDIRECT)

  - id: http-string-action-c
    desc: HTTP action hijack
    crit: notable
    conf: 0.3
    for:
      - c
    if:
      type: string
      regex: HTTP[_-]HIJACK

  - id: http-string-packet-near
    desc: HTTP and packet near each other
    crit: notable
    conf: 0.3
    for:
      - c
    if:
      type: string
      regex: packet.{0,20}HTTP|HTTP.{0,20}packet

  - id: password-string-direct-a
    desc: Password buffer pointer or length
    crit: notable
    conf: 0.4
    for:
      - c
      - elf
    if:
      type: string
      regex: password[_-]?(buf|ptr|len)

  - id: password-string-direct-b
    desc: Password hash or data
    crit: notable
    conf: 0.4
    for:
      - c
      - elf
    if:
      type: string
      regex: password[_-]?(hash|data)

  - id: password-string-op
    desc: Password getter or checker
    crit: notable
    conf: 0.4
    for:
      - c
      - elf
    if:
      type: string
      regex: (get|check)[_-]?password
composite_rules:
  - id: xdp-payload
    desc: Packet payload reference
    crit: notable
    conf: 0.5
    for:
      - c
    any:
      - id: xdp-payload-xdp-packet
      - id: xdp-payload-ctx
      - id: xdp-payload-pointer

  - id: http-string
    desc: HTTP packet manipulation marker
    crit: notable
    conf: 0.3
    for:
      - c
    any:
      - id: http-string-action-a
      - id: http-string-action-b
      - id: http-string-action-c
      - id: http-string-packet-near

  - id: password-string
    desc: Password string reference
    crit: notable
    conf: 0.4
    for:
      - c
      - elf
    any:
      - id: password-string-direct-a
      - id: password-string-direct-b
      - id: password-string-op

  - id: syscall-hooking
    desc: eBPF program hooking syscall tracepoints
    crit: suspicious
    conf: 0.95
    attack: T1014
    for:
      - c
      - elf
    any:
      - id: sec-syscall-enter
      - id: sec-syscall-exit
  - id: xdp-packet-inspection
    desc: XDP packet inspection primitives
    crit: notable
    conf: 0.7
    for:
      - c
      - elf
    needs: 3
    any:
      - id: xdp-data-end
      - id: xdp-iph
      - id: xdp-tcph
      - id: xdp-payload
  - id: offensive-intent
    desc: Offensive intent markers
    crit: notable
    conf: 0.7
    for:
      - c
      - elf
      - rust
    all:
      - id: ebpf-indicator
    any:
      - id: metadata/intent::magic
      - id: metadata/intent::trigger
      - id: metadata/intent::backdoor
      - id: metadata/intent::secret
  - id: ebpf-indicator
    desc: eBPF-related markers
    crit: notable
    conf: 0.6
    for:
      - c
      - elf
    any:
      - id: sec-syscall-enter
      - id: sec-syscall-exit
      - id: micro-behaviors/os/bpf/program/loader::sec-xdp
      - id: sec-uprobe
      - id: xdp-md-struct
      - id: cilium-ebpf
      - id: libbpfgo
      - id: datadog-ebpf
  - id: xdp-backdoor
    desc: XDP-based network backdoor or packet
    crit: suspicious
    conf: 0.95
    attack: T1205
    for:
      - c
      - elf
    all:
      - id: xdp-section-marker
      - id: xdp-packet-inspection
      - id: offensive-intent
  - id: xdp-section-marker
    desc: XDP section markers
    crit: notable
    conf: 0.8
    for:
      - c
      - elf
    any:
      - id: micro-behaviors/os/bpf/program/loader::sec-xdp
      - id: xdp-md-struct
  - id: go-loader
    desc: Go-based eBPF program loader using
    crit: notable
    conf: 0.9
    for:
      - go
    any:
      - id: cilium-ebpf
      - id: libbpfgo
      - id: datadog-ebpf
      - id: ebpf-new-collection
      - id: ebpf-new-program
      - id: load-pinned-program
  - id: go-ebpf-sections
    desc: Go eBPF offensive section references
    crit: notable
    conf: 0.8
    for:
      - go
    any:
      - id: sec-syscall-enter
      - id: sec-syscall-exit
      - id: micro-behaviors/os/bpf/program/loader::sec-xdp
      - id: sec-uprobe
  - id: go-offensive-intent
    desc: Go eBPF offensive intent markers
    crit: notable
    conf: 0.7
    for:
      - go
    any:
      - id: rootkit-string
      - id: micro-behaviors/data/text/keywords::hide
      - id: micro-behaviors/data/text/keywords::bypass
  - id: go-offensive-program
    desc: Go loader referencing offensive eBPF
    crit: suspicious
    conf: 0.95
    attack: T1014
    for:
      - go
    all:
      - id: go-ebpf-sections
      - id: go-offensive-intent
  - id: sensitive-file-ref
    desc: Sensitive system file references
    crit: notable
    conf: 0.7
    any:
      - id: micro-behaviors/fs/path/config/accounts
      - id: micro-behaviors/fs/path/config/privesc
  - id: sudoers-manipulation
    desc: eBPF-based runtime manipulation of sudoers
    crit: suspicious
    conf: 1.0
    attack: T1068
    for:
      - c
      - elf
    all:
      - id: sensitive-file-ref
      - id: bpf-probe-write-user
  - id: dirent-hiding
    desc: eBPF-based file/directory hiding via getdents
    crit: suspicious
    conf: 0.95
    attack: T1014
    for:
      - c
      - elf
    all:
      - id: getdents64-tracepoint
      - id: micro-behaviors/os/syscall/invoke::d-reclen-field
      - id: bpf-probe-write-user
  - id: uprobe-hooking
    desc: eBPF program hooking user-space functions
    crit: suspicious
    conf: 0.95
    attack: T1014
    for:
      - c
      - elf
    all:
      - id: sec-uprobe
      - id: uprobe-target
  - id: uprobe-target
    desc: Uprobe credential targets
    crit: notable
    conf: 0.7
    for:
      - c
      - elf
    any:
      - id: crypt-verify
      - id: password-string
  - id: http-manipulation-action
    desc: HTTP manipulation actions
    crit: suspicious
    conf: 0.8
    for:
      - c
      - elf
    any:
      - id: http-routes
      - id: http-edit
      - id: http-drop
  - id: http-manipulation
    desc: eBPF program performing HTTP traffic
    crit: suspicious
    conf: 0.95
    attack: T1557
    for:
      - c
      - elf
    all:
      - id: micro-behaviors/os/bpf/program/loader::sec-xdp
      - id: http-string
      - id: http-manipulation-action
  - id: advanced-rootkit
    desc: Advanced eBPF rootkit detected
    crit: suspicious
    conf: 0.95
    attack: T1014
    for:
      - c
      - elf
      - go
    needs: 2
    any:
      - id: syscall-hooking
      - id: xdp-backdoor
      - id: bpf-probe-write-user
      - id: sudoers-manipulation
      - id: dirent-hiding
      - id: uprobe-hooking
      - id: http-manipulation
      - id: go-offensive-program
