# Geofencing - Regional/Locale-Based Evasion
# Malware that avoids targeting specific regions (commonly CIS/Russia) to evade prosecution
# ATT&CK: T1614 (System Location Discovery), T1614.001 (System Language Discovery)
# MBC: B0007.003 (Sandbox Detection: Check Location)

defaults:
  attack: "T1614"
  mbc: "B0007.003"

traits:
  # === Russian locale strings ===
  - id: locale-ru-ru-underscore
    desc: Russian locale (ru_RU)
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      substr: "ru_RU"

  - id: locale-ru-ru-dash
    desc: Russian locale (ru-RU)
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      substr: "ru-RU"

  - id: locale-russian-word
    desc: Russian language string
    crit: notable
    conf: 0.5
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      word: "Russian"

  # === CIS locale strings (broader geofencing) ===
  - id: locale-uk-ua
    desc: Ukrainian locale (uk_UA/uk-UA)
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "uk[-_]UA"

  - id: locale-be-by
    desc: Belarusian locale (be_BY/be-BY)
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "be[-_]BY"

  - id: locale-kk-kz
    desc: Kazakh locale (kk_KZ/kk-KZ)
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "kk[-_]KZ"

  # === Timezone detection ===
  - id: tz-europe-moscow
    desc: Europe/Moscow timezone string
    crit: notable
    conf: 0.8
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      substr: "Europe/Moscow"

  - id: tz-europe-minsk
    desc: Europe/Minsk timezone string
    crit: notable
    conf: 0.8
    for: [javascript, typescript, python, shell, ruby, php, elf, macho, pe]
    if:
      type: string
      substr: "Europe/Minsk"

  - id: tz-europe-kiev
    desc: Europe/Kiev timezone string
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php, elf, macho, pe]
    if:
      type: string
      substr: "Europe/Kiev"

  - id: tz-europe-kyiv
    desc: Europe/Kyiv timezone string
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      substr: "Europe/Kyiv"

  - id: tz-asia-almaty
    desc: Asia/Almaty timezone string
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      substr: "Asia/Almaty"

  # === JavaScript-specific timezone APIs ===
  - id: js-intl-datetime-options
    desc: Intl.DateTimeFormat timezone access
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      substr: "DateTimeFormat().resolvedOptions().timeZone"

  - id: js-gettimezoneoffset
    desc: getTimezoneOffset() call
    crit: notable
    conf: 0.4
    for: [javascript, typescript]
    if:
      type: string
      substr: "getTimezoneOffset()"

  - id: js-timezone-offset-cis
    desc: Check for CIS region timezone offset
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: 'getTimezoneOffset\(\).{0,20}(180|240|300|360)'

  # === Locale environment variable access (scripting) ===
  - id: env-lang-check
    desc: LANG environment variable access
    crit: notable
    conf: 0.4
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "(process\\.env\\.|os\\.environ|ENV\\[|getenv\\()['\"]?LANG['\"]?"

  - id: env-lc-all-check
    desc: LC_ALL environment variable access
    crit: notable
    conf: 0.5
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "(process\\.env\\.|os\\.environ|ENV\\[|getenv\\()['\"]?LC_ALL['\"]?"

  - id: env-lc-messages-check
    desc: LC_MESSAGES environment variable access
    crit: notable
    conf: 0.5
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "(process\\.env\\.|os\\.environ|ENV\\[|getenv\\()['\"]?LC_MESSAGES['\"]?"

  - id: env-language-check
    desc: LANGUAGE environment variable access
    crit: notable
    conf: 0.4
    for: [javascript, typescript, python, shell, ruby, php]
    if:
      type: string
      regex: "(process\\.env\\.|os\\.environ|ENV\\[|getenv\\()['\"]?LANGUAGE['\"]?"

  # === Function naming patterns ===
  - id: func-name-russian-check
    desc: Function checking for Russian system
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, python, ruby, php]
    if:
      type: string
      regex: "(is|check|detect).{0,30}[Rr]ussian"

  - id: func-name-russian-specific
    desc: Specific Russian geofencing function names
    crit: suspicious
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: string
      regex: '\bisRussian(Offset|Language|System|Timezone)\b'

  - id: func-name-cis-check
    desc: Function checking for CIS region
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, python, ruby, php]
    if:
      type: string
      regex: "(is|check|detect).{0,30}(CIS|Cis)"

  # === Russian keyboard layout detection ===
  - id: keyboard-layout-russian
    desc: Russian keyboard layout detection
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, csharp]
    if:
      type: string
      regex: "(keyboard|layout).{0,30}(russian|0419|ru-RU)"
      case_insensitive: true

composite_rules:
  # Russian locale detection (any indicator)
  - id: russian-locale
    desc: Russian locale indicator
    crit: notable
    conf: 0.75
    any:
      - id: locale-ru-ru-underscore
      - id: locale-ru-ru-dash
      - id: locale-russian-word

  # CIS locale detection (any CIS country)
  - id: cis-locale
    desc: CIS region locale indicator
    crit: notable
    conf: 0.7
    any:
      - id: russian-locale
      - id: locale-uk-ua
      - id: locale-be-by
      - id: locale-kk-kz

  # CIS timezone detection
  - id: cis-timezone
    desc: CIS region timezone check
    crit: notable
    conf: 0.75
    any:
      - id: tz-europe-moscow
      - id: tz-europe-minsk
      - id: tz-europe-kiev
      - id: tz-europe-kyiv
      - id: tz-asia-almaty

  # Locale environment variable access
  - id: locale-env-access
    desc: Locale environment variable checks
    crit: notable
    conf: 0.6
    needs: 2
    any:
      - id: env-lang-check
      - id: env-lc-all-check
      - id: env-lc-messages-check
      - id: env-language-check

  # JavaScript timezone detection
  - id: js-timezone-detection
    desc: JavaScript timezone detection
    crit: notable
    conf: 0.65
    for: [javascript, typescript]
    any:
      - id: js-intl-datetime-options
      - id: js-gettimezoneoffset

  # === Main geofencing composites ===

  # Russian geofencing (locale + timezone or function name)
  - id: russian-geofencing
    desc: Russian region geofencing
    crit: hostile
    conf: 0.9
    needs: 2
    unless:
      - id: metadata/library::faker-library
      - id: metadata/library::faker-js-export-regex
      - id: metadata/library::faker-js-export-str1
      - id: metadata/library::faker-js-export-str2
      - id: metadata/library::faker-js-definition
      - id: metadata/library::faker-js-locale-regex
      - id: metadata/library::faker-js-locale-str
      - id: metadata/library::faker-js-new
    any:
      - id: russian-locale
      - id: cis-timezone
      - id: func-name-russian-check
      - id: func-name-russian-specific
      - id: locale-env-access
      - id: js-timezone-detection
      - id: js-timezone-offset-cis

  # CIS geofencing (broader detection)
  - id: cis-geofencing
    desc: CIS region geofencing evasion
    crit: suspicious
    conf: 0.85
    needs: 2
    unless:
      - id: metadata/library::faker-library
      - id: metadata/library::faker-js-export-regex
      - id: metadata/library::faker-js-export-str1
      - id: metadata/library::faker-js-export-str2
      - id: metadata/library::faker-js-definition
      - id: metadata/library::faker-js-locale-regex
      - id: metadata/library::faker-js-locale-str
      - id: metadata/library::faker-js-new
    any:
      - id: cis-locale
      - id: cis-timezone
      - id: func-name-russian-check
      - id: func-name-cis-check
      - id: locale-env-access
