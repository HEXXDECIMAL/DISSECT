# Anomalous System Calls
# Detects direct syscalls found in non-standard or suspicious Mach-O sections
# This is a strong indicator of code injection or obfuscated payload execution
# ATT&CK: T1106 (Native API), T1027 (Obfuscated Files or Information)

defaults:
  platforms: [macos]
  for: [macho]
  crit: suspicious
  mbc: "B0032"

traits:
  - id: svc-in-exception-tab
    desc: "Direct ARM64 svc found in __gcc_except_tab section"
    conf: 0.95
    if:
      type: hex
      pattern: "01 00 00 d4"
      section: "__gcc_except_tab"
    downgrade:
      any:
        - id: metadata/signed/platform::apple

  - id: syscall-in-exception-tab
    desc: "Direct x86_64 syscall found in __gcc_except_tab section"
    conf: 0.95
    if:
      type: hex
      pattern: "0f 05"
      section: "__gcc_except_tab"
    downgrade:
      any:
        - id: metadata/signed/platform::apple

  - id: svc-in-data-section
    desc: "Direct ARM64 svc found in data section"
    conf: 0.9
    if:
      type: hex
      pattern: "01 00 00 d4"
      section: "__data"
    downgrade:
      any:
        - id: metadata/signed/platform::apple

  - id: syscall-in-data-section
    desc: "Direct x86_64 syscall found in data section"
    conf: 0.9
    if:
      type: hex
      pattern: "0f 05"
      section: "__data"
    downgrade:
      any:
        - id: metadata/signed/platform::apple

composite_rules:
  - id: anomalous-direct-syscall
    desc: "Direct syscall in anomalous Mach-O section (possible payload)"
    crit: hostile
    conf: 0.98
    any:
      - id: svc-in-exception-tab
      - id: syscall-in-exception-tab
      - id: svc-in-data-section
      - id: syscall-in-data-section
    downgrade:
      any:
        - id: metadata/signed/platform::apple
