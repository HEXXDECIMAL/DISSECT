# Polymorphic Decryption Loop Detection
# Detects small decryption loops with XOR operations common in polymorphic malware
# Classic pattern: small loop with XOR instruction followed by unconditional jump
# ATT&CK: T1027.002 (Obfuscated Files or Information: Software Packing)
# ATT&CK: T1140 (Deobfuscate/Decode Files or Information)

defaults:
  attack: "T1027.002"
  mbc: "F0001"
  for: [pe, elf, macho]

traits:
  # === XOR-based Decryption Patterns (x86/x64) ===

  # XOR with register, increment, loop pattern
  # Pattern: XOR [reg+offset], key ; INC reg ; LOOP
  # Common: 80 ?? XX 33 ?? E2 (xor byte [reg], key; inc; loop)
  - id: xor-inc-loop-x86
    desc: XOR decryption loop (x86)
    crit: suspicious
    conf: 0.85
    if:
      type: hex
      section: text
      pattern: "30 ?? ?? 4? E2"  # xor [reg], al; inc; loop

  # XOR with immediate, increment, conditional jump back
  # 80 ?? XX ?? ?? ?? ?? EB (xor [reg], imm; ... jmp short)
  - id: xor-jmp-short-loop
    desc: XOR with short jump loop
    crit: suspicious
    conf: 0.8
    if:
      type: hex
      section: text
      pattern: "80 ?? ?? ?? ?? EB ??"

  # Dense XOR instructions in small code region (polymorphic stub)
  - id: dense-xor-operations
    desc: Dense XOR operations in code
    crit: suspicious
    conf: 0.85
    if:
      type: hex
      section: text
      pattern: "30|31|32|33"  # XOR opcodes
      count_min: 10
      per_kb_min: 15.0  # 15+ XORs per KB

  # Single-byte XOR key pattern (common in simple packers)
  # XOR [ESI], AL ; INC ESI ; LOOP (33 06 46 E2 FC)
  - id: single-byte-xor-key
    desc: Single-byte XOR decryption stub
    crit: suspicious
    conf: 0.9
    if:
      type: hex
      section: text
      pattern: "33 06 46 E2"

  # === ARM Decryption Patterns ===

  # ARM: EOR (XOR) with loop
  # EOR + conditional branch pattern
  - id: eor-loop-arm
    desc: EOR decryption loop (ARM)
    crit: suspicious
    conf: 0.85
    platforms: [linux, macos]
    for: [elf, macho]
    if:
      type: hex
      section: text
      pattern: "?? ?? ?? E0"  # EOR instruction (E0 in condition field)
      count_min: 5

  # === Decryption Loop Indicators ===

  # Small code section with high entropy (encrypted payload)
  - id: small-encrypted-section
    desc: Small high-entropy section (encrypted stub)
    crit: notable
    conf: 0.75
    if:
      type: section
      executable: true
      entropy_min: 6.5
      length_max: 2048  # Small stub (â‰¤2KB)

  # Entry point in unusual section (common with packers)
  - id: unusual-entry-point-section
    desc: Entry point in non-standard section
    crit: suspicious
    conf: 0.8
    for: [pe, elf]
    if:
      type: section
      executable: true
      entropy_min: 5.0
      # Note: actual entry point check requires binary metadata

composite_rules:
  # Classic polymorphic decryptor
  - id: polymorphic-decryptor
    desc: Polymorphic decryption stub
    crit: hostile
    conf: 0.95
    attack: "T1027.002"
    needs: 2
    any:
      - id: xor-inc-loop-x86
      - id: xor-jmp-short-loop
      - id: single-byte-xor-key
      - id: eor-loop-arm
      - id: dense-xor-operations

  # Packed executable with decryption
  - id: packed-with-decryption
    desc: Packed executable with runtime decryption
    crit: hostile
    conf: 0.98
    all:
      - id: small-encrypted-section
    any:
      - id: polymorphic-decryptor
      - id: objectives/anti-analysis/packing/entropy::high-entropy-exec-section

  # Simple XOR packer
  - id: xor-packer
    desc: Simple XOR-based packer
    crit: hostile
    conf: 0.92
    attack: "T1027.002"
    needs: 2
    any:
      - id: xor-inc-loop-x86
      - id: single-byte-xor-key
      - id: xor-jmp-short-loop
      - id: dense-xor-operations
