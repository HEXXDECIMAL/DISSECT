# Self-Modification Patterns
# These patterns indicate code that modifies itself at runtime
# Can be legitimate (JIT, hot-patching) or malicious (polymorphic malware)

defaults:
  for: [binaries]

traits:
  # === Memory protection (atomic) ===
  # Removed mprotect-unix duplicate - use micro-traits/mem/protect/modify::mprotect (system calls should use symbol type)

  # Removed virtualprotect-win duplicate - use micro-traits/mem/protect/modify::virtual-protect (symbol is more precise)
  # Removed virtualprotectex-win duplicate - use micro-traits/mem/protect/modify::virtual-protect-ex (symbol is more precise)

  - id: prot-write
    desc: PROT_WRITE memory protection constant
    crit: notable
    conf: 0.6
    if:
      type: string
      word: "PROT_WRITE"

  # Removed prot-exec duplicate - use micro-traits/mem/allocate/executable::prot-exec-const

  - id: page-rwx
    desc: PAGE_EXECUTE_READWRITE constant
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: PAGE_EXECUTE_READWRITE

  # === Self-overwriting (atomic) ===
  - id: proc-self-mem
    desc: /proc/self/mem access for self-modification
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: /proc/self/mem

  # Removed proc-self-maps duplicate - use micro-traits/fs/proc/info/linux::process-self-maps
  # Note: proc-self-maps is commonly used by legitimate software (Go/Rust runtimes,
  # crash reporters, profilers) so it's no longer used in self-modify detection.

  # Removed duplicate - use objectives/defense-evasion/process/injection/runtime::write-process-memory

  - id: self-patch-ref
    desc: Self-patch terminology
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "self-patch"
      case_insensitive: true

  # === Code cave (atomic) ===
  - id: codecave-ref
    desc: Code cave terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: '\bcodecave\b|code cave'
      case_insensitive: true

  - id: slack-space-ref
    desc: Slack space terminology
    crit: suspicious
    conf: 0.75
    if:
      type: string
      substr: "slack space"
      case_insensitive: true

  - id: nop-sled
    desc: Long NOP sled byte sequence
    crit: notable
    conf: 0.7
    if:
      type: hex
      pattern: "90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90"
    unless:
      - id: metadata/language/go

  # === Hook installation (atomic) ===
  - id: setwindowshook
    desc: Windows SetWindowsHookEx API
    crit: notable
    conf: 0.7
    if:
      type: symbol
      exact: "SetWindowsHookEx"

  - id: inline-hook-ref
    desc: Inline hook terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "inline hook"
      case_insensitive: true

  - id: detour-ref
    desc: Detour/hooking terminology
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: detour
      case_insensitive: true

  # NOTE: Go runtime uses trampolines legitimately for function calls
  - id: trampoline-ref
    desc: Trampoline hook terminology
    crit: notable
    conf: 0.3
    if:
      type: string
      substr: trampoline
      case_insensitive: true

  # Removed ld-preload duplicate - use micro-traits/os/linker/env::ld-preload

  - id: dyld-insert
    desc: macOS DYLD_INSERT_LIBRARIES injection
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "DYLD_INSERT_LIBRARIES"

  # === IAT/GOT hooking (atomic) ===
  - id: import-descriptor
    desc: PE IMAGE_IMPORT_DESCRIPTOR structure
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: IMAGE_IMPORT_DESCRIPTOR

  - id: import-address-table
    desc: Import Address Table reference
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: ImportAddressTable

  - id: iat-ref
    desc: IAT abbreviation reference
    crit: notable
    conf: 0.4
    if:
      type: string
      word: "IAT"

  - id: got-plt-section
    desc: ELF .got.plt section reference
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: .got.plt

  - id: got-ref
    desc: GOT abbreviation reference
    crit: notable
    conf: 0.4
    if:
      type: string
      word: "GOT"

  # === Polymorphic/metamorphic (atomic) ===
  # NOTE: "polymorphic" has legitimate uses in:
  # - Debuggers (CPU polymorphism, instruction variants)
  # - Compilers (polymorphic type systems, generics)
  # - Security tools analyzing polymorphic malware
  # Only flag as suspicious in malware-specific context
  - id: polymorphic-ref
    desc: Polymorphic code terminology
    crit: notable
    conf: 0.5
    for: [binaries, javascript, typescript]
    if:
      type: string
      substr: polymorphic
      case_insensitive: true

  - id: metamorphic-ref
    desc: Metamorphic code terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: metamorphic
      case_insensitive: true

  - id: self-modifying-ref
    desc: Self-modifying code terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "self-modifying"
      case_insensitive: true

  # NOTE: XOR loop patterns are common in legitimate software (crypto, compression,
  # RNG, games). Only meaningful as an indicator when combined with other self-modify
  # indicators in the polymorphic composite.
  - id: xor-loop-pattern
    desc: XOR decryption loop byte pattern
    crit: notable
    conf: 0.4
    if:
      type: hex
      pattern: "30 ?? 4? 83 ?? ?? 7?"

composite_rules:
  # Memory protection changes
  - id: mprotect
    desc: Memory protection modification (mprotect/VirtualProtect)
    crit: notable
    conf: 0.85
    any:
      - id: micro-traits/mem/protect/modify::mprotect-symbol
      - id: micro-traits/mem/protect/modify::virtual-protect
      - id: micro-traits/mem/protect/modify::virtual-protect-ex
      - id: prot-write
      - id: micro-traits/mem/allocate/executable::prot-exec-const
      - id: page-rwx
    # mprotect is common in graphics libraries for memory-mapped video access
    # and in system libraries for dynamic memory management
    downgrade:
      any:
        - id: micro-traits/dylib/load/x11-dga-marker
        - id: micro-traits/dylib/library::graphics-lib-marker
        - id: micro-traits/dylib/library::system-lib-marker

  # Self-overwriting code
  # Note: Removed proc-self-maps since it's commonly used by legitimate software
  # (Go/Rust runtimes, crash reporters, profilers). proc-self-mem is more specific
  # to actual memory modification.
  - id: self-overwrite
    desc: Self-overwriting code patterns
    crit: suspicious
    conf: 0.8
    any:
      - id: proc-self-mem
      - id: objectives/defense-evasion/process/injection/runtime::write-process-memory
      - id: self-patch-ref
    downgrade:
      any:
        - id: metadata/vendor/valve/valve-corp-binary

  # Code cave or slack space
  - id: code-cave
    desc: Code cave or slack space
    crit: suspicious
    conf: 0.75
    needs: 2
    any:
      - id: codecave-ref
      - id: slack-space-ref
      - id: nop-sled
    downgrade:
      any:
        - id: metadata/vendor/valve/valve-corp-binary

  # Hook installation
  # NOTE: Removed trampoline-ref since Go runtime uses trampolines legitimately
  - id: hook-install
    desc: Dynamic interposition hook patterns
    crit: notable
    conf: 0.7
    any:
      - id: setwindowshook
      - id: inline-hook-ref
      - id: detour-ref
    downgrade:
      any:
        - id: metadata/vendor/valve/valve-corp-binary

  # IAT/GOT hooking - require 2+ indicators to avoid false positives
  # from standard ELF sections like .got.plt
  - id: iat-hook
    desc: Import Address Table hooking
    crit: notable
    conf: 0.7
    needs: 2
    any:
      - id: import-descriptor
      - id: import-address-table
      - id: iat-ref
      - id: got-plt-section
      - id: got-ref

  # Polymorphic/metamorphic indicators
  # NOTE: Require 2+ indicators to avoid FPs on debuggers, security tools, and
  # academic software that analyze/discuss polymorphic techniques
  - id: polymorphic
    desc: Polymorphic or metamorphic code indicators
    crit: suspicious
    conf: 0.75
    needs: 2
    any:
      - id: polymorphic-ref
      - id: metamorphic-ref
      - id: self-modifying-ref
      - id: xor-loop-pattern

  # Active self-modification
  - id: active
    desc: Active self-modification behavior
    crit: notable
    conf: 0.9
    all:
      - id: mprotect
    any:
      - id: self-overwrite
      - id: self-modifying-ref
      - id: codecave-ref
      - id: xor-loop-pattern
