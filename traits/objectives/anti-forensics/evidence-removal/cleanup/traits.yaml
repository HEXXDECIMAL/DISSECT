traits:
- id: history-clear-shell
  desc: Clear shell history files
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  if:
    type: string
    regex: (\.zsh_history|\.ksh_history|history -c|HISTFILE=/dev/null)
  attack: T1070.003
- id: sed-deletion-pattern
  desc: sed command for pattern deletion
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  attack: T1070.003
  if:
    type: string
    regex: (sed\s+-i\s+['"][^'"]{0,120}/d['"]|sed\s+-i\s+['"]s/[^/]{1,120}//g?['"])
- id: deleted-process-cleanup
  desc: Cleanup deleted process references
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  attack: T1070.003
  if:
    type: string
    regex: grep\s+deleted.{0,80}/proc
- id: pkill-signal-9
  desc: pkill with kill -9 signal
  crit: notable
  conf: 0.8
  for:
  - elf
  - shell
  if:
    type: string
    regex: (killall -9|kill\s+-9)
  attack: T1070.003
- id: find-delete-pattern
  desc: find with delete operation
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  if:
    type: string
    regex: ((?:^|\s)find\s+.{0,50}-exec\s+rm|(?:^|\s)find\s+.{0,50}-delete\b)
  unless:
  - type: raw
    regex: gcc|gcov
  attack: T1070.003
- id: cron-removal
  desc: Cron job removal
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: (rm -f /etc/cron|crontab -r|rm -f /var/spool/cron|rm.{0,80}cron)
  attack: T1070.003
- id: systemd-cleanup
  desc: Systemd service removal
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: (rm -f /etc/systemd/system/|systemctl disable|systemctl stop)
  attack: T1070.003
- id: syslog-truncate
  desc: System log truncation
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  if:
    type: string
    regex: (> /var/log/|cat /dev/null > /var/log/|truncate -s 0|>/var/log/[a-z]+\.log)
  attack: T1070.003
- id: wtmp-utmp-clear
  desc: wtmp/utmp login log clearing
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: (/var/log/wtmp|/var/log/utmp|/var/run/utmp)
  attack: T1070.003
- id: history-clear-bash
  desc: Clear bash history
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  attack: T1070.003
  if:
    type: string
    regex: rm -f ~/\.bash_history|cat /dev/null > ~/\.bash_history
composite_rules:
- id: history-cleanup
  desc: Shell history cleanup
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  attack: T1070.003
  needs: 2
  any:
  - id: history-clear-bash
  - id: history-clear-shell
- id: process-cleanup
  desc: Process trace cleanup
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  attack: T1070.003
  needs: 2
  any:
  - id: deleted-process-cleanup
  - id: pkill-signal-9
  - id: find-delete-pattern
- id: persistence-cleanup
  desc: Persistence mechanism cleanup
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  attack: T1070.003
  needs: 2
  any:
  - id: cron-removal
  - id: systemd-cleanup
- id: log-cleanup
  desc: System log cleanup
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  attack: T1070.003
  needs: 2
  any:
  - id: syslog-truncate
  - id: wtmp-utmp-clear
- id: comprehensive-evidence-removal
  desc: Comprehensive evidence removal pattern
  crit: hostile
  conf: 0.9
  for:
  - elf
  - shell
  attack: T1070.003
  mbc: E1006
  needs: 3
  any:
  - id: history-cleanup
  - id: process-cleanup
  - id: persistence-cleanup
  - id: log-cleanup
