# Import table minimization patterns - indicators of string/import obfuscation
# Malware often uses minimal imports + dynamic loading to evade static analysis

defaults:
  mbc: "B0032"
  attack: "T1027"

traits:
  # === Windows PE Import Patterns ===

  - id: minimal-pe-dynamic-load
    desc: "Minimal PE imports with dynamic loading"
    crit: notable
    conf: 0.75
    for: [pe]
    if:
      type: import_combination
      required:
        - "^(LoadLibrary|GetProcAddress)"
      max_total: 25

  - id: crypto-minimal-pe
    desc: "Crypto API with minimal imports"
    crit: suspicious
    conf: 0.8
    for: [pe]
    if:
      type: import_combination
      required:
        - "^Crypt"
      suspicious:
        - "^LoadLibrary"
        - "^GetProcAddress"
        - "^ShellExecute"
        - "^WinExec"
      min_suspicious: 2
      max_total: 20

  - id: shell-exec-minimal-imports
    desc: "Execution capability with minimal imports"
    crit: suspicious
    conf: 0.85
    for: [pe]
    if:
      type: import_combination
      suspicious:
        - "^(ShellExecute|WinExec|CreateProcess)"
        - "^LoadLibrary"
        - "^GetProcAddress"
        - "^Virtual(Alloc|Protect)"
      min_suspicious: 3
      max_total: 20

  - id: extreme-minimal-imports
    desc: "Extremely minimal import table"
    crit: suspicious
    conf: 0.8
    for: [pe, elf]
    if:
      type: import_combination
      suspicious:
        - "^(LoadLibrary|GetProcAddress|dlopen|dlsym)"
        - "^(Virtual|Heap)(Alloc|Free)"
        - "^(Crypt|SSL|crypto)"
        - "^(ShellExecute|WinExec|CreateProcess|system|exec)"
      min_suspicious: 2
      max_total: 15

  - id: suspicious-ratio-imports
    desc: "High ratio of suspicious to total imports"
    crit: suspicious
    conf: 0.85
    for: [pe]
    if:
      type: import_combination
      suspicious:
        # Dynamic loading
        - "^(LoadLibrary|GetProcAddress)"
        # Memory manipulation
        - "^Virtual(Alloc|Free|Protect)"
        - "^Heap(Alloc|Free|Create)"
        # Crypto operations
        - "^Crypt(Acquire|Create|Destroy|Encrypt|Decrypt|Gen|Import)"
        # File operations
        - "^(Create|Open|Write|Delete)File"
        - "^FindFirst|FindNext"
        # Process/Thread
        - "^Create(Thread|Process|RemoteThread)"
        - "^(Open|Terminate)Process"
        # Execution
        - "^(ShellExecute|WinExec)"
        # Registry
        - "^Reg(Open|Create|Set|Delete|Query)Key"
        # Network
        - "^(WSA|socket|connect|send|recv)"
      min_suspicious: 5
      max_total: 20

  # === ELF Import Patterns ===

  - id: minimal-elf-dynamic-load
    desc: "Minimal ELF imports with dynamic loading"
    crit: notable
    conf: 0.75
    for: [elf]
    if:
      type: import_combination
      required:
        - "^(dlopen|dlsym)"
      max_total: 25

  - id: crypto-minimal-elf
    desc: "Crypto library with minimal imports"
    crit: suspicious
    conf: 0.8
    for: [elf]
    if:
      type: import_combination
      suspicious:
        - "^(SSL|crypto|AES|RSA)"
        - "^dlopen"
        - "^dlsym"
        - "^system$"
        - "^exec"
      min_suspicious: 3
      max_total: 20

  # === Mach-O Import Patterns ===

  - id: macho-max-35-imports
    desc: "Mach-O with 35 or fewer imports"
    crit: notable
    conf: 0.5
    for: [macho]
    if:
      type: import_combination
      max_total: 35

composite_rules:
  # === Mach-O Stealth Resolution ===
  - id: macho-stealth-resolution
    desc: "Mach-O stealth resolution (dlsym or direct syscalls)"
    crit: notable
    conf: 0.8
    for: [macho]
    any:
      - id: micro-traits/dylib/lookup::dlsym-symbol
      - id: micro-traits/os/syscall/invoke::macos-arm64-direct-syscall

  # === Mach-O Dropper/Ransomware Patterns ===

  - id: macho-concealed-capability
    desc: "Mach-O binary concealing capabilities via import minimization"
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [macho]
    all:
      - id: macho-max-35-imports
      - id: macho-stealth-resolution
    any:
      - id: objectives/anti-static/obfuscation/payload::math-cipher-imports
      - id: micro-traits/process/create/shell::system-fn

  # === PE Ransomware/Dropper Patterns ===

  - id: pe-dropper-minimal-imports
    desc: "PE dropper with minimal imports and dynamic loading"
    crit: hostile
    conf: 0.9
    for: [pe]
    all:
      - id: minimal-pe-dynamic-load
    any:
      - id: crypto-minimal-pe
      - id: shell-exec-minimal-imports
      - id: extreme-minimal-imports

  - id: pe-concealed-capability
    desc: "PE binary concealing capabilities via import minimization"
    crit: suspicious
    conf: 0.85
    for: [pe]
    needs: 2
    any:
      - id: crypto-minimal-pe
      - id: shell-exec-minimal-imports
      - id: suspicious-ratio-imports
      - id: extreme-minimal-imports

  - id: elf-concealed-capability
    desc: "ELF binary concealing capabilities via import minimization"
    crit: suspicious
    conf: 0.85
    for: [elf]
    all:
      - id: minimal-elf-dynamic-load
    any:
      - id: crypto-minimal-elf
      - id: extreme-minimal-imports