defaults:
  for:
  - macho
  - elf
  - pe
  attack: T1027
  mbc: B0032
traits:
- id: xixa-marker
  desc: Xixa obfuscation marker string
  crit: suspicious
  conf: 0.95
  for:
  - elf
  attack: T1027.002
  mbc: B0032
  if:
    type: string
    exact: Xixa
- id: large-const-section
  desc: Large __const section (>80% of
  crit: suspicious
  conf: 0.8
  for:
  - macho
  if:
    type: section_ratio
    section: __const
    compare_to: total
    min: 0.8
- id: large-data-section
  desc: Large .data section (>70% of
  crit: suspicious
  conf: 0.75
  for:
  - elf
  - pe
  size_min: 20000
  if:
    type: section_ratio
    section: \.data
    compare_to: total
    min: 0.7
- id: tiny-cstring
  desc: Tiny __cstring section (<0.1% of
  crit: notable
  conf: 0.7
  for:
  - macho
  if:
    type: section_ratio
    section: __cstring
    compare_to: total
    max: 0.001
- id: minimal-text
  desc: Small code section (<5% of
  crit: notable
  conf: 0.65
  for:
  - macho
  if:
    type: section_ratio
    section: __text
    compare_to: total
    max: 0.05
- id: high-entropy-const
  desc: High entropy in __const section
  crit: notable
  conf: 0.6
  mbc: C0027
  for:
  - macho
  if:
    type: section
    exact: __const
    entropy_min: 7.5
- id: high-entropy-data
  desc: High entropy in data section
  crit: notable
  conf: 0.6
  mbc: C0027
  for:
  - elf
  - pe
  if:
    type: section
    regex: \.(data|rdata|rodata)
    entropy_min: 7.5
  downgrade:
    any:
    - type: basename
      regex: ^lib(X11|xcb|ssl|crypto|c|z|png|jpeg|xml|curl|pcre|iconv|icu|freetype|fontconfig|harfbuzz|cairo|pango|glib|gtk|qt)\b
- id: high-entropy-text
  desc: High entropy in code section
  crit: suspicious
  conf: 0.9
  mbc: B0032.002
  if:
    type: section
    regex: (__text|\.text)
    entropy_min: 7.0
- id: string-concealment
  desc: Very few visible strings (<10)
  crit: notable
  conf: 0.7
  if:
    type: string_count
    max: 10
    min_length: 4
- id: no-strings
  desc: No visible strings in binary
  crit: suspicious
  conf: 0.8
  for:
  - macho
  - elf
  - pe
  if:
    type: string_count
    max: 0
    min_length: 4
- id: math-cipher-imports
  desc: Math functions (cipher indicator) with
  crit: suspicious
  conf: 0.85
  for:
  - macho
  if:
    type: import_combination
    required:
    - ^_?system$
    suspicious:
    - ^_?(cos|sin|tan|exp|pow|log|sqrt|fmod|hypot|log1p)$
    min_suspicious: 4
- id: minimal-imports
  desc: Very few imports (<50) with
  crit: notable
  conf: 0.7
  if:
    type: import_combination
    required:
    - ^_?system$
    max_total: 50
composite_rules:
- id: encrypted-payload-dropper
  desc: Encrypted payload dropper (large encrypted
  crit: suspicious
  conf: 0.9
  attack: T1027
  mbc: B0032
  for:
  - macho
  needs: 2
  any:
  - id: large-const-section
  - id: high-entropy-const
  - id: tiny-cstring
  - id: minimal-text
  - id: string-concealment
- id: cipher-dropper
  desc: Cipher-based dropper (math imports +
  crit: suspicious
  conf: 0.9
  attack: T1027
  mbc: C0027
  for:
  - macho
  all:
  - id: math-cipher-imports
  - id: high-entropy-const
  any:
  - id: string-concealment
  - id: tiny-cstring
- id: elf-encrypted-dropper
  desc: Encrypted payload dropper (ELF)
  crit: suspicious
  conf: 0.85
  attack: T1027
  mbc: B0032
  for:
  - elf
  needs: 2
  any:
  - id: large-data-section
  - id: high-entropy-data
  - id: string-concealment
- id: obfuscated-macos-daemon-dropper
  desc: Obfuscated macOS daemon dropper (encrypted payload
  crit: hostile
  conf: 0.92
  attack: T1027
  mbc: B0032
  for:
  - macho
  all:
  - id: high-entropy-const
  - id: tiny-cstring
  any:
  - id: objectives/persist/daemon/init::macos-double-fork-daemon
  - id: micro-behaviors/process/create/shell::shell-execution
- id: obfuscated-elf-daemon-dropper
  desc: Obfuscated ELF daemon dropper (embedded payload
  crit: hostile
  conf: 0.88
  attack: T1027
  mbc: B0032
  for:
  - elf
  platforms:
  - linux
  size_max: 2097152
  all:
  - id: micro-behaviors/data/embedded/payload::lzma-magic
  - id: objectives/persist/daemon/init::daemon-fork
  any:
  - id: micro-behaviors/process/create/shell::shell-execution
  - id: micro-behaviors/process/create/shell::shell-execution-indicators
  unless:
  - id: objectives/anti-static/obfuscation/payload/encrypted::obfuscated-elf-daemon-dropper__unless_1
  - id: metadata/format::many-imports
