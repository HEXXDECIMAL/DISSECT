# Section Size Anomalies
# Detects unusual absolute section sizes that indicate obfuscation or payloads
# Combines with ratio-based detection for comprehensive coverage

defaults:
  for: [elf, macho, pe]
  platforms: [linux, macos, windows, unix]
  attack: "T1027"

traits:
  # === macOS Section Sizes ===

  # Abnormally small __cstring for binary size
  # 29 bytes in 200KB binary = extreme obfuscation
  - id: tiny-cstring-absolute-macos
    desc: Abnormally small __cstring section
    crit: suspicious
    conf: 0.85
    for: [macho]
    size_min: 100000  # Binary is at least 100KB
    if:
      type: section
      regex: "^__TEXT\\.__cstring$"
      length_max: 100     # Section ≤100 bytes

  # Large __data section (absolute size, not ratio)
  # 8KB+ suggests encoded payload storage
  - id: large-data-absolute-macos
    desc: Large __DATA section (8KB+)
    crit: notable
    conf: 0.7
    for: [macho]
    if:
      type: section
      regex: "^__DATA\\.__data$"
      length_min: 8192  # Section ≥8KB

  # === ELF Section Sizes ===

  # Tiny .rodata section in large binary
  - id: tiny-rodata-absolute-elf
    desc: Abnormally small .rodata section
    crit: suspicious
    conf: 0.8
    for: [elf]
    size_min: 100000
    if:
      type: section
      regex: "^\\.rodata$"
      length_max: 100  # Section ≤100 bytes

  # Large .data section (absolute)
  - id: large-data-absolute-elf
    desc: Large .data section (16KB+)
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: section
      regex: "^\\.data$"
      length_min: 16384  # Section ≥16KB

composite_rules:
  # Small strings + large data = obfuscated payload
  - id: obfuscated-data-payload-macos
    desc: Obfuscated payload in data section
    crit: suspicious
    conf: 0.9
    for: [macho]
    attack: "T1027"
    all:
      - id: tiny-cstring-absolute-macos
      - id: large-data-absolute-macos
    any:
      - id: objectives/anti-static/obfuscation/payload::high-entropy-data-macos
      - id: micro-traits/process/create/shell

  # ELF version
  - id: obfuscated-data-payload-elf
    desc: Obfuscated payload in data section
    crit: suspicious
    conf: 0.9
    for: [elf]
    attack: "T1027"
    all:
      - id: tiny-rodata-absolute-elf
      - id: large-data-absolute-elf
