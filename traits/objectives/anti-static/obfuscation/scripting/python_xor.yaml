# Python XOR and String Decryption Patterns
# Detects logic typical of Python-based XOR decryptors and string dumpers
# ATT&CK: T1027 (Obfuscated Files or Information)

traits:
  - id: python-xor-byte-loop
    desc: "Python loop with XOR byte manipulation"
    crit: notable
    conf: 0.8
    for: [python]
    if:
      type: ast
      query: |
        (for_statement
          body: (block
            (_
              (assignment
                left: (subscript)
                right: (binary_operator) @bin
              )
            )
          )
          (#match? @bin "\\^")
        )

  - id: python-printable-char-check
    desc: "Python logic checking for printable ASCII range"
    crit: notable
    conf: 0.7
    for: [python]
    if:
      type: ast
      query: |
        (comparison_operator
          (integer) @min
          (identifier)
          (integer) @max
          (#eq? @min "32")
          (#match? @max "^12[67]$")
        )

  - id: python-sliding-key-loop
    desc: "Python loop iterating over key length"
    crit: notable
    conf: 0.6
    for: [python]
    if:
      type: ast
      query: |
        (for_statement
          right: (call
            function: (identifier) @func
            arguments: (argument_list
              (call
                function: (identifier) @len
              )
            )
          )
          (#eq? @func "range")
          (#eq? @len "len")
        )

  - id: python-rolling-xor-loop
    desc: "Python XOR loop with rolling key index"
    crit: suspicious
    conf: 0.9
    for: [python]
    if:
      type: ast
      query: |
        (assignment
          right: (binary_operator
            right: (subscript
               (binary_operator) @mod
            )
          ) @xor
          (#match? @xor "\\^")
          (#match? @mod "%")
        )
