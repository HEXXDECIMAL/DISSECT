defaults:
  for:
  - python
  - elf
  - macho
  - pe
  mbc: B0032
  attack: T1027
traits:
- id: python-hex
  desc: Detects hex-encoded string patterns (\xNN
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (\\x[0-9a-fA-F]{2}){4,}
- id: python-octal
  desc: Detects octal-encoded string patterns (\NNN
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (\\[0-7]{3}){4,}
- id: python-chr
  desc: Character code manipulation (chr/ord)
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: \\b(chr|ord)\(
- id: concatenated-execution
  desc: String concatenation in execution sink
  crit: suspicious
  conf: 0.85
  for:
  - python
  if:
    type: ast
    query: "((call\n  function: (identifier) @func\n  arguments: (argument_list\n\
      \    (binary_operator\n      left: (string)\n      operator: \"+\"\n      right:\
      \ (string))))\n (#match? @func \"^(exec|eval|b64decode|system|compile)$\"))\n"
- id: fromhex-call
  desc: fromhex function
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: fromhex
- id: bytes-fromhex-call
  desc: bytes.fromhex function
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: bytes.fromhex
- id: bz2-decompress-call
  desc: bz2.decompress function
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: bz2.decompress
- id: python-dense-chr-calls
  desc: Dense chr() calls (string building)
  crit: suspicious
  conf: 0.9
  mbc: B0032
  attack: T1027
  if:
    type: raw
    regex: chr\s*\(\s*\d{1,3}\b
    count_min: 15
    per_kb_min: 3.0
  unless:
  - type: basename
    regex: (?i)^(?:test_.*|.*_test)\.py$
- id: python-dense-hex-escapes
  desc: Dense hex escape sequences
  crit: suspicious
  conf: 0.88
  mbc: B0032
  attack: T1027
  size_max: 5000
  if:
    type: string
    regex: (\\x[0-9a-fA-F]{2}){4,}
    count_min: 20
    per_kb_min: 5.0
  unless:
  - type: basename
    regex: (?i)^(?:test_.*|.*_test)\.py$
  - type: raw
    substr: WalImageFile
- id: dense-octal-escapes
  desc: Dense octal escape sequences
  crit: suspicious
  conf: 0.88
  mbc: B0032
  attack: T1027
  if:
    type: string
    regex: (\\[0-7]{3}){4,}
    count_min: 10
    per_kb_min: 2.0
  unless:
  - type: basename
    regex: (?i)^(?:test_.*|.*_test)\.py$
- id: dense-ord-calls
  desc: Dense ord() calls (cipher operations)
  crit: suspicious
  conf: 0.85
  mbc: B0032
  attack: T1027
  if:
    type: raw
    regex: \bord\s*\(
    count_min: 20
    per_kb_min: 3.0
  unless:
  - type: basename
    regex: (?i)^(?:test_.*|.*_test)\.py$
- id: dense-lambda-chains
  desc: Dense lambda expressions (obfuscation)
  crit: suspicious
  conf: 0.85
  mbc: B0032
  attack: T1027
  unless:
  - type: basename
    regex: (?i)^(?:test_.*|.*_test)\.py$
  if:
    type: raw
    regex: lambda\s+[a-zA-Z_][a-zA-Z0-9_]*\s*:.{0,50}lambda\s+[a-zA-Z_][a-zA-Z0-9_]*
    count_min: 8
    per_kb_min: 2.0
- id: reverse-bytes
  desc: Reverses byte order of encoded data
  crit: suspicious
  conf: 0.9
  if:
    type: raw
    regex: (?:fromhex|b64decode|unhexlify).{0,60}\[::-1\]
composite_rules:
- id: python-decode-functions
  desc: Decoding functions for encoded payloads
  crit: notable
  conf: 0.7
  any:
  - id: micro-traits/data/encode/base64::b64decode-string
  - id: fromhex-call
  - id: bytes-fromhex-call
  - id: bz2-decompress-call
  - id: micro-traits/data/compression/library::zlib-decompress-symbol
  - id: micro-traits/data/serialization/unsafe::marshal-loads-symbol
- id: execute-decoded-content
  desc: Direct execution of decoded content
  crit: hostile
  conf: 0.98
  all:
  - id: objectives/execution/interpreter/eval/invoke::python-eval
  - id: python-decode-functions
  - id: python-chr
- id: python-encoded-pattern
  desc: Detects encoded string patterns (hex
  crit: notable
  any:
  - id: python-hex
  - id: python-octal
- id: obfuscated-execution
  desc: Direct execution of encoded string
  crit: hostile
  conf: 0.95
  all:
  - id: objectives/execution/interpreter/eval/invoke::python-eval
  - id: python-encoded-pattern
  - id: python-chr
