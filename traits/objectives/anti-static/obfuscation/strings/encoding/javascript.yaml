# String Obfuscation Detection - JavaScript
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # fromCharCode obfuscation
  - id: fromcharcode
    desc: String obfuscation via fromCharCode
    crit: notable
    conf: 0.66
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "fromCharCode"

  # Unicode escape sequences used to hide strings
  - id: js-unicode-escape
    desc: Unicode escape sequences in string
    crit: notable
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\u[0-9a-fA-F]{4}){4,}'

  # Hex escape sequences
  - id: js-hex-escape
    desc: Hex escape sequences in string
    crit: notable
    conf: 0.75
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\x[0-9a-fA-F]{2}){4,}'

  # Interspersed hex escape sequences (e.g., \x12!\x10) - obfuscation technique
  # Matches sequences where hex escapes are mixed with small amounts of other chars
  - id: js-interspersed-hex-escapes
    desc: Interspersed hex escape sequences
    crit: notable
    conf: 0.8
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      # Matches \xNN followed by up to 3 chars, repeated 4 times
      regex: '(\\x[0-9a-fA-F]{2}.{0,3}){4,}'

  # Hex-encoded require statement - obfuscated module import
  # Pattern: require(Buffer.from("6f73", "hex").toString()) = require("os")
  # This is a strong malware indicator - hiding sensitive imports
  - id: js-hex-encoded-require
    desc: Hex-encoded require statement
    crit: suspicious
    conf: 0.92
    mbc: "B0032"
    attack: "T1027"
    for: [javascript]
    if:
      type: raw
      regex: 'require\s*\(\s*Buffer\.from\([^)]{0,120}hex[^)]{0,120}\)\.toString\(\)'

  # Global object manipulation via assignment to high-risk decode/exec APIs
  - id: js-global-property-write-assignment
    desc: Global object assignment
    crit: suspicious
    conf: 0.6
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      regex: '(globalThis|window|self).{0,80}='

  - id: js-global-property-write-eval
    desc: Global property using eval
    crit: suspicious
    conf: 0.7
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      regex: '\\beval\\b'

  - id: js-global-property-write-function
    desc: Global property using Function constructor
    crit: suspicious
    conf: 0.7
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      regex: '\\bFunction\\b'

  - id: js-global-property-write-atob
    desc: Global property using atob
    crit: suspicious
    conf: 0.7
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      word: "atob"

  - id: js-global-property-write-decode
    desc: Global property using decodeURIComponent
    crit: suspicious
    conf: 0.7
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      regex: 'decodeURIComponent'

  - id: js-require-alias
    desc: Require function aliasing
    crit: suspicious
    conf: 0.9
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      regex: '=\\s*require\\s*;'

  # Version marker pattern (common in malware tracking)
  - id: js-version-marker
    desc: Malware version tracking pattern
    crit: suspicious
    conf: 0.7
    for: [javascript]
    if:
      type: string
      regex: '^[0-9]+-[a-z]{3,15}[0-9]{1,4}$'

  # Custom string shuffling/decoding loop pattern
  - id: js-charat-loop
    desc: charAt in loop pattern
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1027"
    for: [javascript]
    if:
      type: symbol
      regex: ".{0,50}\\.charAt"

  # Array element swapping (common in shuffle algorithms)
  - id: js-array-swap
    desc: Array element swap pattern
    crit: notable
    conf: 0.65
    mbc: "B0032"
    for: [javascript]
    if:
      type: raw
      regex: '\b(?:var|let|const)\s+\w+\s*=.{0,80}\[.{1,80}\].{0,120}\[.{1,80}\]\s*='

  # String split to array
  - id: js-string-split
    desc: Split to empty-delimiter char array
    crit: notable
    conf: 0.6
    for: [javascript]
    if:
      type: raw
      regex: '\.split\(\s*(?:""|'')\s*\)'

  # Dynamic code execution patterns (atomic)
  # Moved to objectives/execution/interpreter/eval/dynamic/eval-call

  - id: js-function-call
    desc: Function() constructor
    crit: notable
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "Function"

  - id: js-new-function
    desc: new Function constructor
    crit: notable
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      substr: "new Function"

  - id: js-array-join-symbol
    desc: Join using empty string delimiter
    crit: notable
    conf: 0.5
    for: [javascript]
    if:
      type: raw
      regex: '\.join\(\s*(?:""|'')\s*\)'

  # Array reverse (often used with split/join for string reversal)
  - id: js-array-reverse
    desc: Array reverse method
    crit: notable
    conf: 0.5
    for: [javascript]
    if:
      type: raw
      regex: '\.reverse\(\s*\)'

  # String cleanup using split(key).join("")
  - id: js-split-join-cleanup
    desc: String cleanup using split(key).join("")
    crit: suspicious
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      regex: '\.split\(.{1,120}\)\.join\(\s*(?:""|'')\s*\)'

  # === Density-Based Obfuscation Detection ===
  # Legitimate code rarely has more than a few escape sequences.
  # Obfuscated code packs many encoded chars per KB.

  - id: dense-fromcharcode
    desc: Dense fromCharCode calls (string obfuscation)
    crit: suspicious
    conf: 0.90
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "fromCharCode\\s*\\(\\s*\\d"
      count_min: 5
      per_kb_min: 1.0

  - id: dense-unicode-escapes
    desc: Dense Unicode escape sequences
    crit: suspicious
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\u[0-9a-fA-F]{4}){3,}'
      count_min: 4
      per_kb_min: 0.8

  - id: js-dense-hex-escapes
    desc: Dense hex escape sequences
    crit: suspicious
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\x[0-9a-fA-F]{2}){4,}'
      count_min: 4
      per_kb_min: 0.8

  # Bracket notation property access is used to hide method names
  # e.g., window["eval"] instead of window.eval
  - id: dense-bracket-notation
    desc: Dense bracket notation access (method hiding)
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\[\\s*['\"](?:eval|Function|constructor|atob)['\"]\\s*\\]\\s*\\("
      count_min: 1

composite_rules:
  - id: js-global-property-write
    desc: Global object property assignment
    crit: suspicious
    conf: 0.8
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    all:
      - id: js-global-property-write-assignment
    any:
      - id: js-global-property-write-eval
      - id: js-global-property-write-function
      - id: js-global-property-write-atob
      - id: js-global-property-write-decode

  # String deobfuscation pattern (charAt/split + swap + join)
  # String deobfuscation pattern (charAt/split + swap + join)
  - id: js-string-deobfuscation
    desc: String deobfuscation routine
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1027.002"
    for: [javascript]
    all:
      - id: js-array-join-symbol
      - id: js-string-split
      - id: js-array-swap
    any:
      - id: js-charat-loop
      - id: dense-fromcharcode
      - id: dense-unicode-escapes
      - id: js-dense-hex-escapes

  # String reversal pattern (split + reverse + join)
  - id: js-reverse-string-obfuscation
    desc: String reversal obfuscation pattern
    crit: notable
    conf: 0.9
    mbc: "B0032"
    attack: "T1027.002"
    for: [javascript]
    all:
      - id: js-array-join-symbol
      - id: js-string-split
      - id: js-array-reverse

  # Dynamic exec composite (eval-equivalent patterns)
  - id: js-dynamic-exec
    desc: Dynamic code execution capability
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    any:
      - id: objectives/execution/interpreter/eval/dynamic::eval-call-js
      - id: js-function-call
      - id: js-new-function

  # Global manipulation combo
  - id: js-global-manipulation
    desc: Global object manipulation pattern
    crit: suspicious
    conf: 0.85
    attack: "T1027.002"
    for: [javascript]
    needs: 2
    any:
      - id: js-global-property-write
      - id: js-require-alias
      - id: js-version-marker

  # JavaScript dictionary string reconstruction
  - id: js-dict-string-reconstruction
    desc: JavaScript string reconstructed from dictionary lookup and array iteration
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1027.002"
    for: [javascript]
    all:
      - id: objectives/anti-static/obfuscation/string_reconstruction::js-string-dict-map
      - id: objectives/anti-static/obfuscation/string_reconstruction::js-string-key-array

  - id: js-dict-reconstruction-eval
    desc: Dictionary-rebuilt payload executed with eval
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1027.002"
    for: [javascript]
    all:
      - id: js-dynamic-exec
      - id: js-dict-string-reconstruction

  # Obfuscated dynamic execution
  - id: js-obfuscated-eval
    desc: Obfuscated dynamic code execution
    crit: hostile
    conf: 0.98
    attack: "T1027.002"
    mbc: "B0032"
    for: [javascript]
    # Small snippets with eval + encoding are more suspicious
    size_max: 5000
    all:
      - id: js-dynamic-exec
    any:
      - id: js-string-deobfuscation
      - id: fromcharcode
      - id: js-unicode-escape
      - id: js-hex-escape
      - id: micro-behaviors/data/encode/base64::buffer-from-base64
      - id: micro-behaviors/data/encode/hex::buffer-from-hex
      - id: js-dict-string-reconstruction
    unless:
      - type: string
        regex: "MathJax|jquery|jquery-ui"
      - type: raw
        substr: "require('../common')"

  # Hex-encoded require obfuscation (npm supply chain malware pattern)
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: js-obfuscated-requires
    desc: Obfuscated module imports via hex encoding
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0032"
    for: [javascript]
    all:
      - id: js-hex-encoded-require
      - id: micro-behaviors/data/encode/hex::buffer-from-hex

  # Strong obfuscation indicators (high density or specific techniques)
  - id: js-strong-obfuscation
    desc: Strong obfuscation indicators
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1027"
    for: [javascript]
    any:
      - id: dense-fromcharcode
      - id: dense-unicode-escapes
      - id: js-dense-hex-escapes
      - id: js-hex-encoded-require
      - id: js-string-deobfuscation
      - id: js-dict-string-reconstruction

  # Mixed encoding usage (Hex and Base64) - common in legitimate code
  - id: js-mixed-encoding-usage
    desc: Mixed encoding usage (Hex and Base64)
    crit: notable
    conf: 0.6
    for: [javascript]
    all:
      - id: micro-behaviors/data/encode/base64::buffer-from-base64
      - id: micro-behaviors/data/encode/hex::buffer-from-hex
