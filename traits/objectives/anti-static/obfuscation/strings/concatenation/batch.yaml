# String Obfuscation Detection - Batch
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027, T1059.003

defaults:
  for: [batch, shell]
  mbc: "B0032"
  attack: "T1027"

traits:
  # set%VAR% trick (obfuscated set command)
  - id: batch-obfuscated-set
    desc: Obfuscated set command (set%VAR%)
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: '(?i)set%[^% \t\n]{1,80}%'

  # %VAR%set trick (obfuscated command start)
  - id: batch-obfuscated-command-start
    desc: Obfuscated command start (%VAR%cmd)
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: '(?i)%[^% \t\n]{1,80}%set\s+'

  # Fragmented command reconstruction (multiple sets of 1-4 chars)
  - id: batch-command-reconstruction
    desc: Fragmented command reconstruction
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: '(?i)set\s+[^=]{1,120}=[^ \t\n\r]{1,4}(?:[\t\r\n ]|$)'
      count_min: 5

  # Base64-like payload in set command
  - id: batch-base64-payload
    desc: Large Base64-like payload in set command
    crit: suspicious
    conf: 0.8
    if:
      type: raw
      regex: 'set\s+[^=]{1,120}=[A-Za-z0-9+/]{100,}'

composite_rules:
  - id: batch-heavy-obfuscation
    desc: Heavy batch script obfuscation
    crit: suspicious
    conf: 0.95
    needs: 2
    any:
      - id: batch-obfuscated-set
      - id: batch-obfuscated-command-start
      - id: batch-command-reconstruction
      - id: batch-base64-payload
