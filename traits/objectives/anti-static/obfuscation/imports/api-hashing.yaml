# API Hashing Detection
# Detects hash constants used for dynamic API resolution (import obfuscation)
# Malware uses hash-based lookups to avoid listing API names in imports
# ATT&CK: T1027.007 (Obfuscated Files or Information: Dynamic API Resolution)

defaults:
  attack: "T1027.007"
  mbc: "B0032.014"
  for: [pe, elf, macho]

traits:
  # === Common API Hashing Constants ===

  # ROR13 hash seeds (very common in malware)
  # These specific constants appear in GetProcAddress hash implementations
  - id: ror13-hash-seed
    desc: ROR13 hash algorithm constant
    crit: suspicious
    conf: 0.8
    if:
      type: hex
      section: text
      pattern: "C1 C? 0D"  # ROR reg, 0x0D (rotate right 13 bits)
      count_min: 3

  # DJB2 hash constant (5381 = 0x1505)
  - id: djb2-hash-constant
    desc: DJB2 hash algorithm constant (5381)
    crit: notable
    conf: 0.75
    if:
      type: hex
      section: data
      pattern: "05 15 00 00"  # Little-endian 0x1505

  # FNV1a 32-bit offset basis (0x811c9dc5)
  - id: fnv1a-offset-basis
    desc: FNV1a hash offset basis constant
    crit: notable
    conf: 0.8
    if:
      type: hex
      section: data
      pattern: "C5 9D 1C 81"  # Little-endian FNV offset

  # PEB walk pattern (accessing PEB->Ldr for module enumeration)
  # MOV eax, fs:[0x30] = 64 A1 30 00 00 00
  - id: peb-ldr-access
    desc: PEB Ldr access for module enumeration
    crit: suspicious
    conf: 0.85
    for: [pe]
    if:
      type: hex
      section: text
      pattern: "64 A1 30 00 00 00"  # mov eax, fs:[0x30]

  # Common API hash values (from known malware families)
  # LoadLibraryA ROR13 hash = 0xec0e4e8e
  - id: loadlibrarya-ror13-hash
    desc: LoadLibraryA ROR13 hash constant
    crit: suspicious
    conf: 0.9
    for: [pe]
    if:
      type: hex
      section: data
      pattern: "8E 4E 0E EC"  # Little-endian

  # GetProcAddress ROR13 hash = 0x7c0dfcaa
  - id: getprocaddress-ror13-hash
    desc: GetProcAddress ROR13 hash constant
    crit: suspicious
    conf: 0.9
    for: [pe]
    if:
      type: hex
      section: data
      pattern: "AA FC 0D 7C"  # Little-endian

composite_rules:
  # Hash-based API resolution pattern
  - id: api-hash-resolution
    desc: Dynamic API resolution via hashing
    crit: hostile
    conf: 0.95
    attack: "T1027.007"
    for: [pe, elf, macho]
    all:
      - id: ror13-hash-seed
    any:
      - id: loadlibrarya-ror13-hash
      - id: getprocaddress-ror13-hash
      - id: peb-ldr-access

  # Generic hash-based obfuscation (less specific)
  - id: hash-based-obfuscation
    desc: Hash-based import obfuscation
    crit: suspicious
    conf: 0.85
    needs: 2
    any:
      - id: ror13-hash-seed
      - id: djb2-hash-constant
      - id: fnv1a-offset-basis
      - id: peb-ldr-access
