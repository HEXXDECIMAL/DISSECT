defaults:
  crit: suspicious
  attack: T1027
  mbc: E1014
  for:
    - python
traits:
  - id: chinese-char-variables
    desc: Chinese character variables
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: "[\u4E00-\u9FFF]+="
  - id: bit-shift-arithmetic
    desc: Bit shift obfuscation
    crit: suspicious
    conf: 0.8
    if:
      type: raw
      regex: <<[0-9]+.{0,50}>>[0-9]+|>>[0-9]+.{0,50}<<[0-9]+
  - id: arithmetic-expression-chains
    desc: Complex arithmetic chains
    crit: suspicious
    conf: 0.75
    if:
      type: raw
      regex: "[*].{0,30}//.{0,30}[|].{0,30}<<.{0,30}>>"
  - id: magic-number-state-machine
    desc: Magic number state machine
    crit: suspicious
    conf: 0.8
    if:
      type: raw
      regex: while.{0,30}:[^}]{0,50}if.{0,30}==.{0,30}[0-9]{5,}
  - id: obfuscated-state-variable
    desc: Obfuscated state variable
    crit: suspicious
    conf: 0.75
    if:
      type: raw
      regex: "[\u4E00-\u9FFF]{5,}\\s*=\\s*[0-9]+"
  # com-dispatch-usage removed - use micro-behaviors/communications/ipc/win32com/python composite instead
  - id: ctypes-windll-usage
    desc: ctypes windll usage
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: ctypes\.windll|windll\.shell32
  - id: join-map-getattr-chr
    desc: String built via join(map(getattr(__builtins__)))
    crit: suspicious
    conf: 0.92
    if:
      type: raw
      substr: join(map(getattr(__builtins__
      count_min: 3
  - id: builtin-repr-chr-construction
    desc: Builds chr via builtin repr introspection
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: (oct|hex|c[a-z]+)\.__str__\(\)
      count_min: 3
  - id: is-admin-flag
    desc: IsAdmin flag check (Python)
    crit: notable
    conf: 0.75
    if:
      type: raw
      exact: IsAdmin
  - id: check-token-membership
    desc: CheckTokenMembership Windows API call
    crit: notable
    conf: 0.8
    if:
      type: raw
      substr: CheckTokenMembership
  - id: unicode-variable-names
    desc: Unicode variable names
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "[\\u4E00-\\u9FFF\\u3040-\\u30FF][\\u4E00-\\u9FFF\\u3040-\\u30FFA-Za-z0-9_]{0,63}\\s*="
  - id: getattr-builtins-obfuscation
    desc: getattr builtins obfuscation
    crit: suspicious
    conf: 0.9
    unless:
      - type: basename
        regex: (test_|_test\.|\.test\.|\.spec\.).*\.py$
    if:
      type: raw
      regex: getattr\((?:__builtins__|builtins)\s*,\s*[a-z_]{2,10}\(
  - id: getattr-obfuscated-access
    desc: getattr obfuscated access
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: getattr\(.{0,40},\s*(?:["'][^"'\n]{1,20}["']\s*\+\s*["'][^"'\n]{1,20}["']|chr\()
composite_rules:
  - id: advanced-python-obfuscation
    desc: Advanced Python obfuscation
    crit: suspicious
    conf: 0.9
    attack: T1027
    for:
      - python
    needs: 3
    any:
      - id: unicode-variable-names
      - id: bit-shift-arithmetic
      - id: getattr-builtins-obfuscation
      - id: builtin-repr-chr-construction
  - id: state-machine-obfuscation
    desc: State machine obfuscation
    crit: suspicious
    conf: 0.95
    attack: T1027
    mbc: E1014
    platforms:
      - all
    needs: 2
    any:
      - id: magic-number-state-machine
      - id: obfuscated-state-variable
      - id: chinese-char-variables
  - id: admin-check-ctypes
    desc: Admin privilege check via ctypes (composite)
    crit: suspicious
    conf: 0.85
    any:
      - id: micro-behaviors/os/admin/check::ctypes-is-admin
      - id: is-admin-flag
      - id: check-token-membership
  - id: windows-com-elevation
    desc: Windows COM elevation attempt
    crit: suspicious
    conf: 0.95
    attack: T1078
    mbc: E1059
    platforms:
      - windows
    needs: 2
    any:
      - id: micro-behaviors/communications/ipc/win32com/python::import-win32com
      - id: admin-check-ctypes
      - id: ctypes-windll-usage
  - id: obfuscated-setup-py-trojan
    desc: Heavily obfuscated setup.py trojan
    crit: hostile
    conf: 0.95
    attack: T1195.002
    mbc: B0024
    for:
      - python
    all:
      - id: advanced-python-obfuscation
      - id: state-machine-obfuscation
      - id: micro-behaviors/communications/ipc/win32com/python::import-win32com
