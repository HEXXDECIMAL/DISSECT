defaults:
  for:
  - all
  crit: notable
traits:
- id: python-chr-builtins-getattr
  desc: "Python getattr on __builtins__ for chr construction"
  mbc: E1014
  attack: T1027
  crit: suspicious
  conf: 0.95
  if:
    type: raw
    substr: getattr(__builtins__,

- id: dunder-str-call
  desc: ".__str__() method call"
  if:
    type: raw
    substr: ".__str__()"

- id: oct-name
  desc: "oct.__str__ reference"
  if: { type: raw, regex: "\\boct\\.__str__" }

- id: hex-name
  desc: "hex.__str__ reference"
  if: { type: raw, regex: "\\bhex\\.__str__" }

- id: copyright-name
  desc: "copyright name reference"
  if: { type: raw, substr: "copyright" }

# === GuardDog: chr() join patterns ===

- id: join-chr-generator
  desc: "''.join(chr(x) for x in ...) pattern"
  mbc: E1014
  attack: T1027
  crit: suspicious
  conf: 0.95
  for: [python]
  if:
    type: ast
    query: |
      (call
        function: (attribute
          object: (string)
          attribute: (identifier) @method)
        arguments: (argument_list
          (generator_expression
            body: (call
              function: (identifier) @func
              (#eq? @func "chr"))))
        (#eq? @method "join"))

- id: join-map-chr
  desc: "''.join(map(chr, ...)) pattern"
  mbc: E1014
  attack: T1027
  crit: suspicious
  conf: 0.95
  for: [python]
  if:
    type: ast
    query: |
      (call
        function: (attribute
          object: (string)
          attribute: (identifier) @method)
        arguments: (argument_list
          (call
            function: (identifier) @map
            arguments: (argument_list
              (identifier) @func
              _)
            (#eq? @map "map")
            (#eq? @func "chr")))
        (#eq? @method "join"))

composite_rules:
- id: python-chr-oct-str
  desc: "oct.__str__ used in chr obfuscation"
  crit: suspicious
  all:
    - id: oct-name
    - id: dunder-str-call

- id: python-chr-hex-str
  desc: "hex.__str__ used in chr obfuscation"
  crit: suspicious
  all:
    - id: hex-name
    - id: dunder-str-call

- id: python-chr-copyright-str
  desc: "copyright.__str__ used in chr obfuscation"
  crit: suspicious
  all:
    - id: copyright-name
    - id: dunder-str-call

- id: python-chr-bitwise-construction
  desc: "Python chr construction using oct/hex/copyright strings"
  crit: suspicious
  conf: 0.95
  mbc: E1014
  attack: T1027
  all:
  - id: python-chr-builtins-getattr
  - id: python-chr-oct-str
  - id: python-chr-hex-str
  - id: python-chr-copyright-str
