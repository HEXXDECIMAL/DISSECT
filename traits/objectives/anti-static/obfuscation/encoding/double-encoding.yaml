# Double Encoding Detection
# Detects multiple layers of encoding/obfuscation
# ATT&CK: T1027 (Obfuscated Files), T1059 (Command Execution)
# MBC: E1014 (Data Encoding)

defaults:
  crit: suspicious
  attack: "T1027"
  mbc: "E1014"
  for: [python, javascript, shell]

traits:
  # === ROT13 Patterns ===
  - id: rot13-decode
    desc: ROT13 string obfuscation
    crit: notable
    conf: 0.85
    # Malware typically keeps obfuscation logic compact
    size_max: 10000
    if:
      type: string
      substr: "rot13"

  - id: codecs-rot13
    desc: codecs ROT13 decoding
    crit: suspicious
    conf: 0.85
    size_max: 10000
    if:
      type: string
      regex: "codecs\\.decode.{0,20}rot13|rot13.{0,20}codecs"

  - id: rot13-encoded-string
    desc: ROT13 encoded string literal
    crit: suspicious
    conf: 0.80
    size_max: 10000
    if:
      type: string
      regex: "codecs\\.decode\\('[^']{10,}'"

  # === Base64 + Other Encoding ===
  - id: base64-then-decode
    desc: Base64 then decode
    crit: suspicious
    conf: 0.80
    for: [python]
    size_max: 15000
    if:
      type: raw
      regex: "b64decode[\\s\\S]{0,80}\\.decode\\s*\\(\\s*\\)"

  - id: base64-with-codecs
    desc: Base64 with codecs
    crit: suspicious
    conf: 0.85
    size_max: 15000
    if:
      type: string
      regex: "b64decode.{0,20}codecs|codecs.{0,20}b64decode"

  # === Encoding Chain ===
  - id: nested-encoding
    desc: Nested encoding call
    crit: suspicious
    conf: 0.85
    size_max: 15000
    if:
      type: string
      regex: "decode\\(.{0,30}decode\\(|encode\\(.{0,30}encode\\("

  - id: multi-layer-string
    desc: Multi-layer string processing
    crit: notable
    conf: 0.80
    if:
      type: string
      regex: "bytes\\(.{0,20}encode|str\\(.{0,20}decode"

  # === Obfuscated Path Construction ===
  - id: encoded-path-assembly
    desc: Encoded path assembly
    crit: suspicious
    conf: 0.85
    size_max: 10000
    if:
      type: string
      regex: "codecs\\.encode\\('/|decode\\('/"

  - id: split-join-obfuscation
    desc: Split/join string obfuscation
    crit: suspicious
    conf: 0.80
    for: [javascript]
    size_max: 10000
    if:
      type: raw
      regex: "\\.split\\(\\s*['\"]['\"]\\s*\\).{0,50}\\.join\\(\\s*['\"]['\"]\\s*\\)"

composite_rules:
  # === Double Encoding Detection ===
  - id: rot13-obfuscation
    desc: ROT13 string obfuscation
    crit: suspicious
    conf: 0.90
    attack: "T1027"
    needs: 2
    any:
      - id: rot13-decode
      - id: codecs-rot13
      - id: rot13-encoded-string

  - id: base64-layered-encoding
    desc: Layered base64 encoding
    crit: suspicious
    conf: 0.90
    attack: "T1027"
    mbc: "E1014"
    for: [python, javascript]
    needs: 2
    any:
      - id: base64-then-decode
      - id: base64-with-codecs
      - id: nested-encoding

  - id: double-obfuscation
    desc: Double encoding obfuscation
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    mbc: "E1014"
    platforms: [all]
    needs: 3
    any:
      - id: rot13-decode
      - id: base64-with-codecs
      - id: nested-encoding
      - id: multi-layer-string
      - id: encoded-path-assembly

  - id: advanced-string-obfuscation
    desc: Advanced string obfuscation
    crit: hostile
    conf: 0.98
    attack: "T1027"
    mbc: "E1014"
    platforms: [all]
    all:
      - id: rot13-obfuscation
      - id: base64-layered-encoding
