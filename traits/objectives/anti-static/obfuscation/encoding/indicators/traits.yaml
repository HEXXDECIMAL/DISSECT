# Encoded Malware Indicators Detection
# Detects common malware patterns in encoded strings (any encoding: base64, xor, hex, url, etc.)
# These are generic indicators that appear frequently in malware but are often encoded to evade detection
# ATT&CK: T1027 (Obfuscated Files or Information)
# MBC: F0001 (Anti-Static Analysis)

traits:
  # === Unix/Linux Shell Indicators ===
  - id: encoded-bin-sh
    desc: "Encoded /bin/sh shell path"
    crit: suspicious
    conf: 0.85
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      substr: "/bin/sh"
    attack: "T1059.004"

  - id: encoded-bin-bash
    desc: "Encoded /bin/bash shell path"
    crit: suspicious
    conf: 0.85
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      substr: "/bin/bash"
    attack: "T1059.004"

  - id: encoded-dev-null
    desc: "Encoded /dev/null redirect"
    crit: notable
    conf: 0.75
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      substr: "/dev/null"
    attack: "T1070.006"

  - id: encoded-chmod-x
    desc: "Encoded chmod +x command"
    crit: suspicious
    conf: 0.9
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      id: micro-behaviors/fs/chmod/executable::shell-plus-x
    attack: "T1222.002"

  - id: encoded-tmp-path
    desc: "Encoded /tmp/ directory path"
    crit: notable
    conf: 0.7
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      id: micro-behaviors/fs/path/temp/traits::unix-temp
    attack: "T1074.001"

  # === Wget/Curl Download Commands ===
  - id: encoded-wget-http
    desc: "Encoded wget download command"
    crit: suspicious
    conf: 0.9
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      regex: "wget\\s+https?://"
    attack: "T1105"

  - id: encoded-curl-http
    desc: "Encoded curl download command"
    crit: suspicious
    conf: 0.9
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      regex: "curl\\s+https?://"
    attack: "T1105"

  # === Python Execution Functions ===
  - id: encoded-python-os-system
    desc: "Encoded Python os.system call"
    crit: suspicious
    conf: 0.95
    for: [python, shell]
    if:
      type: encoded
      substr: "os.system"
    attack: "T1059.006"

  - id: encoded-python-subprocess
    desc: "Encoded Python subprocess usage"
    crit: suspicious
    conf: 0.9
    for: [python, shell]
    if:
      type: encoded
      substr: "subprocess"
    attack: "T1059.006"

  - id: encoded-eval
    desc: "Encoded eval() call"
    crit: suspicious
    conf: 0.95
    for: [python, javascript, shell]
    if:
      type: encoded
      regex: "\\beval\\s*\\("
    attack: "T1059"

  - id: encoded-python-exec
    desc: "Encoded Python exec() call"
    crit: suspicious
    conf: 0.95
    for: [python, shell]
    if:
      type: encoded
      regex: "\\bexec\\s*\\("
    attack: "T1059"

  - id: encoded-python-import-dunder
    desc: "Encoded Python __import__ usage"
    crit: suspicious
    conf: 0.9
    for: [python, shell]
    if:
      type: encoded
      substr: "__import__"
    attack: "T1027"

  - id: encoded-python-base64-decode
    desc: "Encoded base64.b64decode call"
    crit: notable
    conf: 0.8
    for: [python, shell]
    if:
      type: encoded
      substr: "base64.b64decode"
    attack: "T1140"

  # === JavaScript/Node.js Functions ===
  - id: encoded-node-require
    desc: "Encoded Node.js require() call"
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: encoded
      regex: "require\\s*\\("
    attack: "T1059.007"

  - id: encoded-js-function-constructor
    desc: "Encoded Function() constructor"
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: encoded
      regex: "\\bFunction\\s*\\([^)]*"
      not:
        - 'Function("d",'
        - 'JSON.stringify(n)+": d["+t+"]"'
        - 'return {'
        - 'version:"'
        - 'Rickshaw'
    attack: "T1059.007"
    downgrade:
      any:
        - id: metadata/library/jquery::domain
        - id: metadata/library/jquery::version-string
        - id: metadata/library/jquery::copyright
        - id: metadata/library/jquery::fn-extend
        - id: metadata/library/d3::d3-detection
        - type: string
          regex: 'd3\.interpolate[a-zA-Z]+|d3\.scale\.linear|d3\.layout\.force|Bo=\{version:"[0-9.]+"\}|d3\s*=\s*\{version:"[0-9.]+"\}|Rickshaw\.Graph|Rickshaw\.Fixtures\.Time'
    unless:
      - id: metadata/library/jquery::domain
      - id: metadata/library/jquery::version-string
      - id: metadata/library/jquery::copyright
      - id: metadata/library/jquery::fn-extend
      - id: metadata/library/d3::d3-detection
      - type: string
        regex: 'd3\.interpolate[a-zA-Z]+|d3\.scale\.linear|d3\.layout\.force|Bo=\{version:"[0-9.]+"\}|d3\s*=\s*\{version:"[0-9.]+"\}|Rickshaw\.Graph|Rickshaw\.Fixtures\.Time'

  - id: encoded-node-child-process
    desc: "Encoded child_process module"
    crit: suspicious
    conf: 0.95
    for: [javascript, typescript]
    if:
      type: encoded
      substr: "child_process"
    attack: "T1059.007"

  - id: encoded-node-vm
    desc: "Encoded Node.js vm module"
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: encoded
      regex: "require\\s*\\([\"']vm[\"']\\)"
    attack: "T1059.007"

  - id: encoded-node-vm-run
    desc: "Encoded vm runIn...Context"
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: encoded
      regex: "runIn(This|New|Context)Context"
    attack: "T1059.007"

  # === Windows Indicators ===
  - id: encoded-cmd-exe
    desc: "Encoded cmd.exe reference"
    crit: suspicious
    conf: 0.85
    for: [pe, dll, python, javascript]
    if:
      type: encoded
      substr: "cmd.exe"
    attack: "T1059.003"

  - id: encoded-powershell
    desc: "Encoded PowerShell reference"
    crit: suspicious
    conf: 0.9
    for: [pe, dll, python, javascript]
    if:
      type: encoded
      regex: "powershell(\\.exe)?\\s+[-/]"
    attack: "T1059.001"

  - id: encoded-dotnet-diagnostics
    desc: "Encoded System.Diagnostics namespace"
    crit: suspicious
    conf: 0.85
    for: [pe, dll]
    if:
      type: encoded
      substr: "System.Diagnostics"
    attack: "T1059"

  # === Network/C2 Indicators ===
  - id: encoded-mozilla-ua
    desc: "Encoded Mozilla user agent string"
    crit: notable
    conf: 0.7
    for: [elf, pe, python, javascript]
    if:
      type: encoded
      substr: "Mozilla/"
    attack: "T1071.001"

  - id: encoded-http-url
    desc: "Encoded HTTP URL"
    crit: notable
    conf: 0.75
    for: [elf, pe, python, javascript, shell]
    if:
      type: encoded
      regex: "https?://[a-zA-Z0-9]"
    attack: "T1071.001"

  # === File Operations ===
  - id: encoded-fopen
    desc: "Encoded fopen() call"
    crit: notable
    conf: 0.7
    for: [elf, pe]
    if:
      type: encoded
      substr: "fopen("
    attack: "T1005"

  - id: encoded-createfile
    desc: "Encoded CreateFile API"
    crit: notable
    conf: 0.75
    for: [pe, dll]
    if:
      type: encoded
      substr: "CreateFile"
    attack: "T1005"

  # === Process Execution ===
  - id: encoded-execve
    desc: "Encoded execve() syscall"
    crit: suspicious
    conf: 0.9
    for: [elf, python]
    if:
      type: encoded
      substr: "execve"
    attack: "T1059"

  - id: encoded-popen
    desc: "Encoded popen() call"
    crit: suspicious
    conf: 0.85
    for: [elf, python]
    if:
      type: encoded
      substr: "popen("
    attack: "T1059"

  # === Reverse Shell Indicators ===
  - id: encoded-bash-i
    desc: "Encoded bash -i (interactive shell)"
    crit: suspicious
    conf: 0.95
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      regex: "bash\\s+-i"
    attack: "T1059.004"

  - id: encoded-sh-i
    desc: "Encoded sh -i (interactive shell)"
    crit: suspicious
    conf: 0.95
    for: [elf, shell, python, javascript]
    if:
      type: encoded
      regex: "sh\\s+-i"
    attack: "T1059.004"

  - id: encoded-dev-tcp
    desc: "Encoded /dev/tcp redirect"
    crit: suspicious
    conf: 0.95
    for: [shell, python, javascript]
    if:
      type: encoded
      substr: "/dev/tcp/"
    attack: "T1071.001"

composite_rules:
  # Multiple encoded shell indicators suggest sophisticated evasion
  - id: encoded-shell-execution-cluster
    desc: "Multiple encoded shell execution indicators"
    crit: suspicious
    conf: 0.9
    for: [elf, shell, python, javascript]
    attack: "T1059.004"
    mbc: "F0001"
    needs: 2
    any:
      - id: encoded-bin-sh
      - id: encoded-bin-bash
      - id: encoded-chmod-x
      - id: encoded-bash-i
      - id: encoded-sh-i

  # Python malware execution pattern
  - id: encoded-python-malware-pattern
    desc: "Encoded Python malware execution pattern"
    crit: suspicious
    conf: 0.92
    for: [python, shell]
    attack: "T1059.006"
    mbc: "F0001"
    needs: 2
    any:
      - id: encoded-python-os-system
      - id: encoded-python-subprocess
      - id: encoded-eval
      - id: encoded-python-exec
      - id: encoded-python-base64-decode

  # Network download tools
  - id: encoded-download-tools
    desc: "Encoded download tool usage"
    crit: notable
    conf: 0.8
    for: [elf, shell, python, javascript]
    attack: "T1105"
    any:
      - id: encoded-wget-http
      - id: encoded-curl-http

  # Network downloader pattern
  - id: encoded-downloader-pattern
    desc: "Encoded file download pattern"
    crit: suspicious
    conf: 0.93
    for: [elf, shell, python, javascript]
    attack: "T1105"
    mbc: "F0001"
    all:
      - id: encoded-http-url
      - id: encoded-download-tools

  # Interactive shell
  - id: encoded-interactive-shell
    desc: "Encoded interactive shell flag"
    crit: suspicious
    conf: 0.9
    for: [shell, python, javascript]
    attack: "T1059.004"
    any:
      - id: encoded-bash-i
      - id: encoded-sh-i

  # Reverse shell pattern
  - id: encoded-reverse-shell-pattern
    desc: "Encoded reverse shell pattern"
    crit: suspicious
    conf: 0.95
    for: [shell, python, javascript]
    attack: "T1071.001"
    mbc: "F0001"
    all:
      - id: encoded-dev-tcp
      - id: encoded-interactive-shell

  # JavaScript code execution pattern
  - id: encoded-js-execution-pattern
    desc: "Encoded JavaScript execution pattern"
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    attack: "T1059.007"
    mbc: "F0001"
    needs: 2
    any:
      - id: encoded-js-function-constructor
      - id: encoded-eval
      - id: encoded-node-child-process
      - id: encoded-node-require
