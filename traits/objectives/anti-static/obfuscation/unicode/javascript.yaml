# Unicode/Emoji Obfuscation - JavaScript
# Detects obfuscation using Unicode characters, emojis, and international scripts
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # High density of non-ASCII characters
  - id: dense-non-ascii
    desc: Dense non-ASCII character payload
    crit: notable
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "[^\\x00-\\x7F]{10,}"
      count_min: 3
      per_kb_min: 0.5

  # International script characters (Devanagari, Cyrillic, Arabic, etc.)
  - id: international-script-obfuscation
    desc: International script character obfuscation
    crit: notable
    conf: 0.75
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "[\\p{Devanagari}\\p{Cyrillic}\\p{Arabic}\\p{Hebrew}\\p{Han}]"
      count_min: 5
    downgrade:
      any:
        - type: basename
          regex: "^[a-z]{2,3}(-[A-Z][a-z]{3})?(-[A-Z]{2})?\\.js$"
        - type: string
          regex: "moment\\.lang\\(['\"][a-z]{2}"

  # Mixed Unicode blocks in single string (sophisticated obfuscation)
  - id: mixed-unicode-blocks
    desc: Mixed Unicode block obfuscation
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "[\\U00010000-\\U0010FFFF][\\u0900-\\u097F][\\U0001F000-\\U0001F999]"
      count_min: 2

  # Unicode string concatenation patterns
  - id: unicode-string-concatenation
    desc: Unicode character string concatenation
    crit: notable
    conf: 0.78
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\+\\s*[\"'][^\\x00-\\x7F]{3,}[\"']"
      count_min: 5
      per_kb_min: 0.3

  # String containing both Unicode and ASCII obfuscation
  - id: mixed-ascii-unicode
    desc: Mixed ASCII and Unicode obfuscation
    crit: suspicious
    conf: 0.83
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "[\\x00-\\x7F]{3,}[^\\x00-\\x7F]{3,}[\\x00-\\x7F]{3,}"
      count_min: 10

  # Unusual Unicode characters in variable names
  - id: unicode-variable-names
    desc: Unicode characters in identifiers
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "[\\$a-zA-Z_][\\$a-zA-Z0-9_]*[^\\x00-\\x7F][\\$a-zA-Z0-9_]*"
      count_min: 3

composite_rules:
  # Advanced Unicode obfuscation composite
  - id: advanced-unicode-obfuscation
    desc: Advanced Unicode obfuscation pattern
    crit: suspicious
    conf: 0.94
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    needs: 2
    any:
      - id: dense-non-ascii
      - id: international-script-obfuscation
      - id: mixed-unicode-blocks
    all:
      - id: unicode-string-concatenation

  # Unicode-based string hiding
  - id: unicode-string-hiding
    desc: Unicode-based string hiding technique
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027.002"
    for: [javascript, typescript]
    all:
      - id: dense-non-ascii
      - id: mixed-ascii-unicode
    any:
      - id: unicode-variable-names

  # International script obfuscation with concatenation
  - id: international-script-obfuscation-complex
    desc: Complex international script obfuscation
    crit: suspicious
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: international-script-obfuscation
      - id: unicode-string-concatenation
    any:
      - id: objectives/anti-static/obfuscation/strings/encoding::dense-unicode-escapes
      - id: mixed-unicode-blocks
