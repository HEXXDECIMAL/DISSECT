traits:
- id: while-not-not-array
  desc: while(!![]) infinite loop pattern
  crit: notable
  conf: 0.85
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: while\(!!\[\]\)
- id: while-not-zero
  desc: while(0x0) infinite loop pattern
  crit: notable
  conf: 0.85
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: while\(0x0\)
- id: while-not-space-zero
  desc: while(!![]) with space infinite loop
  crit: notable
  conf: 0.85
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: while\(\s*!!\s*\[\]\s*\)
- id: push-shift-pattern
  desc: Array push/shift rotation pattern
  crit: notable
  conf: 0.8
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: \.push\([^)]*?\.shift\(\)\)
- id: shift-push-pattern
  desc: Array unshift/pop rotation pattern
  crit: notable
  conf: 0.8
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: \.unshift\([^)]*?\.pop\(\)\)
- id: array-shuffle-algorithm
  desc: Array shuffle algorithm in infinite loop
  crit: suspicious
  conf: 0.88
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: while\(!!\[\]\).*?try.*?parseInt.*?\.push.*?\.shift
- id: array-swap-elements
  desc: Array element assignment swap step
  crit: notable
  conf: 0.75
  attack: T1027
  for:
  - javascript
  if:
    type: raw
    regex: \w+\[\w+\]\s*=\s*\w+\[\w+\]
    count_min: 3
# GuardDog: Boolean coercion in for loop
- id: for-boolean-coercion
  desc: For loop with boolean coercion (+!!false)
  crit: notable
  conf: 0.88
  attack: T1027
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: 'for\s*\(\s*(?:var|let|const)\s+\w+\s*=\s*\+\s*!!\s*false'
# GuardDog: Dynamic global access via Buffer
- id: global-buffer-access
  desc: Dynamic global property access via Buffer
  crit: suspicious
  conf: 0.92
  attack: T1027.002
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: 'global\s*\[\s*Buffer\.from\s*\('
# GuardDog: Hex-prefixed function/variable names
- id: hex-function-names
  desc: Hex-prefixed function names (_0x pattern)
  crit: notable
  conf: 0.90
  attack: T1027
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: 'function\s+_0x[a-fA-F0-9]{4,}\s*\('
- id: hex-variable-names
  desc: Hex-prefixed variable names (_0x pattern)
  crit: notable
  conf: 0.85
  attack: T1027
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: '(?:var|let|const)\s+_0x[a-fA-F0-9]{4,}\s*='
# GuardDog: JSFuck obfuscation
- id: jsfuck-pattern
  desc: JSFuck obfuscation ([]()!+ only)
  crit: suspicious
  conf: 0.95
  attack: T1027.002
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: '(?:^|[^/\*])\s*[\[\]\(\)\+\!]{10,}\s*(?:$|[^/\*])'
# GuardDog: Whitespace hiding
- id: whitespace-hiding
  desc: Very long horizontal whitespace to hide code
  crit: notable
  conf: 0.85
  attack: T1027
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: '^.{0,100};?[\t ]{150,300}.{10,200}$'
# GuardDog: Packer pattern (eval + function + replace)
- id: packer-eval-pattern
  desc: Packer obfuscation (eval with replace)
  crit: suspicious
  conf: 0.95
  attack: T1027.002
  mbc: B0032
  for:
  - javascript
  if:
    type: raw
    regex: 'eval\s*\(\s*function\s*\(.{0,80}\)\s*\{.{0,220}\.replace\s*\(\s*new\s+RegExp'
composite_rules:
- id: infinite-loop
  desc: Obfuscated infinite loop (while(!![]) pattern)
  crit: notable
  conf: 0.9
  attack: T1027
  for:
  - javascript
  any:
  - id: while-not-not-array
  - id: while-not-zero
  - id: while-not-space-zero
  - id: for-boolean-coercion
- id: string-array-rotation
  desc: String array with rotation decoder
  crit: notable
  conf: 0.9
  attack: T1027
  for:
  - javascript
  any:
  - id: push-shift-pattern
  - id: shift-push-pattern
  - id: array-shuffle-algorithm
- id: advanced-array-shuffling
  desc: Advanced array shuffling algorithm
  crit: hostile
  conf: 0.95
  attack: T1027.002
  for:
  - javascript
  all:
  - id: infinite-loop
  - id: string-array-rotation
  any:
  - id: array-swap-elements
  - id: string-array-rotation
# GuardDog: Name mangling composite
- id: hex-name-mangling
  desc: Hex-prefixed identifier names (obfuscation)
  crit: suspicious
  conf: 0.90
  attack: T1027
  mbc: B0032
  for:
  - javascript
  any:
  - id: hex-function-names
  - id: hex-variable-names
# GuardDog: Commercial obfuscator indicators
- id: commercial-obfuscation
  desc: Commercial obfuscator patterns
  crit: suspicious
  conf: 0.92
  attack: T1027.002
  mbc: B0032
  for:
  - javascript
  any:
  - id: packer-eval-pattern
  - id: jsfuck-pattern
  - id: global-buffer-access
# GuardDog: Strong obfuscation combo
- id: strong-js-obfuscation
  desc: Strong JavaScript obfuscation indicators
  crit: hostile
  conf: 0.95
  attack: T1027.002
  mbc: B0032
  for:
  - javascript
  needs: 2
  any:
  - id: hex-name-mangling
  - id: commercial-obfuscation
  - id: advanced-array-shuffling
  - id: whitespace-hiding
