# Self-Deletion Detection - Windows
# MBC: F0007 (Self Deletion)
# ATT&CK: T1070.004

defaults:
  for: [all]
  mbc: "F0007"
  attack: "T1070.004"
  platforms: [windows]

traits:
  - id: self-delete-windows
    desc: Self-deleting via DeleteFile
    crit: suspicious
    conf: 0.66
    if:
      type: string
      substr: "DeleteFile(argv[0])"

  # VBS file deletion (dropper cleanup)
  - id: vbs-file-delete
    desc: Delete VBS files
    crit: suspicious
    conf: 0.85
    for: [all]
    if:
      type: string
      regex: "del\\s.{0,50}\\.vbs|Remove-Item.{0,50}\\.vbs|DeleteFile.{0,50}\\.vbs"
      case_insensitive: true

  # Script file deletion (generic)
  - id: script-file-delete-del
    desc: Delete script files using del
    crit: notable
    conf: 0.75
    for: [all]
    if:
      type: string
      regex: "del\\s.{0,50}\\.(ps1|bat|cmd|vbs)"
      case_insensitive: true

  - id: script-file-delete-remove-item
    desc: Delete script files using Remove-Item
    crit: notable
    conf: 0.75
    for: [all]
    if:
      type: string
      regex: "Remove-Item.{0,50}\\.(ps1|bat|cmd|vbs)"
      case_insensitive: true

  # Multiple VBS deletions (dropper cleanup pattern)
  - id: multi-vbs-delete
    desc: Multiple VBS file deletions
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: string
      regex: "del.{0,50}\\.vbs|Remove-Item.{0,50}\\.vbs"
      case_insensitive: true
      count_min: 2

composite_rules:
  - id: script-file-delete
    desc: Delete script files
    crit: notable
    conf: 0.75
    for: [all]
    any:
      - id: script-file-delete-del
      - id: script-file-delete-remove-item
