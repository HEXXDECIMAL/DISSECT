# Shell Timestomping Detection
# Detects shell scripts that modify file timestamps to cover tracks
# ATT&CK: T1070.006 (Indicator Removal: Timestomp)
# MBC: F0006 (Indicator Removal)

defaults:
  crit: suspicious
  attack: "T1070.006"
  mbc: "F0006"
  for: [shell]

traits:
  # touch -r (copy timestamp from another file)
  - id: touch-reference
    desc: Copies timestamp from reference file
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: 'touch\s+-r\s+[^\s]{1,120}'

  # touch -d (set specific timestamp)
  - id: touch-date
    desc: Sets specific file timestamp
    crit: notable
    conf: 0.8
    if:
      type: raw
      regex: 'touch\s+-d\s+["\x27][^"\x27]{1,120}["\x27]'

  # touch -t (set timestamp with STAMP)
  - id: touch-timestamp
    desc: Sets timestamp with STAMP format
    crit: notable
    conf: 0.8
    if:
      type: raw
      regex: 'touch\s+-t\s+\d+'

  # Multiple touch -r operations (strong indicator)
  - id: touch-reference-multiple
    desc: Multiple timestamp copy operations
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: 'touch\s+-r\s+[^\s]{1,120}'
      count_min: 2
