# Ftrace Deception and Fake State Logic (Linux-specific)
# Detects fake state and rootkit deception patterns using ftrace hooks

traits:
  # === Rootkit Keywords (case variants) ===
  - id: singularity-lower
    desc: singularity keyword (lowercase)
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      word: "singularity"

  - id: singularity-title
    desc: Singularity keyword (title case)
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      word: "Singularity"

  - id: singularity-upper
    desc: SINGULARITY keyword (uppercase)
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      word: "SINGULARITY"

  - id: ftrace-lower
    desc: ftrace keyword (lowercase)
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      word: "ftrace"

  - id: ftrace-title
    desc: Ftrace keyword (title case)
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      word: "Ftrace"

  - id: ftrace-upper
    desc: FTRACE keyword (uppercase)
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      word: "FTRACE"

  - id: taint-lower
    desc: taint keyword (lowercase)
    crit: notable
    conf: 0.6
    for: [c, elf]
    if:
      type: string
      word: "taint"

  - id: taint-title
    desc: Taint keyword (title case)
    crit: notable
    conf: 0.6
    for: [c, elf]
    if:
      type: string
      word: "Taint"

  - id: taint-upper
    desc: TAINT keyword (uppercase)
    crit: notable
    conf: 0.6
    for: [c, elf]
    if:
      type: string
      word: "TAINT"

  # === Fake State Variables ===
  - id: ftrace-enabled
    desc: ftrace_enabled kernel variable
    crit: notable
    conf: 0.75
    for: [c, elf]
    if:
      type: symbol
      exact: "ftrace_enabled"

  - id: tracing-on
    desc: tracing_on kernel variable
    crit: notable
    conf: 0.75
    for: [c, elf]
    if:
      type: symbol
      exact: "tracing_on"

  - id: saved-ftrace-value
    desc: saved_ftrace_value variable (fake state storage)
    crit: notable
    conf: 0.85
    for: [c, elf]
    if:
      type: symbol
      exact: "saved_ftrace_value"

  - id: ftrace-write-intercepted
    desc: ftrace_write_intercepted flag (deception indicator)
    crit: notable
    conf: 0.85
    for: [c, elf]
    if:
      type: symbol
      exact: "ftrace_write_intercepted"

  # Structural Deception Pattern (AST)
  - id: deception-read-hook
    desc: Structural pattern of a read
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [c]
    if:
      type: ast
      query: |
        ((call_expression
          function: (identifier) @copy_fn
          arguments: (argument_list
            (identifier) @dest
            (identifier) @src
            (identifier) @len))
         (#eq? @copy_fn "copy_to_user"))

composite_rules:
  - id: singularity-keyword
    desc: Singularity keyword (case variants)
    for: [c, elf]
    any:
      - { id: singularity-lower }
      - { id: singularity-title }
      - { id: singularity-upper }
    crit: notable

  - id: ftrace-keyword
    desc: Ftrace keyword (case variants)
    crit: notable
    for: [c, elf]
    any:
      - { id: ftrace-lower }
      - { id: ftrace-title }
      - { id: ftrace-upper }
    # Ftrace is a legitimate Linux tracing framework used by performance tools,
    # debuggers, video drivers (for trace logging), and system monitoring tools.
    downgrade:
      any:
        - id: micro-behaviors/dylib/load/video-lib-marker
        - id: micro-behaviors/dylib/library::graphics-lib-marker
        - id: micro-behaviors/dylib/library::system-lib-marker
        - id: micro-behaviors/dylib/library::debugger-tool-marker

  - id: taint-keyword
    desc: Taint keyword (case variants)
    for: [c, elf]
    any:
      - { id: taint-lower }
      - { id: taint-title }
      - { id: taint-upper }
    crit: notable

  - id: rootkit-keywords
    desc: Rootkit-related keywords
    crit: notable
    for: [c, elf]
    any:
      - { id: singularity-keyword }
      - { id: ftrace-keyword }
      - { id: taint-keyword }
    # These keywords have legitimate uses: ftrace for debugging, taint for
    # memory safety, singularity for HPC containers. Only suspicious in
    # combination with actual rootkit infrastructure.
    downgrade:
      any:
        - id: micro-behaviors/dylib/load/video-lib-marker
        - id: micro-behaviors/dylib/library::graphics-lib-marker
        - id: micro-behaviors/dylib/library::system-lib-marker
        - id: micro-behaviors/dylib/library::debugger-tool-marker

  - id: ftrace-state-vars
    desc: Ftrace state variables
    for: [c, elf]
    any:
      - { id: ftrace-enabled }
      - { id: tracing-on }
    crit: notable

  - id: fake-state-vars
    desc: Fake state storage variables
    for: [c, elf]
    any:
      - { id: saved-ftrace-value }
      - { id: ftrace-write-intercepted }
    crit: notable

  - id: fake-state-logic
    desc: Divergent logic where READ returns
    crit: suspicious
    conf: 0.9
    attack: "T1562.001"
    for: [c, elf]
    all:
      - { id: ftrace-state-vars }
      - { id: fake-state-vars }

  # Fake State Deception (Faking disabled state while keeping active hooks)
  - id: fake-state-deception
    desc: "Fake state deception detected"
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [c, elf]
    needs: 2
    any:
      - { id: fake-state-logic }
      - { id: deception-read-hook }
