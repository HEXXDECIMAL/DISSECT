defaults:
  for:
    - all
  attack: T1555.003
traits:
  - id: regex-standard
    desc: Discord token regex pattern
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '[A-Za-z0-9_-]{24}\\.[A-Za-z0-9_-]{6}\\.[A-Za-z0-9_-]{27}'
  - id: regex-mfa
    desc: Discord MFA token regex pattern
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: mfa\\.[A-Za-z0-9_-]{84}
  - id: literal-pattern
    desc: Discord token in code
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: '[MN][A-Za-z0-9]{23,}\.[A-Za-z0-9_-]{6}\.[A-Za-z0-9_-]{27}'
  - id: localstorage-path
    desc: Discord Local Storage directory access
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: (?i)(discord|discordcanary|discordptb)[/\\]+(Local Storage|leveldb)
  - id: api-users-me
    desc: Discord API user validation endpoint
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: discord(app)?\.com/api/(v[0-9]+/)?users/@me
  - id: api-billing
    desc: Discord billing/payment API endpoint
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: discord(app)?\.com/api/(v[0-9]+/)?users/@me/billing
  - id: api-payment-sources
    desc: Discord payment sources API endpoint
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: payment-sources
  - id: api-relationships
    desc: Discord relationships API endpoint
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: users/@me/relationships
  - id: api-channels
    desc: Discord channels API endpoint
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: users/@me/channels
  - id: discord-path
    desc: Discord application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: Discord
      not: https?://
  - id: discord-canary-path
    desc: Discord Canary application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: (?i)discordcanary
  - id: discord-ptb-path
    desc: Discord PTB application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: (?i)discordptb
  - id: mfa-prefix
    desc: MFA token prefix indicator
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: mfa.
  - id: mfa-token-type
    desc: MFA token type enumeration
    crit: suspicious
    conf: 0.85
    for:
      - javascript
      - typescript
    if:
      type: raw
      regex: (?i)(MFA\s*[=:]\s*[0-9]|TokenType\.MFA|type:\s*MFA)
  - id: users-me-path
    desc: Discord users/@me API path
    crit: notable
    conf: 0.75
    if:
      type: string
      substr: users/@me
  - id: webhook-exfil
    desc: Discord webhook exfiltration endpoint
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: discord(app)?\.com/api/webhooks/
  - id: telegram-exfil
    desc: Telegram API exfiltration endpoint
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: api.telegram.org
  # Removed: brave-browser, edge-browser (dead code, use discovery/host/browser/ instead)
  - id: ldb-extension
    desc: LevelDB file extension
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: .ldb
  - id: appdata-ref
    desc: Windows AppData directory reference
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: '(?i)AppData[/\\](Roaming|Local)[/\\](Discord|discordcanary|discordptb)'
  - id: extract-tokens-fn
    desc: Token extraction function
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: extractTokens?\(
  - id: get-tokens-fn
    desc: Token getter function
    crit: notable
    conf: 0.85
    if:
      type: raw
      regex: getTokens?\(
  - id: discord-domain-filter
    desc: Discord domain filtering regex
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: discord\(\?:app\)\?
  - id: firefox-webappsstore
    desc: Firefox webappsstore.sqlite database
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: webappsstore.sqlite
  - id: firefox-ls-archive
    desc: Firefox ls-archive.sqlite database
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: ls-archive.sqlite
  - id: firefox-storage-default
    desc: Firefox storage/default path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: storage/default
  - id: firefox-ls-data
    desc: Firefox ls/data.sqlite database
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: ls/data.sqlite
  # Removed: chrome-browser, opera-browser (dead code, use discovery/host/browser/ instead)
composite_rules:
  - id: stealer-detected
    desc: Discord token stealer detected
    crit: suspicious
    conf: 0.98
    attack: T1555.003
    mbc: B0030
    for:
      - javascript
      - typescript
      - python
      - elf
      - pe
      - macho
    needs: 2
    any:
      - id: micro-behaviors/fs/path/sensitive/browser::leveldb-ref
      - id: discord-path
      - id: regex-standard
      - id: webhook-exfil
  - id: browser-grabber
    desc: Discord token grabber targeting multiple
    crit: suspicious
    conf: 0.95
    attack: T1555.003
    mbc: B0030
    for:
      - javascript
      - typescript
      - python
      - elf
      - pe
      - macho
    all:
      - id: discord-path
      - id: micro-behaviors/data/text/keywords::token
  - id: leveldb-harvester
    desc: LevelDB credential harvester
    crit: hostile
    conf: 0.95
    attack: T1555.003
    mbc: B0030
    for:
      - javascript
      - typescript
    all:
      - id: micro-behaviors/fs/path/sensitive/browser::leveldb-ref
      - id: micro-behaviors/fs/path/sensitive/browser::local-storage-ref
      - id: appdata-ref
      - id: objectives/discovery/host/system/hardware-fingerprint::os-homedir-call
  - id: firefox-storage-access
    desc: Firefox browser storage database access
    crit: notable
    conf: 0.9
    for:
      - javascript
      - typescript
      - python
    any:
      - id: firefox-webappsstore
      - id: firefox-ls-archive
      - id: firefox-ls-data
  - id: firefox-token-stealer
    desc: Firefox Discord token stealer
    crit: hostile
    conf: 0.95
    attack: T1555.003
    mbc: B0030
    for:
      - javascript
      - typescript
    all:
      - id: firefox-storage-access
      - id: appdata-ref
      - id: objectives/discovery/host/system/hardware-fingerprint::os-homedir-call
    any:
      - id: extract-tokens-fn
      - id: get-tokens-fn
      - id: discord-domain-filter
