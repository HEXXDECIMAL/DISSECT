# Compiled AppleScript Credential Variable Detection
# Detects variable names indicative of credential handling
# ATT&CK: T1555 (Credentials from Password Stores)

defaults:
  for: [applescript]
  platforms: [macos]
  attack: "T1555"

traits:
  # ============================================
  # Password Variables
  # ============================================
  - id: var-password
    desc: "Variable named 'password'"
    crit: suspicious
    conf: 0.85
    if:
      type: symbol
      regex: "(?i)^password$"

  - id: var-passwd
    desc: "Variable named 'passwd'"
    crit: suspicious
    conf: 0.85
    if:
      type: symbol
      regex: "(?i)^passwd$"

  - id: var-pwd
    desc: "Variable named 'pwd'"
    crit: notable
    conf: 0.7
    if:
      type: symbol
      regex: "(?i)^pwd$"

  # ============================================
  # Credential Variables
  # ============================================
  - id: var-credential
    desc: "Variable named 'credential'"
    crit: suspicious
    conf: 0.85
    if:
      type: symbol
      regex: "(?i)^credentials?$"

  - id: var-auth
    desc: "Authentication-related variable name"
    crit: notable
    conf: 0.7
    if:
      type: symbol
      regex: "(?i)^(auth|auth_token|authkey|authorization)$"

  # ============================================
  # Token/Key Variables
  # ============================================
  - id: var-apikey
    desc: "Variable named 'apikey'"
    crit: suspicious
    conf: 0.85
    attack: "T1528"
    if:
      type: symbol
      regex: "(?i)^api_?key$"

  - id: var-secret
    desc: "Variable named 'secret'"
    crit: suspicious
    conf: 0.8
    if:
      type: symbol
      regex: "(?i)^secret$"

  - id: var-private-key
    desc: "Variable for private key"
    crit: suspicious
    conf: 0.85
    if:
      type: symbol
      regex: "(?i)^private_?key$"

  # ============================================
  # Wallet/Crypto Variables
  # ============================================
  - id: var-wallet
    desc: "Variable named 'wallet'"
    crit: suspicious
    conf: 0.9
    attack: "T1005"
    if:
      type: symbol
      regex: "(?i)^wallet$"

  - id: var-mnemonic
    desc: "Variable named 'mnemonic'"
    crit: suspicious
    conf: 0.95
    attack: "T1005"
    if:
      type: symbol
      regex: "(?i)^mnemonic$"

  - id: var-seed-phrase
    desc: "Variable for seed phrase"
    crit: suspicious
    conf: 0.95
    attack: "T1005"
    if:
      type: symbol
      regex: "(?i)^seed_?phrase$"

  # ============================================
  # Path Variables (notable - context needed)
  # ============================================
  - id: var-save-path
    desc: "Variable for save path"
    crit: notable
    conf: 0.75
    if:
      type: symbol
      regex: "(?i)^save_?path$"

  - id: var-output-path
    desc: "Variable for output path"
    crit: notable
    conf: 0.7
    if:
      type: symbol
      regex: "(?i)^(output|dest)_?path$"

  # ============================================
  # Network Variables
  # ============================================
  - id: var-url
    desc: "Variable named 'url'"
    crit: notable
    conf: 0.75
    if:
      type: symbol
      regex: "(?i)^url$"

  - id: var-server
    desc: "Variable named 'server'"
    crit: notable
    conf: 0.75
    if:
      type: symbol
      regex: "(?i)^server$"

  - id: var-endpoint
    desc: "Variable named 'endpoint'"
    crit: notable
    conf: 0.75
    if:
      type: symbol
      regex: "(?i)^endpoint$"

  # ============================================
  # C2-like Variables
  # ============================================
  - id: var-c2
    desc: "Variable suggests C2"
    crit: suspicious
    conf: 0.9
    attack: "T1071"
    if:
      type: symbol
      exact: c2

  - id: var-beacon
    desc: "Variable named 'beacon'"
    crit: suspicious
    conf: 0.9
    attack: "T1071"
    if:
      type: symbol
      regex: "(?i)^beacon$"

  - id: var-exfil
    desc: "Variable suggests exfiltration"
    crit: suspicious
    conf: 0.9
    attack: "T1041"
    if:
      type: symbol
      regex: "(?i)^exfil"

composite_rules:
  # ============================================
  # Password Handling
  # ============================================
  - id: handles-passwords
    desc: "Script handles password data"
    crit: suspicious
    conf: 0.9
    for: [applescript]
    any:
      - { id: var-password }
      - { id: var-passwd }
      - { id: var-credential }

  # ============================================
  # Token/Key Handling
  # ============================================
  - id: handles-secrets
    desc: "Script handles tokens or keys"
    crit: suspicious
    conf: 0.85
    for: [applescript]
    any:
      - { id: var-apikey }
      - { id: var-secret }
      - { id: var-private-key }

  # ============================================
  # Crypto Wallet Targeting
  # ============================================
  - id: targets-wallet
    desc: "Script targets crypto wallet"
    crit: suspicious
    conf: 0.9
    attack: "T1005"
    for: [applescript]
    any:
      - { id: var-wallet }
      - { id: var-mnemonic }
      - { id: var-seed-phrase }

  # ============================================
  # Credential Exfiltration
  # ============================================
  - id: credential-exfil
    desc: "Credentials with network activity"
    crit: hostile
    conf: 0.85
    attack: "T1555"
    for: [applescript]
    all:
      - { id: handles-passwords }
    any:
      - { id: var-url }
      - { id: var-server }
      - { id: micro-behaviors/process/create/shell::shell-execution }

  # ============================================
  # Wallet Theft
  # ============================================
  - id: wallet-theft
    desc: "Wallet data with save/exfil"
    crit: hostile
    conf: 0.9
    attack: "T1005"
    for: [applescript]
    all:
      - { id: targets-wallet }
    any:
      - { id: var-save-path }
      - { id: var-output-path }
      - { id: micro-behaviors/process/create/shell::shell-execution }
