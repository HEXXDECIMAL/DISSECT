defaults:
  for:
  - python
  attack: T1210
traits:
- id: ip-list-read
  desc: Reading IP addresses from file
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: open\([^)]{0,120}\)\.(read|readlines)\(\)
- id: post-to-target
  desc: HTTP POST to dynamic target
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: (requests|aiohttp|httpx)\.post\s*\(\s*f['"]
- id: threading-dot-start
  desc: threading.start usage
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: threading.start
- id: exploit-endpoint-url
  desc: Common exploit endpoint URL pattern
  crit: notable
  conf: 0.7
  if:
    type: string
    regex: (/cgi-bin/|/admin/|/wp-admin)
- id: exploit-endpoint-file
  desc: Common exploit endpoint file pattern
  crit: notable
  conf: 0.75
  if:
    type: string
    regex: (shell\.php|cmd\.asp)
- id: exploit-endpoint-rpc
  desc: Common exploit endpoint RPC pattern
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: \$[0-9]{4,5}
- id: ip-list-argv
  desc: IP list from command line
  crit: notable
  conf: 0.6
  if:
    type: string
    substr: sys.argv[1]
- id: ip-list-word
  desc: ip_list variable naming
  crit: notable
  conf: 0.4
  if:
    type: string
    substr: ip_list
- id: targets-word
  desc: targets variable naming
  crit: notable
  conf: 0.4
  if:
    type: string
    substr: targets
- id: http-aiohttp
  desc: Async HTTP via aiohttp library
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: aiohttp
- id: cve-reference
  desc: CVE identifier in code
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: CVE-[0-9]{4}-[0-9]{4,}
- id: exploit-code-comment
  desc: Exploit mentioned in comment
  crit: notable
  conf: 0.6
  if:
    type: raw
    regex: '#.{0,50}exploit|//.{0,50}exploit|/\*.{0,50}exploit'
- id: shell-endpoint
  desc: Shell endpoint in URL
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: shell\.(php|asp|jsp)|/shell[/?]
- id: shell-exec-pattern
  desc: Shell command execution pattern
  crit: notable
  conf: 0.6
  if:
    type: raw
    regex: (exec|system|passthru)\s*\(.{0,50}\$_GET
- id: subprocess-shell-user-input-run-call
  desc: subprocess.run/call with shell=True and user input
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: subprocess\.(run|call).{0,50}shell\s*=\s*True.{0,50}(input|argv|request)
- id: subprocess-shell-user-input-popen
  desc: subprocess.Popen with shell=True and user input
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: subprocess\.Popen.{0,50}shell\s*=\s*True.{0,50}(input|argv|request)
- id: pawn-keyword
  desc: Contains pawn keyword
  crit: notable
  conf: 0.5
  if:
    type: string
    regex: (?i)\bpawn\b
- id: threading-thread
  desc: Uses threading.Thread class
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: threading.Thread
- id: asyncio-usage
  desc: Uses asyncio library
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: asyncio
- id: multiprocessing-usage
  desc: Uses multiprocessing library
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: multiprocessing
- id: ssl-verify-ssl-false
  desc: SSL verify_ssl disabled
  crit: notable
  conf: 0.6
  if:
    type: string
    substr: verify_ssl=False
- id: ssl-insecure-warning
  desc: Suppresses InsecureRequestWarning
  crit: notable
  conf: 0.6
  if:
    type: string
    substr: InsecureRequestWarning
- id: files-dict
  desc: Files dict for upload
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: files={
- id: multipart-upload
  desc: Multipart file upload
  crit: notable
  conf: 0.5
  if:
    type: string
    substr: multipart
- id: file-open
  desc: File open call in exploit context
  crit: notable
  conf: 0.4
  if:
    type: string
    regex: open\([^)]{0,120}\)\.(read|readlines)
- id: binary-read-mode
  desc: Binary read mode
  crit: notable
  conf: 0.4
  if:
    type: string
    exact: '''rb'''
- id: for-loop-iteration-1
  desc: For loop over targets (list/hosts)
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: for\s+\w+\s+in\s+(ip_list|targets|hosts)
- id: for-loop-iteration-2
  desc: For loop over targets (ips/addr)
  crit: notable
  conf: 0.6
  if:
    type: string
    regex: for\s+\w+\s+in\s+(ips|addr)
- id: ssl-verify-false
  desc: SSL verify disabled
  crit: notable
  conf: 0.6
  if:
    type: raw
    regex: (?s)(requests|httpx)\.(get|post|request)\s*\(.{0,50}verify\s*=\s*False
composite_rules:
- id: exploit-endpoint
  desc: Common exploit endpoint pattern
  crit: notable
  conf: 0.85
  size_max: 5000
  any:
    - id: exploit-endpoint-url
    - id: exploit-endpoint-file
    - id: exploit-endpoint-rpc
  unless:
  - type: raw
    regex: fastapi|tutorial
- id: subprocess-shell-user-input
  desc: subprocess shell with user input
  crit: suspicious
  conf: 0.75
  any:
    - id: subprocess-shell-user-input-run-call
    - id: subprocess-shell-user-input-popen
- id: for-loop-iteration
  desc: For loop over network targets
  crit: notable
  conf: 0.4
  any:
    - id: for-loop-iteration-1
    - id: for-loop-iteration-2
- id: ip-list-var
  desc: IP list variable naming pattern
  crit: notable
  conf: 0.5
  any:
  - id: ip-list-word
  - id: targets-word
- id: threaded-requests
  desc: Multi-threaded network requests
  crit: notable
  conf: 0.6
  any:
  - id: threading-thread
  - id: threading-dot-start
- id: http-post
  desc: HTTP POST method usage
  crit: notable
  conf: 0.7
  any:
  - id: micro-behaviors/communications/http/lib/requests::requests-post
  - id: micro-behaviors/communications/http/lib/httpx::httpx-post
- id: ssl-disabled
  desc: SSL certificate verification disabled
  crit: suspicious
  conf: 0.8
  all:
  - id: http-post
  any:
  - id: ssl-verify-false
  - id: ssl-verify-ssl-false
  - id: ssl-insecure-warning
- id: mass-exploiter
  desc: Mass exploitation tool (IP list)
  crit: suspicious
  conf: 0.95
  attack: T1210
  mbc: B0030
  all:
  - id: http-post
  any:
  - id: ip-list-read
  - id: cve-reference
- id: file-upload-exploit
  desc: File upload exploitation tool
  crit: suspicious
  conf: 0.9
  attack: T1210
  all:
  - id: files-dict
  - id: file-open
  - id: http-post
