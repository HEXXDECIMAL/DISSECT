defaults:
  crit: suspicious
  attack: T1071.001
  mbc: E1105
  for:
    - python

traits:
  - id: gitpython-import
    desc: GitPython import
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: gitpython

  - id: git-module-import
    desc: Git module import
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: git

  - id: git-clone-url
    desc: Git clone with URL
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "git\\.Git.{0,50}clone|clone[_(].{0,30}github\\.com"

  - id: git-clone-in-setup
    desc: Git clone during setup
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "install.{2,50}clone|clone.{2,50}install|setup.{2,50}clone"

  - id: cmdclass-custom-install
    desc: Custom install command class
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: "cmdclass.{0,50}install|CustomInstallCommand"

  - id: install-hook-execution
    desc: Install hook execution
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "class.{0,50}install.{0,50}run|def run.{0,50}install"

  - id: obfuscated-repo-prefix
    desc: Obfuscated repository name prefix
    crit: notable
    conf: 0.7
    if: { type: string, regex: '\\b(?:not|un|dis|anti)[-_a-z0-9]{0,12}' }

  - id: obfuscated-repo-suffix-grabber
    desc: Obfuscated repository name suffix (grabber)
    crit: notable
    conf: 0.7
    if: { id: micro-behaviors/data/text/malware::grabber-word }

  - id: obfuscated-repo-suffix-logger
    desc: Obfuscated repository name suffix (logger)
    crit: notable
    conf: 0.7
    if: { type: raw, regex: '(?i)(github\.com|gitlab\.com).{0,80}logger' }

  - id: obfuscated-repo-suffix-stealer
    desc: Obfuscated repository name suffix (stealer)
    crit: notable
    conf: 0.7
    if: { id: micro-behaviors/data/text/malware::stealer-word }

  - id: obfuscated-repo-suffix-malware
    desc: Obfuscated repository name suffix (malware)
    crit: notable
    conf: 0.7
    if: { type: string, substr: 'malware' }

composite_rules:
  - id: obfuscated-repo-name-1
    desc: Obfuscated repo (grabber/logger)
    crit: suspicious
    conf: 0.7
    all:
      - id: obfuscated-repo-prefix
    any:
      - id: obfuscated-repo-suffix-grabber
      - id: obfuscated-repo-suffix-logger

  - id: obfuscated-repo-name-2
    desc: Obfuscated repo (stealer/malware)
    crit: suspicious
    conf: 0.7
    all:
      - id: obfuscated-repo-prefix
    any:
      - id: obfuscated-repo-suffix-stealer
      - id: obfuscated-repo-suffix-malware

  - id: obfuscated-repo-name
    desc: Obfuscated repository name
    crit: suspicious
    conf: 0.7
    any:
      - id: obfuscated-repo-name-1
      - id: obfuscated-repo-name-2

  - id: gitpython-malicious-clone
    desc: GitPython malicious cloning
    crit: suspicious
    conf: 0.9
    attack: T1105
    for:
      - python
    needs: 2
    any:
      - id: git-clone-url
      - id: git-clone-in-setup
      - id: micro-behaviors/data/text/malware::suspicious-repo-name
    all:
      - id: gitpython-import

  - id: supply-chain-gitclone
    desc: Supply chain via git clone
    crit: suspicious
    conf: 0.95
    attack: T1071.001
    mbc: E1105
    platforms:
      - all
    needs: 2
    any:
      - id: gitpython-malicious-clone
      - id: cmdclass-custom-install
      - id: install-hook-execution
