# PyPI Typosquatting Detection
# Detects malware using typosquatted PyPI domains
# ATT&CK: T1036.005 (Masquerading), T1071.001 (Web Protocols)
# MBC: B0030 (C2 Communication)

defaults:
  crit: hostile
  attack: "T1036.005"
  mbc: "B0030"
  for: [python, shell]

traits:
  # === PyPI Typosquatting ===
  - id: pypi-online-typosquat
    desc: PyPI typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "pypi\\.online"

  - id: pypi-typosquat-pattern
    desc: PyPI typosquat pattern
    crit: suspicious
    conf: 0.90
    if:
      type: string
      regex: "pypi[0-9]\\.|pipy\\.|pipi\\.|ppyi\\."

  # === Fake Package Servers ===
  - id: fake-pypi-server
    desc: Fake package repository server
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "(pypi\\.(online|shop|xyz|top)|python-packages|pip-install)"

  # === Cloud.php Pattern (common in these attacks) ===
  - id: cloud-php-endpoint
    desc: Cloud.php payload endpoint
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "cloud\\.php\\?type="

  # === oshelper Marker ===
  - id: oshelper-filename
    desc: oshelper malware marker
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: "oshelper"

  - id: oshelper-session-cookie
    desc: oshelper session cookie
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "oshelper_session"

composite_rules:
  # === PyPI Typosquat Attack ===
  - id: pypi-typosquat-attack
    desc: PyPI typosquatting attack
    crit: suspicious
    conf: 0.98
    attack: "T1036.005"
    for: [python, shell]
    any:
      - id: pypi-online-typosquat
      - id: pypi-typosquat-pattern

  - id: fake-pypi-downloader
    desc: Fake PyPI payload downloader
    crit: hostile
    conf: 0.96
    attack: "T1071.001"
    mbc: "E1105"
    platforms: [all]
    needs: 2
    any:
      - id: cloud-php-endpoint
      - id: oshelper-filename
      - id: oshelper-session-cookie
    all:
      - id: pypi-typosquat-attack
