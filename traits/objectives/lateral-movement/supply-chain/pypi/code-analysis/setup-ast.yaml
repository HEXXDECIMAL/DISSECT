# Setup.py AST Pattern Detection
# Uses AST patterns to detect malicious setup.py structures
# ATT&CK: T1195.001 (Supply Chain)

defaults:
  crit: suspicious
  attack: "T1195.001"
  for: [python]

traits:
  # === Custom Install Class Detection ===
  - id: custom-install-inherit
    desc: Custom install inherits install
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "class.{0,50}\\(install\\):"

  # === cmdclass with custom install ===
  - id: ast-cmdclass-custom
    desc: cmdclass custom install
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "cmdclass.{0,50}install.{0,50}Custom"

  # === Pre-install function call ===
  - id: ast-preinstall-call
    desc: Pre-install function execution
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      exact: "pre_install()"

  # === AST Pattern: subprocess in setup ===
  - id: ast-subprocess-in-setup
    desc: Subprocess call in setup
    crit: suspicious
    conf: 0.85
    if:
      type: ast
      kind: call
      exact: "subprocess\\.(run|call|Popen)"

  # === AST Pattern: Import in install class ===
  - id: ast-import-in-install
    desc: Import inside install class
    crit: suspicious
    conf: 0.80
    if:
      type: ast
      kind: import
      exact: "import.{0,50}subprocess|from.{0,50}subprocess"

composite_rules:
  # === Malicious Setup.py Detection ===
  - id: malicious-setup-install
    desc: Malicious setup.py install hook
    crit: suspicious
    conf: 0.92
    attack: "T1195.001"
    for: [python]
    needs: 2
    any:
      - id: custom-install-inherit
      - id: ast-cmdclass-custom
      - id: ast-preinstall-call

  - id: setup-py-backdoor
    desc: Setup.py backdoor execution
    crit: hostile
    conf: 0.95
    attack: "T1195.001"
    mbc: "E1059"
    platforms: [all]
    all:
      - id: malicious-setup-install
      - id: ast-subprocess-in-setup
