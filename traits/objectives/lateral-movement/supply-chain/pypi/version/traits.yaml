# Version Field Patterns
# Suspicious version numbers in PyPI packages

defaults:
  crit: notable
  attack: "T1195.002"
  mbc: "F0004"
  for: [all]

traits:
  - id: suspicious-version-pattern
    desc: Suspicious version number
    crit: suspicious
    conf: 0.55
    if:
      type: string
      regex: "version.{0,50}=.{0,50}['\"]0\\.[0-9]{1,2}['\"]"

  - id: pkginfo-lowest-version
    desc: PKG-INFO with lowest possible version
    crit: notable
    conf: 0.65
    if:
      type: kv
      path: version
      regex: "^0\\.0(?:\\.[0-9]+)?$"

  - id: depconf-high-version-1
    desc: PKG version (100-999)
    if:
      type: kv
      path: version
      regex: "^(?:[1-9][0-9]{2})\\."

  - id: depconf-high-version-2
    desc: PKG version (1000+)
    if:
      type: kv
      path: version
      regex: "^(?:[1-9][0-9]{3,})\\."

  - id: setup-py-high-version
    desc: setup.py with abnormally high version number
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    if:
      type: raw
      regex: "(?:^|[\\s(,])version.{0,30}=.{0,30}['\"](?:[1-9][0-9]{2}|[1-9][0-9]{3,})\\."

  - id: pkginfo-dev-version-1
    desc: PKG-INFO (dev/alpha/beta)
    if:
      type: kv
      path: version
      regex: "(?:dev|alpha|beta)"
      case_insensitive: true

  - id: pkginfo-dev-version-2
    desc: PKG-INFO (rc/pre/post)
    if:
      type: kv
      path: version
      regex: "(?:\\brc\\d|pre|post)"
      case_insensitive: true

  - id: pkginfo-inflated-version
    desc: PKG-INFO with inflated version number
    crit: notable
    conf: 0.75
    attack: "T1195.002"
    if:
      type: kv
      path: version
      regex: "^(?:[5-9]|[1-9][0-9]+)\\."

  - id: pyproject-inflated-version
    desc: pyproject.toml with inflated version number
    crit: notable
    conf: 0.75
    attack: "T1195.002"
    if:
      type: kv
      path: "project.version"
      regex: "^(?:[5-9]|[1-9][0-9]+)\\."

composite_rules:
  - id: depconf-high-version
    desc: PKG-INFO version with abnormally high major number
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    any:
      - id: depconf-high-version-1
      - id: depconf-high-version-2

  - id: pkginfo-dev-version
    desc: PKG-INFO with development version string
    crit: notable
    conf: 0.80
    any:
      - id: pkginfo-dev-version-1
      - id: pkginfo-dev-version-2
