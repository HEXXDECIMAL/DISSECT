defaults:
  for:
  - javascript
  - typescript
  attack: T1195.002
traits:
- id: child-process-exec
  desc: child_process execution/spawn call
  crit: notable
  conf: 0.75
  if:
    type: string
    regex: child_process\.(exec|spawn|execSync)
- id: vm-run-context
  desc: vm.runInContext call
  crit: notable
  conf: 0.8
  if:
    type: string
    regex: vm\.runInContext
- id: buffer-from-b64
  desc: Buffer.from with large base64
  crit: suspicious
  conf: 0.85
  if:
    type: string
    regex: Buffer\.from\(['"][A-Za-z0-9+/=]{100,}['"]
- id: atob-large
  desc: atob with large base64
  crit: suspicious
  conf: 0.85
  if:
    type: string
    regex: atob\(['"][A-Za-z0-9+/=]{100,}['"]
- id: hex-escape-dense
  desc: Dense hex escape sequences
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: \\x[0-9a-f]{2}\\x[0-9a-f]{2}\\x[0-9a-f]{2}
    count_min: 20
- id: telegram-bot-api
  desc: Telegram bot API URL
  crit: suspicious
  conf: 0.9
  for:
  - javascript
  - typescript
  - ruby
  if:
    type: string
    regex: api\.telegram\.org/bot
- id: chrome-windows-userdata
  desc: Chrome Windows User Data path
  crit: notable
  conf: 0.85
  if:
    type: string
    substr: Local/Google/Chrome/User Data
- id: chrome-appdata
  desc: Chrome AppData path
  crit: notable
  conf: 0.85
  if:
    type: string
    substr: AppData/Local/Google/Chrome
- id: chrome-linux-config
  desc: Chrome Linux config path
  crit: notable
  conf: 0.85
  if:
    type: string
    substr: .config/google-chrome
- id: chrome-macos-support
  desc: Chrome macOS Application Support path
  crit: notable
  conf: 0.85
  if:
    type: string
    substr: Application Support/Google/Chrome
- id: firefox-profiles
  desc: Firefox profiles path
  crit: notable
  conf: 0.85
  if:
    type: string
    substr: .mozilla/firefox/profiles
- id: login-data-file
  desc: Browser Login Data file
  crit: notable
  conf: 0.9
  if:
    type: string
    regex: cookies\.sqlite|logins\.json
- id: scripts-preinstall-pipe-1
  desc: preinstall pipe (curl/wget with |/;/&&)
  crit: suspicious
  conf: 0.9
  if:
    type: kv
    path: scripts.preinstall
    regex: (curl|wget).{0,50}(\||;|&&)
- id: scripts-preinstall-pipe-2
  desc: preinstall pipe (executors node/sh/bash/eval)
  crit: notable
  conf: 0.75
  if:
    type: kv
    path: scripts.preinstall
    regex: (node|sh|bash|eval)
- id: scripts-postinstall-pipe-1
  desc: postinstall pipe (curl/wget with |/;/&&)
  crit: suspicious
  conf: 0.9
  if:
    type: kv
    path: scripts.postinstall
    regex: (curl|wget).{0,50}(\||;|&&)
- id: scripts-postinstall-pipe-2
  desc: postinstall pipe (executors node/sh/bash/eval)
  crit: notable
  conf: 0.75
  if:
    type: kv
    path: scripts.postinstall
    regex: (node|sh|bash|eval)
- id: scripts-preinstall-node-e
  desc: preinstall node -e with URL
  crit: suspicious
  conf: 0.95
  for:
  - package.json
  if:
    type: kv
    path: scripts.preinstall
    regex: node\s+-e\s+['"].{0,100}https?://
- id: scripts-postinstall-node-e
  desc: postinstall node -e with URL
  crit: suspicious
  conf: 0.95
  for:
  - package.json
  if:
    type: kv
    path: scripts.postinstall
    regex: node\s+-e\s+['"].{0,100}https?://
- id: scripts-preinstall-shell-1
  desc: preinstall runs shell command (network)
  crit: notable
  conf: 0.7
  if:
    type: kv
    path: scripts.preinstall
    regex: \b(curl|wget)\b
- id: scripts-preinstall-shell-2
  desc: preinstall runs shell command (interpreters)
  crit: notable
  conf: 0.6
  if:
    type: kv
    path: scripts.preinstall
    regex: \b(sh|bash|powershell)\b
- id: scripts-postinstall-shell-1
  desc: postinstall runs shell command (network)
  crit: notable
  conf: 0.7
  if:
    type: kv
    path: scripts.postinstall
    regex: \b(curl|wget)\b
- id: scripts-postinstall-shell-2
  desc: postinstall runs shell command (interpreters)
  crit: notable
  conf: 0.5
  if:
    type: kv
    path: scripts.postinstall
    regex: \b(sh|bash|powershell)\b
composite_rules:
- id: scripts-preinstall-pipe
  desc: preinstall download-execute pipe
  crit: suspicious
  conf: 0.95
  for:
  - package.json
  all:
    - id: scripts-preinstall-pipe-1
    - id: scripts-preinstall-pipe-2
- id: scripts-postinstall-pipe
  desc: postinstall download-execute pipe
  crit: suspicious
  conf: 0.95
  for:
  - package.json
  all:
    - id: scripts-postinstall-pipe-1
    - id: scripts-postinstall-pipe-2
- id: scripts-preinstall-shell
  desc: preinstall runs shell command
  crit: suspicious
  conf: 0.85
  for:
  - package.json
  any:
    - id: scripts-preinstall-shell-1
    - id: scripts-preinstall-shell-2
- id: scripts-postinstall-shell
  desc: postinstall runs shell command
  crit: suspicious
  conf: 0.85
  for:
  - package.json
  any:
    - id: scripts-postinstall-shell-1
    - id: scripts-postinstall-shell-2
- id: http-client-imports
  desc: HTTP client imports
  crit: notable
  conf: 0.5
  any:
  - id: metadata/import/npm/axios
  - id: metadata/import/npm/node-fetch
  - id: metadata/import/npm/got
  - id: metadata/import/npm/request
  - id: objectives/lateral-movement/supply-chain/npm/behavior::require-https
- id: fs-imports
  desc: File system imports
  crit: notable
  conf: 0.5
  any:
  - id: metadata/import/npm/fs
  - id: metadata/import/npm/fs-extra
  - id: objectives/lateral-movement/supply-chain/npm/behavior::require-fs
- id: child-process-imports
  desc: Child process execution imports
  crit: notable
  conf: 0.7
  any:
  - id: metadata/import/npm/child_process
  - id: objectives/lateral-movement/supply-chain/npm/behavior::require-child-process
  - id: child-process-exec
- id: dynamic-eval-imports
  desc: Dynamic code evaluation patterns
  crit: notable
  conf: 0.75
  any:
  - id: objectives/execution/interpreter/eval/dynamic::eval-call-js
  - id: vm-run-context
- id: install-hook-exec
  desc: Install hook with command execution
  crit: suspicious
  conf: 0.85
  for:
  - package.json
  any:
  - id: scripts-preinstall-shell
  - id: scripts-postinstall-shell
- id: obfuscated-payload
  desc: Obfuscated payload in package
  crit: suspicious
  conf: 0.85
  any:
  - id: buffer-from-b64
  - id: atob-large
  - id: hex-escape-dense
- id: network-eval-exec-chain
  desc: Network fetch with eval and exec
  crit: suspicious
  conf: 0.9
  all:
  - id: http-client-imports
  - id: dynamic-eval-imports
  - id: child-process-imports
- id: webhook-exfil-pattern
  desc: Webhook with file system access
  crit: suspicious
  conf: 0.85
  all:
  - id: fs-imports
  any:
  - id: objectives/exfiltration/channel/webhook::discord-webhook
  - id: telegram-bot-api
- id: browser-data-access
  desc: Accesses browser data directories
  crit: suspicious
  conf: 0.9
  any:
  - id: chrome-windows-userdata
  - id: chrome-appdata
  - id: chrome-linux-config
  - id: chrome-macos-support
  - id: firefox-profiles
- id: install-hook-dropper
  desc: Install hook downloads and executes payload
  crit: hostile
  conf: 0.95
  mbc: B0024
  for:
  - package.json
  any:
  - id: scripts-preinstall-pipe
  - id: scripts-postinstall-pipe
  - id: scripts-preinstall-node-e
  - id: scripts-postinstall-node-e
- id: browser-credential-stealer
  desc: Steals browser credentials
  crit: hostile
  conf: 0.95
  mbc: E1555
  attack: T1555.003
  all:
  - id: browser-data-access
  - id: fs-imports
  - id: http-client-imports
  any:
  - id: login-data-file
  - id: micro-behaviors/fs/path/sensitive/browser::leveldb-ref
