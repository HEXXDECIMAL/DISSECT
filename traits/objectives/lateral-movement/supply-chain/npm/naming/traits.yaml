# NPM Package Name Anomaly Patterns
# Detects suspicious package naming patterns in package.json
# ATT&CK: T1195.002 (Supply Chain Compromise)
# These patterns indicate typosquatting, name confusion, or malicious intent

defaults:
  for: [package.json]

traits:
  # === Package name contains credential theft keywords ===

  - id: name-dump-keyword
    desc: Package name contains "dump" keyword
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: '"name":\s*".{0,120}dump.{0,120}"'
      case_insensitive: true

  - id: name-grab-keyword
    desc: Package name contains "grab" keyword
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: '"name":\s*".{0,120}grab(ber)?.{0,120}"'
      case_insensitive: true

  - id: name-steal-keyword
    desc: Package name contains "steal" keyword
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: '"name":\s*".{0,120}steal(er)?.{0,120}"'
      case_insensitive: true

  - id: name-hack-keyword
    desc: Package name contains "hack" keyword
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: '"name":\s*".{0,120}hack(er|ing)?.{0,120}"'
      case_insensitive: true

  - id: name-crack-keyword
    desc: Package name contains "crack" keyword
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: '"name":\s*".{0,120}crack(er)?.{0,120}"'
      case_insensitive: true

  - id: name-token-keyword
    desc: Package name contains "token" keyword
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}token.{0,120}"'
      case_insensitive: true

  - id: name-logger-keyword
    desc: Package name contains "logger" keyword
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}logger.{0,120}"'
      case_insensitive: true

  - id: name-exfil-keyword
    desc: Package name contains "exfil" keyword
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: '"name":\s*".{0,120}exfil.{0,120}"'
      case_insensitive: true

  # === Package name contains target application names ===

  - id: name-discord-target
    desc: Package name contains "discord"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}discord.{0,120}"'
      case_insensitive: true

  - id: name-telegram-target
    desc: Package name contains "telegram"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}telegram.{0,120}"'
      case_insensitive: true

  - id: name-slack-target
    desc: Package name contains "slack"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}slack.{0,120}"'
      case_insensitive: true

  - id: name-wallet-target
    desc: Package name contains "wallet"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}wallet.{0,120}"'
      case_insensitive: true

  - id: name-crypto-target
    desc: Package name contains crypto
    crit: notable
    conf: 0.4
    if:
      type: raw
      regex: '"name":\s*".{0,120}crypto.{0,120}"'
      case_insensitive: true

  - id: name-metamask-target
    desc: Package name contains "metamask"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}metamask.{0,120}"'
      case_insensitive: true

  - id: name-browser-target
    desc: Package name contains "browser"
    crit: notable
    conf: 0.4
    if:
      type: raw
      regex: '"name":\s*".{0,120}browser.{0,120}"'
      case_insensitive: true

  - id: name-password-target
    desc: Package name contains "password"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*".{0,120}pass(word)?.{0,120}"'
      case_insensitive: true

  # === Package name prefixes legitimate tool names (typosquatting) ===

  - id: name-mysql-prefix
    desc: Package name prefixes "mysql"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*"mysql-.{0,120}"'
      case_insensitive: true

  - id: name-express-prefix
    desc: Package name prefixes "express"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*"express-.{0,120}"'
      case_insensitive: true

  - id: name-react-prefix
    desc: Package name prefixes "react"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*"react-.{0,120}"'
      case_insensitive: true

  - id: name-vue-prefix
    desc: Package name prefixes "vue"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*"vue-.{0,120}"'
      case_insensitive: true

  - id: name-node-prefix
    desc: Package name prefixes "node"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"name":\s*"node-.{0,120}"'
      case_insensitive: true

  # === Minimal metadata indicators ===

  # === Keyword-based detection ===

  - id: keyword-dump
    desc: Keywords contain "dump"
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: '"keywords":\s*\[[^\]]{0,300}".{0,120}dump.{0,120}"'
      case_insensitive: true

  - id: keyword-grab
    desc: Keywords contain "grab"
    crit: notable
    conf: 0.7
    if:
      type: raw
      regex: '"keywords":\s*\[[^\]]{0,300}".{0,120}grab.{0,120}"'
      case_insensitive: true

  - id: keyword-steal
    desc: Keywords contain "steal"
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: '"keywords":\s*\[[^\]]{0,300}".{0,120}steal.{0,120}"'
      case_insensitive: true

  - id: keyword-token
    desc: Keywords contain "token"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"keywords":\s*\[[^\]]{0,300}".{0,120}token.{0,120}"'
      case_insensitive: true

  - id: keyword-discord
    desc: Keywords contain "discord"
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"keywords":\s*\[[^\]]{0,300}".{0,120}discord.{0,120}"'
      case_insensitive: true

composite_rules:
  # === Credential theft keywords in name ===

  - id: name-has-theft-keyword
    desc: Package name contains theft-related keyword
    crit: notable
    conf: 0.75
    any:
      - id: name-dump-keyword
      - id: name-grab-keyword
      - id: name-steal-keyword
      - id: name-hack-keyword
      - id: name-crack-keyword
      - id: name-exfil-keyword

  # === Target application in name ===

  - id: name-has-target-app
    desc: Package name contains target application
    crit: notable
    conf: 0.5
    any:
      - id: name-discord-target
      - id: name-telegram-target
      - id: name-slack-target
      - id: name-wallet-target
      - id: name-metamask-target
      - id: name-password-target

  # === Theft keyword + target app in name (SUSPICIOUS) ===
  # Pattern: "mysql-dumpdiscord", "grab-telegram-token", etc.

  - id: name-theft-target-combo
    desc: Package name combines theft keyword with target app
    crit: suspicious
    conf: 0.9
    all:
      - id: name-has-theft-keyword
      - id: name-has-target-app

  # === Keywords contain suspicious terms ===

  - id: keyword-theft-patterns
    desc: Keywords contain theft-related terms
    crit: notable
    conf: 0.75
    any:
      - id: keyword-dump
      - id: keyword-grab
      - id: keyword-steal

  # === Keyword theft + target combo ===

  - id: keyword-theft-target-combo
    desc: Keywords combine theft and target terms
    crit: suspicious
    conf: 0.85
    all:
      - id: keyword-theft-patterns
      - id: keyword-discord
      - id: keyword-token

  # === Suspicious name without metadata ===
  # Malicious packages often have minimal metadata

  - id: theft-name-no-repo
    desc: Theft keyword in name without repository
    crit: suspicious
    conf: 0.85
    all:
      - id: name-has-theft-keyword
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::npm-has-repository

  - id: theft-name-no-bugs
    desc: Theft keyword in name without bugs URL
    crit: suspicious
    conf: 0.85
    all:
      - id: name-has-theft-keyword
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::has-bugs-url

  - id: theft-name-no-homepage
    desc: Theft keyword in name without homepage
    crit: suspicious
    conf: 0.85
    all:
      - id: name-has-theft-keyword
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::has-homepage

  # === Credential stealer package name pattern (SUSPICIOUS) ===
  # Complexity: 3 (all) = 3 -> suspicious (needs 4 for hostile)

  - id: credential-stealer-naming
    desc: Package naming suggests credential stealer
    crit: suspicious
    conf: 0.9
    attack: "T1195.002"
    all:
      - id: name-theft-target-combo
      - id: keyword-discord
      - id: keyword-token
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::npm-has-repository
