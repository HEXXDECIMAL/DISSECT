defaults:
  for:
  - javascript
traits:
- id: license-file-reference
  desc: LICENSE file path reference
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: '[''"`]LICENSE[''"`]|/LICENSE[''"`]|LICENSE[''"`]\)'
- id: readme-file-reference
  desc: README file path reference
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: '[''"`]README(?:\.md)?[''"`]|/README(?:\.md)?[''"`]'
- id: changelog-file-reference
  desc: CHANGELOG file path reference
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: '[''"`]CHANGELOG(?:\.md)?[''"`]|/CHANGELOG(?:\.md)?[''"`]'
- id: txt-file-reference
  desc: .txt file path reference
  crit: notable
  conf: 0.5
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: '[''"`][^''"`]{1,120}\.txt[''"`]'
- id: dat-file-reference
  desc: .dat file path reference
  crit: notable
  conf: 0.5
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: '[''"`][^''"`]{1,120}\.dat[''"`]'
- id: eval-function-call-arg
  desc: eval() with function call
  crit: suspicious
  conf: 0.9
  attack: T1027
  mbc: B0032
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: eval\s*\(\s*[a-zA-Z_$][a-zA-Z0-9_$]*\s*\(
  downgrade:
    any:
    - id: metadata/library/syntaxhighlighter::syntaxhighlighter-header-url
    - id: metadata/library/syntaxhighlighter::syntaxhighlighter-core
- id: eval-method-call-arg
  desc: eval() with method call
  crit: suspicious
  conf: 0.9
  attack: T1027
  mbc: B0032
  for:
  - javascript
  - typescript
  if:
    type: raw
    regex: eval\s*\(\s*[a-zA-Z_$][a-zA-Z0-9_$]*\.[a-zA-Z_$][a-zA-Z0-9_$]*\s*\(
- id: local-lib-require
  desc: Local lib module require
  crit: notable
  conf: 0.5
  for:
  - javascript
  if:
    type: raw
    regex: require\s*\(\s*['"`]\./[a-zA-Z0-9_-]+['"`]\s*\)
- id: fs-readfile-call
  desc: fs.readFile call
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  if:
    type: symbol
    regex: (?:^|\.)readFile$
- id: fs-readfilesync-call
  desc: fs.readFileSync call
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  if:
    type: symbol
    regex: (?:^|\.)readFileSync$
- id: local-parse-require
  desc: Local parser module require
  crit: notable
  conf: 0.7
  for:
  - javascript
  if:
    type: raw
    regex: require\(['"`]\./(?:parse|parser|decode|decrypt|transform|convert)['"`]\)
composite_rules:
- id: non-code-file-reference
  desc: Reference to non-code file
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  any:
  - id: license-file-reference
  - id: readme-file-reference
  - id: changelog-file-reference
  - id: txt-file-reference
  - id: dat-file-reference
- id: eval-processed-arg
  desc: eval with processed/transformed argument
  crit: suspicious
  conf: 0.9
  attack: T1027
  mbc: B0032
  for:
  - javascript
  - typescript
  any:
  - id: eval-function-call-arg
  - id: eval-method-call-arg
  downgrade:
    any:
    - id: metadata/library/syntaxhighlighter::syntaxhighlighter-header-url
    - id: metadata/library/syntaxhighlighter::syntaxhighlighter-core
- id: file-read-operation
  desc: File read operation
  crit: notable
  conf: 0.6
  for:
  - javascript
  - typescript
  any:
  - id: fs-readfile-call
  - id: fs-readfilesync-call
- id: hidden-payload-eval
  desc: Hidden payload in non-code file executed via eval
  crit: hostile
  conf: 0.95
  attack: T1195.002
  mbc: B0024
  for:
  - javascript
  all:
  - id: file-read-operation
  - id: eval-processed-arg
  - id: objectives/lateral-movement/supply-chain/npm/behavior::require-fs
  any:
  - id: non-code-file-reference
  - id: local-parse-require
- id: suspicious-eval-transform
  desc: Suspicious eval with data transformation
  crit: suspicious
  conf: 0.85
  attack: T1027
  mbc: B0032
  for:
  - javascript
  all:
  - id: eval-processed-arg
  - id: objectives/lateral-movement/supply-chain/npm/behavior::small-file-5k
