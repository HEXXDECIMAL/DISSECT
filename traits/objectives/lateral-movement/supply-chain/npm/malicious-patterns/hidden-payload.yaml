defaults:
  for:
  - javascript
  - typescript
  attack: T1195.002
traits:
  - id: eval-function-call-arg
    desc: eval() with dynamic argument
    crit: notable
    conf: 0.75
    if:
      type: ast
      query: "(call_expression\n  function: (identifier) @fn\n  arguments: (arguments\n\
          \    (identifier))\n (#eq? @fn \"eval\"))\n"
  - id: hex-string-array
    desc: Array of hex strings (potential shellcode)
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: '\[\s*["'']0x[0-9a-f]{2}["''](\s*,\s*["'']0x[0-9a-f]{2}["'']){10,}\s*\]'
  - id: join-hex-array
    desc: Joining hex array into string
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: \.join\(["'']["'']\).{0,50}0x[0-9a-f]{2}
  - id: char-code-at-loop
    desc: Iterating with charCodeAt (decoding loop)
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: \.charCodeAt\(.{0,50}\).{0,100}\^
  - id: hidden-script-ref
    desc: References hidden .js file
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: '["'']\./\.[a-z0-9_-]+\.js["'']'
  - id: fs-read-hidden
    desc: Reads hidden file from disk
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: (readFile|readFileSync)\s*\(.{0,120}['"]\./\..{1,50}['"]
  - id: eval-hex-decode
    desc: eval() of hex-decoded buffer
    crit: suspicious
    conf: 0.98
    if:
      type: string
      regex: eval\(Buffer\.from\(.{1,120},['']hex['']\)\.toString\(\)\)
  - id: process-env-home
    desc: Accesses process.env.HOME
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: process.env.HOME
  - id: process-env-username
    desc: Accesses process.env.USERNAME
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: process.env.USERNAME
  - id: path-join-hidden
    desc: path.join with hidden file path
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: path\.join\(.{1,50},['"]\..{1,50}['"]\)
  - id: b64-to-buffer
    desc: base64 string to Buffer
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: Buffer\.from\(.{1,220},['']base64['']\)
  - id: buffer-slice-magic
    desc: Buffer.slice with magic offsets
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: \.slice\(\d{1,4},\s*\d{1,4}\)
  - id: payload-transform-loop
    desc: XOR/Transform loop on data buffer
    crit: notable
    conf: 0.85
    if:
      type: yara
      source: "rule xor_transform_loop {\n  strings:\n    $xor = /\\^/ ascii\n    $loop\
        \ = /(for|while)\\s*\\(/ ascii\n    $index = /\\[i\\]/ ascii\n    $buffer =\
        \ \"Buffer\" ascii\n  condition:\n    all of them\n}\n"
  - id: obfuscated-eval-yara
    desc: Obfuscated eval via YARA
    crit: suspicious
    conf: 0.95
    if:
      type: yara
      source: "rule obfuscated_eval {\n  strings:\n    $eval = \"eval(\" ascii\n   \
        \ $b64 = \"base64\" ascii\n    $hex = \"hex\" ascii\n    $toString = \".toString()\"\
        \ ascii\n    $buffer = \"Buffer.from\" ascii\n  condition:\n    $eval and $buffer\n\
        \    and ($b64 or $hex) and $toString\n}\n"
  - id: malicious-electron-inject
    desc: Trojanized Electron app.asar injection
    crit: suspicious
    conf: 0.98
    attack: T1554
    mbc: B0024
    if:
      type: string
      substr: 'require("electron").app.on("ready"'
  - id: install-hook-discord-exfil
    desc: Install hook Discord webhook exfil
    crit: suspicious
    conf: 0.98
    for:
    - package.json
    if:
      type: kv
      path: scripts.preinstall
      regex: (curl|wget).{0,100}discord\.com/api/webhooks
composite_rules:
  - id: hidden-payload-eval
    desc: eval() of payload from hidden file
    crit: hostile
    conf: 0.95
    all:
    - id: objectives/lateral-movement/supply-chain/npm/behavior::require-fs
    - id: fs-read-hidden
    - id: eval-function-call-arg
  - id: hex-payload-injection
    desc: Hex-encoded payload injection
    crit: suspicious
    conf: 0.9
    all:
    - id: hex-string-array
    - id: join-hex-array
    - id: eval-function-call-arg
  - id: decoding-loop-eval
    desc: eval() following decoding loop
    crit: hostile
    conf: 0.95
    all:
    - id: char-code-at-loop
    - id: eval-function-call-arg
  - id: home-dir-exfil-prep
    desc: Accesses home directory for exfiltration
    crit: suspicious
    conf: 0.8
    any:
    - id: process-env-home
    - id: objectives/persistence/env-vars/profile::env-appdata
    - id: objectives/discovery/host/system::js-os-homedir
  - id: suspicious-eval-transform
    desc: eval() following data transformation
    crit: suspicious
    conf: 0.9
    all:
    - id: objectives/lateral-movement/supply-chain/npm/behavior::small-file-5k
    - id: payload-transform-loop
    - id: eval-function-call-arg
  - id: encoded-eval-chain
    desc: Encoded data decoded then executed
    crit: hostile
    conf: 0.95
    any:
    - id: eval-hex-decode
    - id: obfuscated-eval-yara
  - id: electron-trojan-injection
    desc: Electron application trojan injection
    crit: hostile
    conf: 0.95
    all:
    - id: malicious-electron-inject
    - id: micro-behaviors/communications/http/post::post
