defaults:
  attack: T1195.002
  for:
  - javascript
  - typescript
traits:
- id: stealer-string
  desc: Stealer module string reference
  crit: notable
  conf: 0.8
  if:
    type: string
    substr: ./stealer
- id: grabber-string
  desc: Grabber module string reference
  crit: notable
  conf: 0.8
  if:
    type: string
    substr: ./grabber
- id: homedir-app-check
  desc: Homedir /app sandbox check
  crit: suspicious
  conf: 0.9
  mbc: B0007
  attack: T1497.001
  if:
    type: string
    regex: homedir\(\)\s*===?\s*['"]/?app['"]
- id: app-path-string
  desc: /app path string (cloud sandbox)
  crit: notable
  conf: 0.5
  if:
    type: string
    exact: /app
- id: postinstall-argv-check
  desc: Check for --postinstall in argv
  crit: suspicious
  conf: 0.9
  mbc: B0024
  if:
    type: string
    regex: process\.argv\.(?:includes|indexOf)\(['"]--postinstall['"]\)
- id: postinstall-flag-string
  desc: --postinstall flag string
  crit: notable
  conf: 0.7
  if:
    type: string
    substr: --postinstall
- id: global-dunder-assignment
  desc: Global __variable assignment
  crit: notable
  conf: 0.75
  mbc: B0024
  if:
    type: string
    regex: global\.__[a-z_]+
    case_insensitive: true
- id: global-postinstall-flag
  desc: Global postinstall state flag
  crit: suspicious
  conf: 0.85
  mbc: B0024
  if:
    type: string
    regex: global\.__[a-z_]*postinstall
    case_insensitive: true
- id: dunder-postinstall-decl
  desc: Dunder postinstall variable declaration
  crit: suspicious
  conf: 0.85
  mbc: B0024
  if:
    type: raw
    regex: __[a-z_]*postinstall
    case_insensitive: true
- id: dunder-token-decl
  desc: Dunder token storage variable
  crit: suspicious
  conf: 0.85
  mbc: E1059
  attack: T1528
  if:
    type: raw
    regex: __[a-z_]*_token\b
    case_insensitive: true
- id: stealer-basename
  desc: File named stealer
  crit: suspicious
  conf: 0.9
  mbc: E1059
  for:
  - javascript
  if:
    type: string
    regex: ^[Ss]tealer\.
- id: grabber-basename
  desc: File named grabber
  crit: suspicious
  conf: 0.9
  mbc: E1059
  for:
  - javascript
  if:
    type: string
    regex: ^grabber\.
    case_insensitive: true
- id: local-stealer-import
  desc: Import from local stealer module
  crit: suspicious
  conf: 0.95
  mbc: E1059
  if:
    type: string
    case_insensitive: true
    regex: from\s+['"]\./(?:stealer|grabber|logger|exfil)['"]|require\(['"]\./(?:stealer|grabber|logger|exfil)['"]\)
composite_rules:
- id: stealer-import
  desc: Local stealer/grabber module import
  crit: suspicious
  conf: 0.9
  any:
  - id: local-stealer-import
  - id: stealer-string
  - id: grabber-string
- id: cloud-sandbox-check
  desc: Cloud environment sandbox detection
  crit: suspicious
  conf: 0.85
  mbc: B0007
  attack: T1497.001
  all:
  - id: objectives/discovery/host/system/hardware-fingerprint::os-homedir-call
  - id: app-path-string
- id: postinstall-abuse
  desc: NPM postinstall hook abuse
  crit: suspicious
  conf: 0.85
  mbc: B0024
  any:
  - id: postinstall-argv-check
  - id: postinstall-flag-string
- id: supply-chain-stealer
  desc: NPM supply chain stealer package
  crit: hostile
  conf: 0.98
  mbc: E1059
  for:
  - javascript
  - typescript
  all:
  - id: stealer-import
  - id: postinstall-abuse
  - id: objectives/discovery/host/system/hardware-fingerprint::os-homedir-call
- id: stealer-sandbox-evasion
  desc: Stealer with sandbox evasion
  crit: hostile
  conf: 0.98
  mbc: B0007
  attack: T1497.001
  for:
  - javascript
  - typescript
  all:
  - id: stealer-import
  - id: cloud-sandbox-check
  - id: micro-traits/process/exit/terminate::process-exit
- id: stealer-declaration
  desc: Stealer module declaration with token storage
  crit: hostile
  conf: 0.95
  mbc: E1059
  attack: T1528
  for:
  - javascript
  - typescript
  all:
  - id: stealer-basename
  - id: dunder-token-decl
  - id: dunder-postinstall-decl
- id: stealer-postinstall-tracking
  desc: Stealer file with postinstall state
  crit: suspicious
  conf: 0.9
  mbc: B0024
  for:
  - javascript
  - typescript
  all:
  - id: stealer-basename
  - id: dunder-postinstall-decl
- id: token-theft-declaration
  desc: Token storage with postinstall tracking
  crit: suspicious
  conf: 0.88
  mbc: E1059
  attack: T1528
  for:
  - javascript
  - typescript
  all:
  - id: dunder-token-decl
  - id: dunder-postinstall-decl
