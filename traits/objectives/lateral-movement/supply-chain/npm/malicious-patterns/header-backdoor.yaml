# Header-Based Remote Code Execution (RCE) Backdoor
# ATT&CK: T1105 (Ingress Tool Transfer), T1059 (Command and Scripting Interpreter)
# MBC: B0022 (Socket-based communication), E1059 (Code Execution)
#
# Pattern: Malicious code reassembles a payload from HTTP headers (often using specific regex)
# and executes it using vm.runInThisContext or similar.

defaults:
  for: [javascript, typescript]

composite_rules:
  - id: npm-header-rce-backdoor
    desc: HTTP Header-based Remote Code Execution Backdoor
    crit: hostile
    conf: 0.98
    attack: "T1105"
    mbc: "B0022"
    all:
      - id: micro-traits/data/manipulation/buffer::offset-write
    needs: 2
    any:
      - id: micro-traits/net/protocol/http::hex-command-regex
      - id: micro-traits/net/protocol/http::header-stringify-scan
      - id: objectives/execution/vm/sandbox::vm-runInThisContext
      - id: objectives/anti-static/obfuscation/encoding/indicators::encoded-node-require
      - id: objectives/anti-static/obfuscation/encoding/indicators::encoded-node-vm
      - id: objectives/anti-static/obfuscation/encoding/indicators::encoded-node-vm-run
      - id: micro-traits/data/manipulation/buffer::buffer-alloc-large
      - id: micro-traits/data/manipulation/buffer::module-exports-buffer-storage
