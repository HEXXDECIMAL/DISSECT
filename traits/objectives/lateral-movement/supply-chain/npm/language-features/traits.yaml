# Modern JavaScript Language Features
# Classes, async/await, generators, proxies, etc.

defaults:
  for: [javascript, typescript]

traits:
  - id: has-class
    desc: Code defines classes
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "^class\\s+[A-Z][a-zA-Z0-9]*|export\\s+class\\s+[A-Z]"

  # Has JSDoc comments
  - id: has-async-await
    desc: Code uses async/await patterns
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "async\\s+function|async\\s*\\(|await\\s+"

  - id: has-promise-new
    desc: Code uses new Promise
    if: { type: string, substr: "new Promise(" }
  - id: has-promise-then
    desc: Code uses .then/catch
    if: { type: string, regex: "\\.(then|catch)\\(" }
  - id: has-promise-methods-1
    desc: Code uses Promise.all/race
    if: { type: string, regex: "Promise\\.(all|race)" }
  - id: has-promise-methods-2
    desc: Code uses Promise.resolve/reject
    if: { type: string, regex: "Promise\\.(resolve|reject)" }

  - id: has-decorators-1
    desc: uses TS/ES decorators (Controller/Injectable/Service)
    if: { type: string, regex: "@(Controller|Injectable|Service)" }
  - id: has-decorators-2
    desc: uses TS/ES decorators (Module/Component/Prop/Watch)
    if: { type: string, regex: "@(Module|Component|Prop|Watch)" }

  # Has dependency injection
  - id: has-error-class
    desc: Code defines custom error classes
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "class\\s+\\w+Error\\s+extends\\s+Error"

  # Has getter/setter
  - id: has-accessors
    desc: Code uses getters/setters
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "\\bget\\s+\\w+\\s*\\(\\)|\\bset\\s+\\w+\\s*\\("

  - id: has-symbols-base
    desc: Code uses Symbol constructor
    if: { type: string, substr: "Symbol(" }
  - id: has-symbols-iter
    desc: Code uses Symbol iterators
    if: { type: string, regex: "Symbol\\.(for|iterator|asyncIterator)" }

  - id: has-weak-collections-map
    desc: Code uses WeakMap
    if: { type: string, substr: "new WeakMap" }
  - id: has-weak-collections-set
    desc: Code uses WeakSet
    if: { type: string, substr: "new WeakSet" }

  # Has Proxy usage
  - id: has-proxy
    desc: Code uses Proxy for metaprogramming
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "new\\s+Proxy\\s*\\("

  # Has generator functions
  - id: has-generators
    desc: Code uses generator functions
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "function\\s*\\*|yield\\s+"

  # Multiple export patterns
  - id: promise-test-call
    desc: promise_test() WPT call
    crit: notable
    conf: 0.95
    if:
      type: string
      substr: "promise_test("

  - id: async-test-call
    desc: async_test() WPT call
    crit: notable
    conf: 0.95
    if:
      type: string
      substr: "async_test("

composite_rules:
  - id: has-promise
    desc: Code uses Promises
    crit: notable
    conf: 0.7
    any:
      - id: has-promise-new
      - id: has-promise-then
      - id: has-promise-methods-1
      - id: has-promise-methods-2

  - id: has-decorators
    desc: Code uses TypeScript/ES decorators
    crit: notable
    conf: 0.85
    any:
      - id: has-decorators-1
      - id: has-decorators-2

  - id: has-symbols
    desc: Code uses Symbol for private
    crit: notable
    conf: 0.85
    any:
      - id: has-symbols-base
      - id: has-symbols-iter

  - id: has-weak-collections
    desc: Code uses WeakMap/WeakSet patterns
    crit: notable
    conf: 0.85
    any:
      - id: has-weak-collections-map
      - id: has-weak-collections-set
