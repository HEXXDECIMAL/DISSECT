# Malicious VSCode Extension Patterns
# Detects high-confidence malicious patterns in VSCode extensions
# These combine multiple indicators to reduce false positives

defaults:
  for: [all]

traits:
  # NOTE: YARA kept for api-usage - requires fullword match on "activate" which
  # DISSECT doesn't support, plus regex patterns for require/import
  - id: api-usage
    desc: Uses VSCode API (extension marker)
    crit: notable
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule vscode_api_usage {
          strings:
            $require = /require\(['"]vscode['"]\)/ ascii
            $import = /from\s+['"]vscode['"]/ ascii
            $namespace = "vscode." ascii
          condition:
            // activate is too common to be a standalone extension marker
            any of them
        }

  # === Atomic indicators for post-install-exec ===
  - id: activate-word
    desc: activate keyword
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      substr: "activate"

  - id: postInstall-word
    desc: postInstall keyword
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      substr: "postInstall"

  - id: exec-pattern
    desc: exec function pattern
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync|Async)?\\("

  # === Atomic indicators for credential-theft ===
  # Removed ssh-dir duplicate - use micro-behaviors/fs/path/sensitive/ssh::keys

  # aws-dir: use objectives/credential-access/cloud/token::aws-config (canonical)

  # Removed npmrc-file duplicate - use objectives/credential-access/environment/secret-access::dot-npmrc

  - id: readFile-pattern
    desc: readFile function pattern
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "read(File|FileSync)"

  # VSCode namespace usage pattern
  - id: vscode-namespace
    desc: Uses VSCode namespace
    crit: notable
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: string
      regex: "vscode\\."

  # Persistence location references
  - id: persistence-location-startup
    desc: References Startup location
    if:
      type: string
      word: "Startup"

  - id: persistence-location-crontab
    desc: References crontab location
    if:
      type: string
      word: "crontab"

  - id: persistence-location-launchd
    desc: References launchd location
    if:
      type: string
      word: "launchd"

  # File write operations
  - id: file-write-ops
    desc: File write or copy operations
    crit: notable
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: string
      regex: "write(File|FileSync)|copy(File|FileSync)"

composite_rules:
  # State helpers
  - id: state-markers
    desc: State management markers (globalState or postInstall)
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    any:
      - id: objectives/lateral-movement/supply-chain/vscode::globalState
      - id: postInstall-word

  # Credential paths
  - id: credential-paths
    desc: Sensitive credential file/directory paths
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    any:
      - id: micro-behaviors/fs/path/sensitive/ssh::keys
      - id: objectives/credential-access/cloud/token::aws-config
      - id: objectives/credential-access/environment/secret-access::dot-npmrc
      - id: metadata/quality/config::dotenv-file

  # Send methods
  - id: send-methods
    desc: HTTP send methods
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    any:
      - id: micro-behaviors/communications/http/post/
      - id: micro-behaviors/communications/http/request/
      - id: micro-behaviors/communications/http/request::axios

  # Post-Install Code Execution
  - id: post-install-exec
    desc: Post-install script execution (dropper pattern)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059"
    for: [javascript, typescript]
    all:
      - id: activate-word
      - id: state-markers
      - id: exec-pattern

  # Extension Credential Theft
  - id: credential-theft
    desc: VSCode extension accessing sensitive credentials
    crit: suspicious
    conf: 0.9
    mbc: "E1519"
    attack: "T1555"
    for: [javascript, typescript]
    all:
      - id: credential-paths
      - id: readFile-pattern
      - id: send-methods

  # Staged Decryption and Execution inside a VSCode Extension
  - id: staged-dropper
    desc: VSCode extension with staged decryption
    crit: suspicious
    conf: 0.99
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: well-known/malware/dropper::js-decrypt-eval
      - id: api-usage
      - id: vscode-namespace

  - id: persistence-locations
    desc: References persistence locations (startup/autorun paths)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    any:
      - id: persistence-location-startup
      - id: persistence-location-crontab
      - id: persistence-location-launchd
      - id: objectives/persist/systemd/service::systemd-keyword

  # Extension Persistence via well-known hooks
  - id: persistence
    desc: Extension establishing persistence
    crit: suspicious
    conf: 0.95
    mbc: "F0011"
    attack: "T1547"
    for: [javascript, typescript]
    all:
      - id: api-usage
      - id: persistence-locations
      - id: file-write-ops
