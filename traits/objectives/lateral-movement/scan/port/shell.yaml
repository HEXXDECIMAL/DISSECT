defaults:
  attack: T1046
  mbc: E1046
  for:
  - shell
traits:
- id: xargs-network-loop
  desc: xargs executing command per line
  crit: suspicious
  conf: 0.85
  if:
    type: raw
    regex: cat\s+\S+\s*\|\s*xargs\s+[^\n]{0,120}-l[^\n]{0,120}\.
- id: xargs-call-script
  desc: xargs executing local script
  crit: notable
  conf: 0.8
  if:
    type: raw
    regex: xargs\s+[^\n]{0,120}\./\.[a-z_]+
- id: pipe-loop-pattern
  desc: Pipe to xargs for iteration
  crit: notable
  conf: 0.7
  if:
    type: raw
    regex: \|\s*xargs\s+[^\n]{0,120}-[a-z]*l
- id: script-loops-ips-while
  desc: Script while-loop over IPs
  crit: notable
  conf: 0.75
  if:
    type: raw
    regex: while\s+read\s+(ip|host|target|addr)
- id: script-loops-ips-for
  desc: Script for-loop over IPs
  crit: notable
  conf: 0.75
  if:
    type: raw
    regex: for\s+(ip|host|target|addr)\s+in
- id: dotfiles-in-script
  desc: References hidden scripts
  crit: notable
  conf: 0.85
  size_max: 5000
  if:
    type: raw
    regex: \./\.\w+|/\.\w+\s
  unless:
    - type: raw
      regex: library|compiler|builtins
- id: script-probes-port-common
  desc: Probes common ports (21/22/23/25)
  crit: notable
  conf: 0.7
  if:
    type: raw
    regex: '(?:-p|port\s+)2[1235]\b'
- id: script-probes-port-web
  desc: Probes web ports (53/80/443)
  crit: notable
  conf: 0.7
  if:
    type: raw
    regex: \b(53|80|443)\b
- id: script-probes-port-mail
  desc: Probes mail/rpc ports (110/139/143)
  crit: notable
  conf: 0.7
  if:
    type: raw
    regex: \b(110|139|143)\b
- id: script-probes-port-other
  desc: Probes other ports (445/3306/3389)
  crit: notable
  conf: 0.7
  if:
    type: raw
    regex: \b(445|3306|3389)\b
composite_rules:
- id: script-loops-ips
  desc: Script loops over IP addresses
  crit: notable
  conf: 0.8
  any:
    - id: script-loops-ips-while
    - id: script-loops-ips-for
- id: script-probes-port
  desc: Shell script probes specific port
  crit: notable
  conf: 0.75
  unless:
  - type: raw
    regex: \b(21|22)\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)
  any:
    - id: script-probes-port-common
    - id: script-probes-port-web
    - id: script-probes-port-mail
    - id: script-probes-port-other
- id: xargs-dotfile-loop
  desc: xargs looping with hidden script calls
  crit: suspicious
  conf: 0.9
  all:
  - id: xargs-network-loop
  - id: dotfiles-in-script
  - id: pipe-loop-pattern
