# SSH Lateral Movement Detection for Shell Scripts
# Detects shell scripts that spread via SSH to other hosts
# ATT&CK: T1021.004 (Remote Services: SSH), T1210 (Exploitation of Remote Services)
# MBC: B0040 (Lateral Movement)

defaults:
  crit: suspicious
  attack: "T1021.004"
  mbc: "B0040"
  for: [shell]

traits:
  # === Known Hosts Harvesting ===
  - id: known-hosts-read
    desc: Reads SSH known_hosts file
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "(?:cat|grep|awk)\\s+[^\\n]{0,50}/\\.ssh/known_hosts|known_hosts"

  - id: known-hosts-ip-extract
    desc: Extracts IPs from known_hosts
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      # Extracts IP addresses from known_hosts
      regex: "grep\\s+-oE[^\\n]{0,50}known_hosts|awk[^\\n]{0,50}known_hosts"

  # === SSH Key Detection ===
  - id: ssh-key-check
    desc: Checks for SSH private key
    crit: suspicious
    conf: 0.80
    if:
      type: raw
      regex: "-f\\s+[^\\n]{0,30}id_rsa|\\$\\(cat\\s+[^)]{0,30}id_rsa\\)"

  - id: ssh-key-access
    desc: SSH key path access
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "/root/\\.ssh/id_rsa|~/.ssh/id_rsa\\.pub|\\$HOME/\\.ssh/id_rsa"

  # === SSH Worm Spreading ===
  - id: ssh-batch-mode
    desc: SSH batch mode for automation
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # SSH options commonly used by worms
      regex: "ssh\\s+[^\\n]{0,50}-o\\s*(?:BatchMode=yes|StrictHostKeyChecking=no|ConnectTimeout=)"

  - id: ssh-remote-execute
    desc: SSH remote command execution
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # ssh host 'command' pattern
      regex: "ssh\\s+[^\\n]{0,80}'[^']{5,}'"

  - id: ssh-spread-loop
    desc: SSH spreading loop pattern
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      # for h in $(grep ... known_hosts); do ssh $h pattern
      regex: "for\\s+\\w+\\s+in\\s+\\$\\([^)]{0,80}known_hosts[^)]{0,30}\\)[^;]{0,10};\\s*do\\s+ssh"

  - id: ssh-curl-spread
    desc: SSH spreading with curl payload
    crit: suspicious
    conf: 0.95
    attack: "T1210"
    if:
      type: raw
      # ssh $host 'curl URL | bash' pattern
      regex: "ssh\\s+[^']{0,50}'[^']{0,30}(?:curl|wget)[^']{0,50}\\|\\s*bash"

composite_rules:
  # Full SSH worm pattern: harvests hosts, has keys, spreads
  # Complexity: all(4) + for(1) = 5 >= 4 HOSTILE
  - id: ssh-worm-spread
    desc: SSH worm spreading behavior
    crit: hostile
    conf: 0.95
    attack: "T1210"
    all:
      - id: known-hosts-read
      - id: ssh-key-check
      - id: ssh-batch-mode
      - id: ssh-remote-execute

  # SSH curl/wget dropper spread
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: ssh-dropper-spread
    desc: SSH dropper spreading
    crit: hostile
    conf: 0.95
    attack: "T1210"
    all:
      - id: known-hosts-read
      - id: ssh-batch-mode
      - id: ssh-curl-spread

  # SSH spread loop detection
  # Complexity: all(2) + for(1) = 3 < 4, SUSPICIOUS
  - id: ssh-loop-spread
    desc: SSH loop-based spreading
    crit: suspicious
    conf: 0.90
    attack: "T1210"
    all:
      - id: ssh-spread-loop
      - id: ssh-batch-mode
