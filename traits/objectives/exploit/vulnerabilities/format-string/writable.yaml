# Format Strings in Writable Sections
# Detects format strings located in writable memory sections
# Format strings should be in read-only sections; writable = potential vulnerability
# Allows runtime modification of format strings (format string attack vector)
# CWE-134: Use of Externally-Controlled Format String

defaults:
  for: [elf, macho, pe]
  crit: suspicious

traits:
  # === Format Strings in Writable Data Section ===

  # Common printf-family format specifiers in writable memory
  - id: printf-format-writable-data
    desc: Printf format string in writable section
    conf: 0.85
    if:
      type: string
      section: data
      regex: "%[0-9*]*[sdxpn]"

  # Multiple format specifiers in writable section (higher risk)
  - id: multi-format-writable
    desc: Multiple format specifiers in writable section
    conf: 0.9
    if:
      type: string
      section: data
      regex: "%[0-9*]*[sdxpnuifgec].{0,20}%[0-9*]*[sdxpnuifgec].{0,20}%[0-9*]*[sdxpnuifgec]"

  # Dangerous format specifiers (%n writes to memory)
  - id: format-n-writable
    desc: Dangerous %n format in writable section
    conf: 0.95
    if:
      type: string
      section: data
      regex: "%[0-9$]*n"

  # Format string with field width (often used in exploits)
  - id: format-width-writable
    desc: Format field width in writable section
    conf: 0.85
    if:
      type: string
      section: data
      regex: "%[0-9]{2,}[sdx]"

  # === Format Strings in BSS (Uninitialized Writable) ===

  # Format strings in BSS (very suspicious - runtime initialization)
  - id: printf-format-bss
    desc: Printf format string in BSS section
    conf: 0.9
    if:
      type: string
      section: bss
      regex: "%[sdxpn]"

composite_rules:
  # Format string vulnerability indicators
  - id: format-string-vulnerability
    desc: Potential format string vulnerability
    crit: suspicious
    conf: 0.9
    needs: 2
    any:
      - id: printf-format-writable-data
      - id: multi-format-writable
      - id: format-n-writable
      - id: format-width-writable
      - id: printf-format-bss

  # High-risk format string (writable + dangerous specifier)
  - id: dangerous-writable-format
    desc: Dangerous format string in writable memory
    crit: hostile
    conf: 0.95
    all:
      - id: format-n-writable
    any:
      - id: multi-format-writable
      - id: format-width-writable
