defaults:
  for:
    - package.json
traits:
  - id: module-exports-pattern
    desc: CommonJS module.exports pattern
    crit: notable
    conf: 0.8
    for:
      - javascript
    if:
      type: ast
      kind: assignment
      exact: module.exports
  - id: exports-dot-pattern
    desc: CommonJS exports.{0,50} pattern
    crit: notable
    conf: 0.8
    for:
      - javascript
    if:
      type: ast
      kind: assignment
      exact: exports.
  - id: esm-export-pattern
    desc: ESM export statement
    crit: notable
    conf: 0.8
    for:
      - javascript
    if:
      type: ast
      node: export_statement
      exact: export
  - id: require-os
    desc: require('os') import
    crit: notable
    conf: 0.7
    for:
      - javascript
    if:
      type: ast
      query:
        "((call_expression\n  function: (identifier) @fn\n  arguments: (arguments\
        \ (string) @arg))\n (#eq? @fn \"require\")\n (#match? @arg \"'os'|\\\"os\\\"\
        \"))\n"
  - id: require-child-process
    desc: require('child_process') import
    crit: notable
    conf: 0.8
    for:
      - javascript
    if:
      type: ast
      query:
        "((call_expression\n  function: (identifier) @fn\n  arguments: (arguments\
        \ (string) @arg))\n (#eq? @fn \"require\")\n (#match? @arg \"'child_process'|\\\
        \"child_process\\\"\"))\n"
  - id: require-https
    desc: require('https') import
    crit: notable
    conf: 0.7
    for:
      - javascript
    if:
      type: ast
      query:
        "((call_expression\n  function: (identifier) @fn\n  arguments: (arguments\
        \ (string) @arg))\n (#eq? @fn \"require\")\n (#match? @arg \"'https'|\\\"https\\\
        \"\"))\n"
  - id: require-fs
    desc: require('fs') import
    crit: notable
    conf: 0.7
    for:
      - javascript
    if:
      type: ast
      query:
        "((call_expression\n  function: (identifier) @fn\n  arguments: (arguments\
        \ (string) @arg))\n (#eq? @fn \"require\")\n (#match? @arg \"'fs'|\\\"fs\\\"\
        \"))\n"
  - id: pkg-dependencies
    desc: Package has dependencies field
    crit: notable
    conf: 0.9
    if:
      type: kv
      path: dependencies
  - id: pkg-version-001
    desc: Package version 0.0.1 (brand new)
    crit: notable
    conf: 0.6
    if:
      type: kv
      path: version
      exact: 0.0.1
  - id: node-modules-write
    desc: Package writes to node_modules directory
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
    if:
      type: string
      regex: (?:writeFile|writeFileSync|appendFile)\s*\(.{0,220}node_modules
  - id: npmrc-read
    desc: Reads .npmrc file (token theft)
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
    if:
      type: string
      regex: (?:readFile|readFileSync)\s*\(.{0,220}\.npmrc
  - id: package-json-write
    desc: Writes to package.json file
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
    if:
      type: string
      regex: writeFileSync\s*\(.{0,220}package\.json|writeFile\s*\(.{0,220}package\.json
  - id: child-dot-unref
    desc: child.unref() call (orphan process)
    crit: notable
    conf: 0.75
    for:
      - javascript
      - typescript
    if:
      type: ast
      kind: call
      exact: .unref()
  - id: spawn-unref
    desc: spawn().unref() call (orphan process)
    crit: notable
    conf: 0.75
    for:
      - javascript
      - typescript
    if:
      type: string
      regex: spawn\(.{1,220}\)\.unref\(\)
  - id: stdio-ignore-array
    desc: "stdio: [...ignore...] pattern"
    crit: notable
    conf: 0.7
    for:
      - javascript
      - typescript
    if:
      type: string
      regex: stdio:\s*\[.{0,50}ignore
  - id: small-file-5k
    desc: Small file under 5KB
    crit: notable
    conf: 0.7
    for:
      - javascript
    size_max: 5120
  - id: pkg-skeleton-small
    desc: Tiny package.json (metadata only)
    crit: notable
    conf: 0.7
    for:
      - package.json
    size_max: 2048
  - id: oast-fun-domain
    desc: oast.fun exfil domain
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
      - package.json
    if:
      type: string
      substr: oast.fun
  - id: oastify-domain
    desc: oastify.com exfil domain
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
      - package.json
    if:
      type: string
      substr: oastify.com
  - id: oast-me-domain
    desc: oast.me exfil domain
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
      - package.json
    if:
      type: string
      substr: oast.me
  - id: pipedream-domain
    desc: pipedream.net exfil domain
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
      - package.json
    if:
      type: string
      substr: pipedream.net
  - id: discord-webhook
    desc: Discord webhook exfil endpoint
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
      - package.json
    if:
      type: string
      substr: discord.com/api/webhooks
  - id: placeholder-author-your-name
    desc: Author field is "Your Name"
    crit: suspicious
    conf: 0.85
    for:
      - package.json
    if:
      type: kv
      path: author
      exact: Your Name
  - id: placeholder-author-generic
    desc: Author field contains generic placeholder
    crit: notable
    conf: 0.75
    for:
      - package.json
    if:
      type: kv
      path: author
      regex: ^(?:author|your name|name|test|user|admin|example|sample|anonymous)$
      case_insensitive: true
  - id: pkg-no-description-short
    desc: Very short/empty description
    crit: notable
    conf: 0.7
    for:
      - package.json
    if:
      type: kv
      path: description
      regex: ^.{0,15}$
  - id: pkg-main-resp-path
    desc: Main uses resp/ directory
    crit: notable
    conf: 0.7
    for:
      - package.json
    if:
      type: kv
      path: main
      substr: resp/
  - id: cdn-keyword-facade
    desc: CDN-related keywords
    crit: notable
    conf: 0.6
    for:
      - package.json
    if:
      type: kv
      path: keywords
      regex: jsdelivr|cdn|cloudflare|unpkg
  - id: template-keyword
    desc: Template keyword in package
    crit: notable
    conf: 0.5
    for:
      - package.json
    if:
      type: kv
      path: keywords
      exact: template
  - id: desc-dependency-confusion
    desc: Description mentions dependency confusion
    crit: notable
    conf: 0.8
    for:
      - package.json
    if:
      type: kv
      path: description
      regex: dependency\s*confusion
      case_insensitive: true
  - id: desc-placeholder-package
    desc: Description mentions placeholder package
    crit: notable
    conf: 0.75
    for:
      - package.json
    if:
      type: kv
      path: description
      substr: placeholder
      case_insensitive: true
  - id: desc-prevent-squat
    desc: Description claims to prevent squatting
    crit: notable
    conf: 0.75
    for:
      - package.json
    if:
      type: kv
      path: description
      regex: (prevent|protect|reserve|claim).{0,100}(squat|confusion|typo)
      case_insensitive: true
  - id: scoped-typosquat
    desc: Scoped package mimicking well-known package
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: '"name":\\s*"@[^/]{1,80}/(react|vue|angular|express|lodash|axios|webpack|babel|typescript|eslint|prettier|jest|mocha)'
  - id: js-placeholder-announcement
    desc: Code announces placeholder or fake package
    crit: suspicious
    conf: 0.85
    mbc: B0024
    attack: T1195.002
    for:
      - javascript
    if:
      type: string
      regex: (?:\b(?:placeholder|fake|demo|reserved)\b.{0,40}\b(?:package|module|library|dependency|npm)\b|\b(?:package|module|library|dependency|npm)\b.{0,40}\b(?:placeholder|fake|demo|reserved)\b|\bdo\s+not\s+use\b.{0,40}\b(?:package|module|library|dependency|npm)\b|\bprevent(?:s|ing)?\s+(?:dependency\s+)?confusion\b)
      case_insensitive: true
  - id: bug-bounty-marker
    desc: Bug bounty or security research
    crit: notable
    conf: 0.9
    for:
      - javascript
      - package.json
    if:
      type: string
      case_insensitive: true
      regex: bug\s*bounty|hackerone|bugcrowd|security\s*research|proof\s*of\s*concept|PoC|benign\s*test
composite_rules:
  - id: has-exports
    desc: Module has exports
    crit: notable
    conf: 0.8
    for:
      - javascript
    any:
      - id: module-exports-pattern
      - id: exports-dot-pattern
      - id: esm-export-pattern
  - id: dangerous-requires
    desc: Dangerous Node.js API imports
    crit: notable
    conf: 0.8
    for:
      - javascript
    needs: 3
    any:
      - id: require-os
      - id: require-child-process
      - id: require-https
      - id: require-fs
  - id: single-file-dangerous
    desc: Tiny npm package using dangerous
    crit: suspicious
    conf: 0.85
    for:
      - javascript
    all:
      - id: small-file-5k
      - id: dangerous-requires
    downgrade:
      any:
        - id: objectives/lateral-movement/supply-chain/npm/testing::test-fixtures
  - id: no-deps-with-hooks
    desc: Package has install hooks but
    crit: notable
    conf: 0.85
    all:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::install-hooks
    none:
      - id: pkg-dependencies
      - id: objectives/lateral-movement/supply-chain/npm-quality/pkg-meta::has-bin-field
  - id: multiple-hooks
    desc: Package has multiple install lifecycle
    crit: suspicious
    conf: 0.85
    needs: 2
    any:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::preinstall-hook-key
      - id: objectives/lateral-movement/supply-chain/npm/metadata::postinstall-hook-key
      - id: objectives/lateral-movement/supply-chain/npm/metadata::install-hook-key
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::npm-has-repository
  - id: new-version-hooks
    desc: Brand new version (0.0.1) with
    crit: suspicious
    conf: 0.8
    all:
      - id: pkg-version-001
      - id: objectives/lateral-movement/supply-chain/npm/metadata::install-hooks
  - id: missing-metadata-hooks
    desc: Package missing standard metadata but
    crit: suspicious
    conf: 0.85
    all:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::install-hooks
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::repository-key
      - id: objectives/lateral-movement/supply-chain/npm-quality/pkg-meta::has-bin-field
  - id: child-unref
    desc: Orphan child process (unref pattern)
    crit: suspicious
    conf: 0.85
    for:
      - javascript
      - typescript
    any:
      - id: child-dot-unref
      - id: spawn-unref
  - id: stdio-ignore
    desc: Silent process execution (stdio ignored)
    crit: notable
    conf: 0.8
    for:
      - javascript
      - typescript
    any:
      - id: micro-traits/process/create/spawn::stdio-ignore-string
      - id: stdio-ignore-array
  - id: multi-oob
    desc: Multiple OOB exfiltration endpoints
    crit: suspicious
    conf: 0.9
    for:
      - javascript
      - typescript
      - package.json
    needs: 2
    any:
      - id: oast-fun-domain
      - id: oastify-domain
      - id: oast-me-domain
      - id: objectives/exfiltration/channel/oob::webhook-site
      - id: pipedream-domain
      - id: discord-webhook
  - id: placeholder-no-repo
    desc: Package with placeholder author and no repository URL
    crit: suspicious
    conf: 0.85
    for:
      - package.json
    all:
      - id: placeholder-author-your-name
    none:
      - id: objectives/lateral-movement/supply-chain/npm/metadata::repository-key
  - id: npm-data-exfil
    desc: NPM package exfiltrates system info via HTTP
    crit: hostile
    conf: 0.95
    attack: T1020
    mbc: E1041
    for:
      - javascript
    all:
      - id: micro-traits/comm/http/post::post
      - id: small-file-5k
    any:
      - id: objectives/discovery/host/system/hardware-fingerprint::js-sysinfo-multi
      - id: objectives/discovery/host/system/hardware-fingerprint::process-fingerprint-multi
  - id: npm-victim-exfil
    desc: NPM package sends victim ID via HTTP POST
    crit: hostile
    conf: 0.92
    attack: T1020
    mbc: E1041
    for:
      - javascript
    all:
      - id: objectives/discovery/host/system/hardware-fingerprint::js-victim-id
      - id: micro-traits/comm/http/post::post
      - id: small-file-5k
  - id: npm-sysinfo-http
    desc: NPM package with system info and HTTP POST
    crit: suspicious
    conf: 0.85
    attack: T1082
    for:
      - javascript
    all:
      - id: objectives/discovery/host/system/hardware-fingerprint::js-victim-id
      - id: micro-traits/comm/http/post::post
  - id: dependency-confusion-claim
    desc: Package claims dependency confusion protection
    crit: notable
    conf: 0.8
    for:
      - package.json
    any:
      - id: desc-dependency-confusion
      - id: desc-placeholder-package
      - id: desc-prevent-squat
  - id: fake-placeholder-noop
    desc: Fake package stub with no module exports
    crit: hostile
    conf: 0.95
    attack: T1195.002
    mbc: B0024
    for:
      - javascript
    size_max: 1024
    all:
      - id: js-placeholder-announcement
      - id: small-file-5k
    none:
      - id: has-exports
