# Machine ID Collection
# ATT&CK: T1082 (System Information Discovery)
# NOTE: Neutral machine-id strings moved to micro-behaviors/os/machine-id/
# NOTE: Kept here: specific file paths (fp-dbus-machine-id, fp-etc-machine-id, product-uuid-path) have notable suspicion for device tracking
# NOTE: MachineGuid kept here - Windows registry key for device tracking

defaults:
  for: [all]
  attack: "T1082"

traits:
  # === Machine ID micro-behaviors ===
  # NOTE: Specific paths kept here - used for device tracking
  - id: fp-dbus-machine-id
    desc: dbus machine-id path
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "/var/lib/dbus/machine-id"

  - id: fp-etc-machine-id
    desc: /etc/machine-id path
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "/etc/machine-id"

  - id: machineguid
    desc: MachineGuid registry key
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "MachineGuid"

  - id: product-uuid-path
    desc: DMI product_uuid path
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "/sys/class/dmi/id/product_uuid"

  # === Hardware UUID micro-behaviors ===
  - id: generate-hwid
    desc: GenerateHardwareId function
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "GenerateHardwareId"

  - id: get-hwid
    desc: GetHardwareId function
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "GetHardwareId"

  - id: hardware-id-string
    desc: hardware_id string
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)hardware_id"

  - id: hwid-string
    desc: hwid string
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)\\bhwid\\b"

  # Removed fingerprint-string duplicate - use micro-behaviors/os/system/machine-id::fingerprint-string


composite_rules:
  # Machine ID composite
  - id: machine-id-collection
    desc: Machine ID collection for victim tracking
    crit: notable
    conf: 0.8
    needs: 2
    any:
      - id: fp-dbus-machine-id
      - id: fp-etc-machine-id
      - id: micro-behaviors/os/system/machine-id::machine-id-string
      - id: machineguid
      - id: micro-behaviors/os/system/machine-id::machineid-camel
      - id: product-uuid-path
      - id: micro-behaviors/os/system/machine-id::product-uuid-string

  # Hardware UUID composite
  - id: hardware-uuid
    desc: Hardware-based UUID generation
    crit: suspicious
    conf: 0.8
    any:
      - id: generate-hwid
      - id: get-hwid
      - id: hardware-id-string
      - id: hwid-string
      - id: micro-behaviors/os/system/machine-id::fingerprint-string

  # Hostname composite
  - id: hostname
    desc: Hostname collection for identification
    crit: notable
    conf: 0.7
    needs: 2
    any:
      - id: micro-behaviors/os/sysinfo/system-info::gethostname
      - id: micro-behaviors/os/system/machine-id::etc-hostname
      - id: micro-behaviors/os/env/vars/system-info::hostname-var
      - id: micro-behaviors/os/sysinfo/system-info::getfqdn
