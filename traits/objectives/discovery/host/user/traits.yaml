defaults:
  for:
  - all
traits:
- id: getenv-home
  desc: getenv HOME lookup
  crit: notable
  conf: 0.5
  attack: T1033
  for:
  - all
  if:
    type: string
    regex: getenv.{0,30}HOME
- id: env-dot-home
  desc: env.HOME lookup
  crit: notable
  conf: 0.5
  attack: T1033
  for:
  - all
  if:
    type: string
    substr: env.HOME
- id: dollar-home
  desc: $HOME variable reference
  crit: notable
  conf: 0.5
  attack: T1033
  for:
  - all
  if:
    type: string
    substr: $HOME
- id: appdata
  desc: Windows APPDATA lookup
  crit: notable
  conf: 0.75
  attack: T1033
  for:
  - pe
  - python
  - javascript
  if:
    type: string
    substr: APPDATA
- id: localappdata
  desc: Windows LOCALAPPDATA lookup
  crit: notable
  conf: 0.75
  attack: T1033
  for:
  - pe
  - python
  - javascript
  if:
    type: string
    substr: LOCALAPPDATA
- id: userprofile
  desc: Windows USERPROFILE lookup
  crit: notable
  conf: 0.75
  attack: T1033
  for:
  - pe
  - python
  - javascript
  if:
    type: string
    substr: USERPROFILE
- id: username-var
  desc: USERNAME environment variable
  crit: notable
  conf: 0.5
  if:
    type: string
    word: USERNAME
- id: user-var
  desc: USER environment variable
  crit: notable
  conf: 0.5
  for:
  - shell
  - elf
  - macho
  - pe
  - python
  - ruby
  - javascript
  if:
    type: string
    word: USER
  not:
  - regex: ^\s*USER\s+(user|fwuser)(@|$)
  - regex: USERNAME|USERPROFILE|USERID
  - regex: '[|,]USER[|,]'
- id: logname-var
  desc: LOGNAME environment variable
  crit: notable
  conf: 0.5
  attack: T1033
  for:
  - all
  if:
    type: string
    substr: LOGNAME
- id: getpwnam
  desc: Get password entry by name
  crit: notable
  conf: 0.4
  attack: T1033
  for:
  - elf
  - macho
  if:
    type: string
    substr: getpwnam
- id: dscl
  desc: macOS Directory Service CLI
  crit: suspicious
  conf: 0.85
  attack: T1087.001
  for:
  - macho
  - shell
  if:
    type: string
    regex: dscl\s+\.
- id: dsenableroot
  desc: macOS enable root user
  crit: suspicious
  conf: 0.85
  attack: T1087.001
  for:
  - macho
  - shell
  if:
    type: string
    substr: dsenableroot
- id: finger
  desc: Finger command for user info
  crit: suspicious
  conf: 0.75
  attack: T1033
  for:
  - shell
  - elf
  - macho
  if:
    type: string
    regex: (?:/usr/bin/finger|/usr/local/bin/finger|\bfinger\s+@[a-z]|\bfinger\s+-[lms]\s)
- id: last-cmd
  desc: Last command for login history
  crit: suspicious
  conf: 0.8
  attack: T1033
  for:
  - shell
  - elf
  - macho
  if:
    type: string
    substr: /usr/bin/last
- id: w-cmd
  desc: W command for user sessions
  crit: suspicious
  conf: 0.75
  attack: T1033
  for:
  - shell
  - elf
  - macho
  if:
    type: string
    regex: /usr/bin/w\b
- id: whoami
  desc: Shell whoami command execution
  crit: notable
  conf: 0.85
  attack: T1033
  for:
  - javascript
  - typescript
  if:
    type: string
    regex: exec(Sync)?\(['"]whoami['"]
- id: id
  desc: Shell id command execution
  crit: notable
  conf: 0.85
  attack: T1033
  for:
  - javascript
  - typescript
  if:
    type: string
    regex: exec(Sync)?\(['"]id['"]
- id: npm-whoami
  desc: npm whoami command execution
  crit: suspicious
  conf: 0.9
  attack: T1033
  for:
  - javascript
  - typescript
  if:
    type: string
    regex: exec(Sync)?\(['"]npm whoami['"]
composite_rules:
- id: home-env
  desc: HOME environment variable lookup
  crit: notable
  conf: 0.7
  attack: T1033
  for:
  - all
  any:
  - id: getenv-home
  - id: env-dot-home
  - id: dollar-home
- id: username-env
  desc: USERNAME environment variable
  crit: notable
  conf: 0.75
  attack: T1033
  for:
  - all
  any:
  - id: username-var
  - id: user-var
  - id: logname-var
- id: active-enum-cmds
  desc: Active user enumeration commands
  crit: notable
  conf: 0.8
  attack: T1033
  for:
  - shell
  - elf
  - macho
  - pe
  - python
  any:
  - id: micro-traits/process/user/query::whoami-cmd
  - id: micro-traits/fs/path/config/accounts::etc-passwd
  - id: dscl
  - id: finger
  - id: last-cmd
  - id: w-cmd
- id: passive-user-lookup
  desc: POSIX user lookup functions
  crit: notable
  conf: 0.4
  attack: T1033
  for:
  - elf
  - macho
  any:
  - id: getpwnam
  - id: micro-traits/process/identity/query::get-uid
  - id: micro-traits/process/user/query::getpwuid
- id: enumeration-detected
  desc: User enumeration activity
  crit: suspicious
  conf: 0.9
  attack: T1033
  mbc: B0046
  for:
  - shell
  - elf
  - macho
  - pe
  - python
  size_max: 5000
  all:
  - id: active-enum-cmds
  any:
  - id: passive-user-lookup
  - id: username-env
  - id: home-env
  unless:
  - id: objectives/discovery/host/user::inline__enumeration-detected__unless_1
