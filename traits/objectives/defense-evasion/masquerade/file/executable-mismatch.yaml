# Executable Masquerading as non-executable
# Detects binary executables hiding behind common document or media extensions
# ATT&CK: T1036.003 (Rename System Utilities)

defaults:
  for: [all]
  crit: hostile
  conf: 0.95

traits:
  - id: basename-is-doc
    desc: Filename has document extension
    crit: notable
    if:
      type: basename
      regex: '\.(pdf|doc|docx|xls|xlsx|ppt|pptx|rtf|txt|csv|ods|odt)$'

  - id: basename-is-media
    desc: Filename has media extension
    crit: notable
    if:
      type: basename
      regex: '\.(mp3|mp4|wav|avi|mov|mkv|flv|wmv|png|jpg|jpeg|gif|bmp|ico|svg|webp|tiff|tif)$'

composite_rules:
  - id: pe-masquerading-as-image
    desc: PE executable hiding as image file
    all:
      - id: metadata/format/magic::pe-dos-stub
      - id: basename-is-media

  - id: pe-masquerading-as-doc
    desc: PE executable hiding as document file
    all:
      - id: metadata/format/magic::pe-dos-stub
      - id: basename-is-doc

  - id: elf-masquerading-as-media
    desc: ELF executable hiding as media file
    all:
      - id: metadata/format/magic::elf-header
      - id: basename-is-media

  - id: elf-masquerading-as-doc
    desc: ELF executable hiding as document file
    all:
      - id: metadata/format/magic::elf-header
      - id: basename-is-doc

  - id: macho-masquerading-as-media
    desc: Mach-O executable hiding as media file
    any:
      - id: metadata/format/magic::macho-32
      - id: metadata/format/magic::macho-64
    all:
      - id: basename-is-media

  - id: macho-masquerading-as-doc
    desc: Mach-O executable hiding as document file
    any:
      - id: metadata/format/magic::macho-32
      - id: metadata/format/magic::macho-64
    all:
      - id: basename-is-doc
