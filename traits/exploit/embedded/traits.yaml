# Embedded Exploit/CVE Detection
# Detects binaries with embedded exploit code or CVE references
# ATT&CK: T1203 (Exploitation for Client Execution)

traits:
  # CVE identifier patterns
  - id: exploit/embedded/cve-reference
    description: Contains CVE identifier references
    criticality: suspicious
    confidence: 0.85
    attack: "T1203"
    condition:
      type: yara
      source: |
        rule cve_reference {
          strings:
            $cve = /CVE-20[0-2][0-9]-[0-9]{4,5}/ ascii nocase
          condition:
            #cve > 2
        }

  # POC YAML references (Alchimist/nuclei style)
  - id: exploit/embedded/poc-yaml
    description: Contains POC YAML file references (exploit framework)
    criticality: hostile
    confidence: 0.9
    attack: "T1203"
    condition:
      type: yara
      source: |
        rule poc_yaml_refs {
          strings:
            $poc_yaml = /poc-yaml-[a-z0-9-]+/ ascii
            $pocs_dir = "pocs/" ascii
            $nuclei = "nuclei" ascii nocase
          condition:
            #poc_yaml > 3 or ($pocs_dir and $nuclei)
        }

  # Common exploit strings
  - id: exploit/embedded/exploit-strings
    description: Contains common exploit-related strings
    criticality: suspicious
    confidence: 0.8
    attack: "T1203"
    condition:
      type: yara
      source: |
        rule exploit_strings {
          strings:
            $rce = "remote code execution" ascii nocase
            $shell_upload = "shell upload" ascii nocase
            $webshell = "webshell" ascii nocase
            $getshell = "getshell" ascii nocase
            $cmd_injection = "command injection" ascii nocase
            $sql_injection = "sql injection" ascii nocase
            $lfi = "local file inclusion" ascii nocase
            $rfi = "remote file inclusion" ascii nocase
            $ssrf = "ssrf" ascii nocase
            $xxe = "xxe" ascii nocase
            $deserial = "deserialization" ascii nocase
          condition:
            3 of them
        }

  # Metasploit/exploit framework references
  - id: exploit/embedded/framework-ref
    description: References exploit frameworks (Metasploit, etc.)
    criticality: suspicious
    confidence: 0.85
    attack: "T1203"
    condition:
      type: yara
      source: |
        rule exploit_framework {
          strings:
            $msf = "metasploit" ascii nocase
            $msf_module = "msf/modules" ascii
            $exploit_db = "exploit-db" ascii nocase
            $packetstorm = "packetstorm" ascii nocase
            $rapid7 = "rapid7" ascii nocase
            $vulhub = "vulhub" ascii nocase
          condition:
            any of them
        }

  # Specific high-profile CVEs embedded
  - id: exploit/embedded/critical-cves
    description: References critical/commonly exploited CVEs
    criticality: hostile
    confidence: 0.9
    attack: "T1203"
    condition:
      type: yara
      source: |
        rule critical_cves {
          strings:
            // Log4Shell
            $log4j = "CVE-2021-44228" ascii nocase
            // ProxyShell/ProxyLogon
            $proxylogon = "CVE-2021-26855" ascii nocase
            $proxyshell = "CVE-2021-34473" ascii nocase
            // Spring4Shell
            $spring4shell = "CVE-2022-22965" ascii nocase
            // Confluence
            $confluence = "CVE-2022-26134" ascii nocase
            // Apache Struts
            $struts = "CVE-2017-5638" ascii nocase
            // Drupalgeddon
            $drupal = "CVE-2018-7600" ascii nocase
            // WebLogic
            $weblogic = "CVE-2019-2725" ascii nocase
            $weblogic2 = "CVE-2020-14882" ascii nocase
          condition:
            any of them
        }

composite_rules:
  # Exploit toolkit/framework
  - id: exploit/embedded/exploit-toolkit
    description: Binary contains embedded exploit toolkit (Alchimist-style)
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: trait
        id: exploit/embedded/cve-reference
    requires_any:
      - type: trait
        id: exploit/embedded/poc-yaml
      - type: trait
        id: exploit/embedded/exploit-strings
