# Exploit CVE Detection
# ATT&CK: T1068 (Exploitation for Privilege Escalation)
# MBC: E1203 (Exploit Vulnerability)

traits:
  # DirtyCow (CVE-2016-5195)
  - id: exploit/cve/dirtycow
    description: DirtyCow kernel privilege escalation exploit (CVE-2016-5195)
    criticality: hostile
    confidence: 0.95
    mbc: "E1203"
    attack: "T1068"
    condition:
      type: yara
      source: |
        rule dirtycow {
          strings:
            $name1 = "dirtycow" ascii nocase
            $name2 = "dirty cow" ascii nocase
            $name3 = "dirtyc0w" ascii nocase
            $cve = "CVE-2016-5195" ascii
            // Exploit technique - /proc/self/mem write is the key indicator
            $proc_mem = "/proc/self/mem" ascii
            $madvise = "madvise" ascii
            $madv_dontneed = "MADV_DONTNEED" ascii
          condition:
            any of ($name*, $cve) or
            ($proc_mem and $madvise) or
            ($proc_mem and $madv_dontneed)
        }

  # Spectre (CVE-2017-5753, CVE-2017-5715)
  - id: exploit/cve/spectre
    description: Spectre CPU speculative execution exploit
    criticality: suspicious
    confidence: 0.85
    mbc: "E1203"
    attack: "T1068"
    condition:
      type: yara
      source: |
        rule spectre {
          strings:
            $name1 = "spectre" ascii nocase
            $name2 = "meltdown" ascii nocase
            $cve1 = "CVE-2017-5753" ascii
            $cve2 = "CVE-2017-5715" ascii
            // Technique
            $clflush = "clflush" ascii
            $rdtsc = "rdtsc" ascii
            // Spectre gadget
            $branch = "__builtin_speculation" ascii
            $barrier = "speculation_barrier" ascii
          condition:
            any of ($name*, $cve*) or
            ($clflush and $rdtsc) or
            any of ($branch, $barrier)
        }

  # Log4Shell (CVE-2021-44228)
  - id: exploit/cve/log4shell
    description: Log4Shell JNDI injection exploit (CVE-2021-44228)
    criticality: hostile
    confidence: 0.95
    mbc: "E1203"
    attack: "T1190"
    condition:
      type: yara
      source: |
        rule log4shell {
          strings:
            $name = "log4shell" ascii nocase
            $cve = "CVE-2021-44228" ascii
            // JNDI injection
            $jndi1 = "${jndi:" ascii
            $jndi2 = "jndi:ldap://" ascii
            $jndi3 = "jndi:rmi://" ascii
            $jndi4 = "jndi:dns://" ascii
            // Obfuscated variants
            $obf1 = "${${" ascii
            $obf2 = "${lower:" ascii
            $obf3 = "${upper:" ascii
            $obf4 = "${env:" ascii
            // Log4j markers
            $log4j1 = "log4j" ascii nocase
            $log4j2 = "org.apache.logging" ascii
          condition:
            any of ($name, $cve) or
            any of ($jndi*) or
            (2 of ($obf*) and any of ($log4j*))
        }

  # Polkit pkexec (CVE-2021-4034)
  - id: exploit/cve/pwnkit
    description: PwnKit polkit privilege escalation (CVE-2021-4034)
    criticality: hostile
    confidence: 0.95
    mbc: "E1203"
    attack: "T1068"
    condition:
      type: yara
      source: |
        rule pwnkit {
          strings:
            $name1 = "pwnkit" ascii nocase
            $name2 = "pkexec" ascii
            $cve = "CVE-2021-4034" ascii
            // Technique
            $gconv = "GCONV_PATH" ascii
            $gconv2 = "gconv-modules" ascii
          condition:
            any of ($name*, $cve) or
            ($gconv and $gconv2) or
            ($name2 and $gconv)
        }

  # Sudo Baron Samedit (CVE-2021-3156)
  - id: exploit/cve/baron-samedit
    description: Sudo heap overflow privilege escalation (CVE-2021-3156)
    criticality: hostile
    confidence: 0.9
    mbc: "E1203"
    attack: "T1068"
    condition:
      type: yara
      source: |
        rule baron_samedit {
          strings:
            $name = "baron samedit" ascii nocase
            $cve = "CVE-2021-3156" ascii
            // Technique markers
            $sudoedit = "sudoedit" ascii
            $heap_overflow = { 5C 00 5C 00 5C }  // backslash pattern
          condition:
            any of ($name, $cve) or
            ($sudoedit and $heap_overflow)
        }

  # Container escape exploits
  - id: exploit/cve/container-escape
    description: Container escape exploit patterns
    criticality: hostile
    confidence: 0.85
    mbc: "E1203"
    attack: "T1611"
    condition:
      type: yara
      source: |
        rule container_escape {
          strings:
            // CVE-2019-5736 runc
            $runc_cve = "CVE-2019-5736" ascii
            // CVE-2020-15257 containerd
            $containerd_cve = "CVE-2020-15257" ascii
            // Cgroup escape - need release_agent + notify_on_release together
            $cgroup_release = "release_agent" ascii
            $cgroup_notify = "notify_on_release" ascii
            $cgroup_escape = "cgroup escape" ascii nocase
            // Container escape specific strings
            $escape1 = "container escape" ascii nocase
            $escape2 = "container breakout" ascii nocase
            $escape3 = "docker escape" ascii nocase
            // Specific exploit tool names
            $tool1 = "deepce" ascii nocase
            $tool2 = "CDK-" ascii
            $tool3 = "PEIRATES" ascii
          condition:
            any of ($runc_cve, $containerd_cve, $cgroup_escape) or
            any of ($escape*) or
            any of ($tool*) or
            ($cgroup_release and $cgroup_notify)
        }

composite_rules:
  # Privilege escalation exploit
  - id: exploit/cve/privesc-exploit
    description: Privilege escalation exploit detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: exploit/cve/dirtycow
      - type: trait
        id: exploit/cve/pwnkit
      - type: trait
        id: exploit/cve/baron-samedit
      - type: trait
        id: exploit/cve/container-escape
