# XZ Utils Backdoor (CVE-2024-3094)
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)
# MBC: B0030 (Remote Access)

traits:
  # XZ backdoor IFUNC hijacking
  - id: exploit/cve/xz-backdoor/ifunc
    description: XZ backdoor IFUNC resolver hijacking (CVE-2024-3094)
    criticality: hostile
    confidence: 0.95
    mbc: "B0030"
    attack: "T1195.002"
    condition:
      type: yara
      source: |
        rule xz_backdoor_ifunc {
          strings:
            // CVE identifier
            $cve = "CVE-2024-3094" ascii
            // XZ backdoor specific
            $xz1 = "xz backdoor" ascii nocase
            $xz2 = "liblzma backdoor" ascii nocase
            // IFUNC patterns specific to XZ backdoor
            // The backdoor hijacks crc64 IFUNC resolver
            $ifunc1 = "lzma_crc64" ascii
            $ifunc2 = "crc64_resolve" ascii
            // Backdoor payload markers
            $payload1 = { 00 00 00 00 00 00 00 01 }  // XZ stream header
          condition:
            any of ($cve, $xz1, $xz2) or
            ($ifunc1 and $ifunc2)
        }

  # XZ backdoor SSH authentication bypass
  - id: exploit/cve/xz-backdoor/ssh-bypass
    description: XZ backdoor SSH RSA authentication bypass
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1195.002"
    condition:
      type: yara
      source: |
        rule xz_ssh_bypass {
          strings:
            // RSA signature manipulation
            $rsa1 = "RSA_public_decrypt" ascii
            $rsa2 = "RSA_verify" ascii
            // SSH-related
            $ssh1 = "sshd" ascii
            $ssh2 = "openssh" ascii nocase
            // XZ/LZMA context
            $xz1 = "liblzma" ascii
            $xz2 = "lzma_" ascii
            // Specific backdoor indicators
            $bd1 = "xz" ascii
            $bd2 = "backdoor" ascii nocase
          condition:
            (any of ($rsa*) and any of ($xz*)) or
            ($bd1 and $bd2 and any of ($ssh*))
        }

  # XZ backdoor obfuscated payload
  - id: exploit/cve/xz-backdoor/payload
    description: XZ backdoor embedded obfuscated payload
    criticality: hostile
    confidence: 0.85
    mbc: "B0030"
    attack: "T1195.002"
    condition:
      type: yara
      source: |
        rule xz_backdoor_payload {
          strings:
            // XZ backdoor used test files to hide payload
            $test1 = "tests/files" ascii
            $test2 = "bad-" ascii
            $test3 = "good-" ascii
            // Specific malicious test file names
            $file1 = "bad-3-corrupt_lzma2.xz" ascii
            $file2 = "good-large_compressed.lzma" ascii
            // Backdoor build script markers
            $build1 = "gl_cv_host_cpu_c_abi" ascii
            $build2 = "IFUNC" ascii
          condition:
            ($file1 and $file2) or
            ($build1 and $build2)
        }

composite_rules:
  # XZ backdoor detection
  - id: exploit/cve/xz-backdoor/detected
    description: XZ backdoor (CVE-2024-3094) detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: exploit/cve/xz-backdoor/ifunc
      - type: trait
        id: exploit/cve/xz-backdoor/ssh-bypass
      - type: trait
        id: exploit/cve/xz-backdoor/payload
