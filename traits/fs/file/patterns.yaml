# Malicious File System Patterns
# Detects patterns of file creation followed by execution

traits:
  # === Temp directory atomic indicators ===
  - id: tmp-ref
    desc: "Reference to tmp path"
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "tmp"

  - id: tempfile-ref
    desc: "Reference to tempfile module"
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "tempfile"

  - id: environ-tmp
    desc: "Reference to TMP environment variable"
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: 'environ\[[''"]TMP'

composite_rules:
  # Temp directory reference composite
  # NOTE: "tmp" string is too generic - appears in Go runtime and many
  # legitimate programs. Downgraded to inert.
  - id: temp-dir-reference
    desc: "Reference to a temporary directory path or variable"
    crit: inert
    conf: 0.4
    count_min: 1
    any:
      - id: tmp-ref
      - id: tempfile-ref
      - id: environ-tmp

  - id: execute-temp-file
    desc: "Creates and executes a file from a temporary directory (Staging)"
    crit: suspicious
    conf: 0.95
    near_lines: 50
    all:
      - id: fs/file/open/generic
      - id: exec/command/subprocess/run
      - id: temp-dir-reference
