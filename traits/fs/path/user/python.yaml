# User Home Directory Access - Python
# Detects Python code accessing user home directories
# ATT&CK: T1083 (File and Directory Discovery)

defaults:
  file_types: [python]
  mbc: "E1083"
  attack: "T1083"
  criticality: notable

traits:
  # os.path.expanduser("~") - most common pattern
  - id: python-expanduser
    description: "Home directory expansion (os.path.expanduser)"
    confidence: 0.8
    condition:
      type: string
      regex: "os\\.path\\.expanduser\\([^)]*[\"']~"

  # === pathlib.Path.home() atomic indicators ===
  - id: python-path-home-direct
    description: "Path.home() direct call"
    confidence: 0.7
    criticality: inert
    condition:
      type: string
      exact: "Path.home()"

  - id: python-path-home-method
    description: "Path().home() method call"
    confidence: 0.7
    criticality: inert
    condition:
      type: string
      regex: "Path\\(\\)\\s*\\.home\\(\\)"

  # os.environ['HOME'] or os.environ.get('HOME')
  - id: python-environ-home
    description: "HOME environment variable access"
    confidence: 0.75
    condition:
      type: string
      regex: "os\\.environ\\[['\"]HOME['\"]\\]|os\\.environ\\.get\\(['\"]HOME"

  # USERPROFILE for Windows
  - id: python-environ-userprofile
    description: "USERPROFILE environment variable access (Windows)"
    confidence: 0.75
    platforms: [windows]
    condition:
      type: string
      regex: "os\\.environ\\[['\"]USERPROFILE['\"]\\]|os\\.environ\\.get\\(['\"]USERPROFILE"

  # os.getenv('HOME')
  - id: python-getenv-home
    description: "Home directory via getenv"
    confidence: 0.75
    condition:
      type: string
      regex: "os\\.getenv\\(['\"]HOME['\"]"

  # Home directory access via any method (for composite rules)
  - id: python-home-access-any
    description: "Home directory access via expanduser, pathlib, or environ"
    confidence: 0.75
    condition:
      type: string
      regex: "os\\.path\\.expanduser\\([^)]*~|Path\\.home\\(\\)|os\\.environ.*HOME"

  # Hidden directory path construction via os.path.join
  - id: python-hidden-dir-join
    description: "Path join with hidden directory component"
    confidence: 0.75
    condition:
      type: string
      regex: "os\\.path\\.join\\([^)]*,\\s*[\"']\\.[a-zA-Z]"

composite_rules:
  - id: python-pathlib-home
    description: "Home directory via pathlib (Path.home)"
    confidence: 0.8
    requires_count: 1
    conditions:
      - id: python-path-home-direct
      - id: python-path-home-method

  # Home directory + hidden path construction
  - id: python-home-hidden-dir
    description: "Hidden directory in home (likely malware staging)"
    confidence: 0.9
    criticality: suspicious
    requires_all:
      - id: python-home-access-any
      - id: python-hidden-dir-join
