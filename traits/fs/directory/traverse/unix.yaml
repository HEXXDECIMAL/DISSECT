# Filesystem Hierarchy Traversal
# MBC: E1083 (File and Directory Discovery)
# ATT&CK: T1083

defaults:
  for: [elf, macho, so, dylib, c]

traits:
  # fts API functions
  - id: fts-open
    desc: fts_open function (open directory hierarchy)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      pattern: "_?fts_open"

  - id: fts-read
    desc: fts_read function (read directory entry)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      pattern: "_?fts_read"

  - id: fts-children
    desc: fts_children function (get child entries)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      pattern: "_?fts_children"

  - id: fts-set
    desc: fts_set function (set directory options)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      pattern: "_?fts_set"

  - id: fts-close
    desc: fts_close function (close directory hierarchy)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      pattern: "_?fts_close"

  # nftw/ftw API
  - id: traverse-nftw
    desc: Traverse filesystem hierarchy via nftw/ftw
    crit: inert
    conf: 0.66
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      pattern: "nftw|ftw"

  # Manual traversal functions
  - id: opendir-symbol
    desc: opendir function (open directory)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      exact: "opendir"

  - id: readdir-symbol
    desc: readdir function (read directory entry)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      exact: "readdir"

  - id: lstat-symbol
    desc: lstat function (get file status,
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      exact: "lstat"

  - id: stat-symbol
    desc: stat function (get file status)
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    if:
      type: symbol
      exact: "stat"

composite_rules:
  - id: traverse-fts
    desc: Traverse filesystem hierarchy via fts
    crit: inert
    conf: 0.66
    mbc: E1083
    attack: T1083
    count_min: 2
    any:
      - id: fts-open
      - id: fts-read
      - id: fts-children
      - id: fts-set
      - id: fts-close

  - id: stat-functions
    desc: File status check (stat or
    crit: inert
    conf: 0.7
    mbc: E1083
    attack: T1083
    any:
      - id: lstat-symbol
      - id: stat-symbol

  - id: traverse-manual
    desc: Manual recursive directory traversal (opendir
    crit: notable
    conf: 0.7
    mbc: E1083
    attack: T1083
    all:
      - id: opendir-symbol
      - id: readdir-symbol
      - id: stat-functions
