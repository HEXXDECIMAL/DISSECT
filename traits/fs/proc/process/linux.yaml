# /proc Process Information (Linux)
# MBC: E1057 (Process Discovery)
# ATT&CK: T1057

traits:
  - id: process-arbitrary
    description: Access /proc for arbitrary PIDs
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[%{$][/\\$\\w\\}]{0,12}'

  - id: process-self-exe
    description: Read own executable path via
    crit: inert
    conf: 0.66
    if:
      type: string
      exact: /proc/self/exe

  - id: process-self-cmdline
    description: Read own command line via
    crit: inert
    conf: 0.66
    if:
      type: string
      exact: /proc/self/cmdline

  - id: process-self-status
    description: Read own process status via
    crit: inert
    conf: 0.66
    if:
      type: string
      exact: /proc/self/status

  - id: process-self-maps
    description: Read own process memory maps
    crit: inert
    conf: 0.66
    if:
      type: string
      exact: /proc/self/maps

  - id: process-pid-maps
    description: Read process memory maps via
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/maps'

  - id: process-pid-mem
    description: Access process memory via /proc/*/mem
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: '/proc/[^/]+/mem'

  - id: process-pid-cmdline
    description: Read process command line via
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/cmdline'

  - id: process-pid-environ
    description: Read process environment via /proc/*/environ
    crit: suspicious
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/environ'

  - id: process-pid-fd
    description: Access process file descriptors via
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/fd'

  - id: process-pid-exe
    description: Read process executable path via
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/exe'

  - id: process-pid-status
    description: Read process status via /proc/*/status
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/status'

  - id: process-pid-stat
    description: Read process statistics via /proc/*/stat
    crit: notable
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/stat[^u]'

  - id: python-proc-path-join
    description: os.path.join for /proc sensitive files
    crit: notable
    conf: 0.85
    for: [python]
    if:
      type: ast
      language: python
      query: |
        (call
          function: (attribute
            object: (attribute
              object: (identifier) @os (#eq? @os "os")
              attribute: (identifier) @path (#eq? @path "path"))
            attribute: (identifier) @join (#eq? @join "join"))
          arguments: (argument_list
            (string) @proc (#match? @proc "/proc")
            (identifier)
            (string) @file (#match? @file "cmdline|maps|mem|environ|exe")))

  - id: process-oom
    description: Adjust OOM killer score via
    crit: suspicious
    conf: 0.66
    if:
      type: string
      regex: '/proc/[^/]+/oom_score_adj'

composite_rules:
  - id: process-pid-mem-maps-helper
    desc: Helper for process memory access
    all:
      - id: process-pid-maps
      - id: process-pid-mem

  - id: process-memory-dumper
    desc: Dumps process memory via /proc
    crit: suspicious
    conf: 0.8
    any:
      - id: python-proc-path-join
      - id: process-pid-mem-maps-helper
    downgrade:
      notable:
        any:
          - id: discovery/process/psutil-enum
