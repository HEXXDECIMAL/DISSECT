# Binary File Mode Operations Detection
# Detects explicit binary file operations (read/write in binary mode)
# Suspicious when combined with network operations (file exfiltration)
# ATT&CK: T1005 (Data from Local System), T1041 (Exfiltration Over C2 Channel)

defaults:
  attack: "T1005"
  crit: inert

traits:
  # === Binary write modes ===
  - id: write-binary
    desc: "Opens file in binary write mode (wb)"
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, c, python]
    if:
      type: string
      regex: '\\b"wb"\\b|\\bfopen\\s*\\([^,]+,\\s*"wb"\\)'

  - id: write-read-binary
    desc: "Opens file in binary write+read mode (w+b)"
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, c, python]
    if:
      type: string
      regex: '\\b"w\\+b"\\b|\\bfopen\\s*\\([^,]+,\\s*"w\\+b"\\)'

  - id: read-write-binary
    desc: "Opens file in binary read+write mode (r+b)"
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, c, python]
    if:
      type: string
      regex: '\\b"r\\+b"\\b|\\bfopen\\s*\\([^,]+,\\s*"r\\+b"\\)'

  - id: read-binary
    desc: "Opens file in binary read mode (rb)"
    crit: inert
    conf: 0.5
    for: [elf, macho, pe, c, python]
    if:
      type: string
      regex: '\\b"rb"\\b|\\bfopen\\s*\\([^,]+,\\s*"rb"\\)'

  # === macOS file copying ===
  - id: fcopyfile-macos
    desc: "Copies files on macOS using fcopyfile()"
    crit: notable
    conf: 0.7
    platforms: [macos]
    for: [macho]
    attack: "T1005"
    if:
      type: symbol
      pattern: "fcopyfile"

  # === Binary file I/O ===
  - id: fread-func
    desc: "Reads binary data from file"
    crit: inert
    conf: 0.5
    for: [elf, macho, pe]
    if:
      type: symbol
      pattern: "fread"

  - id: fwrite-func
    desc: "Writes binary data to file"
    crit: inert
    conf: 0.5
    for: [elf, macho, pe]
    if:
      type: symbol
      pattern: "fwrite"

  - id: fseek-func
    desc: "Seeks to position in file"
    crit: inert
    conf: 0.4
    for: [elf, macho, pe]
    if:
      type: symbol
      pattern: "fseek"

composite_rules:
  # Binary file operations composite
  - id: binary-file-ops
    desc: "Binary file read/write operations"
    crit: notable
    conf: 0.7
    attack: "T1005"
    count_min: 2
    any:
      - id: write-binary
      - id: write-read-binary
      - id: read-write-binary
      - id: read-binary
      - id: fread-func
      - id: fwrite-func

  # File manipulation with seeking
  - id: file-manipulation
    desc: "File content manipulation (read/write/seek)"
    crit: notable
    conf: 0.75
    attack: "T1005"
    all:
      - id: fseek-func
    count_min: 1
    any:
      - id: fread-func
      - id: fwrite-func
      - id: binary-file-ops
