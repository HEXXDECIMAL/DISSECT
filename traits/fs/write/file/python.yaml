# Python file write operations
# ATT&CK: T1105 (Ingress Tool Transfer), T1027 (Obfuscated Files)

defaults:
  file_types: [python]
  criticality: notable
  mbc: "C0016"
  attack: "T1105"

traits:
  # Binary file write - open with 'wb' mode
  - id: python-open-write-binary
    description: "Write binary file (open with 'wb')"
    confidence: 0.85
    condition:
      type: string
      # Matches: open(..., 'wb'), open(..., "wb"), with open(..., 'wb')
      regex: "open\\([^)]+['\"]wb['\"]\\)"

  # Binary append mode
  - id: python-open-append-binary
    description: "Append to binary file (open with 'ab')"
    confidence: 0.8
    condition:
      type: string
      regex: "open\\([^)]+['\"]ab['\"]\\)"

  # Write with pathlib
  - id: python-pathlib-write-bytes
    description: "Write bytes via pathlib"
    confidence: 0.85
    condition:
      type: string
      regex: "\\.write_bytes\\("

  # File content from HTTP response
  - id: python-write-response-content
    description: "Write HTTP response content to file"
    confidence: 0.9
    condition:
      type: string
      # Matches: f.write(response.content) or write(r.content)
      regex: "\\.write\\([^)]*\\.content\\)"

  # shutil.copyfileobj - streaming copy
  - id: python-shutil-copy
    description: "Copy file object (shutil.copyfileobj)"
    confidence: 0.75
    criticality: inert
    condition:
      type: string
      regex: "shutil\\.copyfileobj\\("

  # Write to temp directory
  - id: python-write-tmp
    description: "Write to /tmp directory"
    confidence: 0.85
    condition:
      type: string
      regex: "open\\([^)]*['\"]?/tmp/"

  # tempfile module usage
  - id: python-tempfile
    description: "Temporary file creation (tempfile module)"
    confidence: 0.7
    criticality: inert
    condition:
      type: string
      regex: "tempfile\\.(NamedTemporaryFile|mkstemp|mkdtemp)"

  # HTTP request pattern (requests or urllib)
  - id: python-http-request
    description: "HTTP request via requests or urllib"
    confidence: 0.8
    condition:
      type: string
      regex: "requests\\.(get|post)\\(|urllib\\.request\\.(urlopen|urlretrieve)"

  # Binary write pattern (open wb or write_bytes)
  - id: python-binary-write-pattern
    description: "Binary file write pattern"
    confidence: 0.85
    condition:
      type: string
      regex: "open\\([^)]+['\"]wb['\"]\\)|write_bytes\\("

  # os.chmod with executable permission
  - id: python-chmod-executable
    description: "Make file executable with os.chmod"
    confidence: 0.9
    condition:
      type: string
      regex: "os\\.chmod\\([^)]+0[o]?7"

composite_rules:
  # Download and write pattern (dropper behavior)
  - id: python-download-write
    description: "Download content and write to file"
    confidence: 0.9
    criticality: suspicious
    attack: "T1105"
    mbc: "B0024"
    requires_all:
      - id: python-http-request
      - id: python-binary-write-pattern

  # Write + make executable pattern
  - id: python-write-chmod-exec
    description: "Write file and make executable"
    confidence: 0.95
    criticality: suspicious
    attack: "T1222.002"
    requires_all:
      - id: python-open-write-binary
      - id: python-chmod-executable
