# Python file write operations
# ATT&CK: T1105 (Ingress Tool Transfer), T1027 (Obfuscated Files)

defaults:
  for: [python]
  crit: notable
  mbc: "C0016"
  attack: "T1105"

traits:
  # Binary file write - open with 'wb' mode
  - id: python-open-write-binary
    description: "Write binary file (open with 'wb')"
    conf: 0.85
    if:
      type: string
      # Matches: open(..., 'wb'), open(..., "wb"), with open(..., 'wb')
      regex: "open\\([^)]+['\"]wb['\"]\\)"

  # Binary append mode
  - id: python-open-append-binary
    description: "Append to binary file (open with 'ab')"
    conf: 0.8
    if:
      type: string
      regex: "open\\([^)]+['\"]ab['\"]\\)"

  # Write with pathlib
  - id: python-pathlib-write-bytes
    description: "Write bytes via pathlib"
    conf: 0.85
    if:
      type: string
      regex: "\\.write_bytes\\("

  # File content from HTTP response
  - id: python-write-response-content
    description: "Write HTTP response content to file"
    conf: 0.9
    if:
      type: string
      # Matches: f.write(response.content) or write(r.content)
      regex: "\\.write\\([^)]*\\.content\\)"

  # shutil.copyfileobj - streaming copy
  - id: python-shutil-copy
    description: "Copy file object (shutil.copyfileobj)"
    conf: 0.75
    crit: inert
    if:
      type: string
      regex: "shutil\\.copyfileobj\\("

  # Write to temp directory
  - id: python-write-tmp
    description: "Write to /tmp directory"
    conf: 0.85
    if:
      type: string
      regex: "open\\([^)]*['\"]?/tmp/"

  # === tempfile module atomic indicators ===
  - id: python-tempfile-named
    description: "tempfile.NamedTemporaryFile usage"
    conf: 0.6
    crit: inert
    if:
      type: string
      exact: "tempfile.NamedTemporaryFile"

  - id: python-tempfile-mkstemp
    description: "tempfile.mkstemp usage"
    conf: 0.6
    crit: inert
    if:
      type: string
      exact: "tempfile.mkstemp"

  - id: python-tempfile-mkdtemp
    description: "tempfile.mkdtemp usage"
    conf: 0.6
    crit: inert
    if:
      type: string
      exact: "tempfile.mkdtemp"

  # === HTTP request atomic indicators ===
  - id: python-requests-get
    description: "requests.get call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "requests\\.get\\("

  - id: python-requests-post
    description: "requests.post call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "requests\\.post\\("

  - id: python-urllib-urlopen
    description: "urllib.request.urlopen call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "urllib\\.request\\.urlopen"

  - id: python-urllib-urlretrieve
    description: "urllib.request.urlretrieve call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "urllib\\.request\\.urlretrieve"

  # os.chmod with executable permission
  - id: python-chmod-executable
    description: "Make file executable with os.chmod"
    conf: 0.9
    if:
      type: string
      regex: "os\\.chmod\\([^)]+0[o]?7"

composite_rules:
  - id: python-tempfile
    description: "Temporary file creation (tempfile module)"
    conf: 0.7
    crit: inert
    count: 1
    any:
      - id: python-tempfile-named
      - id: python-tempfile-mkstemp
      - id: python-tempfile-mkdtemp

  - id: python-http-request
    description: "HTTP request via requests or urllib"
    conf: 0.8
    count: 1
    any:
      - id: python-requests-get
      - id: python-requests-post
      - id: python-urllib-urlopen
      - id: python-urllib-urlretrieve

  - id: python-binary-write-pattern
    description: "Binary file write pattern"
    conf: 0.85
    count: 1
    any:
      - id: python-open-write-binary
      - id: python-pathlib-write-bytes

  # Download and write pattern (dropper behavior)
  - id: python-download-write
    description: "Download content and write to file"
    conf: 0.9
    crit: suspicious
    attack: "T1105"
    mbc: "B0024"
    all:
      - id: python-http-request
      - id: python-binary-write-pattern

  # Write + make executable pattern
  - id: python-write-chmod-exec
    description: "Write file and make executable"
    conf: 0.95
    crit: suspicious
    attack: "T1222.002"
    all:
      - id: python-open-write-binary
      - id: python-chmod-executable
