# Example Trait File with MBC and ATT&CK Mappings
#
# This file demonstrates how to add MBC (Malware Behavior Catalog) and
# MITRE ATT&CK IDs to trait definitions.
#
# Fields:
#   mbc_id: MBC identifier (B0XXX, E1XXX, C0XXX, F0XXX)
#   attack_id: ATT&CK technique ID (T1XXX or T1XXX.XXX for sub-technique)
#
# Both fields are optional. Use null or omit if no mapping exists.

# ============================================================================
# SIMPLE TRAITS (Atomic Observations)
# ============================================================================
# Simple traits can have both mbc_id and attack_id
# Set capability:true to also emit as a standalone capability

traits:
  # ===== Command Execution =====

  - id: exec/api/system
    description: Execute shell commands via system()
    mbc_id: "E1059"           # Command and Scripting Interpreter
    attack_id: "T1059"
    capability: true           # Also emit as capability
    criticality: high          # Dangerous function
    confidence: 0.9
    type: symbol
    pattern: system
    platforms: [all]

  - id: exec/api/popen
    description: Execute commands via popen()
    mbc_id: "E1059"
    attack_id: "T1059"
    capability: true
    criticality: high
    confidence: 0.8
    type: symbol
    pattern: popen
    platforms: [unix, linux, macos]

  - id: exec/api/execve
    description: Execute programs directly
    mbc_id: "E1059"
    attack_id: "T1059"
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: execve
    platforms: [unix, linux, macos]

  # ===== Network APIs =====

  - id: net/api/socket
    description: Uses socket API
    mbc_id: "C0001"           # Socket Communication (micro-behavior)
    attack_id: "T1071"        # Application Layer Protocol
    capability: true           # Networking is notable
    criticality: low           # Benign but notable
    confidence: 1.0
    type: symbol
    pattern: socket
    platforms: [all]

  - id: net/api/connect
    description: Uses connect API
    mbc_id: "C0001"
    attack_id: "T1071"
    capability: true
    criticality: low
    confidence: 1.0
    type: symbol
    pattern: connect
    platforms: [all]

  # ===== Anti-Analysis =====

  - id: anti-analysis/api/ptrace
    description: ptrace system call (debugging/tracing)
    mbc_id: "B0001"           # Debugger Detection
    attack_id: "T1622"        # Debugger Evasion Detection
    capability: true
    criticality: medium        # Suspicious but has legitimate uses
    confidence: 0.7
    type: symbol
    pattern: ptrace
    platforms: [linux, unix, macos]

  - id: anti-analysis/api/isatty
    description: Detect if running in terminal
    mbc_id: null              # No direct MBC mapping
    attack_id: "T1622"        # Related to debugging detection
    capability: false          # Too common to be standalone capability
    criticality: none          # Building block only
    confidence: 0.5
    type: symbol
    pattern: isatty
    platforms: [all]

  # ===== Building Blocks (No Capability Flag) =====

  - id: exec/shell/bin-sh
    description: References /bin/sh
    mbc_id: null              # Just a string reference
    attack_id: null
    capability: false          # Not meaningful alone
    criticality: none          # Building block only
    confidence: 1.0
    type: string
    exact: '/bin/sh'
    platforms: [unix, linux, macos]

  - id: exec/api/dup2
    description: Uses dup2 to redirect I/O
    mbc_id: null              # Not malicious by itself
    attack_id: null
    capability: false
    criticality: none
    confidence: 1.0
    type: symbol
    pattern: dup2
    platforms: [unix, linux, macos]

  # ===== Encoding (Building Blocks) =====

  - id: encoding/base64/decode
    description: Base64 decoding
    mbc_id: null              # Too common to be meaningful
    attack_id: null
    capability: false          # Needs context
    criticality: none
    confidence: 0.9
    type: symbol_or_string
    any:
      - b64decode
      - base64_decode
      - Buffer.from
      - atob
    platforms: [all]

  # ===== Exfiltration Infrastructure =====

  - id: exfil/telegram/api
    description: Telegram Bot API
    mbc_id: "B0030.001"       # C2 Communication: Send Data
    attack_id: "T1567.001"    # Exfiltration Over Web Service: Cloud Storage
    capability: true           # Clear exfil indicator
    criticality: high          # Dangerous
    confidence: 1.0
    type: string
    exact: 'api.telegram.org'
    platforms: [all]

  - id: exfil/telegram/send
    description: Telegram send methods
    mbc_id: null
    attack_id: null
    capability: false          # Building block
    criticality: none
    confidence: 0.9
    type: string
    regex: '/(sendMessage|sendDocument|sendPhoto)'
    platforms: [all]

  - id: exfil/discord/webhook
    description: Discord webhook URL
    mbc_id: "B0030.001"
    attack_id: "T1567.001"
    capability: true
    criticality: high
    confidence: 1.0
    type: string
    regex: '(discordapp\.com|discord\.com)/api/webhooks'
    platforms: [all]

  # ===== Dynamic Code Execution =====

  - id: exec/dynamic/eval
    description: Dynamic code evaluation
    mbc_id: "E1059"           # Command and Scripting Interpreter
    attack_id: "T1059"
    capability: true           # Very dangerous
    criticality: high
    confidence: 1.0
    type: symbol_or_string
    any:
      - eval
      - exec
      - Function
    platforms: [all]

  # ===== Crypto (Micro-Behaviors) =====

  - id: crypto/api/aes
    description: AES encryption API
    mbc_id: "C0027"           # Encrypt Data (micro-behavior)
    attack_id: "T1027"        # Obfuscated Files or Information
    capability: false          # Building block
    criticality: none
    confidence: 1.0
    type: symbol
    pattern: AES_encrypt
    platforms: [all]

  - id: crypto/hash/md5
    description: MD5 hash function
    mbc_id: "C0029"           # Cryptographic Hash (micro-behavior)
    attack_id: null           # Hashing isn't malicious
    capability: false
    criticality: none
    confidence: 1.0
    type: symbol
    pattern: MD5
    platforms: [all]

# ============================================================================
# COMPOSITE TRAITS (Behavioral Capabilities)
# ============================================================================
# Composite traits combine simple traits to detect specific behaviors
# These MUST reference other traits by ID (no inline conditions)

capabilities:
  # ===== Classic Reverse Shell =====

  - id: net/reverse-shell
    description: Reverse shell pattern (socket + dup2 + shell)
    mbc_id: "B0033"           # Process Injection (or could be B0030 C2)
    attack_id: "T1059"        # Command and Scripting Interpreter
    criticality: high          # Clearly malicious
    confidence: 0.95
    platforms: [linux, macos, unix]
    file_types: [elf, macho]

    requires_all:
      - trait: net/api/socket
      - trait: net/api/connect
      - trait: exec/api/dup2
      - trait: exec/shell/bin-sh

  # ===== Obfuscated Code Execution =====

  - id: exec/obfuscated/base64-eval
    description: Base64-encoded code execution (obfuscation)
    mbc_id: "B0008"           # Executable Code Obfuscation
    attack_id: "T1027"        # Obfuscated Files or Information
    criticality: medium        # Suspicious behavior
    confidence: 0.95
    platforms: [all]

    requires_all:
      - trait: encoding/base64/decode
      - trait: exec/dynamic/eval

  # ===== Telegram Exfiltration =====

  - id: c2/exfil/telegram
    description: Data exfiltration via Telegram
    mbc_id: "B0030.001"       # C2 Communication: Send Data
    attack_id: "T1567.001"    # Exfiltration Over Web Service
    criticality: high          # Clear exfiltration
    confidence: 0.95
    platforms: [all]

    requires_all:
      - trait: exfil/telegram/api
      - trait: exfil/telegram/send

  # ===== Discord Exfiltration =====

  - id: c2/exfil/discord
    description: Data exfiltration via Discord webhook
    mbc_id: "B0030.001"
    attack_id: "T1567.001"
    criticality: high
    confidence: 0.9
    platforms: [all]

    requires_count: 1
    conditions:
      - trait: exfil/discord/webhook

  # ===== Anti-Debugging via Ptrace =====

  - id: anti-analysis/debug/ptrace-self
    description: Anti-debugging via ptrace self-attachment
    mbc_id: "B0001.m01"       # Debugger Detection: Ptrace Self-Attachment
    attack_id: "T1622"
    criticality: high          # Clear anti-analysis
    confidence: 0.95
    platforms: [linux, unix]
    file_types: [elf]

    requires_all:
      - trait: anti-analysis/api/ptrace
      - type: symbol            # Also need getpid
        pattern: getpid
      - type: string            # And PTRACE constant
        regex: 'PTRACE_TRACEME|PT_DENY_ATTACH'

  # ===== VM Detection =====

  - id: anti-analysis/vm/detect
    description: Virtual machine environment detection
    mbc_id: "B0009"           # Virtual Machine Detection
    attack_id: "T1497.001"    # Virtualization/Sandbox Evasion: System Checks
    criticality: high
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # VM vendor strings
      - type: string
        regex: '(VMware|VirtualBox|VBOX|QEMU|Xen|Parallels)'
        case_insensitive: true

      # VM-specific hardware
      - type: string
        regex: '(VMXH|VBox|QEMU|virtio|vmmouse)'
        case_insensitive: true

  # ===== Download and Execute =====

  - id: exec/download-and-execute
    description: Download and execute remote code
    mbc_id: "E1105"           # Ingress Tool Transfer
    attack_id: "T1105"
    criticality: high
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Network download capability
      - type: symbol_or_string
        any:
          - curl
          - wget
          - URLSession
          - HttpURLConnection
          - 'http://'

      # Execution capability
      - type: symbol_or_string
        any:
          - system
          - exec
          - CreateProcess
          - chmod

  # ===== System Info Collection and Upload =====

  - id: c2/exfil/sysinfo-upload
    description: Uploads system information
    mbc_id: "B0030.006"       # C2 Communication: Send System Information
    attack_id: "T1082"        # System Information Discovery
    criticality: medium
    confidence: 0.85
    platforms: [all]

    requires_all:
      # System info functions
      - type: symbol_or_string
        any:
          - uname
          - hostname
          - getenv
          - gethostname

      # Upload/send functionality
      - type: string
        regex: '(http|post|send|upload)'

  # ===== Process Injection =====

  - id: process/inject/code
    description: Inject code into remote process
    mbc_id: "B0033"           # Process Injection
    attack_id: "T1055"
    criticality: high
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # Process access
      - type: symbol_or_string
        any:
          - ptrace
          - task_for_pid
          - OpenProcess
          - '/proc/[0-9]+/mem'

      # Memory manipulation
      - type: symbol_or_string
        any:
          - mach_vm_write
          - process_vm_writev
          - WriteProcessMemory
          - mprotect

      # Thread creation
      - type: symbol_or_string
        any:
          - thread_create
          - CreateRemoteThread
          - RtlCreateUserThread

# ============================================================================
# NOTES
# ============================================================================
#
# 1. MBC IDs:
#    - B0XXX: Behavioral objectives (anti-analysis, C2, injection)
#    - E1XXX: Enterprise ATT&CK equivalents
#    - C0XXX: Micro-behaviors (socket, crypto, file ops)
#    - F0XXX: Defense evasion
#
# 2. ATT&CK IDs:
#    - T1XXX: Parent technique
#    - T1XXX.XXX: Sub-technique (prefer when available)
#
# 3. Criticality Guidelines:
#    - none: Internal building blocks (dup2, /bin/sh, base64)
#    - low: Notable but benign (socket, connect)
#    - medium: Suspicious (obfuscation, anti-debug)
#    - high: Malicious indicators (reverse shell, exfiltration)
#
# 4. Capability Flag:
#    - true: Trait is meaningful standalone, emit as capability
#    - false: Building block only, used in composite traits
#
# 5. When to Use null:
#    - No MBC/ATT&CK mapping exists
#    - Too common/generic to map (base64, string references)
#    - Benign operations (MD5 hashing, file read)
#
# ============================================================================
