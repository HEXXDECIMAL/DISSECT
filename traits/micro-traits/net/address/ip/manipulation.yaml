defaults:
  for: [all]

traits:
  - id: dashed-ip-regex
    desc: Dashed IP Replacement pattern (regex)
    crit: notable
    conf: 0.9
    attack: "T1071.004"
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (member_expression
            property: (property_identifier) @prop
          )
          arguments: (arguments
            (regex (regex_pattern) @pat)
            (string (string_fragment) @repl)
          )
        )
        (#match? @prop "replace")
        (#match? @pat "\\.")
        (#match? @repl "-")
    unless:
      - id: metadata/builder/autotools::autotools
      - id: metadata/builder/autotools::configure-ac
      - id: metadata/builder/pip::setup-py
      - id: metadata/library::commander
    downgrade:
      any:
        - id: metadata/library::commander

  - id: dashed-ip-colon-regex
    desc: Dashed IP Replacement (colon to dash)
    crit: notable
    conf: 0.9
    attack: "T1071.004"
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (member_expression
            property: (property_identifier) @prop
          )
          arguments: (arguments
            (regex (regex_pattern) @pat)
            (string (string_fragment) @repl)
          )
        )
        (#match? @prop "replace")
        (#match? @pat ":")
        (#match? @repl "-")
    unless:
      - id: metadata/builder/autotools::autotools
      - id: metadata/builder/autotools::configure-ac
      - id: metadata/builder/pip::setup-py
      - id: metadata/library::commander
    downgrade:
      any:
        - id: metadata/library::commander

composite_rules:
  - id: dashed-ip-manipulation
    desc: IP Address Manipulation (Dashed format for DNS Exfil)
    crit: notable
    conf: 0.9
    any:
      - id: dashed-ip-regex
      - id: dashed-ip-colon-regex
    unless:
      - id: metadata/builder/autotools::autotools
      - id: metadata/builder/autotools::configure-ac
      - id: metadata/builder/pip::setup-py
      - id: metadata/library::commander
    downgrade:
      any:
        - id: metadata/library::commander
