# UI Delivery (JavaScript)
# Detects patterns related to dynamic ad or malicious content delivery

defaults:
  for: [javascript, typescript, html, package.json]

traits:
  - id: ui-delivery-class
    desc: JavaScript referring to .ui-delivery CSS class
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: ".ui-delivery"

  - id: dynamic-ad-injection-dom-api-a
    desc: DOM write API innerHTML or appendChild
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '(?i)(innerHTML|appendChild)'

  - id: dynamic-ad-injection-dom-api-b
    desc: DOM write API insertBefore
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '(?i)insertBefore'

  - id: dynamic-ad-injection-keyword-a
    desc: Delivery or ads keyword
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '(?i)\b(delivery|ads?)\b'

  - id: dynamic-ad-injection-keyword-b
    desc: Promo keyword
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '(?i)\bpromo\b'

  - id: news-delivery-pattern
    desc: Potential malicious news or content delivery pattern
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '(?i)\.(news|tips|rm|adb)\.js'

composite_rules:
  - id: dynamic-ad-injection-a
    desc: Dynamic ad injection innerHTML with keyword
    crit: notable
    conf: 0.7
    all:
      - id: dynamic-ad-injection-dom-api-a
      - id: dynamic-ad-injection-keyword-a

  - id: dynamic-ad-injection-b
    desc: Dynamic ad injection innerHTML with promo
    crit: notable
    conf: 0.7
    all:
      - id: dynamic-ad-injection-dom-api-a
      - id: dynamic-ad-injection-keyword-b

  - id: dynamic-ad-injection-c
    desc: Dynamic ad injection insertBefore with keyword
    crit: notable
    conf: 0.7
    all:
      - id: dynamic-ad-injection-dom-api-b
      - id: dynamic-ad-injection-keyword-a

  - id: dynamic-ad-injection-d
    desc: Dynamic ad injection insertBefore with promo
    crit: notable
    conf: 0.7
    all:
      - id: dynamic-ad-injection-dom-api-b
      - id: dynamic-ad-injection-keyword-b

  - id: dynamic-ad-injection
    desc: Potential dynamic ad or content injection pattern
    crit: notable
    conf: 0.7
    any:
      - id: dynamic-ad-injection-a
      - id: dynamic-ad-injection-b
      - id: dynamic-ad-injection-c
      - id: dynamic-ad-injection-d
