traits:
- id: apt-install-sudo
  desc: apt-get install sudo
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    substr: apt-get install -y sudo
  attack: T1548.004
- id: yum-install-sudo
  desc: yum install sudo
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    substr: yum install -y sudo
  attack: T1548.004
- id: dnf-install-sudo
  desc: dnf install sudo
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    substr: dnf install -y sudo
  attack: T1548.004
- id: multi-distro-apt-get-ref
  desc: apt-get reference
  crit: inert
  conf: 0.6
  for:
  - elf
  - shell
  size_max: 1000000
  if:
    type: string
    substr: apt-get
  unless:
  - type: raw
    regex: postgresql|libc|libgcc|libstdc\+\+
- id: multi-distro-yum-ref
  desc: yum reference
  crit: inert
  conf: 0.6
  for:
  - elf
  - shell
  size_max: 1000000
  if:
    type: string
    substr: yum
  unless:
  - type: raw
    regex: postgresql|libc|libgcc|libstdc\+\+
- id: multi-distro-dnf-ref
  desc: dnf reference
  crit: inert
  conf: 0.6
  for:
  - elf
  - shell
  size_max: 1000000
  if:
    type: string
    substr: dnf
  unless:
  - type: raw
    regex: postgresql|libc|libgcc|libstdc\+\+
- id: conditional-install-which-apt
  desc: which-based apt conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: which\s+apt-get\s+.{0,50}>/dev/null.{0,80}&&\s*apt-get
- id: conditional-install-which-yum
  desc: which-based yum conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: which\s+yum\s+.{0,50}>/dev/null.{0,80}&&\s*yum
- id: conditional-install-which-dnf
  desc: which-based dnf conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: which\s+dnf\s+.{0,50}>/dev/null.{0,80}&&\s*dnf
- id: conditional-install-type-apt
  desc: type-based apt conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: type\s+apt-get\s+.{0,50}>/dev/null.{0,80}&&\s*apt-get
- id: conditional-install-type-yum
  desc: type-based yum conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: type\s+yum\s+.{0,50}>/dev/null.{0,80}&&\s*yum
- id: conditional-install-type-dnf
  desc: type-based dnf conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: type\s+dnf\s+.{0,50}>/dev/null.{0,80}&&\s*dnf
- id: conditional-install-command-apt
  desc: command -v apt conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: command\s+-v\s+apt-get.{0,80}&&\s*apt-get
- id: conditional-install-command-yum
  desc: command -v yum conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: command\s+-v\s+yum.{0,80}&&\s*yum
- id: conditional-install-command-dnf
  desc: command -v dnf conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  if:
    type: string
    regex: command\s+-v\s+dnf.{0,80}&&\s*dnf
composite_rules:
- id: multi-distro-detection
  desc: Checks for multiple package managers
  crit: suspicious
  conf: 0.8
  for:
  - elf
  - shell
  needs: 2
  any:
  - id: multi-distro-apt-get-ref
  - id: multi-distro-yum-ref
  - id: multi-distro-dnf-ref
- id: conditional-install
  desc: Conditional installation based on availability
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  any:
  - id: conditional-install-which
  - id: conditional-install-command
  - id: conditional-install-type
- id: conditional-install-which
  desc: which-based conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  any:
  - id: conditional-install-which-apt
  - id: conditional-install-which-yum
  - id: conditional-install-which-dnf
- id: conditional-install-type
  desc: type-based conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  any:
  - id: conditional-install-type-apt
  - id: conditional-install-type-yum
  - id: conditional-install-type-dnf
- id: conditional-install-command
  desc: command -v conditional installation
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  any:
  - id: conditional-install-command-apt
  - id: conditional-install-command-yum
  - id: conditional-install-command-dnf
- id: apt-distro-targeting
  desc: apt-based distribution targeting
  any:
  - id: micro-traits/os/package-manager/install::which-apt-get
  - id: apt-install-sudo
- id: yum-distro-targeting
  desc: yum-based distribution targeting
  any:
  - id: micro-traits/os/package-manager/install::which-yum
  - id: yum-install-sudo
- id: dnf-distro-targeting
  desc: dnf-based distribution targeting
  any:
  - id: micro-traits/os/package-manager/install::which-dnf
  - id: dnf-install-sudo
- id: all-distros-targeted
  desc: All three major package manager families
  any:
  - id: apt-distro-targeting
  - id: yum-distro-targeting
  - id: dnf-distro-targeting
- id: multi-distro-sudo-deployment
  desc: Multi-distribution sudo deployment
  crit: suspicious
  conf: 0.9
  for:
  - elf
  - shell
  attack: T1548.004
  all:
  - id: conditional-install
  - id: all-distros-targeted
    needs: 2
- id: distribution-agnostic-attack
  desc: Distribution-agnostic attack infrastructure
  crit: suspicious
  conf: 0.85
  for:
  - elf
  - shell
  attack: T1195.001
  all:
  - id: multi-distro-detection
  - id: all-distros-targeted
    needs: 2
- id: kinsing-multi-distro-setup
  desc: Kinsing multi-distribution setup
  crit: suspicious
  conf: 0.9
  for:
  - elf
  - shell
  attack: T1548.004
  all:
  - id: well-known/malware/miner/kinsing-enhanced::kinsing-identifier
  - id: multi-distro-sudo-deployment
