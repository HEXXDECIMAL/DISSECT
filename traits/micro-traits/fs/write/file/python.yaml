# Python file write operations
# ATT&CK: T1105 (Ingress Tool Transfer), T1027 (Obfuscated Files)

defaults:
  for: [python]
  crit: notable
  mbc: "C0016"
  attack: "T1105"

traits:
  # Binary file write - open with 'wb' mode
  - id: python-open-write-binary
    desc: "Write binary file (open with"
    conf: 0.85
    if:
      type: string
      # Matches: open(..., 'wb'), open(..., "wb"), with open(..., 'wb')
      regex: "open\\(.{1,220}['\"]wb['\"]\\)"

  # Binary append mode
  - id: python-open-append-binary
    desc: "Append to binary file (open"
    conf: 0.8
    if:
      type: string
      regex: "open\\(.{1,220}['\"]ab['\"]\\)"

  # Write with pathlib
  - id: python-pathlib-write-bytes
    desc: "Write bytes via pathlib"
    conf: 0.85
    if:
      type: string
      regex: "\\.write_bytes\\("

  # File content from HTTP response
  - id: python-write-response-content
    desc: "Write HTTP response content to"
    conf: 0.9
    if:
      type: string
      # Matches: f.write(response.content) or write(r.content)
      regex: "\\.write\\(.{0,220}\\.content\\)"

  # shutil.copyfileobj - streaming copy
  - id: python-shutil-copy
    desc: "Copy file object (shutil.copyfileobj)"
    conf: 0.75
    crit: inert
    if:
      type: string
      regex: "shutil\\.copyfileobj\\("

  # Write to temp directory
  - id: python-write-tmp
    desc: "Write to /tmp directory"
    conf: 0.85
    if:
      type: string
      regex: "open\\(.{0,220}['\"]?/tmp/"

  # === tempfile module atomic indicators ===
  - id: python-tempfile-named
    desc: "tempfile.NamedTemporaryFile usage"
    conf: 0.6
    crit: inert
    if:
      type: string
      substr: "tempfile.NamedTemporaryFile"

  - id: python-tempfile-mkstemp
    desc: "tempfile.mkstemp usage"
    conf: 0.6
    crit: inert
    if:
      type: string
      substr: "tempfile.mkstemp"

  - id: python-tempfile-mkdtemp
    desc: "tempfile.mkdtemp usage"
    conf: 0.6
    crit: inert
    if:
      type: string
      substr: "tempfile.mkdtemp"

  # === HTTP request atomic indicators ===
  - id: python-requests-get
    desc: "requests.get call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "requests\\.get\\("

  - id: python-requests-post
    desc: "requests.post call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "requests\\.post\\("

  - id: python-urllib-urlopen
    desc: "urllib.request.urlopen call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "urllib\\.request\\.urlopen"

  - id: python-urllib-urlretrieve
    desc: "urllib.request.urlretrieve call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "urllib\\.request\\.urlretrieve"

composite_rules:
  - id: python-tempfile
    desc: "Temporary file creation (tempfile module)"
    conf: 0.7
    crit: inert
    any:
      - id: python-tempfile-named
      - id: python-tempfile-mkstemp
      - id: python-tempfile-mkdtemp

  - id: python-http-request
    desc: "HTTP request via requests or"
    conf: 0.8
    any:
      - id: python-requests-get
      - id: python-requests-post
      - id: python-urllib-urlopen
      - id: python-urllib-urlretrieve

  - id: python-binary-write-pattern
    desc: "Binary file write pattern"
    conf: 0.85
    any:
      - id: python-open-write-binary
      - id: python-pathlib-write-bytes

  # Download and write pattern (dropper behavior)
  - id: python-download-write
    desc: "Download content and write to"
    conf: 0.9
    crit: suspicious
    attack: "T1105"
    mbc: "B0024"
    all:
      - id: python-http-request
      - id: python-binary-write-pattern

  # Write + make executable pattern
  - id: python-write-chmod-exec
    desc: "Write file and make executable"
    conf: 0.95
    crit: suspicious
    attack: "T1222.002"
    all:
      - id: python-open-write-binary
      - id: micro-traits/fs/chmod/executable
