# Generic Exploitation Terminology
# Detects terms related to exploitation and vulnerability research

defaults:
  for: [all]

traits:
  - id: rop-ref
    desc: ROP (Return-Oriented Programming) reference
    crit: inert
    conf: 0.8
    if:
      type: string
      word: "ROP"

  - id: gadget-ref
    desc: ROP gadget reference
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "gadget"

  # === Prototype Pollution Gadget Detection ===
  # Detects JS functions that split dot-notation paths and dynamically set properties
  # without checking for __proto__, constructor, or prototype - enabling prototype pollution

  - id: js-path-split-single
    desc: Dot-notation path splitting (single quotes)
    crit: inert
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      substr: ".split('.')"

  - id: js-path-split-double
    desc: Dot-notation path splitting (double quotes)
    crit: inert
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      substr: '.split(".")'

  - id: js-dynamic-key-create
    desc: Dynamic property creation via bracket notation
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: raw
      regex: "\\w+\\[\\w+\\]\\s*=\\s*\\{\\}"

  - id: js-proto-guard-proto
    desc: Prototype pollution guard checks __proto__
    crit: inert
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      exact: "__proto__"

  - id: js-proto-guard-constructor
    desc: Prototype pollution guard checks constructor
    crit: inert
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      exact: "constructor"

  - id: js-proto-guard-prototype
    desc: Prototype pollution guard check present
    crit: inert
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      exact: "prototype"

composite_rules:
  - id: js-path-split
    desc: Dot-notation path splitting for property traversal
    crit: inert
    conf: 0.8
    for: [javascript]
    any:
      - id: js-path-split-single
      - id: js-path-split-double

  - id: js-proto-pollution-gadget
    desc: Prototype pollution gadget without guards
    crit: notable
    conf: 0.9
    attack: "T1195.002"
    for: [javascript]
    near_lines: 20
    all:
      - id: js-path-split
      - id: js-dynamic-key-create
    none:
      - id: js-proto-pollution-guard

  - id: js-proto-pollution-guard
    desc: Prototype pollution guard check present
    crit: inert
    conf: 0.9
    for: [javascript]
    any:
      - id: js-proto-guard-proto
      - id: js-proto-guard-constructor
      - id: js-proto-guard-prototype
