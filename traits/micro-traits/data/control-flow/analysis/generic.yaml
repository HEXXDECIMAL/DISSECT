# Generic Control Flow Patterns
# Detects loops and iteration structures

defaults:
  for: [all]

traits:
  # === Iteration/loop atomic indicators ===
  - id: for-loop-ast
    desc: for loop (AST)
    crit: inert
    conf: 0.3
    if:
      type: ast
      node: for
      regex: ".{0,1000}"

  - id: for-loop-content
    desc: for loop (content)
    crit: inert
    conf: 0.3
    if:
      type: raw
      # Matches 'for ' or 'for(' at start of line or after space/semicolon
      # and expects some iteration-like structure (e.g. ' in ', ';', or a bracket)
      regex: '(?m)(?:^|[;{}\s])for(?:\s+\w+\s+in\s+|\s*\(|(?:\s+\w+\s*:[^=]))'

  - id: for-loop-symbol
    desc: for_loop symbol
    crit: inert
    conf: 0.3
    if:
      type: symbol
      exact: "for_loop"

  - id: iter-symbol
    desc: iter symbol
    crit: inert
    conf: 0.3
    if:
      type: symbol
      exact: "iter"

  - id: while-loop
    desc: while loop pattern
    crit: inert
    conf: 0.3
    if:
      type: string
      word: "while"

  - id: glob-pattern
    desc: glob module pattern
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "glob\\."

composite_rules:
  - id: iteration-loop-pattern
    desc: "Iteration or loop pattern"
    crit: inert
    conf: 0.5
    any:
      - id: for-loop-ast
      - id: for-loop-content
      - id: for-loop-symbol
      - id: iter-symbol
      - id: while-loop
      - id: micro-traits/fs/directory/traverse::traverse-walk
      - id: glob-pattern
