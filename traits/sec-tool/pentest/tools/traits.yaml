# Security Tools - Penetration Testing Frameworks
# Used for both legitimate security testing and malicious purposes

composite_rules:
  # === Atomic: Metasploit ===

  - id: sec-tool/pentest/metasploit-ref
    description: Metasploit framework reference
    criticality: suspicious
    confidence: 0.8
    attack: "T1588.002"
    platforms: [all]
    condition:
      type: string
      exact: "metasploit"
      case_insensitive: true

  - id: sec-tool/pentest/msfpayload
    description: Metasploit payload generator reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1587.001"
    platforms: [all]
    condition:
      type: string
      exact: "msfpayload"

  - id: sec-tool/pentest/metasploit-url
    description: Metasploit website reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1588.002"
    platforms: [all]
    condition:
      type: string
      regex: "metasploit\\.com"

  - id: sec-tool/pentest/meterpreter
    description: Meterpreter payload reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1059"
    platforms: [windows]
    condition:
      type: string
      regex: "/meterpreter/"

  # === Atomic: Network Scanners ===

  - id: sec-tool/pentest/nmap-ref
    description: Nmap port scanner reference
    criticality: notable
    confidence: 0.6
    attack: "T1046"
    platforms: [all]
    condition:
      type: string
      # Word boundaries to avoid matching substrings like "dynmap", "unmap", etc.
      regex: "\\bnmap\\b"

  - id: sec-tool/pentest/masscan-ref
    description: Masscan port scanner reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1046"
    platforms: [all]
    condition:
      type: string
      exact: "masscan"

  - id: sec-tool/pentest/masscan-config
    description: Masscan configuration patterns
    criticality: suspicious
    confidence: 0.85
    attack: "T1046"
    platforms: [all]
    condition:
      type: yara
      source: |
        rule masscan_config {
          strings:
            $adapter_ip = "adapter-ip"
            $nocapture = "nocapture"
            $output_format = "output-format"
            $randomize_hosts = "randomize-hosts"
          condition:
            3 of them
        }

  # === Atomic: Tunneling Tools ===

  - id: sec-tool/pentest/chisel-ref
    description: Chisel TCP/UDP tunnel tool
    criticality: suspicious
    confidence: 0.9
    attack: "T1572"
    platforms: [all]
    condition:
      type: string
      exact: "jpillora/chisel"

  - id: sec-tool/pentest/chisel-functions
    description: Chisel tunnel tool function signatures
    criticality: suspicious
    confidence: 0.85
    attack: "T1572"
    platforms: [all]
    condition:
      type: yara
      source: |
        rule chisel_functions {
          strings:
            $f1 = "tlsLetsEncrypt"
            $f2 = "authUser"
            $f3 = "handleWebsocket"
            $f4 = "tlsKeyCert"
            $f5 = "tunnel_out_ssh"
          condition:
            3 of them
        }

  # === Atomic: Venom RAT ===

  - id: sec-tool/pentest/venom-ref
    description: Venom multi-hop proxy/RAT reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1090"
    platforms: [all]
    condition:
      type: string
      regex: "Dliv3/Venom|/Venom/agent|venom_agent"

  # === Atomic: Web Recon ===

  - id: sec-tool/recon/dirbuster
    description: DirBuster directory brute-force tool
    criticality: suspicious
    confidence: 0.8
    attack: "T1595.003"
    platforms: [all]
    condition:
      type: string
      exact: "dirbuster"

  # === Atomic: SMB Tools ===

  - id: sec-tool/pentest/smbexec
    description: SMBExec remote command execution
    criticality: suspicious
    confidence: 0.9
    attack: "T1021.002"
    platforms: [all]
    condition:
      type: string
      regex: "NTLM HASH|HASH PASS: Substituting"

  # === Atomic: Process Snooping ===

  - id: sec-tool/pentest/pspy-ref
    description: pspy process snooping tool
    criticality: suspicious
    confidence: 0.9
    attack: "T1057"
    platforms: [linux]
    condition:
      type: string
      exact: "dominicbreuker/pspy"

  - id: sec-tool/pentest/pspy-functions
    description: pspy tool function signatures
    criticality: suspicious
    confidence: 0.8
    attack: "T1057"
    platforms: [linux]
    condition:
      type: yara
      source: |
        rule pspy_functions {
          strings:
            $f1 = "startFSW"
            $f2 = "startPSS"
            $f3 = "triggerEvery"
          condition:
            2 of them
        }

  - id: sec-tool/pentest/metasploit-payload
    description: Metasploit payload detected
    criticality: suspicious
    confidence: 0.95
    attack: "T1587.001"
    file_types: [all]
    requires_count: 2
    conditions:
      - type: trait
        id: sec-tool/pentest/msfpayload
      - type: trait
        id: sec-tool/pentest/metasploit-url
      - type: string
        exact: "Payload: "
      - type: string
        exact: "/shh/bin"

  - id: sec-tool/pentest/masscan-execution
    description: Masscan scanner execution
    criticality: suspicious
    confidence: 0.9
    attack: "T1046"
    platforms: [linux]
    file_types: [elf]
    requires_all:
      - type: trait
        id: sec-tool/pentest/masscan-ref
    requires_any:
      - type: symbol
        pattern: "^_?execve$"
      - type: symbol
        pattern: "^_?system$"
      - type: string
        exact: "exec.(*Cmd).Run"
