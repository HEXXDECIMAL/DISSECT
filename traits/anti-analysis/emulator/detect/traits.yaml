# VM/Emulator Detection
# MBC: OB0001 (Anti-Behavioral Analysis) â†’ B0009 (Virtual Machine Detection)
# ATT&CK: T1497.001 (Virtualization/Sandbox Evasion: System Checks)

traits:
  # Single VM vendor strings are notable - network tools legitimately know about VMware
  # Multiple vendor checks indicate deliberate VM detection (see combos.yaml)
  - id: vmware-string
    description: VMware vendor string detection
    criticality: notable
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.6
    condition:
      type: string
      exact: "VMware"

  # === VirtualBox atomic indicators ===
  - id: virtualbox-word
    description: VirtualBox string detection
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)VirtualBox"

  - id: vbox-string
    description: VBOX string detection
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)VBOX"

  # === QEMU atomic indicators ===
  - id: qemu-upper
    description: QEMU uppercase string
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      exact: "QEMU"

  - id: qemu-lower
    description: qemu lowercase string
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      exact: "qemu"

  # === VM hardware atomic indicators ===
  - id: vmxh-string
    description: VMXH hardware string
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      exact: "VMXH"

  - id: virtio-string
    description: virtio hardware string
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)virtio"

  - id: vmmouse-string
    description: vmmouse hardware string
    criticality: inert
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)vmmouse"

  # === CPU vendor atomic indicators ===
  - id: genuineintel
    description: GenuineIntel CPU vendor string
    criticality: inert
    mbc: "B0009"
    confidence: 0.4
    condition:
      type: string
      exact: "GenuineIntel"

  - id: authenticamd
    description: AuthenticAMD CPU vendor string
    criticality: inert
    mbc: "B0009"
    confidence: 0.4
    condition:
      type: string
      exact: "AuthenticAMD"

composite_rules:
  # VirtualBox string composite
  - id: virtualbox-string
    description: VirtualBox vendor string detection
    criticality: notable
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.6
    requires_count: 1
    conditions:
      - id: virtualbox-word
      - id: vbox-string

  # QEMU string composite
  - id: qemu-string
    description: QEMU vendor string detection
    criticality: notable
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.6
    requires_count: 1
    conditions:
      - id: qemu-upper
      - id: qemu-lower

  # VM hardware composite
  - id: vm-hardware
    description: VM-specific hardware strings
    criticality: notable
    mbc: "B0009"
    attack: "T1497.001"
    confidence: 0.6
    requires_count: 1
    conditions:
      - id: vmxh-string
      - id: vbox-string
      - id: virtio-string
      - id: vmmouse-string

  # CPU vendor composite
  - id: cpu-vendor
    description: CPU vendor string checks (Intel/AMD vs VM)
    criticality: notable
    mbc: "B0009"
    confidence: 0.5
    requires_count: 1
    conditions:
      - id: genuineintel
      - id: authenticamd
