# Debugger Detection
# MBC: OB0001 (Anti-Behavioral Analysis) â†’ B0001 (Debugger Detection)
# ATT&CK: T1622 (Debugger Evasion)
# NOTE: /proc/self/status is defined in fs/proc/process/linux.yaml (process-self-status)

traits:
  # Unix/Linux
  - id: ptrace
    desc: ptrace system call (debugging/tracing)
    crit: notable
    mbc: "B0001"
    attack: "T1622"
    conf: 0.7
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      pattern: ptrace
    platforms: [linux, unix, macos]

  - id: getpid
    desc: getpid system call (process ID retrieval)
    crit: notable
    mbc: "B0001"
    attack: "T1622"
    conf: 0.5
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      pattern: getpid
    platforms: [linux, unix, macos]

  # === ptrace constant atomic indicators ===
  - id: ptrace-traceme
    desc: PTRACE_TRACEME constant
    crit: notable
    mbc: "B0001.m01"
    attack: "T1622"
    conf: 0.7
    if:
      type: string
      exact: "PTRACE_TRACEME"
    platforms: [linux, unix]

  - id: pt-deny-attach
    desc: PT_DENY_ATTACH constant
    crit: notable
    mbc: "B0001.m01"
    attack: "T1622"
    conf: 0.7
    if:
      type: string
      exact: "PT_DENY_ATTACH"
    platforms: [macos]

  - id: isatty
    desc: Detect if running in terminal
    crit: notable
    mbc: "B0001"
    attack: "T1622"
    conf: 0.5
    for: [elf, macho, so, dylib, c]
    if:
      type: symbol
      pattern: isatty
    platforms: [all]

  - id: process-inspection
    desc: "Process inspection pattern (potential anti-debug)"
    crit: notable
    conf: 0.75
    attack: "T1622"
    if:
      type: yara
      source: |
        rule process_inspection {
          strings:
            $ptrace = "ptrace" ascii fullword
            $proc1 = "/proc/self/status" ascii fullword
            $proc2 = "/proc/self/maps" ascii fullword
            $proc3 = "TracerPid" ascii fullword
          condition:
            $ptrace or any of ($proc*)
        }

  - id: ld-debug
    desc: LD_DEBUG environment variable check
    crit: notable
    mbc: "B0001"
    attack: "T1622"
    conf: 0.6
    if:
      type: string
      exact: "LD_DEBUG"
    platforms: [linux]

  # Windows
  - id: win-isdebuggerpresent
    desc: Windows IsDebuggerPresent API
    crit: suspicious
    mbc: "B0001"
    attack: "T1622"
    conf: 0.9
    if:
      type: string
      exact: "IsDebuggerPresent"
    platforms: [windows]
    for: [pe, dll]

  - id: win-checkremotedebugger
    desc: Windows CheckRemoteDebuggerPresent API
    crit: suspicious
    mbc: "B0001"
    attack: "T1622"
    conf: 0.9
    if:
      type: string
      exact: "CheckRemoteDebuggerPresent"
    platforms: [windows]

  - id: win-ntqueryinfo
    desc: NtQueryInformationProcess for debugger detection
    crit: suspicious
    mbc: "B0001"
    attack: "T1622"
    conf: 0.85
    if:
      type: string
      exact: "NtQueryInformationProcess"
    platforms: [windows]

  - id: win-unhandledexception
    desc: UnhandledExceptionFilter for anti-debugging
    crit: suspicious
    mbc: "B0001"
    attack: "T1622"
    conf: 0.7
    if:
      type: string
      exact: "UnhandledExceptionFilter"
    platforms: [windows]

  - id: win-queryperformance
    desc: QueryPerformanceCounter timing check
    crit: suspicious
    mbc: "B0001"
    attack: "T1622"
    conf: 0.6
    if:
      type: string
      exact: "QueryPerformanceCounter"
    platforms: [windows]

composite_rules:
  # ptrace constant composite
  - id: ptrace-traceme-or-deny
    desc: PTRACE_TRACEME or PT_DENY_ATTACH anti-debugging constants
    crit: suspicious
    mbc: "B0001.m01"
    attack: "T1622"
    conf: 0.8
    count: 1
    any:
      - id: ptrace-traceme
      - id: pt-deny-attach
