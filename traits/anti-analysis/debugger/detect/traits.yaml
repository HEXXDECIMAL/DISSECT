# Debugger Detection
# MBC: OB0001 (Anti-Behavioral Analysis) â†’ B0001 (Debugger Detection)
# ATT&CK: T1622 (Debugger Evasion)
# NOTE: /proc/self/status is defined in fs/proc/process/linux.yaml (process-self-status)

traits:
  # Unix/Linux
  - id: ptrace
    description: ptrace system call (debugging/tracing)
    criticality: notable
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.7
    file_types: [elf, macho, so, dylib, c]
    condition:
      type: symbol
      pattern: ptrace
    platforms: [linux, unix, macos]

  - id: getpid
    description: getpid system call (process ID retrieval)
    criticality: notable
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.5
    file_types: [elf, macho, so, dylib, c]
    condition:
      type: symbol
      pattern: getpid
    platforms: [linux, unix, macos]

  - id: ptrace-traceme-or-deny
    description: PTRACE_TRACEME or PT_DENY_ATTACH anti-debugging constants
    criticality: suspicious
    mbc: "B0001.m01"
    attack: "T1622"
    confidence: 0.8
    condition:
      type: string
      regex: "PTRACE_TRACEME|PT_DENY_ATTACH"
    platforms: [linux, unix, macos]

  - id: isatty
    description: Detect if running in terminal
    criticality: notable
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.5
    file_types: [elf, macho, so, dylib, c]
    condition:
      type: symbol
      pattern: isatty
    platforms: [all]

  - id: process-inspection
    description: "Process inspection pattern (potential anti-debug)"
    criticality: notable
    confidence: 0.75
    attack: "T1622"
    condition:
      type: yara
      source: |
        rule process_inspection {
          strings:
            $ptrace = "ptrace" ascii fullword
            $proc1 = "/proc/self/status" ascii fullword
            $proc2 = "/proc/self/maps" ascii fullword
            $proc3 = "TracerPid" ascii fullword
          condition:
            $ptrace or any of ($proc*)
        }

  - id: ld-debug
    description: LD_DEBUG environment variable check
    criticality: notable
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.6
    condition:
      type: string
      exact: "LD_DEBUG"
    platforms: [linux]

  # Windows
  - id: win-isdebuggerpresent
    description: Windows IsDebuggerPresent API
    criticality: suspicious
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.9
    condition:
      type: string
      exact: "IsDebuggerPresent"
    platforms: [windows]
    file_types: [pe, dll]

  - id: win-checkremotedebugger
    description: Windows CheckRemoteDebuggerPresent API
    criticality: suspicious
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.9
    condition:
      type: string
      exact: "CheckRemoteDebuggerPresent"
    platforms: [windows]

  - id: win-ntqueryinfo
    description: NtQueryInformationProcess for debugger detection
    criticality: suspicious
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.85
    condition:
      type: string
      exact: "NtQueryInformationProcess"
    platforms: [windows]

  - id: win-unhandledexception
    description: UnhandledExceptionFilter for anti-debugging
    criticality: suspicious
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.7
    condition:
      type: string
      exact: "UnhandledExceptionFilter"
    platforms: [windows]

  - id: win-queryperformance
    description: QueryPerformanceCounter timing check
    criticality: suspicious
    mbc: "B0001"
    attack: "T1622"
    confidence: 0.6
    condition:
      type: string
      exact: "QueryPerformanceCounter"
    platforms: [windows]
