# Virtual Machine / Hypervisor Detection
# ATT&CK: T1497.001 (Virtualization/Sandbox Evasion: System Checks)
# Detects checks for VM/hypervisor presence

defaults:
  attack: "T1497.001"

traits:
  # === Xen hypervisor atomic indicators ===
  - id: vendor-xen-upper
    desc: XEN hypervisor (uppercase)
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "XEN"

  - id: vendor-xen-title
    desc: Xen hypervisor (titlecase)
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "Xen"

  # === KVM hypervisor atomic indicators ===
  - id: vendor-kvm-upper
    desc: KVM hypervisor (uppercase)
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "KVM"

  - id: vendor-kvm-repeat
    desc: KVMKVMKVM hypervisor signature
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "KVMKVMKVM"

  - id: vendor-vmware
    desc: VMware hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: VMware
      case_insensitive: true

  # === VirtualBox hypervisor atomic indicators ===
  - id: vendor-virtualbox
    desc: VirtualBox hypervisor vendor string
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: VirtualBox
      case_insensitive: true

  - id: vendor-vbox-short
    desc: VBOX hypervisor short string
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: VBOX
      case_insensitive: true

  # === Hyper-V hypervisor atomic indicators ===
  - id: vendor-hyperv-dash
    desc: Hyper-V hypervisor vendor string
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "Hyper-V"
      case_insensitive: true

  - id: vendor-microsoft-hv
    desc: Microsoft Hv hypervisor string
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "Microsoft Hv"
      case_insensitive: true

  - id: vendor-qemu
    desc: QEMU hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: QEMU

  - id: vendor-parallels
    desc: Parallels hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: Parallels

  - id: vendor-bhyve
    desc: bhyve hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: bhyve

  # === CPUID hypervisor bit check ===
  - id: cpuid-check
    desc: CPUID instruction for hypervisor detection
    crit: suspicious
    conf: 0.9
    for: [python, shell]
    if:
      type: string
      regex: '/proc/cpuinfo.*hypervisor|cpuid|hypervisor\s*flag'

  # === DMI/SMBIOS checks (atomic) ===
  - id: dmi-dmidecode
    desc: dmidecode command for hardware info
    crit: inert
    conf: 0.5
    for: [python, shell]
    if:
      type: string
      exact: dmidecode

  - id: dmi-sysfs
    desc: DMI sysfs path access
    crit: inert
    conf: 0.6
    for: [python, shell]
    if:
      type: string
      exact: /sys/class/dmi

  - id: dmi-product-name
    desc: DMI product_name field
    crit: inert
    conf: 0.5
    for: [python, shell]
    if:
      type: string
      exact: product_name

  - id: dmi-sys-vendor
    desc: DMI sys_vendor field
    crit: inert
    conf: 0.5
    for: [python, shell]
    if:
      type: string
      exact: sys_vendor

  - id: dmi-bios-vendor
    desc: DMI bios_vendor field
    crit: inert
    conf: 0.5
    for: [python, shell]
    if:
      type: string
      exact: bios_vendor

  # === VM-specific files (atomic) ===
  - id: file-vbox-guest
    desc: VirtualBox guest additions file
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: VBoxGuest

  - id: file-vbox-mouse
    desc: VirtualBox mouse driver file
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: VBoxMouse

  - id: file-vbox-sf
    desc: VirtualBox shared folders file
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: VBoxSF

  - id: file-vmware-tools
    desc: VMware tools binary
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: vmware-tools

  - id: file-vmtoolsd
    desc: VMware tools daemon
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: vmtoolsd

  - id: file-vmhgfs
    desc: VMware host-guest filesystem
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: /vmhgfs

  - id: file-qemu-ga
    desc: QEMU guest agent
    crit: inert
    conf: 0.8
    for: [python, shell, javascript]
    if:
      type: string
      exact: qemu-ga

  - id: file-dev-vda
    desc: QEMU/KVM virtio disk device
    crit: inert
    conf: 0.7
    for: [python, shell, javascript]
    if:
      type: string
      exact: /dev/vda

  # === VM MAC address prefixes (atomic) ===
  - id: mac-vmware-1
    desc: VMware MAC prefix 00:0c:29
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "00:0c:29"
      case_insensitive: true

  - id: mac-vmware-2
    desc: VMware MAC prefix 00:50:56
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "00:50:56"
      case_insensitive: true

  - id: mac-vmware-3
    desc: VMware MAC prefix 00:05:69
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "00:05:69"
      case_insensitive: true

  - id: mac-vbox
    desc: VirtualBox MAC prefix 08:00:27
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "08:00:27"
      case_insensitive: true

  - id: mac-xen
    desc: Xen MAC prefix 00:16:3e
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "00:16:3e"
      case_insensitive: true

  - id: mac-hyperv
    desc: Hyper-V MAC prefix 00:15:5d
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "00:15:5d"
      case_insensitive: true

  - id: mac-parallels
    desc: Parallels MAC prefix 00:1c:42
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "00:1c:42"
      case_insensitive: true

  - id: mac-qemu
    desc: QEMU/KVM MAC prefix 52:54:00
    crit: inert
    conf: 0.8
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "52:54:00"
      case_insensitive: true

  # === Hardware model VM check ===
  - id: hardware-model
    desc: Checks hardware model for VM indicators
    crit: suspicious
    conf: 0.8
    for: [python, shell]
    if:
      type: string
      regex: "system_profiler.*Model|wmic.*computersystem.*model|/sys/devices/virtual"

  # === Cloud provider metadata check ===
  - id: cloud-metadata
    desc: Cloud provider metadata access (VM detection)
    crit: notable
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      regex: '169\.254\.169\.254|metadata\.google\.internal|169\.254\.169\.123'

  # === Container detection (atomic) ===
  - id: docker-env
    desc: Docker environment file
    crit: inert
    conf: 0.7
    for: [python, shell, javascript]
    if:
      type: string
      exact: /.dockerenv

  - id: docker-sock
    desc: Docker socket path
    crit: inert
    conf: 0.7
    for: [python, shell, javascript]
    if:
      type: string
      exact: /run/docker.sock

  - id: cgroup-check
    desc: Process cgroup check
    crit: inert
    conf: 0.6
    for: [python, shell, javascript]
    if:
      type: string
      exact: /proc/1/cgroup

  - id: k8s-service
    desc: Kubernetes service environment variable
    crit: inert
    conf: 0.7
    for: [python, shell, javascript]
    if:
      type: string
      exact: KUBERNETES_SERVICE

  - id: k8s-secrets
    desc: Kubernetes secrets path
    crit: inert
    conf: 0.7
    for: [python, shell, javascript]
    if:
      type: string
      exact: /var/run/secrets/kubernetes

  # === Exit indicators for evasion ===
  - id: exit-call
    desc: Generic exit call
    crit: inert
    conf: 0.3
    for: [python, shell, javascript]
    if:
      type: string
      exact: exit

  - id: sys-exit
    desc: Python sys.exit call
    crit: inert
    conf: 0.3
    for: [python]
    if:
      type: string
      exact: sys.exit

  - id: process-exit
    desc: Node.js process.exit call
    crit: inert
    conf: 0.3
    for: [javascript, typescript]
    if:
      type: string
      exact: process.exit

composite_rules:
  # Xen vendor composite
  - id: vendor-xen
    desc: Xen hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    count: 1
    any:
      - id: vendor-xen-upper
      - id: vendor-xen-title

  # KVM vendor composite
  - id: vendor-kvm
    desc: KVM hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    count: 1
    any:
      - id: vendor-kvm-upper
      - id: vendor-kvm-repeat

  # VirtualBox vendor composite
  - id: vendor-vbox
    desc: VirtualBox hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    count: 1
    any:
      - id: vendor-virtualbox
      - id: vendor-vbox-short

  # Hyper-V vendor composite
  - id: vendor-hyperv
    desc: Hyper-V hypervisor vendor string
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    count: 1
    any:
      - id: vendor-hyperv-dash
      - id: vendor-microsoft-hv

  # Hypervisor vendor strings
  - id: hypervisor-vendor
    desc: Checks for hypervisor vendor strings
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: vendor-xen
      - id: vendor-kvm
      - id: vendor-vmware
      - id: vendor-vbox
      - id: vendor-hyperv
      - id: vendor-qemu
      - id: vendor-parallels
      - id: vendor-bhyve

  # DMI/SMBIOS VM detection
  - id: dmi-check
    desc: DMI/SMBIOS check for VM detection
    crit: suspicious
    conf: 0.85
    count: 1
  # VM-specific file checks
    any:
      - id: dmi-sysfs
      - id: dmi-dmidecode
      - id: dmi-product-name
      - id: dmi-sys-vendor
      - id: dmi-bios-vendor
  - id: file-check
    desc: Checks for VM-specific files
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: file-vbox-guest
      - id: file-vbox-mouse
      - id: file-vbox-sf
      - id: file-vmware-tools
      - id: file-vmtoolsd
      - id: file-vmhgfs
      - id: file-qemu-ga
      - id: file-dev-vda

  # VM MAC address prefixes
  - id: mac-prefix
    desc: Checks for VM MAC address prefixes
    crit: suspicious
    conf: 0.85
    count: 1
    any:
      - id: mac-vmware-1
      - id: mac-vmware-2
      - id: mac-vmware-3
      - id: mac-vbox
      - id: mac-xen
      - id: mac-hyperv
      - id: mac-parallels
      - id: mac-qemu

  # Docker/container detection
  - id: container-check
    desc: Container environment detection
    crit: notable
    conf: 0.75
    count: 1
    any:
      - id: docker-env
      - id: docker-sock
      - id: cgroup-check
      - id: k8s-service
      - id: k8s-secrets

  # Comprehensive VM evasion (3+ VM indicators + exit)
  - id: comprehensive-evasion
    desc: Multiple VM detection techniques (evasion attempt)
    crit: suspicious
    conf: 0.95
    count: 3
    any:
      - id: vendor-vmware
      - id: vendor-vbox
      - id: vendor-qemu
      - id: vendor-xen
      - id: mac-vmware-1
      - id: mac-vbox
      - id: docker-env
      - id: file-vmtoolsd
      - id: exit-call
      - id: sys-exit
      - id: process-exit
