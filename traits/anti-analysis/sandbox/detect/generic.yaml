# Sandbox Detection
# MBC: B0007 (Sandbox Detection)
# ATT&CK: T1497

traits:
  - id: sandbox
    description: Sandbox detection techniques
    criticality: suspicious
    confidence: 0.66
    mbc: "B0007"
    attack: "T1497"
    # Exclude JS - data libraries like faker.js have random words that match
    file_types: [elf, macho, pe, shell, python]
    condition:
      type: yara
      source: |
        rule sandbox_detect {
          strings:
            // Specific sandbox product names (not generic "sandbox" word)
            $cuckoo = "cuckoo" nocase fullword
            $joe = "joe sandbox" nocase
            $any_run = "any.run"
            $hybrid = "hybrid-analysis" nocase
            $virustotal = "virustotal" nocase
            // Analysis tools commonly checked for
            $wireshark = "wireshark" nocase fullword
            $fiddler = "fiddler" nocase fullword
            $procmon = "procmon" nocase fullword
            $processhacker = "process hacker" nocase
            $x64dbg = "x64dbg" nocase fullword
            $ollydbg = "ollydbg" nocase fullword
            // Sandbox detection file paths
            $sandbox_path = /C:\\(sandbox|analysis|malware)/i
          condition:
            // Require 2+ indicators to avoid false positives on single words
            2 of them
        }

  # JavaScript/Node.js sandbox detection
  - id: js-timing
    description: Sleep acceleration detection (sandbox evasion)
    criticality: suspicious
    confidence: 0.8
    mbc: "B0007"
    attack: "T1497"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "atomic-sleep|Date\\.now\\(\\).*setTimeout|performance\\.now\\(\\).*setTimeout"

  - id: js-debugger
    description: JavaScript debugger detection
    criticality: suspicious
    confidence: 0.85
    mbc: "B0001"
    attack: "T1622"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule js_debugger_detect {
          strings:
            $debug1 = "debugger" ascii
            $func_check = "function.toString" ascii
            $console_check = /console\.(log|warn|error)\.toString/
            $devtools1 = "__REACT_DEVTOOLS" ascii
            $devtools2 = "__VUE_DEVTOOLS" ascii
          condition:
            2 of them
        }

  - id: js-headless
    description: Headless browser detection
    criticality: suspicious
    confidence: 0.8
    mbc: "B0007"
    attack: "T1497"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "navigator\\.webdriver|navigator\\.plugins\\.length\\s*===?\\s*0|window\\.outerWidth\\s*===?\\s*0"

  # NOTE: VM detection traits are in anti-analysis/vm/
  # Use anti-analysis/vm directory reference for VM/hypervisor detection
