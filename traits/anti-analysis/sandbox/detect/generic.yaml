# Sandbox Detection
# MBC: B0007 (Sandbox Detection)
# ATT&CK: T1497

defaults:
  mbc: "B0007"
  attack: "T1497"

traits:
  # === Sandbox product names ===
  - id: cuckoo
    desc: Cuckoo sandbox reference
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: '\bcuckoo\b'
      case_insensitive: true

  - id: joe-sandbox
    desc: Joe Sandbox reference
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      exact: "joe sandbox"
      case_insensitive: true

  - id: any-run
    desc: Any.run sandbox reference
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      exact: "any.run"

  - id: hybrid-analysis
    desc: Hybrid Analysis sandbox reference
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      exact: "hybrid-analysis"
      case_insensitive: true

  - id: virustotal
    desc: VirusTotal reference
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      exact: virustotal
      case_insensitive: true

  # === Analysis tools ===
  - id: wireshark
    desc: Wireshark network analyzer
    crit: inert
    conf: 0.5
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: '\bwireshark\b'
      case_insensitive: true

  - id: fiddler
    desc: Fiddler proxy tool
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: '\bfiddler\b'
      case_insensitive: true

  - id: procmon
    desc: Process Monitor tool
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: '\bprocmon\b'
      case_insensitive: true

  - id: process-hacker
    desc: Process Hacker tool
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      exact: "process hacker"
      case_insensitive: true

  - id: x64dbg
    desc: x64dbg debugger
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: '\bx64dbg\b'
      case_insensitive: true

  - id: ollydbg
    desc: OllyDbg debugger
    crit: inert
    conf: 0.6
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: '\bollydbg\b'
      case_insensitive: true

  - id: sandbox-path
    desc: Sandbox/analysis file path
    crit: notable
    conf: 0.75
    for: [elf, macho, pe, shell, python]
    if:
      type: string
      regex: 'C:\\(sandbox|analysis|malware)'
      case_insensitive: true

  # JavaScript/Node.js sandbox detection (atomic)
  - id: js-atomic-sleep
    desc: atomic-sleep module
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "atomic-sleep"

  - id: js-date-now-timeout
    desc: Date.now with setTimeout
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      regex: "Date\\.now\\(\\).*setTimeout"

  - id: js-performance-now-timeout
    desc: performance.now with setTimeout
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      regex: "performance\\.now\\(\\).*setTimeout"

  # === JS debugger detection atomic indicators ===
  - id: js-debugger-stmt
    desc: JavaScript debugger statement
    crit: inert
    conf: 0.4
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: debugger

  - id: js-func-tostring
    desc: Function.toString check
    crit: inert
    conf: 0.5
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: function.toString

  - id: js-console-log-tostring
    desc: console.log.toString check
    crit: inert
    conf: 0.5
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: "console.log.toString"

  - id: js-console-warn-tostring
    desc: console.warn.toString check
    crit: inert
    conf: 0.5
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: "console.warn.toString"

  - id: js-console-error-tostring
    desc: console.error.toString check
    crit: inert
    conf: 0.5
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: "console.error.toString"

  - id: js-react-devtools
    desc: React DevTools detection
    crit: inert
    conf: 0.5
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: __REACT_DEVTOOLS

  - id: js-vue-devtools
    desc: Vue DevTools detection
    crit: inert
    conf: 0.5
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    if:
      type: string
      exact: __VUE_DEVTOOLS

  # Headless browser detection (atomic)
  - id: js-navigator-webdriver
    desc: navigator.webdriver check
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "navigator.webdriver"

  - id: js-plugins-length-zero
    desc: navigator.plugins.length zero check
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      regex: "navigator\\.plugins\\.length\\s*===?\\s*0"

  - id: js-outerwidth-zero
    desc: window.outerWidth zero check
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      regex: "window\\.outerWidth\\s*===?\\s*0"

composite_rules:
  # JS timing detection composite
  - id: js-timing
    desc: Sleep acceleration detection (sandbox evasion)
    crit: suspicious
    conf: 0.8
    for: [javascript, typescript]
    count: 1
    any:
      - id: js-atomic-sleep
      - id: js-date-now-timeout
      - id: js-performance-now-timeout

  # JS headless browser detection composite
  - id: js-headless
    desc: Headless browser detection
    crit: suspicious
    conf: 0.8
    for: [javascript, typescript]
    count: 1
    any:
      - id: js-navigator-webdriver
      - id: js-plugins-length-zero
      - id: js-outerwidth-zero

  # Sandbox detection (2+ indicators)
  - id: sandbox
    desc: Sandbox detection techniques
    crit: suspicious
    conf: 0.66
    for: [elf, macho, pe, shell, python]
    count: 2
    any:
      - id: cuckoo
      - id: joe-sandbox
      - id: any-run
      - id: hybrid-analysis
      - id: virustotal
      - id: wireshark
      - id: fiddler
      - id: procmon
      - id: process-hacker
      - id: x64dbg
      - id: ollydbg
      - id: sandbox-path

  # Console toString composite
  - id: js-console-tostring
    desc: Console method toString check
    crit: notable
    conf: 0.7
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    count: 1
    any:
      - id: js-console-log-tostring
      - id: js-console-warn-tostring
      - id: js-console-error-tostring

  # JS debugger detection (2+ indicators)
  - id: js-debugger
    desc: JavaScript debugger detection
    crit: suspicious
    conf: 0.85
    mbc: "B0001"
    attack: "T1622"
    for: [javascript, typescript]
    count: 2
    any:
      - id: js-debugger-stmt
      - id: js-func-tostring
      - id: js-console-tostring
      - id: js-react-devtools
      - id: js-vue-devtools

# NOTE: VM detection traits are in anti-analysis/vm/
# Use anti-analysis/vm directory reference for VM/hypervisor detection
