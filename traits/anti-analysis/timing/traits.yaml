# Anti-Analysis - Timing Primitives
# MBC: B0001.032 (Timing/Delay Check)
# ATT&CK: T1497.001 (Virtualization/Sandbox Evasion: System Checks)

defaults:
  for: [elf, macho, pe, dll]
  mbc: "B0001.032"
  attack: "T1497.001"

traits:
  - id: rdtsc
    desc: RDTSC instruction (hardware timestamp)
    crit: inert
    conf: 0.5
    if:
      type: hex
      pattern: "0F 31"

  - id: clock-gettime
    desc: clock_gettime function
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: '\bclock_gettime\b'

  - id: gettimeofday
    desc: gettimeofday function
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: '\bgettimeofday\b'

  - id: time-func
    desc: time function
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: '\btime\b'

composite_rules:
  - id: primitive
    desc: "Hardware timing primitive (potential anti-analysis)"
    crit: notable
    conf: 0.7
    all:
      - id: rdtsc
    count: 1
    any:
      - id: clock-gettime
      - id: gettimeofday
      - id: time-func
