# System Fingerprinting Traits (Node.js)
# Detects system information collection for fingerprinting/profiling
# MBC: E1592 (System Information Discovery)
# ATT&CK: T1082 (System Information Discovery), T1016 (System Network Configuration)

traits:
  # OS Module - Basic System Info
  - id: os-hostname
    desc: Hostname collection via os module
    crit: notable
    conf: 0.8
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.hostname"

  - id: os-platform
    desc: Platform detection via os module
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.platform"

  - id: os-arch
    desc: Architecture detection via os module
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.arch"

  - id: os-release
    desc: OS release version collection
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.release"

  - id: os-userInfo
    desc: User information collection
    crit: suspicious
    conf: 0.85
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.userInfo"

  - id: os-cpus
    desc: CPU information collection
    crit: notable
    conf: 0.7
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.cpus"

  - id: os-totalmem
    desc: Total memory collection
    crit: notable
    conf: 0.7
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.totalmem"

  - id: os-networkInterfaces
    desc: Network interface enumeration
    crit: suspicious
    conf: 0.85
    attack: "T1016"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.networkInterfaces"

  # === MAC address extraction patterns ===
  - id: mac-keyword-lower
    desc: mac keyword (lowercase)
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      word: "mac"

  - id: mac-keyword-upper
    desc: MAC keyword (uppercase)
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      word: "MAC"

  - id: mac-address-regex
    desc: MAC address regex pattern
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "[0-9a-fA-F]{2}(:[0-9a-fA-F]{2}){5}"

  - id: internal-filter-keyword
    desc: internal filter keyword
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      word: "internal"

  # === Hashing for machine ID ===
  - id: createhash-call
    desc: crypto.createHash call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "createHash"

  - id: sha256-keyword
    desc: sha256 hash algorithm
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      word: "sha256"

  - id: md5-keyword
    desc: md5 hash algorithm
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      word: "md5"

  - id: hostname-keyword
    desc: hostname keyword
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      word: "hostname"

  - id: userinfo-keyword
    desc: userInfo keyword
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      word: "userInfo"

  - id: networkinterfaces-keyword
    desc: networkInterfaces keyword
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      word: "networkInterfaces"

  # === Object serialization ===
  - id: json-stringify-call
    desc: JSON.stringify call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "JSON.stringify"

  - id: object-keys-call
    desc: Object.keys call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "Object.keys"

  - id: object-entries-call
    desc: Object.entries call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "Object.entries"

  - id: process-env-access
    desc: process.env access
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "process.env"

  # === Process list atomic indicators ===
  - id: tasklist-cmd
    desc: Windows tasklist command
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "tasklist"

  - id: ps-aux-cmd
    desc: ps aux command
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "ps aux"

  - id: ps-ef-cmd
    desc: ps -ef command
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "ps -ef"

  - id: get-process-cmd
    desc: PowerShell Get-Process
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "Get-Process"

composite_rules:
  # Helper composites
  - id: mac-keyword-variants
    desc: MAC keyword variants
    for: [javascript, typescript]
    any:
      - { id: mac-keyword-lower }
      - { id: mac-keyword-upper }

  - id: mac-patterns
    desc: MAC address patterns
    for: [javascript, typescript]
    any:
      - { id: mac-keyword-variants }
      - { id: mac-address-regex }
      - { id: internal-filter-keyword }

  - id: hash-algorithms
    desc: Hash algorithm keywords
    for: [javascript, typescript]
    any:
      - { id: sha256-keyword }
      - { id: md5-keyword }

  - id: system-id-sources
    desc: System identification sources
    for: [javascript, typescript]
    any:
      - { id: hostname-keyword }
      - { id: userinfo-keyword }
      - { id: networkinterfaces-keyword }

  - id: object-serialization
    desc: Object serialization methods
    for: [javascript, typescript]
    any:
      - { id: json-stringify-call }
      - { id: object-keys-call }
      - { id: object-entries-call }

  - id: all-os-methods
    desc: All os module methods
    for: [javascript, typescript]
    any:
      - { id: os-hostname }
      - { id: os-platform }
      - { id: os-arch }
      - { id: os-release }
      - { id: os-userInfo }
      - { id: os-cpus }
      - { id: os-totalmem }
      - { id: os-networkInterfaces }

  # Main composites (migrated from YARA)
  - id: mac-address
    desc: MAC address extraction pattern
    crit: suspicious
    conf: 0.9
    mbc: "E1592"
    attack: "T1016"
    for: [javascript, typescript]
    all:
      - { id: os-networkInterfaces }
      - { id: mac-patterns }

  - id: machine-id
    desc: Machine unique identifier generation
    crit: suspicious
    conf: 0.85
    mbc: "E1592"
    attack: "T1082"
    for: [javascript, typescript]
    all:
      - { id: createhash-call }
      - { id: hash-algorithms }
      - id: system-id-sources
        count_min: 2
  - id: full-fingerprint
    desc: Comprehensive system fingerprinting (multiple vectors)
    crit: suspicious
    conf: 0.9
    mbc: "E1592"
    attack: "T1082"
    for: [javascript, typescript]
    count_min: 4
    any:
      - { id: os-hostname }
      - { id: os-platform }
      - { id: os-arch }
      - { id: os-release }
      - { id: os-userInfo }
      - { id: os-cpus }
      - { id: os-totalmem }
      - { id: os-networkInterfaces }

  - id: process-env-dump
    desc: Full environment variable dump
    crit: suspicious
    conf: 0.85
    mbc: "E1592"
    attack: "T1082"
    for: [javascript, typescript]
    all:
      - { id: process-env-access }
      - { id: object-serialization }

  # Process list composite
  - id: process-list
    desc: Running process enumeration
    crit: suspicious
    conf: 0.9
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    count_min: 1
    any:
      - { id: tasklist-cmd }
      - { id: ps-aux-cmd }
      - { id: ps-ef-cmd }
      - { id: get-process-cmd }
