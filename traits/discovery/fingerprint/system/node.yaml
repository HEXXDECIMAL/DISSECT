# System Fingerprinting Traits (Node.js)
# Detects system information collection for fingerprinting/profiling
# MBC: E1592 (System Information Discovery)
# ATT&CK: T1082 (System Information Discovery), T1016 (System Network Configuration)

traits:
  # OS Module - Basic System Info
  - id: os-hostname
    desc: Hostname collection via os module
    crit: notable
    conf: 0.8
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.hostname"

  - id: os-platform
    desc: Platform detection via os module
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.platform"

  - id: os-arch
    desc: Architecture detection via os module
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.arch"

  - id: os-release
    desc: OS release version collection
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.release"

  - id: os-userInfo
    desc: User information collection
    crit: suspicious
    conf: 0.85
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.userInfo"

  - id: os-cpus
    desc: CPU information collection
    crit: notable
    conf: 0.7
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.cpus"

  - id: os-totalmem
    desc: Total memory collection
    crit: notable
    conf: 0.7
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.totalmem"

  - id: os-networkInterfaces
    desc: Network interface enumeration
    crit: suspicious
    conf: 0.85
    attack: "T1016"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "os.networkInterfaces"

  # MAC Address Collection
  - id: mac-address
    desc: MAC address extraction pattern
    crit: suspicious
    conf: 0.9
    mbc: "E1592"
    attack: "T1016"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule mac_address_collection {
          strings:
            $net = "networkInterfaces"
            $mac1 = "mac" nocase
            $mac2 = /[0-9a-fA-F]{2}(:[0-9a-fA-F]{2}){5}/
            $filter = "internal"
          condition:
            $net and (any of ($mac*) or $filter)
        }

  # Machine ID / Unique Identifier
  - id: machine-id
    desc: Machine unique identifier generation
    crit: suspicious
    conf: 0.85
    mbc: "E1592"
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule machine_id_generation {
          strings:
            $hash1 = "createHash"
            $hash2 = "sha256"
            $hash3 = "md5"
            $host = "hostname"
            $user = "userInfo"
            $mac = "networkInterfaces"
          condition:
            any of ($hash*) and 2 of ($host, $user, $mac)
        }

  # Comprehensive Fingerprinting
  - id: full-fingerprint
    desc: Comprehensive system fingerprinting (multiple vectors)
    crit: suspicious
    conf: 0.9
    mbc: "E1592"
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule full_system_fingerprint {
          strings:
            $os1 = "os.hostname"
            $os2 = "os.platform"
            $os3 = "os.arch"
            $os4 = "os.release"
            $os5 = "os.userInfo"
            $os6 = "os.cpus"
            $os7 = "os.totalmem"
            $os8 = "os.networkInterfaces"
          condition:
            4 of them
        }

  # Process Environment
  - id: process-env-dump
    desc: Full environment variable dump
    crit: suspicious
    conf: 0.85
    mbc: "E1592"
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule env_dump {
          strings:
            $env1 = "process.env"
            $json1 = "JSON.stringify"
            $keys1 = "Object.keys"
            $entries = "Object.entries"
          condition:
            $env1 and any of ($json1, $keys1, $entries)
        }

  # === Process list atomic indicators ===
  - id: tasklist-cmd
    desc: Windows tasklist command
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "tasklist"

  - id: ps-aux-cmd
    desc: ps aux command
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "ps aux"

  - id: ps-ef-cmd
    desc: ps -ef command
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "ps -ef"

  - id: get-process-cmd
    desc: PowerShell Get-Process
    crit: inert
    conf: 0.7
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    if:
      type: string
      exact: "Get-Process"

composite_rules:
  # Process list composite
  - id: process-list
    desc: Running process enumeration
    crit: suspicious
    conf: 0.9
    mbc: "E1592"
    attack: "T1057"
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: tasklist-cmd
      - id: ps-aux-cmd
      - id: ps-ef-cmd
      - id: get-process-cmd
