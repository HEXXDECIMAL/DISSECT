# Machine ID / Hardware Fingerprinting
# ATT&CK: T1082 (System Information Discovery)
# Detects collection of unique machine identifiers

defaults:
  attack: "T1082"

traits:
  # === Machine ID atomic indicators ===
  - id: etc-machine-id
    desc: /etc/machine-id file
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell, elf, macho]
    if:
      type: string
      exact: "/etc/machine-id"

  - id: dbus-machine-id
    desc: /var/lib/dbus/machine-id file
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell, elf, macho]
    if:
      type: string
      exact: "/var/lib/dbus/machine-id"

  - id: windows-machine-guid
    desc: Windows MachineGuid reference
    crit: inert
    conf: 0.7
    for: [javascript, typescript, powershell, pe]
    if:
      type: string
      exact: "MachineGuid"

  # === Node.js machine-id package atomic indicators ===
  - id: require-node-machine-id
    desc: require node-machine-id
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "require\\(['\"]node-machine-id['\"]\\)"

  - id: require-machine-id
    desc: require machine-id
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "require\\(['\"]machine-id['\"]\\)"

  - id: import-node-machine-id
    desc: import from node-machine-id
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: 'from [''"]node-machine-id[''"]'

  # === macOS hardware UUID atomic indicators ===
  - id: system-profiler-hardware
    desc: system_profiler SPHardwareDataType
    crit: inert
    conf: 0.7
    for: [javascript, typescript, shell, python, macho]
    if:
      type: string
      exact: "system_profiler SPHardwareDataType"

  - id: ioplatform-uuid
    desc: IOPlatformUUID reference
    crit: inert
    conf: 0.7
    for: [javascript, typescript, shell, python, macho]
    if:
      type: string
      exact: "IOPlatformUUID"

  - id: ioreg-serial
    desc: ioreg IOPlatformSerialNumber
    crit: inert
    conf: 0.7
    for: [javascript, typescript, shell, python, macho]
    if:
      type: string
      regex: "ioreg.{0,50}IOPlatformSerialNumber"

  # === Windows machine GUID atomic indicators ===
  - id: hklm-cryptography-guid
    desc: HKLM Cryptography MachineGuid
    crit: inert
    conf: 0.7
    for: [javascript, typescript, powershell, pe]
    if:
      type: string
      regex: "HKLM.{0,30}Cryptography.{0,30}MachineGuid"

  - id: wmic-csproduct-uuid
    desc: wmic csproduct get uuid
    crit: inert
    conf: 0.7
    for: [javascript, typescript, powershell, shell]
    if:
      type: string
      exact: "wmic csproduct get uuid"

  # === CPU ID atomic indicators ===
  - id: proc-cpuinfo
    desc: /proc/cpuinfo file
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell, elf]
    if:
      type: string
      exact: "/proc/cpuinfo"

  - id: processor-id
    desc: processor id reference
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python, shell, elf, pe]
    if:
      type: string
      regex: "processor.{0,30}id"

  - id: cpuid-instruction
    desc: cpuid instruction/function
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python, shell, elf, pe, macho]
    if:
      type: string
      exact: "cpuid"

  # === Disk serial atomic indicators ===
  - id: hdparm-info
    desc: hdparm -i command
    crit: inert
    conf: 0.6
    for: [javascript, typescript, shell, elf]
    if:
      type: string
      regex: "hdparm.{0,20}-i"

  - id: smartctl-cmd
    desc: smartctl command
    crit: inert
    conf: 0.6
    for: [javascript, typescript, shell, elf]
    if:
      type: string
      exact: "smartctl"

  - id: wmic-diskdrive-serial
    desc: wmic diskdrive get serialnumber
    crit: inert
    conf: 0.6
    for: [javascript, typescript, shell, powershell, pe]
    if:
      type: string
      exact: "wmic diskdrive get serialnumber"

  # === BIOS serial atomic indicators ===
  - id: dmidecode-cmd
    desc: dmidecode command
    crit: inert
    conf: 0.6
    for: [javascript, typescript, shell, elf]
    if:
      type: string
      exact: "dmidecode"

  - id: wmic-bios-serial
    desc: wmic bios get serialnumber
    crit: inert
    conf: 0.6
    for: [javascript, typescript, shell, powershell, pe]
    if:
      type: string
      exact: "wmic bios get serialnumber"

  # Comprehensive hardware fingerprint
  - id: hardware-comprehensive
    desc: Comprehensive hardware fingerprinting (multiple vectors)
    crit: suspicious
    conf: 0.9
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule comprehensive_fingerprint {
          strings:
            $mac = "networkInterfaces" ascii
            $cpu = "cpus()" ascii
            $mem = "totalmem" ascii
            $host = "hostname()" ascii
            $user = "userInfo()" ascii
            $plat = "platform()" ascii
            $arch = "arch()" ascii
            $release = "release()" ascii
          condition:
            4 of them
        }

  # Unique identifier generation with exfil
  - id: unique-id-exfil
    desc: Generates unique identifier and sends to network
    crit: suspicious
    conf: 0.95
    attack: "T1082"
    mbc: "E1082"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule unique_id_exfil {
          strings:
            // ID generation
            $id1 = "machine-id" ascii
            $id2 = "uuid" ascii
            $id3 = "fingerprint" ascii
            $id4 = "uniqueId" ascii
            $id5 = "deviceId" ascii
            // Combined with network
            $net1 = "fetch(" ascii
            $net2 = "https.request" ascii
            $net3 = "POST" ascii
            $net4 = "webhook" ascii
          condition:
            any of ($id*) and any of ($net*)
        }

composite_rules:
  # Machine ID file access composite
  - id: machine-id-file
    desc: Accesses machine-id file (unique system identifier)
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript, python, shell, elf, macho, pe]
    requires_count: 1
    any:
      - id: etc-machine-id
      - id: dbus-machine-id
      - id: windows-machine-guid

  # Node.js machine-id package composite
  - id: machine-id-package
    desc: Uses machine-id npm package
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: require-node-machine-id
      - id: require-machine-id
      - id: import-node-machine-id

  # macOS hardware UUID composite
  - id: hardware-uuid-macos
    desc: Collects macOS hardware UUID
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript, shell, python, macho]
    requires_count: 1
    any:
      - id: system-profiler-hardware
      - id: ioplatform-uuid
      - id: ioreg-serial

  # Windows machine GUID composite
  - id: machine-guid-windows
    desc: Collects Windows machine GUID
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript, powershell, pe]
    requires_count: 1
    any:
      - id: hklm-cryptography-guid
      - id: wmic-csproduct-uuid

  # CPU ID composite
  # NOTE: Go runtime uses cpuid instruction to check CPU features (AVX, SSE, etc.)
  # Downgraded to inert for binaries to avoid false positives.
  - id: cpu-id
    desc: Collects CPU identifier
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python, shell, elf, pe, macho]
    requires_count: 1
    any:
      - id: proc-cpuinfo
      - id: processor-id
      - id: cpuid-instruction

  # Disk serial composite
  - id: disk-serial
    desc: Collects disk serial number
    crit: notable
    conf: 0.75
    for: [javascript, typescript, shell, elf, pe]
    requires_count: 1
    any:
      - id: hdparm-info
      - id: smartctl-cmd
      - id: wmic-diskdrive-serial

  # BIOS serial composite
  - id: bios-serial
    desc: Collects BIOS/firmware serial
    crit: notable
    conf: 0.75
    for: [javascript, typescript, shell, elf, pe, macho]
    requires_count: 1
    any:
      - id: dmidecode-cmd
      - id: wmic-bios-serial
      - id: system-profiler-hardware
