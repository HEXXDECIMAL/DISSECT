# Machine ID / Hardware Fingerprinting
# ATT&CK: T1082 (System Information Discovery)
# Detects collection of unique machine identifiers

defaults:
  attack: "T1082"

traits:
  # === Machine ID atomic indicators ===
  - id: etc-machine-id
    description: /etc/machine-id file
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, python, shell, elf, macho]
    condition:
      type: string
      exact: "/etc/machine-id"

  - id: dbus-machine-id
    description: /var/lib/dbus/machine-id file
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, python, shell, elf, macho]
    condition:
      type: string
      exact: "/var/lib/dbus/machine-id"

  - id: windows-machine-guid
    description: Windows MachineGuid reference
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, powershell, pe]
    condition:
      type: string
      exact: "MachineGuid"

  # === Node.js machine-id package atomic indicators ===
  - id: require-node-machine-id
    description: require node-machine-id
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"]node-machine-id['\"]\\)"

  - id: require-machine-id
    description: require machine-id
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"]machine-id['\"]\\)"

  - id: import-node-machine-id
    description: import from node-machine-id
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "from ['\"]node-machine-id['\"]"

  # === macOS hardware UUID atomic indicators ===
  - id: system-profiler-hardware
    description: system_profiler SPHardwareDataType
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, shell, python, macho]
    condition:
      type: string
      exact: "system_profiler SPHardwareDataType"

  - id: ioplatform-uuid
    description: IOPlatformUUID reference
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, shell, python, macho]
    condition:
      type: string
      exact: "IOPlatformUUID"

  - id: ioreg-serial
    description: ioreg IOPlatformSerialNumber
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, shell, python, macho]
    condition:
      type: string
      regex: "ioreg.*IOPlatformSerialNumber"

  # === Windows machine GUID atomic indicators ===
  - id: hklm-cryptography-guid
    description: HKLM Cryptography MachineGuid
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, powershell, pe]
    condition:
      type: string
      regex: "HKLM.*Cryptography.*MachineGuid"

  - id: wmic-csproduct-uuid
    description: wmic csproduct get uuid
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript, powershell, shell]
    condition:
      type: string
      exact: "wmic csproduct get uuid"

  # === CPU ID atomic indicators ===
  - id: proc-cpuinfo
    description: /proc/cpuinfo file
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, python, shell, elf]
    condition:
      type: string
      exact: "/proc/cpuinfo"

  - id: processor-id
    description: processor id reference
    criticality: inert
    confidence: 0.5
    file_types: [javascript, typescript, python, shell, elf, pe]
    condition:
      type: string
      regex: "processor.*id"

  - id: cpuid-instruction
    description: cpuid instruction/function
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, python, shell, elf, pe, macho]
    condition:
      type: string
      exact: "cpuid"

  # === Disk serial atomic indicators ===
  - id: hdparm-info
    description: hdparm -i command
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, shell, elf]
    condition:
      type: string
      regex: "hdparm.*-i"

  - id: smartctl-cmd
    description: smartctl command
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, shell, elf]
    condition:
      type: string
      exact: "smartctl"

  - id: wmic-diskdrive-serial
    description: wmic diskdrive get serialnumber
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, shell, powershell, pe]
    condition:
      type: string
      exact: "wmic diskdrive get serialnumber"

  # === BIOS serial atomic indicators ===
  - id: dmidecode-cmd
    description: dmidecode command
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, shell, elf]
    condition:
      type: string
      exact: "dmidecode"

  - id: wmic-bios-serial
    description: wmic bios get serialnumber
    criticality: inert
    confidence: 0.6
    file_types: [javascript, typescript, shell, powershell, pe]
    condition:
      type: string
      exact: "wmic bios get serialnumber"

  # Comprehensive hardware fingerprint
  - id: hardware-comprehensive
    description: Comprehensive hardware fingerprinting (multiple vectors)
    criticality: suspicious
    confidence: 0.9
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule comprehensive_fingerprint {
          strings:
            $mac = "networkInterfaces" ascii
            $cpu = "cpus()" ascii
            $mem = "totalmem" ascii
            $host = "hostname()" ascii
            $user = "userInfo()" ascii
            $plat = "platform()" ascii
            $arch = "arch()" ascii
            $release = "release()" ascii
          condition:
            4 of them
        }

  # Unique identifier generation with exfil
  - id: unique-id-exfil
    description: Generates unique identifier and sends to network
    criticality: suspicious
    confidence: 0.95
    attack: "T1082"
    mbc: "E1082"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule unique_id_exfil {
          strings:
            // ID generation
            $id1 = "machine-id" ascii
            $id2 = "uuid" ascii
            $id3 = "fingerprint" ascii
            $id4 = "uniqueId" ascii
            $id5 = "deviceId" ascii
            // Combined with network
            $net1 = "fetch(" ascii
            $net2 = "https.request" ascii
            $net3 = "POST" ascii
            $net4 = "webhook" ascii
          condition:
            any of ($id*) and any of ($net*)
        }

composite_rules:
  # Machine ID file access composite
  - id: machine-id-file
    description: Accesses machine-id file (unique system identifier)
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript, python, shell, elf, macho, pe]
    requires_count: 1
    conditions:
      - id: etc-machine-id
      - id: dbus-machine-id
      - id: windows-machine-guid

  # Node.js machine-id package composite
  - id: machine-id-package
    description: Uses machine-id npm package
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    requires_count: 1
    conditions:
      - id: require-node-machine-id
      - id: require-machine-id
      - id: import-node-machine-id

  # macOS hardware UUID composite
  - id: hardware-uuid-macos
    description: Collects macOS hardware UUID
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript, shell, python, macho]
    requires_count: 1
    conditions:
      - id: system-profiler-hardware
      - id: ioplatform-uuid
      - id: ioreg-serial

  # Windows machine GUID composite
  - id: machine-guid-windows
    description: Collects Windows machine GUID
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript, powershell, pe]
    requires_count: 1
    conditions:
      - id: hklm-cryptography-guid
      - id: wmic-csproduct-uuid

  # CPU ID composite
  - id: cpu-id
    description: Collects CPU identifier
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript, python, shell, elf, pe, macho]
    requires_count: 1
    conditions:
      - id: proc-cpuinfo
      - id: processor-id
      - id: cpuid-instruction

  # Disk serial composite
  - id: disk-serial
    description: Collects disk serial number
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript, shell, elf, pe]
    requires_count: 1
    conditions:
      - id: hdparm-info
      - id: smartctl-cmd
      - id: wmic-diskdrive-serial

  # BIOS serial composite
  - id: bios-serial
    description: Collects BIOS/firmware serial
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript, shell, elf, pe, macho]
    requires_count: 1
    conditions:
      - id: dmidecode-cmd
      - id: wmic-bios-serial
      - id: system-profiler-hardware

