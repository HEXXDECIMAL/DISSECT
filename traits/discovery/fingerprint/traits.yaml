# Machine Fingerprinting Detection
# ATT&CK: T1082 (System Information Discovery)
# Used by malware for victim identification and C2 tracking

traits:
  # Machine ID collection
  - id: machine-id
    desc: Machine ID collection for victim identification
    crit: suspicious
    conf: 0.8
    attack: "T1082"
    if:
      type: yara
      source: |
        rule machine_id {
          strings:
            $id1 = "/var/lib/dbus/machine-id" ascii
            $id2 = "/etc/machine-id" ascii
            $id3 = "machine-id" ascii
            $id4 = "MachineGuid" ascii wide
            $id5 = "MachineId" ascii
            $uuid1 = "/sys/class/dmi/id/product_uuid" ascii
            $uuid2 = "product_uuid" ascii
          condition:
            any of them
        }

  # DMI/SMBIOS data collection
  - id: dmi-smbios
    desc: DMI/SMBIOS hardware information collection
    crit: notable
    conf: 0.75
    attack: "T1082"
    if:
      type: yara
      source: |
        rule dmi_smbios {
          strings:
            $dmi1 = "/sys/class/dmi/id/" ascii
            $dmi2 = "/sys/devices/virtual/dmi/id/" ascii
            $dmi3 = "sys_vendor" ascii
            $dmi4 = "product_name" ascii
            $dmi5 = "product_serial" ascii
            $dmi6 = "board_serial" ascii
            $dmi7 = "bios_vendor" ascii
            $dmi8 = "bios_version" ascii
            $dmidecode = "dmidecode" ascii
          condition:
            2 of them or $dmidecode
        }

  # CPU fingerprinting
  - id: cpu-info
    desc: CPU information fingerprinting
    crit: notable
    conf: 0.7
    attack: "T1082"
    if:
      type: yara
      source: |
        rule cpu_fingerprint {
          strings:
            $cpu1 = "/proc/cpuinfo" ascii
            $cpu2 = "model name" ascii
            $cpu3 = "cpu family" ascii
            $cpu4 = "cpu cores" ascii
            $cpu5 = "processor" ascii
            $cpuid1 = "cpuid" ascii
            $cpuid2 = "__cpuid" ascii
            $lscpu = "lscpu" ascii
          condition:
            ($cpu1 and any of ($cpu2, $cpu3, $cpu4, $cpu5)) or any of ($cpuid*) or $lscpu
        }

  # Network interface fingerprinting
  - id: network-interfaces
    desc: Network interface fingerprinting (MAC address)
    crit: notable
    conf: 0.75
    attack: "T1082"
    if:
      type: yara
      source: |
        rule network_fingerprint {
          strings:
            $if1 = "/sys/class/net/" ascii
            $if2 = "address" ascii
            $mac1 = "HWaddr" ascii
            $mac2 = "ether " ascii
            $mac3 = "getifaddrs" ascii
            $mac4 = "SIOCGIFHWADDR" ascii
            $ip1 = "ip link" ascii
            $ip2 = "ifconfig" ascii
          condition:
            ($if1 and $if2) or any of ($mac*) or any of ($ip*)
        }

  # Disk/Storage fingerprinting
  - id: disk-serial
    desc: Disk serial number fingerprinting
    crit: notable
    conf: 0.75
    attack: "T1082"
    if:
      type: yara
      source: |
        rule disk_fingerprint {
          strings:
            $disk1 = "/sys/block/" ascii
            $disk2 = "/device/serial" ascii
            $disk3 = "HDIO_GET_IDENTITY" ascii
            $disk4 = "hdparm -i" ascii
            $disk5 = "lsblk" ascii
            $disk6 = "blkid" ascii
            $serial1 = "serial_short" ascii
            $serial2 = "ID_SERIAL" ascii
          condition:
            2 of them
        }

  # OS fingerprinting
  - id: os-info
    desc: Operating system fingerprinting
    crit: notable
    conf: 0.7
    attack: "T1082"
    if:
      type: yara
      source: |
        rule os_fingerprint {
          strings:
            $os1 = "/etc/os-release" ascii
            $os2 = "/etc/lsb-release" ascii
            $os3 = "/etc/redhat-release" ascii
            $os4 = "/etc/debian_version" ascii
            $os5 = "/etc/centos-release" ascii
            $os6 = "/proc/version" ascii
            $uname = "uname -a" ascii
            $hostnamectl = "hostnamectl" ascii
          condition:
            2 of them
        }

  # Hostname collection
  - id: hostname
    desc: Hostname collection for identification
    crit: notable
    conf: 0.7
    attack: "T1082"
    if:
      type: yara
      source: |
        rule hostname_collect {
          strings:
            $host1 = "gethostname" ascii
            $host2 = "/etc/hostname" ascii
            $host3 = "HOSTNAME" ascii
            $host4 = "hostname" ascii
            $fqdn = "getfqdn" ascii
          condition:
            2 of them
        }

  # User fingerprinting
  - id: user-info
    desc: User information fingerprinting
    crit: notable
    conf: 0.7
    attack: "T1033"
    if:
      type: yara
      source: |
        rule user_fingerprint {
          strings:
            $user1 = "getlogin" ascii
            $user2 = "getpwuid" ascii
            $user3 = "getenv(\"USER\")" ascii
            $user4 = "getenv(\"HOME\")" ascii
            $user5 = "whoami" ascii
            $user6 = "id -u" ascii
            $user7 = "/etc/passwd" ascii
          condition:
            2 of them
        }

  # Hardware UUID generation
  - id: hardware-uuid
    desc: Hardware-based UUID generation
    crit: suspicious
    conf: 0.8
    attack: "T1082"
    if:
      type: yara
      source: |
        rule hardware_uuid {
          strings:
            $gen1 = "GenerateHardwareId" ascii
            $gen2 = "GetHardwareId" ascii
            $gen3 = "hardware_id" ascii nocase
            $gen4 = "hwid" ascii nocase
            $gen5 = "fingerprint" ascii
            // Combining multiple sources
            $combo = "md5" ascii
            $combo2 = "sha" ascii
          condition:
            any of ($gen*) or (($combo or $combo2) and 2 of them)
        }

composite_rules:
  # Full system fingerprinting
  - id: full-system
    desc: Comprehensive system fingerprinting (malware behavior)
    crit: suspicious
    conf: 0.85
    requires_count: 3
    any:
      - id: machine-id
      - id: cpu-info
      - id: network-interfaces
      - id: disk-serial
      - id: os-info
