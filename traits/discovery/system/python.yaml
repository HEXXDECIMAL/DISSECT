# System Information Discovery - Python
# Detects Python code that fingerprints the host system
# ATT&CK: T1082 (System Information Discovery)

defaults:
  for: [python]
  mbc: "E1082"
  attack: "T1082"
  crit: notable

traits:
  # Platform module - OS detection (Alias-resistant AST)
  - id: python-platform-system
    desc: Profiles the host operating system type
    conf: 0.8
    if:
      type: ast_pattern
      node_type: call
      pattern: ".system()"

  - id: python-platform-machine
    desc: Identifies the host CPU architecture
    conf: 0.75
    if:
      type: ast_pattern
      node_type: call
      pattern: ".machine()"

  - id: python-platform-node
    desc: Retrieves the system hostname
    conf: 0.7
    if:
      type: ast_pattern
      node_type: call
      pattern: ".node()"

  - id: python-platform-uname
    desc: Collects comprehensive system hardware and OS information
    conf: 0.8
    if:
      type: ast_pattern
      node_type: call
      pattern: ".uname()"

  # User lookup (Alias-resistant)
  - id: python-getpass-user
    desc: Identifies the current logged-in user
    conf: 0.85
    if:
      type: ast_pattern
      node_type: call
      pattern: ".getuser()"

  # === MAC address discovery (atomic) ===
  - id: getmac-module
    desc: getmac module for MAC address discovery
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "getmac"

  - id: ifconfig-cmd
    desc: ifconfig command for network info
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "ifconfig"

  - id: uuid-getnode
    desc: uuid.getnode() for MAC address
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "uuid.getnode()"

composite_rules:
  # MAC address discovery
  - id: python-mac-discovery
    desc: Collects hardware MAC addresses for system fingerprinting
    crit: notable
    conf: 0.8
    requires_count: 1
    any:
      - id: getmac-module
      - id: ifconfig-cmd
      - id: uuid-getnode

  # Composite: Intensive system enumeration (Alias-resistant)
  - id: python-enumeration
    desc: Performs intensive system enumeration (multiple info leaks)
    crit: suspicious
    conf: 0.95
    near_lines: 80
    requires_count: 3
    any:
      - id: python-platform-system
      - id: python-mac-discovery
      - id: python-getpass-user
      - id: comm/http/request
