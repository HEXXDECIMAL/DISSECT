# Discovery - Geolocation and IP Intelligence
# Detects victim geolocation/profiling via IP lookup APIs
# ATT&CK: T1016 (System Network Configuration Discovery)

traits:
  # === IP Geolocation APIs ===

  - id: api-db-ip
    description: api.db-ip.com endpoint
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "api.db-ip.com"

  - id: db-ip-v2
    description: db-ip.com/v2 endpoint
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "db-ip.com/v2"

  - id: ipinfo-io
    description: ipinfo.io geolocation API
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "ipinfo.io"

  - id: ipapi-api
    description: ip-api.com geolocation API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      exact: "ip-api.com"

  - id: api-ipify
    description: api.ipify.org endpoint
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "api.ipify.org"

  - id: ipify-org
    description: ipify.org domain
    criticality: inert
    confidence: 0.6
    attack: "T1016"
    condition:
      type: string
      exact: "ipify.org"

  - id: ipgeolocation-api
    description: ipgeolocation.io API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      exact: "ipgeolocation.io"

  - id: geoip-maxmind
    description: geoip.maxmind.com endpoint
    criticality: inert
    confidence: 0.6
    attack: "T1016"
    condition:
      type: string
      exact: "geoip.maxmind.com"

  - id: maxmind-geoip
    description: maxmind.com/geoip endpoint
    criticality: inert
    confidence: 0.6
    attack: "T1016"
    condition:
      type: string
      exact: "maxmind.com/geoip"

  - id: freegeoip-app
    description: freegeoip.app domain
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "freegeoip.app"

  - id: freegeoip-net
    description: freegeoip.net domain
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "freegeoip.net"

  - id: freegeoip-io
    description: freegeoip.io domain
    criticality: inert
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "freegeoip.io"

  # NOTE: Generic IP lookup services (checkip.amazonaws.com, icanhazip.com, ifconfig.me, etc.)
  # are defined in discovery/network/discovery/ip-lookup.yaml
  # Use discovery/network/discovery directory reference for IP lookup detection

  # === Response Fields (JSON parsing) ===

  - id: country-code-camel
    description: countryCode field (camelCase)
    criticality: inert
    confidence: 0.5
    attack: "T1016"
    condition:
      type: string
      regex: "\\bcountryCode\\b"

  - id: country-code-snake
    description: country_code field (snake_case)
    criticality: inert
    confidence: 0.5
    attack: "T1016"
    condition:
      type: string
      regex: "\\bcountry_code\\b"

  - id: ip-address-camel
    description: ipAddress field (camelCase)
    criticality: inert
    confidence: 0.4
    attack: "T1016"
    condition:
      type: string
      regex: "\\bipAddress\\b"

  - id: ip-address-snake
    description: ip_address field (snake_case)
    criticality: inert
    confidence: 0.4
    attack: "T1016"
    condition:
      type: string
      regex: "\\bip_address\\b"

  - id: ip-json-field
    description: "ip" JSON field
    criticality: inert
    confidence: 0.4
    attack: "T1016"
    condition:
      type: string
      exact: '"ip":'

  - id: city-field
    description: City JSON field (geo profiling)
    criticality: notable
    confidence: 0.5
    attack: "T1016"
    condition:
      type: string
      exact: '"city":'

  - id: region-field
    description: Region JSON field (geo profiling)
    criticality: notable
    confidence: 0.5
    attack: "T1016"
    condition:
      type: string
      exact: '"region":'

  - id: freegeoip-generic
    description: freegeoip reference (generic)
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "freegeoip"

composite_rules:
  # DB-IP API composite
  - id: db-ip-api
    description: db-ip.com geolocation API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    requires_count: 1
    conditions:
      - type: trait
        id: api-db-ip
      - type: trait
        id: db-ip-v2

  # ipify API composite
  - id: ipify-api
    description: ipify.org IP address API
    criticality: suspicious
    confidence: 0.8
    attack: "T1016"
    requires_count: 1
    conditions:
      - type: trait
        id: api-ipify
      - type: trait
        id: ipify-org

  # MaxMind API composite
  - id: maxmind-api
    description: MaxMind GeoIP API
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    requires_count: 1
    conditions:
      - type: trait
        id: geoip-maxmind
      - type: trait
        id: maxmind-geoip

  # freegeoip API composite
  - id: freegeoip-api
    description: freegeoip API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    requires_count: 1
    conditions:
      - type: trait
        id: freegeoip-app
      - type: trait
        id: freegeoip-net
      - type: trait
        id: freegeoip-io

  # Country code field composite
  - id: country-code-field
    description: Country code JSON field (geo profiling)
    criticality: notable
    confidence: 0.6
    attack: "T1016"
    requires_count: 1
    conditions:
      - type: trait
        id: country-code-camel
      - type: trait
        id: country-code-snake

  # IP address field composite
  - id: ip-address-field
    description: IP address JSON field (geo profiling)
    criticality: notable
    confidence: 0.5
    attack: "T1016"
    requires_count: 1
    conditions:
      - type: trait
        id: ip-address-camel
      - type: trait
        id: ip-address-snake
      - type: trait
        id: ip-json-field

  - id: victim-profiling
    description: Victim geolocation profiling via IP API
    criticality: suspicious
    confidence: 0.9
    attack: "T1016"
    requires_all:
      - requires_any:
          - type: composite
            id: db-ip-api
          - type: trait
            id: ipinfo-io
          - type: trait
            id: ipapi-api
          - type: trait
            id: ipgeolocation-api
          - type: composite
            id: freegeoip-api
          - type: trait
            id: freegeoip-generic
          - type: composite
            id: ipify-api
      - requires_any:
          - type: composite
            id: country-code-field
          - type: composite
            id: ip-address-field
          - type: trait
            id: city-field
          - type: trait
            id: region-field
