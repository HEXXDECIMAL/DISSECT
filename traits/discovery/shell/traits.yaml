# Shell Command Reconnaissance Detection
# Detects system info gathering via shell command execution
# ATT&CK: T1059 (Command Execution), T1082 (System Information Discovery)

traits:
  # execSync with system info commands
  - id: whoami
    desc: Shell whoami command execution
    crit: notable
    conf: 0.85
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]whoami['\"]"

  - id: hostname
    desc: Shell hostname command execution
    crit: notable
    conf: 0.8
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]hostname['\"]"

  # === ifconfig/ip atomic indicators ===
  - id: exec-ifconfig
    desc: execSync ifconfig command
    crit: inert
    conf: 0.7
    attack: "T1016"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]ifconfig['\"]"

  - id: exec-ip-addr
    desc: execSync ip addr command
    crit: inert
    conf: 0.7
    attack: "T1016"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]ip addr['\"]"

  - id: exec-ip-a
    desc: execSync ip a command
    crit: inert
    conf: 0.7
    attack: "T1016"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]ip a['\"]"

  - id: uname
    desc: Shell uname command execution
    crit: notable
    conf: 0.75
    attack: "T1082"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]uname['\"]"

  - id: id
    desc: Shell id command execution
    crit: notable
    conf: 0.85
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]id['\"]"

  - id: pwd
    desc: Shell pwd command execution
    crit: inert
    conf: 0.7
    attack: "T1083"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]pwd['\"]"

  - id: npm-whoami
    desc: npm whoami command execution (npm user discovery)
    crit: suspicious
    conf: 0.9
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]npm whoami['\"]"

  # === Curl exfil atomic indicators ===
  - id: curl-d-flag
    desc: curl -d flag
    crit: notable
    conf: 0.8
    attack: "T1041"
    for: [javascript, typescript, python, shell]
    if:
      type: string
      regex: "curl\\s+-d"

  - id: curl-data-flag
    desc: curl --data flag
    crit: notable
    conf: 0.8
    attack: "T1041"
    for: [javascript, typescript, python, shell]
    if:
      type: string
      regex: "curl\\s+--data"

  - id: curl-post-flag
    desc: curl -X POST flag
    crit: notable
    conf: 0.8
    attack: "T1041"
    for: [javascript, typescript, python, shell]
    if:
      type: string
      regex: "curl\\s+-X\\s*POST"

composite_rules:
  # ifconfig/ip composite
  - id: ifconfig
    desc: Shell ifconfig/ip command execution
    crit: notable
    conf: 0.85
    attack: "T1016"
    for: [javascript, typescript]
    count: 1
    any:
      - id: exec-ifconfig
      - id: exec-ip-addr
      - id: exec-ip-a

  # curl exfil composite
  - id: curl-exfil
    desc: Curl command with data parameter (exfiltration)
    crit: suspicious
    conf: 0.9
    attack: "T1041"
    for: [javascript, typescript, python, shell]
    count: 1
    any:
      - id: curl-d-flag
      - id: curl-data-flag
      - id: curl-post-flag

  # Multiple system info commands
  - id: system-profiling
    desc: Multiple system info commands (reconnaissance)
    crit: suspicious
    conf: 0.95
    attack: "T1082"
    count: 2
    any:
      - id: whoami
      - id: hostname
      - id: ifconfig
      - id: uname
      - id: id
