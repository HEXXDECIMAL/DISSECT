# Intelligence Gathering - Permissions Discovery
# ATT&CK: T1069 (Permission Groups Discovery)
# NOTE: /proc/self/status is defined in fs/proc/process/linux.yaml (process-self-status)

traits:
  - id: capsh
    description: Linux capability shell
    criticality: suspicious
    confidence: 0.85
    attack: "T1069"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "capsh"

  - id: getgroups
    description: Get group list
    criticality: notable
    confidence: 0.75
    attack: "T1069"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getgroups"

  - id: getgid
    description: Get group ID
    criticality: notable
    confidence: 0.7
    attack: "T1069"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getgid"

  - id: getegid
    description: Get effective group ID
    criticality: notable
    confidence: 0.75
    attack: "T1069"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getegid"

  - id: geteuid
    description: Get effective user ID
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "geteuid"

  - id: etc-group
    description: Group file access
    criticality: suspicious
    confidence: 0.8
    attack: "T1069"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/group"

  - id: etc-sudoers
    description: Sudoers file access
    criticality: suspicious
    confidence: 0.85
    attack: "T1069"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/sudoers"

  - id: cap-get
    description: Linux capability get
    criticality: notable
    confidence: 0.7
    attack: "T1069"
    file_types: [elf]
    condition:
      type: string
      regex: "cap_(get|set)_(proc|file)"

  - id: sudo-l
    description: Sudo permission listing
    criticality: suspicious
    confidence: 0.85
    attack: "T1069"
    file_types: [shell]
    condition:
      type: string
      regex: "sudo\\s+-l"

  - id: cap-get-proc
    description: Get process capabilities
    criticality: notable
    confidence: 0.75
    attack: "T1069"
    file_types: [elf]
    condition:
      type: string
      exact: "cap_get_proc"

  - id: cap-set-proc
    description: Set process capabilities
    criticality: notable
    confidence: 0.75
    attack: "T1069"
    file_types: [elf]
    condition:
      type: string
      exact: "cap_set_proc"

composite_rules:
  - id: linux-caps-enum
    description: Linux capabilities enumeration
    criticality: suspicious
    confidence: 0.9
    attack: "T1069"
    mbc: "B0046"
    file_types: [elf, shell]
    condition:
      type: yara
      source: |
        rule linux_caps_enum {
          strings:
            $capsh = "capsh" fullword
            $proc_status = "/proc/self/status"
            $cap_get = "cap_get_proc"
            $cap_set = "cap_set_proc"
          condition:
            filesize < 10MB and
            ($capsh and $proc_status) or 2 of ($cap*)
        }
    requires_any:
      - requires_all:
          - type: trait
            id: capsh
          - type: trait
            id: process-self-status
      - requires_all:
          - type: trait
            id: cap-get-proc
          - type: trait
            id: cap-set-proc
