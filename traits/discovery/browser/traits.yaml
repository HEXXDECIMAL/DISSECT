# Intelligence Gathering - Browser Discovery
# ATT&CK: T1217 (Browser Information Discovery)
# NOTE: "Web Data" is defined in cred/browser/chromium/traits.yaml (web-data)

traits:
  # === Browser name atomic indicators ===
  - id: chrome-name
    desc: Chrome browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Chrome"

  - id: firefox-name
    desc: Firefox browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Firefox"

  - id: safari-name
    desc: Safari browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Safari"

  - id: edge-name
    desc: Edge browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Edge"

  - id: opera-name
    desc: Opera browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Opera"

  - id: brave-name
    desc: Brave browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Brave"

  # === Browser data file atomic indicators ===
  - id: history-file
    desc: History file reference
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "History"

  - id: cookies-file
    desc: Cookies file reference
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Cookies"

  # === Firefox-specific files ===
  - id: places-sqlite
    desc: Firefox places.sqlite
    crit: inert
    conf: 0.7
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "places.sqlite"

  - id: logins-json
    desc: Firefox logins.json
    crit: inert
    conf: 0.7
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "logins.json"

  # === Bookmarks ===
  - id: bookmarks-word
    desc: bookmarks keyword
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: bookmarks
      case_insensitive: true

  - id: bookmarks-plist
    desc: Bookmarks.plist file
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Bookmarks.plist"

  # === Local storage ===
  - id: local-storage-dir
    desc: Local Storage directory
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "Local Storage"

  - id: leveldb-storage
    desc: leveldb storage
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "leveldb"

  # === Extensions ===
  - id: chrome-extension-url
    desc: chrome-extension:// URL
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "chrome-extension://"

  - id: extensions-hash-path
    desc: Extensions path with hash
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "/Extensions/[a-z]{32}"

  - id: chrome-extensions-path
    desc: Chrome Extensions path
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "/Google/Chrome/.{0,50}Extensions"

  - id: browser-support-extensions
    desc: BrowserSupport Extensions path
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      exact: "/BrowserSupport/Extensions"

  # === Opera/Brave specific ===
  - id: opera-stable
    desc: Opera Stable
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "Opera.{0,30}Stable"

  - id: brave-software
    desc: Brave Software path
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "Brave.{0,30}Software"

composite_rules:
  # Browser names composite
  - id: browser-names
    desc: Browser name references
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    requires_count: 2
    any:
      - id: chrome-name
      - id: firefox-name
      - id: safari-name
      - id: edge-name
      - id: opera-name
      - id: brave-name

  # Browser data files composite
  - id: browser-data-files
    desc: Browser data file references
    crit: notable
    conf: 0.7
    attack: "T1217"
    for: [all]
    requires_count: 1
    any:
      - id: history-file
      - id: cookies-file
      - id: cred/browser/chromium/login-data
      - id: places-sqlite

  # Chrome history composite
  - id: chrome-history
    desc: Chrome browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: chrome-name
    any:
      - id: history-file
      - id: cookies-file
      - id: cred/browser/chromium/login-data

  # Firefox history composite
  - id: firefox-history
    desc: Firefox browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    requires_count: 1
    any:
      - id: places-sqlite
      - id: cred/browser/firefox/cookies-sqlite
      - id: logins-json

  # Safari history composite
  - id: safari-history
    desc: Safari browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: safari-name
    any:
      - id: history-file
      - id: cookies-file

  # Edge history composite
  - id: edge-history
    desc: Edge browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: edge-name
    any:
      - id: history-file
      - id: cookies-file

  # Bookmarks composite
  - id: bookmarks
    desc: Browser bookmarks access
    crit: suspicious
    conf: 0.8
    attack: "T1217"
    for: [all]
    requires_count: 1
    any:
      - id: bookmarks-word
      - id: bookmarks-plist

  # Local storage composite
  - id: local-storage
    desc: Browser local storage access
    crit: suspicious
    conf: 0.8
    attack: "T1217"
    for: [all]
    requires_count: 1
    any:
      - id: local-storage-dir
      - id: leveldb-storage

  # Extensions composite
  - id: extensions
    desc: Browser extensions access
    crit: suspicious
    conf: 0.8
    attack: "T1217"
    for: [all]
    requires_count: 1
    any:
      - id: chrome-extension-url
      - id: extensions-hash-path
      - id: chrome-extensions-path
      - id: browser-support-extensions

  # Opera composite
  - id: opera
    desc: Opera browser data
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    requires_count: 1
    any:
      - id: opera-stable
      - id: opera-name

  # Brave composite
  - id: brave
    desc: Brave browser data
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: brave-software

  # Multi-browser enumeration
  - id: multi-browser-enum
    desc: Multiple browser data access
    crit: suspicious
    conf: 0.9
    attack: "T1217"
    mbc: "B0046"
    for: [all]
    all:
      - id: browser-names
      - id: browser-data-files
