# Intelligence Gathering - External IP Discovery
# ATT&CK: T1016.001 (Internet Connection Discovery)

traits:
  - id: ipify
    desc: ipify.org IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ipify.org"

  - id: ipinfo
    desc: ipinfo.io IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ipinfo.io"

  - id: ifconfig-me
    desc: ifconfig.me IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ifconfig.me"

  - id: icanhazip
    desc: icanhazip.com IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "icanhazip"

  - id: wtfismyip
    desc: wtfismyip.com IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "wtfismyip"

  - id: iplogger
    desc: iplogger.org IP logging service
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "iplogger.org"

  - id: ifconfig-io
    desc: ifconfig.io IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ifconfig.io"

  - id: ifconfig-co
    desc: ifconfig.co IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ifconfig.co"

  - id: ident-me
    desc: ident.me IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ident.me"

  - id: checkip-amazonaws
    desc: AWS checkip service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "checkip.amazonaws.com"

  # Base64 encoded variants (common evasion)
  - id: ipify-b64
    desc: ipify.org (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aXBpZnkub3Jn"

  - id: ipinfo-b64
    desc: ipinfo.io (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aXBpbmZvLmlv"

  - id: ip-recon-obfuscated-yara
    desc: Obfuscated IP reconnaissance via YARA
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    for: [all]
    if:
      type: yara
      source: |
        rule ip_recon_obfuscated {
          strings:
            $ipify_x = "ipify.org" xor(1-255)
            $ipinfo_x = "ipinfo.io" xor(1-255)
            $wtfismyip_x = "wtfismyip" xor(1-255)
            $iplogger_x = "iplogger.org" xor(1-255)
          condition:
            filesize < 50MB and any of them
        }

composite_rules:
  - id: ip-recon-detected
    desc: External IP address reconnaissance
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    for: [all]
    requires_count: 2
    any:
      - id: ipify
      - id: ipinfo
      - id: ifconfig-me
      - id: icanhazip
      - id: wtfismyip
      - id: iplogger
      - id: ifconfig-io
      - id: ifconfig-co
      - id: ident-me
      - id: checkip-amazonaws
      - id: ipify-b64
      - id: ipinfo-b64

  - id: ip-recon-obfuscated
    desc: Obfuscated IP reconnaissance
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    for: [all]
    all:
      - id: ip-recon-obfuscated-yara
