# Intelligence Gathering - External IP Discovery
# ATT&CK: T1016.001 (Internet Connection Discovery)

traits:
  - id: ipify
    desc: ipify.org IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ipify.org"

  - id: ipinfo
    desc: ipinfo.io IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ipinfo.io"

  - id: ifconfig-me
    desc: ifconfig.me IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ifconfig.me"

  - id: icanhazip
    desc: icanhazip.com IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "icanhazip"

  - id: wtfismyip
    desc: wtfismyip.com IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "wtfismyip"

  - id: iplogger
    desc: iplogger.org IP logging service
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "iplogger.org"

  - id: ifconfig-io
    desc: ifconfig.io IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ifconfig.io"

  - id: ifconfig-co
    desc: ifconfig.co IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ifconfig.co"

  - id: ident-me
    desc: ident.me IP lookup service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "ident.me"

  - id: checkip-amazonaws
    desc: AWS checkip service
    crit: suspicious
    conf: 0.85
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "checkip.amazonaws.com"

  # Base64 encoded variants (common evasion)
  - id: ipify-b64
    desc: ipify.org (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aXBpZnkub3Jn"

  - id: ipinfo-b64
    desc: ipinfo.io (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aXBpbmZvLmlv"

  - id: wtfismyip-b64
    desc: wtfismyip (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "d3RmaXNteWlw"

  - id: iplogger-b64
    desc: iplogger.org (base64 encoded)
    crit: suspicious
    conf: 0.95
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aXBsb2dnZXIub3Jn"

  - id: icanhazip-b64
    desc: icanhazip.com (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aWNhbmhhemlw"

  - id: checkip-amazonaws-b64
    desc: checkip.amazonaws.com (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "Y2hlY2tpcC5hbWF6b25hd3MuY29t"

  - id: ifconfig-me-b64
    desc: ifconfig.me (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aWZjb25maWcubWU="

  - id: ifconfig-io-b64
    desc: ifconfig.io (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aWZjb25maWcuaW8="

  - id: ifconfig-co-b64
    desc: ifconfig.co (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aWZjb25maWcuY28="

  - id: ident-me-b64
    desc: ident.me (base64 encoded)
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    for: [all]
    if:
      type: string
      exact: "aWRlbnQubWU="

  # NOTE: The YARA rule below remains because DISSECT doesn't yet support
  # XOR obfuscation (xor(1-255)) in native traits. Once XOR support is added,
  # this can be migrated to atomic traits with type: string_xor
  - id: ip-recon-obfuscated-yara
    desc: Obfuscated IP reconnaissance via YARA
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    for: [all]
    if:
      type: yara
      source: |
        rule ip_recon_obfuscated {
          strings:
            $ipify_x = "ipify.org" xor(1-255)
            $ipinfo_x = "ipinfo.io" xor(1-255)
            $wtfismyip_x = "wtfismyip" xor(1-255)
            $iplogger_x = "iplogger.org" xor(1-255)
          condition:
            filesize < 50MB and any of them
        }

composite_rules:
  # Helper composite for all plaintext IP lookup services
  - id: plaintext-ip-services
    description: Plaintext IP lookup service references
    for: [all]
    any:
      - {id: ipify}
      - {id: ipinfo}
      - {id: ifconfig-me}
      - {id: icanhazip}
      - {id: wtfismyip}
      - {id: iplogger}
      - {id: ifconfig-io}
      - {id: ifconfig-co}
      - {id: ident-me}
      - {id: checkip-amazonaws}

  # Helper composite for all base64-encoded IP lookup services
  - id: base64-ip-services
    description: Base64-encoded IP lookup service references
    for: [all]
    any:
      - {id: ipify-b64}
      - {id: ipinfo-b64}
      - {id: wtfismyip-b64}
      - {id: iplogger-b64}
      - {id: icanhazip-b64}
      - {id: checkip-amazonaws-b64}
      - {id: ifconfig-me-b64}
      - {id: ifconfig-io-b64}
      - {id: ifconfig-co-b64}
      - {id: ident-me-b64}

  # Migrated from YARA (partial) - requires 2 different IP lookup services
  - id: ip-recon-detected
    desc: External IP address reconnaissance
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    for: [all]
    count: 2
    any:
      - {id: plaintext-ip-services}
      - {id: base64-ip-services}

  - id: ip-recon-obfuscated
    desc: Obfuscated IP reconnaissance
    crit: suspicious
    conf: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    for: [all]
    all:
      - id: ip-recon-obfuscated-yara
