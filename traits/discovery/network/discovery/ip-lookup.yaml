# Intelligence Gathering - External IP Discovery
# ATT&CK: T1016.001 (Internet Connection Discovery)

traits:
  - id: ipify
    description: ipify.org IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "ipify.org"

  - id: ipinfo
    description: ipinfo.io IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "ipinfo.io"

  - id: ifconfig-me
    description: ifconfig.me IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "ifconfig.me"

  - id: icanhazip
    description: icanhazip.com IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "icanhazip"

  - id: wtfismyip
    description: wtfismyip.com IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "wtfismyip"

  - id: iplogger
    description: iplogger.org IP logging service
    criticality: suspicious
    confidence: 0.9
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "iplogger.org"

  - id: ifconfig-io
    description: ifconfig.io IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "ifconfig.io"

  - id: ifconfig-co
    description: ifconfig.co IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "ifconfig.co"

  - id: ident-me
    description: ident.me IP lookup service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "ident.me"

  - id: checkip-amazonaws
    description: AWS checkip service
    criticality: suspicious
    confidence: 0.85
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "checkip.amazonaws.com"

  # Base64 encoded variants (common evasion)
  - id: ipify-b64
    description: ipify.org (base64 encoded)
    criticality: suspicious
    confidence: 0.9
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "aXBpZnkub3Jn"

  - id: ipinfo-b64
    description: ipinfo.io (base64 encoded)
    criticality: suspicious
    confidence: 0.9
    attack: "T1016.001"
    file_types: [all]
    condition:
      type: string
      exact: "aXBpbmZvLmlv"

composite_rules:
  - id: ip-recon-detected
    description: External IP address reconnaissance
    criticality: suspicious
    confidence: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    file_types: [all]
    requires_count: 2
    conditions:
      - id: ipify
      - id: ipinfo
      - id: ifconfig-me
      - id: icanhazip
      - id: wtfismyip
      - id: iplogger
      - id: ifconfig-io
      - id: ifconfig-co
      - id: ident-me
      - id: checkip-amazonaws
      - id: ipify-b64
      - id: ipinfo-b64

  - id: ip-recon-obfuscated
    description: Obfuscated IP reconnaissance
    criticality: suspicious
    confidence: 0.9
    attack: "T1016.001"
    mbc: "B0046"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule ip_recon_obfuscated {
          strings:
            $ipify_x = "ipify.org" xor(1-255)
            $ipinfo_x = "ipinfo.io" xor(1-255)
            $wtfismyip_x = "wtfismyip" xor(1-255)
            $iplogger_x = "iplogger.org" xor(1-255)
          condition:
            filesize < 50MB and any of them
        }
