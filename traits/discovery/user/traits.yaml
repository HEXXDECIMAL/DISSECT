# Intelligence Gathering - User Discovery
# ATT&CK: T1033 (System Owner/User Discovery)

traits:
  # === HOME environment atomic indicators ===
  - id: getenv-home
    description: getenv HOME lookup
    criticality: inert
    confidence: 0.5
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      regex: "getenv.*HOME"

  - id: env-dot-home
    description: env.HOME lookup
    criticality: inert
    confidence: 0.5
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      exact: "env.HOME"

  - id: dollar-home
    description: $HOME variable reference
    criticality: inert
    confidence: 0.5
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      exact: "$HOME"

  - id: appdata
    description: Windows APPDATA lookup
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [pe, python, javascript]
    condition:
      type: string
      exact: "APPDATA"

  - id: localappdata
    description: Windows LOCALAPPDATA lookup
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [pe, python, javascript]
    condition:
      type: string
      exact: "LOCALAPPDATA"

  - id: userprofile
    description: Windows USERPROFILE lookup
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [pe, python, javascript]
    condition:
      type: string
      exact: "USERPROFILE"

  # === Username environment atomic indicators ===
  - id: username-var
    description: USERNAME environment variable
    criticality: inert
    confidence: 0.5
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      exact: "USERNAME"

  - id: user-var
    description: USER environment variable
    criticality: inert
    confidence: 0.5
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      exact: "USER"

  - id: logname-var
    description: LOGNAME environment variable
    criticality: inert
    confidence: 0.5
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      exact: "LOGNAME"

  - id: getuid
    description: Get user ID
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getuid"

  - id: getpwuid
    description: Get password entry by UID
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getpwuid"

  - id: getpwnam
    description: Get password entry by name
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getpwnam"

  - id: dscl
    description: macOS Directory Service CLI
    criticality: suspicious
    confidence: 0.85
    attack: "T1087.001"
    file_types: [macho, shell]
    condition:
      type: string
      regex: "dscl\\s+\\."

  - id: dsenableroot
    description: macOS enable root user
    criticality: suspicious
    confidence: 0.85
    attack: "T1087.001"
    file_types: [macho, shell]
    condition:
      type: string
      exact: "dsenableroot"

  - id: whoami
    description: Current user lookup
    criticality: suspicious
    confidence: 0.75
    attack: "T1033"
    # Exclude JS - syntax highlighters have shell keywords
    file_types: [shell, elf, macho, pe, python]
    condition:
      type: string
      exact: "whoami"

  - id: etc-passwd
    description: Password file access
    criticality: suspicious
    confidence: 0.8
    attack: "T1087.001"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/passwd"

  - id: finger
    description: Finger command for user info
    criticality: suspicious
    confidence: 0.75
    attack: "T1033"
    file_types: [shell, elf, macho]
    condition:
      type: string
      exact: "finger"

  - id: last-cmd
    description: Last command for login history
    criticality: suspicious
    confidence: 0.8
    attack: "T1033"
    file_types: [shell, elf, macho]
    condition:
      type: string
      exact: "/usr/bin/last"

  - id: w-cmd
    description: W command for user sessions
    criticality: suspicious
    confidence: 0.75
    attack: "T1033"
    file_types: [shell, elf, macho]
    condition:
      type: string
      exact: "/usr/bin/w"

composite_rules:
  # HOME environment composite
  - id: home-env
    description: HOME environment variable lookup
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [all]
    requires_count: 1
    conditions:
      - type: trait
        id: getenv-home
      - type: trait
        id: env-dot-home
      - type: trait
        id: dollar-home

  # Username environment composite
  - id: username-env
    description: USERNAME environment variable
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [all]
    requires_count: 1
    conditions:
      - type: trait
        id: username-var
      - type: trait
        id: user-var
      - type: trait
        id: logname-var

  # Active enumeration commands
  - id: active-enum-cmds
    description: Active user enumeration commands
    criticality: notable
    confidence: 0.8
    attack: "T1033"
    file_types: [shell, elf, macho, pe, python]
    requires_count: 1
    conditions:
      - type: trait
        id: whoami
      - type: trait
        id: etc-passwd
      - type: trait
        id: dscl
      - type: trait
        id: finger
      - type: trait
        id: last-cmd
      - type: trait
        id: w-cmd

  # Passive user lookup functions
  - id: passive-user-lookup
    description: POSIX user lookup functions
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [elf, macho]
    requires_count: 1
    conditions:
      - type: trait
        id: getpwnam
      - type: trait
        id: getuid
      - type: trait
        id: getpwuid

  # User enumeration detected (active commands + context)
  - id: enumeration-detected
    description: User enumeration activity
    criticality: suspicious
    confidence: 0.9
    attack: "T1033"
    mbc: "B0046"
    file_types: [shell, elf, macho, pe, python]
    requires_all:
      - type: composite
        id: active-enum-cmds
    requires_any:
      - type: composite
        id: passive-user-lookup
      - type: composite
        id: username-env
      - type: composite
        id: home-env
