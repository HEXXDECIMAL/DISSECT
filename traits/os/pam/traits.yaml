# PAM (Pluggable Authentication Modules) Library Detection
# Useful for ML baseline - legitimate PAM usage patterns

traits:
  # PAM client API functions (symbols)
  - id: pam-start-symbol
    description: pam_start function symbol
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_start"

  - id: pam-end-symbol
    description: pam_end function symbol
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_end"

  - id: pam-authenticate-symbol
    description: pam_authenticate function symbol
    crit: inert
    confidence: 0.7
    condition:
      type: symbol
      exact: "pam_authenticate"

  - id: pam-acct-mgmt-symbol
    description: pam_acct_mgmt function symbol
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_acct_mgmt"

  - id: pam-setcred-symbol
    description: pam_setcred function symbol
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_setcred"

  # PAM libraries (strings)
  - id: libpam-so-string
    description: libpam.so library string
    crit: inert
    confidence: 0.6
    condition:
      type: string
      exact: "libpam.so"

  - id: libpam-string
    description: libpam library reference
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "libpam"

  # PAM module API functions (symbols)
  - id: pam-sm-authenticate-symbol
    description: pam_sm_authenticate module function
    crit: inert
    confidence: 0.7
    condition:
      type: symbol
      exact: "pam_sm_authenticate"

  - id: pam-sm-setcred-symbol
    description: pam_sm_setcred module function
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_sm_setcred"

  - id: pam-sm-acct-mgmt-symbol
    description: pam_sm_acct_mgmt module function
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_sm_acct_mgmt"

  - id: pam-sm-open-session-symbol
    description: pam_sm_open_session module function
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_sm_open_session"

  - id: pam-sm-close-session-symbol
    description: pam_sm_close_session module function
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_sm_close_session"

  # PAM handle types (strings)
  - id: pam-handle-t-string
    description: pam_handle_t type string
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "pam_handle_t"

  - id: pam-get-item-symbol
    description: pam_get_item function symbol
    crit: inert
    confidence: 0.6
    condition:
      type: symbol
      exact: "pam_get_item"

  # PAM configuration paths (strings)
  - id: pam-d-path
    description: /etc/pam.d/ directory path
    crit: inert
    confidence: 0.6
    condition:
      type: string
      exact: "/etc/pam.d/"

  - id: pam-conf-path
    description: /etc/pam.conf file path
    crit: inert
    confidence: 0.6
    condition:
      type: string
      exact: "/etc/pam.conf"

  # PAM module names (strings)
  - id: pam-unix-module
    description: pam_unix module reference
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "pam_unix"

  - id: pam-permit-module
    description: pam_permit module reference
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "pam_permit"

  - id: pam-deny-module
    description: pam_deny module reference
    crit: inert
    confidence: 0.5
    condition:
      type: string
      exact: "pam_deny"

  # PAM control flags (strings)
  - id: pam-required-control
    description: PAM required control flag
    crit: inert
    confidence: 0.4
    condition:
      type: string
      exact: "required"

  - id: pam-sufficient-control
    description: PAM sufficient control flag
    crit: inert
    confidence: 0.4
    condition:
      type: string
      exact: "sufficient"

# === Composite Rules ===
composite_rules:
  # PAM library references
  - id: pam-libraries
    description: PAM library references
    crit: inert
    conf: 0.6
    any:
      - id: libpam-so-string
      - id: libpam-string

  # PAM API functions
  - id: pam-api-functions
    description: PAM API function usage
    crit: inert
    conf: 0.7
    count_min: 3
    any:
      - id: pam-start-symbol
      - id: pam-end-symbol
      - id: pam-authenticate-symbol
      - id: pam-acct-mgmt-symbol
      - id: pam-setcred-symbol

  # PAM client usage
  - id: client
    description: PAM client library usage
    crit: benign
    conf: 0.9
    any:
      - id: pam-libraries
      - id: pam-api-functions

  # PAM module API functions
  - id: pam-module-api
    description: PAM module API functions
    crit: inert
    conf: 0.7
    count_min: 2
    any:
      - id: pam-sm-authenticate-symbol
      - id: pam-sm-setcred-symbol
      - id: pam-sm-acct-mgmt-symbol
      - id: pam-sm-open-session-symbol
      - id: pam-sm-close-session-symbol

  # PAM handle access
  - id: pam-handle-access
    description: PAM handle type and access
    crit: inert
    conf: 0.6
    any:
      - id: pam-handle-t-string
      - id: pam-get-item-symbol

  # Any PAM module function
  - id: any-pam-module-function
    description: Any PAM module API function
    crit: inert
    conf: 0.6
    any:
      - id: pam-sm-authenticate-symbol
      - id: pam-sm-setcred-symbol
      - id: pam-sm-acct-mgmt-symbol
      - id: pam-sm-open-session-symbol
      - id: pam-sm-close-session-symbol

  # PAM module with handle
  - id: pam-module-with-handle
    description: PAM module with handle access
    crit: inert
    conf: 0.7
    all:
      - id: any-pam-module-function
      - id: pam-handle-access

  # PAM module implementation
  - id: module
    description: PAM module implementation
    crit: benign
    conf: 0.85
    any:
      - id: pam-module-api
      - id: pam-module-with-handle

  # PAM configuration paths
  - id: pam-config-paths
    description: PAM configuration file paths
    crit: inert
    conf: 0.6
    any:
      - id: pam-d-path
      - id: pam-conf-path

  # PAM modules
  - id: pam-modules
    description: PAM module names
    crit: inert
    conf: 0.5
    count_min: 2
    any:
      - id: pam-unix-module
      - id: pam-permit-module
      - id: pam-deny-module

  # PAM control flags
  - id: pam-controls
    description: PAM control flags
    crit: inert
    conf: 0.4
    any:
      - id: pam-required-control
      - id: pam-sufficient-control

  # Any PAM module name
  - id: any-pam-module-name
    description: Any PAM module name
    crit: inert
    conf: 0.5
    any:
      - id: pam-unix-module
      - id: pam-permit-module
      - id: pam-deny-module

  # PAM module with control
  - id: pam-module-with-control
    description: PAM module with control flag
    crit: inert
    conf: 0.6
    all:
      - id: any-pam-module-name
      - id: pam-controls

  # PAM configuration
  - id: config
    description: PAM configuration patterns
    crit: benign
    conf: 0.9
    any:
      - id: pam-config-paths
      - id: pam-modules
      - id: pam-module-with-control
