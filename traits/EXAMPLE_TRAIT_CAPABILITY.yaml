# Example: Trait-Based Architecture
# Everything is fundamentally a TRAIT (simple or composite)
# Traits can optionally be classified as CAPABILITIES (what a program can do)
#
# Simple Traits = Atomic observations (building blocks, always exported for ML)
# Composite Traits = Behavioral interpretations (combine simple traits)
# Capability Flag = Marks traits that are meaningful standalone

# ============================================================================
# TRAITS: Atomic Observations
# ============================================================================
# Each trait is a single, observable characteristic
# Traits are ALWAYS exported in the analysis report for ML training
# Add "capability: true" to also emit as a standalone capability
#
# Criticality levels:
# - none: Internal building block only (default)
# - low: Notable but benign observation
# - medium: Suspicious behavior
# - high: Dangerous or malicious indicator

traits:
  # Network API usage (ALSO a capability - meaningful on its own)
  - id: net/api/socket
    description: Uses socket API
    capability: true  # ← Also emit as capability
    criticality: low  # ← Notable observation
    confidence: 1.0
    type: symbol
    pattern: socket

  - id: net/api/connect
    description: Uses connect API
    capability: true  # ← Also emit as capability
    criticality: low  # ← Notable observation
    confidence: 1.0
    type: symbol
    pattern: connect

  # I/O redirection (trait only - not meaningful alone)
  - id: exec/api/dup2
    description: Uses dup2 to redirect I/O
    criticality: none  # ← Internal building block (default)
    confidence: 1.0
    type: symbol
    pattern: dup2
    # No "capability" field - just a building block

  # Shell references (trait only - just strings, need context)
  - id: exec/shell/bin-sh
    description: References /bin/sh
    criticality: none  # ← Building block only
    confidence: 1.0
    type: string
    exact: '/bin/sh'
    # No "capability" - could be docs/comments

  - id: exec/shell/bin-bash
    description: References /bin/bash
    criticality: none  # ← Building block only
    confidence: 1.0
    type: string
    exact: '/bin/bash'
    # No "capability" - could be docs/comments

  # Base64 decoding (trait only - too common to be meaningful alone)
  - id: encoding/base64/decode
    description: Base64 decoding
    criticality: none  # ← Too common, needs context
    confidence: 0.9
    type: symbol_or_string
    any:
      - b64decode
      - base64_decode
      - Buffer.from
      - atob

  # Dynamic code execution (ALSO a capability - dangerous on its own!)
  - id: exec/dynamic/eval
    description: Dynamic code evaluation
    capability: true  # ← Meaningful standalone
    criticality: high  # ← Dangerous capability
    confidence: 1.0
    type: symbol_or_string
    any:
      - eval
      - exec
      - Function

  # Telegram API (ALSO a capability - clear exfil indicator)
  - id: exfil/telegram/api
    description: Telegram Bot API
    capability: true  # ← Meaningful standalone
    criticality: high  # ← Clear exfiltration indicator
    confidence: 1.0
    type: string
    exact: 'api.telegram.org'

  - id: exfil/telegram/send
    description: Telegram send methods
    criticality: none  # ← Building block only
    confidence: 0.9
    type: string
    regex: '/(sendMessage|sendDocument|sendPhoto)'

  # Discord webhook (ALSO a capability - clear exfil indicator)
  - id: exfil/discord/webhook
    description: Discord webhook URL
    capability: true  # ← Meaningful standalone
    criticality: high  # ← Clear exfiltration indicator
    confidence: 1.0
    type: string
    regex: '(discordapp\.com|discord\.com)/api/webhooks'

# ============================================================================
# COMPOSITE TRAITS: Behavioral Interpretations
# ============================================================================
# Composite traits combine simple traits to detect specific behaviors
# Section name: can use "capabilities:" or "composite_rules:" (both accepted)
# Field names: can use "id:" or "capability:" (both accepted for compatibility)
# IMPORTANT: Composite traits MUST reference other traits by ID (enforces building blocks)

capabilities:
  # Classic reverse shell pattern
  - id: net/reverse-shell
    description: Reverse shell pattern (socket + dup2 + shell)
    confidence: 0.95
    criticality: high  # Reverse shell = malicious
    platforms: [linux, macos, unix]
    file_types: [elf, macho]

    requires_all:
      - trait: net/api/socket
      - trait: net/api/connect
      - trait: exec/api/dup2
      - trait: exec/shell/bin-sh

  # Obfuscated code execution
  - id: exec/obfuscated/base64-eval
    description: Base64-encoded code execution (obfuscation)
    confidence: 0.95
    criticality: medium  # Suspicious obfuscation
    platforms: [all]

    requires_all:
      - trait: encoding/base64/decode
      - trait: exec/dynamic/eval

  # Telegram exfiltration
  - id: c2/exfil/telegram
    description: Data exfiltration via Telegram
    confidence: 0.95
    criticality: high  # Clear exfiltration = malicious
    platforms: [all]

    requires_all:
      - trait: exfil/telegram/api
      - trait: exfil/telegram/send

  # Discord exfiltration
  - id: c2/exfil/discord
    description: Data exfiltration via Discord webhook
    confidence: 0.9
    criticality: high  # Clear exfiltration = malicious
    platforms: [all]

    requires_count: 1
    conditions:
      - trait: exfil/discord/webhook

# ============================================================================
# DEVELOPER BENEFITS
# ============================================================================
#
# 1. SIMPLE: Define traits once, mark meaningful ones with "capability: true"
# 2. CLEAR: See which observations are meaningful vs building blocks
# 3. ML-FRIENDLY: All traits always exported for training
# 4. FLEXIBLE: Traits can be capabilities, building blocks, or both
# 5. NO DUPLICATION: One definition, dual output
#
# Example workflow:
# 1. Add new trait: "net/api/socket"
# 2. Mark as capability: "capability: true" (if meaningful standalone)
# 3. Use in composite: "net/reverse-shell" requires socket + dup2 + shell
# 4. Output includes:
#    - trait: net/api/socket (always)
#    - capability: net/api/socket (because capability: true)
#    - capability: net/reverse-shell (composite)
#
# Guidelines for "capability: true":
# - YES: exec/dynamic/eval (dangerous)
# - YES: net/api/socket (network access)
# - YES: exfil/telegram/api (clear exfiltration)
# - NO: exec/shell/bin-sh (just a string, needs context)
# - NO: exec/api/dup2 (I/O redirect, meaningless alone)
# - NO: encoding/base64/decode (too common, benign)
#
# Guidelines for criticality levels:
# - none: Internal building blocks (exec/shell/bin-sh, exec/api/dup2, encoding/base64/decode)
# - low: Notable but benign capabilities (net/api/socket, net/api/connect)
# - medium: Suspicious behavior (obfuscation, anti-analysis techniques)
# - high: Dangerous/malicious indicators (reverse shells, exfiltration, code injection)
