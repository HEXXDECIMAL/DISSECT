# Malware Family - UNC1945
# Threat Actor Attribution: Mandiant/Google Threat Intelligence
# Behavior: statdx-scan RPC vulnerability scanner toolkit
# References:
#   - https://mandiant.wiz.io/blogs/unc1945-infra-research
#   - statdx-scan targets rpc.statd vulnerability (CVE-2005-0001 era exploits)
# ATT&CK: T1046 (Network Service Discovery), T1018 (Remote System Discovery)

traits:
  # Atomic patterns for statdx-scan detection

  - id: utils-tar-gz-gzip-archive
    desc: .utils.tar.gz gzip archive file
    crit: suspicious
    conf: 0.85
    attack: "T1046"
    mbc: "E1046"
    for: [all]
    if:
      type: yara
      source: |
        rule gzip_tar_utils {
          strings:
            $magic = { 1F 8B }
            $tarname = "tmpfile.tar"
          condition:
            $magic at 0 and $tarname
        }

  - id: statdx-scanner-binary
    desc: statdx RPC service enumeration binary
    crit: suspicious
    conf: 0.9
    attack: "T1046"
    mbc: "E1046"
    for: [elf]
    if:
      type: string
      regex: "rpc\\.statd|100024|pmap_getmaps"

  - id: statdx-shell-loader
    desc: statdx shell script loader (osscan pattern)
    crit: suspicious
    conf: 0.9
    attack: "T1046"
    mbc: "E1046"
    for: [shell]
    if:
      type: raw
      regex: "StatdX.{0,20}Scan.{0,10}v|cat\\s+.{0,20}statdx\\.log"

  - id: statdx-probing-script
    desc: statdx FTP probing script (.bla pattern)
    crit: suspicious
    conf: 0.85
    attack: "T1046"
    mbc: "E1046"
    for: [shell]
    if:
      type: raw
      regex: "Probing.{0,15}FTP|\\./\\.os\\s+\\$1\\s+21"

composite_rules:
  # Any archive file containing RPC enumeration patterns indicates scanner toolkit
  - id: rpc-enumeration-archive
    desc: Archive with RPC service enumeration
    crit: suspicious
    conf: 0.9
    attack: "T1046"
    mbc: "E1046"
    for: [all]
    all:
      - id: utils-tar-gz-gzip-archive
      - id: objectives/lateral-movement/scan/port::rpc-enum-pmap

  # statdx-scan RPC + shell integration: any 2 of the key indicators
  - id: statdx-scan-toolkit
    desc: statdx-scan RPC vulnerability scanner toolkit
    crit: suspicious
    conf: 0.92
    attack: "T1046"
    mbc: "E1046"
    for: [all]
    needs: 2
    any:
      - id: statdx-scanner-binary
      - id: statdx-shell-loader
      - id: statdx-probing-script

  # Complete toolkit detection combining RPC enumeration with xargs looping
  - id: statdx-complete-compromise
    desc: Complete statdx-scan vulnerability scanner suite
    crit: suspicious
    conf: 0.95
    attack: "T1046"
    mbc: "E1046"
    for: [all]
    all:
      - id: objectives/lateral-movement/scan/port::rpc-enum-pmap
      - id: objectives/lateral-movement/scan/port::xargs-dotfile-loop
