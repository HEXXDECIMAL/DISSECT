# Known Malware: Chrysalis Installer Detection Rules
# Nullsoft NSIS installer deployment patterns

composite_rules:
  # === NSIS Installer Signature ===
  - id: nsis-installer-detected
    desc: Nullsoft NSIS installer detected
    crit: notable
    conf: 0.90
    for: ["pe"]
    all:
      - id: well-known/malware/trojan/chrysalis-installer::nullsoft-installer
      - id: well-known/malware/trojan/chrysalis-installer::nsis-version

  # NOTE: Generic installer patterns removed - they matched ALL Windows installers.
  # Chrysalis-specific detection requires unique IOCs beyond standard NSIS patterns.
  #
  # The following patterns were removed as false positives:
  # - registry-installation: Generic registry writes (all installers do this)
  # - elevated-installation: Generic privilege escalation (all admin installers do this)
  #
  # To restore Chrysalis detection, add specific indicators:
  # - Unique C2 domains/IPs
  # - Specific registry keys used by Chrysalis
  # - Characteristic file paths or mutexes
  # - Unique string patterns in the binary

  # === DISABLED: Too Generic ===
  # The following rules match ALL NSIS installers, not just Chrysalis.
  # Commented out to prevent false positives on legitimate software.
  #
  # - id: installer-detected
  #   desc: Chrysalis installer (update.exe) detected
  #   crit: suspicious
  #   conf: 0.75
  #   for: ["pe"]
  #   all:
  #     - id: well-known/malware/trojan/chrysalis-installer::nsis-installer-detected
  #     - id: micro-behaviors/os/registry/access::reg-set-value
  #     - id: micro-behaviors/process/create/spawn::create-process-w
  #     - id: micro-behaviors/io/console/output::write-file
  #
  # - id: full-deployment
  #   desc: Complete malware deployment pattern
  #   crit: suspicious
  #   conf: 0.80
  #   for: ["pe"]
  #   all:
  #     - id: well-known/malware/trojan/chrysalis-installer::installer-detected
  #     - id: micro-behaviors/os/privilege/escalation::adjust-token-privileges
  #     - id: micro-behaviors/data/encode/compression::lzma-signature
