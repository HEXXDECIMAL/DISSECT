# JavaScript Dropper and Staged Payload Patterns
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  attack: "T1027"
  mbc: "C0025"

traits:
  # === Crypto library imports ===
  - id: from-crypto-import
    desc: from 'crypto' import
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "from\\s+['\"]crypto['\"]"

  - id: import-crypto
    desc: import crypto
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "import\\s+.{0,50}['\"]crypto['\"]"

  # === Decryption methods ===
  - id: createdecipher-call
    desc: crypto.createDecipher call
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "createDecipher"

  # Removed createdecipheriv-call duplicate - use micro-behaviors/crypto/symmetric/aes::createDecipheriv

  - id: decrypt-call
    desc: .decrypt() method call
    crit: inert
    conf: 0.65
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "decrypt"

  # === Execution methods ===
  # Moved to objectives/execution/interpreter/eval/dynamic/eval-call
  # Removed function-constructor duplicate - use objectives/anti-static/obfuscation/require::function-constructor

  # === Large encoded blobs ===
  - id: large-hex-string
    desc: Large hex-encoded string (128+ chars)
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: '[''"][0-9a-fA-F]{128,}[''"]'

  - id: large-base64-string
    desc: Large base64-encoded string (128+ chars)
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: '[''"][a-zA-Z0-9+/]{128,}={0,2}[''"]'

  # === Buffer decoding ===
  - id: buffer-from-hex
    desc: Buffer.from with 'hex' encoding
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\(.{0,60}['\"]hex['\"]\\)"

  - id: buffer-from-base64
    desc: Buffer.from with 'base64' encoding
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\(.{0,60}['\"]base64['\"]\\)"

  - id: buffer-from-utf8
    desc: Buffer.from with 'utf8' encoding
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\(.{0,60}['\"]utf8['\"]\\)"

  # === AST-based eval detection ===
  - id: eval-ast-call
    desc: eval() via AST pattern
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      exact: "eval"

  - id: js-staged-generator
    desc: Uses a generator function to yield eval
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: 'function\*.{0,50}yield\s+eval\('

composite_rules:
  # Helper composites
  - id: crypto-import-patterns
    desc: Crypto library imports
    for: [javascript, typescript]
    any:
      - { id: micro-behaviors/crypto/symmetric/aes::crypto-require-call }
      - { id: from-crypto-import }
      - { id: import-crypto }

  - id: decryption-methods
    desc: Decryption method calls
    for: [javascript, typescript]
    any:
      - { id: createdecipher-call }
      - { id: micro-behaviors/crypto/symmetric/aes::createDecipheriv }
      - { id: decrypt-call }

  - id: code-execution-methods
    desc: Dynamic code execution methods
    crit: notable
    conf: 0.9
    for: [javascript, typescript]
    any:
      - { id: objectives/execution/interpreter/eval/dynamic::eval-call-js }
      - { id: eval-ast-call }
      - { id: objectives/anti-static/obfuscation/require::function-constructor }

  - id: encoded-blobs
    desc: Large encoded data blobs
    for: [javascript, typescript]
    any:
      - { id: large-hex-string }
      - { id: large-base64-string }

  - id: buffer-decoding
    desc: Buffer decoding operations
    for: [javascript, typescript]
    any:
      - { id: buffer-from-hex }
      - { id: buffer-from-base64 }
      - { id: buffer-from-utf8 }

  - id: encoded-data
    desc: Encoded data (blobs or buffer decoding)
    for: [javascript, typescript]
    any:
      - { id: encoded-blobs }
      - { id: buffer-decoding }

  # Main composite (migrated from YARA)
  - id: js-decrypt-eval
    desc: Decrypts a hardcoded payload and executes it
    crit: suspicious
    conf: 0.95
    for: [javascript, typescript]
    all:
      - { id: crypto-import-patterns }
      - { id: decryption-methods }
      - { id: code-execution-methods }
      - { id: encoded-data }

  # Remote code execution: HTTP fetch + eval
  # Pattern: axios.get(...).then(res => eval(res.data))
  # Complexity: for(+1) + all(+2) = 3, needs size_max for +1 = 4
  - id: js-remote-exec
    desc: Fetches and executes remote code
    crit: hostile
    conf: 0.95
    attack: "T1105"
    mbc: "B0024"
    for: [javascript, typescript]
    size_max: 10000
    all:
      - { id: micro-behaviors/comm/http/request/}
      - { id: code-execution-methods }
