# LinkedOpports Dropper Family
# Identified by exfiltration to linkedopports.com and download from python-release.com
# Often uses "firstbasicpyapp" as a description.

defaults:
  for: [python]
  attack: "T1195.002"

traits:
  - id: linkedopports-domain
    desc: linkedopports.com domain (LinkedOpports family)
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "linkedopports.com"

  - id: python-release-domain
    desc: python-release.com domain (LinkedOpports family)
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "python-release.com"

  - id: firstbasicpyapp-desc
    desc: firstbasicpyapp description marker
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "firstbasicpyapp"

  - id: python-install-scr-url
    desc: python-release.com/python-install.scr URL (LinkedOpports family)
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "python-release.com/python-install.scr"

  - id: pyp-dropped-exe
    desc: Dropped executable name (LinkedOpports family)
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: "ini_file_pyp_.{0,100}\\.exe"

  - id: pyp-app-keyword-elevate
    desc: Specific app keywords (LinkedOpports family)
    crit: notable
    conf: 0.9
    if:
      type: string
      exact: "elevatepyapp"

  - id: pyp-app-keyword-praise
    desc: Specific app keywords (LinkedOpports family)
    crit: notable
    conf: 0.9
    if:
      type: string
      exact: "praisepyapp"

  - id: pyp-unique-comments
    desc: Unique LinkedOpports family comments
    crit: notable
    conf: 1.0
    if:
      type: raw
      regex: "#firstbasicpyapp,\\s*elevatepyapp,\\s*praisepyapp"

  - id: ina-function
    desc: Suspicious ina() function (LinkedOpports family)
    crit: suspicious
    conf: 0.95
    if:
      type: ast
      query: |
        (function_definition
          name: (identifier) @name (#eq? @name "ina")
          body: (block
            (expression_statement
              (call
                function: (identifier) @func (#eq? @func "print")
                arguments: (argument_list (string (string_content) @str (#match? @str "installed")))
              )
            )
          )
        )

composite_rules:
  - id: linkedopports-dropper
    desc: LinkedOpports supply-chain dropper
    crit: hostile
    conf: 1.0
    all:
      - id: linkedopports-domain
      - id: python-release-domain
    any:
      - id: objectives/command-and-control/uri/fragment::pyp-resp-php-path
      - id: objectives/command-and-control/uri/fragment::installation-new-c-kw
      - id: firstbasicpyapp-desc
      - id: pyp-dropped-exe
      - id: pyp-app-keywords
      - id: pyp-unique-comments
      - id: ina-function
      - id: micro-behaviors/process/create/launch::python-start-process
      - id: objectives/lateral-movement/supply-chain/pypi/install-patterns::pypi-install-dropper

  - id: pyp-app-keywords
    desc: Specific app keywords (LinkedOpports family)
    crit: notable
    conf: 0.9
    any:
      - id: pyp-app-keyword-elevate
      - id: pyp-app-keyword-praise
