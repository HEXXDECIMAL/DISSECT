# Hadooken Malware Detection
# ATT&CK: T1059 (Command and Scripting Interpreter)
# MBC: B0030 (Remote Access)

traits:
  # === Hadooken Name Variants ===
  - id: hadooken-lower
    desc: hadooken string (lowercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "hadooken"

  - id: hadooken-title
    desc: Hadooken string (title case)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Hadooken"

  - id: hadooken-upper
    desc: HADOOKEN string (uppercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "HADOOKEN"

  - id: hadouken-lower
    desc: hadouken string (lowercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "hadouken"

  - id: hadouken-title
    desc: Hadouken string (title case)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Hadouken"

  - id: hadouken-upper
    desc: HADOUKEN string (uppercase)
    crit: inert
    conf: 0.85
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "HADOUKEN"

  # === Street Fighter References ===
  - id: shoryuken-lower
    desc: shoryuken string (lowercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "shoryuken"

  - id: shoryuken-title
    desc: Shoryuken string (title case)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Shoryuken"

  - id: shoryuken-upper
    desc: SHORYUKEN string (uppercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "SHORYUKEN"

  - id: tatsumaki-lower
    desc: tatsumaki string (lowercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "tatsumaki"

  - id: tatsumaki-title
    desc: Tatsumaki string (title case)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "Tatsumaki"

  - id: tatsumaki-upper
    desc: TATSUMAKI string (uppercase)
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      word: "TATSUMAKI"

  # === Dropper Patterns ===
  - id: download-and-execute
    desc: download_and_execute function
    crit: inert
    conf: 0.75
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      substr: "download_and_execute"

  # Removed wget-output - use micro-behaviors/communications/download/curl::wget-output
  # Removed curl-output - use micro-behaviors/communications/download/curl::curl-output

  # === Mining Tools ===
  # Removed minerd-tool - use objectives/lateral-movement/evasion/competing-malware::minerd-targeting
  # Removed cpuminer-tool - use objectives/lateral-movement/evasion/competing-malware::cpuminer-targeting

  # === Pool Configuration ===
  # Note: stratum+ already defined in kinsing traits
  - id: pool-dot
    desc: pool. domain prefix pattern
    crit: inert
    conf: 0.65
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      # Must be followed by a TLD-like pattern to be a mining pool domain
      regex: "pool\\.[a-z]{2,10}(?:/|$|:)"

  # === Persistence Mechanisms ===
  # Removed etc-cron-path duplicate - use objectives/persist/cron/job::etc-cron-path

  # === IRC Bot Commands ===
  - id: irc-privmsg
    desc: PRIVMSG IRC command
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      substr: "PRIVMSG"

  # Removed irc-nick duplicate - use objectives/command-and-control/irc/bot::irc-nick

  - id: irc-join
    desc: IRC JOIN command for channel
    crit: inert
    conf: 0.7
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      substr: "JOIN #"

  # === Shell Execution Functions ===
  # Removed system-call - use micro-behaviors/process/create/shell::system-call
  # Removed exec-call duplicate - use objectives/execution/interpreter/eval/invoke::exec-call-shell
  # Removed popen-call - use micro-behaviors/process/create/shell::c-popen

  # === Hadooken-specific binary names ===
  - id: crondr-binary
    desc: crondr binary (Hadooken dropper)
    crit: suspicious
    conf: 0.95
    for: [elf, macho, shell]
    if:
      type: raw
      regex: "crondr"

  - id: crondr-path
    desc: /bin/crondr path (Hadooken)
    crit: suspicious
    conf: 0.95
    for: [elf, macho, shell]
    if:
      type: raw
      regex: "/bin/crondr"

composite_rules:
  # === Helper composites ===
  - id: hadooken-keyword
    desc: Hadooken keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-lower
      - id: hadooken-title
      - id: hadooken-upper

  - id: hadouken-keyword
    desc: Hadouken keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadouken-lower
      - id: hadouken-title
      - id: hadouken-upper

  - id: hadooken-names
    desc: Hadooken name variants
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-keyword
      - id: hadouken-keyword

  - id: shoryuken-keyword
    desc: Shoryuken keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: shoryuken-lower
      - id: shoryuken-title
      - id: shoryuken-upper

  - id: tatsumaki-keyword
    desc: Tatsumaki keyword (case variants)
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: tatsumaki-lower
      - id: tatsumaki-title
      - id: tatsumaki-upper

  - id: street-fighter-refs
    desc: Street Fighter references
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: shoryuken-keyword
      - id: tatsumaki-keyword

  - id: dropper-patterns
    desc: Download and execute patterns
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: download-and-execute
      - id: micro-behaviors/communications/download/curl::wget-output
      - id: micro-behaviors/communications/download/curl::curl-output

  - id: mining-tools
    desc: Cryptocurrency mining tools
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: objectives/lateral-movement/evasion/competing-malware::minerd-targeting
      - id: objectives/lateral-movement/evasion/competing-malware::cpuminer-targeting

  - id: persistence-methods
    desc: Persistence mechanisms
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: micro-behaviors/persist/cron/keywords::crontab-keyword
      - id: objectives/persist/cron/job::etc-cron-path

  - id: irc-commands
    desc: IRC bot commands
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: irc-privmsg
      - id: objectives/command-and-control/irc/bot::irc-nick
      - id: irc-join

  - id: shell-execution
    desc: Shell command execution functions
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: micro-behaviors/process/create/shell::system-fn
      - id: micro-behaviors/process/create/shell::system-call-word
      - id: objectives/execution/interpreter/eval/invoke::exec-call-shell
      - id: micro-behaviors/process/create/shell::c-popen

  # === Helper composite ===
  - id: street-fighter-dropper
    desc: Street Fighter references with dropper
    all:
      - id: street-fighter-refs
      - id: dropper-patterns

  # === Migrated from YARA ===
  - id: hadooken-generic
    desc: Hadooken malware dropper patterns
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1059"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-names
      - id: street-fighter-dropper

  - id: mining-deployment
    desc: Mining tools with pool config
    all:
      - id: mining-tools
      - id: pool-dot
      - id: persistence-methods

  - id: miner
    desc: Hadooken cryptominer deployment
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-keyword
      - id: mining-deployment

  - id: irc-webshell
    desc: IRC commands with shell execution
    all:
      - id: irc-commands
        needs: 2
      - id: shell-execution

  - id: webshell
    desc: Hadooken webshell deployment
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1505.003"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-keyword
      - id: irc-webshell

  # crondr binary reference composite
  - id: crondr-reference
    desc: Hadooken crondr binary reference
    crit: suspicious
    conf: 0.95
    for: [elf, macho, shell]
    any:
      - id: crondr-binary
      - id: crondr-path

  # Hadooken detection
  - id: detected
    desc: "Hadooken malware detected"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1059"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: hadooken-generic
      - id: miner
      - id: webshell
      - id: crondr-reference
