---
# CVE-2015-5889: Local Privilege Escalation via MallocStackLogging
# macOS local root exploit using issetugid() + rsh + libmalloc
# ATT&CK: T1068 (Exploitation for Privilege Escalation)
# MBC: E1548 (Abuse Elevation Control Mechanism)

defaults:
  for: [python]
  platforms: [macos, unix]

traits:
  - id: malloc-stack-logging
    desc: MallocStackLogging environment variable
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    mbc: "E1548"
    if:
      type: string
      substr: "MallocStackLogging"

  - id: rsh-exec
    desc: Remote shell execution via rsh (CVE-2015-5889 exploit-specific)
    crit: suspicious
    conf: 0.85
    attack: "T1068"
    if:
      type: string
      substr: "/usr/bin/rsh"

  - id: sudoers-privilege-escalation
    desc: Sudoers file privilege escalation
    crit: suspicious
    conf: 0.85
    attack: "T1068"
    if:
      type: string
      substr: "NOPASSWD: ALL"

  - id: cve-reference
    desc: CVE-2015-5889 reference
    crit: notable
    conf: 0.9
    attack: "T1068"
    if:
      type: string
      substr: "CVE-2015-5889"

composite_rules:
  # Full CVE-2015-5889 exploit pattern: MallocStackLogging + rsh + sudoers manipulation
  - id: exploit
    desc: CVE-2015-5889 privilege escalation exploit
    crit: hostile
    conf: 0.95
    attack: "T1068"
    mbc: "E1548"
    all:
      - id: malloc-stack-logging
      - id: rsh-exec
      - id: sudoers-privilege-escalation
