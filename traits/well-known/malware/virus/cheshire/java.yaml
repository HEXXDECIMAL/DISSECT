# Virus:Java/Cheshire.A Indicators

defaults:
  for: [all]

traits:
  - id: method-definition-cheshire
    desc: "Definition of the 'Cheshire' virus method"
    crit: suspicious
    conf: 1.0
    for: [java]
    if:
      type: ast
      kind: function
      regex: '(?i)Cheshire'

  - id: method-definition-parseClassFile
    desc: "Manual class file parsing method"
    crit: notable
    conf: 0.9
    for: [java]
    if:
      type: ast
      kind: function
      regex: 'parseClassFile'

  - id: method-definition-copyMethod
    desc: "Method injection/copying logic"
    crit: notable
    conf: 0.9
    for: [java]
    if:
      type: ast
      kind: function
      regex: 'copyMethod'

  - id: method-definition-isInfected
    desc: "Method to check for infection status"
    crit: suspicious
    conf: 1.0
    for: [java]
    if:
      type: ast
      kind: function
      regex: 'isInfected'

  - id: payload-string-mad
    desc: "Unique Cheshire payload string"
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "We're all mad down here...you may notice that I'm not all there myself."

  - id: payload-string-dongs
    desc: "Unique Cheshire marker file string"
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "dongs.txt"

  - id: jar-search-logic
    desc: "Recursive search for JAR files"
    crit: suspicious
    conf: 0.8
    if:
      type: raw
      regex: '\.getName\(\)\.endsWith\(["'']\.jar["'']\)'

  - id: hardcoded-test-path
    desc: "Hardcoded path from Cheshire test environment"
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "VirtualMachineTest.class"

composite_rules:
  - id: cheshire-virus-source
    desc: "Virus:Java/Cheshire.A source code detected"
    crit: hostile
    conf: 1.0
    all:
      - id: method-definition-cheshire
      - id: micro-behaviors/data/source/parser/bytecode::java-bytecode-magic
    any:
      - id: payload-string-mad
      - id: jar-search-logic
      - id: method-definition-parseClassFile
      - id: hardcoded-test-path
      - id: payload-string-dongs
      - id: method-definition-isInfected

  - id: cheshire-virus-infection-logic
    desc: "Virus:Java/Cheshire.A infection logic detected"
    crit: hostile
    conf: 1.0
    all:
      - id: method-definition-isInfected
      - id: method-definition-copyMethod
    any:
      - id: method-definition-parseClassFile
      - id: method-definition-cheshire
