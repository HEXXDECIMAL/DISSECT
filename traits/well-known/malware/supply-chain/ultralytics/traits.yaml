# Ultralytics Supply Chain Attack Pattern (2024)
# Detects malware disguised as legitimate ML library modifications
# ATT&CK: T1195.002 (Supply Chain Compromise)
# MBC: B0024 (Dropper)

defaults:
  attack: "T1195.002"
  mbc: "B0024"
  for: [python]

traits:
  # Import of safe_run function from downloads module
  - id: safe-run-import
    desc: safe_run dropper import
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "import\\s+.{0,30}safe_run"

  # Definition of safe_run function
  - id: safe-run-def
    desc: safe_run dropper definition
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "def safe_run\\("

  # Call to safe_run with /tmp path
  - id: safe-run-tmp
    desc: safe_run tmp execution
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "safe_run\\(\\s*[\"']/tmp/"

  # Typosquatting domain used in C2
  - id: consrensys-domain
    desc: Typosquatting consrensys.com domain
    crit: suspicious
    conf: 1.0
    mbc: "C0002" # C2
    attack: "T1071.001" # Web Service
    if:
      type: string
      substr: "consrensys.com"

  # Specific hardcoded miner wallet
  - id: ultralytics-miner-wallet
    desc: Specific hardcoded miner wallet
    crit: suspicious
    conf: 1.0
    mbc: "B0036" # Cryptominer
    attack: "T1496" # Resource Hijacking
    if:
      type: string
      substr: "4BHRQHFexjzfVjinAbrAwJdtogpFV3uCXhxYtYnsQN66CRtypsRyVEZhGc8iWyPViEewB8LtdAEL7CdjE4szMpKzPGjoZnw"

  # Git blob SHA pattern (40 hex chars) - detected as long hex string
  - id: git-blob-sha
    desc: Git blob SHA payload
    crit: notable
    conf: 0.80
    if:
      type: raw
      regex: '"[a-f0-9]{40}"'

  # gitApi parameter in function call
  - id: gitapi-param
    desc: gitApi=True parameter for GitHub API
    crit: notable
    conf: 0.85
    if:
      type: raw
      substr: "gitApi=True"

  # ultralytics_runner binary name
  - id: ultralytics-runner
    desc: Ultralytics runner payload name
    crit: suspicious
    conf: 0.98
    if:
      type: string
      substr: "ultralytics_runner"

  # Ultralytics v8.3.46 xmrig dropper pattern
  # Downloads xmrig from GitHub and runs with supportxmr pool
  - id: xmrig-dropper
    desc: xmrig download in os.system
    crit: suspicious
    conf: 0.98
    if:
      type: string
      regex: "xmrig.{0,50}supportxmr"

  # Module-level platform check with os.system
  - id: module-platform-exec
    desc: Platform check with os.system execution
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      regex: 'if\s+"Linux"\s+in\s+platform\.system\(\).{0,50}os\.system'

composite_rules:
  # Download and run from tmp via gitApi
  - id: github-dropper
    desc: Download via GitHub API and execute
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    for: [python]
    needs: 2
    any:
      - id: git-blob-sha
      - id: gitapi-param
      - id: objectives/execution/dropper/tmp-run::tmp-path

  - id: safe-run-entry
    desc: safe_run entry point
    crit: suspicious
    conf: 0.95
    any:
      - id: safe-run-import
      - id: safe-run-def

  - id: safe-run-behavior
    desc: safe_run behavior
    crit: suspicious
    conf: 0.95
    any:
      - id: safe-run-tmp
      - id: ultralytics-runner
      - id: github-dropper

  # Complete ultralytics-style supply chain attack (safe_run variant)
  - id: detected-safe-run
    desc: Ultralytics safe_run dropper
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    for: [python]
    all:
      - id: safe-run-entry
      - id: safe-run-behavior

  # Combined detection for all Ultralytics variants
  # Complexity: any:+1, file_types:+1, all:+2 = 4
  - id: detected
    desc: Ultralytics supply chain attack
    crit: suspicious
    conf: 0.98
    attack: "T1195.002"
    for: [python]
    any:
      - id: detected-safe-run
      - id: xmrig-dropper
      - id: module-platform-exec
      - id: consrensys-domain
      - id: ultralytics-miner-wallet
