defaults:
  for: [python]

traits:
  - id: check-text-func
    desc: Detects check_text function definition
    crit: notable
    conf: 0.8
    if:
      type: symbol
      exact: "check_text"

  - id: check-image-func
    desc: Detects check_image function definition
    crit: notable
    conf: 0.8
    if:
      type: symbol
      exact: "check_image"

  - id: spellchecker-class
    desc: Detects SpellChecker class definition
    crit: notable
    conf: 0.8
    if:
      type: ast
      query: |
        (class_definition
          name: (identifier) @name
          (#eq? @name "SpellChecker"))

composite_rules:
  - id: spellcheckpy-suspicious-method
    desc: Detects suspicious methods in spellcheckpy context
    crit: notable
    conf: 0.8
    any:
      - id: well-known/malware/supply-chain/pypi::check-text-func
      - id: well-known/malware/supply-chain/pypi::check-image-func

  - id: spellcheckpy-openai-structural
    desc: Detects spellcheckpy malware via structural analysis (OpenAI + SpellChecker + Suspicious Method)
    crit: hostile
    conf: 1.0
    all:
      - type: trait
        id: objectives/discovery/ai/openai::openai-ref
      - id: well-known/malware/supply-chain/pypi::spellchecker-class
      - id: well-known/malware/supply-chain/pypi::spellcheckpy-suspicious-method

  - id: spellcheckpy-openai-prompt
    desc: Detects spellcheckpy malware via specific prompt strings
    crit: hostile
    conf: 1.0
    any:
      - id: micro-behaviors/data/text/prompt::spellcheckpy-text-prompt
      - id: micro-behaviors/data/text/prompt::spellcheckpy-image-prompt
      - id: micro-behaviors/data/text/prompt::spellcheckpy-reject-format

  - id: spellcheckpy-utils-logic
    desc: Detects spellcheckpy utility logic (OpenAI + Sloppy JSON + Reject Check)
    crit: hostile
    conf: 1.0
    all:
      - id: micro-behaviors/data/text/llm::openai-content-access-python
      - id: micro-behaviors/data/text/llm::openai-reject-check
      - id: micro-behaviors/data/serialization/json::json-quote-replace
