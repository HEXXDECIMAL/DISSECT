# EsqueleSquad Supply Chain Attack Pattern
# Known threat actor targeting PyPI with malicious packages
# ATT&CK: T1195.002 (Supply Chain Compromise)
# MBC: F0004 (Typosquatting)

defaults:
  for: [all]
  attack: "T1195.002"
  mbc: "F0004"

traits:
  - id: author-name
    desc: EsqueleSquad author name
    crit: suspicious
    conf: 1.0
    if:
      type: string
      regex: "(?i)EsqueleSquad|Lolip0p"

  - id: author-email
    desc: EsqueleSquad author email
    crit: suspicious
    conf: 1.0
    if:
      type: string
      regex: "(?i)tahgoficial@proton\\.me|lolipopdev@gmail\\.com"

  - id: copyright
    desc: EsqueleSquad copyright string
    crit: suspicious
    conf: 1.0
    if:
      type: string
      regex: "(?i)Copyright \\(c\\) \\d{4} EsqueleSquad"

  # Removed tui-summary duplicate - use micro-traits/data/text/keywords/pypi-library::tui-summary

composite_rules:
  - id: detected
    desc: EsqueleSquad malicious package
    crit: hostile
    conf: 1.0
    any:
      - id: author-name
      - id: author-email
      - id: copyright

  - id: impersonator
    desc: EsqueleSquad impersonation pattern (TUI summary + urllib3 content)
    crit: hostile
    conf: 1.0
    all:
      - id: objectives/lateral-movement/supply-chain/pypi/impersonation::metadata-mismatch-tui-http
    any:
      - id: author-name
      - id: author-email
      - id: copyright

  - id: powershell-dropper
    desc: EsqueleSquad PowerShell dropper behavior
    crit: hostile
    conf: 1.0
    all:
      - id: author-name
      - id: objectives/lateral-movement/supply-chain/pypi/install-patterns::powershell-encoded-command-in-string
      - id: objectives/execution/background/daemon::powershell-hidden
