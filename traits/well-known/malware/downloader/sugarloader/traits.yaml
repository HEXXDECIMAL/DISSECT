# SUGARLOADER Downloader Detection
# UNC1069/APT-FIN downloader using OSRecovery persistence
# Source: Google Threat Intelligence Group (GTIG)

defaults:
  platforms: [macos]
  for: [macho]

traits:
  # Atomic indicators
  - id: osrecovery-config-file
    desc: os.config file in OSRecovery directory
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "/Library/OSRecovery/com.apple.os.config"

  - id: osrecovery-group-container
    desc: OSRecovery group container path
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "/Library/Group Containers/OSRecovery"

  - id: wolfssl-make-rng
    desc: WolfSSL RNG initialization symbol
    crit: notable
    conf: 0.75
    if:
      type: symbol
      regex: "wolfssl_make_rng|wc_InitRng"

  - id: mod-init-func-lko2
    desc: __mod_init_func with lko2 identifier
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "__mod_init_func\\x00lko2\\x00"

  - id: mod-term-func-lko2
    desc: __mod_term_func with lko2 identifier
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "__mod_term_func\\x00lko2\\x00"

composite_rules:
  # Strict SUGARLOADER variant 1
  - id: sugarloader-v1-strict
    desc: SUGARLOADER variant 1 (exact match)
    crit: hostile
    conf: 1.0
    all:
      - id: osrecovery-config-file
      - id: osrecovery-group-container
      - id: wolfssl-make-rng

  # Strict SUGARLOADER variant 2
  - id: sugarloader-v2-strict
    desc: SUGARLOADER variant 2 with lko2 (exact match)
    crit: hostile
    conf: 1.0
    all:
      - id: mod-init-func-lko2
      - id: mod-term-func-lko2
    unless:
      # Only if libcurl is linked (we have automatic library detection)
      - id: micro-traits/comm/http/lib::libcurl

  # Generalized OSRecovery persistence abuse
  - id: osrecovery-persistence
    desc: Malware using OSRecovery directory for persistence
    crit: hostile
    conf: 0.95
    attack: "T1543"
    any:
      - id: osrecovery-config-file
      - id: osrecovery-group-container
