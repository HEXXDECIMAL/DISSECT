# Malware Family - SpectralBlur
# DPRK/Lazarus-linked macOS backdoor discovered in 2024
# Reference: https://objective-see.org/blog/blog_0x7A.html
# ATT&CK: T1059.004 (Unix Shell), T1071 (Application Layer Protocol)
#
# NOTE: Individual traits are marked "suspicious" because while these function
# names are characteristic of SpectralBlur, they could theoretically appear in
# legitimate software (e.g., backup tools, network utilities). Only the composite
# rule combining multiple indicators is marked "hostile" per criticality.md:
# "Definitively malicious with no reasonable alternative explanation"

traits:
  # Command handler functions characteristic of SpectralBlur
  # These are suspicious individually but hostile when combined
  - id: proc-upload
    desc: SpectralBlur-style file upload handler
    crit: suspicious
    conf: 0.9
    attack: "T1041"
    for: [macho]
    if:
      type: string
      regex: "_proc_upload(_content)?"

  - id: proc-download
    desc: SpectralBlur-style file download handler
    crit: suspicious
    conf: 0.9
    attack: "T1105"
    for: [macho]
    if:
      type: string
      regex: "_proc_download(_content)?"

  - id: proc-shell
    desc: SpectralBlur-style shell command handler
    crit: suspicious
    conf: 0.9
    attack: "T1059.004"
    for: [macho]
    if:
      type: string
      substr: "_proc_shell"

  - id: proc-dir
    desc: SpectralBlur-style directory listing handler
    crit: suspicious
    conf: 0.85
    attack: "T1083"
    for: [macho]
    if:
      type: string
      substr: "_proc_dir"

  - id: proc-rmfile
    desc: SpectralBlur-style file deletion handler
    crit: suspicious
    conf: 0.9
    attack: "T1070.004"
    for: [macho]
    if:
      type: string
      substr: "_proc_rmfile"

  - id: proc-hibernate
    desc: SpectralBlur-style hibernation handler
    crit: suspicious
    conf: 0.9
    attack: "T1029"
    for: [macho]
    if:
      type: string
      substr: "_proc_hibernate"

  # === SpectralBlur config atomic indicators ===
  - id: proc-getcfg
    desc: SpectralBlur get config handler
    crit: suspicious
    conf: 0.85
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_proc_getcfg"

  - id: proc-setcfg
    desc: SpectralBlur set config handler
    crit: suspicious
    conf: 0.85
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_proc_setcfg"

  - id: proc-sleep
    desc: SpectralBlur-style sleep handler
    crit: notable
    conf: 0.8
    attack: "T1029"
    for: [macho]
    if:
      type: string
      substr: "_proc_sleep"

  - id: proc-testconn
    desc: SpectralBlur-style connection test handler
    crit: notable
    conf: 0.8
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_proc_testconn"

  # === SpectralBlur lifecycle atomic indicators ===
  - id: proc-die
    desc: SpectralBlur die handler
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    for: [macho]
    if:
      type: string
      substr: "_proc_die"

  - id: proc-stop
    desc: SpectralBlur stop handler
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    for: [macho]
    if:
      type: string
      substr: "_proc_stop"

  - id: proc-restart
    desc: SpectralBlur restart handler
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    for: [macho]
    if:
      type: string
      substr: "_proc_restart"

  - id: proc-none
    desc: SpectralBlur none handler
    crit: notable
    conf: 0.7
    attack: "T1059"
    for: [macho]
    if:
      type: string
      substr: "_proc_none"

  # Internal communication functions - suspicious patterns
  - id: authchannel
    desc: SpectralBlur-style authentication channel
    crit: suspicious
    conf: 0.85
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_authchannel"

  - id: openchannel
    desc: SpectralBlur-style channel open function
    crit: suspicious
    conf: 0.85
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_openchannel"

  - id: xcrypt
    desc: SpectralBlur-style encryption wrapper
    crit: suspicious
    conf: 0.85
    attack: "T1573"
    for: [macho]
    if:
      type: string
      substr: "_xcrypt"

  # === SpectralBlur packet I/O atomic indicators ===
  - id: read-packet
    desc: SpectralBlur read packet function
    crit: inert
    conf: 0.7
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_read_packet"

  - id: write-packet
    desc: SpectralBlur write packet function
    crit: inert
    conf: 0.7
    attack: "T1071"
    for: [macho]
    if:
      type: string
      substr: "_write_packet"

  # === Generic behaviors atomic indicators ===
  - id: load-config
    desc: Load config function
    crit: inert
    conf: 0.6
    attack: "T1027"
    for: [macho]
    if:
      type: string
      substr: "_load_config"

  - id: save-config
    desc: Save config function
    crit: inert
    conf: 0.6
    attack: "T1027"
    for: [macho]
    if:
      type: string
      substr: "_save_config"

  - id: mainprocess
    desc: Main process loop function
    crit: inert
    conf: 0.6
    attack: "T1059"
    for: [macho]
    if:
      type: string
      substr: "_mainprocess"

  - id: mainthread
    desc: Main thread loop function
    crit: inert
    conf: 0.6
    attack: "T1059"
    for: [macho]
    if:
      type: string
      substr: "_mainthread"

  # SpectralBlur YARA signature - comprehensive detection
  # NOTE: Cannot fully migrate to composite rules - requires filesize constraint (< 100KB)
  - id: spectralblur-yara-signature
    desc: SpectralBlur macOS backdoor YARA signature
    crit: suspicious
    conf: 0.98
    attack: "T1059.004"
    mbc: "B0022"
    for: [macho]
    if:
      type: yara
      source: |
        rule spectralblur_macos {
          meta:
            description = "SpectralBlur macOS backdoor (DPRK/Lazarus)"
            author = "DISSECT"
            date = "2024"
            reference = "https://objective-see.org/blog/blog_0x7A.html"
          strings:
            // Command handlers
            $proc_upload = "_proc_upload"
            $proc_download = "_proc_download"
            $proc_shell = "_proc_shell"
            $proc_dir = "_proc_dir"
            $proc_rmfile = "_proc_rmfile"
            $proc_hibernate = "_proc_hibernate"
            // PTY backdoor pattern
            $posix_openpt = "posix_openpt"
            $grantpt = "grantpt"
            $unlockpt = "unlockpt"
            // Shell
            $bin_sh = "/bin/sh"
            // GPL string (present in SpectralBlur)
            $gpl = "There is NO WARRANTY"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE) and
            filesize < 100KB and
            (
              // Strong match: multiple proc handlers
              (4 of ($proc_*)) or
              // Alternative: proc handlers with PTY pattern
              (2 of ($proc_*) and $posix_openpt and $grantpt and $unlockpt and $bin_sh) or
              // Alternative: key proc handlers with GPL string
              ($proc_shell and $proc_upload and $gpl)
            )
        }

  # Behavioral pattern - YARA based detection
  # NOTE: Cannot fully migrate to composite rules - requires filesize constraint (< 500KB)
  - id: behavioral-yara
    desc: SpectralBlur-like C2 backdoor behavior via
    crit: suspicious
    conf: 0.85
    attack: "T1059.004"
    mbc: "B0022"
    for: [macho]
    if:
      type: yara
      source: |
        rule spectralblur_behavior {
          meta:
            description = "SpectralBlur-like behavioral pattern"
          strings:
            // POSIX PTY creation
            $posix_openpt = "posix_openpt" fullword
            $grantpt = "grantpt" fullword
            $unlockpt = "unlockpt" fullword
            $ptsname = "ptsname" fullword
            // Network
            $socket = "socket" fullword
            $connect = "connect" fullword
            $recv = "recv" fullword
            $send = "send" fullword
            // Process
            $fork = "fork" fullword
            $setsid = "setsid" fullword
            $execve = "execve" fullword
            // Shell
            $bin_sh = "/bin/sh"
            $dev_null = "/dev/null"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE) and
            filesize < 500KB and
            // PTY backdoor pattern
            $posix_openpt and $grantpt and $unlockpt and $ptsname and
            // Network communication
            $socket and $connect and ($recv or $send) and
            // Process daemonization
            $fork and $setsid and
            // Shell execution
            (($bin_sh and $dev_null) or $execve)
        }

composite_rules:
  # SpectralBlur config handler composite
  - id: proc-config
    desc: SpectralBlur-style configuration handler
    crit: suspicious
    conf: 0.85
    attack: "T1071"
    for: [macho]
    any:
      - id: proc-getcfg
      - id: proc-setcfg

  # SpectralBlur lifecycle composite
  - id: proc-lifecycle
    desc: SpectralBlur-style lifecycle control handler
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    for: [macho]
    any:
      - id: proc-die
      - id: proc-stop
      - id: proc-restart
      - id: proc-none

  # SpectralBlur packet I/O composite
  - id: packet-io
    desc: SpectralBlur-style packet communication
    crit: notable
    conf: 0.8
    attack: "T1071"
    for: [macho]
    any:
      - id: read-packet
      - id: write-packet

  # Config persist composite
  - id: config-persist
    desc: Configuration load/save functions
    crit: notable
    conf: 0.7
    attack: "T1027"
    for: [macho]
    any:
      - id: load-config
      - id: save-config

  # Mainloop composite
  - id: mainloop
    desc: Main processing loop functions
    crit: notable
    conf: 0.7
    attack: "T1059"
    for: [macho]
    any:
      - id: mainprocess
      - id: mainthread

  # This is the ONLY hostile rule - requires multiple indicators
  # "Definitively malicious with no reasonable alternative explanation"
  - id: spectralblur-detected
    desc: SpectralBlur macOS backdoor (DPRK/Lazarus)
    crit: suspicious
    conf: 0.98
    attack: "T1059.004"
    mbc: "B0022"
    for: [macho]
    needs: 3
    any:
      - id: proc-upload
      - id: proc-download
      - id: proc-shell
      - id: proc-rmfile
      - id: proc-hibernate
      - id: authchannel
      - id: xcrypt
      - id: spectralblur-yara-signature

  # Behavioral pattern - suspicious (could be similar legitimate tool)
