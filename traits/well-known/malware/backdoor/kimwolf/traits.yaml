defaults:
  for: [all]

traits:
  - id: marker
    desc: KimWolf-specific auth marker string
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "krebsforeheadindustriesA"

  - id: arm-ip-build
    desc: Hand-written ARM assembly IP building
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: hex
      # mov r0, 45; strb r0, [sp, 4]; mov r0, 139; strb r0, [sp, 5]; mov r0, 197; strb r0, [sp, 6]; mov r0, 87; strb r0, [sp, 7]
      pattern: "2d 00 a0 e3 04 00 cd e5 8b 00 a0 e3 05 00 cd e5 c5 00 a0 e3 06 00 cd e5 57 00 a0 e3 07 00 cd e5"

  - id: arm-port-build
    desc: Hand-written ARM assembly port building
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: hex
      # movw r0, 8082; rev16 r0, r0; strh r0, [sp, 2]
      pattern: "92 0f 01 e3 b0 0f bf e6 b2 00 cd e1"

  - id: arm-socket-connect
    desc: Hand-written ARM assembly socket/connect pattern
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: hex
      # socket(2, 1, 0)
      # mov r7, 0x100; add r7, r7, 0x19; mov r0, 2; mov r1, 1; mov r2, 0; svc 0
      pattern: "01 7c a0 e3 19 70 87 e2 02 00 a0 e3 01 10 a0 e3 00 20 a0 e3 00 00 00 ef"

  - id: arm-read-write-loop
    desc: Hand-written ARM assembly read/write loop
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: hex
      # read(r4, sp, 0x400); write(1, sp, r0); b ...
      pattern: "04 00 a0 e1 0d 10 a0 e1 01 2b a0 e3 03 70 a0 e3 00 00 00 ef [0-32] 0d 10 a0 e1 00 20 a0 e1 01 00 a0 e3 04 70 a0 e3 00 00 00 ef"

composite_rules:
  - id: detected
    desc: KimWolf stager malware detected
    crit: hostile
    mbc: "B0024" # Software Stager
    attack: "T1105" # Ingress Tool Transfer
    all:
      - id: marker
      - id: arm-ip-build
      - id: arm-port-build
      - id: arm-socket-connect