# WAVESHAPER Backdoor Detection
# UNC1069 macOS backdoor targeting cryptocurrency/AI companies
# Source: https://cloud.google.com/blog/topics/threat-intelligence/unc1069-targets-cryptocurrency-ai-social-engineering
# Google Threat Intelligence Group (GTIG)

defaults:
  platforms: [macos]
  for: [macho]

composite_rules:
  # Strict WAVESHAPER variant 1 detection
  - id: waveshaper-v1-strict
    desc: WAVESHAPER backdoor variant 1 (exact match)
    crit: hostile
    conf: 1.0
    attack: "T1071.001"
    all:
      - id: micro-behaviors/data/encode/spoofing::user-agent-msie8
      - id: micro-behaviors/fs/path/temp::tmp-hidden-file
      - id: objectives/discovery/system/install::install-log-grep
      - id: objectives/discovery/system/hardware::sysctl-hw-model
      - id: objectives/discovery/system/hardware::sysctl-cpu-brand
      - id: objectives/discovery/system/hardware::sw-vers-product

  # Generalized WAVESHAPER-like behavior
  - id: waveshaper-behavior
    desc: WAVESHAPER-like backdoor behavior pattern
    crit: hostile
    conf: 0.95
    attack: "T1071.001"
    all:
      - id: micro-behaviors/data/encode/spoofing::user-agent-old-browser
      - id: micro-behaviors/fs/path/temp::tmp-hidden-file
      - id: objectives/discovery/system/hardware::system-profiling

  # Strict WAVESHAPER variant 2 detection (C++ symbols)
  - id: waveshaper-v2-strict
    desc: WAVESHAPER backdoor variant 2 (C++ symbols exact)
    crit: hostile
    conf: 1.0
    all:
      - id: micro-behaviors/process/create/backdoor::run-command-symbol
      - id: micro-behaviors/process/create/backdoor::generate-uid-symbol
      - id: micro-behaviors/process/create/backdoor::get-response-symbol
      - id: micro-behaviors/process/create/backdoor::write-callback-symbol
      - id: micro-behaviors/process/create/backdoor::process-request-symbol
      - id: micro-behaviors/process/create/backdoor::save-and-execute-symbol
      - id: micro-behaviors/process/create/backdoor::make-status-string-symbol
      - id: micro-behaviors/process/create/backdoor::get-exe-path-symbol
      - id: micro-behaviors/process/create/backdoor::execute-symbol

