# Malware Family - TinyShell Backdoor
# Open-source backdoor, commonly reused in attacks
# ATT&CK: T1059.004 (Unix Shell)

traits:
  # === Go variant traits ===

  - id: go-runshell
    desc: TinyShell Go shell handler
    crit: suspicious
    conf: 0.9
    attack: "T1059.004"
    for: [elf]
    if:
      type: string
      substr: "handleRunShell"

  # Note: RunInBackground is too generic (matches V8, WebAssembly, etc.)
  # Only use as part of composite, not as standalone indicator
  - id: go-pty-wrapper
    desc: TinyShell Go PTY wrapper
    crit: suspicious
    conf: 0.85
    attack: "T1059.004"
    for: [elf]
    if:
      type: string
      substr: "LinuxPtyWrapper"

  # === C variant traits ===

  - id: c-runshell
    desc: TinyShell C daemon shell function
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    for: [elf]
    if:
      type: string
      substr: "_tshd_runshell"

  - id: c-getfile
    desc: TinyShell C file transfer function
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    for: [elf]
    if:
      type: string
      substr: "_tshd_get_file"

  - id: c-putfile
    desc: TinyShell C file upload function
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    for: [elf]
    if:
      type: string
      substr: "_tshd_put_file"

  # Inline pattern for RunInBackground - too generic for standalone trait
  # but valid as part of TinyShell-specific composite
  - id: go-background-pattern
    desc: TinyShell Go background execution pattern
    crit: notable
    conf: 0.5
    attack: "T1059.004"
    for: [elf]
    if:
      type: string
      substr: "RunInBackground"

composite_rules:
  # Go variant detection
  - id: go-detected
    desc: TinyShell Go backdoor
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    mbc: "B0022"
    for: [elf]
    all:
      - id: go-runshell
      - id: go-background-pattern
      - id: go-pty-wrapper

  # C variant detection
  - id: c-detected
    desc: TinyShell C backdoor
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    mbc: "B0022"
    for: [elf]
    needs: 2
    any:
      - id: c-runshell
      - id: c-getfile
      - id: c-putfile
