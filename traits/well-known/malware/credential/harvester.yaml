# Security Tools - Credential Extraction
# Used for both legitimate security testing and malicious purposes

traits:
  # === Mimikatz Patterns ===
  - id: sekurlsa-logonpasswords-lower
    desc: sekurlsa::logonpasswords command (lowercase)
    crit: notable
    conf: 0.98
    platforms: [windows]
    for: [pe, dll, shell, python, javascript, powershell]
    if:
      type: string
      substr: "sekurlsa::logonpasswords"

  - id: sekurlsa-logonpasswords-mixed
    desc: Sekurlsa::LogonPasswords command (mixed case)
    crit: notable
    conf: 0.98
    platforms: [windows]
    for: [pe, dll, shell, python, javascript, powershell]
    if:
      type: string
      regex: "(?i)sekurlsa::logonpasswords"

  - id: mimikatz-error
    desc: ERROR kuhl Mimikatz error signature
    crit: notable
    conf: 0.98
    platforms: [windows]
    for: [pe, dll]
    if:
      type: string
      substr: "ERROR kuhl"

  - id: mimikatz-process-string
    desc: mimikatz.exe process string
    crit: notable
    conf: 0.95
    platforms: [windows]
    for: [pe, dll, shell, python, javascript, powershell]
    if:
      type: string
      substr: "mimikatz.exe"

  - id: gentilkiwi-author
    desc: Benjamin Delpy (gentilkiwi) author signature
    crit: notable
    conf: 0.90
    platforms: [windows]
    for: [pe, dll]
    if:
      type: string
      regex: "gentilkiwi|Benjamin Delpy"

  # === BackTrack Keylogger Patterns ===
  - id: modesitt-software
    desc: Modesitt Software company name
    crit: inert
    conf: 0.75
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: string
      substr: "Modesitt Software"

  - id: modesittsoftware-web
    desc: www.modesittsoftware website
    crit: inert
    conf: 0.75
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: string
      substr: "www.modesittsoftware"

  - id: backtrack-string
    desc: BackTrack product name
    crit: inert
    conf: 0.7
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: string
      word: "BackTrack"

composite_rules:
  # === Helper composites ===
  - id: sekurlsa-logonpasswords
    desc: Sekurlsa logonpasswords command (case variants)
    platforms: [windows]
    for: [pe, dll, shell, python, javascript, powershell]
    any:
      - id: sekurlsa-logonpasswords-lower
      - id: sekurlsa-logonpasswords-mixed

  - id: modesitt-references
    desc: Modesitt Software references
    platforms: [macos]
    for: [macho, dylib]
    any:
      - id: modesitt-software
      - id: modesittsoftware-web

  # === Main detection composites ===

  # Migrated from YARA
  - id: backtrack-keylogger
    desc: BackTrack keylogger (macOS)
    crit: suspicious
    conf: 0.9
    attack: "T1056.001"
    platforms: [macos]
    for: [macho, dylib]
    all:
      - id: backtrack-string
      - id: modesitt-references

  - id: mimikatz
    desc: Mimikatz credential extraction tool
    crit: suspicious
    conf: 0.99
    attack: "T1003.001"
    mbc: "E1003"
    platforms: [windows]
    for: [pe, dll, shell, python, javascript, powershell]
    none:
      - id: metadata/purpose/security-rule::definition
    any:
      - id: sekurlsa-logonpasswords
      - id: mimikatz-error
      - id: mimikatz-process-string
      - id: gentilkiwi-author
