# Malware Family - Poseidon Infostealer
# macOS infostealer targeting credentials
# Reference: https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/
# ATT&CK: T1555 (Credentials from Password Stores)

traits:
  - id: c2-url
    desc: Poseidon C2 update check URL
    crit: suspicious
    conf: 0.99
    attack: "T1071.001"
    platforms: [macos]
    for: [macho]
    if:
      type: string
      substr: "https://forked-project.com/check_updates"

  - id: mangled-string
    desc: Poseidon mangled C++ string pattern
    crit: suspicious
    conf: 0.7
    attack: "T1555"
    platforms: [macos]
    for: [macho]
    if:
      type: string
      substr: "cEEE8max_sizeB8ue170006IS2_vEEmRKS2_"

  - id: poseidon-detected-yara
    desc: Poseidon stealer via YARA
    crit: suspicious
    conf: 0.9
    attack: "T1555"
    platforms: [macos]
    for: [macho]
    if:
      type: yara
      source: |
        import "math"
        rule poseidon_stealer {
          strings:
            $not_jar = "META-INF/"
            $not_dwarf = "_DWARF"
            $not_kext = "_.SYMDEF SORTED"
            $le = "cEEE8max_sizeB8ue170006IS2_vEEmRKS2_" fullword
            $sy = "@_system" fullword
            $sy2 = "_system" fullword
            $bs = "basic_string" fullword
            $ve = "vector" fullword
          condition:
            filesize > 190KB and filesize < 400KB and
            (uint32(0) == 4277009102 or uint32(0) == 3472551422 or
             uint32(0) == 4277009103 or uint32(0) == 3489328638 or
             uint32(0) == 3405691582 or uint32(0) == 3199925962 or
             uint32(0) == 3405691583 or uint32(0) == 3216703178) and
            none of ($not*) and all of ($le, $sy, $sy2, $bs, $ve) and
            math.entropy(20000, 50000) >= 2.5
        }

composite_rules:
