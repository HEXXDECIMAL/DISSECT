# Malware Family - Kaiji IoT Botnet
# Chinese Linux/IoT malware written in Go
# Reference: https://intezer.com/blog/research/kaiji-new-chinese-linux-malware-turning-to-golang/
# ATT&CK: T1583.005 (Botnet)

traits:
  # === Atomic Traits (moved from composite_rules) ===

  - id: systemctl-service
    desc: Kaiji systemd service startup
    crit: suspicious
    conf: 0.95
    attack: "T1543.002"
    for: [elf]
    if:
      type: string
      substr: "systemctl start linux.service"

  - id: audit-selinux
    desc: Kaiji SELinux audit bypass
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [elf]
    if:
      type: string
      substr: "audit2allow -M my-Systemimgconf"

  - id: chaos-cve
    desc: Kaiji CVE exploitation function
    crit: suspicious
    conf: 0.95
    attack: "T1190"
    for: [elf]
    if:
      type: string
      substr: "chaos_cve_make"

  # === Old variant traits (Go symbols) ===

  - id: beat-heart
    desc: Kaiji heartbeat function (old)
    crit: suspicious
    conf: 0.9
    attack: "T1071"
    for: [elf]
    if:
      type: string
      substr: "main.BeatHeart"

  - id: make-packet
    desc: Kaiji packet crafting (old)
    crit: suspicious
    conf: 0.9
    attack: "T1498"
    for: [elf]
    if:
      type: string
      substr: "main.makePacketa"

  - id: decrypt-cfb
    desc: Kaiji CFB decryption (old)
    crit: suspicious
    conf: 0.9
    attack: "T1140"
    for: [elf]
    if:
      type: string
      substr: "main.DecryptCFB"

  # === Chaos variant traits (Go symbols) ===

  - id: chaos-ssh
    desc: Chaos SSH brute force attack
    crit: suspicious
    conf: 0.95
    attack: "T1110"
    for: [elf]
    if:
      type: string
      regex: "main\\.chaos_ssh(_attack|_boom|read)?"

  - id: chaos-ddos
    desc: Chaos DDoS attack functions
    crit: suspicious
    conf: 0.95
    attack: "T1498"
    for: [elf]
    if:
      type: string
      regex: "main\\.chaos_(ack|udp_plain|ipspoof|http)"

composite_rules:
  # New Kaiji/Chaos variant detection
  - id: kaiji-detected
    desc: Kaiji/Chaos botnet detected
    crit: notable
    conf: 0.95
    attack: "T1071"
    mbc: "B0030"
    for: [elf]
    needs: 2
    any:
      - id: systemctl-service
      - id: audit-selinux
      - id: chaos-cve
      - id: chaos-ssh
      - id: chaos-ddos

  - id: old-variant-detected
    desc: Kaiji botnet old variant detected
    crit: notable
    conf: 0.95
