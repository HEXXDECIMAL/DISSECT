# Supply Chain - Interpreter Dropper Patterns
# Detects "bring your own interpreter" patterns where malware downloads
# a standalone interpreter (Python, Node, etc.) to execute payloads
# ATT&CK: T1059 (Command Execution), T1105 (Ingress Tool Transfer)

traits:
  # Python-build-standalone download (commonly abused)
  - id: supply-chain/dropper/interpreter/python-standalone
    description: Downloads python-build-standalone (interpreter dropper pattern)
    criticality: suspicious
    confidence: 0.9
    attack: "T1105"
    file_types: [javascript, typescript, shell]
    condition:
      type: yara
      source: |
        rule python_standalone_dropper {
          strings:
            $repo1 = "indygreg/python-build-standalone" ascii
            $repo2 = "python-build-standalone/releases" ascii
            $url1 = "cpython-" ascii
            $url2 = "-install_only.tar.gz" ascii
            $url3 = "python.org/ftp/python" ascii
          condition:
            any of ($repo*) or ($url1 and $url2) or $url3
        }

  # Node.js portable/standalone download
  - id: supply-chain/dropper/interpreter/node-standalone
    description: Downloads standalone Node.js interpreter
    criticality: suspicious
    confidence: 0.85
    attack: "T1105"
    file_types: [javascript, typescript, shell]
    condition:
      type: yara
      source: |
        rule node_standalone_dropper {
          strings:
            $url1 = "nodejs.org/dist" ascii
            $url2 = "node-v" ascii
            $tar = ".tar.gz" ascii
            $zip = ".zip" ascii
            $exec1 = "spawn(" ascii
            $exec2 = "exec(" ascii
          condition:
            ($url1 or $url2) and ($tar or $zip) and any of ($exec*)
        }

  # Stdin piping to interpreter (common payload execution)
  - id: supply-chain/dropper/interpreter/stdin-exec
    description: Pipes code to interpreter via stdin (payload execution)
    criticality: suspicious
    confidence: 0.9
    attack: "T1059"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule stdin_interpreter_exec {
          strings:
            // spawn with stdin pipe - Node.js pattern (includes .spawn for method calls)
            $spawn1 = "spawn(" ascii
            $spawn2 = ".spawn(" ascii
            $stdin1 = "stdin.write" ascii
            $stdin2 = "stdin.end" ascii
            // Interpreter flags that read from stdin
            $flag1 = "['-']" ascii  // python -, node -
            $flag2 = "[\"-\"]" ascii
            $flag3 = ", ['-']" ascii
            $flag4 = ", [\"-\"]" ascii
            // Interpreter binaries (in paths or variable names)
            $py1 = "python" ascii nocase
            $py2 = "bin/python" ascii
            $node1 = "/node" ascii
            $ruby1 = "ruby" ascii nocase
            $perl1 = "perl" ascii nocase
          condition:
            any of ($spawn*) and any of ($stdin*) and
            any of ($flag*) and any of ($py*, $node*, $ruby*, $perl*)
        }

  # Stream directly to tar extraction (in-memory dropper)
  - id: supply-chain/dropper/interpreter/stream-tar-extract
    description: Streams HTTP response directly to tar extraction
    criticality: suspicious
    confidence: 0.9
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule stream_tar_extract {
          strings:
            // HTTP get with pipe
            $http1 = "https.get" ascii
            $http2 = "http.get" ascii
            $http3 = "https.request" ascii
            // Pipe to process
            $pipe1 = ".pipe(" ascii
            $pipe2 = "res.pipe" ascii
            // Tar command
            $tar1 = "spawn" ascii
            $tar2 = "'tar'" ascii
            $tar3 = "\"tar\"" ascii
            $tar4 = "-x" ascii
          condition:
            any of ($http*) and any of ($pipe*) and any of ($tar*)
        }

  # Generic "download interpreter + execute payload" pattern
  - id: supply-chain/dropper/interpreter/download-and-exec
    description: Downloads interpreter binary then executes payload
    criticality: suspicious
    confidence: 0.85
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule download_interpreter_exec {
          strings:
            // Downloading binary
            $dl1 = "https.get" ascii
            $dl2 = "http.get" ascii
            $dl3 = "fetch(" ascii
            // Interpreter paths/binaries
            $interp1 = "bin/python" ascii
            $interp2 = "python.exe" ascii
            $interp3 = "bin/node" ascii
            $interp4 = "node.exe" ascii
            $interp5 = "bin/ruby" ascii
            // Execution
            $exec1 = "spawn(" ascii
            $exec2 = "execFile(" ascii
            $exec3 = "exec(" ascii
            // File existence check (typical dropper pattern)
            $exists1 = "existsSync" ascii
            $exists2 = "access(" ascii
          condition:
            any of ($dl*) and any of ($interp*) and any of ($exec*) and any of ($exists*)
        }

composite_rules:
  # Full interpreter dropper: download + extract + stdin exec
  - id: supply-chain/dropper/interpreter/full-stager
    description: Complete interpreter-based stager (download interpreter + execute payload)
    criticality: hostile
    confidence: 0.95
    attack: "T1059"
    mbc: "B0024"
    file_types: [javascript, typescript]
    requires_any:
      - type: trait
        id: python-standalone
      - type: trait
        id: node-standalone
    requires_all:
      - type: trait
        id: stdin-exec

  # Download interpreter + remote payload fetch + execute
  - id: supply-chain/dropper/interpreter/remote-payload-stager
    description: Downloads interpreter and fetches remote payload for execution
    criticality: hostile
    confidence: 0.95
    attack: "T1105"
    file_types: [javascript, typescript]
    requires_all:
      - type: trait
        id: download-and-exec
      - type: string
        regex: "Buffer\\.from.*base64|atob\\(|btoa\\("

  # Python stager with obfuscated payload URL
  - id: supply-chain/dropper/interpreter/python-obfuscated-stager
    description: Python dropper with obfuscated payload URL (npm malware pattern)
    criticality: hostile
    confidence: 0.95
    attack: "T1105"
    mbc: "B0024"
    file_types: [javascript, typescript]
    requires_all:
      - type: trait
        id: python-standalone
      - type: trait
        id: hex-url-array
