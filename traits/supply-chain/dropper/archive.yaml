# Archive-based Dropper Patterns
# Detects download and extraction of password-protected archives
# ATT&CK: T1105 (Ingress Tool Transfer), T1140 (Deobfuscate/Decode)

traits:
  # Password-protected archive extraction
  - id: supply-chain/dropper/archive/password-extract
    description: Extracts password-protected archive
    criticality: suspicious
    confidence: 0.9
    attack: "T1140"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule password_archive_extract {
          strings:
            $extract1 = "extractFull" ascii
            $extract2 = "extract(" ascii
            $extract3 = "unzip" ascii
            $extract4 = "7z" ascii
            $extract5 = "node-7z" ascii
            $password1 = "password:" ascii
            $password2 = "password=" ascii
            $password3 = "-p" ascii
          condition:
            any of ($extract*) and any of ($password*)
        }

  # 7-zip binary usage
  - id: supply-chain/dropper/archive/7zip-usage
    description: Uses 7-zip for archive operations
    criticality: notable
    confidence: 0.8
    attack: "T1140"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "7zip-bin|node-7z|path7za|7z\\.exe"

  # Executable file search pattern
  - id: supply-chain/dropper/archive/exe-search
    description: Searches for executable files after extraction
    criticality: suspicious
    confidence: 0.9
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "endsWith\\(['\"]\\.(exe|bat|cmd|ps1|sh|elf|bin)['\"]\\)|find\\([^)]*\\.(exe|bat|cmd)"

  # Download to temp then extract
  - id: supply-chain/dropper/archive/temp-extract
    description: Downloads archive to temp directory then extracts
    criticality: suspicious
    confidence: 0.85
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule temp_archive_extract {
          strings:
            $temp1 = "process.env.TEMP" ascii
            $temp2 = "process.env.TMP" ascii
            $temp3 = "os.tmpdir()" ascii
            $temp4 = "/tmp/" ascii
            $archive1 = ".zip" ascii
            $archive2 = ".7z" ascii
            $archive3 = ".tar" ascii
            $archive4 = ".rar" ascii
          condition:
            any of ($temp*) and any of ($archive*)
        }

  # Spawn executable after extraction
  - id: supply-chain/dropper/archive/extract-execute
    description: Extracts archive then executes contents
    criticality: hostile
    confidence: 0.95
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule extract_and_execute {
          strings:
            $extract1 = "extractFull" ascii
            $extract2 = "extract(" ascii
            $extract3 = "unzip" ascii
            $spawn1 = "spawn(" ascii
            $spawn2 = "exec(" ascii
            $spawn3 = "execFile(" ascii
            $exe1 = ".exe" ascii
            $exe2 = "exePath" ascii
            $exe3 = "exeFile" ascii
          condition:
            any of ($extract*) and any of ($spawn*) and any of ($exe*)
        }

  # Download zip file
  - id: supply-chain/dropper/archive/download-zip
    description: Downloads zip archive from remote URL
    criticality: suspicious
    confidence: 0.85
    attack: "T1105"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule download_zip {
          strings:
            $dl1 = "https.get" ascii
            $dl2 = "http.get" ascii
            $dl3 = "fetch(" ascii
            $dl4 = "axios.get" ascii
            $dl5 = "request(" ascii
            $zip1 = ".zip" ascii
            $zip2 = ".7z" ascii
            $zip3 = "application/zip" ascii
            $write1 = "createWriteStream" ascii
            $write2 = "writeFileSync" ascii
          condition:
            any of ($dl*) and any of ($zip*) and any of ($write*)
        }

composite_rules:
  # Full dropper chain: download -> extract -> execute
  - id: supply-chain/dropper/archive/full-chain
    description: Complete archive dropper (download + extract + execute)
    criticality: hostile
    confidence: 0.98
    attack: "T1105"
    requires_all:
      - type: trait
        id: supply-chain/dropper/archive/download-zip
      - type: trait
        id: supply-chain/dropper/archive/exe-search
