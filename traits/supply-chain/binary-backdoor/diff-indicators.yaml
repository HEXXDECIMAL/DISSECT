# Supply Chain Diff Indicators
# Traits that indicate suspicious changes in library updates
# These are particularly useful for dissect diff comparisons

defaults:
  file_types: [elf, pe, macho]
  attack: "T1195.002"
  mbc: "B0025"

traits:
  # === Unexpected Functionality in Libraries ===

  - id: supply-chain/binary-backdoor/unexpected-socket-ops
    description: "Socket operations in non-network library"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule unexpected_socket {
          strings:
            $sock1 = "socket" ascii
            $sock2 = "connect" ascii
            $sock3 = "bind" ascii
            $sock4 = "listen" ascii
            $sock5 = "accept" ascii
            $send1 = "send" ascii
            $recv1 = "recv" ascii
            // Exclude obvious network libraries
            $net_lib1 = "libssl" ascii
            $net_lib2 = "libcrypto" ascii
            $net_lib3 = "libcurl" ascii
            $net_lib4 = "libssh" ascii
          condition:
            (3 of ($sock*, $send*, $recv*)) and
            not any of ($net_lib*)
        }

  - id: supply-chain/binary-backdoor/unexpected-process-ops
    description: "Process operations in utility library"
    criticality: suspicious
    confidence: 0.75
    condition:
      type: yara
      source: |
        rule unexpected_process {
          strings:
            $fork = "fork" ascii
            $exec1 = "execve" ascii
            $exec2 = "execl" ascii
            $exec3 = "system" ascii
            $popen = "popen" ascii
            $shell = "/bin/sh" ascii
          condition:
            3 of them
        }

  - id: supply-chain/binary-backdoor/unexpected-crypto
    description: "Cryptographic operations in non-crypto library"
    criticality: suspicious
    confidence: 0.75
    condition:
      type: yara
      source: |
        rule unexpected_crypto {
          strings:
            $aes1 = "AES_" ascii
            $aes2 = { 63 7C 77 7B F2 6B 6F C5 }  // AES S-box start
            $rsa1 = "RSA_" ascii
            $evp1 = "EVP_" ascii
            $sha1 = "SHA256" ascii
            $chacha = "chacha" ascii nocase
            // ED25519 constants (used in XZ backdoor)
            $ed1 = { 79 07 4D C9 D3 14 79 51 }
          condition:
            3 of them
        }

  - id: supply-chain/binary-backdoor/unexpected-env-access
    description: "Environment variable access patterns"
    criticality: notable
    confidence: 0.65
    condition:
      type: yara
      source: |
        rule env_access_pattern {
          strings:
            $env1 = "getenv" ascii
            $env2 = "setenv" ascii
            $env3 = "putenv" ascii
            // Suspicious env vars
            $ld1 = "LD_PRELOAD" ascii
            $ld2 = "LD_LIBRARY_PATH" ascii
            $ld3 = "LD_AUDIT" ascii
            $ld4 = "LD_DEBUG" ascii
          condition:
            any of ($env*) and any of ($ld*)
        }

  # === Memory/Code Manipulation ===

  - id: supply-chain/binary-backdoor/memory-protection-change
    description: "Memory protection modification (self-modifying code)"
    criticality: suspicious
    confidence: 0.8
    attack: "T1055"
    condition:
      type: yara
      source: |
        rule mem_protect_change {
          strings:
            $mprotect = "mprotect" ascii
            $mmap = "mmap" ascii
            $wx = { 07 00 00 00 }  // PROT_READ | PROT_WRITE | PROT_EXEC
          condition:
            ($mprotect and $wx) or
            ($mmap and $mprotect)
        }

  - id: supply-chain/binary-backdoor/jit-pattern
    description: "JIT-like code generation pattern"
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule jit_pattern {
          strings:
            $mmap = "mmap" ascii
            $mprotect = "mprotect" ascii
            $memcpy = "memcpy" ascii
            // Indirect call patterns
            $icall1 = { FF D? }  // call reg
            $icall2 = { FF 1? }  // call [reg]
          condition:
            ($mmap and $mprotect and $memcpy) and
            (#icall1 + #icall2) > 10
        }

  # === Anti-Analysis Indicators ===

  - id: supply-chain/binary-backdoor/timing-check
    description: "Timing-based anti-analysis check"
    criticality: notable
    confidence: 0.7
    attack: "T1497"
    condition:
      type: yara
      source: |
        rule timing_check {
          strings:
            $rdtsc = { 0F 31 }  // rdtsc instruction
            $clock1 = "clock_gettime" ascii
            $clock2 = "gettimeofday" ascii
            $time1 = "time" ascii
          condition:
            ($rdtsc and any of ($clock*, $time*)) or
            #rdtsc > 3
        }

  - id: supply-chain/binary-backdoor/debug-detection
    description: "Debugger detection pattern"
    criticality: suspicious
    confidence: 0.75
    attack: "T1622"
    condition:
      type: yara
      source: |
        rule debug_detect {
          strings:
            $ptrace = "ptrace" ascii
            $proc1 = "/proc/self/status" ascii
            $proc2 = "/proc/self/maps" ascii
            $proc3 = "TracerPid" ascii
            $int3 = { CC }  // int 3
          condition:
            $ptrace or any of ($proc*) or #int3 > 5
        }

  # === Obfuscation Indicators ===

  - id: supply-chain/binary-backdoor/string-obfuscation
    description: "String obfuscation/deobfuscation pattern"
    criticality: notable
    confidence: 0.65
    condition:
      type: yara
      source: |
        rule string_obfuscation {
          strings:
            // XOR deobfuscation loop
            $xor1 = { 30 ?? 4? FF C? 3? ?? 7? }  // xor byte, inc, cmp, jl
            $xor2 = { 32 ?? 4? 83 ?? ?? 7? }     // xor byte, inc, cmp, jl
            // Stack string construction
            $stack1 = { C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ?? }  // mov [rbp-x], imm8
            $stack2 = { C7 45 ?? ?? ?? ?? ?? C7 45 ?? ?? ?? ?? ?? }  // mov [rbp-x], imm32
          condition:
            any of them
        }

  - id: supply-chain/binary-backdoor/data-obfuscation
    description: "Large obfuscated data blob"
    criticality: suspicious
    confidence: 0.7
    condition:
      type: metrics
      field: binary.high_entropy_strings
      min: 20

  # === Suspicious Library Patterns ===

  - id: supply-chain/binary-backdoor/constructor-destructor
    description: "ELF constructor/destructor functions"
    criticality: notable
    confidence: 0.5
    condition:
      type: yara
      source: |
        rule elf_ctors_dtors {
          strings:
            $init = ".init_array" ascii
            $fini = ".fini_array" ascii
            $ctors = ".ctors" ascii
            $dtors = ".dtors" ascii
            $preinit = ".preinit_array" ascii
          condition:
            uint32(0) == 0x464c457f and
            2 of them
        }

  - id: supply-chain/binary-backdoor/symbol-interposition
    description: "Symbol interposition/override pattern"
    criticality: suspicious
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule symbol_interpose {
          strings:
            $dlsym = "dlsym" ascii
            $rtld = "RTLD_NEXT" ascii
            $rtld2 = "RTLD_DEFAULT" ascii
            $versym = ".gnu.version" ascii
          condition:
            $dlsym and any of ($rtld, $rtld2, $versym)
        }

composite_rules:
  # === Unexpected Capability Combination ===

  - id: supply-chain/binary-backdoor/unexpected-capabilities
    description: "Unexpected capability combination in library"
    criticality: suspicious
    confidence: 0.8
    requires_count: 2
    conditions:
      - type: trait
        id: unexpected-socket-ops
      - type: trait
        id: unexpected-process-ops
      - type: trait
        id: unexpected-crypto

  - id: supply-chain/binary-backdoor/stealth-backdoor-pattern
    description: "Stealth backdoor pattern"
    criticality: hostile
    confidence: 0.9
    requires_count: 2
    conditions:
      - type: trait
        id: debug-detection
      - type: trait
        id: timing-check
      - type: trait
        id: string-obfuscation
      - type: trait
        id: memory-protection-change

  - id: supply-chain/binary-backdoor/injected-code-pattern
    description: "Injected code pattern in library"
    criticality: hostile
    confidence: 0.85
    requires_all:
      - type: trait
        id: data-obfuscation
    requires_any:
      - type: trait
        id: unexpected-crypto
      - type: trait
        id: unexpected-socket-ops
