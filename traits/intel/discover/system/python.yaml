# System Information Discovery - Python
# Detects Python code that fingerprints the host system
# ATT&CK: T1082 (System Information Discovery)

defaults:
  file_types: [python]
  mbc: "E1082"
  attack: "T1082"
  criticality: notable

traits:
  # Platform module - OS detection (Alias-resistant AST)
  - id: intel/discover/system/python-platform-system
    description: "Profiles the host operating system type"
    confidence: 0.8
    condition:
      type: ast_pattern
      node_type: call
      pattern: ".system()"

  - id: intel/discover/system/python-platform-machine
    description: "Identifies the host CPU architecture"
    confidence: 0.75
    condition:
      type: ast_pattern
      node_type: call
      pattern: ".machine()"

  - id: intel/discover/system/python-platform-node
    description: "Retrieves the system hostname"
    confidence: 0.7
    condition:
      type: ast_pattern
      node_type: call
      pattern: ".node()"

  - id: intel/discover/system/python-platform-uname
    description: "Collects comprehensive system hardware and OS information"
    confidence: 0.8
    condition:
      type: ast_pattern
      node_type: call
      pattern: ".uname()"

  # User lookup (Alias-resistant)
  - id: intel/discover/system/python-getpass-user
    description: "Identifies the current logged-in user"
    confidence: 0.85
    condition:
      type: ast_pattern
      node_type: call
      pattern: ".getuser()"

  # MAC address discovery
  - id: intel/discover/system/python-mac-discovery
    description: "Collects hardware MAC addresses for system fingerprinting"
    confidence: 0.8
    condition:
      type: string
      regex: 'getmac|ifconfig|uuid\.getnode\(\)'

composite_rules:
  # Composite: Intensive system enumeration (Alias-resistant)
  - id: intel/discover/system/python-enumeration
    description: "Performs intensive system enumeration (multiple info leaks)"
    criticality: suspicious
    confidence: 0.95
    near_lines: 80
    requires_count: 3
    conditions:
      - type: trait
        id: intel/discover/system/python-platform-system
      - type: trait
        id: intel/discover/system/python-mac-discovery
      - type: trait
        id: intel/discover/system/python-getpass-user
      - type: trait
        id: net/http/request-python