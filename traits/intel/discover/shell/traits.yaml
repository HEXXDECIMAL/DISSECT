# Shell Command Reconnaissance Detection
# Detects system info gathering via shell command execution
# ATT&CK: T1059 (Command Execution), T1082 (System Information Discovery)

traits:
  # execSync with system info commands
  - id: intel/discover/shell/whoami
    description: Shell whoami command execution
    criticality: notable
    confidence: 0.85
    attack: "T1033"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"]whoami['\"]"

  - id: intel/discover/shell/hostname
    description: Shell hostname command execution
    criticality: notable
    confidence: 0.8
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"]hostname['\"]"

  - id: intel/discover/shell/ifconfig
    description: Shell ifconfig/ip command execution
    criticality: notable
    confidence: 0.85
    attack: "T1016"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"](ifconfig|ip addr|ip a)['\"]"

  - id: intel/discover/shell/uname
    description: Shell uname command execution
    criticality: notable
    confidence: 0.75
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"]uname['\"]"

  - id: intel/discover/shell/id
    description: Shell id command execution
    criticality: notable
    confidence: 0.85
    attack: "T1033"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"]id['\"]"

  - id: intel/discover/shell/pwd
    description: Shell pwd command execution
    criticality: inert
    confidence: 0.7
    attack: "T1083"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"]pwd['\"]"

  - id: intel/discover/shell/npm-whoami
    description: npm whoami command execution (npm user discovery)
    criticality: suspicious
    confidence: 0.9
    attack: "T1033"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync)?\\(['\"]npm whoami['\"]"

  # Curl/wget data exfiltration in shell
  - id: intel/discover/shell/curl-exfil
    description: Curl command with data parameter (exfiltration)
    criticality: suspicious
    confidence: 0.9
    attack: "T1041"
    file_types: [javascript, typescript, python, shell]
    condition:
      type: string
      regex: "curl\\s+(-d|--data|-X\\s*POST)"

composite_rules:
  # Multiple system info commands
  - id: intel/discover/shell/system-profiling
    description: Multiple system info commands (reconnaissance)
    criticality: suspicious
    confidence: 0.95
    attack: "T1082"
    requires_count: 2
    conditions:
      - type: trait
        id: intel/discover/shell/whoami
      - type: trait
        id: intel/discover/shell/hostname
      - type: trait
        id: intel/discover/shell/ifconfig
      - type: trait
        id: intel/discover/shell/uname
      - type: trait
        id: intel/discover/shell/id
