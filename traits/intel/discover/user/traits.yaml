# Intelligence Gathering - User Discovery
# ATT&CK: T1033 (System Owner/User Discovery)

traits:
  - id: intel/discover/user/home-env
    description: HOME environment variable lookup
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      regex: "(getenv.*HOME|env\\.HOME|\\$HOME)"

  - id: intel/discover/user/appdata
    description: Windows APPDATA lookup
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [pe, python, javascript]
    condition:
      type: string
      exact: "APPDATA"

  - id: intel/discover/user/localappdata
    description: Windows LOCALAPPDATA lookup
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [pe, python, javascript]
    condition:
      type: string
      exact: "LOCALAPPDATA"

  - id: intel/discover/user/userprofile
    description: Windows USERPROFILE lookup
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [pe, python, javascript]
    condition:
      type: string
      exact: "USERPROFILE"

  - id: intel/discover/user/username-env
    description: USERNAME environment variable
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      regex: "(USERNAME|USER|LOGNAME)"

  - id: intel/discover/user/getuid
    description: Get user ID
    criticality: notable
    confidence: 0.7
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getuid"

  - id: intel/discover/user/getpwuid
    description: Get password entry by UID
    criticality: notable
    confidence: 0.75
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getpwuid"

  - id: intel/discover/user/getpwnam
    description: Get password entry by name
    criticality: suspicious
    confidence: 0.8
    attack: "T1033"
    file_types: [elf, macho]
    condition:
      type: string
      exact: "getpwnam"

  - id: intel/discover/user/dscl
    description: macOS Directory Service CLI
    criticality: suspicious
    confidence: 0.85
    attack: "T1087.001"
    file_types: [macho, shell]
    condition:
      type: string
      regex: "dscl\\s+\\."

  - id: intel/discover/user/dsenableroot
    description: macOS enable root user
    criticality: suspicious
    confidence: 0.85
    attack: "T1087.001"
    file_types: [macho, shell]
    condition:
      type: string
      exact: "dsenableroot"

  - id: intel/discover/user/whoami
    description: Current user lookup
    criticality: suspicious
    confidence: 0.75
    attack: "T1033"
    file_types: [all]
    condition:
      type: string
      exact: "whoami"

  - id: intel/discover/user/etc-passwd
    description: Password file access
    criticality: suspicious
    confidence: 0.8
    attack: "T1087.001"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/passwd"

composite_rules:
  - id: intel/discover/user/enumeration-detected
    description: User enumeration activity
    criticality: suspicious
    confidence: 0.9
    attack: "T1033"
    mbc: "B0046"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule user_enumeration {
          strings:
            $whoami = "whoami"
            $getuid = "getuid" fullword
            $getpwuid = "getpwuid" fullword
            $getpwnam = "getpwnam" fullword
            $etc_passwd = "/etc/passwd"
            $dscl = "dscl"
            $username = "USERNAME" fullword
            $user = "USER" fullword
            $logname = "LOGNAME" fullword
          condition:
            filesize < 20MB and 3 of them
        }
