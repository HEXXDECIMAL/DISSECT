# Discovery - Geolocation and IP Intelligence
# Detects victim geolocation/profiling via IP lookup APIs
# ATT&CK: T1016 (System Network Configuration Discovery)

traits:
  # === IP Geolocation APIs ===

  - id: intel/geo/db-ip-api
    description: db-ip.com geolocation API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      regex: "api\\.db-ip\\.com|db-ip\\.com/v2"

  - id: intel/geo/ipinfo-api
    description: ipinfo.io geolocation API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      regex: "ipinfo\\.io|ip-api\\.com"

  - id: intel/geo/ipapi-api
    description: ip-api.com geolocation API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      exact: "ip-api.com"

  - id: intel/geo/ipify-api
    description: ipify.org IP address API
    criticality: suspicious
    confidence: 0.8
    attack: "T1016"
    condition:
      type: string
      regex: "api\\.ipify\\.org|ipify\\.org"

  - id: intel/geo/ipgeolocation-api
    description: ipgeolocation.io API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      exact: "ipgeolocation.io"

  - id: intel/geo/maxmind-api
    description: MaxMind GeoIP API
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      regex: "geoip\\.maxmind\\.com|maxmind\\.com/geoip"

  - id: intel/geo/freegeoip-api
    description: freegeoip.app API
    criticality: suspicious
    confidence: 0.85
    attack: "T1016"
    condition:
      type: string
      regex: "freegeoip\\.(app|net|io)"

  - id: intel/geo/checkip-aws
    description: AWS checkip service
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "checkip.amazonaws.com"

  - id: intel/geo/icanhazip
    description: icanhazip.com IP lookup
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "icanhazip.com"

  - id: intel/geo/ifconfig-me
    description: ifconfig.me IP lookup
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    condition:
      type: string
      exact: "ifconfig.me"

  # === Response Fields (JSON parsing) ===

  - id: intel/geo/country-code-field
    description: Country code JSON field (geo profiling)
    criticality: notable
    confidence: 0.6
    attack: "T1016"
    condition:
      type: string
      regex: "\\bcountryCode\\b|\\bcountry_code\\b"

  - id: intel/geo/ip-address-field
    description: IP address JSON field (geo profiling)
    criticality: notable
    confidence: 0.5
    attack: "T1016"
    condition:
      type: string
      regex: "\\bipAddress\\b|\\bip_address\\b|\"ip\":"

composite_rules:
  - id: intel/geo/victim-profiling
    description: Victim geolocation profiling via IP API
    criticality: suspicious
    confidence: 0.9
    attack: "T1016"
    condition:
      type: yara
      source: |
        rule victim_geo_profiling {
          meta:
            description = "Uses IP geolocation API to profile victims"
          strings:
            // Common geo APIs
            $api1 = "api.db-ip.com" ascii
            $api2 = "ipinfo.io" ascii
            $api3 = "ip-api.com" ascii
            $api4 = "ipgeolocation.io" ascii
            $api5 = "freegeoip" ascii
            $api6 = "api.ipify.org" ascii
            // JSON response fields
            $field1 = "countryCode" ascii
            $field2 = "country_code" ascii
            $field3 = "ipAddress" ascii
            $field4 = "\"city\":" ascii
            $field5 = "\"region\":" ascii
          condition:
            any of ($api*) and any of ($field*)
        }
