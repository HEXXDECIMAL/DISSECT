# Machine ID / Hardware Fingerprinting
# ATT&CK: T1082 (System Information Discovery)
# Detects collection of unique machine identifiers

traits:
  # Machine ID file access
  - id: intel/fingerprint/machine-id-file
    description: Accesses machine-id file (unique system identifier)
    criticality: suspicious
    confidence: 0.85
    attack: "T1082"
    file_types: [javascript, typescript, python, shell]
    condition:
      type: string
      regex: '/etc/machine-id|/var/lib/dbus/machine-id|MachineGuid'

  # Node.js machine-id package
  - id: intel/fingerprint/machine-id-package
    description: Uses machine-id npm package
    criticality: notable
    confidence: 0.8
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"]node-machine-id['\"]\\)|require\\(['\"]machine-id['\"]\\)|from ['\"]node-machine-id['\"]"

  # Hardware UUID collection (macOS)
  - id: intel/fingerprint/hardware-uuid-macos
    description: Collects macOS hardware UUID
    criticality: suspicious
    confidence: 0.85
    attack: "T1082"
    file_types: [javascript, typescript, shell, python]
    condition:
      type: string
      regex: 'system_profiler SPHardwareDataType|IOPlatformUUID|ioreg.*IOPlatformSerialNumber'

  # Windows machine GUID
  - id: intel/fingerprint/machine-guid-windows
    description: Collects Windows machine GUID
    criticality: suspicious
    confidence: 0.85
    attack: "T1082"
    file_types: [javascript, typescript, powershell]
    condition:
      type: string
      regex: 'HKLM.*Cryptography.*MachineGuid|wmic csproduct get uuid'

  # CPU ID collection
  - id: intel/fingerprint/cpu-id
    description: Collects CPU identifier
    criticality: notable
    confidence: 0.75
    attack: "T1082"
    file_types: [javascript, typescript, python, shell]
    condition:
      type: string
      regex: '/proc/cpuinfo|processor.*id|cpuid'

  # Disk serial collection
  - id: intel/fingerprint/disk-serial
    description: Collects disk serial number
    criticality: notable
    confidence: 0.75
    attack: "T1082"
    file_types: [javascript, typescript, shell]
    condition:
      type: string
      regex: 'hdparm.*-i|smartctl|wmic diskdrive get serialnumber'

  # BIOS/firmware serial
  - id: intel/fingerprint/bios-serial
    description: Collects BIOS/firmware serial
    criticality: notable
    confidence: 0.75
    attack: "T1082"
    file_types: [javascript, typescript, shell]
    condition:
      type: string
      regex: 'dmidecode|wmic bios get serialnumber|system_profiler SPHardwareDataType'

  # Comprehensive hardware fingerprint
  - id: intel/fingerprint/hardware-comprehensive
    description: Comprehensive hardware fingerprinting (multiple vectors)
    criticality: suspicious
    confidence: 0.9
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule comprehensive_fingerprint {
          strings:
            $mac = "networkInterfaces" ascii
            $cpu = "cpus()" ascii
            $mem = "totalmem" ascii
            $host = "hostname()" ascii
            $user = "userInfo()" ascii
            $plat = "platform()" ascii
            $arch = "arch()" ascii
            $release = "release()" ascii
          condition:
            4 of them
        }

  # Unique identifier generation with exfil
  - id: intel/fingerprint/unique-id-exfil
    description: Generates unique identifier and sends to network
    criticality: hostile
    confidence: 0.95
    attack: "T1082"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule unique_id_exfil {
          strings:
            // ID generation
            $id1 = "machine-id" ascii
            $id2 = "uuid" ascii
            $id3 = "fingerprint" ascii
            $id4 = "uniqueId" ascii
            $id5 = "deviceId" ascii
            // Combined with network
            $net1 = "fetch(" ascii
            $net2 = "https.request" ascii
            $net3 = "POST" ascii
            $net4 = "webhook" ascii
          condition:
            any of ($id*) and any of ($net*)
        }

