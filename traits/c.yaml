# C Language Traits and Capabilities
# Detection rules for C programs covering buffer overflows, format strings, shellcode, and unsafe operations

# ============================================================================
# TRAITS: Atomic Observations
# ============================================================================

traits:
  # ==========================================
  # Command Execution
  # ==========================================

  - id: exec/c/system
    description: system() command execution
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: system
    platforms: [all]

  - id: exec/c/popen
    description: popen() command execution
    capability: true
    criticality: high
    confidence: 0.9
    type: symbol
    pattern: popen
    platforms: [unix, linux, macos]

  - id: exec/c/execve
    description: execve() program execution
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: execve
    platforms: [unix, linux, macos]

  - id: exec/c/execl
    description: execl() program execution
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: execl
    platforms: [unix, linux, macos]

  - id: exec/c/execlp
    description: execlp() program execution
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: execlp
    platforms: [unix, linux, macos]

  - id: exec/c/execv
    description: execv() program execution
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: execv
    platforms: [unix, linux, macos]

  - id: exec/c/execvp
    description: execvp() program execution
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: execvp
    platforms: [unix, linux, macos]

  # ==========================================
  # Buffer Overflow Risks (Dangerous Functions)
  # ==========================================

  - id: unsafe/c/strcpy
    description: strcpy (buffer overflow risk)
    capability: true
    criticality: high
    confidence: 0.85
    type: symbol
    pattern: strcpy
    platforms: [all]

  - id: unsafe/c/strcat
    description: strcat (buffer overflow risk)
    capability: true
    criticality: high
    confidence: 0.85
    type: symbol
    pattern: strcat
    platforms: [all]

  - id: unsafe/c/gets
    description: gets (buffer overflow risk)
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: gets
    platforms: [all]

  - id: unsafe/c/sprintf
    description: sprintf (buffer overflow risk)
    capability: true
    criticality: high
    confidence: 0.85
    type: symbol
    pattern: sprintf
    platforms: [all]

  - id: unsafe/c/vsprintf
    description: vsprintf (buffer overflow risk)
    capability: true
    criticality: high
    confidence: 0.85
    type: symbol
    pattern: vsprintf
    platforms: [all]

  - id: unsafe/c/scanf
    description: scanf (buffer overflow risk)
    capability: true
    criticality: medium
    confidence: 0.8
    type: symbol
    pattern: scanf
    platforms: [all]

  # Safe alternatives (for comparison)
  - id: safe/c/strncpy
    description: strncpy (safer alternative)
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: strncpy
    platforms: [all]

  - id: safe/c/strncat
    description: strncat (safer alternative)
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: strncat
    platforms: [all]

  - id: safe/c/snprintf
    description: snprintf (safer alternative)
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: snprintf
    platforms: [all]

  - id: safe/c/fgets
    description: fgets (safer alternative)
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: fgets
    platforms: [all]

  # ==========================================
  # Format String Vulnerabilities
  # ==========================================

  - id: unsafe/c/printf-format
    description: printf with format string
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: printf
    platforms: [all]

  - id: unsafe/c/fprintf-format
    description: fprintf with format string
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: fprintf
    platforms: [all]

  - id: unsafe/c/syslog-format
    description: syslog with format string
    criticality: none
    confidence: 0.75
    type: symbol
    pattern: syslog
    platforms: [unix, linux, macos]

  # ==========================================
  # Inline Assembly (Shellcode Indicator)
  # ==========================================

  - id: unsafe/c/asm
    description: Inline assembly
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: __asm__
    platforms: [all]

  - id: unsafe/c/asm-short
    description: Inline assembly (short form)
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: asm
    platforms: [all]

  - id: unsafe/c/asm-volatile
    description: Volatile inline assembly
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: __volatile__
    platforms: [all]

  # ==========================================
  # Network Operations
  # ==========================================

  - id: net/c/socket
    description: Socket creation
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: socket
    platforms: [all]

  - id: net/c/connect
    description: Socket connection
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: connect
    platforms: [all]

  - id: net/c/bind
    description: Socket binding
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: bind
    platforms: [all]

  - id: net/c/listen
    description: Socket listening
    capability: true
    criticality: low
    confidence: 0.9
    type: symbol
    pattern: listen
    platforms: [all]

  - id: net/c/accept
    description: Accept connection
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: accept
    platforms: [all]

  - id: net/c/recv
    description: Receive data
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: recv
    platforms: [all]

  - id: net/c/send
    description: Send data
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: send
    platforms: [all]

  # ==========================================
  # I/O Redirection
  # ==========================================

  - id: io/c/dup2
    description: Duplicate file descriptor (I/O redirection)
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: dup2
    platforms: [unix, linux, macos]

  - id: io/c/dup
    description: Duplicate file descriptor
    criticality: none
    confidence: 0.8
    type: symbol
    pattern: dup
    platforms: [unix, linux, macos]

  # ==========================================
  # Memory Operations
  # ==========================================

  - id: memory/c/malloc
    description: Dynamic memory allocation
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: malloc
    platforms: [all]

  - id: memory/c/calloc
    description: Zeroed memory allocation
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: calloc
    platforms: [all]

  - id: memory/c/realloc
    description: Reallocate memory
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: realloc
    platforms: [all]

  - id: memory/c/memcpy
    description: Memory copy
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: memcpy
    platforms: [all]

  - id: memory/c/memmove
    description: Safe memory move
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: memmove
    platforms: [all]

  - id: memory/c/memset
    description: Memory set
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: memset
    platforms: [all]

  - id: memory/c/mmap
    description: Memory mapping
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: mmap
    platforms: [unix, linux, macos]

  - id: memory/c/mprotect
    description: Change memory protection
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: mprotect
    platforms: [unix, linux, macos]

  - id: memory/c/virtualalloc
    description: Virtual memory allocation (Windows)
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: VirtualAlloc
    platforms: [windows]

  - id: memory/c/virtualprotect
    description: Change memory protection (Windows)
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: VirtualProtect
    platforms: [windows]

  # ==========================================
  # Process Operations
  # ==========================================

  - id: process/c/fork
    description: Fork process
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: fork
    platforms: [unix, linux, macos]

  - id: process/c/vfork
    description: vfork process
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: vfork
    platforms: [unix, linux, macos]

  - id: process/c/kill
    description: Send signal to process
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: kill
    platforms: [unix, linux, macos]

  - id: process/c/ptrace
    description: Process tracing/debugging
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: ptrace
    platforms: [linux, unix]

  - id: process/c/setuid
    description: Set user ID
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: setuid
    platforms: [unix, linux, macos]

  - id: process/c/setgid
    description: Set group ID
    capability: true
    criticality: high
    confidence: 0.95
    type: symbol
    pattern: setgid
    platforms: [unix, linux, macos]

  # ==========================================
  # Dynamic Loading
  # ==========================================

  - id: exec/c/dlopen
    description: Dynamic library loading
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: dlopen
    platforms: [unix, linux, macos]

  - id: exec/c/dlsym
    description: Resolve dynamic symbol
    capability: true
    criticality: medium
    confidence: 0.85
    type: symbol
    pattern: dlsym
    platforms: [unix, linux, macos]

  - id: exec/c/loadlibrary
    description: Load library (Windows)
    capability: true
    criticality: medium
    confidence: 0.9
    type: symbol
    pattern: LoadLibrary
    platforms: [windows]

  - id: exec/c/getprocaddress
    description: Get procedure address (Windows)
    capability: true
    criticality: medium
    confidence: 0.85
    type: symbol
    pattern: GetProcAddress
    platforms: [windows]

  # ==========================================
  # File Operations
  # ==========================================

  - id: fs/c/fopen
    description: Open file
    criticality: none
    confidence: 0.7
    type: symbol
    pattern: fopen
    platforms: [all]

  - id: fs/c/remove
    description: Delete file
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: remove
    platforms: [all]

  - id: fs/c/unlink
    description: Unlink file
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: unlink
    platforms: [unix, linux, macos]

  - id: fs/c/chmod
    description: Change file permissions
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: chmod
    platforms: [unix, linux, macos]

  - id: fs/c/chown
    description: Change file ownership
    capability: true
    criticality: low
    confidence: 0.85
    type: symbol
    pattern: chown
    platforms: [unix, linux, macos]

  # ==========================================
  # Cryptography
  # ==========================================

  - id: crypto/c/openssl
    description: OpenSSL library usage
    criticality: none
    confidence: 0.8
    type: string
    pattern: openssl/
    platforms: [all]

  - id: crypto/c/aes
    description: AES encryption
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: AES_encrypt
    platforms: [all]

  - id: crypto/c/rsa
    description: RSA operations
    criticality: none
    confidence: 0.85
    type: symbol
    pattern: RSA_public_encrypt
    platforms: [all]

  # ==========================================
  # Function Pointers (Code Injection Risk)
  # ==========================================

  - id: meta/c/function-pointer
    description: Function pointer usage
    criticality: none
    confidence: 0.7
    type: string
    pattern: '(*'
    platforms: [all]

  # ==========================================
  # Shell References
  # ==========================================

  - id: exec/shell/bin-sh
    description: References /bin/sh
    criticality: none
    confidence: 1.0
    type: string
    exact: '/bin/sh'
    platforms: [unix, linux, macos]

  - id: exec/shell/bin-bash
    description: References /bin/bash
    criticality: none
    confidence: 1.0
    type: string
    exact: '/bin/bash'
    platforms: [unix, linux, macos]

  - id: exec/shell/cmd-exe
    description: References cmd.exe
    criticality: none
    confidence: 1.0
    type: string
    exact: 'cmd.exe'
    platforms: [windows]

# ============================================================================
# COMPOSITE CAPABILITIES: Behavioral Interpretations
# ============================================================================

capabilities:
  # ==========================================
  # Classic Reverse Shell
  # ==========================================

  - id: c2/c/reverse-shell
    description: Classic reverse shell pattern (socket + dup2 + shell)
    confidence: 0.98
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: net/c/socket
      - type: trait
        id: net/c/connect
      - type: trait
        id: io/c/dup2
      - type: trait
        id: exec/shell/bin-sh
  - id: c2/c/reverse-shell-exec
    description: Reverse shell via exec family
    confidence: 0.98
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: net/c/socket
      - type: trait
        id: net/c/connect
      - type: trait
        id: exec/c/execve
  # ==========================================
  # Shellcode Execution
  # ==========================================

  - id: exec/c/shellcode
    description: Shellcode execution pattern (mmap + mprotect + execute)
    confidence: 0.95
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: memory/c/mmap
      - type: trait
        id: memory/c/mprotect
      - type: trait
        id: unsafe/c/asm
  - id: exec/c/shellcode-windows
    description: Shellcode execution (Windows)
    confidence: 0.95
    criticality: high
    platforms: [windows]

    requires_all:
      - type: trait
        id: memory/c/virtualalloc
      - type: trait
        id: memory/c/virtualprotect
  # ==========================================
  # Buffer Overflow Exploitation
  # ==========================================

  - id: unsafe/c/buffer-overflow-risk
    description: Buffer overflow risk pattern (dangerous functions)
    confidence: 0.85
    criticality: high
    platforms: [all]

    requires_count: 2
    conditions:
      - type: trait
        id: unsafe/c/strcpy
      - type: trait
        id: unsafe/c/strcat
      - type: trait
        id: unsafe/c/gets
      - type: trait
        id: unsafe/c/sprintf
  - id: unsafe/c/buffer-vs-safe
    description: Mixed use of dangerous and safe string functions
    confidence: 0.75
    criticality: medium
    platforms: [all]

    requires_all:
      - type: trait
        id: unsafe/c/strcpy
      - type: trait
        id: safe/c/strncpy
  # ==========================================
  # Code Injection
  # ==========================================

  - id: exec/c/dylib-inject
    description: Dynamic library injection
    confidence: 0.92
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: exec/c/dlopen
      - type: trait
        id: exec/c/dlsym
      - type: trait
        id: memory/c/mprotect
  - id: exec/c/dll-inject-windows
    description: DLL injection (Windows)
    confidence: 0.92
    criticality: high
    platforms: [windows]

    requires_all:
      - type: trait
        id: exec/c/loadlibrary
      - type: trait
        id: exec/c/getprocaddress
      - type: trait
        id: memory/c/virtualprotect
  # ==========================================
  # Process Injection
  # ==========================================

  - id: exec/c/ptrace-inject
    description: Process injection via ptrace
    confidence: 0.95
    criticality: high
    platforms: [linux, unix]

    requires_all:
      - type: trait
        id: process/c/ptrace
      - type: trait
        id: memory/c/mmap
      - type: trait
        id: exec/c/dlopen
  # ==========================================
  # Privilege Escalation
  # ==========================================

  - id: privilege/c/setuid-exec
    description: Privilege escalation via setuid + execution
    confidence: 0.95
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: process/c/setuid
      - type: trait
        id: exec/c/system
  - id: privilege/c/setuid-shell
    description: Setuid shell execution
    confidence: 0.98
    criticality: high
    platforms: [unix, linux, macos]

    requires_all:
      - type: trait
        id: process/c/setuid
      - type: trait
        id: exec/c/execve
      - type: trait
        id: exec/shell/bin-sh
  # ==========================================
  # Anti-Debugging
  # ==========================================

  - id: anti-analysis/c/ptrace-anti-debug
    description: ptrace-based anti-debugging
    confidence: 0.90
    criticality: medium
    platforms: [linux, unix]

    requires_all:
      - type: trait
        id: process/c/ptrace
      - type: trait
        id: process/c/fork
  # ==========================================
  # Network Backdoor
  # ==========================================

  - id: c2/c/bind-shell
    description: Bind shell (listening backdoor)
    confidence: 0.95
    criticality: high
    platforms: [all]

    requires_all:
      - type: trait
        id: net/c/socket
      - type: trait
        id: net/c/bind
      - type: trait
        id: net/c/listen
      - type: trait
        id: io/c/dup2
      - type: trait
        id: exec/shell/bin-sh