---
# Ruby System Information Exfiltration
# Detects system fingerprinting and data exfiltration
# ATT&CK: T1082 (System Information Discovery), T1041 (Exfiltration Over C2 Channel)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Platform Check ===
  - id: platform-fingerprint
    desc: Platform fingerprinting check
    crit: notable
    conf: 0.75
    attack: "T1082"
    if:
      type: string
      regex: 'RUBY_PLATFORM.*include|RUBY_PLATFORM.*match|darwin|linux|mswin'

  # === Socket Hostname ===
  - id: socket-hostname
    desc: Socket hostname discovery
    crit: notable
    conf: 0.70
    attack: "T1082"
    if:
      type: string
      regex: 'Socket\.gethostname|gethostname'

  # === Socket IP Address ===
  - id: socket-ip-address
    desc: Socket IP address discovery
    crit: notable
    conf: 0.75
    attack: "T1016"
    if:
      type: string
      regex: 'Socket\.ip_address_list|ip_address_list|ipv4\?|ip_address'

  # === System Info Collection ===
  - id: system-info-collect
    desc: System information collection
    crit: suspicious
    conf: 0.80
    attack: "T1082"
    if:
      type: string
      regex: 'hostname.*os.*ip|platform.*username|info\[.*hostname|to_json'

  # === Hardcoded IP Exfiltration ===
  - id: hardcoded-ip-exfil
    desc: Hardcoded IP for data exfiltration
    crit: suspicious
    conf: 0.85
    attack: "T1041"
    if:
      type: string
      regex: 'http://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+|https://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'

  # === JSON Data Encoding ===
  - id: json-data-encode
    desc: JSON data encoding for exfiltration
    crit: notable
    conf: 0.70
    attack: "T1027"
    if:
      type: string
      regex: 'to_json|JSON\.generate|\.to_json'

  # === Base64 JSON Encoding ===
  - id: base64-json-encode
    desc: Base64 encoded JSON data
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    if:
      type: string
      regex: 'Base64\.encode64.*to_json|encode64.*json|Base64\..*json'

  # === Rakefile Payload ===
  - id: rakefile-payload
    desc: Rakefile as payload delivery
    crit: notable
    conf: 0.70
    attack: "T1059"
    if:
      type: string
      regex: 'Rakefile|require.*rake'

composite_rules:
  # === System Info Exfiltration ===
  - id: system-info-exfiltration
    desc: System information exfiltration
    crit: suspicious
    conf: 0.92
    attack: "T1041"
    count_min: 4
    any:
      - id: platform-fingerprint
      - id: socket-hostname
      - id: socket-ip-address
      - id: system-info-collect
      - id: hardcoded-ip-exfil
      - id: base64-json-encode
      - id: discovery/user/username-env

  # === Platform-Specific Payload ===
  - id: platform-specific-payload
    desc: Platform-specific malicious payload
    crit: suspicious
    conf: 0.88
    attack: "T1059"
    count_min: 3
    any:
      - id: platform-fingerprint
      - id: rakefile-payload
      - id: system-info-collect
      - id: comm/http/request/ruby-http-get-response
