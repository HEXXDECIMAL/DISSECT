# Data Exfiltration Patterns for Info-Stealers
# Detects C2 communication patterns common in credential stealers
# ATT&CK: T1041 (Exfiltration Over C2 Channel)

defaults:
  attack: "T1041"
  crit: suspicious
  # curl/wget commands can be embedded in any file type
  for: ["*"]

traits:
  # === Gate URL atomic (EXFIL-SPECIFIC) ===
  - id: gate-var-http
    description: gate = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bgate\\s*=\\s*[\"']http"

  - id: c2-var-http
    description: c2 = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bc2\\s*=\\s*[\"']http"

  - id: panel-var-http
    description: panel = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bpanel\\s*=\\s*[\"']http"

composite_rules:
  # Gate URL (exfil-specific)
  - id: gate-url
    description: Hardcoded gate/C2 URL variable
    crit: suspicious
    conf: 0.85
    for: [shell, python, javascript]
    requires_count: 1
    any:
      - id: gate-var-http
      - id: c2-var-http
      - id: panel-var-http

  # curl POST with custom headers (references comm/http/client/)
  - id: curl-post-headers
    description: curl POST with custom identification headers
    crit: suspicious
    conf: 0.9
    mbc: "C0001"
    for: [shell]
    requires_count: 1
    any:
      - id: comm/http/client/curl-post-x
      - id: comm/http/client/curl-user-header
      - id: comm/http/client/curl-buildid-header

  # curl file upload (references comm/http/client/)
  - id: curl-upload
    description: curl file upload
    crit: suspicious
    conf: 0.8
    for: [shell]
    requires_count: 1
    any:
      - id: comm/http/client/curl-form-upload
      - id: comm/http/client/curl-data-binary
      - id: comm/http/client/curl-at-tmp

  # Bot identification headers (references comm/http/headers/)
  - id: bot-headers
    description: Bot identification HTTP headers
    crit: suspicious
    conf: 0.9
    for: [shell]
    requires_any:
      - id: comm/http/headers/bot-headers

  # ZIP upload (references comm/http/upload/)
  - id: zip-upload
    description: ZIP archive upload for exfiltration
    crit: suspicious
    conf: 0.9
    for: [shell]
    requires_any:
      - id: comm/http/upload/zip-upload

  # Multipart upload (references comm/http/headers/)
  - id: multipart-upload
    description: Multipart form data upload
    crit: suspicious
    conf: 0.75
    for: [shell, python, javascript]
    requires_any:
      - id: comm/http/headers/multipart-upload

  # HTTP client/POST (references comm/http/client/ and comm/http/)
  - id: http-client-post
    description: HTTP client tool or POST method
    crit: notable
    conf: 0.8
    for: [shell]
    requires_count: 1
    any:
      - id: comm/http/client/curl-cmd
      - id: comm/http/client/wget-cmd
      - id: comm/http/post-method

  # Full exfiltration pattern: archive + upload
  - id: stealer-exfil
    description: Stealer data exfiltration pattern
    crit: hostile
    conf: 0.95
    mbc: "C0001"
    for: [shell]
    requires_all:
      - id: http-client-post
    requires_any:
      - id: curl-post-headers
      - id: bot-headers
      - id: gate-url
