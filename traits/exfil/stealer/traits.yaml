# Data Exfiltration Patterns for Info-Stealers
# Detects C2 communication patterns common in credential stealers
# ATT&CK: T1041 (Exfiltration Over C2 Channel)

defaults:
  attack: "T1041"
  crit: suspicious
  # curl/wget commands can be embedded in any file type
  for: ["*"]

traits:
  # === Gate URL atomic (EXFIL-SPECIFIC) ===
  - id: gate-var-http
    desc: gate = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bgate\\s*=\\s*[\"']http"

  - id: c2-var-http
    desc: c2 = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bc2\\s*=\\s*[\"']http"

  - id: panel-var-http
    desc: panel = http variable
    crit: notable
    conf: 0.7
    for: [shell, python, javascript]
    if:
      type: string
      regex: "\\bpanel\\s*=\\s*[\"']http"

composite_rules:
  # Gate URL (exfil-specific)
  - id: gate-url
    desc: Hardcoded gate/C2 URL variable
    crit: suspicious
    conf: 0.85
    for: [shell, python, javascript]
    count_min: 1
    any:
      - id: gate-var-http
      - id: c2-var-http
      - id: panel-var-http

  # curl POST with custom headers (references comm/http/client/)
  # NOTE: This is suspicious because legitimate downloads don't use custom POST headers
  - id: curl-post-headers
    desc: curl POST with custom identification
    crit: suspicious
    conf: 0.9
    mbc: "C0001"
    for: [shell]
    count_min: 1
    any:
      - id: comm/http/client/curl-post-x
      - id: comm/http/client/curl-user-header
      - id: comm/http/client/curl-buildid-header

  # curl file upload (references comm/http/client/)
  - id: curl-upload
    desc: curl file upload
    crit: suspicious
    conf: 0.8
    for: [shell]
    count_min: 1
    any:
      - id: comm/http/client/curl-form-upload
      - id: comm/http/client/curl-data-binary
      - id: comm/http/client/curl-at-tmp

  # Bot identification headers (references comm/http/headers/)
  - id: bot-headers
    desc: Bot identification HTTP headers
    crit: suspicious
    conf: 0.9
    for: [shell]
    any:
      - id: comm/http/headers/bot-headers

  # ZIP upload (references comm/http/upload/)
  - id: zip-upload
    desc: ZIP archive upload for exfiltration
    crit: suspicious
    conf: 0.9
    for: [shell]
    any:
      - id: comm/http/upload/zip-upload

  # Multipart upload (references comm/http/headers/)
  - id: multipart-upload
    desc: Multipart form data upload
    crit: suspicious
    conf: 0.75
    for: [shell, python, javascript]
    any:
      - id: comm/http/headers/multipart-upload

  # Full exfiltration pattern: must have POST with custom headers or C2 indicators
  # NOTE: Simple curl downloads (without POST/upload indicators) won't trigger this
  - id: stealer-exfil
    desc: Stealer data exfiltration pattern
    crit: notable
    conf: 0.95
    mbc: "C0001"
    for: [shell]
    count_min: 3
    any:
      - id: curl-post-headers
      - id: curl-upload
      - id: bot-headers
      - id: gate-url
      - id: zip-upload
