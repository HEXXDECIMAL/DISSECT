# macOS Archive Utilities for Exfiltration
# Detects use of macOS-specific compression for data staging
# ATT&CK: T1560.001 (Archive Collected Data: Archive via Utility)

defaults:
  attack: "T1560.001"
  platforms: [macos]
  crit: notable

traits:
  # === ditto compress atomic indicators ===
  - id: ditto-ck-flags
    desc: ditto -c -k compression flags
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "ditto\\s+-c\\s+-k"

  - id: ditto-keepparent
    desc: ditto --keepParent compression
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "ditto.*--keepParent.*-c"

  # === ditto sequester atomic indicators ===
  - id: ditto-sequesterrsrc
    desc: ditto --sequesterRsrc flag
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: "--sequesterRsrc"

  - id: ditto-rsrc-flag
    desc: ditto -rsrc flag
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "ditto.*-rsrc"

  # === zip create atomic indicators ===
  - id: zip-recursive-quiet
    desc: zip -r or -q flag
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "\\bzip\\s+-[rq]"

  - id: zip-output-file
    desc: zip with .zip output
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "\\bzip\\s+.*\\.zip"

  # === tmp archive atomic indicators ===
  - id: tmp-zip-path
    desc: zip file in /tmp
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "/tmp/.*\\.zip"

  - id: tmp-out-zip
    desc: /tmp/out.zip file
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/tmp/out.zip"

  - id: var-tmp-zip
    desc: zip file in /var/tmp
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "/var/tmp/.*\\.zip"

composite_rules:
  # ditto compress composite
  - id: ditto-compress
    desc: ditto archive creation with compression
    crit: suspicious
    conf: 0.85
    requires_count: 1
    any:
      - id: ditto-ck-flags
      - id: ditto-keepparent

  # ditto sequester composite
  - id: ditto-sequester
    desc: ditto with resource fork handling
    crit: suspicious
    conf: 0.9
    requires_count: 1
    any:
      - id: ditto-sequesterrsrc
      - id: ditto-rsrc-flag

  # zip create composite
  - id: zip-create
    desc: zip archive creation
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: zip-recursive-quiet
      - id: zip-output-file

  # tmp archive composite
  - id: tmp-archive
    desc: "Archive creation in /tmp"
    crit: suspicious
    conf: 0.8
    requires_count: 1
    any:
      - id: tmp-zip-path
      - id: tmp-out-zip
      - id: var-tmp-zip

  # ditto staging for exfil
  - id: ditto-staging
    desc: "macOS data staging via ditto"
    crit: suspicious
    conf: 0.9
    attack: "T1560.001"
    for: [shell, applescript, python]
    requires_any:
      - id: ditto-compress
      - id: ditto-sequester
    requires_all:
      - id: tmp-archive

  # Archive with curl exfil
  - id: archive-exfil
    desc: "Archive creation with HTTP exfiltration"
    crit: hostile
    conf: 0.95
    attack: "T1560.001"
    for: [shell, applescript, python]
    requires_all:
      - id: tmp-archive
    requires_any:
      - id: ditto-compress
      - id: ditto-sequester
      - id: zip-create
