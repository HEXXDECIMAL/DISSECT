# Node.js Data Encoding for Exfiltration
# ATT&CK: T1027 (Obfuscated Files or Information), T1132 (Data Encoding)

traits:
  # Base64 encoding
  - id: node-base64-encode
    description: Base64 encodes data (pre-exfiltration)
    criticality: notable
    confidence: 0.8
    attack: "T1132"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "toString\\(['\"]base64['\"]\\)"

  - id: node-buffer-base64
    description: Buffer to base64 conversion
    criticality: notable
    confidence: 0.85
    attack: "T1132"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "Buffer\\.from\\([^)]+\\)\\.toString\\(['\"]base64['\"]\\)"

  - id: node-base64-decode
    description: Base64 decodes data
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "Buffer\\.from\\([^,]+,\\s*['\"]base64['\"]\\)"

  # Hex encoding
  - id: node-hex-encode
    description: Hex encodes data
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "toString\\(['\"]hex['\"]\\)"

  # JSON serialization
  - id: node-json-stringify
    description: JSON serializes data for transmission
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: 'JSON\.stringify\('

  # URL encoding
  - id: node-querystring
    description: URL-encodes data using querystring
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: 'querystring\.stringify\('

  - id: node-url-params
    description: Creates URLSearchParams for data
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: 'new URLSearchParams\('

  # HTTP request patterns for exfiltration detection (atomic)
  - id: node-http-req
    description: http.request method
    criticality: inert
    confidence: 0.5
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "http.request"

  - id: node-https-req
    description: https.request method
    criticality: inert
    confidence: 0.5
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "https.request"

  - id: node-axios
    description: axios library
    criticality: inert
    confidence: 0.5
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "axios"

  - id: node-fetch-call
    description: fetch() call
    criticality: inert
    confidence: 0.5
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "fetch("

composite_rules:
  # HTTP request composite
  - id: node-http-request
    description: HTTP request capable of sending data
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    requires_count: 1
    conditions:
      - type: trait
        id: node-http-req
      - type: trait
        id: node-https-req
      - type: trait
        id: node-axios
      - type: trait
        id: node-fetch-call

  # Encode then exfil pattern
  - id: node-encode-exfil
    description: Encodes data then sends via HTTP (exfiltration)
    criticality: suspicious
    confidence: 0.9
    attack: "T1041"
    requires_all:
      - type: trait
        id: node-base64-encode
      - type: trait
        id: comm/http/request/node-http-request
