# HTTP POST Exfiltration - JavaScript/Node.js
# Detects HTTP POST requests that may be used for data exfiltration
# ATT&CK: T1041 (Exfiltration Over C2 Channel)

defaults:
  # String patterns work in JavaScript source, TypeScript, and packaged/embedded JS (Electron, pkg, nexe)
  for: [javascript, typescript, elf, macho, pe]
  attack: "T1041"

traits:
  # === Axios POST atomic indicators ===
  - id: axios-dot-post
    description: axios.post method call
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "axios.post"

  - id: axios-bracket-post
    description: axios bracket post access
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "axios\\[.{0,30}post"

  # === Fetch POST atomic indicators ===
  - id: fetch-with-post
    description: fetch with POST method
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "fetch\\(.{0,50}POST"

  - id: method-post-string
    description: method POST string
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "method:\\s*['\"]POST"

  # === Request POST atomic indicators ===
  - id: request-dot-post
    description: request.post method call
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "request.post"

  - id: request-method-post
    description: request with method POST
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "request\\(.{0,50}method.{0,20}POST"

composite_rules:
  # Axios POST composite
  - id: axios-post
    description: axios POST request (potential exfiltration)
    crit: suspicious
    conf: 0.8
    requires_count: 1
    any:
      - id: axios-dot-post
      - id: axios-bracket-post

  # Fetch POST composite
  - id: fetch-post
    description: fetch POST request (potential exfiltration)
    crit: suspicious
    conf: 0.8
    requires_count: 1
    any:
      - id: fetch-with-post
      - id: method-post-string

  # Request POST composite
  - id: request-post
    description: request module POST (potential exfiltration)
    crit: suspicious
    conf: 0.8
    requires_count: 1
    any:
      - id: request-dot-post
      - id: request-method-post

  # HTTP request composite
  - id: http-request
    description: Node.js http.request (potential exfiltration)
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: comm/http/request/javascript/http-request
      - id: comm/http/request/javascript/https-request
