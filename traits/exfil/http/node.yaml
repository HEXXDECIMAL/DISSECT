# Node.js HTTP Exfiltration Patterns
# ATT&CK: T1041 (Exfiltration Over C2 Channel), T1071 (Application Layer Protocol)

traits:
  # HTTP POST with JSON body
  - id: node-post-json
    description: HTTP POST request with JSON body
    crit: notable
    conf: 0.75
    attack: "T1041"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule http_post_json {
          strings:
            $method = "method:" ascii
            $post = "'POST'" ascii
            $post2 = "\"POST\"" ascii
            $json = "application/json" ascii
          condition:
            $method and ($post or $post2) and $json
        }

  # HTTP GET with query params (data in URL)
  - id: node-get-params
    description: HTTP GET with data in query parameters
    crit: notable
    conf: 0.8
    attack: "T1041"
    for: [javascript, typescript]
    if:
      type: string
      regex: "path:\\s*[`\"'][^`\"']*\\$\\{"

  # axios POST
  - id: node-axios-post
    description: Sends data via axios POST request
    crit: notable
    conf: 0.8
    attack: "T1041"
    for: [javascript, typescript]
    if:
      type: string
      regex: "axios\\.post\\("

  # axios with data
  - id: node-axios-data
    description: axios request with data payload
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: string
      regex: "axios\\(\\{[^}]*data:"

  # fetch POST
  - id: node-fetch-post
    description: Sends data via fetch POST request
    crit: notable
    conf: 0.8
    attack: "T1041"
    for: [javascript, typescript]
    if:
      type: string
      regex: "fetch\\([^)]+\\{[^}]*method:\\s*['\"]POST['\"]"

  # http.request
  - id: node-http-request
    description: Makes HTTP request using http module
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "http\\.request\\("

  # https.request
  - id: node-https-request
    description: Makes HTTPS request using https module
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "https\\.request\\("

  # https.get
  - id: node-https-get
    description: Makes HTTPS GET request
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "https\\.get\\("

  # Request write (sending body)
  - id: node-req-write
    description: Writes data to HTTP request body
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "req\\.write\\("

  # Silent error handling (hiding exfil failures)
  - id: node-silent-error
    description: Silent error handling (hides network failures)
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\.on\\(['\"]error['\"],\\s*\\(\\)\\s*=>\\s*\\{\\s*\\}\\)"

  # Timeout handling
  - id: node-request-timeout
    description: HTTP request with timeout handling
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\.setTimeout\\(\\d+,"

  # === HTTP method atomic indicators ===
  - id: axios-post-call
    description: axios.post() call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "axios.post"

  - id: fetch-call
    description: fetch() call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "fetch("

  # === HTTP library atomic indicators ===
  - id: axios-import
    description: axios library usage
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: "axios"

composite_rules:
  # HTTP request methods composite
  - id: node-http-methods
    description: Node.js HTTP request methods
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: axios-post-call
      - id: node-https-request
      - id: node-http-request
      - id: fetch-call

  # HTTP libraries composite
  - id: node-http-libs
    description: Node.js HTTP request libraries
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    requires_count: 1
    any:
      - id: axios-import
      - id: node-https-request
      - id: node-http-request
      - id: fetch-call

  # Collect and exfil pattern
  - id: node-collect-exfil
    description: Collects system info and exfiltrates via HTTP
    crit: suspicious
    conf: 0.95
    attack: "T1041"
    for: [javascript, typescript]
    requires_all:
      - id: discovery/system/node
      - id: node-http-methods

  # Stealthy exfil (silent errors)
  - id: node-stealthy-exfil
    description: Stealthy exfiltration with silent error handling
    crit: suspicious
    conf: 0.85
    attack: "T1041"
    requires_all:
      - id: node-silent-error
      - id: node-http-libs
