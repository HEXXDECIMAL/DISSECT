# Exfiltration - Telegram Bot API
# Reference: https://core.telegram.org/bots/api
# ATT&CK: T1567.002 (Exfiltration Over Web Service)

traits:
  - id: exfil/telegram/api-endpoint
    description: Telegram Bot API endpoint
    criticality: suspicious
    confidence: 0.9
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      exact: "api.telegram.org"

  - id: exfil/telegram/api-endpoint-b64
    description: Telegram Bot API endpoint (base64)
    criticality: suspicious
    confidence: 0.95
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      exact: "YXBpLnRlbGVncmFtLm9yZw=="

  - id: exfil/telegram/send-message
    description: Telegram sendMessage API
    criticality: suspicious
    confidence: 0.85
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      exact: "/sendMessage"

  - id: exfil/telegram/send-document
    description: Telegram sendDocument API
    criticality: suspicious
    confidence: 0.9
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      exact: "/sendDocument"

  - id: exfil/telegram/send-location
    description: Telegram sendLocation API
    criticality: suspicious
    confidence: 0.9
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      exact: "/sendLocation"

  - id: exfil/telegram/send-photo
    description: Telegram sendPhoto API
    criticality: suspicious
    confidence: 0.9
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      exact: "/sendPhoto"

  - id: exfil/telegram/bot-token
    description: Telegram bot token pattern
    criticality: suspicious
    confidence: 0.95
    attack: "T1567.002"
    file_types: [all]
    condition:
      type: string
      regex: "\\d{8,10}:[A-Za-z0-9_-]{35}"

composite_rules:
  - id: exfil/telegram/bot-exfil
    description: Telegram bot exfiltration
    criticality: suspicious
    confidence: 0.9
    attack: "T1567.002"
    mbc: "B0030"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule telegram_exfil {
          strings:
            $api = "api.telegram.org"
            $api_b64 = "YXBpLnRlbGVncmFtLm9yZw=="
            $send_msg = "/sendMessage"
            $send_doc = "/sendDocument"
            $send_loc = "/sendLocation"
            $send_photo = "/sendPhoto"
            $form_data = "Content-Disposition: form-data"
            $bot_token = /\d{8,10}:[A-Za-z0-9_-]{35}/
          condition:
            filesize < 50MB and
            ($api or $api_b64) and
            (2 of ($send*) or $bot_token)
        }
