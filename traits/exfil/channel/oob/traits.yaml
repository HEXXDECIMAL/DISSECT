# Exfiltration - Out-of-Band (OOB) Data Exfiltration
# ATT&CK: T1048 (Exfiltration Over Alternative Protocol)

traits:
  - id: exfil/oob/interactsh
    description: Exfiltrates data to Interactsh OOB domain
    criticality: suspicious
    confidence: 0.95
    attack: "T1048"
    file_types: [all]
    condition:
      type: string
      regex: "[a-z0-9]{8,32}\\.(interactsh|burpcollaborator\\.net|oastify\\.com|oast\\.fun|m\\.pipedream\\.net)"

  - id: exfil/oob/ngrok
    description: Communication with Ngrok (common C2 tunnel)
    criticality: suspicious
    confidence: 0.95
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: "[a-z0-9-]+\\.(tcp|http|https)\\.(eu|us|asia|au|sa|jp|in)\\.ngrok\\.io"

  - id: exfil/oob/bytedance-dast
    description: Exfiltrates data to Bytedance DAST testing domain
    criticality: suspicious
    confidence: 0.95
    attack: "T1048"
    file_types: [all]
    condition:
      type: string
      regex: "[a-z0-9-]+\\.byted-dast\\.com"

  - id: exfil/oob/workers-dev
    description: Communication with Cloudflare Workers (common C2 vector)
    criticality: notable
    confidence: 0.7
    attack: "T1071"
    file_types: [all]
    condition:
      type: string
      regex: "[a-z0-9-]+\\.workers\\.dev"

  - id: exfil/oob/requestbin
    description: Exfiltrates data to RequestBin OOB endpoint
    criticality: suspicious
    confidence: 0.9
    attack: "T1048"
    file_types: [all]
    condition:
      type: string
      regex: "requestbin\\.(com|net)"

  - id: exfil/oob/webhook-site
    description: Exfiltrates data to Webhook.site OOB endpoint
    criticality: suspicious
    confidence: 0.9
    attack: "T1048"
    file_types: [all]
    condition:
      type: string
      exact: "webhook.site"

  - id: exfil/oob/dnslog-cn
    description: Exfiltrates data to DNSLog.cn OOB domain
    criticality: suspicious
    confidence: 0.95
    attack: "T1048"
    file_types: [all]
    condition:
      type: string
      exact: "dnslog.cn"

  - id: exfil/oob/canarytokens
    description: Accesses Canarytokens OOB domain (potential probe)
    criticality: suspicious
    confidence: 0.9
    attack: "T1048"
    file_types: [all]
    condition:
      type: string
      exact: "canarytokens.com"

  - id: exfil/oob/oastify-b64
    description: Exfiltrates data to base64-encoded Oastify OOB domain
    criticality: hostile
    confidence: 0.9
    file_types: [python, javascript]
    condition:
      type: string
      exact: "b2FzdGlmeS5jb20"

  - id: exfil/oob/oast-fun-b64
    description: Exfiltrates data to base64-encoded OAST.fun OOB domain
    criticality: hostile
    confidence: 0.9
    file_types: [python, javascript]
    condition:
      type: string
      exact: "b2FzdC5mdW4"

  # Discord webhook exfiltration
  - id: exfil/oob/discord-webhook
    description: Discord webhook exfiltration endpoint
    criticality: suspicious
    confidence: 0.9
    attack: "T1567.004"
    file_types: [javascript, typescript, python]
    condition:
      type: string
      regex: "discord\\.com/api/webhooks/[0-9]+/[A-Za-z0-9_-]+"

  # Telegram bot exfiltration
  - id: exfil/oob/telegram-bot
    description: Telegram bot API exfiltration
    criticality: suspicious
    confidence: 0.9
    attack: "T1567"
    file_types: [javascript, typescript, python]
    condition:
      type: string
      regex: "api\\.telegram\\.org/bot[0-9]+:[A-Za-z0-9_-]+"

  # Slack webhook exfiltration
  - id: exfil/oob/slack-webhook
    description: Slack webhook exfiltration endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1567"
    file_types: [javascript, typescript, python]
    condition:
      type: string
      regex: "hooks\\.slack\\.com/services/T[A-Z0-9]+/B[A-Z0-9]+/[A-Za-z0-9]+"

  # Ngrok free tunnel detection
  - id: exfil/oob/ngrok-free
    description: Ngrok free tunnel endpoint
    criticality: suspicious
    confidence: 0.9
    attack: "T1572"
    file_types: [all]
    condition:
      type: string
      regex: "[a-z0-9-]+\\.ngrok-free\\.app"

composite_rules:
  - id: exfil/oob/multiple-encoded-indicators
    description: "Multiple base64-encoded indicators detected (potential evasion)"
    criticality: hostile
    confidence: 0.9
    requires_count: 2
    conditions:
      - type: string
        exact: "aHR0cDovL" # http://
      - type: string
        exact: "aHR0cHM6Ly" # https://
      - type: trait
        id: exfil/oob/oastify-b64
      - type: trait
        id: exfil/oob/oast-fun-b64
      - type: trait
        id: exfil/oob/interactsh

  - id: exfil/oob/preinstall-exfil
    description: OOB exfiltration from npm preinstall
    criticality: suspicious
    confidence: 0.99
    attack: "T1048"
    mbc: "B0030"
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule oob_preinstall_exfil {
          strings:
            $preinstall = /\s{2,8}\"preinstall\": \".{12,256}/
            $oob1 = /[a-z0-9]{8,32}\.burpcollaborator\.net/
            $oob2 = /[a-z0-9]{8,32}\.oastify\.com/
            $oob3 = /[a-z0-9]{8,32}\.oast\.fun/
            $oob4 = /[a-z0-9]{8,32}\.interactsh\.com/
            $oob5 = /[a-z0-9]{8,32}\.m\.pipedream\.net/
          condition:
            filesize < 5KB and $preinstall and any of ($oob*)
        }

  - id: exfil/oob/crypto-exfil
    description: Encrypted OOB exfiltration
    criticality: suspicious
    confidence: 0.95
    attack: "T1048"
    mbc: "B0030"
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule oob_crypto_exfil {
          strings:
            $crypto = /require\(['"]crypto['"]\)/
            $oob1 = /[a-z0-9]{8,32}\.burpcollaborator\.net/
            $oob2 = /[a-z0-9]{8,32}\.oastify\.com/
            $oob3 = /[a-z0-9]{8,32}\.oast\.fun/
            $oob4 = /[a-z0-9]{8,32}\.interactsh\.com/
          condition:
            filesize < 24KB and $crypto and any of ($oob*)
        }
