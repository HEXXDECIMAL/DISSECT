# Exfiltration - OAuth Token Theft
# ATT&CK: T1528 (Steal Application Access Token)

traits:
  - id: google-token-endpoint
    desc: Google OAuth2 token endpoint
    crit: notable
    conf: 0.8
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "googleapis.com/oauth2/v4/token"

  - id: google-auth-endpoint
    desc: Google OAuth2 auth endpoint
    crit: notable
    conf: 0.8
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "accounts.google.com/o/oauth2/auth"

  - id: google-userinfo
    desc: Google OAuth2 userinfo endpoint
    crit: suspicious
    conf: 0.85
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "googleapis.com/oauth2/v1/userinfo"

  - id: gmail-client-id
    desc: Gmail client ID variable
    crit: suspicious
    conf: 0.9
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "GMAIL_CLIENT_ID"

  - id: microsoft-graph
    desc: Microsoft Graph API endpoint
    crit: notable
    conf: 0.8
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "graph.microsoft.com/v1.0/me"

  - id: microsoft-auth
    desc: Microsoft OAuth2 auth endpoint
    crit: notable
    conf: 0.8
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "login.microsoftonline.com/common/oauth2/v2.0/authorize"

  - id: o365-client-id
    desc: Office 365 client ID variable
    crit: suspicious
    conf: 0.9
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "O365_CLIENT_ID"

  - id: code-verifier
    desc: OAuth PKCE code verifier
    crit: notable
    conf: 0.7
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "code_verifier"

  - id: code-challenge
    desc: OAuth PKCE code challenge
    crit: notable
    conf: 0.7
    attack: "T1528"
    for: [all]
    if:
      type: string
      exact: "code_challenge"

  - id: json-content-type
    desc: JSON content type header
    crit: info
    conf: 0.5
    for: [all]
    if:
      type: string
      exact: "application/json"

  - id: http-post-method
    desc: HTTP POST method
    crit: info
    conf: 0.5
    for: [all]
    if:
      type: string
      exact: "POST"

  - id: recon-computername
    desc: COMPUTERNAME environment variable
    crit: notable
    conf: 0.7
    attack: "T1082"
    for: [all]
    if:
      type: string
      exact: "COMPUTERNAME"

  - id: recon-userdomain
    desc: USERDOMAIN environment variable
    crit: notable
    conf: 0.7
    attack: "T1082"
    for: [all]
    if:
      type: string
      exact: "USERDOMAIN"

  - id: recon-ipinfo
    desc: ipinfo.io IP lookup service
    crit: notable
    conf: 0.7
    attack: "T1016"
    for: [all]
    if:
      type: string
      exact: "ipinfo.io"

composite_rules:
  - id: stealer-detected
    desc: OAuth credential stealer
    crit: suspicious
    conf: 0.9
    attack: "T1528"
    mbc: "B0028"
    for: [all]
    all:
      - id: json-content-type
      - id: http-post-method
    any:
      - id: recon-computername
      - id: recon-userdomain
      - id: recon-ipinfo
      - id: google-token-endpoint
      - id: google-auth-endpoint
      - id: google-userinfo
      - id: gmail-client-id
      - id: microsoft-graph
      - id: microsoft-auth
      - id: o365-client-id
