# Exfiltration - OAuth Token Theft
# ATT&CK: T1528 (Steal Application Access Token)

traits:
  - id: google-token-endpoint
    description: Google OAuth2 token endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "googleapis.com/oauth2/v4/token"

  - id: google-auth-endpoint
    description: Google OAuth2 auth endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "accounts.google.com/o/oauth2/auth"

  - id: google-userinfo
    description: Google OAuth2 userinfo endpoint
    criticality: suspicious
    confidence: 0.85
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "googleapis.com/oauth2/v1/userinfo"

  - id: gmail-client-id
    description: Gmail client ID variable
    criticality: suspicious
    confidence: 0.9
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "GMAIL_CLIENT_ID"

  - id: microsoft-graph
    description: Microsoft Graph API endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "graph.microsoft.com/v1.0/me"

  - id: microsoft-auth
    description: Microsoft OAuth2 auth endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "login.microsoftonline.com/common/oauth2/v2.0/authorize"

  - id: o365-client-id
    description: Office 365 client ID variable
    criticality: suspicious
    confidence: 0.9
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "O365_CLIENT_ID"

  - id: code-verifier
    description: OAuth PKCE code verifier
    criticality: notable
    confidence: 0.7
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "code_verifier"

  - id: code-challenge
    description: OAuth PKCE code challenge
    criticality: notable
    confidence: 0.7
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "code_challenge"

composite_rules:
  - id: stealer-detected
    description: OAuth credential stealer
    criticality: suspicious
    confidence: 0.9
    attack: "T1528"
    mbc: "B0028"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule oauth_stealer {
          strings:
            $json = "application/json"
            $post = "POST"
            $o_google1 = "googleapis.com/oauth2/v4/token"
            $o_google2 = "accounts.google.com/o/oauth2/auth"
            $o_google3 = "googleapis.com/oauth2/v1/userinfo"
            $o_google4 = "GMAIL_CLIENT_ID"
            $o_microsoft1 = "graph.microsoft.com/v1.0/me"
            $o_microsoft2 = "login.microsoftonline.com/common/oauth2/v2.0/authorize"
            $o_microsoft3 = "O365_CLIENT_ID"
            $recon1 = "COMPUTERNAME"
            $recon2 = "USERDOMAIN"
            $recon3 = "ipinfo.io"
          condition:
            filesize < 10MB and
            $json and $post and
            5 of ($o*) and any of ($recon*)
        }
