# Exfiltration - OAuth Token Theft
# ATT&CK: T1528 (Steal Application Access Token)

traits:
  - id: google-token-endpoint
    description: Google OAuth2 token endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "googleapis.com/oauth2/v4/token"

  - id: google-auth-endpoint
    description: Google OAuth2 auth endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "accounts.google.com/o/oauth2/auth"

  - id: google-userinfo
    description: Google OAuth2 userinfo endpoint
    criticality: suspicious
    confidence: 0.85
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "googleapis.com/oauth2/v1/userinfo"

  - id: gmail-client-id
    description: Gmail client ID variable
    criticality: suspicious
    confidence: 0.9
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "GMAIL_CLIENT_ID"

  - id: microsoft-graph
    description: Microsoft Graph API endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "graph.microsoft.com/v1.0/me"

  - id: microsoft-auth
    description: Microsoft OAuth2 auth endpoint
    criticality: notable
    confidence: 0.8
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "login.microsoftonline.com/common/oauth2/v2.0/authorize"

  - id: o365-client-id
    description: Office 365 client ID variable
    criticality: suspicious
    confidence: 0.9
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "O365_CLIENT_ID"

  - id: code-verifier
    description: OAuth PKCE code verifier
    criticality: notable
    confidence: 0.7
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "code_verifier"

  - id: code-challenge
    description: OAuth PKCE code challenge
    criticality: notable
    confidence: 0.7
    attack: "T1528"
    file_types: [all]
    condition:
      type: string
      exact: "code_challenge"

  - id: json-content-type
    description: JSON content type header
    criticality: info
    confidence: 0.5
    file_types: [all]
    condition:
      type: string
      exact: "application/json"

  - id: http-post-method
    description: HTTP POST method
    criticality: info
    confidence: 0.5
    file_types: [all]
    condition:
      type: string
      exact: "POST"

  - id: recon-computername
    description: COMPUTERNAME environment variable
    criticality: notable
    confidence: 0.7
    attack: "T1082"
    file_types: [all]
    condition:
      type: string
      exact: "COMPUTERNAME"

  - id: recon-userdomain
    description: USERDOMAIN environment variable
    criticality: notable
    confidence: 0.7
    attack: "T1082"
    file_types: [all]
    condition:
      type: string
      exact: "USERDOMAIN"

  - id: recon-ipinfo
    description: ipinfo.io IP lookup service
    criticality: notable
    confidence: 0.7
    attack: "T1016"
    file_types: [all]
    condition:
      type: string
      exact: "ipinfo.io"

composite_rules:
  - id: stealer-detected
    description: OAuth credential stealer
    criticality: suspicious
    confidence: 0.9
    attack: "T1528"
    mbc: "B0028"
    file_types: [all]
    requires_all:
      - id: json-content-type
      - id: http-post-method
    requires_any:
      - id: recon-computername
      - id: recon-userdomain
      - id: recon-ipinfo
      - id: google-token-endpoint
      - id: google-auth-endpoint
      - id: google-userinfo
      - id: gmail-client-id
      - id: microsoft-graph
      - id: microsoft-auth
      - id: o365-client-id
