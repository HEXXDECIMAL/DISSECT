# Exfiltration - Discord Webhook
# ATT&CK: T1567.002 (Exfiltration Over Web Service)

traits:
  - id: webhook-endpoint
    desc: Discord webhook API endpoint
    crit: suspicious
    conf: 0.9
    attack: "T1567.002"
    for: [all]
    if:
      type: string
      regex: "discord\\.com/api/webhooks/\\d+"

  - id: webhook-endpoint-legacy
    desc: Discord webhook API endpoint (legacy)
    crit: suspicious
    conf: 0.9
    attack: "T1567.002"
    for: [all]
    if:
      type: string
      regex: "discordapp\\.com/api/webhooks/\\d+"

  - id: lib-js
    desc: Discord.js library usage
    crit: notable
    conf: 0.7
    attack: "T1567.002"
    for: [javascript]
    if:
      type: string
      exact: "discord.js"

  - id: lib-go
    desc: DiscordGo library usage
    crit: notable
    conf: 0.7
    attack: "T1567.002"
    for: [elf]
    if:
      type: string
      exact: "discordgo"

  - id: lib-python
    desc: Discord Python library usage
    crit: notable
    conf: 0.7
    attack: "T1567.002"
    for: [python]
    if:
      type: string
      exact: "import discord"

  - id: lib-disnake
    desc: Disnake Python library usage
    crit: notable
    conf: 0.7
    attack: "T1567.002"
    for: [python]
    if:
      type: string
      exact: "import disnake"

  - id: ip-lookup-ipify
    desc: "ipify.org IP lookup service"
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: string
      exact: "ipify.org"

  - id: ip-lookup-ipinfo
    desc: "ipinfo.io IP lookup service"
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: string
      exact: "ipinfo.io"

  - id: ip-lookup-ifconfig
    desc: "ifconfig.me IP lookup service"
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: string
      exact: "ifconfig.me"

  - id: ip-lookup-icanhazip
    desc: "icanhazip IP lookup service"
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: string
      exact: "icanhazip"

  - id: ip-lookup-wtfismyip
    desc: "wtfismyip IP lookup service"
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: string
      exact: "wtfismyip"

composite_rules:
  - id: webhook-exfil
    desc: Discord webhook exfiltration
    crit: suspicious
    conf: 0.9
    attack: "T1567.002"
    mbc: "B0030"
    for: [all]
    all:
      - id: webhook-endpoint
    any:
      - id: ip-lookup-ipify
      - id: ip-lookup-ipinfo
      - id: ip-lookup-ifconfig
      - id: ip-lookup-icanhazip
      - id: ip-lookup-wtfismyip
