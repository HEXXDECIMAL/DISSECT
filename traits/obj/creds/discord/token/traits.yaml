# Credential Access - Discord Token Theft
# Stealing Discord authentication tokens from local storage
# ATT&CK: T1555.003 (Credentials from Web Browsers)

defaults:
  attack: "T1555.003"

traits:
  # Discord token regex pattern (standard)
  - id: regex-standard
    desc: Discord token regex pattern
    crit: suspicious
    conf: 0.95
    if:
      type: string
      # Matches: [A-Za-z0-9_-]{24}.[A-Za-z0-9_-]{6}.[A-Za-z0-9_-]{27}
      regex: '[A-Za-z0-9_-]{24}\\.[A-Za-z0-9_-]{6}\\.[A-Za-z0-9_-]{27}'

  # Discord MFA token pattern
  - id: regex-mfa
    desc: Discord MFA token regex pattern
    crit: suspicious
    conf: 0.95
    if:
      type: string
      # Matches: mfa.[A-Za-z0-9_-]{84}
      regex: 'mfa\\.[A-Za-z0-9_-]{84}'

  # Discord token literal pattern (actual token format)
  - id: literal-pattern
    desc: Discord token in code
    crit: suspicious
    conf: 0.9
    if:
      type: string
      # Actual token format: MTIzNDU2Nzg5.Gh1234.abcdef...
      regex: "[MN][A-Za-z0-9]{23,}\\.[A-Za-z0-9_-]{6}\\.[A-Za-z0-9_-]{27}"

  # Discord Local Storage path
  - id: localstorage-path
    desc: Discord Local Storage directory access
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "(?i)(discord|discordcanary|discordptb)[/\\\\]+(Local Storage|leveldb)"

  # Discord API user endpoint (token validation)
  - id: api-users-me
    desc: Discord API user validation endpoint
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me"

  # Discord billing endpoint (payment theft)
  - id: api-billing
    desc: Discord billing/payment API endpoint
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me/billing"

  # Discord payment sources endpoint
  - id: api-payment-sources
    desc: Discord payment sources API endpoint
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: "payment-sources"

  # Discord relationships endpoint (friends list)
  - id: api-relationships
    desc: Discord relationships API endpoint
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "users/@me/relationships"

  # Discord channels endpoint (DM access)
  - id: api-channels
    desc: Discord channels API endpoint
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "users/@me/channels"

  # LevelDB storage reference
  - id: leveldb-ref
    desc: LevelDB storage reference
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "leveldb"

  # Local Storage reference
  - id: local-storage-ref
    desc: Local Storage directory reference
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "Local Storage"

  # Discord application path
  - id: discord-path
    desc: Discord application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "Discord"

  # Discord Canary path
  - id: discord-canary-path
    desc: Discord Canary application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)discordcanary"

  # Discord PTB path
  - id: discord-ptb-path
    desc: Discord PTB application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)discordptb"

  # MFA token prefix
  - id: mfa-prefix
    desc: MFA token prefix indicator
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "mfa."

  # MFA token type enum - used in token stealers to differentiate token types
  - id: mfa-token-type
    desc: MFA token type enumeration
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: raw
      regex: "(?i)(MFA\\s*[=:]\\s*[0-9]|TokenType\\.MFA|type:\\s*MFA)"

  # Users/@me API path
  - id: users-me-path
    desc: Discord users/@me API path
    crit: notable
    conf: 0.75
    if:
      type: string
      substr: "users/@me"

  # Discord webhook exfil
  - id: webhook-exfil
    desc: Discord webhook exfiltration endpoint
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "discord(app)?\\.com/api/webhooks/"

  # Telegram API exfil
  - id: telegram-exfil
    desc: Telegram API exfiltration endpoint
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "api.telegram.org"

  # Chrome browser profile path for token theft
  - id: chrome-browser
    desc: Chrome browser profile path
    crit: notable
    conf: 0.6
    if:
      type: string
      # Match Chrome profile data paths, not just "Chrome" string (too generic for graphics libs)
      regex: "(?i)Google[/\\\\]Chrome[/\\\\]User Data|Chrome[/\\\\](?:Default|Profile)[/\\\\]|/\\.config/google-chrome/"

  # Opera browser path - require profile data path context
  - id: opera-browser
    desc: Opera browser profile path
    crit: notable
    conf: 0.6
    if:
      type: string
      # Match Opera profile paths with directory separators, not just "Opera" (too generic)
      # Require Opera followed by path separator and profile dir, or explicit Opera GX/Software paths
      regex: "(?i)Opera[/\\\\](?:Stable|Profile|Software|GX Stable)|(?:AppData|Application Support)[/\\\\](?:Local[/\\\\]|Roaming[/\\\\])?Opera[/\\\\]"

  # Brave browser path - require profile data path context
  - id: brave-browser
    desc: Brave browser profile path
    crit: notable
    conf: 0.6
    if:
      type: string
      # Match Brave profile paths, not just "Brave" (too generic)
      regex: "(?i)Brave[/\\\\](?:Software|User Data|Profile)|BraveSoftware[/\\\\]"

  # Edge browser path - require profile data path context
  - id: edge-browser
    desc: Edge browser profile path
    crit: notable
    conf: 0.6
    if:
      type: string
      # Match Edge profile paths, not just "Edge" (too generic - common in graphics for edge detection)
      regex: "(?i)Microsoft[/\\\\]Edge[/\\\\]User Data|Edge[/\\\\](?:Default|Profile)[/\\\\]"

  # LDB file extension
  - id: ldb-extension
    desc: LevelDB file extension
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: ".ldb"

  # Removed: log-extension was too generic (.log matches any log file)
  # LevelDB log files are detected via leveldb-ref and localstorage-path patterns

  # Token keyword moved to data/text/generic.yaml

  # AppData reference for Windows credential theft
  - id: appdata-ref
    desc: Windows AppData directory reference
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "AppData"

  # extractTokens function - common in token stealers
  - id: extract-tokens-fn
    desc: Token extraction function
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: "extractTokens?\\("

  # getTokens function - common in token stealers
  - id: get-tokens-fn
    desc: Token getter function
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "getTokens?\\("

  # Discord domain filtering regex in code - targets Discord storage
  - id: discord-domain-filter
    desc: Discord domain filtering regex
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: 'discord\(\?:app\)\?'

  # Firefox webappsstore.sqlite - used to steal Discord tokens from Firefox
  - id: firefox-webappsstore
    desc: Firefox webappsstore.sqlite database
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "webappsstore.sqlite"

  # Firefox ls-archive.sqlite - local storage archive
  - id: firefox-ls-archive
    desc: Firefox ls-archive.sqlite database
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "ls-archive.sqlite"

  # Firefox storage/default path - Discord token location
  - id: firefox-storage-default
    desc: Firefox storage/default path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "storage/default"

  # Firefox ls/data.sqlite - Discord local storage
  - id: firefox-ls-data
    desc: Firefox ls/data.sqlite database
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "ls/data.sqlite"

composite_rules:
  # Discord token stealer composite
  - id: stealer-detected
    desc: Discord token stealer detected
    crit: suspicious
    conf: 0.98
    attack: "T1555.003"
    mbc: "B0030"
    for: [javascript, typescript, python, elf, pe, macho]
    needs: 2
    any:
      - id: leveldb-ref
      - id: discord-path
      - id: regex-standard
      - id: webhook-exfil

  # Discord token grabber with browser enumeration
  - id: browser-grabber
    desc: Discord token grabber targeting multiple
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0030"
    for: [javascript, typescript, python, elf, pe, macho]
    all:
      - id: discord-path
      - id: cap/data/text/keywords::token

  # LevelDB token harvester - targets browser local storage for tokens
  # Complexity: file_types:+1, all:+4 = 5 (hostile allowed)
  - id: leveldb-harvester
    desc: LevelDB credential harvester
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0030"
    for: [javascript, typescript]
    all:
      - id: leveldb-ref
      - id: local-storage-ref
      - id: appdata-ref
      - id: obj/discovery/host/system/hardware-fingerprint::os-homedir-call

  # Firefox storage databases used for Discord token theft
  - id: firefox-storage-access
    desc: Firefox browser storage database access
    crit: notable
    conf: 0.9
    for: [javascript, typescript, python]
    any:
      - id: firefox-webappsstore
      - id: firefox-ls-archive
      - id: firefox-ls-data

  # Firefox-based Discord token stealer
  # Complexity: file_types:+1, all:+3, any:+1 = 5 (hostile allowed)
  - id: firefox-token-stealer
    desc: Firefox Discord token stealer
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0030"
    for: [javascript, typescript]
    all:
      - id: firefox-storage-access
      - id: appdata-ref
      - id: obj/discovery/host/system/hardware-fingerprint::os-homedir-call
    any:
      - id: extract-tokens-fn
      - id: get-tokens-fn
      - id: discord-domain-filter
