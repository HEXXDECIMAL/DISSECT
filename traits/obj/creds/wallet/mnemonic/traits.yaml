# Cryptocurrency Wallet Mnemonic/Seed Phrase Theft Detection
# Detects code targeting BIP-39 mnemonic recovery phrases
# ATT&CK: T1555 (Credentials from Password Stores)
# MBC: B0028 (Credential Theft)

defaults:
  attack: "T1555"
  mbc: "B0028"
  crit: suspicious

traits:
  # BIP-39 word count patterns (12, 15, 18, 21, 24 words)
  - id: word-count-check
    desc: "Mnemonic word count validation (12/15/18/21/24)"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      regex: "split\\([^)]*\\)\\s*\\.\\s*length\\s*[=!<>]+\\s*(12|15|18|21|24)|len\\([^)]*split[^)]*\\)\\s*[=!<>]+\\s*(12|15|18|21|24)|words?_?count\\s*[=!<>]+\\s*(12|15|18|21|24)"

  # Common mnemonic-related variable/function names
  - id: variable-names
    desc: "Mnemonic-related variable or function names"
    conf: 0.8
    if:
      type: string
      regex: "\\b(mnemonic|seed_phrase|seedphrase|recovery_phrase|recoveryPhrase|secret_words|secretWords|wallet_words|walletWords)\\s*[=:]"

  # BIP-39 wordlist references
  - id: bip39-wordlist
    desc: "BIP-39 wordlist reference"
    conf: 0.85
    if:
      type: string
      regex: "bip39|bip-39|wordlist|word_list|english\\.txt.{0,30}mnemonic|mnemonic.{0,30}english\\.txt"

  # Mnemonic validation patterns
  - id: validation-pattern
    desc: "Mnemonic phrase validation logic"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      regex: "validate.{0,20}mnemonic|mnemonic.{0,20}valid|check.{0,20}seed.{0,20}phrase|verify.{0,20}recovery"

  # Private key extraction in wallet context (not general crypto)
  - id: private-key-hex
    desc: "Wallet private key extraction"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      # Require wallet/crypto context, not just "private_key" which is used by SSH/TLS
      # Use {0,50} to limit gap between keywords, avoiding matches across concatenated strings
      regex: "(wallet|eth|btc|crypto|metamask|phantom).{0,50}private_?key|export.{0,30}(wallet|crypto|eth|btc).{0,30}key"

  # Bitcoin WIF private key format detection
  - id: bitcoin-wif
    desc: "Bitcoin WIF private key format"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      # Require wallet/bitcoin context - "wif" alone matches wireless interface
      regex: "wallet_import_format|WIF.{0,20}key|WIF.{0,20}private|bitcoin.{0,20}wif|wif.{0,20}bitcoin|decode.{0,20}wif|encode.{0,20}wif|to_?wif|from_?wif"

  # HD wallet derivation path patterns
  - id: derivation-path
    desc: "HD wallet derivation path (BIP-44/49/84)"
    conf: 0.8
    if:
      type: string
      regex: "m/44'/|m/49'/|m/84'/|m/86'/|derivation_?path|derivationPath"

  # Keystore/JSON wallet file patterns
  - id: keystore-file
    desc: "Ethereum keystore file reference"
    conf: 0.8
    if:
      type: string
      # Ethereum-specific patterns, avoid matching OS "keystore" services
      regex: "UTC--.{0,50}--[a-fA-F0-9]{40}|ethereum.{0,30}keystore|keystore.{0,30}ethereum|web3.{0,30}keystore|\\.json.{0,30}wallet"

  # === Mnemonic/seed phrase term atomic indicators ===
  - id: mnemonic-word
    desc: mnemonic term
    crit: inert
    conf: 0.5
    # Restrict to high-level languages where wallet code typically appears
    # Exclude assembly scripts and system-level code where "mnemonic" refers to processor instructions
    for: [python, javascript, csharp, java, go]
    if:
      type: string
      substr: "mnemonic"

  - id: seed-phrase-underscore
    desc: seed_phrase term
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "seed_phrase"

  - id: seedphrase-word
    desc: seedphrase term
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "seedphrase"

  - id: recovery-phrase-word
    desc: recovery_phrase term
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "recovery_phrase"

  - id: secret-words-word
    desc: secret_words term
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "secret_words"

  # === Wallet/crypto context atomic indicators ===
  - id: wallet-word
    desc: wallet term
    crit: inert
    conf: 0.5
    # Restrict to high-level languages where wallet code appears, exclude system libraries
    for: [python, javascript, csharp, java, go, ruby, php]
    if:
      type: string
      word: "wallet"

  - id: crypto-word
    desc: crypto term
    crit: inert
    conf: 0.5
    # Restrict to languages where wallet code appears, exclude system headers (C/C++)
    for: [python, javascript, csharp, java, go, ruby, php]
    if:
      type: string
      word: "crypto"

  - id: metamask-word
    desc: MetaMask reference
    crit: inert
    conf: 0.5
    if:
      type: string
      word: "metamask"

  - id: phantom-word
    desc: Phantom wallet reference
    crit: inert
    conf: 0.5
    if:
      type: string
      word: "phantom"

  - id: browser-word
    desc: browser wallet context
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "\\bbrowser[_-]?(wallet|extension|addon)\\b"

composite_rules:
  # Mnemonic terms composite
  - id: mnemonic-terms
    desc: Mnemonic or seed phrase terminology
    crit: notable
    conf: 0.7
    needs: 2
    any:
      - id: mnemonic-word
      - id: seed-phrase-underscore
      - id: seedphrase-word
      - id: recovery-phrase-word
      - id: secret-words-word

  # Wallet context composite
  - id: wallet-context
    desc: Wallet or cryptocurrency context
    crit: notable
    conf: 0.7
    needs: 2
    any:
      - id: wallet-word
      - id: crypto-word
      - id: metamask-word
      - id: phantom-word
      - id: browser-word

  # Private key variable composite
  - id: private-key-var
    desc: Private key variable or property
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: private-key-underscore
      - id: privatekey-nospace
      - id: privatekey-camel

  # Keystore reference composite
  - id: keystore-ref
    desc: Keystore reference
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: keystore-singular
      - id: keystores-plural

  # Derivation path composite
  - id: derivation-pattern
    desc: Wallet derivation path pattern
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: derivation-path-words
      - id: bip44-path-prefix

  # BIP-39 reference composite
  - id: bip39-ref
    desc: BIP-39 or wordlist reference
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: bip39-exact
      - id: bip-39-hyphen
      - id: wordlist-word

  # Mnemonic extraction with file/network operations
  - id: stealer-pattern
    desc: "Mnemonic phrase theft (extraction +"
    crit: hostile
    conf: 0.95
    attack: "T1555"
    mbc: "B0028"
    for: [python, javascript]
    all:
      - id: mnemonic-terms
      - id: cap/comm/http/request/http-client
      - id: wallet-context

  # Multiple wallet-related patterns = wallet stealer
  - id: comprehensive-stealer
    desc: "Comprehensive wallet credential theft"
    crit: hostile
    conf: 0.95
    attack: "T1555"
    mbc: "B0028"
    for: [python, javascript, elf, pe, macho]
    needs: 3
    any:
      - id: mnemonic-terms
      - id: private-key-var
      - id: keystore-ref
      - id: derivation-pattern
      - id: bip39-ref
