# Keychain Credential Access (macOS)
# MBC: E1555 (Credentials from Password Stores)
# ATT&CK: T1555.001

traits:
  # === Atomic: Security Framework Symbols ===

  - id: find-generic
    desc: Read passwords from macOS Keychain
    crit: suspicious
    conf: 0.9
    mbc: "E1555.001"
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      regex: "SecKeychainFindGenericPassword"

  - id: find-internet
    desc: Read internet passwords from macOS
    crit: suspicious
    conf: 0.9
    mbc: "E1555.001"
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      regex: "SecKeychainFindInternetPassword"

  - id: item-copy-content
    desc: Copy Keychain item contents (SecKeychainItemCopyContent)
    crit: suspicious
    conf: 0.95
    mbc: "E1555.001"
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      regex: "SecKeychainItemCopyContent"

  - id: open
    desc: Open Keychain database (SecKeychainOpen)
    crit: suspicious
    conf: 0.8
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      regex: "SecKeychainOpen"

  - id: copy-default
    desc: Copy default Keychain reference (SecKeychainCopyDefault)
    crit: notable
    conf: 0.7
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      regex: "SecKeychainCopyDefault"

  - id: sec-item-copy
    desc: Copy keychain item attributes (SecItemCopyMatching)
    crit: suspicious
    conf: 0.85
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      regex: "SecItemCopy"

  # === Atomic: Command Line Tools ===

  # === security CLI atomic indicators ===
  - id: security-find
    desc: security find- commands
    crit: inert
    conf: 0.6
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+find-"

  - id: security-dump
    desc: security dump- commands
    crit: inert
    conf: 0.7
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+dump-"

  - id: security-delete
    desc: security delete- commands
    crit: inert
    conf: 0.6
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+delete-"

  - id: security-add
    desc: security add- commands
    crit: inert
    conf: 0.5
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+add-"

  - id: security-export
    desc: security export command
    crit: inert
    conf: 0.6
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+export"

  - id: security-import
    desc: security import command
    crit: inert
    conf: 0.5
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+import"

  - id: security-unlock
    desc: security unlock command
    crit: inert
    conf: 0.6
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      regex: "\\bsecurity\\s+unlock"

  - id: find-generic-password-cli
    desc: security find-generic-password command
    crit: suspicious
    conf: 0.85
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      exact: "find-generic-password"

  - id: dump-keychain-cli
    desc: security dump-keychain command
    crit: suspicious
    conf: 0.9
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    if:
      type: string
      exact: "dump-keychain"

  # === Atomic: Keychain File Paths ===

  - id: login-path
    desc: User login keychain path
    crit: notable
    conf: 0.7
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, shell, perl, python, ruby]
    if:
      type: string
      exact: "login.keychain"

  - id: system-path
    desc: System keychain path
    crit: notable
    conf: 0.7
    attack: "T1555.001"
    platforms: [macos]
    for: [macho, shell, perl, python, ruby]
    if:
      type: string
      exact: "/Library/Keychains/System.keychain"

composite_rules:
  # security CLI composite
  - id: security-cli
    desc: macOS security command line tool
    crit: suspicious
    conf: 0.75
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    count_min: 1
    any:
      - id: security-find
      - id: security-dump
      - id: security-delete
      - id: security-add
      - id: security-export
      - id: security-import
      - id: security-unlock

  - id: password-extraction
    desc: macOS Keychain password extraction
    crit: suspicious
    conf: 0.9
    attack: "T1555.001"
    mbc: "E1555.001"
    platforms: [macos]
    for: [macho, dylib]
    any:
      - id: find-generic
      - id: find-internet
    all:
      - id: item-copy-content

  - id: cli-dump
    desc: macOS Keychain dump via CLI
    crit: suspicious
    conf: 0.9
    attack: "T1555.001"
    platforms: [macos]
    for: [shell, macho]
    all:
      - id: security-cli
    any:
      - id: find-generic-password-cli
      - id: dump-keychain-cli
