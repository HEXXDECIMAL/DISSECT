# Credential Dumping - Unix
# MBC: E1003 (OS Credential Dumping)
# ATT&CK: T1003 (OS Credential Dumping)
#
# NOTE: Basic user lookup functions (getpwnam, getpwuid) are defined in
# obj/discovery/user/traits.yaml as they're legitimate user discovery.
# This file focuses on actual credential/shadow file access.

traits:
  # getpwnam/getpwuid removed - they're legitimate user lookup functions
  # used by countless system utilities. See obj/discovery/user/traits.yaml.

  - id: getspnam
    desc: Read shadow password file (getspnam)
    crit: notable
    conf: 0.8
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [linux, unix]
    for: [elf]
    if:
      type: symbol
      regex: "getspnam"

  # === Atomic: Direct File Access ===

  # NOTE: For ELF binaries, shadow file access is common in system utilities
  # Real credential dumping detection requires additional context
  # === shadow file atomic indicators ===
  - id: etc-shadow
    desc: /etc/shadow file
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      substr: "/etc/shadow"

  - id: etc-gshadow
    desc: /etc/gshadow file
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      substr: "/etc/gshadow"

  - id: etc-master-passwd
    desc: /etc/master.passwd file
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      substr: "/etc/master.passwd"

  # NOTE: /etc/passwd is defined in discovery/user/traits.yaml as etc-passwd

  # NOTE: System utilities like busybox legitimately access gshadow
  - id: gshadow-file
    desc: Group shadow file access (/etc/gshadow)
    crit: notable
    conf: 0.6
    attack: "T1003.008"
    platforms: [linux]
    for: [elf, macho, shell, perl, python, ruby]
    if:
      type: string
      substr: "/etc/gshadow"

  - id: master-passwd
    desc: BSD master.passwd file access
    crit: notable
    conf: 0.9
    attack: "T1003.008"
    platforms: [macos, unix]
    for: [elf, macho, shell, perl, python, ruby]
    if:
      type: string
      substr: "/etc/master.passwd"

composite_rules:
  # shadow file composite
  - id: shadow-file
    desc: Access to system shadow password
    crit: notable
    conf: 0.9
    attack: "T1003.008"
    needs: 1
    any:
      - id: etc-shadow
      - id: etc-gshadow
      - id: etc-master-passwd

  - id: shadow-extraction
    desc: Shadow file credential extraction
    crit: suspicious
    conf: 0.9
    attack: "T1003.008"
    mbc: "E1003.008"
    platforms: [linux, unix]
    for: [elf]
    all:
      - id: getspnam
      - id: shadow-file
