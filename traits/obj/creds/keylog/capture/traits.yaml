# Keylogging Detection
# MBC: B0015 (Keylogging)
# ATT&CK: T1056.001 (Input Capture: Keylogging)
#
# NOTE: Single keyboard API usage is suspicious but not hostile.
# These APIs are used legitimately by accessibility software, games,
# hotkey managers, and automation tools. Hostile classification
# requires multiple indicators (e.g., keyboard capture + exfiltration).

defaults:
  mbc: "B0015"
  attack: "T1056.001"
  crit: suspicious

traits:
  # === Atomic: Windows Keyboard Hooks ===
  - id: windows-hook
    desc: Windows keyboard hooking via SetWindowsHookEx
    conf: 0.7
    mbc: "B0015.001"
    platforms: [windows]
    for: [pe, dll]
    if:
      type: symbol
      pattern: "SetWindowsHookEx"

  - id: windows-rawinput
    desc: Windows raw input API for
    conf: 0.7
    platforms: [windows]
    for: [pe, dll]
    if:
      type: symbol
      pattern: "GetRawInputData"

  - id: windows-asynckey
    desc: Windows GetAsyncKeyState for key polling
    conf: 0.65
    platforms: [windows]
    for: [pe, dll]
    if:
      type: symbol
      pattern: "GetAsyncKeyState"

  # === Atomic: Linux Keyboard Input ===
  - id: linux-input-device
    desc: Direct access to Linux input
    conf: 0.75
    platforms: [linux]
    for: [elf, python, shell]
    if:
      type: string
      regex: "/dev/input/event[0-9]+"

  - id: x11-grab
    desc: X11 key grabbing for keylogging
    conf: 0.65
    platforms: [linux, unix]
    # NOTE: Exclude shared libraries (.so) as XGrabKey is a core X11 API
    # libX11.so and other X11 libraries legitimately export this function
    for: [elf]
    if:
      type: symbol
      pattern: "XGrabKey"
    # Skip if this looks like a system X11 library or utility
    unless:
      # Match X11 library filenames like libX11.so, libX11.so.6, libX11.so.19.0
      - type: basename
        regex: "^lib(X11|xcb|Xext|Xt|Xmu|Xi|Xrandr|Xrender|Xfixes|Xcomposite|Xdamage|Xinput|Xinerama|Xss|Xkb|Xaw|Xcursor|Xdmcp|Xpm|Xft|fontconfig|Xxf86dga|Xxf86vm|Xxf86misc)(\\.so|\\.dylib).*"
      # Match X11/XFree86 test utilities (dga, glxinfo, xdpyinfo, etc.)
      - type: basename
        regex: "^(dga|glxinfo|xdpyinfo|xwininfo|xev|xinput|xrandr|xset|xmodmap|xkbcomp|setxkbmap|xhost|xauth)$"
      # Match X11 version strings in the file
      - type: string
        regex: "X11R[0-9]|xenocara|xorg|X\\.Org"
      # Match if this exports many X11 functions (it's a library, not a consumer)
      - type: symbol
        regex: "^X(Query|Open|Close|Create|Destroy|Map|Unmap|Get|Set)(Display|Window|Keymap|Pointer|Event)"
      # Match X11 DGA extension markers (legitimate use of XGrabKey for tests/direct access)
      - type: string
        regex: "(?i)(?:XF86DGA|XDGAOpenFramebuffer|XDGACloseFramebuffer|libXxf86dga|XFree86-DGA)"
      # Match X11 DGA symbol imports (DGA video test utilities)
      - type: symbol
        regex: "^XDGA(OpenFramebuffer|CloseFramebuffer|QueryExtension|QueryVersion|SetMode|GetViewportStatus)"

  # === Atomic: macOS Keyboard Capture ===
  - id: macos-eventtap
    desc: macOS CGEventTap for key interception
    conf: 0.7
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      pattern: "CGEventTapCreate"

  # === Atomic: Language Libraries ===
  - id: go-gohook
    desc: Go robotn/gohook keyboard capture library
    conf: 0.75
    for: [elf, macho]
    if:
      type: string
      exact: "github.com/robotn/gohook"

  # === Python pynput atomic indicators ===
  - id: pynput-import-keyboard
    desc: from pynput import keyboard
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: "from pynput import keyboard"

  - id: pynput-keyboard-import
    desc: from pynput.keyboard import
    conf: 0.5
    for: [python]
    if:
      type: string
      regex: "from pynput\\.keyboard"

  # === JS iohook atomic indicators ===
  - id: require-iohook
    desc: require("iohook")
    conf: 0.6
    for: [javascript]
    if:
      type: string
      regex: "require\\(['\"]iohook['\"]\\)"

  - id: import-iohook
    desc: from "iohook" import
    conf: 0.6
    for: [javascript]
    if:
      type: string
      regex: 'from [''"]iohook[''"]'

  # === Rust rdev atomic indicators ===
  - id: use-rdev
    desc: "use rdev:: import statement"
    conf: 0.5
    for: [rust]
    if:
      type: string
      regex: "use rdev::"

  - id: extern-crate-rdev
    desc: extern crate rdev
    conf: 0.5
    for: [rust]
    if:
      type: string
      exact: "extern crate rdev"

  # === AppleScript Keystroke Capture ===
  - id: osascript-lower
    desc: osascript command (lowercase)
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "osascript"

  - id: osascript-title
    desc: Osascript command (title case)
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Osascript"

  - id: osascript-upper
    desc: OSASCRIPT command (uppercase)
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "OSASCRIPT"

  - id: keystroke-lower
    desc: keystroke keyword (lowercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      word: "keystroke"

  - id: keystroke-title
    desc: Keystroke keyword (title case)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      word: "Keystroke"

  - id: keystroke-upper
    desc: KEYSTROKE keyword (uppercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      word: "KEYSTROKE"

  - id: key-code-lower
    desc: key code phrase (lowercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "key code"

  - id: key-code-title
    desc: Key Code phrase (title case)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "Key Code"

  - id: key-code-upper
    desc: KEY CODE phrase (uppercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "KEY CODE"

  - id: key-down-lower
    desc: key down phrase (lowercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "key down"

  - id: key-down-title
    desc: Key Down phrase (title case)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "Key Down"

  - id: key-down-upper
    desc: KEY DOWN phrase (uppercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "KEY DOWN"

  - id: system-events-lower
    desc: system events phrase (lowercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "system events"

  - id: system-events-title
    desc: System Events phrase (title case)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "System Events"

  - id: system-events-upper
    desc: SYSTEM EVENTS phrase (uppercase)
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "SYSTEM EVENTS"

  # === JXA (JavaScript for Automation) ===
  - id: application-call
    desc: Application( constructor call
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: "Application("

  - id: keycode-camel
    desc: keyCode property
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: symbol
      exact: "keyCode"

  # === Node.js AppleScript Libraries ===
  - id: require-applescript-single
    desc: require('applescript') import
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "require('applescript')"

  - id: require-applescript-double
    desc: 'require("applescript") import'
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: 'require("applescript")'

  - id: node-osascript
    desc: node-osascript library
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "node-osascript"

  - id: run-applescript
    desc: run-applescript function
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: "run-applescript"

  - id: exec-sync
    desc: execSync function
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "execSync"

composite_rules:
  # === Helper composites (case variants) ===
  # These are building blocks that just aggregate case variants.
  # They should remain inert - suspicious ratings come from
  # the behavioral composites that combine multiple indicators.
  - id: osascript-keyword
    desc: osascript keyword (case variants)
    crit: inert
    for: [all]
    any:
      - { id: osascript-lower }
      - { id: osascript-title }
      - { id: osascript-upper }

  - id: keystroke-keyword
    desc: keystroke keyword (case variants)
    crit: inert
    for: [all]
    any:
      - { id: keystroke-lower }
      - { id: keystroke-title }
      - { id: keystroke-upper }

  - id: key-code-phrase
    desc: key code phrase (case variants)
    crit: inert
    for: [all]
    any:
      - { id: key-code-lower }
      - { id: key-code-title }
      - { id: key-code-upper }

  - id: key-down-phrase
    desc: key down phrase (case variants)
    crit: inert
    for: [all]
    any:
      - { id: key-down-lower }
      - { id: key-down-title }
      - { id: key-down-upper }

  - id: system-events-phrase
    desc: system events phrase (case variants)
    crit: inert
    for: [all]
    any:
      - { id: system-events-lower }
      - { id: system-events-title }
      - { id: system-events-upper }

  - id: applescript-keywords
    desc: AppleScript keystroke keywords
    crit: inert
    for: [all]
    any:
      - { id: keystroke-keyword }
      - { id: key-code-phrase }
      - { id: key-down-phrase }
      - { id: system-events-phrase }

  - id: jxa-keystroke-keywords
    desc: JXA keystroke keywords
    for: [javascript]
    any:
      - { id: keystroke-lower }
      - { id: keycode-camel }

  - id: applescript-require
    desc: Node.js AppleScript library imports
    for: [javascript, typescript]
    any:
      - { id: require-applescript-single }
      - { id: require-applescript-double }
      - { id: node-osascript }
      - { id: run-applescript }

  # Python pynput composite
  - id: python-pynput
    desc: Python pynput keyboard listener
    conf: 0.7
    for: [python]
    any:
      - { id: pynput-import-keyboard }
      - { id: pynput-keyboard-import }

  # JS iohook composite
  - id: js-iohook
    desc: Node.js iohook global keyboard hook
    conf: 0.75
    for: [javascript]
    any:
      - { id: require-iohook }
      - { id: import-iohook }

  # Rust rdev composite
  - id: rust-rdev
    desc: Rust rdev keyboard event library
    conf: 0.65
    for: [rust]
    any:
      - { id: use-rdev }
      - { id: extern-crate-rdev }

  # === Migrated from YARA ===
  - id: applescript-keystroke
    desc: AppleScript keystroke capture
    crit: suspicious
    conf: 0.95
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    for: [all]
    all:
      - { id: osascript-keyword }
      - { id: applescript-keywords }

  - id: jxa-keystroke
    desc: JXA (JavaScript for Automation) keystroke
    crit: suspicious
    conf: 0.95
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    for: [javascript]
    all:
      - { id: application-call }
      - { id: system-events-phrase }
      - { id: jxa-keystroke-keywords }

  # Helper composite
  - id: osascript-exec
    desc: osascript execution via exec
    all:
      - id: osascript-keyword
      - id: exec-sync

  - id: node-applescript
    desc: Node.js AppleScript execution
    crit: suspicious
    conf: 0.85
    mbc: "B0015"
    attack: "T1059.002"
    platforms: [macos]
    for: [javascript, typescript]
    any:
      - id: applescript-require
      - id: osascript-exec

  # === Platform Composite Rules ===
  # Multiple keyboard-related indicators - still only suspicious
  # Hostile classification requires exfiltration indicators
  - id: windows-keylogger
    desc: Windows keylogger pattern (multiple keyboard
    conf: 0.85
    platforms: [windows]
    for: [pe, dll]
    count_min: 2
    any:
      - { id: windows-hook }
      - { id: windows-rawinput }
      - { id: windows-asynckey }

  - id: linux-keylogger
    desc: Linux keylogger pattern (multiple input
    conf: 0.85
    platforms: [linux]
    for: [elf]
    all:
      - { id: linux-input-device }
      - { id: x11-grab }
