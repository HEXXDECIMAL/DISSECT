# Secret/Credential Environment Variable Access - Python
# Detects access to sensitive environment variables via os.environ or os.getenv

traits:
  # === os.getenv patterns ===
  # Note: We detect getenv symbol + TOKEN/KEY/etc string patterns
  - id: os-getenv-symbol
    desc: os.getenv method
    crit: inert
    conf: 0.6
    for: [python]
    if:
      type: symbol
      exact: "getenv"

  # === os.environ patterns ===
  - id: os-environ-symbol
    desc: os.environ attribute
    crit: inert
    conf: 0.6
    for: [python]
    if:
      type: symbol
      exact: "os.environ"

  # === Common Keywords ===
  - id: keyword-token
    desc: TOKEN keyword in env variable
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*TOKEN[^''"]*[''"]'

  - id: keyword-key
    desc: KEY keyword in env variable
    crit: inert
    conf: 0.65
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*KEY[^''"]*[''"]'

  - id: keyword-secret
    desc: SECRET keyword in env variable
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*SECRET[^''"]*[''"]'

  - id: keyword-pass
    desc: PASS keyword in env variable
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*PASS[^''"]*[''"]'

  - id: keyword-auth
    desc: AUTH keyword in env variable
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*AUTH[^''"]*[''"]'

  - id: keyword-pwd
    desc: PWD keyword in env variable
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*PWD[^''"]*[''"]'

  - id: keyword-cred
    desc: CRED keyword in env variable
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      regex: '[''"][^''"]*CRED[^''"]*[''"]'

composite_rules:
  # Helper composites
  - id: sensitive-env-keywords
    desc: Sensitive keywords in env variable
    for: [python]
    any:
      - { id: keyword-token }
      - { id: keyword-key }
      - { id: keyword-secret }
      - { id: keyword-pass }
      - { id: keyword-auth }
      - { id: keyword-pwd }
      - { id: keyword-cred }

  # Migrated from YARA
  - id: python-os-getenv
    desc: Accesses sensitive environment variable via os.getenv
    crit: suspicious
    conf: 0.9
    for: [python]
    all:
      - { id: os-getenv-symbol }
      - { id: sensitive-env-keywords }

  - id: python-os-environ
    desc: Accesses sensitive environment variable via os.environ
    crit: suspicious
    conf: 0.9
    for: [python]
    all:
      - { id: os-environ-symbol }
      - { id: sensitive-env-keywords }

  # Original composite
  - id: python-env-key
    desc: "Accesses sensitive environment variable"
    crit: suspicious
    any:
      - id: python-os-getenv
      - id: python-os-environ