---
# VBScript Clipboard Hijacker Detection
# Detects clipboard monitoring and cryptocurrency address replacement
# ATT&CK: T1115 (Clipboard Data), T1649 (Steal Crypto Wallet)

defaults:
  for: [all]
  platforms: [windows]

traits:
  # === Clipboard Data Access ===
  - id: vbs-clipboard-get
    desc: Clipboard data retrieval
    crit: suspicious
    conf: 0.85
    attack: "T1115"
    if:
      type: string
      regex: 'ClipboardData\.GetData|ParentWindow\.ClipboardData'

  # === Clipboard Monitoring Loop ===
  - id: vbs-clipboard-loop
    desc: Continuous clipboard monitoring
    crit: suspicious
    conf: 0.90
    attack: "T1115"
    if:
      type: string
      regex: "Do.{0,50}Loop|While.{0,30}True.{0,30}Clipboard|Clipboard.{0,30}sleep"

  # === Bitcoin Address Pattern ===
  - id: bitcoin-address
    desc: Bitcoin address embedded
    crit: notable
    conf: 0.80
    attack: "T1649"
    if:
      type: string
      regex: '\b(bc1[a-zA-Z0-9]{25,59}|1[a-km-zA-HJ-NP-Z1-9]{25,34}|3[a-km-zA-HJ-NP-Z1-9]{25,34})\b'

  # === Monero Address Pattern ===
  - id: monero-address
    desc: Monero address embedded
    crit: notable
    conf: 0.80
    attack: "T1649"
    if:
      type: string
      regex: "4[0-9AB][1-9A-HJ-NP-Za-km-z]{93}"

  # === Ethereum Address Pattern ===
  - id: ethereum-address
    desc: Ethereum address embedded
    crit: notable
    conf: 0.80
    attack: "T1649"
    if:
      type: string
      regex: "0x[a-fA-F0-9]{40}"

  # === Cryptocurrency Address Check ===
  - id: crypto-address-check
    desc: Cryptocurrency address validation
    crit: suspicious
    conf: 0.85
    attack: "T1649"
    if:
      type: string
      regex: 'Left\\(.{0,30}1\\)|Len\\(.{0,30}26|Len\\(.{0,30}35|Len\\(.{0,30}95'

  # === Address Replacement ===
  - id: address-replacement
    desc: Clipboard content replacement
    crit: suspicious
    conf: 0.90
    attack: "T1649"
    if:
      type: string
      regex: 'echo.{0,30}clip|\\.run.{0,30}clip|replace.{0,30}address'

  # === HTMLFile Object ===
  - id: htmlfile-object
    desc: HTMLFile object for clipboard access
    crit: notable
    conf: 0.75
    attack: "T1115"
    if:
      type: string
      regex: "HTMLfile|CreateObject.{0,30}HTML"

composite_rules:
  # === Cryptocurrency Clipboard Hijacker ===
  - id: crypto-clipboard-hijacker
    desc: Cryptocurrency clipboard hijacker
    crit: suspicious
    conf: 0.95
    attack: "T1649"
    needs: 4
    any:
      - id: vbs-clipboard-get
      - id: vbs-clipboard-loop
      - id: bitcoin-address
      - id: monero-address
      - id: ethereum-address
      - id: crypto-address-check
      - id: address-replacement

  # === Clipboard Monitor ===
  - id: vbs-clipboard-monitor
    desc: VBScript clipboard monitor
    crit: suspicious
    conf: 0.88
    attack: "T1115"
    needs: 2
    any:
      - id: vbs-clipboard-get
      - id: vbs-clipboard-loop
      - id: htmlfile-object
