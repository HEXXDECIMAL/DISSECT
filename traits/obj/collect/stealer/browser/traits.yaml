# Browser and Cloud Credential Harvesting
# Detects theft of stored credentials from browser databases and environment variables
# ATT&CK: T1555.003 (Credentials from Web Browsers)
# ATT&CK: T1552.001 (Unsecured Credentials: Credentials In Files)

defaults:
  for: [elf, macho, pe, go]

traits:
  # === Browser credential harvesting ===
  - id: chrome-string
    desc: Chrome browser string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "Chrome"

  - id: firefox-string
    desc: Firefox browser string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "Firefox"

  - id: go-sqlite3
    desc: go-sqlite3 library import
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "go-sqlite3"

  - id: crypt-unprotect-data
    desc: CryptUnprotectData Windows API
    crit: inert
    conf: 0.75
    for: [pe]
    if:
      type: symbol
      exact: "CryptUnprotectData"

  # === AWS credential harvesting ===
  - id: os-getenv
    desc: os.Getenv function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "os.Getenv"

  - id: aws-access-string
    desc: AWS_ACCESS environment variable
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "AWS_ACCESS"

  - id: aws-secret-string
    desc: AWS_SECRET environment variable
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "AWS_SECRET"

composite_rules:
  - id: browser-strings
    desc: Browser name strings
    any:
      - { id: chrome-string }
      - { id: firefox-string }
      - { id: cap/fs/path/sensitive/browser::login-data }
      - { id: obj/creds/browser/firefox::cookies }

  - id: aws-env-vars
    desc: AWS environment variable names
    any:
      - { id: aws-access-string }
      - { id: aws-secret-string }

  - id: browser-cred-harvest
    desc: Browser credential database harvesting
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    all:
      - { id: browser-strings, needs: 2 }
      - { id: go-sqlite3 }

  - id: aws-cred-harvest
    desc: AWS credential environment variable harvesting
    crit: suspicious
    conf: 0.85
    attack: "T1552.001"
    all:
      - { id: os-getenv }
      - { id: aws-env-vars }

  - id: credential-harvest
    desc: Credential harvesting patterns
    crit: suspicious
    conf: 0.85
    any:
      - { id: browser-cred-harvest }
      - { id: crypt-unprotect-data }
      - { id: aws-cred-harvest }
