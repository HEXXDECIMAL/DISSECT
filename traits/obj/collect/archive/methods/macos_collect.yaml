# macOS Archive Operations Detection
# Detects macOS-specific archive and compression operations
# ATT&CK: T1560 (Archive Collected Data)

defaults:
  attack: "T1560"
  platforms: [macos]
  crit: notable

traits:
  # === ditto compression atomic indicators ===
  - id: ditto-ck-flags
    desc: ditto -c -k compression flags
    crit: notable
    conf: 0.7
    attack: "T1560.001"
    if:
      type: string
      regex: "ditto\\s+-c\\s+-k"

  - id: ditto-sequester
    desc: ditto --sequesterRsrc flag
    crit: notable
    conf: 0.7
    attack: "T1560.001"
    if:
      type: string
      substr: "--sequesterRsrc"

  - id: ditto-zip-output
    desc: ditto with .zip output
    crit: notable
    conf: 0.7
    attack: "T1560.001"
    if:
      type: string
      regex: "ditto.{0,50}\\.zip"

  # === hdiutil create atomic indicators ===
  - id: hdiutil-create-cmd
    desc: hdiutil create command
    crit: notable
    conf: 0.65
    attack: "T1560.001"
    if:
      type: string
      regex: "hdiutil\\s+create"

  - id: hdiutil-format-flag
    desc: hdiutil -format flag
    crit: notable
    conf: 0.65
    attack: "T1560.001"
    if:
      type: string
      regex: "hdiutil.{0,30}-format"

  # === tar/gzip atomic indicators ===
  - id: tar-create-flag
    desc: tar create/compress flags
    crit: notable
    conf: 0.5
    attack: "T1560.001"
    if:
      type: string
      regex: "tar\\s+-[a-z]*[cz]"

  - id: tar-create-long
    desc: tar --create long option
    crit: notable
    conf: 0.5
    attack: "T1560.001"
    if:
      type: string
      substr: "tar --create"

  - id: gzip-compress
    desc: gzip compression
    crit: notable
    conf: 0.5
    attack: "T1560.001"
    if:
      type: string
      regex: "gzip\\s+-"

composite_rules:
  # ditto compression composite
  - id: ditto-compress
    desc: "macOS ditto archive compression"
    crit: suspicious
    conf: 0.85
    attack: "T1560.001"
    any:
      - id: ditto-ck-flags
      - id: ditto-sequester
      - id: ditto-zip-output
    downgrade:
      any:
        - id: meta/sign/apple::platform

  # hdiutil create composite
  - id: hdiutil-create
    desc: macOS disk image creation
    crit: notable
    conf: 0.75
    attack: "T1560.001"
    any:
      - id: hdiutil-create-cmd
      - id: hdiutil-format-flag

  # tar/gzip compression composite
  - id: tar-compress
    desc: "tar archive creation"
    crit: notable
    conf: 0.6
    attack: "T1560.001"
    any:
      - id: tar-create-flag
      - id: tar-create-long
      - id: gzip-compress
