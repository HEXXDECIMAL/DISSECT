# Init Script Persistence Detection
# Detects shell scripts that establish persistence via init system
# ATT&CK: T1037 (Boot or Logon Initialization Scripts)

defaults:
  crit: notable
  attack: "T1037"
  for: [shell]

traits:
  # === Init Script Indicators ===
  # Init script headers must appear in first 1KB (standard practice)
  - id: chkconfig-header
    desc: SysV init script header
    crit: notable
    conf: 0.95
    if:
      type: raw
      regex: "#\\s*chkconfig:\\s*[-0-9]+\\s+[0-9]+\\s+[0-9]+"
      offset_range: [0, 1024] # Must be in header area

  # Aggressive persistence: runs in ALL runlevels (12345 or 2345)
  - id: chkconfig-all-runlevels
    desc: Init runs in all runlevels
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # Matches chkconfig with runlevels 12345, 2345, or similar (4+ runlevels)
      regex: "#\\s*chkconfig:\\s*[-]?[0-9]{4,}\\s+[0-9]+\\s+[0-9]+"
      offset_range: [0, 1024]

  # Very early start priority (01-10) - wants to run before most services
  - id: chkconfig-early-start
    desc: Init with very early start
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # Priority 01-10 is unusually early (most legitimate services use 50+)
      regex: "#\\s*chkconfig:\\s*[-0-9]+\\s+0[0-9]\\s+[0-9]+"
      offset_range: [0, 1024]

  - id: source-init-functions
    desc: Sources init.d functions
    crit: notable
    conf: 0.85
    if:
      type: raw
      regex: "\\.\\s+/etc/rc\\.d/init\\.d/functions|source\\s+/etc/rc\\.d/init\\.d/functions"

  - id: source-sysconfig
    desc: Sources sysconfig file
    crit: notable
    conf: 0.80
    if:
      type: raw
      regex: "\\.\\s+/etc/sysconfig/|source\\s+/etc/sysconfig/"

  - id: source-selinux-config
    desc: Sources SELinux config
    crit: suspicious
    conf: 0.85
    attack: "T1562.001"
    if:
      type: raw
      regex: "\\.\\s+/etc/selinux/|source\\s+/etc/selinux/"

  - id: lockfile-subsys
    desc: Uses subsys lockfile
    crit: notable
    conf: 0.90
    if:
      type: raw
      regex: "/var/lock/subsys/"

  - id: daemon-function
    desc: Calls daemon function
    crit: notable
    conf: 0.85
    if:
      type: raw
      regex: "\\bdaemon\\s+\\$"

  # === Process Control Patterns ===
  # Process group kill: kill -9 -$pid kills entire process group
  - id: process-group-kill
    desc: Kills entire process group
    crit: suspicious
    conf: 0.90
    attack: "T1489"
    if:
      type: raw
      # kill -9 -$var or kill -SIGKILL -$var patterns
      regex: "kill\\s+(?:-9|-SIGKILL|-KILL)\\s+-\\$?\\{?[a-zA-Z_][a-zA-Z0-9_]*\\}?"

  # Process hunting: ps -ef | grep + kill pattern
  - id: ps-grep-kill-pattern
    desc: Process hunt via ps/grep/kill
    crit: notable
    conf: 0.85
    attack: "T1057"
    if:
      type: raw
      regex: "ps\\s+(?:-ef|-aux)[^|]{0,30}\\|[^|]{0,50}grep"

  # Process inspection via /proc
  - id: proc-cmdline-read
    desc: Reads /proc process cmdline
    crit: notable
    conf: 0.85
    attack: "T1057"
    if:
      type: raw
      regex: "/proc/\\$[a-zA-Z_][a-zA-Z0-9_]*/cmdline|/proc/\\$\\{[a-zA-Z_][a-zA-Z0-9_]*\\}/cmdline"

  # Process discovery via pgrep
  - id: pgrep-discovery
    desc: Process discovery via pgrep
    crit: notable
    conf: 0.80
    attack: "T1057"
    if:
      type: raw
      regex: "\\bpgrep\\s+"

  # === Kernel/Device Operations (Suspicious in Init Scripts) ===
  # Init script that loads kernel modules - can be used to load rootkits
  - id: kernel-module-load
    desc: Init loads kernel module
    crit: suspicious
    conf: 0.80
    attack: "T1547.006"
    if:
      type: raw
      regex: "\\bmodprobe\\s+\\$|\\binsmod\\s+"

  # Init script creates device nodes - can create backdoor devices
  - id: device-node-create
    desc: Init creates device node
    crit: suspicious
    conf: 0.85
    attack: "T1543"
    if:
      type: raw
      regex: "\\bmknod\\s+[^\\n]{1,50}\\s+c\\s+[0-9]+"

  # Sources non-standard init helper files (not /etc/init.d/functions or /etc/rc.d/init.d/functions)
  # Malware often sources custom helper scripts like "modules", "status"
  - id: source-nonstandard-init-helper
    desc: Sources non-standard init helper
    crit: suspicious
    conf: 0.85
    attack: "T1037"
    if:
      type: raw
      # Sources /etc/init.d/modules or /etc/init.d/status (not standard)
      regex: "\\.\\s+/etc/init\\.d/(?:modules|status)|source\\s+/etc/init\\.d/(?:modules|status)"

  # Binary executed from /root directory - unusual for system services
  - id: binary-from-root-dir
    desc: Runs binary from /root
    crit: suspicious
    conf: 0.90
    attack: "T1543"
    if:
      type: raw
      regex: '"/root/[^"]+"|PROGNAME="/root/|DAEMON="/root/'

  # Deceptive processname comment - claims to be one process but might run another
  - id: processname-mismatch-lib
    desc: processname references library-like name
    crit: suspicious
    conf: 0.85
    attack: "T1036"
    if:
      type: raw
      # processname that looks like a library (lib*.a, lib*.so, etc)
      regex: "#\\s*processname:\\s*lib[a-z_]+[._][aso]"

composite_rules:
  # SysV init script with SELinux manipulation
  - id: init-script-selinux-bypass
    desc: Init script with SELinux bypass
    crit: suspicious
    conf: 0.90
    attack: "T1562.001"
    all:
      - id: chkconfig-header
      - id: obj/impact/degrade/mac::selinux-setsebool

  # Aggressive init persistence: early start + all runlevels
  # Complexity: all(2) + for(1) = 3 -> suspicious maintained
  - id: aggressive-init-persistence
    desc: Aggressive init persistence
    crit: suspicious
    conf: 0.90
    attack: "T1037.004"
    all:
      - id: chkconfig-all-runlevels
      - id: chkconfig-early-start

  # Init script with process group killing - highly suspicious
  # Legitimate init scripts use graceful signals, not SIGKILL on process groups
  # Complexity: all(2) + for(1) = 3 -> suspicious maintained
  - id: init-process-group-killer
    desc: Init script with process group kill
    crit: suspicious
    conf: 0.90
    attack: "T1489"
    all:
      - id: chkconfig-header
      - id: process-group-kill

  # Init script with extensive process hunting
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE
  - id: init-process-hunter
    desc: Init script with process hunting
    crit: hostile
    conf: 0.90
    attack: "T1037"
    all:
      - id: chkconfig-header
      - id: ps-grep-kill-pattern
      - id: proc-cmdline-read
      - id: process-group-kill

  # Init script with process discovery and control
  # Complexity: all(4) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: init-aggressive-process-control
    desc: Init script aggressive process mgmt
    crit: hostile
    conf: 0.90
    attack: "T1037"
    all:
      - id: chkconfig-all-runlevels
      - id: pgrep-discovery
      - id: ps-grep-kill-pattern
      - id: process-group-kill

  # Init script with kernel module loading and device creation
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE maintained
  - id: init-kernel-device-manipulation
    desc: Init with kernel/device manipulation
    crit: hostile
    conf: 0.85
    attack: "T1547.006"
    all:
      - id: chkconfig-header
      - id: kernel-module-load
      - id: device-node-create

  # Init script sourcing non-standard helpers and running from /root
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE maintained
  - id: init-backdoor-pattern
    desc: Init with backdoor characteristics
    crit: hostile
    conf: 0.90
    attack: "T1037"
    all:
      - id: chkconfig-header
      - id: source-nonstandard-init-helper
      - id: binary-from-root-dir

  # Deceptive init script: claims to be library, has all-runlevel persistence
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE maintained
  - id: init-deceptive-service
    desc: Deceptive init service masquerade
    crit: hostile
    conf: 0.90
    attack: "T1036"
    all:
      - id: chkconfig-header
      - id: chkconfig-all-runlevels
      - id: processname-mismatch-lib
