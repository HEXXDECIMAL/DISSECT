# Windows Startup Persistence Detection
# Detects Windows persistence mechanisms
# ATT&CK: T1547.001 (Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder)

defaults:
  attack: "T1547.001"
  crit: suspicious
  for: [pe, py, rb, js, ts]
  platforms: [windows]

traits:
  # === Startup folder atomic indicators ===
  - id: start-menu-startup
    desc: Start Menu Programs Startup path
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "\\Start Menu\\Programs\\Startup"

  - id: appdata-startup
    desc: AppData Roaming Startup path
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup"

  - id: shell-startup
    desc: shell:startup special folder
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "shell:startup"

  # === Registry Run key atomic indicators ===
  - id: software-run-key
    desc: SOFTWARE CurrentVersion Run path
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"

  - id: hkcu-run
    desc: HKCU Run key reference
    crit: notable
    conf: 0.6
    platforms: [windows]
    if:
      type: string
      regex: "HKCU.{0,50}Run"

  - id: hklm-run
    desc: HKLM Run key reference
    crit: notable
    conf: 0.6
    platforms: [windows]
    if:
      type: string
      regex: "HKLM.{0,50}Run"

  - id: currentversion-run
    desc: CurrentVersion Run path
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "CurrentVersion\\Run"

  # === RunOnce atomic indicators ===
  - id: currentversion-runonce
    desc: CurrentVersion RunOnce path
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "CurrentVersion\\RunOnce"

  - id: runonce-word
    desc: RunOnce keyword
    crit: notable
    conf: 0.5
    platforms: [windows]
    if:
      type: string
      substr: "RunOnce"

  # === Python winreg atomic indicators ===
  - id: import-winreg
    desc: import winreg statement
    crit: notable
    conf: 0.5
    platforms: [windows]
    for: [python]
    if:
      type: string
      substr: "import winreg"

  - id: from-winreg
    desc: from winreg import
    crit: notable
    conf: 0.5
    platforms: [windows]
    for: [python]
    if:
      type: string
      substr: "from winreg"

  - id: underscore-winreg
    desc: _winreg module (Python 2)
    crit: notable
    conf: 0.5
    platforms: [windows]
    for: [python]
    if:
      type: string
      substr: "_winreg"

  - id: openkey-hkey
    desc: OpenKey HKEY call
    crit: notable
    conf: 0.6
    platforms: [windows]
    for: [python]
    if:
      type: string
      regex: "OpenKey.{0,30}HKEY"

  - id: setvalueex
    desc: SetValueEx call
    crit: notable
    conf: 0.6
    platforms: [windows]
    for: [python]
    if:
      type: string
      substr: "SetValueEx"

  - id: createkey
    desc: CreateKey call
    crit: notable
    conf: 0.6
    platforms: [windows]
    for: [python]
    if:
      type: string
      substr: "CreateKey"

  # === Scheduled tasks atomic indicators ===
  - id: schtasks-create-cmd
    desc: schtasks /create command
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "schtasks\\s*/create"

  - id: schtasks-exe-create
    desc: schtasks.exe create
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "schtasks\\.exe.{0,30}create"

  - id: itaskscheduler-iface
    desc: ITaskScheduler interface
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "ITaskScheduler"

  - id: taskscheduler-word
    desc: TaskScheduler keyword
    crit: notable
    conf: 0.6
    platforms: [windows]
    if:
      type: string
      substr: "TaskScheduler"

  # === Service installation atomic indicators ===
  - id: sc-create-cmd
    desc: sc create command
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "sc\\s+create"

  - id: createservice-api
    desc: CreateService API
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "CreateService"

  - id: installservice-fn
    desc: InstallService function
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "InstallService\\s*\\("

  - id: win32serviceutil-mod
    desc: win32serviceutil module
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "win32serviceutil"

  # === PowerShell registry atomic indicators ===
  - id: set-itemproperty-run
    desc: Set-ItemProperty Run
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "Set-ItemProperty.{0,50}Run"

  - id: new-itemproperty-run
    desc: New-ItemProperty Run
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "New-ItemProperty.{0,50}Run"

  - id: reg-add-run
    desc: reg add Run
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      regex: "reg\\s+add.{0,50}Run"

  # === WMI persistence atomic indicators ===
  - id: wmi-eventfilter
    desc: __EventFilter class
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "__EventFilter"

  - id: wmi-filtertoconsumer
    desc: __FilterToConsumerBinding class
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "__FilterToConsumerBinding"

  - id: wmi-commandlineconsumer
    desc: CommandLineEventConsumer class
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "CommandLineEventConsumer"

  - id: wmi-activescriptconsumer
    desc: ActiveScriptEventConsumer class
    crit: notable
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      substr: "ActiveScriptEventConsumer"

  # === Shortcut file enumeration ===
  - id: lnk-endswith-filter
    desc: Filters files by .lnk extension
    crit: notable
    conf: 0.8
    platforms: [windows]
    if:
      type: string
      substr: ".lnk"

  - id: endswith-filter-content
    desc: Python endswith file extension filter
    crit: notable
    conf: 0.65
    for: [python]
    if:
      type: raw
      substr: ".endswith("

  # === Windows shortcut manipulation ===
  - id: create-shortcut
    desc: COM CreateShortcut method call
    crit: notable
    conf: 0.75
    platforms: [windows]
    if:
      type: raw
      substr: "CreateShortcut"

  - id: shortcut-target-path
    desc: Shortcut TargetPath property access
    crit: notable
    conf: 0.75
    platforms: [windows]
    if:
      type: raw
      substr: ".TargetPath"

  - id: shortcut-arguments
    desc: Shortcut Arguments property modification
    crit: notable
    conf: 0.75
    platforms: [windows]
    if:
      type: raw
      substr: ".Arguments"

  - id: shortcut-save
    desc: Shortcut Save method call
    crit: notable
    conf: 0.65
    platforms: [windows]
    if:
      type: raw
      substr: ".Save()"

  # NOTE: Generic executable indicators moved to cap/exec/script/indicators/windows.yaml
  # and cap/data/text/keywords/ to avoid misleading categorization as registry persistence

composite_rules:
  # Startup folder composite
  - id: windows-startup-folder
    desc: "Targets Windows Startup folder for"
    conf: 0.85
    crit: suspicious
    platforms: [windows]
    any:
      - id: start-menu-startup
      - id: appdata-startup
      - id: shell-startup

  # Registry Run key composite
  - id: windows-registry-run
    desc: "Accesses Windows registry Run key"
    conf: 0.9
    crit: suspicious
    platforms: [windows]
    any:
      - id: software-run-key
      - id: hkcu-run
      - id: hklm-run
      - id: currentversion-run
    downgrade:
      any:
        - id: meta/quality/versioned

  # RunOnce composite
  - id: windows-registry-runonce
    desc: "Accesses Windows registry RunOnce key"
    conf: 0.9
    crit: suspicious
    platforms: [windows]
    any:
      - id: currentversion-runonce
      - id: runonce-word

  # Python winreg import composite
  - id: windows-python-winreg-import
    desc: "Imports Python winreg module for"
    conf: 0.7
    crit: notable
    platforms: [windows]
    for: [python]
    any:
      - id: import-winreg
      - id: from-winreg
      - id: underscore-winreg

  # Python winreg composite
  - id: windows-python-winreg
    desc: "Accesses Windows registry via Python"
    conf: 0.8
    crit: notable
    # Stealth binaries are typically small
    size_max: 5000
    platforms: [windows]
    for: [python]
    any:
      - id: import-winreg
      - id: from-winreg
      - id: underscore-winreg
      - id: openkey-hkey
      - id: setvalueex
      - id: createkey
    unless:
      - type: basename
        exact: "six.py"

  # Registry Run access composite
  - id: windows-registry-run-access
    desc: "Accesses Windows registry Run key"
    conf: 0.8
    crit: notable
    platforms: [windows]
    any:
      - id: currentversion-run
      - id: openkey-hkey

  # Scheduled tasks composite
  - id: windows-schtasks
    desc: "Creates scheduled task for persistence"
    conf: 0.85
    crit: notable
    attack: "T1053.005"
    size_max: 500000
    platforms: [windows]
    any:
      - id: schtasks-create-cmd
      - id: schtasks-exe-create
      - id: itaskscheduler-iface
      - id: taskscheduler-word

  # Scheduled task create composite
  - id: windows-schtasks-create
    desc: "Creates Windows scheduled task"
    conf: 0.8
    crit: notable
    attack: "T1053.005"
    size_max: 500000
    platforms: [windows]
    any:
      - id: schtasks-create-cmd
      - id: schtasks-exe-create
      - id: itaskscheduler-iface

  # Service installation composite
  - id: windows-service-install
    desc: "Installs Windows service for persistence"
    conf: 0.85
    attack: "T1543.003"
    platforms: [windows]
    any:
      - id: sc-create-cmd
      - id: createservice-api
      - id: installservice-fn
      - id: win32serviceutil-mod

  # PowerShell registry composite
  - id: windows-powershell-registry
    desc: "Modifies registry for persistence via"
    conf: 0.9
    crit: suspicious
    platforms: [windows]
    any:
      - id: set-itemproperty-run
      - id: new-itemproperty-run
      - id: reg-add-run

  # WMI persistence composite
  - id: windows-wmi-persistence
    desc: "Sets up WMI event subscription"
    conf: 0.9
    crit: suspicious
    attack: "T1546.003"
    platforms: [windows]
    any:
      - id: wmi-eventfilter
      - id: wmi-filtertoconsumer
      - id: wmi-commandlineconsumer
      - id: wmi-activescriptconsumer

  # NOTE: windows-executable-payload composite moved to cap/exec/script/indicators/windows.yaml
  # as windows-executable-ref to reflect its nature as a capability, not persistence mechanism

  # Python registry persistence pattern
  - id: windows-python-reg-persistence
    desc: "Python Windows registry persistence"
    crit: suspicious
    conf: 0.95
    attack: "T1547.001"
    mbc: "F0006"
    platforms: [windows]
    for: [python]
    all:
      - id: windows-python-winreg-import
      - id: windows-registry-run-access

  # Shortcut hijacking composite
  - id: windows-shortcut-hijack
    desc: "Windows shortcut hijacking via COM"
    crit: suspicious
    conf: 0.90
    attack: "T1547.009"
    platforms: [windows]
    all:
      - id: create-shortcut
      - id: shortcut-target-path

  # Shortcut argument injection composite
  - id: windows-shortcut-argument-injection
    desc: "Shortcut argument injection via COM"
    crit: suspicious
    conf: 0.90
    attack: "T1547.009"
    platforms: [windows]
    all:
      - id: create-shortcut
      - id: shortcut-arguments
      - id: shortcut-save

  # Shortcut enumeration + modification
  # Walks directories to find .lnk files and modifies them
  # Complexity: all(+2) + any(+1) = 3 (SUSPICIOUS)
  - id: windows-shortcut-walk-modify
    desc: "Enumerates and modifies shortcut files"
    crit: suspicious
    conf: 0.90
    attack: "T1547.009"
    platforms: [windows]
    all:
      - id: cap/fs/directory/traverse::traverse-walk
      - id: create-shortcut
    any:
      - id: lnk-endswith-filter
      - id: endswith-filter-content

  # Full browser shortcut argument injection chain
  # Walks directories for .lnk files and injects arguments into browser shortcuts
  # This is a complete persistence/hijack operation with no legitimate use
  # Complexity: all(+4) = 4 (meets HOSTILE threshold)
  - id: windows-shortcut-walk-argument-inject
    desc: "Enumerates shortcuts and injects arguments"
    crit: hostile
    conf: 0.95
    attack: "T1547.009"
    mbc: "F0012"
    platforms: [windows]
    all:
      - id: cap/fs/directory/traverse::traverse-walk
      - id: create-shortcut
      - id: shortcut-arguments
      - id: shortcut-save

  # Scheduled task with suspicious payload
  - id: windows-schtasks-payload
    desc: "Scheduled task with executable payload"
    crit: suspicious
    conf: 0.95
    attack: "T1053.005"
    mbc: "F0006"
    platforms: [windows]
    all:
      - id: windows-schtasks-create
      - id: cap/exec/script/indicators::windows-executable-ref
