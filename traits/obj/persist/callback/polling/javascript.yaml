# Persistent Polling - JavaScript/Node.js
# Detects setInterval/setTimeout patterns used for persistent callbacks
# ATT&CK: T1053 (Scheduled Task/Job)

traits:
  # === setInterval HTTP atomic indicators ===
  - id: setInterval-http-call
    desc: setInterval with http
    crit: inert
    conf: 0.6
    r#for: [javascript]
    if:
      type: string
      regex: "setInterval.{0,100}http"

  - id: setInterval-axios
    desc: setInterval with axios
    crit: inert
    conf: 0.6
    r#for: [javascript]
    if:
      type: string
      regex: "setInterval.{0,100}axios"

  - id: setInterval-fetch
    desc: setInterval with fetch
    crit: inert
    conf: 0.6
    r#for: [javascript]
    if:
      type: string
      regex: "setInterval.{0,100}fetch"

  - id: setInterval-function
    desc: setInterval with function callback
    crit: inert
    conf: 0.7
    r#for: [javascript]
    if:
      type: string
      regex: "setInterval\\s*\\(\\s*function"

  - id: setTimeout-recursive
    desc: setTimeout in recursive pattern
    crit: notable
    conf: 0.7
    r#for: [javascript]
    if:
      type: string
      regex: "setTimeout.{0,100}setTimeout"

composite_rules:
  - id: setInterval-http
    desc: setInterval with HTTP calls (persistent
    crit: suspicious
    conf: 0.85
    attack: "T1053"
    r#for: [javascript]
    count_min: 1
    any:
      - id: setInterval-http-call
      - id: setInterval-axios
      - id: setInterval-fetch
