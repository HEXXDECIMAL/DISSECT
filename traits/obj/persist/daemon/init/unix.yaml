# Unix Daemon Persistence
# Detects daemon/background process behavior common in malware
# ATT&CK: T1543 (Create or Modify System Process)

traits:
  # === daemon-fork atomic indicators ===
  - id: fork-symbol
    description: fork syscall symbol
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bfork\\b"

  - id: daemon-symbol
    description: daemon function symbol
    crit: inert
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bdaemon\\b"

  # NOTE: setsid is commonly used by legitimate system tools, shells, and
  # terminal multiplexers. Alone it's just process group management.
  - id: daemon-setsid
    description: "Session creation (setsid) for daemon"
    crit: inert
    confidence: 0.4
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bsetsid\\b"

  - id: daemon-umask
    description: "umask syscall (daemon initialization)"
    crit: inert
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bumask\\b"

  # NOTE: /dev/null is extremely common in legitimate software - build tools,
  # compilers, system utilities all use it for I/O redirection. Too broad to
  # be notable on its own.
  - id: daemon-dev-null
    description: "Redirects I/O to /dev/null (daemon"
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: string
      exact: "/dev/null"

  # NOTE: chdir is a basic filesystem operation used by countless legitimate tools.
  # Too common to be notable.
  - id: daemon-chdir-root
    description: "Change directory to root (daemon"
    crit: inert
    confidence: 0.2
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bchdir\\b"

  # NOTE: Go runtime uses /proc/self legitimately for memory management
  # and process introspection. Downgraded to inert.
  - id: daemon-proc-self
    description: "Reads /proc/self (process introspection)"
    crit: inert
    confidence: 0.3
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "/proc/self(/|$)"

  # === Signal handling micro-traits (migrated from YARA) ===
  - id: signal-symbol
    description: signal function symbol
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: symbol
      pattern: "\\bsignal\\b"

  - id: sigaction-symbol
    description: sigaction function symbol
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: symbol
      pattern: "\\bsigaction\\b"

  # NOTE: Signal ignore patterns are common in many legitimate binaries
  # that need robust signal handling (shells, daemons, servers).
  - id: sig-ign-sighup-x64
    description: SIGHUP signal ignore pattern (x86_64)
    crit: inert
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: hex
      pattern: "BF 01 00 00 00 BE 01 00 00 00"

  - id: sig-ign-sigpipe-x64
    description: SIGPIPE signal ignore pattern (x86_64)
    crit: inert
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: hex
      pattern: "BF 0D 00 00 00 BE 01 00 00 00"

  # === sigchld-handler atomic indicators ===
  - id: sigchild-underscore
    description: _sigchild string
    crit: inert
    confidence: 0.5
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "_sigchild"

  - id: sigchld-handler-string
    description: sigchld_handler string
    crit: inert
    confidence: 0.5
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "sigchld_handler"

  - id: handle-sigchld-string
    description: handle_sigchld string
    crit: inert
    confidence: 0.5
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "handle_sigchld"

composite_rules:
  # NOTE: fork/daemon are basic process primitives used by many legitimate
  # system tools, servers, and build utilities. Downgraded to inert.
  - id: daemon-fork
    description: "Process forking for daemon behavior"
    crit: inert
    confidence: 0.3
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos]
    count_min: 1
    any:
      - id: fork-symbol
      - id: daemon-symbol

  # Signal function composite
  - id: signal-function
    description: Signal handling function
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    count_min: 1
    any:
      - id: signal-symbol
      - id: sigaction-symbol

  # NOTE: Signal ignore patterns are common in legitimate binaries.
  - id: sig-ign-pattern
    description: Signal ignore byte pattern (x86_64)
    crit: inert
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    count_min: 1
    any:
      - id: sig-ign-sighup-x64
      - id: sig-ign-sigpipe-x64

  # Signal ignore for daemon (migrated from YARA)
  - id: signal-ignore-pattern
    description: "Signal handler setup (daemon persistence"
    crit: inert
    confidence: 0.3
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    all:
      - id: signal-function
      - id: sig-ign-pattern

  - id: sigchld-handler
    description: "Custom SIGCHLD handler (child process"
    crit: notable
    confidence: 0.6
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    count_min: 1
    any:
      - id: sigchild-underscore
      - id: sigchld-handler-string
      - id: handle-sigchld-string

  # NOTE: Daemon behavior is extremely common in legitimate software - system
  # services, build tools, compilers, servers, shells. The individual components
  # (/dev/null, fork, setsid) are universal primitives. Downgraded to inert.
  # For truly malicious daemon activity, combine with C2, credential access,
  # or other hostile indicators in a separate composite.
  - id: full-daemon
    description: "Full daemon behavior (fork +"
    crit: inert
    confidence: 0.3
    attack: "T1543"
    mbc: "F0006"
    file_types: [elf]
    platforms: [linux]
    all:
      - id: daemon-dev-null
    any:
      - id: daemon-fork
      - id: daemon-setsid

  # NOTE: Since daemon-proc-self is now inert (Go uses /proc/self legitimately),
  # this composite needs additional indicators to be meaningful.
  - id: stealth-daemon
    description: "Stealthy daemon (daemon + proc"
    crit: notable
    confidence: 0.5
    attack: "T1543"
    mbc: "F0006"
    file_types: [elf]
    platforms: [linux]
    all:
      - id: daemon-proc-self
    any:
      - id: daemon-fork
      - id: daemon-setsid

  # macOS double-fork daemon pattern
  # This is the classic fork() -> setsid() -> fork() -> umask() -> chdir() pattern
  - id: macos-double-fork-daemon
    description: "macOS double-fork daemon pattern (fork"
    crit: suspicious
    confidence: 0.85
    attack: "T1543"
    mbc: "F0006"
    file_types: [macho]
    platforms: [macos]
    all:
      - id: fork-symbol
      - id: daemon-setsid
    any:
      - id: daemon-umask
      - id: daemon-chdir-root
