# Unix Daemon Persistence
# Detects daemon/background process behavior common in malware
# ATT&CK: T1543 (Create or Modify System Process)

traits:
  # === daemon-fork atomic indicators ===
  - id: fork-symbol
    desc: fork syscall symbol
    crit: inert
    conf: 0.3
    for: [elf, macho]
    platforms: [linux, macos]
    if:
      type: symbol
      regex: "\\bfork\\b"

  - id: daemon-symbol
    desc: daemon function symbol
    crit: inert
    conf: 0.4
    for: [elf, macho]
    platforms: [linux, macos]
    if:
      type: symbol
      regex: "\\bdaemon\\b"

  # NOTE: setsid is commonly used by legitimate system tools, shells, and
  # terminal multiplexers. Alone it's just process group management.
  - id: daemon-setsid
    desc: "Session creation (setsid) for daemon"
    crit: inert
    conf: 0.4
    attack: "T1543"
    for: [elf, macho]
    platforms: [linux, macos]
    if:
      type: symbol
      regex: "\\bsetsid\\b"

  - id: daemon-umask
    desc: "umask syscall (daemon initialization)"
    crit: inert
    conf: 0.4
    for: [elf, macho]
    platforms: [linux, macos]
    if:
      type: symbol
      regex: "\\bumask\\b"

  # NOTE: /dev/null is extremely common in legitimate software - build tools,
  # compilers, system utilities all use it for I/O redirection. Too broad to
  # be notable on its own.
  - id: daemon-dev-null
    desc: "Redirects I/O to /dev/null (daemon"
    crit: inert
    conf: 0.3
    for: [elf, macho]
    platforms: [linux, macos]
    if:
      type: string
      substr: "/dev/null"

  # NOTE: chdir is a basic filesystem operation used by countless legitimate tools.
  # Too common to be notable.
  - id: daemon-chdir-root
    desc: "Change directory to root (daemon"
    crit: inert
    conf: 0.2
    for: [elf, macho]
    platforms: [linux, macos]
    if:
      type: symbol
      regex: "\\bchdir\\b"

  # NOTE: Go runtime uses /proc/self legitimately for memory management
  # and process introspection. Downgraded to inert.
  - id: daemon-proc-self
    desc: "Reads /proc/self (process introspection)"
    crit: inert
    conf: 0.3
    for: [elf]
    platforms: [linux]
    if:
      type: string
      regex: "/proc/self(/|$)"

  # === Signal handling micro-traits (migrated from YARA) ===
  - id: signal-symbol
    desc: signal function symbol
    crit: inert
    conf: 0.3
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: symbol
      regex: "\\bsignal\\b"

  - id: sigaction-symbol
    desc: sigaction function symbol
    crit: inert
    conf: 0.3
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: symbol
      regex: "\\bsigaction\\b"

  # NOTE: Signal ignore patterns are common in many legitimate binaries
  # that need robust signal handling (shells, daemons, servers).
  - id: sig-ign-sighup-x64
    desc: SIGHUP signal ignore pattern (x86_64)
    crit: inert
    conf: 0.4
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: hex
      pattern: "BF 01 00 00 00 BE 01 00 00 00"

  - id: sig-ign-sigpipe-x64
    desc: SIGPIPE signal ignore pattern (x86_64)
    crit: inert
    conf: 0.4
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: hex
      pattern: "BF 0D 00 00 00 BE 01 00 00 00"

  # === sigchld-handler atomic indicators ===
  - id: sigchild-underscore
    desc: _sigchild string
    crit: inert
    conf: 0.5
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: string
      substr: "_sigchild"

  - id: sigchld-handler-string
    desc: sigchld_handler string
    crit: inert
    conf: 0.5
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: string
      substr: "sigchld_handler"

  - id: handle-sigchld-string
    desc: handle_sigchld string
    crit: inert
    conf: 0.5
    for: [elf, macho]
    platforms: [linux, macos, unix]
    if:
      type: string
      substr: "handle_sigchld"

composite_rules:
  # NOTE: fork/daemon are basic process primitives used by many legitimate
  # system tools, servers, and build utilities. Downgraded to inert.
  - id: daemon-fork
    desc: "Process forking for daemon behavior"
    crit: inert
    conf: 0.3
    attack: "T1543"
    for: [elf, macho]
    platforms: [linux, macos]
    needs: 1
    any:
      - id: fork-symbol
      - id: daemon-symbol

  # Signal function composite
  - id: signal-function
    desc: Signal handling function
    crit: inert
    conf: 0.3
    for: [elf, macho]
    platforms: [linux, macos, unix]
    needs: 1
    any:
      - id: signal-symbol
      - id: sigaction-symbol

  # NOTE: Signal ignore patterns are common in legitimate binaries.
  - id: sig-ign-pattern
    desc: Signal ignore byte pattern (x86_64)
    crit: inert
    conf: 0.4
    for: [elf, macho]
    platforms: [linux, macos, unix]
    needs: 1
    any:
      - id: sig-ign-sighup-x64
      - id: sig-ign-sigpipe-x64

  # Signal ignore for daemon (migrated from YARA)
  - id: signal-ignore-pattern
    desc: "Signal handler setup (daemon persistence"
    crit: inert
    conf: 0.3
    attack: "T1543"
    for: [elf, macho]
    platforms: [linux, macos, unix]
    all:
      - id: signal-function
      - id: sig-ign-pattern

  - id: sigchld-handler
    desc: "Custom SIGCHLD handler (child process"
    crit: notable
    conf: 0.6
    attack: "T1543"
    for: [elf, macho]
    platforms: [linux, macos, unix]
    needs: 1
    any:
      - id: sigchild-underscore
      - id: sigchld-handler-string
      - id: handle-sigchld-string

  # NOTE: Daemon behavior is extremely common in legitimate software - system
  # services, build tools, compilers, servers, shells. The individual components
  # (/dev/null, fork, setsid) are universal primitives. Downgraded to inert.
  # For truly malicious daemon activity, combine with C2, credential access,
  # or other hostile indicators in a separate composite.
  - id: full-daemon
    desc: "Full daemon behavior (fork +"
    crit: inert
    conf: 0.3
    attack: "T1543"
    mbc: "F0006"
    for: [elf]
    platforms: [linux]
    all:
      - id: daemon-dev-null
    any:
      - id: daemon-fork
      - id: daemon-setsid

  # NOTE: Since daemon-proc-self is now inert (Go uses /proc/self legitimately),
  # this composite needs additional indicators to be meaningful.
  - id: stealth-daemon
    desc: "Stealthy daemon (daemon + proc"
    crit: notable
    conf: 0.5
    attack: "T1543"
    mbc: "F0006"
    for: [elf]
    platforms: [linux]
    all:
      - id: daemon-proc-self
    any:
      - id: daemon-fork
      - id: daemon-setsid

  # Fork + system() + randomized timing = persistent daemon with randomized execution
  # Complexity: all(3) + for(1) = 4 (meets hostile threshold)
  - id: fork-random-exec-daemon
    desc: Forked daemon with randomized command execution
    crit: suspicious
    conf: 0.85
    attack: "T1543"
    for: [elf, macho, c, objectivec]
    all:
      - id: cap/process/fork/clone/fork
      - id: cap/exec/command/shell/sleep-format-exec
      - id: cap/os/random/crypto/seeded-random

  # macOS double-fork daemon pattern
  # This is the classic fork() -> setsid() -> fork() -> umask() -> chdir() pattern
  - id: macos-double-fork-daemon
    desc: "macOS double-fork daemon pattern (fork"
    crit: suspicious
    conf: 0.85
    attack: "T1543"
    mbc: "F0006"
    for: [macho]
    platforms: [macos]
    all:
      - id: fork-symbol
      - id: daemon-setsid
    any:
      - id: daemon-umask
      - id: daemon-chdir-root
