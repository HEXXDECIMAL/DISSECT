# Registry Access via Script
# Detects JavaScript/VBScript registry manipulation
# Generic indicator for persistence and configuration modification

traits:
  - id: script-regwrite
    desc: Script registry write
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "RegWrite"
    notes: "Registry write operation (persistence/configuration)"
    attack: "T1547.001"
    mbc: "F0006"

  - id: script-regread
    desc: Script registry read
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "RegRead"
    notes: "Registry read operation (data exfiltration)"
    attack: "T1012"
    mbc: "E1563"

  - id: script-regdelete
    desc: Script registry delete
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "RegDelete"
    notes: "Registry delete operation (anti-forensics/cleanup)"
    attack: "T1562.004"
    mbc: "E1006"

  - id: hkey-local-machine
    desc: HKEY_LOCAL_MACHINE
    crit: inert
    conf: 0.5
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "HKEY_LOCAL_MACHINE"
        - substr: "HKLM"
    notes: "Registry HKEY_LOCAL_MACHINE access (system-wide)"
    attack: "T1012"

  - id: hkey-current-user
    desc: HKEY_CURRENT_USER
    crit: inert
    conf: 0.5
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "HKEY_CURRENT_USER"
        - substr: "HKCU"
    notes: "Registry HKEY_CURRENT_USER access (user-specific)"
    attack: "T1012"

  - id: run-key-reference
    desc: Registry Run key
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "\\Run"
        - substr: "\\RunOnce"
    notes: "Registry Run/RunOnce key (persistence mechanism)"
    attack: "T1547.001"
    mbc: "F0006"

composite_rules:
  - id: script-registry-operations
    desc: Script registry manipulation
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    attack: "T1012"
    mbc: "E1563"
    notes: |
      Registry operations via script detected.

      Indicates:
      - Configuration modification
      - System settings changes
      - Credential storage access
      - Anti-analysis/anti-forensics

    count_min: 2
    any:
      - id: script-regwrite
      - id: script-regread
      - id: script-regdelete

  - id: script-registry-persistence
    desc: Script registry persistence
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    attack: "T1547.001"
    mbc: "F0006"
    notes: |
      Registry persistence mechanism detected.

      Combines registry write with Run key modification.

      Indicates:
      - Persistence installation
      - Automatic startup on reboot
      - System-wide execution

    all:
      - id: script-regwrite
      - id: run-key-reference

  - id: script-registry-cleanup
    desc: Script registry cleanup
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    attack: "T1562.004"
    mbc: "E1006"
    notes: |
      Registry deletion/cleanup detected.

      Indicates:
      - Anti-forensics
      - Trace removal
      - Evidence destruction
      - Evasion awareness

    all:
      - id: script-regdelete
      - id: obj/anti-forensics

