# Persistence - Shell Configuration Files
# ATT&CK: T1546.004 (Unix Shell Configuration Modification)

traits:
  # Bash persistence
  - id: bash-profile
    desc: .bash_profile shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      substr: ".bash_profile"
    downgrade:
      any:
        - id: cap/exec/load/library::system-lib-marker

  - id: bashrc
    desc: .bashrc shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      substr: ".bashrc"
    downgrade:
      any:
        - id: cap/exec/load/library::system-lib-marker

  - id: bash-login
    desc: .bash_login shell configuration file
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      substr: ".bash_login"

  - id: bash-logout
    desc: .bash_logout shell configuration file
    crit: notable
    conf: 0.85
    attack: T1546.004
    if:
      type: string
      substr: ".bash_logout"

  - id: profile
    desc: .profile shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      # Match .profile as standalone or in a path context, not as part of compound words
      # This avoids matching things like "vaGetProfileSupport" or "ProfileManager"
      regex: '(?:^|[/~])\.profile$|\.profile(?:\s|$)'
    downgrade:
      any:
        - id: cap/exec/load/library::system-lib-marker
        - id: cap/exec/load/video-lib-marker

  - id: etc-profile
    desc: /etc/profile system-wide shell configuration
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      substr: "/etc/profile"

  - id: etc-bashrc
    desc: /etc/bashrc system-wide shell configuration
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      substr: "/etc/bashrc"

  # Zsh persistence
  - id: zshrc
    desc: .zshrc shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      substr: ".zshrc"
    downgrade:
      any:
        - id: cap/exec/load/library::system-lib-marker

  - id: zprofile
    desc: .zprofile shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      substr: ".zprofile"
    downgrade:
      any:
        - id: cap/exec/load/library::system-lib-marker

  - id: zlogin
    desc: .zlogin shell configuration file
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      substr: ".zlogin"

  - id: zlogout
    desc: .zlogout shell configuration file
    crit: notable
    conf: 0.85
    attack: T1546.004
    if:
      type: string
      substr: ".zlogout"

  - id: etc-zshrc
    desc: /etc/zshrc system-wide shell configuration
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      substr: "/etc/zshrc"

  # Hardcoded paths (more suspicious)
  - id: hardcoded-profile
    desc: Hardcoded path to .profile file
    crit: notable
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.profile'

  - id: hardcoded-bashrc
    desc: Hardcoded path to .bashrc file
    crit: notable
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.bashrc'

  - id: hardcoded-zshrc
    desc: Hardcoded path to .zshrc file
    crit: notable
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.zshrc'

  # Exclusion patterns
  - id: posixly-correct
    desc: POSIXLY_CORRECT environment variable (legitimate bash
    crit: inert
    conf: 0.3
    if:
      type: string
      substr: "POSIXLY_CORRECT"

  - id: cshrc-file
    desc: .cshrc file (C shell, not
    crit: notable
    conf: 1.0
    if:
      type: string
      substr: ".cshrc"

  - id: tcsh-keyword
    desc: tcsh keyword (shell name)
    crit: notable
    conf: 1.0
    if:
      type: string
      word: "tcsh"

composite_rules:
  - id: bash-files
    desc: Bash shell configuration files
    crit: notable
    conf: 0.7
    attack: T1546.004
    any:
      - id: bash-profile
      - id: bash-login
      - id: profile
      - id: bashrc

  - id: multi-file-access
    desc: Multiple shell config files accessed
    crit: notable
    conf: 0.9
    attack: T1546.004
    needs: 3
    any:
      - id: bash-profile
      - id: bash-login
      - id: profile
      - id: bashrc
      - id: zshrc
      - id: zprofile
    none:
      - id: posixly-correct
      - id: cshrc-file
      - id: tcsh-keyword

  - id: elf-hardcoded
    desc: Binary with hardcoded shell config
    crit: notable
    conf: 0.95
    for: [elf, macho]
    attack: T1546.004
    any:
      - id: hardcoded-profile
      - id: hardcoded-bashrc
      - id: hardcoded-zshrc
