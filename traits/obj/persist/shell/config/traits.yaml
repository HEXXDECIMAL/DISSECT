# Persistence - Shell Configuration Files
# ATT&CK: T1546.004 (Unix Shell Configuration Modification)

traits:
  # Bash persistence
  - id: bash-profile
    description: .bash_profile shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".bash_profile"
    downgrade:
      any:
        - id: cap/exec/load/system-lib-marker

  - id: bashrc
    description: .bashrc shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".bashrc"
    downgrade:
      any:
        - id: cap/exec/load/system-lib-marker

  - id: bash-login
    description: .bash_login shell configuration file
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: ".bash_login"

  - id: bash-logout
    description: .bash_logout shell configuration file
    crit: notable
    conf: 0.85
    attack: T1546.004
    if:
      type: string
      exact: ".bash_logout"

  - id: profile
    description: .profile shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      # Match .profile as standalone or in a path context, not as part of compound words
      # This avoids matching things like "vaGetProfileSupport" or "ProfileManager"
      regex: '(?:^|[/~])\.profile$|\.profile(?:\s|$)'
    downgrade:
      any:
        - id: cap/exec/load/system-lib-marker
        - id: cap/exec/load/video-lib-marker

  - id: etc-profile
    description: /etc/profile system-wide shell configuration
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: "/etc/profile"

  - id: etc-bashrc
    description: /etc/bashrc system-wide shell configuration
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: "/etc/bashrc"

  # Zsh persistence
  - id: zshrc
    description: .zshrc shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".zshrc"
    downgrade:
      any:
        - id: cap/exec/load/system-lib-marker

  - id: zprofile
    description: .zprofile shell configuration file
    crit: notable
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".zprofile"
    downgrade:
      any:
        - id: cap/exec/load/system-lib-marker

  - id: zlogin
    description: .zlogin shell configuration file
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: ".zlogin"

  - id: zlogout
    description: .zlogout shell configuration file
    crit: notable
    conf: 0.85
    attack: T1546.004
    if:
      type: string
      exact: ".zlogout"

  - id: etc-zshrc
    description: /etc/zshrc system-wide shell configuration
    crit: notable
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: "/etc/zshrc"

  # Hardcoded paths (more suspicious)
  - id: hardcoded-profile
    description: Hardcoded path to .profile file
    crit: notable
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.profile'

  - id: hardcoded-bashrc
    description: Hardcoded path to .bashrc file
    crit: notable
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.bashrc'

  - id: hardcoded-zshrc
    description: Hardcoded path to .zshrc file
    crit: notable
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.zshrc'

  # Exclusion patterns
  - id: posixly-correct
    description: POSIXLY_CORRECT environment variable (legitimate bash
    crit: inert
    conf: 1.0
    if:
      type: string
      exact: "POSIXLY_CORRECT"

  - id: cshrc-file
    description: .cshrc file (C shell, not
    crit: inert
    conf: 1.0
    if:
      type: string
      exact: ".cshrc"

  - id: tcsh-keyword
    description: tcsh keyword (shell name)
    crit: inert
    conf: 1.0
    if:
      type: string
      word: "tcsh"

composite_rules:
  - id: bash-files
    description: Bash shell configuration files
    crit: notable
    conf: 0.7
    attack: T1546.004
    any:
      - id: bash-profile
      - id: bash-login
      - id: profile
      - id: bashrc

  - id: multi-file-access
    description: Multiple shell config files accessed
    crit: notable
    conf: 0.9
    attack: T1546.004
    count_min: 3
    any:
      - id: bash-profile
      - id: bash-login
      - id: profile
      - id: bashrc
      - id: zshrc
      - id: zprofile
    none:
      - id: posixly-correct
      - id: cshrc-file
      - id: tcsh-keyword

  - id: elf-hardcoded
    description: Binary with hardcoded shell config
    crit: notable
    conf: 0.95
    for: [elf, macho]
    attack: T1546.004
    any:
      - id: hardcoded-profile
      - id: hardcoded-bashrc
      - id: hardcoded-zshrc
