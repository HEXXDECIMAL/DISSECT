# Complete Backdoor Installation Chains
# Detects multi-step attack sequences combining account creation with persistent access
# Generic indicator for comprehensive system compromise

composite_rules:
  - id: account-ssh-key-injection
    desc: Account creation with SSH key injection
    crit: hostile
    conf: 0.92
    for: [elf, shell]
    attack: "T1098.004"
    mbc: "E1015"
    all:
      - id: obj/persist/account/useradd-command
      - id: obj/persist/account/user-bash-shell
      - id: obj/lateral/ssh-backdoor-installation/authorized-keys-path

  - id: password-set-privilege-escalation
    desc: Password setting with privilege escalation
    crit: hostile
    conf: 0.90
    for: [elf, shell]
    attack: "T1136.001"
    mbc: "E1015"
    all:
      - id: obj/persist/account/chpasswd-command
      - id: obj/persist/account/privilege-escalation-setup

  - id: complete-backdoor-installation
    desc: Complete backdoor account and SSH setup
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1098.004"
    mbc: "E1015"
    all:
      - id: obj/persist/account/account-creation
      - id: obj/persist/account/privilege-escalation-setup
      - id: obj/lateral/ssh-backdoor-installation/authorized-keys-path
      - id: obj/lateral/ssh-backdoor-installation/sshd-restart
