# Complete Backdoor Installation Chains
# Detects multi-step attack sequences combining account creation with persistent access
# Generic indicator for comprehensive system compromise

composite_rules:
  - id: account-ssh-key-injection
    desc: Account creation with SSH key injection
    crit: hostile
    conf: 0.92
    for: [elf, shell]
    attack: "T1098.004"
    mbc: "E1015"
    notes: |
      Complete account creation and SSH key injection pattern.
      Combines:
      - New user account creation with bash shell
      - SSH authorized_keys file modification
      - Persistent passwordless SSH access installation

      This indicates:
      - Permanent backdoor account with SSH access
      - Attacker-controlled system access
      - Sophisticated persistence mechanism
    all:
      - id: obj/persist/account-privilege-escalation/useradd-command
      - id: obj/persist/account-privilege-escalation/user-bash-shell
      - id: obj/lateral/ssh-backdoor-installation/authorized-keys-path

  - id: password-set-privilege-escalation
    desc: Password setting with privilege escalation
    crit: hostile
    conf: 0.90
    for: [elf, shell]
    attack: "T1136.001"
    mbc: "E1015"
    notes: |
      Automated account setup with privilege elevation.
      Combines:
      - Password automated setting (chpasswd/openssl)
      - Privilege escalation setup (sudoers/wheel)

      This indicates:
      - Complete backdoor account creation
      - Privileged access installation
      - Automated account setup
    all:
      - id: obj/persist/account-privilege-escalation/chpasswd-command
      - id: obj/persist/account-privilege-escalation/privilege-escalation-setup

  - id: complete-backdoor-installation
    desc: Complete backdoor account and SSH setup
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1098.004"
    mbc: "E1015"
    notes: |
      Complete multi-vector backdoor installation pattern.
      Combines all persistence techniques:
      - Account creation with bash shell
      - Automated password setting
      - Privilege escalation (sudoers/wheel)
      - SSH key injection for passwordless access
      - SSH daemon restart/reload for activation

      This indicates:
      - Comprehensive system compromise
      - Permanent attacker access guaranteed
      - Professional-grade malware installation
      - Sophisticated attack chain execution
    all:
      - id: obj/persist/account-privilege-escalation/account-creation
      - id: obj/persist/account-privilege-escalation/privilege-escalation-setup
      - id: obj/lateral/ssh-backdoor-installation/authorized-keys-path
      - id: obj/lateral/ssh-backdoor-installation/sshd-restart
