# LaunchDaemon/LaunchAgent Persistence (macOS)
# MBC: B0028 (Scheduled Task/Job)
# ATT&CK: T1543.004

traits:
  - id: launch-agents
    desc: LaunchAgents directory (user-level services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      substr: "LaunchAgents"

  - id: launch-daemons
    desc: LaunchDaemons directory (system-level services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      substr: "LaunchDaemons"

  - id: launchctl-command
    desc: launchctl command (manage launchd services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      word: "launchctl"

  - id: plist-extension
    desc: .plist file extension (property list)
    crit: notable
    conf: 0.6
    attack: T1543.004
    if:
      type: string
      substr: ".plist"

  - id: run-at-load
    desc: RunAtLoad key (start service at
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      substr: "RunAtLoad"

composite_rules:
  - id: launchd
    desc: macOS launchd persistence (2+ indicators)
    crit: notable
    conf: 0.66
    mbc: B0028
    attack: T1543.004
    count_min: 2
    any:
      - id: launch-agents
      - id: launch-daemons
      - id: launchctl-command
      - id: plist-extension
      - id: run-at-load
