# Message Queue Threading Pattern
# Detects server-based malware using message queues
# Generic indicator for RATs, command servers

traits:
  - id: peek-message-api
    desc: Message queue polling (PeekMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "PeekMessageA"
    attack: "T1129"
    mbc: "C0019"

  - id: post-message-api
    desc: Message queue posting (PostThreadMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "PostThreadMessageA"
    attack: "T1129"
    mbc: "C0019"

  - id: get-message-api
    desc: Message queue retrieval (GetMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "GetMessageA"
    attack: "T1129"
    mbc: "C0019"

composite_rules:
  - id: message-queue-threading
    desc: Message queue-based thread communication
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    all:
      - id: cap/process/create
      - id: cap/process/threading
    any:
      - id: peek-message-api
      - id: get-message-api
    needs: 1

  - id: message-based-command-server
    desc: Message queue command server pattern
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    all:
      - id: message-queue-threading
      - id: post-message-api

  - id: message-dispatch-framework
    desc: Sophisticated message dispatch framework
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    all:
      - id: message-based-command-server
      - id: cap/exec/command

