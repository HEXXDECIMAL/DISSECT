# Message Queue Threading Pattern
# Detects server-based malware using message queues
# Generic indicator for RATs, command servers

traits:
  - id: peek-message-api
    desc: Message queue polling (PeekMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "PeekMessageA"
    notes: "Polls Windows message queue without blocking"
    attack: "T1129"
    mbc: "C0019"

  - id: post-message-api
    desc: Message queue posting (PostThreadMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "PostThreadMessageA"
    notes: "Posts messages to thread queue for IPC"
    attack: "T1129"
    mbc: "C0019"

  - id: get-message-api
    desc: Message queue retrieval (GetMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "GetMessageA"
    notes: "Retrieves and waits for messages from queue"
    attack: "T1129"
    mbc: "C0019"

composite_rules:
  - id: message-queue-threading
    desc: Message queue-based thread communication
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    notes: |
      Detects message queue-based inter-thread communication.

      Pattern: CreateThread + PeekMessageA/GetMessageA + PostThreadMessageA

      Alternative to direct injection model:
      - Creates worker threads
      - Communicates via message queues
      - Server-like command processing
      - Avoids direct API calls that trigger detection

      Indicates:
      - RAT/Remote Access Trojan
      - C&C command processing
      - Sophisticated malware avoiding direct injection

      Seen in:
      - Advanced RATs (AsyncRAT variants)
      - Loader malware (Chrysalis loader2)
      - Command-and-control servers

    all:
      - id: cap/process/create
      - id: cap/process/threading
    any:
      - id: peek-message-api
      - id: get-message-api
    count_min: 1

  - id: message-based-command-server
    desc: Message queue command server pattern
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    notes: |
      Combines message posting and retrieval for IPC.
      Indicates bidirectional command communication.

    all:
      - id: message-queue-threading
      - id: post-message-api

  - id: message-dispatch-framework
    desc: Sophisticated message dispatch framework
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    notes: |
      Complete message-based command dispatch system.
      Indicates professional malware infrastructure.

    all:
      - id: message-based-command-server
      - id: cap/exec/command

