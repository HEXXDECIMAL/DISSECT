# Advanced Windows Synchronization Primitives
# Detects sophisticated multi-threaded architecture
# Generic indicator for professional malware servers

traits:
  - id: srw-lock-acquire
    desc: SRW lock acquisition
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "AcquireSRWLockExclusive"
    notes: "Acquires exclusive reader/writer lock"
    attack: "T1129"

  - id: srw-lock-release
    desc: SRW lock release
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "ReleaseSRWLockExclusive"
    notes: "Releases exclusive reader/writer lock"
    attack: "T1129"

  - id: srw-lock-shared
    desc: SRW shared lock read
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      any:
        - exact: "AcquireSRWLockShared"
        - exact: "ReleaseSRWLockShared"
    notes: "Shared reader/writer lock operations"
    attack: "T1129"

  - id: condition-variable-wait
    desc: Condition variable wait
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      any:
        - exact: "SleepConditionVariableSRW"
        - exact: "SleepConditionVariableCS"
    notes: "Thread sleeps on condition variable"
    attack: "T1129"

  - id: condition-variable-signal
    desc: Condition variable signal
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      any:
        - exact: "WakeConditionVariable"
        - exact: "WakeAllConditionVariable"
    notes: "Signals waiting threads via condition variable"
    attack: "T1129"

  - id: slist-initialize
    desc: Interlocked SList init
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "InitializeSListHead"
    notes: "Initializes interlocked singly-linked list"
    attack: "T1129"

  - id: slist-operations
    desc: Interlocked SList ops
    crit: notable
    conf: 0.65
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      any:
        - substr: "InterlockedPushEntrySList"
        - substr: "InterlockedPopEntrySList"
        - substr: "InterlockedFlushSList"
    notes: "Interlocked SList push/pop/flush operations"
    attack: "T1129"

composite_rules:
  - id: srw-lock-ops
    desc: SRW lock operations
    crit: suspicious
    conf: 0.7
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    notes: |
      Reader/Writer lock synchronization patterns.

      Indicates:
      - Multi-reader or exclusive writer access
      - Shared resource protection
      - Sophisticated thread coordination

    count_min: 2
    any:
      - id: srw-lock-acquire
      - id: srw-lock-release
      - id: srw-lock-shared

  - id: condition-variable-ops
    desc: Condition variable ops
    crit: suspicious
    conf: 0.7
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    notes: |
      Condition variable synchronization patterns.

      Indicates:
      - Thread signaling mechanisms
      - Producer/consumer patterns
      - Event-driven thread coordination

    any:
      - id: condition-variable-wait
      - id: condition-variable-signal

  - id: slist-sync-ops
    desc: Interlocked SList sync
    crit: suspicious
    conf: 0.7
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    notes: |
      Interlocked singly-linked list operations.

      Indicates:
      - Lock-free data structures
      - High-performance queuing
      - Sophisticated synchronization

    any:
      - id: slist-initialize
      - id: slist-operations

  - id: advanced-sync-primitives
    desc: Advanced sync primitives
    crit: suspicious
    conf: 0.75
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    notes: |
      Combination of advanced synchronization primitives.
      Indicates professional-grade multi-threaded implementation.

    count_min: 2
    any:
      - id: srw-lock-ops
      - id: condition-variable-ops
      - id: slist-sync-ops

  - id: advanced-sync-server
    desc: Advanced server infrastructure
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "E1030"
    notes: |
      Professional multi-threaded server using advanced synchronization.
      Combines thread creation with sophisticated coordination primitives.

      Indicates:
      - Command server infrastructure (C2, RAT)
      - Distributed ransomware workers
      - Botnet node management
      - Professional malware development

      Seen in:
      - Darkside ransomware (SRW + condition variables)
      - Advanced RAT command servers
      - Professional botnet infrastructure

    all:
      - id: cap/process/create
      - id: advanced-sync-primitives

