# Fiber Local Storage Operations
# Detects use of FLS instead of TLS
# Generic indicator for sophisticated thread pool malware

traits:
  - id: fls-alloc-api
    desc: Fiber local storage allocation (FlsAlloc)
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FlsAlloc"
    attack: "T1129"

  - id: fls-getvalue-api
    desc: Fiber local storage retrieval (FlsGetValue)
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FlsGetValue"
    attack: "T1129"

  - id: fls-setvalue-api
    desc: Fiber local storage assignment (FlsSetValue)
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FlsSetValue"
    attack: "T1129"

  - id: fls-free-api
    desc: Fiber local storage deallocation (FlsFree)
    crit: inert
    conf: 0.6
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FlsFree"

composite_rules:
  - id: fiber-local-storage-ops
    desc: Fiber-based thread local storage
    crit: suspicious
    conf: 0.75
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    needs: 2
    any:
      - id: fls-alloc-api
      - id: fls-getvalue-api
      - id: fls-setvalue-api

  - id: thread-pool-based-malware
    desc: Thread pool with fiber-based scheduling
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    all:
      - id: fiber-local-storage-ops
      - id: cap/process/thread/create

  - id: fiber-dispatch-framework
    desc: Fiber-based dispatch and scheduling framework
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    all:
      - id: thread-pool-based-malware
      - id: cap/exec/command
