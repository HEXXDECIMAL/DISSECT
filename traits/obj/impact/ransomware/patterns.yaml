# Ransomware Detection Patterns
# ATT&CK: T1486 (Data Encrypted for Impact)
# Detects file encryption, key generation, and ransom note patterns

defaults:
  attack: "T1486"

traits:
  # === RSA key handling (atomic) ===
  - id: rsa-keyword
    desc: RSA keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "RSA"

  - id: generate-keypair
    desc: generateKeyPair function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "generateKeyPair"

  - id: public-encrypt
    desc: publicEncrypt function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "publicEncrypt"

  - id: private-decrypt
    desc: privateDecrypt function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "privateDecrypt"

  - id: begin-rsa-key
    desc: BEGIN RSA key header
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "-----BEGIN RSA"

  - id: begin-public-key
    desc: BEGIN PUBLIC KEY header
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "-----BEGIN PUBLIC KEY"

  - id: crypto-module
    desc: crypto module
    crit: inert
    conf: 0.3
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "crypto"

  # === File iteration (atomic) ===
  - id: readdir-sync
    desc: readdirSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "readdirSync"

  - id: walk-sync
    desc: walkSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "walkSync"

  - id: glob-module
    desc: glob module
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "glob"

  - id: readdir-fn
    desc: readdir function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "readdir"

  - id: os-walk
    desc: os.walk function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "os.walk"

  # === Encryption (atomic) ===
  - id: encrypt-fn
    desc: encrypt function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "encrypt"

  - id: cipher-keyword
    desc: cipher keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "cipher"

  - id: create-cipheriv
    desc: createCipheriv function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "createCipheriv"

  - id: aes-keyword
    desc: AES keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "AES"

  # === File write (atomic) ===
  - id: writefile-sync
    desc: writeFileSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "writeFileSync"

  - id: writefile-fn
    desc: writeFile function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "writeFile"

  - id: open-paren
    desc: open( function
    crit: inert
    conf: 0.3
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "open("

  # === Ransom note (atomic) ===
  - id: files-encrypted-msg
    desc: Files encrypted message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "your files have been encrypted"
      case_insensitive: true

  - id: pay-bitcoin-msg
    desc: Pay bitcoin message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "pay bitcoin"
      case_insensitive: true

  - id: pay-btc-msg
    desc: Pay BTC message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "pay btc"
      case_insensitive: true

  - id: decrypt-files-msg
    desc: Decrypt files message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "decrypt your files"
      case_insensitive: true

  - id: bitcoin-wallet-msg
    desc: Bitcoin wallet message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "bitcoin wallet"
      case_insensitive: true

  - id: restore-files-msg
    desc: Restore files message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "restore your files"
      case_insensitive: true

  - id: send-payment-msg
    desc: Send payment message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "send payment"
      case_insensitive: true

  - id: ransom-identifier
    desc: Ransom-related terminology
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "(?i)\\bransom\\b"

  # === File rename (atomic) ===
  - id: rename-sync
    desc: renameSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "renameSync"

  - id: rename-fn
    desc: rename( function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "rename("

  - id: os-rename
    desc: os.rename function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "os.rename"

  # === Encrypted extensions (atomic) ===
  - id: ext-encrypted
    desc: .encrypted extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".encrypted"

  - id: ext-locked
    desc: .locked extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".locked"

  - id: ext-enc
    desc: .enc extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".enc"

  - id: ext-crypt
    desc: .crypt extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".crypt"

  # === Medusa ransomware (atomic) ===
  - id: medusa-name
    desc: Medusa name
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: medusa
      case_insensitive: true

  - id: polymorphic-keyword
    desc: polymorphic keyword
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: polymorphic
      case_insensitive: true

  - id: mutate-keyword
    desc: mutate keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript]
    if:
      type: string
      exact: mutate

  # === Shadow copy deletion (atomic) ===
  - id: vssadmin-delete
    desc: vssadmin delete shadows
    crit: inert
    conf: 0.7
    attack: "T1490"
    for: [javascript, powershell, shell]
    if:
      type: string
      regex: 'vssadmin\s+delete\s+shadows'

  - id: wmic-shadowcopy
    desc: wmic shadowcopy delete
    crit: inert
    conf: 0.7
    attack: "T1490"
    for: [javascript, powershell, shell]
    if:
      type: string
      regex: 'wmic\s+shadowcopy\s+delete'

  - id: bcdedit-recovery
    desc: bcdedit recoveryenabled no
    crit: inert
    conf: 0.7
    attack: "T1490"
    for: [javascript, powershell, shell]
    if:
      type: string
      regex: "bcdedit.{0,30}recoveryenabled.{0,30}no"

composite_rules:
  # RSA key operations
  - id: rsa-key-operations
    desc: RSA key operations
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    count_min: 2
    any:
      - id: rsa-keyword
      - id: generate-keypair
      - id: public-encrypt
      - id: private-decrypt
      - id: begin-rsa-key
      - id: begin-public-key

  # RSA key handling with crypto
  - id: rsa-key-handling
    desc: RSA key generation or handling
    crit: notable
    conf: 0.8
    for: [javascript, typescript, python]
    all:
      - id: crypto-module
      - id: rsa-key-operations

  # File iteration
  - id: file-iteration
    desc: File iteration functions
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: readdir-sync
      - id: walk-sync
      - id: glob-module
      - id: readdir-fn
      - id: os-walk

  # Encryption functions
  - id: encryption-functions
    desc: Encryption functions
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: encrypt-fn
      - id: cipher-keyword
      - id: create-cipheriv
      - id: aes-keyword

  # File write functions
  - id: file-write-functions
    desc: File write functions
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: writefile-sync
      - id: writefile-fn
      - id: open-paren

  # File encryption loop
  - id: file-encryption-loop
    desc: File iteration with encryption (ransomware
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, python]
    all:
      - id: file-iteration
      - id: encryption-functions
      - id: file-write-functions

  # Ransom note
  - id: ransom-note
    desc: Ransom note text patterns
    crit: suspicious
    conf: 0.95
    for: [javascript, typescript, python, shell]
    count_min: 2
    any:
      - id: files-encrypted-msg
      - id: pay-bitcoin-msg
      - id: pay-btc-msg
      - id: decrypt-files-msg
      - id: bitcoin-wallet-msg
      - id: restore-files-msg
      - id: send-payment-msg

  # Rename functions
  - id: rename-functions
    desc: File rename functions
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: rename-sync
      - id: rename-fn
      - id: os-rename

  # Encrypted extensions
  - id: encrypted-extensions
    desc: Encrypted file extensions
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: ext-encrypted
      - id: ext-locked
      - id: ext-enc
      - id: ext-crypt

  # Extension change
  - id: extension-change
    desc: Changes file extensions (potential ransomware)
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript, python]
    all:
      - id: rename-functions
      - id: encrypted-extensions

  # Medusa pattern
  - id: medusa-pattern
    desc: Medusa ransomware implementation indicators
    crit: notable
    conf: 0.95
    for: [javascript, typescript]
    all:
      - id: medusa-name
    count_min: 1
    any:
      - id: polymorphic-keyword
      - id: mutate-keyword
      - id: rsa-keyword

  # Shadow copy deletion
  - id: shadow-delete
    desc: Shadow copy deletion (ransomware preparation)
    crit: suspicious
    conf: 0.95
    attack: "T1490"
    for: [javascript, powershell, shell]
    count_min: 1
    any:
      - id: vssadmin-delete
      - id: wmic-shadowcopy
      - id: bcdedit-recovery

  # In-place file encryption ransomware (Python/Fernet)
  # Combines directory traversal + in-place file write + encryption
  - id: inplace-encrypt
    desc: In-place file encryption ransomware
    crit: hostile
    conf: 0.95
    for: [python]
    all:
      - id: cap/fs/directory/traverse/traverse-walk
      - id: cap/fs/file/open/binary-rw
    any:
      - id: cap/crypto/symmetric/fernet/encrypt
      - id: cap/crypto/symmetric/fernet/class-usage
