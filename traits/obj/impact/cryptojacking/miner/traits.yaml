# Impact - Cryptojacking / Cryptocurrency Mining
# ATT&CK: T1496 (Resource Hijacking)
# MBC: B0036 (Cryptomining)

traits:
  # === Atomic: Mining Protocols ===

  - id: stratum-protocol
    desc: Stratum mining protocol reference
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      regex: "stratum(\\+(tcp|ssl|tls))?://"

  # === Atomic: Mining Pools ===

  - id: pool-c3pool
    desc: C3Pool mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "c3pool"

  - id: pool-f2pool
    desc: F2Pool mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "f2pool"

  - id: pool-hashvault
    desc: HashVault mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "hashvault"

  - id: pool-monerohash
    desc: MoneroHash mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "monerohash"

  - id: pool-xmrpool
    desc: XMRPool mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "xmrpool"

  - id: pool-supportxmr
    desc: SupportXMR mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "supportxmr"

  - id: pool-minergate
    desc: MinerGate mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "minergate"

  - id: pool-crypto-pool
    desc: Crypto-pool mining pool
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      substr: "crypto-pool"

  - id: pool-moneropool
    desc: Moneropool mining pool
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      substr: "moneropool"

  # === Atomic: Mining Software ===

  - id: xmrig-ref
    desc: XMRig miner reference
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      substr: "xmrig"
      case_insensitive: true

  - id: cryptonight
    desc: CryptoNight algorithm reference
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      regex: "[Cc]rypto[Nn]ight"

  - id: monero-lower
    desc: monero word (lowercase)
    crit: notable
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "monero"

  - id: monero-title
    desc: Monero word (title case)
    crit: notable
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "Monero"

  - id: monero-upper
    desc: MONERO word (uppercase)
    crit: notable
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "MONERO"

  - id: xmr-ticker
    desc: XMR ticker symbol
    crit: notable
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "XMR"

  # === Atomic: Mining Configuration ===

  - id: donate-level
    desc: Mining donate-level configuration
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      substr: "--donate-level"

  - id: tls-fingerprint
    desc: Mining TLS fingerprint option
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    if:
      type: string
      substr: "--tls-fingerprint"

  - id: miner-name
    desc: Miner name configuration
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    if:
      type: string
      substr: "miner_name"

  - id: miner-url
    desc: Miner URL configuration
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    if:
      type: string
      substr: "miner_url"

  - id: normal-hashing
    desc: Normal hashing configuration
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    if:
      type: string
      substr: '"normalHashing": true,'

  # === Atomic: Memory Optimization ===

  - id: hugepages
    desc: Huge pages memory configuration
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    for: [elf]
    if:
      type: string
      substr: "vm.nr_hugepages"

  - id: nmi-watchdog
    desc: NMI watchdog disable (mining optimization)
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    for: [elf]
    if:
      type: string
      substr: "kernel.nmi_watchdog"

  # === Atomic: Argon2 (Memory-Hard) ===

  - id: argon2d
    desc: Argon2d hashing algorithm
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      substr: "argon2d"

  # === Atomic: Mining Indicators ===

  # NOTE: "wallet" is too generic - appears in many legitimate contexts.
  # Only meaningful with other mining indicators.
  - id: wallet-ref
    desc: Wallet reference (mining context)
    crit: notable
    conf: 0.3
    attack: "T1496"
    # Restrict to languages where miners typically appear, avoid iOS/macOS libraries
    for: [python, shell, javascript, go, c, elf]
    if:
      type: string
      substr: "wallet"

  # NOTE: Go runtime uses /proc/self legitimately for memory management
  # Moved to inert - only meaningful with other mining indicators
  - id: proc-self-ref
    desc: Process self reference
    crit: notable
    conf: 0.3
    if:
      type: string
      substr: "/proc/self"

  # NOTE: "NUMA" can appear in Go and other runtimes for memory optimization.
  # Only meaningful with other mining indicators.
  - id: numa-ref
    desc: NUMA memory architecture reference
    crit: notable
    conf: 0.3
    if:
      type: string
      exact: "NUMA"

composite_rules:
  # Monero reference composite
  - id: monero-ref
    desc: Monero cryptocurrency reference
    crit: notable
    conf: 0.6
    attack: "T1496"
    any:
      - id: monero-lower
      - id: monero-title
      - id: monero-upper
      - id: xmr-ticker

  - id: cryptocurrency-miner
    desc: Cryptocurrency miner detected
    crit: suspicious
    conf: 0.95
    attack: "T1496"
    mbc: "B0036"
    needs: 2
    any:
      - id: stratum-protocol
      - id: pool-c3pool
      - id: pool-f2pool
      - id: pool-hashvault
      - id: pool-monerohash
      - id: pool-xmrpool
      - id: pool-supportxmr
      - id: pool-minergate
      - id: pool-crypto-pool
      - id: pool-moneropool
      - id: xmrig-ref
      - id: cryptonight
      - id: known/malware/miner::cn-variants
      - id: donate-level
      - id: miner-name

  - id: memory-optimized-miner
    desc: Memory-optimized cryptocurrency miner
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    mbc: "B0036"
    for: [elf]
    all:
      - id: hugepages
    any:
      - id: xmrig-ref
      - id: monero-ref
      - id: wallet-ref

  - id: argon2-miner
    desc: Argon2-based cryptocurrency miner
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    mbc: "B0036"
    for: [elf]
    all:
      - id: argon2d
      - id: proc-self-ref
      - id: numa-ref

  # === HOSTILE: Cryptominer Trojan ===
  # Complexity: file_types(+1) + all(+4) = 5 >= 4 ✓
  - id: cryptominer-trojan
    desc: Cryptominer trojan detected
    crit: hostile
    conf: 0.98
    attack: "T1496"
    mbc: "B0036"
    for: [python, shell]
    all:
      - id: xmrig-ref
      - id: pool-supportxmr
      - id: known/malware/miner::monero-wallets
      - id: cap/exec/command/shell::python-os-system

  # Helper: any known mining pool
  - id: known-mining-pool
    desc: Known mining pool detected
    crit: notable
    conf: 0.9
    attack: "T1496"
    any:
      - id: pool-c3pool
      - id: pool-f2pool
      - id: pool-hashvault
      - id: pool-monerohash
      - id: pool-xmrpool
      - id: pool-supportxmr
      - id: pool-minergate
      - id: pool-crypto-pool
      - id: pool-moneropool

  # === HOSTILE: Generic Python Cryptominer Dropper ===
  # Complexity: file_types(+1) + all(+4) = 5 >= 4 ✓
  - id: python-cryptominer-dropper
    desc: Python cryptominer dropper
    crit: hostile
    conf: 0.95
    attack: "T1496"
    mbc: "B0036"
    for: [python]
    all:
      - id: xmrig-ref
      - id: known-mining-pool
      - id: known/malware/miner::monero-wallets
      - id: cap/exec/command/shell::python-os-system

  # === HOSTILE: Stealth Cryptominer Dropper ===
  # Detects cryptominer droppers that execute in stealth mode
  # Pattern: Monero wallet + stealth subprocess execution + chmod executable
  # Complexity: file_types(+1) + all(+4) = 5 >= 4 ✓
  - id: stealth-cryptominer-dropper
    desc: Stealth cryptominer dropper
    crit: hostile
    conf: 0.95
    attack: "T1496"
    mbc: "B0036"
    for: [python]
    all:
      - id: known/malware/miner::monero-wallets
      - id: cap/exec/dropper/stealth::python
      - id: cap/fs/chmod/executable
      - id: cap/exec/dropper/stealth::subprocess-popen
