# Cryptojacking/Miner Detection
# MBC: B0041 (Mining)
# ATT&CK: T1496

traits:
  - id: stratum-tcp
    description: stratum+tcp protocol
    crit: notable
    conf: 0.6
    mbc: "B0041"
    attack: "T1496"
    if:
      type: string
      exact: "stratum+tcp"

  # NOTE: Removed standalone "pool" keyword detection - too many false positives
  # "pool" is ubiquitous in programming (memory pool, thread pool, connection pool)
  # Mining pools are now detected via pool-url pattern or combined with other mining indicators
  - id: pool-url
    description: Mining pool URL pattern
    crit: notable
    conf: 0.7
    if:
      type: string
      # Match pool URLs like pool.example.com or example-pool.com
      regex: "(?:stratum\\+(?:tcp|ssl)://|https?://)[^\\s]+pool[^\\s]*|pool\\.[a-z0-9-]+\\.(?:com|net|org|io)"

  - id: miner-word
    description: miner keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      word: "miner"

  - id: xmrig-str
    description: xmrig reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "xmrig"

  - id: monero-str
    description: monero reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "monero"

  - id: hashrate-str
    description: hashrate keyword
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "hashrate"

  - id: wallet-word
    description: wallet keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      word: "wallet"

  - id: coinhive-str
    description: coinhive reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "coinhive"

  - id: cryptonight-str
    description: cryptonight algorithm
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "cryptonight"

  # === XMRig atomic indicators (legacy) ===
  - id: xmrig-lower
    description: xmrig (lowercase)
    crit: notable
    conf: 0.55
    if:
      type: string
      exact: "xmrig"

  - id: xmrig-pascal
    description: XMRig (PascalCase)
    crit: notable
    conf: 0.55
    if:
      type: string
      exact: "XMRig"

  - id: miner-stratum
    description: Stratum mining protocol
    crit: suspicious
    conf: 0.66
    if:
      type: string
      regex: "stratum\\+tcp://"

composite_rules:
  - id: miner
    description: Cryptocurrency mining patterns
    crit: suspicious
    conf: 0.66
    mbc: "B0041"
    attack: "T1496"
    count_min: 2
    any:
      - id: stratum-tcp
      - id: pool-url
      - id: miner-word
      - id: xmrig-str
      - id: monero-str
      - id: hashrate-str
      - id: wallet-word
      - id: coinhive-str
      - id: cryptonight-str

  # XMRig composite
  - id: miner-xmrig
    description: XMRig cryptocurrency miner reference
    crit: suspicious
    conf: 0.66
    count_min: 1
    any:
      - id: xmrig-lower
      - id: xmrig-pascal
