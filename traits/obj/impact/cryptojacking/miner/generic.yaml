# Cryptojacking/Miner Detection
# MBC: B0041 (Mining)
# ATT&CK: T1496

traits:
  - id: stratum-tcp
    desc: stratum+tcp protocol
    crit: notable
    conf: 0.6
    mbc: "B0041"
    attack: "T1496"
    if:
      type: string
      substr: "stratum+tcp"

  # NOTE: Removed standalone "pool" keyword detection - too many false positives
  # "pool" is ubiquitous in programming (memory pool, thread pool, connection pool)
  # Mining pools are now detected via pool-url pattern or combined with other mining indicators
  - id: pool-url
    desc: Mining pool URL pattern
    crit: notable
    conf: 0.7
    if:
      type: string
      # Match pool URLs like pool.example.com or example-pool.com
      regex: "(?:stratum\\+(?:tcp|ssl)://|https?://)[^\\s]+pool[^\\s]*|pool\\.[a-z0-9-]+\\.(?:com|net|org|io)"

  - id: miner-word
    desc: miner keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      word: "miner"

  - id: hashrate-str
    desc: hashrate keyword
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "hashrate"

  - id: wallet-word
    desc: wallet keyword
    crit: inert
    conf: 0.4
    # Restrict to languages where miners typically appear, exclude Swift/macOS contexts
    for: [python, shell, javascript, go]
    if:
      type: string
      word: "wallet"

  - id: coinhive-str
    desc: coinhive reference
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "coinhive"

  - id: cryptonight-str
    desc: cryptonight algorithm
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "cryptonight"

  # === XMRig atomic indicators (legacy) ===
  - id: xmrig-pascal
    desc: XMRig (PascalCase)
    crit: notable
    conf: 0.55
    if:
      type: string
      substr: "XMRig"

  - id: miner-stratum
    desc: Stratum mining protocol
    crit: suspicious
    conf: 0.66
    if:
      type: string
      regex: "stratum\\+tcp://"

composite_rules:
  - id: miner
    desc: Cryptocurrency mining patterns
    crit: suspicious
    conf: 0.66
    mbc: "B0041"
    attack: "T1496"
    needs: 2
    any:
      - id: stratum-tcp
      - id: pool-url
      - id: miner-word
      - id: known/malware/miner::xmrig-lower
      - id: obj/impact/cryptojacking/miner::monero-lower
      - id: hashrate-str
      - id: wallet-word
      - id: coinhive-str
      - id: cryptonight-str

  # XMRig composite
  - id: miner-xmrig
    desc: XMRig cryptocurrency miner reference
    crit: notable
    conf: 0.66
    any:
      - id: known/malware/miner::xmrig-lower
      - id: xmrig-pascal
