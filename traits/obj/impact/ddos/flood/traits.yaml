# DDoS Attack Pattern Detection
# Detects various DDoS attack implementations
# ATT&CK: T1498 (Network Denial of Service)

traits:
  # === SYN Flood micro-traits ===
  - id: sock-raw
    desc: SOCK_RAW socket type
    crit: notable
    conf: 0.5
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      substr: "SOCK_RAW"

  - id: ipproto-tcp
    desc: IPPROTO_TCP constant
    crit: notable
    conf: 0.3
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      substr: "IPPROTO_TCP"

  - id: syn-flood-string
    desc: syn_flood string reference
    crit: suspicious
    conf: 0.8
    attack: "T1498"
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      regex: "(?i)syn[_\\s]?flood"

  # === UDP Flood micro-traits ===
  - id: udpbuf
    desc: udpbuf buffer reference
    crit: notable
    conf: 0.5
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      substr: "udpbuf"

  - id: sock-dgram
    desc: SOCK_DGRAM socket type
    crit: notable
    conf: 0.3
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      substr: "SOCK_DGRAM"

  - id: sendto-func
    desc: sendto function
    crit: notable
    conf: 0.3
    for: [elf, macho, pe, so, dylib]
    if:
      type: symbol
      regex: "sendto"

  # === DNS Amplification micro-traits ===
  - id: amplification-string
    desc: amplification string reference
    crit: notable
    conf: 0.6
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      # Match DDoS-specific amplification contexts, not generic "amplification" (used in compilers for loop unrolling)
      regex: "(?i)(dns|udp|ntp|ssdp|memcached|chargen)[_\\s\\-]?amplification|amplification[_\\s\\-]?(attack|flood|ddos)"

  - id: port-53
    desc: Port 53 reference
    crit: notable
    conf: 0.3
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      exact: ":53"

  # NOTE: Generic "dns" is too broad - matches countless legitimate uses.
  # This trait is only used in dns-amp-logic composite which requires
  # amplification-string AND port-53 AND dns-string, so keep it broad
  # but only match DNS in attack-related contexts.
  - id: dns-string
    desc: DNS protocol in attack context
    crit: notable
    conf: 0.3
    for: [elf, macho, pe, so, dylib]
    if:
      type: string
      # Match DNS in contexts suggesting network attacks, not just "dns" anywhere
      regex: "(?i)\\b(dns[_-]?(flood|amp|attack|query|spoof|reflect)|send[_-]?dns|udp[_-]?dns)\\b"

  - id: dns-amp
    desc: DNS amplification identifier string
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)dns[ _]?amp"

  # === HTTP Flood micro-traits ===
  - id: slowloris-string
    desc: slowloris attack reference
    crit: suspicious
    conf: 0.8
    attack: "T1498"
    if:
      type: string
      regex: "(?i)slowloris"

  - id: layer7-string
    desc: layer7 DDoS reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)layer7"

  - id: http-flood-string
    desc: http_flood attack reference
    crit: suspicious
    conf: 0.8
    attack: "T1498"
    if:
      type: string
      regex: "(?i)http[_\\s]?flood"

composite_rules:
  # SYN Flood composite (migrated from YARA)
  - id: syn-flood-logic
    desc: SYN flood attack implementation
    crit: suspicious
    conf: 0.9
    attack: "T1498"
    for: [elf, macho, pe, so, dylib]
    all:
      - id: sock-raw
      - id: ipproto-tcp
      - id: syn-flood-string

  # UDP Flood composite (migrated from YARA)
  - id: udp-flood-logic
    desc: UDP flood attack implementation
    crit: suspicious
    conf: 0.9
    attack: "T1498"
    for: [elf, macho, pe, so, dylib]
    all:
      - id: sock-dgram
      - id: sendto-func
      - id: udpbuf

  # DNS Amplification composite (migrated from YARA)
  - id: dns-amp-logic
    desc: DNS amplification attack implementation
    crit: suspicious
    conf: 0.9
    attack: "T1498"
    for: [elf, macho, pe, so, dylib]
    all:
      - id: amplification-string
      - id: port-53
      - id: dns-string

  # HTTP Flood composite (migrated from YARA)
  - id: http-flood-identifier
    desc: Layer 7 DDoS identifier string
    crit: notable
    conf: 0.7
    any:
      - id: slowloris-string
      - id: layer7-string
      - id: http-flood-string

  # Multi-vector DDoS tool
  - id: multi-vector
    desc: Multi-vector DDoS tool (multiple attack
    crit: suspicious
    conf: 0.95
    needs: 2
    any:
      - id: syn-flood-logic
      - id: udp-flood-logic
      - id: dns-amp-logic
