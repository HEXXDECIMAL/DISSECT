# Wiper/Destruction Patterns
# Detects patterns associated with destructive malware (wipers, protestware)
# ATT&CK: T1485 (Data Destruction), T1561 (Disk Wipe)

traits:
  # Recursive directory deletion (Node.js)
  - id: recursive-delete
    desc: Recursive directory deletion function
    crit: suspicious
    conf: 0.85
    attack: "T1485"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule node_recursive_delete {
          strings:
            $readdir = "readdirSync" ascii
            $unlink = "unlinkSync" ascii
            $rmdir = "rmdirSync" ascii
            $rmrf = "rm -rf" ascii
            $rimraf = "rimraf" ascii
          condition:
            ($readdir and ($unlink or $rmdir)) or $rmrf or $rimraf
        }

  # Targets development directories
  - id: target-dev-dirs
    desc: Targets development directories for deletion
    crit: suspicious
    conf: 0.9
    attack: "T1485"
    for: [javascript, typescript, python]
    if:
      type: yara
      source: |
        rule target_dev_directories {
          strings:
            $dir1 = ".git" ascii
            $dir2 = ".svn" ascii
            $dir3 = "node_modules" ascii
            $dir4 = ".vscode" ascii
            $dir5 = "/src" ascii
            $dir6 = "/public" ascii
            $delete1 = "unlink" ascii
            $delete2 = "rmdir" ascii
            $delete3 = "rm -rf" ascii
            $delete4 = "rmtree" ascii
            $delete5 = "shutil.rmtree" ascii
          condition:
            3 of ($dir*) and any of ($delete*)
        }

  # Individual directory targeting
  - id: target-git
    desc: Targets .git directory (version control)
    crit: notable
    conf: 0.85
    attack: "T1485"
    for: [javascript, typescript, python, shell]
    if:
      type: string
      regex: '["'']\\./?\\.git["'']'

  - id: target-node-modules
    desc: Targets node_modules directory
    crit: notable
    conf: 0.8
    attack: "T1485"
    for: [javascript, typescript]
    if:
      type: string
      regex: '["'']/?(\\./)?node_modules["'']'

  - id: target-src
    desc: Targets source code directory
    crit: notable
    conf: 0.85
    attack: "T1485"
    for: [javascript, typescript, python]
    if:
      type: string
      regex: '["'']/?(\\./)?src["'']'

  # === IDE config atomic indicators ===
  - id: target-vscode-dir
    desc: Targets .vscode directory
    crit: notable
    conf: 0.7
    attack: "T1485"
    for: [javascript, typescript]
    if:
      type: string
      regex: '["'']/?(\\./)?\\.(vscode)["'']'

  - id: target-idea-dir
    desc: Targets .idea directory
    crit: notable
    conf: 0.7
    attack: "T1485"
    for: [javascript, typescript]
    if:
      type: string
      regex: '["'']/?(\\./)?\\.(idea)["'']'

  # Conditional destruction based on environment
  - id: conditional-destroy
    desc: Conditional destruction based on environment
    crit: suspicious
    conf: 0.95
    attack: "T1485"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule conditional_destruction {
          strings:
            $env_check = /process\.env\[[^\]]+\]\s*(!=|!==|==|===)/ ascii
            $node_env = "NODE_ENV" ascii
            $destroy1 = "unlinkSync" ascii
            $destroy2 = "rmdirSync" ascii
            $destroy3 = "rm -rf" ascii
          condition:
            ($env_check or $node_env) and any of ($destroy*)
        }

  # Android/mobile storage targeting
  - id: target-android-storage
    desc: Targets Android storage directories
    crit: suspicious
    conf: 0.95
    attack: "T1485"
    for: [javascript, typescript, shell]
    if:
      type: yara
      source: |
        rule target_android_storage {
          strings:
            $sdcard = "/sdcard" ascii
            $storage = "/storage/emulated" ascii
            $dcim = "DCIM" ascii
            $pictures = "Pictures" ascii
            $downloads = "Download" ascii
            $rm = "rm " ascii
            $rmrf = "rm -rf" ascii
            $spawn = "spawn(" ascii
          condition:
            ($sdcard or $storage) and any of ($dcim, $pictures, $downloads) and any of ($rm, $rmrf, $spawn)
        }

  # Mass file deletion
  - id: mass-delete
    desc: Mass file deletion pattern
    crit: suspicious
    conf: 0.85
    attack: "T1485"
    for: [javascript, typescript, python, shell]
    if:
      type: raw
      regex: "(fs\\.readdirSync|os\\.walk|find\\s+\\.)[\\s\\S]{0,50}(unlinkSync|os\\.remove|os\\.unlink|-delete|rm\\s+-rf)"

composite_rules:
  # Target IDE config composite
  - id: target-vscode
    desc: Targets .vscode configuration directory
    crit: notable
    conf: 0.85
    attack: "T1485"
    for: [javascript, typescript]
    any:
      - id: target-vscode-dir
      - id: target-idea-dir

  # Protestware pattern (env-conditional destruction)
  - id: protestware
    desc: Protestware pattern - conditional destruction
    crit: suspicious
    conf: 0.98
    attack: "T1485"
    mbc: "B0031"
    for: [javascript, typescript]
    all:
      - id: obj/impact/wiper/disk::conditional-destroy
      - id: obj/impact/wiper/disk::target-dev-dirs

  # Full wiper with HTTP callback (report success)
  - id: with-callback
    desc: Wiper with HTTP callback (potential
    crit: suspicious
    conf: 0.95
    attack: "T1485"
    mbc: "B0031"
    for: [javascript, typescript]
    all:
      - id: obj/impact/wiper/disk::recursive-delete
      - id: cap/comm/http/request/
