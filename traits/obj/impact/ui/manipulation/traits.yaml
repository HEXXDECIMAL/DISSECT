# Impact - UI Manipulation
# ATT&CK: T1491 (Defacement)

traits:
  - id: dock-hide
    desc: macOS dock hiding
    crit: suspicious
    conf: 0.9
    attack: "T1564.003"
    for: [macho]
    if:
      type: string
      regex: "(?i)(hideDock|applicationWillHide)"

  - id: screencapture
    desc: macOS screencapture command
    crit: suspicious
    conf: 0.85
    attack: "T1113"
    for: [macho, shell]
    if:
      type: string
      substr: "screencapture"

  - id: pil-imagegrab
    desc: Python PIL screenshot capture
    crit: suspicious
    conf: 0.85
    attack: "T1113"
    for: [python]
    if:
      type: string
      substr: "ImageGrab"

  - id: cg-window-capture
    desc: macOS CGWindow capture
    crit: suspicious
    conf: 0.85
    attack: "T1113"
    for: [macho]
    if:
      type: string
      substr: "CGWindowListCreateImageFromArray"

  - id: screensaver-engine
    desc: macOS ScreenSaver control
    crit: suspicious
    conf: 0.8
    attack: "T1491"
    for: [macho, shell]
    if:
      type: string
      substr: "ScreenSaverEngine"

  - id: system-events
    desc: macOS System Events control
    crit: suspicious
    conf: 0.8
    attack: "T1059.002"
    for: [macho, shell]
    if:
      type: string
      substr: 'tell application "System Events"'

  - id: window-watcher
    desc: macOS window/application monitoring
    crit: suspicious
    conf: 0.9
    attack: "T1010"
    for: [macho]
    if:
      type: string
      substr: "frontmostApplication"

  - id: screen-locked
    desc: macOS screen lock detection
    crit: suspicious
    conf: 0.8
    attack: "T1010"
    for: [macho]
    if:
      type: string
      substr: "CGSSessionScreenIsLocked"

  # NOTE: MIT-MAGIC-COOKIE-1 is the standard X11 authentication mechanism, not UI manipulation.
  # It's used by all X11 libraries (libX11, libICE, libSM, etc.) for normal authentication.
  # The x11-auth-protocol trait is defined in cap/exec/load/traits.yaml as inert.

  - id: xsession
    desc: Xsession reference
    crit: notable
    conf: 0.6
    attack: "T1056"
    for: [elf, shell]
    if:
      type: string
      substr: "Xsession"

  - id: hid-idle-time
    desc: macOS HID idle time detection
    crit: suspicious
    conf: 0.8
    attack: "T1010"
    for: [macho]
    if:
      type: string
      substr: "HIDIdleTime"

  - id: process-identifier
    desc: macOS process identifier access
    crit: notable
    conf: 0.7
    attack: "T1010"
    for: [macho]
    if:
      type: string
      substr: "processIdentifier"

composite_rules:
  - id: macos-spy-detected
    desc: macOS UI spying
    crit: suspicious
    conf: 0.95
    attack: "T1010"
    mbc: "B0042"
    for: [macho]
    requires_any_n:
      count_min: 2
      any:
        - id: screen-locked
        - id: hid-idle-time
        - id: window-watcher
        - id: process-identifier
