# Impact - Exploit Techniques
# ATT&CK: T1068 (Exploitation for Privilege Escalation)

defaults:
  # Exploit strings can be embedded in any file type
  for: ["*"]

traits:
  # CVE References
  - id: cve-mention
    desc: References a CVE identifier
    crit: notable
    conf: 0.8
    attack: "T1068"
    if:
      type: string
      regex: "CVE-20[12]\\d-\\d{4,7}"

  - id: cve-poc
    desc: References a CVE proof-of-concept
    crit: notable
    conf: 0.9
    attack: "T1068"
    if:
      type: string
      regex: "(CVE[-_]POC|POC[-_]CVE)-20[12]\\d-\\d+"

  # PwnKit (CVE-2021-4034)
  - id: pwnkit-name
    desc: PwnKit exploit identifier
    crit: notable
    conf: 0.95
    attack: "T1068"
    for: [elf, python, shell]
    if:
      type: string
      regex: "(?i)pwnkit"

  - id: pwnkit-cve
    desc: PwnKit CVE reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)cve[-_]?2021[-_]?4034"

  - id: pkexec-exploit
    desc: pkexec exploitation marker
    crit: notable
    conf: 0.9
    attack: "T1068"
    for: [elf]
    if:
      type: string
      substr: "pkexec"

  # GCONV_PATH Exploit
  - id: gconv-path-dot
    desc: GCONV_PATH override to current directory
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      substr: "GCONV_PATH=."

  # NOTE: gconv_init is present in glibc for character conversion
  # This trait alone is NOT a reliable exploit indicator
  # Only meaningful in small binaries or combined with GCONV_PATH= exploit pattern
  - id: gconv-init
    desc: GCONV initialization hook (requires context)
    crit: notable
    conf: 0.4
    attack: "T1068"
    for: [elf]
    if:
      type: string
      substr: "gconv_init"

  # GLIBC_TUNABLES (CVE-2023-4911)
  # NOTE: GLIBC_TUNABLES is present in all statically linked glibc binaries
  # This trait alone is NOT a reliable exploit indicator - only notable when
  # combined with explicit exploit references (looney tunables, cve-2023-4911)
  - id: glibc-tunables
    desc: GLIBC_TUNABLES environment variable (requires context)
    crit: notable
    conf: 0.3
    attack: "T1068"
    if:
      type: string
      substr: "GLIBC_TUNABLES"

  - id: looney-tunables
    desc: Looney Tunables exploit reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)looney.?tunables"

  - id: cve-2023-4911
    desc: GLIBC_TUNABLES CVE reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)cve[-_]?2023[-_]?4911"

  # Shellcode/Buffer Overflow
  - id: shellcode-ref
    desc: Shellcode reference
    crit: notable
    conf: 0.85
    attack: "T1068"
    if:
      type: string
      substr: "shellcode"

  - id: exec-shellcode
    desc: Shellcode execution function
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "exec(ute)?[_-]?shellcode"

  - id: nop-sled
    desc: NOP sled reference
    crit: notable
    conf: 0.9
    attack: "T1068"
    if:
      type: string
      regex: "(?i)nop[_-]?sled"

  - id: payload-so
    desc: Payload shared object
    crit: notable
    conf: 0.9
    attack: "T1068"
    for: [elf]
    if:
      type: string
      substr: "payload.so"

  # DirtyPipe (CVE-2022-0847)
  - id: dirtypipe
    desc: DirtyPipe exploit reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)dirty.?pipe"

  - id: cve-2022-0847
    desc: DirtyPipe CVE reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)cve[-_]?2022[-_]?0847"

  # DirtyCow (CVE-2016-5195)
  - id: dirtycow
    desc: DirtyCow exploit reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)dirty.?cow"

  - id: cve-2016-5195
    desc: DirtyCow CVE reference
    crit: notable
    conf: 0.95
    attack: "T1068"
    if:
      type: string
      regex: "(?i)cve[-_]?2016[-_]?5195"

  # Additional atomic traits for composite rules

  # NOTE: Removed standalone "PATH" trait - too generic, matches any binary.
  # PATH is only meaningful in exploit context when combined with exploit indicators.
  # The path-env-var trait is now only meaningful in composite rules that require
  # additional context like GCONV_PATH=. or pkexec.
  - id: path-env-var
    desc: PATH environment variable manipulation
    crit: notable
    conf: 0.5
    attack: "T1068"
    for: [elf, python, shell]
    if:
      type: string
      # Match PATH manipulation patterns, not just the word "PATH"
      # Use bounded patterns to avoid unbounded greedy matching
      regex: "(?:PATH=|setenv.{0,30}PATH|putenv.{0,30}PATH|getenv.{0,30}PATH.{0,20}:|PATH[+]?=)"

  - id: reverse-shell-ref
    desc: Reverse shell reference in exploit
    crit: notable
    conf: 0.8
    attack: "T1068"
    for: [elf, python, shell]
    if:
      type: string
      substr: "reverse_shell"

  # Generic terms (padding, address, offset, overflow) moved to data/text/generic.yaml

  - id: poc-ref
    desc: Proof of concept reference
    crit: notable
    conf: 0.6
    attack: "T1068"
    if:
      type: string
      regex: "(?i)proof.?of.?concept"

  # YARA-based detection traits
  - id: pwnkit-yara
    desc: PwnKit exploit via YARA
    crit: notable
    conf: 0.95
    attack: "T1068"
    mbc: "E1068"
    for: [elf, python, shell]
    if:
      type: yara
      source: |
        rule pwnkit_exploit {
          strings:
            $pwnkit1 = "PwnKit" nocase
            $pwnkit2 = "pwnkit" nocase
            $cve = /cve[-_]?2021[-_]?4034/i
            $path = "PATH" fullword
            $pkexec = "pkexec"
            $gconv_path = "GCONV_PATH=."
            $gconv_init = "gconv_init"
            $payload = "payload.so"
            $revshell = "reverse_shell"
          condition:
            filesize < 5MB and
            (any of ($pwnkit*, $cve) and any of ($path, $pkexec, $revshell)) or
            (4 of ($path, $pkexec, $gconv_path, $gconv_init, $payload))
        }

  - id: buffer-overflow-yara
    desc: Buffer overflow exploit via YARA
    crit: notable
    conf: 0.9
    attack: "T1068"
    mbc: "E1068"
    if:
      type: yara
      source: |
        rule buffer_overflow_exploit {
          strings:
            $shellcode = "shellcode" fullword
            $n_padding = "padding" fullword
            $n_address = "address" fullword
            $n_offset = "offset" fullword
            $n_overflow = "overflow" fullword
            $n_rop = "ROP" fullword
            $n_gadget = "gadget" fullword
            $not_fishshell = "fishshell"
            $not_powershell = "powershell"
          condition:
            filesize < 3MB and $shellcode and 2 of ($n*) and none of ($not*)
        }

  - id: looney-tunables-yara
    desc: Looney Tunables exploit via YARA
    crit: notable
    conf: 0.95
    attack: "T1068"
    mbc: "E1068"
    for: [elf, python, shell]
    if:
      type: yara
      source: |
        rule looney_tunables {
          strings:
            // Explicit exploit references (high confidence)
            $name = /looney.?tunables/i
            $cve = /cve[-_]?2023[-_]?4911/i
            // Exploit code patterns
            $tunables = "GLIBC_TUNABLES"
            $overflow = "overflow"
            $exploit = "exploit"
            $payload = "payload"
            $shellcode = "shellcode"
            $poc = /proof.?of.?concept/i
          condition:
            filesize < 5MB and
            // Only match if explicit exploit reference OR exploit patterns
            any of ($name, $cve) or
            ($tunables and any of ($overflow, $exploit, $payload, $shellcode, $poc))
        }

composite_rules:
  # Trait-based composite rules for simpler detection patterns

  - id: pwnkit-name-with-context
    desc: PwnKit exploit with execution context
    crit: suspicious
    conf: 0.9
    attack: "T1068"
    mbc: "E1068"
    for: [elf, python, shell]
    any:
      - id: pwnkit-name
      - id: pwnkit-cve
    all:
      - id: pkexec-exploit

  - id: gconv-path-exploit
    desc: GCONV_PATH exploitation pattern
    crit: suspicious
    conf: 0.9
    attack: "T1068"
    mbc: "E1068"
    for: [elf, shell]
    all:
      - id: gconv-path-dot
      - id: gconv-init
      - id: payload-so

  - id: looney-tunables-explicit
    desc: Looney Tunables with explicit exploit
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    mbc: "E1068"
    for: [elf, python, shell]
    any:
      - id: looney-tunables
      - id: cve-2023-4911

  - id: looney-tunables-with-exploit-pattern
    desc: GLIBC_TUNABLES with exploit indicators
    crit: notable
    conf: 0.85
    attack: "T1068"
    mbc: "E1068"
    for: [elf, python, shell]
    all:
      - id: glibc-tunables
    any:
      - id: cap/data/text/generic/overflow
      - id: cap/data/text/generic/exploit
      - id: cap/data/text/generic/payload
      - id: shellcode-ref
      - id: poc-ref

  - id: dirtypipe-detected
    desc: DirtyPipe exploit detected
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    mbc: "E1068"
    for: [all]
    any:
      - id: dirtypipe
      - id: cve-2022-0847

  - id: dirtycow-detected
    desc: DirtyCow exploit detected
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    mbc: "E1068"
    for: [all]
    any:
      - id: dirtycow
      - id: cve-2016-5195

  - id: shellcode-with-rop
    desc: Shellcode with ROP exploitation
    crit: suspicious
    conf: 0.9
    attack: "T1068"
    mbc: "E1068"
    for: [all]
    all:
      - id: shellcode-ref
    any:
      - id: cap/data/exploitation/rop-ref
      - id: cap/data/exploitation/gadget-ref
