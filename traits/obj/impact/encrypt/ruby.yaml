---
# Ruby Ransomware Detection
# Detects file encryption ransomware and ransom note behaviors
# ATT&CK: T1486 (Data Encrypted for Impact)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Chilkat Crypto Library ===
  - id: chilkat-crypto-lib
    desc: Chilkat crypto library usage
    crit: suspicious
    conf: 0.85
    attack: "T1486"
    if:
      type: string
      regex: 'require.{0,50}chilkat|Chilkat|chilkat'

  # === Encrypt Module ===
  - id: encrypt-module
    desc: Encryption module import
    crit: notable
    conf: 0.80
    attack: "T1486"
    if:
      type: string
      regex: 'Encrypt.rb|encrypt|Enc.new|dec\.cry'

  # === Decrypt Module ===
  - id: decrypt-module
    desc: Decryption module import
    crit: notable
    conf: 0.80
    attack: "T1486"
    if:
      type: string
      regex: 'Decrypt.rb|decrypt|Dec.new|dec\.dec'

  # === Directory File Enumeration ===
  - id: dir-file-enum
    desc: Directory file enumeration
    crit: inert
    conf: 0.75
    attack: "T1083"
    if:
      type: string
      regex: 'Dir\[.{0,50}\*\*.{0,50}\*\.\*|Dir\.glob|input.{0,50}\*\*'

  # === File Operation Loop ===
  - id: file-operation-loop
    desc: File operation loop
    crit: notable
    conf: 0.75
    attack: "T1486"
    if:
      type: string
      regex: 'for i in input|\.each.{0,50}file|loop.{0,50}encrypt'

  # === Ransom Note Creation ===
  - id: ransom-note-create
    desc: Ransom note file creation
    crit: suspicious
    conf: 0.90
    attack: "T1491"
    if:
      type: string
      regex: 'Readme\.txt|ransom|hackend.{0,50}encrypted|README.{0,50}PUTS|\.puts.{0,50}banner'

  # === Ransom Banner/Art ===
  - id: ransomware-banner
    desc: Ransomware ASCII art banner
    crit: notable
    conf: 0.70
    attack: "T1491"
    if:
      type: string
      regex: '████|卐|hackend'

  # === System Clear Screen ===
  - id: clear-screen
    desc: Clear terminal screen
    crit: inert
    conf: 0.50
    if:
      type: string
      regex: "system.{0,50}clear|system.{0,50}'clear'|system.{0,50}\"clear\""

  # === Interactive Menu ===
  - id: interactive-menu
    desc: Interactive menu interface
    crit: notable
    conf: 0.60
    if:
      type: string
      regex: 'Choose.{0,50}option|case out|when.{0,50}Encrypt|when.{0,50}Decrypt|Exit'

  # === Recursive Directory Access ===
  - id: recursive-dir-access
    desc: Recursive directory access
    crit: inert
    conf: 0.80
    attack: "T1083"
    if:
      type: string
      regex: '\*\*/\*\..{0,50}|Dir\.pwd|\.pwd'

composite_rules:
  # === Ransomware Tool ===
  - id: ransomware-tool
    desc: File encryption ransomware tool
    crit: suspicious
    conf: 0.95
    attack: "T1486"
    needs: 5
    any:
      - id: chilkat-crypto-lib
      - id: encrypt-module
      - id: decrypt-module
      - id: dir-file-enum
      - id: file-operation-loop
      - id: ransom-note-create
      - id: recursive-dir-access

  # === Ransomware Note Dropper ===
  - id: ransomware-note-dropper
    desc: Ransom note creation behavior
    crit: suspicious
    conf: 0.90
    attack: "T1491"
    needs: 2
    any:
      - id: ransom-note-create
      - id: ransomware-banner
      - id: file-operation-loop

  # === File Encryption Loop ===
  - id: file-encryption-loop
    desc: Bulk file encryption behavior
    crit: suspicious
    conf: 0.92
    attack: "T1486"
    needs: 3
    any:
      - id: dir-file-enum
      - id: file-operation-loop
      - id: encrypt-module
      - id: decrypt-module
