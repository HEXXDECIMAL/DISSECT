# System Directory Destructive Operations
# Detects targeting of critical system directories for destructive purposes
# ATT&CK: T1485 (Data Destruction), T1561 (Disk Wipe)

defaults:
  attack: "T1485"
  crit: suspicious

traits:
  # Windows System32 deletion
  - id: windows-system32-delete
    desc: "Windows System32 directory deletion"
    conf: 0.95
    platforms: [windows]
    if:
      type: string
      regex: "(rmdir|del|remove|shutil\\.rmtree|os\\.remove).{0,50}[Ss]ystem32|[Ss]ystem32.{0,50}(rmdir|del|remove)"

  # Windows directory recursive deletion
  - id: windows-recursive-delete
    desc: "Windows system directory recursive deletion"
    conf: 0.9
    platforms: [windows]
    if:
      type: string
      regex: "rd\\s+/s.{0,50}(?:Windows|%WINDIR%|%SYSTEMROOT%)|rmdir\\s+/s.{0,50}(?:Windows|%WINDIR%|%SYSTEMROOT%)|del\\s+/f\\s+/q.{0,50}(?:Windows|%WINDIR%|%SYSTEMROOT%)"

  # Linux critical directory targeting
  - id: linux-etc-delete
    desc: "Linux /etc directory deletion attempt"
    conf: 0.95
    platforms: [linux]
    if:
      type: string
      regex: "rm\\s+-rf\\s+/etc|shutil\\.rmtree.{0,50}[\"']/etc"

  # Linux /usr directory targeting (binaries/libs)
  - id: linux-usr-delete
    desc: "Linux /usr directory deletion attempt"
    conf: 0.95
    platforms: [linux]
    if:
      type: string
      regex: "rm\\s+-rf\\s+/usr|shutil\\.rmtree.{0,50}[\"']/usr"

  # Linux boot directory targeting
  - id: linux-boot-delete
    desc: "Linux /boot directory deletion attempt"
    conf: 0.95
    platforms: [linux]
    if:
      type: string
      regex: "rm\\s+-rf\\s+/boot|shutil\\.rmtree.{0,50}[\"']/boot"

  # Root filesystem wipe
  - id: root-wipe
    desc: "Root filesystem wipe attempt"
    conf: 0.95
    attack: "T1561"
    if:
      type: string
      regex: "rm\\s+-rf\\s+/\\s|rm\\s+-rf\\s+/\\*|shutil\\.rmtree.{0,50}[\"']/[\"']"

  # macOS system directory targeting
  - id: macos-system-delete
    desc: "macOS system directory deletion"
    conf: 0.95
    platforms: [macos]
    if:
      type: string
      regex: "rm\\s+-rf.{0,50}(/System|/Library/System)|shutil\\.rmtree.{0,50}/System"

  # MBR/Boot sector targeting
  - id: mbr-target
    desc: "MBR/Boot sector targeting"
    conf: 0.95
    attack: "T1561.002"
    if:
      type: string
      regex: "/dev/sda|/dev/hda|PhysicalDrive0|\\\\\\\\\\\\.\\\\PhysicalDrive"

  # === Recursive deletion atomic indicators ===
  - id: rmtree-call
    desc: rmtree function call
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "rmtree"

  - id: rm-rf-cmd
    desc: rm -rf command
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "rm\\s+-rf"

  - id: rmdir-recursive
    desc: rmdir recursive command
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "(?:rmdir|rd).{0,30}(/s|/q)"

  # === System directory atomic indicators ===
  - id: windows-dir-ref
    desc: Windows directory reference
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "[A-Za-z]:\\\\\\\\Windows(?:\\\\\\\\System32)?|\\\\\\\\Windows\\\\\\\\System32|/Windows/System32"

  - id: system32-ref
    desc: System32 directory reference
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "System32"

  - id: etc-dir-ref
    desc: /etc directory reference
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "/etc"

  - id: boot-dir-ref
    desc: /boot directory reference
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "/boot"

  - id: usr-dir-ref
    desc: /usr directory reference
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "/usr"

composite_rules:
  - id: recursive-delete-cmd
    desc: "Recursive deletion command pattern"
    crit: notable
    conf: 0.8
    any:
      - id: rmtree-call
      - id: rm-rf-cmd
      - id: rmdir-recursive

  # NOTE: Go and many legitimate programs reference /etc, /usr, etc.
  # These are too generic on their own - downgraded to inert.
  - id: system-dir-reference
    desc: "Reference to critical system directories"
    crit: notable
    conf: 0.4
    any:
      - id: windows-dir-ref
      - id: system32-ref
      - id: etc-dir-ref
      - id: boot-dir-ref
      - id: usr-dir-ref

  # System destruction with iteration
  - id: mass-deletion
    desc: "Mass system file deletion"
    conf: 0.95
    all:
      - id: recursive-delete-cmd
      - id: cap/data/control-flow/analysis::iteration-loop-pattern
      - id: system-dir-reference
