# System reboot/shutdown commands
# Triggers system restart or shutdown, often used for cleanup or denial of service
# ATT&CK: T1529 (System Shutdown/Reboot)
# MBC: B0017 (Execute)

traits:
  - id: reboot-command
    desc: reboot command (force system restart)
    crit: suspicious
    conf: 0.85
    mbc: "B0017"
    attack: "T1529"
    platforms: [unix, macos, linux]
    if:
      type: content
      regex: '(?i)(^|[\s"''])(?:sudo\s+)?(?:/sbin/|/usr/sbin/)?reboot(?:\s+-(?:f|n|w|p|i|d|l)\b(?:\s+\S+)*)?(?:\s*(?:;|&&|\|\||["'']\s*[),]|$))'

  - id: shutdown-command
    desc: shutdown command (system shutdown)
    crit: suspicious
    conf: 0.85
    mbc: "B0017"
    attack: "T1529"
    platforms: [unix, macos, linux]
    # Restrict to shell scripts where shutdown is used as a command
    # Binary programs often have "shutdown" in error messages, callbacks, etc.
    for: [shell, python, ruby, perl]
    if:
      type: content
      regex: '(?i)(^|[\s"''])(?:sudo\s+)?(?:/sbin/|/usr/sbin/)?shutdown(?:(?:\s+-(?:h|r|k|H|P|c|f|F|n)\b(?:\s+\S+)*)|(?:\s+now\b))(?:\s*(?:;|&&|\|\||["'']\s*[),]|$))'

  - id: halt-command
    desc: halt command (immediate shutdown)
    crit: suspicious
    conf: 0.85
    mbc: "B0017"
    attack: "T1529"
    platforms: [unix, macos, linux]
    # Restrict to shell scripts and interpreted languages where halt is used as a command
    # Binary programs often have "halt" as a function/opcode name (e.g., SQLite VM)
    for: [shell, python, ruby, perl]
    if:
      type: content
      regex: '(?im)(^|[;|&]\s*|[(,]\s*|["'']\s*)(?:sudo\s+)?(?:/sbin/|/usr/sbin/)?halt(?:\s+-(?:f|n|p|i|d|w)\b(?:\s+\S+)*)?(?:\s+now\b)?(?:\s*(?:;|&&|\|\||[)"'',]|$))'

  - id: poweroff-command
    desc: poweroff command (power down system)
    crit: suspicious
    conf: 0.85
    mbc: "B0017"
    attack: "T1529"
    platforms: [unix, macos, linux]
    if:
      type: content
      regex: '(?i)(^|[\s"''])(?:sudo\s+)?(?:/sbin/|/usr/sbin/)?poweroff(?:\s+\S+)*?(?:\s*(?:;|&&|\|\||["'']\s*[),]|$))'

composite_rules:
  - id: system-restart-trigger
    desc: System restart/shutdown triggered
    crit: suspicious
    conf: 0.90
    platforms: [unix, macos, linux]
    for: [macho, shell, python, ruby, javascript, go, perl]
    needs: 1
    any:
      - id: reboot-command
      - id: shutdown-command
      - id: halt-command
      - id: poweroff-command
