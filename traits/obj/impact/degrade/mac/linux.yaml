# Mandatory Access Control (MAC) Degradation - Linux
# Detects attempts to disable or weaken SELinux and AppArmor
# ATT&CK: T1562.001 (Impair Defenses: Disable or Modify Tools)

defaults:
  crit: suspicious
  attack: "T1562.001"
  for: [shell]

traits:
  # === SELinux Manipulation ===
  - id: selinux-setsebool
    desc: SELinux boolean modification
    conf: 0.85
    if:
      type: raw
      word: "setsebool"

  - id: selinux-setenforce
    desc: SELinux mode change to permissive
    conf: 0.90
    if:
      type: raw
      regex: "\\bsetenforce\\s+0\\b"

  - id: selinux-disable
    desc: SELinux disable in config
    conf: 0.90
    if:
      type: raw
      regex: "SELINUX\\s*=\\s*disabled"

  # === AppArmor Manipulation ===
  - id: apparmor-disable
    desc: AppArmor profile disable
    conf: 0.90
    if:
      type: raw
      regex: "\\baa-disable\\b|apparmor_parser\\s+-R"

  - id: apparmor-stop
    desc: AppArmor service stop
    conf: 0.90
    if:
      type: raw
      regex: "service\\s+apparmor\\s+stop|systemctl\\s+(?:stop|disable)\\s+apparmor"

composite_rules:
  # SELinux disabled via any method
  - id: selinux-disabled
    desc: SELinux disabled
    crit: suspicious
    conf: 0.9
    any:
      - id: selinux-setenforce
      - id: selinux-disable
      - id: selinux-setsebool

  # AppArmor disabled via any method
  - id: apparmor-disabled
    desc: AppArmor disabled
    crit: suspicious
    conf: 0.9
    any:
      - id: apparmor-disable
      - id: apparmor-stop

  # Both MAC systems disabled
  - id: mac-disabled
    desc: Multiple MAC systems disabled
    crit: hostile
    conf: 0.95
    all:
      - id: selinux-disabled
      - id: apparmor-disabled

  # Complete security stack degradation (MAC + Firewall)
  - id: full-security-disable
    desc: Complete security stack disable (MAC + Firewall)
    crit: hostile
    conf: 0.95
    attack: "T1562"
    needs: 2
    any:
      - id: selinux-disabled
      - id: apparmor-disabled
      - id: obj/impact/degrade/firewall
