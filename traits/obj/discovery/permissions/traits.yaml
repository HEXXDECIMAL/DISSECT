# Intelligence Gathering - Permissions Discovery
# ATT&CK: T1069 (Permission Groups Discovery)
# NOTE: /proc/self/status is defined in fs/proc/process/linux.yaml (process-self-status)

traits:
  - id: capsh
    desc: Linux capability shell
    crit: suspicious
    conf: 0.85
    attack: "T1069"
    # Command can be embedded in any file type
    for: ["*"]
    if:
      type: string
      substr: "capsh"

  - id: getgroups
    desc: Get group list
    crit: notable
    conf: 0.75
    attack: "T1069"
    for: [elf, macho]
    if:
      type: string
      substr: "getgroups"

  # NOTE: getgid/getegid/geteuid are extremely common POSIX functions used by
  # virtually every program that needs user/group information. Mark as inert
  # unless combined with other permission discovery indicators.
  - id: getgid
    desc: Get group ID
    crit: inert
    conf: 0.5
    attack: "T1069"
    for: [elf, macho]
    if:
      type: symbol
      exact: "getgid"

  - id: getegid
    desc: Get effective group ID
    crit: inert
    conf: 0.5
    attack: "T1069"
    for: [elf, macho]
    if:
      type: symbol
      exact: "getegid"

  - id: geteuid
    desc: Get effective user ID
    crit: inert
    conf: 0.5
    attack: "T1033"
    for: [elf, macho]
    if:
      type: symbol
      exact: "geteuid"

  - id: etc-group-core
    desc: Group file access string
    crit: inert
    conf: 0.8
    attack: "T1069"
    for: [all]
    if:
      type: string
      substr: "/etc/group"

  - id: etc-sudoers-core
    desc: Sudoers file access string
    crit: inert
    conf: 0.85
    attack: "T1069"
    for: [all]
    if:
      type: string
      substr: "/etc/sudoers"

  - id: etc-shadow-core
    desc: Shadow file access string
    crit: inert
    conf: 0.85
    attack: "T1003.008"
    for: [all]
    if:
      type: string
      substr: "/etc/shadow"

  - id: etc-gshadow-core
    desc: Group shadow file access string
    crit: inert
    conf: 0.85
    attack: "T1003.008"
    for: [all]
    if:
      type: string
      substr: "/etc/gshadow"

  # === Linux capability atomic indicators ===
  - id: cap-get-file
    desc: cap_get_file function
    crit: inert
    conf: 0.6
    attack: "T1069"
    for: [elf]
    if:
      type: string
      substr: "cap_get_file"

  - id: cap-set-file
    desc: cap_set_file function
    crit: inert
    conf: 0.6
    attack: "T1069"
    for: [elf]
    if:
      type: string
      substr: "cap_set_file"

  - id: sudo-l
    desc: Sudo permission listing
    crit: suspicious
    conf: 0.85
    attack: "T1069"
    for: [shell]
    if:
      type: string
      regex: "sudo\\s+-l"

  - id: cap-get-proc
    desc: Get process capabilities
    crit: notable
    conf: 0.75
    attack: "T1069"
    for: [elf]
    if:
      type: string
      substr: "cap_get_proc"

  - id: cap-set-proc
    desc: Set process capabilities
    crit: notable
    conf: 0.75
    attack: "T1069"
    for: [elf]
    if:
      type: string
      substr: "cap_set_proc"

composite_rules:
  # Linux capability get/set composite
  - id: cap-get
    desc: Linux capability get/set
    crit: notable
    conf: 0.7
    attack: "T1069"
    for: [elf]
    needs: 1
    any:
      - id: cap-get-proc
      - id: cap-set-proc
      - id: cap-get-file
      - id: cap-set-file

  # Linux capabilities via capsh + /proc/self/status
  - id: linux-caps-via-capsh
    desc: Linux capabilities via capsh
    crit: suspicious
    conf: 0.85
    attack: "T1069"
    for: [elf, shell]
    all:
      - id: capsh
      - id: process-self-status

  # Linux capabilities via cap_get/set_proc
  - id: linux-caps-via-api
    desc: Linux capabilities via API
    crit: suspicious
    conf: 0.85
    attack: "T1069"
    for: [elf]
    all:
      - id: cap-get-proc
      - id: cap-set-proc

  - id: linux-caps-enum
    desc: Linux capabilities enumeration
    crit: suspicious
    conf: 0.9
    attack: "T1069"
    mbc: "B0046"
    for: [elf, shell]
    needs: 1
    any:
      - id: linux-caps-via-capsh
      - id: linux-caps-via-api

  - id: etc-group
    desc: Group file access
    crit: suspicious
    conf: 0.8
    attack: "T1069"
    all:
      - id: etc-group-core
      - id: cap/fs/path/config/config-etc
    unless:
      - type: basename
        exact: "lookup.go"

  - id: etc-sudoers
    desc: Sudoers file access
    crit: suspicious
    conf: 0.85
    attack: "T1069"
    all:
      - id: etc-sudoers-core
      - id: cap/fs/path/config/config-etc

  - id: etc-shadow
    desc: Shadow file access
    crit: suspicious
    conf: 0.85
    attack: "T1003.008"
    all:
      - id: etc-shadow-core
      - id: cap/fs/path/config/config-etc

  - id: etc-gshadow
    desc: Group shadow file access
    crit: suspicious
    conf: 0.85
    attack: "T1003.008"
    all:
      - id: etc-gshadow-core
      - id: cap/fs/path/config/config-etc

  # User/group ID gathering - only notable when combined with multiple checks
  - id: uid-gid-gathering
    desc: User/group ID gathering
    crit: notable
    conf: 0.7
    attack: "T1069"
    for: [elf, macho]
    # Require multiple ID checks to be notable
    needs: 3
    any:
      - id: getgid
      - id: getegid
      - id: geteuid
      - id: getgroups
    # Many legitimate libraries check uid/gid for access control:
    # video drivers (DRM access), X11 libs, system libraries
    downgrade:
      any:
        - id: cap/exec/load/video-lib-marker
        - id: cap/exec/load/graphics-lib-marker
        - id: cap/exec/load/system-lib-marker
        - id: cap/exec/load/x11-ipc-lib-marker
