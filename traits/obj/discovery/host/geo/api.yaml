# Discovery - Geolocation and IP Intelligence
# Detects victim geolocation/profiling via IP lookup APIs
# ATT&CK: T1016 (System Network Configuration Discovery)

traits:
  # === IP Geolocation APIs ===

  - id: api-db-ip
    desc: api.db-ip.com endpoint
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "api.db-ip.com"

  - id: db-ip-v2
    desc: db-ip.com/v2 endpoint
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "db-ip.com/v2"

  - id: ipapi-api
    desc: ip-api.com geolocation API
    crit: suspicious
    conf: 0.85
    attack: "T1016"
    if:
      type: string
      substr: "ip-api.com"

  - id: ipapi-co
    desc: ipapi.co geolocation API
    crit: notable
    conf: 0.8
    attack: "T1016"
    if:
      type: string
      substr: "ipapi.co"

  - id: api-ipify
    desc: api.ipify.org endpoint
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "api.ipify.org"

  - id: ipgeolocation-api
    desc: ipgeolocation.io API
    crit: suspicious
    conf: 0.85
    attack: "T1016"
    if:
      type: string
      substr: "ipgeolocation.io"

  - id: geoip-maxmind
    desc: geoip.maxmind.com endpoint
    crit: notable
    conf: 0.6
    attack: "T1016"
    if:
      type: string
      substr: "geoip.maxmind.com"

  - id: maxmind-geoip
    desc: maxmind.com/geoip endpoint
    crit: notable
    conf: 0.6
    attack: "T1016"
    if:
      type: string
      substr: "maxmind.com/geoip"

  - id: freegeoip-app
    desc: freegeoip.app domain
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "freegeoip.app"

  - id: freegeoip-net
    desc: freegeoip.net domain
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "freegeoip.net"

  - id: freegeoip-io
    desc: freegeoip.io domain
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "freegeoip.io"

  # NOTE: Generic IP lookup services (checkip.amazonaws.com, icanhazip.com, ifconfig.me, etc.)
  # are defined in discovery/network/scan/ip-lookup.yaml
  # Use discovery/network/scan directory reference for IP lookup detection

  # === Response Fields (JSON parsing) ===

  - id: country-code-camel
    desc: countryCode field (camelCase)
    crit: notable
    conf: 0.5
    attack: "T1016"
    if:
      type: string
      word: "countryCode"

  - id: country-code-snake
    desc: country_code field (snake_case)
    crit: notable
    conf: 0.5
    attack: "T1016"
    if:
      type: string
      word: "country_code"

  - id: country-name
    desc: country_name field (geo profiling)
    crit: notable
    conf: 0.5
    attack: "T1016"
    if:
      type: string
      word: "country_name"

  - id: ip-address-camel
    desc: ipAddress field (camelCase)
    crit: notable
    conf: 0.4
    attack: "T1016"
    if:
      type: string
      word: "ipAddress"

  - id: ip-address-snake
    desc: ip_address field (snake_case)
    crit: notable
    conf: 0.4
    attack: "T1016"
    if:
      type: string
      word: "ip_address"

  - id: ip-json-field
    desc: '"ip" JSON field'
    crit: notable
    conf: 0.4
    attack: "T1016"
    if:
      type: string
      exact: '"ip":'

  - id: city-field
    desc: City JSON field (geo profiling)
    crit: notable
    conf: 0.5
    attack: "T1016"
    if:
      type: string
      substr: '"city":'

  - id: region-field
    desc: Region JSON field (geo profiling)
    crit: notable
    conf: 0.5
    attack: "T1016"
    if:
      type: string
      substr: '"region":'

  - id: freegeoip-generic
    desc: freegeoip reference (generic)
    crit: notable
    conf: 0.7
    attack: "T1016"
    if:
      type: string
      substr: "freegeoip"

composite_rules:
  # DB-IP API composite
  - id: db-ip-api
    desc: db-ip.com geolocation API
    crit: suspicious
    conf: 0.85
    attack: "T1016"
    any:
      - id: api-db-ip
      - id: db-ip-v2

  # ipify API composite
  - id: ipify-api
    desc: ipify.org IP address API
    crit: notable
    conf: 0.8
    attack: "T1016"
    any:
      - id: api-ipify
      - id: obj/discovery/network/scan::ipify

  # MaxMind API composite
  - id: maxmind-api
    desc: MaxMind GeoIP API
    crit: notable
    conf: 0.7
    attack: "T1016"
    any:
      - id: geoip-maxmind
      - id: maxmind-geoip

  # freegeoip API composite
  - id: freegeoip-api
    desc: freegeoip geolocation API usage
    crit: suspicious
    conf: 0.85
    attack: "T1016"
    any:
      - id: freegeoip-app
      - id: freegeoip-net
      - id: freegeoip-io

  # Country code field composite
  - id: country-code-field
    desc: Country code JSON field (geo
    crit: notable
    conf: 0.6
    attack: "T1016"
    any:
      - id: country-code-camel
      - id: country-code-snake

  # IP address field composite
  - id: ip-address-field
    desc: IP address JSON field (geo
    crit: notable
    conf: 0.5
    attack: "T1016"
    any:
      - id: ip-address-camel
      - id: ip-address-snake
      - id: ip-json-field

  # Geo API composite (any one of these APIs)
  - id: geo-api
    desc: Geolocation API endpoint
    crit: notable
    conf: 0.7
    attack: "T1016"
    any:
      - id: db-ip-api
      - id: obj/discovery/network/scan::ipinfo
      - id: ipapi-api
      - id: ipapi-co
      - id: ipgeolocation-api
      - id: freegeoip-api
      - id: freegeoip-generic
      - id: ipify-api

  # Geo response field composite (any one of these fields)
  - id: geo-response-field
    desc: Geolocation response field
    crit: notable
    conf: 0.5
    attack: "T1016"
    any:
      - id: country-code-field
      - id: country-name
      - id: ip-address-field
      - id: city-field
      - id: region-field

  - id: victim-profiling
    desc: Victim geolocation profiling via IP
    crit: suspicious
    conf: 0.9
    attack: "T1016"
    all:
      - id: geo-api
      - id: geo-response-field
