# Intelligence Gathering - Browser Discovery
# ATT&CK: T1217 (Browser Information Discovery)
# NOTE: "Web Data" is defined in cred/browser/chromium/traits.yaml (web-data)

traits:
  # === Browser name atomic indicators ===
  - id: chrome-name
    desc: Chrome browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "Chrome"

  - id: firefox-name
    desc: Firefox browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "Firefox"

  - id: safari-name
    desc: Safari browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "Safari"

  - id: edge-name
    desc: Edge browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      # Require browser context: path separator or browser-specific strings
      # Plain "Edge" matches too many legitimate contexts (graphics edges, etc.)
      regex: "Edge[/\\\\]|Microsoft\\s*Edge|MicrosoftEdge|Edge\\s+(?:Browser|Chromium)"

  - id: opera-name
    desc: Opera browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      # Require browser context: path separator + profile/data dir, or "Opera GX/Stable/Software"
      # Plain "Opera" matches too many legitimate contexts (operand, operation, etc.)
      regex: "Opera[/\\\\]|Opera\\s+(?:GX|Stable|Software|Browser)"

  - id: brave-name
    desc: Brave browser name
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "Brave"

  # === Browser data file atomic indicators ===
  - id: history-file
    desc: History file reference
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    if:
      type: string
      # Require path context or browser-specific naming
      # Plain "History" matches too many legitimate contexts
      regex: "[/\\\\]History$|History\\.db|browser.{0,30}history|history\\.sqlite"

  - id: cookies-file
    desc: Cookies file reference
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    if:
      type: string
      # Require path context or browser-specific naming
      # Plain "Cookies" matches too many legitimate contexts (X11 XrmDatabase, HTTP headers, etc.)
      regex: "[/\\\\]Cookies$|Cookies\\.sqlite|Cookies\\.binarycookies|browser.{0,30}cookies|cookies\\.db"

  # === Firefox-specific files ===
  - id: places-sqlite
    desc: Firefox places.sqlite
    crit: inert
    conf: 0.7
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "places.sqlite"

  # === Bookmarks ===
  - id: bookmarks-word
    desc: bookmarks keyword
    crit: inert
    conf: 0.4
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: bookmarks
      case_insensitive: true

  - id: bookmarks-plist
    desc: Bookmarks.plist file
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "Bookmarks.plist"

  # === Local storage ===
  # === Extensions ===
  - id: chrome-extension-url
    desc: chrome-extension:// URL
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "chrome-extension://"

  - id: extensions-hash-path
    desc: Extensions path with hash
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "/Extensions/[a-z]{32}"

  - id: chrome-extensions-path
    desc: Chrome Extensions path
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "/Google/Chrome/.{0,50}Extensions"

  - id: browser-support-extensions
    desc: BrowserSupport Extensions path
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "/BrowserSupport/Extensions"

  # === Browser preferences/config ===
  - id: safari-plist
    desc: Safari preferences plist file
    crit: notable
    conf: 0.7
    attack: "T1217"
    for: [all]
    if:
      type: string
      substr: "com.apple.Safari.plist"

  - id: search-engine-id
    desc: Browser search engine identifier reference
    crit: notable
    conf: 0.7
    attack: "T1217"
    if:
      type: string
      regex: "SearchProvider|SearchEngine|DefaultSearch|searchProvider|searchEngine|defaultSearch"
      not:
        - "SearchProviderSearchGuide"

  # === Opera/Brave specific ===
  - id: opera-stable
    desc: Opera Stable
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "Opera.{0,30}Stable"

  - id: brave-software
    desc: Brave Software path
    crit: inert
    conf: 0.6
    attack: "T1217"
    for: [all]
    if:
      type: string
      regex: "Brave.{0,30}Software"

composite_rules:
  # Browser names composite
  - id: browser-names
    desc: Browser name references
    crit: inert
    conf: 0.5
    attack: "T1217"
    for: [all]
    needs: 2
    any:
      - id: chrome-name
      - id: firefox-name
      - id: safari-name
      - id: edge-name
      - id: opera-name
      - id: brave-name

  # Browser data files composite
  - id: browser-data-files
    desc: Browser data file references
    crit: notable
    conf: 0.7
    attack: "T1217"
    for: [all]
    any:
      - id: history-file
      - id: cookies-file
      - id: obj/creds/browser/chromium::login-data
      - id: places-sqlite

  # Chrome history composite
  - id: chrome-history
    desc: Chrome browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: chrome-name
    any:
      - id: history-file
      - id: cookies-file
      - id: obj/creds/browser/chromium::login-data
    downgrade:
      any:
        # Chrome binaries legitimately reference their own data files
        - type: basename
          substr: "chrome"
        - type: basename
          substr: "chromium"

  # Firefox history composite
  - id: firefox-history
    desc: Firefox browser history
    crit: notable
    conf: 0.85
    attack: "T1217"
    for: [all]
    any:
      - id: places-sqlite
      - id: obj/creds/browser/firefox::cookies-sqlite
      - id: obj/creds/browser/firefox::logins-json
    downgrade:
      any:
        - type: basename
          substr: "firefox"

  # Safari history composite
  - id: safari-history
    desc: Safari browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: safari-name
    any:
      - id: history-file
      - id: cookies-file
    downgrade:
      any:
        - type: basename
          substr: "Safari"

  # Edge history composite
  - id: edge-history
    desc: Edge browser history
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: edge-name
    any:
      - id: history-file
      - id: cookies-file
    downgrade:
      any:
        - type: basename
          substr: "edge"
        - type: basename
          substr: "msedge"

  # Bookmarks composite
  - id: bookmarks
    desc: Browser bookmarks access
    crit: notable
    conf: 0.8
    attack: "T1217"
    for: [all]
    any:
      - id: bookmarks-word
      - id: bookmarks-plist
    downgrade:
      any:
        - type: basename
          substr: "chrome"
        - type: basename
          substr: "chromium"
        - type: basename
          substr: "firefox"
        - type: basename
          substr: "Safari"
        - type: basename
          substr: "brave"

  # Local storage composite
  - id: local-storage
    desc: Browser local storage access
    crit: notable
    conf: 0.8
    attack: "T1217"
    for: [all]
    any:
      - id: obj/creds/discord/token::local-storage-ref
      - id: obj/creds/discord/token::leveldb-ref

  # Extensions composite
  - id: extensions
    desc: Browser extensions access
    crit: suspicious
    conf: 0.8
    attack: "T1217"
    for: [all]
    any:
      - id: chrome-extension-url
      - id: extensions-hash-path
      - id: chrome-extensions-path
      - id: browser-support-extensions
    downgrade:
      any:
        - type: basename
          substr: "chrome"
        - type: basename
          substr: "chromium"
        - type: basename
          substr: "firefox"
        - type: basename
          substr: "brave"

  # Opera composite - require both the name AND a browser-specific indicator
  # to avoid false positives (e.g., the word "Opera" can appear in many contexts)
  - id: opera
    desc: Opera browser data
    crit: notable
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: opera-name
      - id: opera-stable

  # Brave composite

  # Browser settings hijack - modifies browser search/homepage settings
  - id: browser-settings-hijack
    desc: Browser search engine or homepage hijacking
    crit: suspicious
    conf: 0.85
    attack: "T1217"
    for: [all]
    all:
      - id: search-engine-id
    any:
      - id: safari-plist
      - id: cap/fs/file/write::write
      - id: cap/fs/watch/fswatch::fseventstream
    downgrade:
      any:
        - type: basename
          substr: "Safari"
        - type: basename
          substr: "chrome"
        - type: basename
          substr: "firefox"

  # Multi-browser enumeration
  - id: multi-browser-enum
    desc: Multiple browser data access
    crit: suspicious
    conf: 0.9
    attack: "T1217"
    mbc: "B0046"
    for: [all]
    all:
      - id: browser-names
      - id: browser-data-files
