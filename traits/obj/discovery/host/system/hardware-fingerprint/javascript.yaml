# System Fingerprinting - JavaScript/Node.js
# ATT&CK: T1082 (System Information Discovery)

defaults:
  attack: "T1082"

traits:
  # === OS module system info calls ===
  - id: os-hostname-call
    desc: os.hostname() call
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.hostname"

  - id: os-userinfo-call
    desc: os.userInfo() call
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.userInfo"

  - id: os-platform-call
    desc: os.platform() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.platform"

  - id: os-arch-call
    desc: os.arch() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.arch"

  - id: os-release-call
    desc: os.release() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.release"

  - id: os-type-call
    desc: os.type() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.type"

  - id: os-cpus-call
    desc: os.cpus() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.cpus"

  - id: os-totalmem-call
    desc: os.totalmem() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.totalmem"

  - id: os-networkinterfaces-call
    desc: os.networkInterfaces() call
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.networkInterfaces"

  - id: os-homedir-call
    desc: os.homedir() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.homedir"

  - id: os-tmpdir-call
    desc: os.tmpdir() call
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "os.tmpdir"

  # === Process module system info ===
  - id: process-cwd-call
    desc: process.cwd() call
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "process.cwd"

  - id: process-env-access
    desc: process.env access
    crit: notable
    conf: 0.65
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "process.env"

  - id: process-platform-access
    desc: process.platform access
    crit: notable
    conf: 0.65
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "process.platform"

  - id: process-arch-access
    desc: process.arch access
    crit: notable
    conf: 0.65
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "process.arch"

  - id: process-version-access
    desc: process.version access
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: symbol
      exact: "process.version"

  # === Content-based process fingerprinting ===
  # These catch process.* usage in object literals (common in malware payloads)
  - id: process-platform-content
    desc: process.platform in content
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: raw
      substr: "process.platform"

  - id: process-arch-content
    desc: process.arch in content
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: raw
      substr: "process.arch"

  - id: process-versions-content
    desc: process.versions in content
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: raw
      substr: "process.versions"

  - id: process-argv-content
    desc: process.argv in content
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: raw
      substr: "process.argv"

composite_rules:
  # System profiling: hostname + userinfo + platform (strict)
  - id: js-profiling
    desc: Aggregates system info for profiling
    crit: suspicious
    conf: 0.95
    for: [javascript, typescript]
    all:
      - { id: os-hostname-call }
      - { id: os-userinfo-call }
      - { id: os-platform-call }

  # System profiling: at least 3 sensitive system info functions
  - id: js-sysinfo-multi
    desc: Multiple system info function calls
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    needs: 3
    any:
      - { id: os-hostname-call }
      - { id: os-userinfo-call }
      - { id: os-homedir-call }
      - { id: os-networkinterfaces-call }
      - { id: os-platform-call }
      - { id: os-arch-call }
      - { id: os-cpus-call }
      - { id: os-totalmem-call }
      - { id: process-cwd-call }
      - { id: process-env-access }

  # User identification: hostname + userinfo (core victim ID)
  - id: js-victim-id
    desc: Victim identification (host + user)
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    all:
      - { id: os-hostname-call }
      - { id: os-userinfo-call }

  - id: js-profiling-exfil
    desc: JavaScript system profiling with exfiltration
    crit: hostile
    conf: 0.98
    mbc: "E1082"
    attack: "T1020"
    for: [javascript]
    all:
      - id: js-sysinfo-multi
      - id: cap/comm/http/post::post
      - id: cap/data/encoding/charset::json

  # === Process-based fingerprinting (content-based detection) ===
  # Catches fingerprinting via process.* properties in object literals

  # Helper: any process fingerprinting property
  - id: process-fingerprint-any
    desc: Process object fingerprint property
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    any:
      - id: process-platform-content
      - id: process-arch-content
      - id: process-versions-content
      - id: process-platform-access
      - id: process-arch-access
      - id: process-version-access

  # Multiple process fingerprinting properties (2+)
  - id: process-fingerprint-multi
    desc: Multiple process fingerprint properties
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    needs: 2
    any:
      - id: process-platform-content
      - id: process-arch-content
      - id: process-versions-content
      - id: process-argv-content
      - id: process-platform-access
      - id: process-arch-access
      - id: process-version-access

  # Process fingerprinting with HTTP POST exfiltration
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: process-fingerprint-exfil
    desc: Process fingerprinting with HTTP POST exfil
    crit: hostile
    conf: 0.95
    mbc: "E1041"
    attack: "T1020"
    for: [javascript]
    all:
      - id: process-fingerprint-multi
      - id: cap/comm/http/post::post
      - id: cap/data/encoding/charset::json
