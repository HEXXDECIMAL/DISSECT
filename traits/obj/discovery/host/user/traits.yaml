# Intelligence Gathering - User Discovery
# ATT&CK: T1033 (System Owner/User Discovery)

traits:
  # === HOME environment atomic indicators ===
  - id: getenv-home
    desc: getenv HOME lookup
    crit: notable
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      regex: "getenv.{0,30}HOME"

  - id: env-dot-home
    desc: env.HOME lookup
    crit: notable
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      substr: "env.HOME"

  - id: dollar-home
    desc: $HOME variable reference
    crit: notable
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      substr: "$HOME"

  - id: appdata
    desc: Windows APPDATA lookup
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [pe, python, javascript]
    if:
      type: string
      substr: "APPDATA"

  - id: localappdata
    desc: Windows LOCALAPPDATA lookup
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [pe, python, javascript]
    if:
      type: string
      substr: "LOCALAPPDATA"

  - id: userprofile
    desc: Windows USERPROFILE lookup
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [pe, python, javascript]
    if:
      type: string
      substr: "USERPROFILE"

  - id: username-var
    desc: USERNAME environment variable
    crit: notable
    conf: 0.5
    if:
      type: string
      word: "USERNAME"

  - id: user-var
    desc: USER environment variable
    crit: notable
    conf: 0.5
    for: [shell, elf, macho, pe, python, ruby, javascript]
    if:
      type: string
      word: "USER"
    not:
      # Exclude FTP protocol documentation (USER is FTP command)
      - regex: '^\s*USER\s+(user|fwuser)(@|$)'
      # Exclude variable names that contain USER but aren't env access
      - regex: "USERNAME|USERPROFILE|USERID"
      # Exclude syntax highlighter lists (e.g. "USER|HOST|...")
      - regex: '[|,]USER[|,]'

  - id: logname-var
    desc: LOGNAME environment variable
    crit: notable
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      substr: "LOGNAME"

  # NOTE: Go runtime and standard library use getuid/getpwuid legitimately
  # for user information. Downgraded to inert for atomic indicators.
  # Removed duplicate - use cap/process/user/query::getpwuid

  - id: getpwnam
    desc: Get password entry by name
    crit: notable
    conf: 0.4
    attack: "T1033"
    for: [elf, macho]
    if:
      type: string
      substr: "getpwnam"

  - id: dscl
    desc: macOS Directory Service CLI
    crit: suspicious
    conf: 0.85
    attack: "T1087.001"
    for: [macho, shell]
    if:
      type: string
      regex: "dscl\\s+\\."

  - id: dsenableroot
    desc: macOS enable root user
    crit: suspicious
    conf: 0.85
    attack: "T1087.001"
    for: [macho, shell]
    if:
      type: string
      substr: "dsenableroot"

  # Removed duplicate - use cap/process/user/query::whoami-cmd

  - id: finger
    desc: Finger command for user info
    crit: suspicious
    conf: 0.75
    attack: "T1033"
    for: [shell, elf, macho]
    if:
      type: string
      # Match finger command path or with host/user query pattern
      # Tightened to avoid game strings like "finger ring" etc.
      regex: "(?:/usr/bin/finger|/usr/local/bin/finger|\\bfinger\\s+@[a-z]|\\bfinger\\s+-[lms]\\s)"

  - id: last-cmd
    desc: Last command for login history
    crit: suspicious
    conf: 0.8
    attack: "T1033"
    for: [shell, elf, macho]
    if:
      type: string
      substr: "/usr/bin/last"

  - id: w-cmd
    desc: W command for user sessions
    crit: suspicious
    conf: 0.75
    attack: "T1033"
    for: [shell, elf, macho]
    if:
      type: string
      regex: "/usr/bin/w\\b"

  # Shell command user discovery
  - id: whoami
    desc: Shell whoami command execution
    crit: notable
    conf: 0.85
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]whoami['\"]"

  - id: id
    desc: Shell id command execution
    crit: notable
    conf: 0.85
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]id['\"]"

  - id: npm-whoami
    desc: npm whoami command execution
    crit: suspicious
    conf: 0.9
    attack: "T1033"
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync)?\\(['\"]npm whoami['\"]"

composite_rules:
  # HOME environment composite
  - id: home-env
    desc: HOME environment variable lookup
    crit: notable
    conf: 0.7
    attack: "T1033"
    for: [all]
    any:
      - id: getenv-home
      - id: env-dot-home
      - id: dollar-home

  # Username environment composite
  - id: username-env
    desc: USERNAME environment variable
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [all]
    any:
      - id: username-var
      - id: user-var
      - id: logname-var

  # Active enumeration commands
  - id: active-enum-cmds
    desc: Active user enumeration commands
    crit: notable
    conf: 0.8
    attack: "T1033"
    for: [shell, elf, macho, pe, python]
    any:
      - id: cap/process/user/query::whoami-cmd
      - id: cap/fs/path/config/accounts::etc-passwd
      - id: dscl
      - id: finger
      - id: last-cmd
      - id: w-cmd

  # Passive user lookup functions
  # NOTE: Go runtime and legitimate tools (like ls) use these for user/group name display
  - id: passive-user-lookup
    desc: POSIX user lookup functions
    crit: inert
    conf: 0.4
    attack: "T1033"
    for: [elf, macho]
    any:
      - id: getpwnam
      - id: cap/process/identity/query::get-uid
      - id: cap/process/user/query::getpwuid

  # User enumeration detected (active commands + context)
  - id: enumeration-detected
    desc: User enumeration activity
    crit: suspicious
    conf: 0.9
    attack: "T1033"
    mbc: "B0046"
    for: [shell, elf, macho, pe, python]
    # Compact discovery tools are typically small
    size_max: 5000
    all:
      - id: active-enum-cmds
    any:
      - id: passive-user-lookup
      - id: username-env
      - id: home-env
    unless:
      - type: raw
        regex: "requests|test"


