# Process Information Discovery - Python
# Detects Python code that enumerates or introspects running processes

defaults:
  for: [python]

traits:
  - id: psutil-enum
    desc: Enumerates running processes via psutil
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: 'psutil\.process_iter\('

  # === Shell process enumeration (atomic) ===
  - id: tasklist-cmd
    desc: Windows tasklist command
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "tasklist"

  - id: pgrep-cmd
    desc: pgrep command for process grep
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "pgrep"

  - id: ps-ef-cmd
    desc: ps -ef command for process
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "ps -ef"

  # === Analysis tool process names (atomic) ===
  - id: wireshark-proc
    desc: Wireshark process name
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Wireshark"

  - id: vbox-proc
    desc: VirtualBox process name
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "vbox"

  - id: vmware-proc
    desc: VMware process name
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "vmware"

  - id: charles-proc
    desc: Charles proxy process name
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "charles"

  - id: fiddler-proc
    desc: Fiddler proxy process name
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "fiddler"

composite_rules:
  # Shell process enumeration
  - id: tasklist-shell
    desc: Enumerates processes via shell command
    crit: notable
    conf: 0.8
    count_min: 1
    any:
      - id: tasklist-cmd
      - id: pgrep-cmd
      - id: ps-ef-cmd

  # Analysis tool detection
  - id: analysis-tool-names
    desc: References analysis/debugging tool process names
    crit: notable
    conf: 0.8
    count_min: 1
    any:
      - id: wireshark-proc
      - id: vbox-proc
      - id: vmware-proc
      - id: charles-proc
      - id: fiddler-proc

  - id: anti-analysis-recon
    desc: Process-based anti-analysis/recon (psutil + sensitive
    crit: suspicious
    conf: 0.9
    all:
      - id: psutil-enum
      - id: analysis-tool-names
