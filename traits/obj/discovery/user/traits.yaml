# Intelligence Gathering - User Discovery
# ATT&CK: T1033 (System Owner/User Discovery)

traits:
  # === HOME environment atomic indicators ===
  - id: getenv-home
    desc: getenv HOME lookup
    crit: inert
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      regex: "getenv.{0,30}HOME"

  - id: env-dot-home
    desc: env.HOME lookup
    crit: inert
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      exact: "env.HOME"

  - id: dollar-home
    desc: $HOME variable reference
    crit: inert
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      exact: "$HOME"

  - id: appdata
    desc: Windows APPDATA lookup
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [pe, python, javascript]
    if:
      type: string
      exact: "APPDATA"

  - id: localappdata
    desc: Windows LOCALAPPDATA lookup
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [pe, python, javascript]
    if:
      type: string
      exact: "LOCALAPPDATA"

  - id: userprofile
    desc: Windows USERPROFILE lookup
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [pe, python, javascript]
    if:
      type: string
      exact: "USERPROFILE"

  # === Username environment atomic indicators ===
  - id: env-username
    desc: USERNAME environment variable
    crit: notable
    conf: 0.5
    if:
      type: string
      word: "USERNAME"

  - id: env-user
    desc: USER environment variable
    crit: notable
    conf: 0.5
    if:
      type: string
      word: "USER"
    # System libraries legitimately reference USER for standard functions
    downgrade:
      any:
        - type: basename
          regex: "^lib(X11|xcb|c|glib|gtk|qt|pam|pango|gio|dbus|systemd)(\\.so|\\.dylib)"
        - type: string
          regex: "X11R[0-9]|xenocara|xorg|X\\.Org|glibc"

  - id: logname-var
    desc: LOGNAME environment variable
    crit: inert
    conf: 0.5
    attack: "T1033"
    for: [all]
    if:
      type: string
      exact: "LOGNAME"



  - id: getpwuid
    desc: Get password entry by UID
    crit: inert
    conf: 0.4
    attack: "T1033"
    for: [elf, macho]
    if:
      type: string
      exact: "getpwuid"

  - id: getpwnam
    desc: Get password entry by name
    crit: inert
    conf: 0.4
    attack: "T1033"
    for: [elf, macho]
    if:
      type: string
      exact: "getpwnam"

  - id: dscl
    desc: macOS Directory Service CLI
    crit: suspicious
    conf: 0.85
    attack: "T1087.001"
    for: [macho, shell]
    if:
      type: string
      regex: "dscl\\s+\\."

  - id: dsenableroot
    desc: macOS enable root user
    crit: suspicious
    conf: 0.85
    attack: "T1087.001"
    for: [macho, shell]
    if:
      type: string
      exact: "dsenableroot"

  - id: whoami
    desc: Current user lookup
    crit: suspicious
    conf: 0.75
    attack: "T1033"
    # Exclude JS - syntax highlighters have shell keywords
    for: [shell, elf, macho, pe, python]
    if:
      type: string
      exact: "whoami"

  - id: etc-passwd
    desc: Password file access
    crit: suspicious
    conf: 0.8
    attack: "T1087.001"
    for: [all]
    if:
      type: string
      exact: "/etc/passwd"

  - id: finger
    desc: Finger command for user info
    crit: suspicious
    conf: 0.75
    attack: "T1033"
    for: [shell, elf, macho]
    if:
      type: string
      # Match finger command path or with host/user query pattern
      # Tightened to avoid game strings like "finger ring" etc.
      regex: "(?:/usr/bin/finger|/usr/local/bin/finger|\\bfinger\\s+@[a-z]|\\bfinger\\s+-[lms]\\s)"

  - id: last-cmd
    desc: Last command for login history
    crit: suspicious
    conf: 0.8
    attack: "T1033"
    for: [shell, elf, macho]
    if:
      type: string
      exact: "/usr/bin/last"

  - id: w-cmd
    desc: W command for user sessions
    crit: suspicious
    conf: 0.75
    attack: "T1033"
    for: [shell, elf, macho]
    if:
      type: string
      exact: "/usr/bin/w"

composite_rules:
  # HOME environment composite
  - id: home-env
    desc: HOME environment variable lookup
    crit: notable
    conf: 0.7
    attack: "T1033"
    for: [all]
    count_min: 1
    any:
      - id: getenv-home
      - id: env-dot-home
      - id: dollar-home

  # Username environment composite
  - id: username-env
    desc: USERNAME environment variable
    crit: notable
    conf: 0.75
    attack: "T1033"
    for: [all]
    count_min: 1
    any:
      - id: username-var
      - id: user-var
      - id: logname-var

  # Active enumeration commands
  - id: active-enum-cmds
    desc: Active user enumeration commands
    crit: notable
    conf: 0.8
    attack: "T1033"
    for: [shell, elf, macho, pe, python]
    count_min: 1
    any:
      - id: whoami
      - id: etc-passwd
      - id: dscl
      - id: finger
      - id: last-cmd
      - id: w-cmd

  # Passive user lookup functions
  # NOTE: Go runtime uses these legitimately - downgraded to inert
  - id: passive-user-lookup
    desc: POSIX user lookup functions
    crit: inert
    conf: 0.4
    attack: "T1033"
    for: [elf, macho]
    count_min: 1
    any:
      - id: getpwnam
      - id: cap/process/identity/query/getuid
      - id: getpwuid

  # User enumeration detected (active commands + context)
  - id: enumeration-detected
    desc: User enumeration activity
    crit: suspicious
    conf: 0.9
    attack: "T1033"
    mbc: "B0046"
    for: [shell, elf, macho, pe, python]
    all:
      - id: active-enum-cmds
    any:
      - id: passive-user-lookup
      - id: username-env
      - id: home-env
