# Crontab Evidence Removal & Cleanup
# Detects patterns for removing cron job evidence and cleaning scheduled task records
# Malware removes evidence of itself and competing malware from cron systems
# ATT&CK: T1070.004 (File Deletion)
# MBC: B0005 (Defense Evasion)

traits:
  # === Crontab Location Targeting ===
  - id: var-spool-cron-target
    desc: Target /var/spool/cron crontab directory
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "/var/spool/cron"
    notes: "User-specific crontab files location"
    attack: "T1070.004"

  - id: etc-crontab-target
    desc: Target /etc/crontab system crontab
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "/etc/crontab"
    notes: "System-wide crontab file"
    attack: "T1070.004"

  - id: etc-cron-d-target
    desc: Target /etc/cron.d cron job directory
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "/etc/cron.d"
    notes: "Cron job drop-in directory"
    attack: "T1070.004"

  - id: cron-frequent-targets
    desc: Target frequent cron directories
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "/etc/cron.daily"
        - substr: "/etc/cron.hourly"
        - substr: "/etc/cron.weekly"
        - substr: "/etc/cron.monthly"
    notes: "Scheduled cron job directories"
    attack: "T1070.004"

  # === Evidence Removal Methods ===
  - id: sed-cron-removal
    desc: sed-based crontab evidence removal
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      all:
        - substr: "sed -i"
        - any:
          - substr: "/var/spool/cron"
          - substr: "/etc/crontab"
    notes: "In-place sed editing of cron files"
    attack: "T1070.004"

  - id: sed-deleted-pattern-cron
    desc: Remove deleted cron references
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "sed -i"
    notes: "Sed pattern for removing (deleted) process evidence"
    attack: "T1070.004"

  - id: rm-cron-files
    desc: Bulk removal of cron files
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "rm -f /var/spool/cron"
    notes: "Complete deletion of user crontab directory"
    attack: "T1070.004"

  - id: crontab-command
    desc: Direct crontab command usage
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      word: "crontab"
    notes: "crontab command interaction"

  # === File Test & Iteration ===
  - id: cron-file-test
    desc: Test for cron file existence
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: "[ -f"
    notes: "File existence check, typical in cleanup loops"
    attack: "T1070.004"

  - id: cron-loop-iteration
    desc: Loop iteration over cron files
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "for crontab in"
    notes: "Iterative processing of multiple cron files"
    attack: "T1070.004"

composite_rules:
  - id: cron-location-targeting
    desc: Targeting multiple cron file locations
    for: [elf, shell]
    any:
      - id: var-spool-cron-target
      - id: etc-crontab-target
      - id: etc-cron-d-target

  - id: cron-removal-methods
    desc: Methods for removing cron evidence
    any:
      - id: sed-cron-removal
      - id: sed-deleted-pattern-cron
      - id: rm-cron-files

  - id: cron-loop-removal
    desc: Looping removal of cron files
    all:
      - id: cron-loop-iteration
      - id: cron-file-test
      - id: cron-removal-methods

  - id: cron-file-cleanup
    desc: Complete crontab file cleanup
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1070.004"
    notes: |
      Malware performs comprehensive crontab cleanup:
      1. Iterate through crontab files
      2. Test for file existence
      3. Remove evidence using sed (deleted process removal)
      4. Bulk delete with rm -f

      Indicates forensics-aware malware covering tracks.
    all:
      - id: cron-loop-removal
      - id: cron-location-targeting
        count_min: 2

  - id: spool-cron-bulk-wipeout
    desc: Complete /var/spool/cron wipeout
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1070.004"
    mbc: "B0005"
    notes: |
      Aggressive removal pattern:
      - Target /var/spool/cron/* (all user crontabs)
      - Target /etc/crontab (system crontab)
      - Remove all references in sed patterns
      - Perform rm -f to delete entire directories

      Indicates malware eliminating all evidence of scheduled tasks.
    all:
      - id: rm-cron-files
      - id: var-spool-cron-target
      - id: sed-deleted-pattern-cron

  - id: comprehensive-cron-evidence-removal
    desc: Comprehensive crontab evidence removal campaign
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1070.004"
    mbc: "B0005"
    notes: |
      Complete malware evidence removal strategy targeting cron:

      1. Locate and iterate through all cron file locations:
         - /var/spool/cron/* (user crontabs)
         - /etc/crontab (system crontab)
         - /etc/cron.d/ (cron jobs)
         - /etc/cron.{daily,hourly,weekly,monthly}/

      2. For each file:
         - Test existence with [ -f ]
         - Use sed -i to remove (deleted) process references
         - Remove all malware/competitor process evidence

      3. Final cleanup:
         - Bulk delete /var/spool/cron/*
         - Ensure no trace of scheduled tasks remain

      Pattern indicates highly sophisticated, forensics-aware malware
      implementing multi-stage evidence destruction.
    all:
      - id: cron-file-cleanup
      - id: spool-cron-bulk-wipeout

  - id: kinsing-cron-cleanup
    desc: Kinsing cron job evidence removal
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1070.004"
    notes: |
      Kinsing performs systematic cron evidence removal:
      - Targets both user crontabs (/var/spool/cron)
      - Targets system crontab (/etc/crontab)
      - Removes all (deleted) process references
      - Eliminates evidence of previous malware/competitors
      - Uses sed for precision removal, rm for bulk deletion

      Part of comprehensive forensics evasion strategy.
    all:
      - id: kinsing-identifier
      - id: comprehensive-cron-evidence-removal
