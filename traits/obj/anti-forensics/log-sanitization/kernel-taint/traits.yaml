# Kernel Taint Erasure and Message Log Sanitization
# Detects kernel log and taint sanitization techniques

traits:
  # === Kernel Taint Erasure ===
  - id: tainted-mask
    desc: tainted_mask kernel variable
    crit: inert
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      exact: "tainted_mask"

  - id: taint-mask
    desc: taint_mask kernel variable
    crit: inert
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      exact: "taint_mask"

  # Kernel Taint Erasure (AST)
  - id: kernel-taint-assign
    desc: Direct assignment to kernel taint
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: ast
      kind: assignment
      exact: "*taint_mask_ptr = 0"

  # === Log Sanitization Functions ===
  - id: filter-kmsg
    desc: filter_kmsg function
    crit: inert
    conf: 0.75
    for: [c, elf]
    if:
      type: symbol
      exact: "filter_kmsg"

  - id: filter-taint
    desc: filter_taint function
    crit: inert
    conf: 0.75
    for: [c, elf]
    if:
      type: symbol
      exact: "filter_taint"

  - id: sanitize-log
    desc: sanitize_log function
    crit: inert
    conf: 0.75
    for: [c, elf]
    if:
      type: symbol
      exact: "sanitize_log"

  # === Kernel Log Paths ===
  - id: dev-kmsg-path
    desc: /dev/kmsg kernel message device
    crit: inert
    conf: 0.7
    for: [c, elf, shell]
    if:
      type: string
      substr: "/dev/kmsg"

  - id: do-syslog-symbol
    desc: do_syslog kernel function
    crit: inert
    conf: 0.7
    for: [c, elf]
    if:
      type: symbol
      exact: "do_syslog"

  # === TaskStats API ===
  - id: taskstats-user-cmd
    desc: taskstats_user_cmd kernel function
    crit: inert
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      exact: "taskstats_user_cmd"

  - id: taskstats-cmd-attr-pid
    desc: TASKSTATS_CMD_ATTR_PID constant
    crit: inert
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      substr: "TASKSTATS_CMD_ATTR_PID"

  - id: esrch-constant
    desc: ESRCH error constant (No such
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: string
      substr: "ESRCH"

composite_rules:
  - id: taint-mask-symbols
    desc: Kernel taint mask variables
    for: [c, elf]
    any:
      - { id: tainted-mask }
      - { id: taint-mask }

  - id: log-filter-functions
    desc: Log filtering/sanitization functions
    for: [c, elf]
    any:
      - { id: filter-kmsg }
      - { id: filter-taint }
      - { id: sanitize-log }

  - id: kmsg-access
    desc: Kernel message log access
    for: [c, elf, shell]
    any:
      - { id: dev-kmsg-path }
      - { id: do-syslog-symbol }

  - id: log-sanitization
    desc: Real-time filtering of dmesg or
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [c, elf]
    all:
      - { id: kmsg-access }
      - { id: log-filter-functions }

  - id: taskstats-deception
    desc: Blinds TaskStats netlink API to
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c, elf]
    all:
      - { id: taskstats-user-cmd }
      - { id: taskstats-cmd-attr-pid }
      - { id: esrch-constant }
