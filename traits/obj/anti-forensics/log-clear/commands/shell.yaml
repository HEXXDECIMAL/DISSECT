# Shell Log Clearing Detection
# Detects shell scripts that clear logs and history to cover tracks
# ATT&CK: T1070.003 (Indicator Removal: Clear Command History), T1070.002 (Clear Linux Logs)
# MBC: F0006 (Indicator Removal)

defaults:
  crit: suspicious
  attack: "T1070"
  mbc: "F0006"
  for: [shell]

traits:
  # === History Clearing ===
  - id: history-clear
    desc: Clears shell history
    crit: suspicious
    conf: 0.85
    attack: "T1070.003"
    if:
      type: raw
      regex: "\\bhistory\\s+-c\\b|>\\s*/root/\\.bash_history|echo\\s*>\\s*[^\\n]{0,30}\\.bash_history"

  - id: bash-history-wipe
    desc: Wipes bash_history file
    crit: suspicious
    conf: 0.85
    attack: "T1070.003"
    if:
      type: raw
      regex: "echo\\s*>\\s*(?:/root/|~/|\\$HOME/)\\.bash_history|rm\\s+-[rf]+\\s+[^\\n]{0,20}\\.bash_history"

  # === System Log Clearing ===
  - id: wtmp-clear
    desc: Clears wtmp login records
    crit: suspicious
    conf: 0.90
    attack: "T1070.002"
    if:
      type: raw
      regex: "echo\\s*>\\s*/var/log/wtmp|>\\s*/var/log/wtmp|rm\\s+-[rf]+\\s+/var/log/wtmp"

  - id: secure-log-clear
    desc: Clears secure/auth log
    crit: suspicious
    conf: 0.90
    attack: "T1070.002"
    if:
      type: raw
      regex: "echo\\s*>\\s*/var/log/(?:secure|auth\\.log)|>\\s*/var/log/(?:secure|auth\\.log)"

  - id: syslog-clear
    desc: Clears system syslog file
    crit: suspicious
    conf: 0.90
    attack: "T1070.002"
    if:
      type: raw
      regex: "echo\\s*>\\s*/var/log/syslog|rm\\s+-[rf]+\\s+/var/log/syslog|>\\s*/var/log/syslog"

  - id: mail-spool-clear
    desc: Clears mail spool
    crit: suspicious
    conf: 0.80
    attack: "T1070.002"
    if:
      type: raw
      regex: "echo\\s*>\\s*/var/spool/mail/|>\\s*/var/spool/mail/"

  # === Mass Log Clearing ===
  - id: mass-log-clear
    desc: Mass log file clearing
    crit: suspicious
    conf: 0.90
    attack: "T1070.002"
    if:
      type: raw
      regex: "rm\\s+-[rf]+\\s+/var/log/\\*|for\\s+[^;]{0,30}in\\s+/var/log/|find\\s+/var/log"

  # find + exec rm pattern for mass log deletion
  - id: find-exec-rm-log
    desc: Find-exec mass log deletion
    crit: suspicious
    conf: 0.95
    attack: "T1070.002"
    if:
      type: raw
      regex: 'find\s+[^\n]{0,30}-name\s+[^\n]{0,30}\.log[^\n]{0,30}-exec\s+rm'

composite_rules:
  # Combined history and log clearing indicates anti-forensics
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: anti-forensics-cleanup
    desc: Anti-forensics log and history cleanup
    crit: hostile
    conf: 0.95
    attack: "T1070"
    all:
      - id: history-clear
      - id: wtmp-clear
      - id: secure-log-clear

  # Alternative: bash history + mail spool (miner pattern)
  # Complexity: all(3) + for(1) = 4 >= 4 HOSTILE
  - id: miner-anti-forensics
    desc: Miner anti-forensics cleanup
    crit: hostile
    conf: 0.95
    attack: "T1070"
    all:
      - id: history-clear
      - id: wtmp-clear
      - id: mail-spool-clear
