# Timestomping Detection - Shell
# Behavioral composites for timestamp manipulation in evasion context
# MBC: F0006 (Timestomp)
# ATT&CK: T1070.006
#
# Note: Atomic touch flags moved to fs/file/timestamp/shell.yaml
# This file contains only behavioral composites

defaults:
  attack: "T1070.006"
  mbc: "F0006"
  for: [shell]

traits:
  # === Advanced timestamp manipulation techniques ===
  - id: dd-timestamp-modify
    desc: dd to modify file timestamps
    crit: suspicious
    conf: 0.7
    if:
      type: string
      regex: "dd\\s+.{0,50}conv=notrunc"

  - id: debugfs-timestamp
    desc: debugfs to modify ext filesystem
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "debugfs.{0,50}-w.{0,50}set_inode_field"

  - id: setfile-timestamp-macos
    desc: SetFile to modify macOS timestamps
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "SetFile\\s+-[dm]"

  - id: powershell-timestamp-modify
    desc: PowerShell timestamp modification
    crit: suspicious
    conf: 0.8
    for: [powershell]
    if:
      type: string
      regex: "\\.(CreationTime|LastWriteTime|LastAccessTime)\\s*="

  # === Timestamp-related keywords ===
  - id: timestomp-keyword
    desc: timestomp keyword (explicit evasion intent)
    crit: notable
    conf: 0.85
    if:
      type: string
      word: "timestomp"

  - id: timestamp-forge-keyword
    desc: timestamp forge keyword (explicit evasion
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "forge.{0,50}timestamp"

composite_rules:
  # Touch-based timestamp manipulation
  - id: timestomp-touch-specific
    desc: Set specific timestamp via touch
    crit: notable
    conf: 0.75
    any:
      - id: cap/fs/file/timestamp/shell/touch-t-flag
      - id: cap/fs/file/timestamp/shell/touch-r-flag
      - id: cap/fs/file/timestamp/shell/touch-date-flag

  # Generic touch timestamp modification
  - id: timestomp-touch
    desc: Timestamp modification via touch command
    crit: notable
    conf: 0.7
    any:
      - id: cap/fs/file/timestamp/shell/touch-timestamp-modification

  # Combined timestamp manipulation (multiple techniques)
  - id: timestamp-manipulation
    desc: Timestamp manipulation
    crit: notable
    conf: 0.6
    any:
      - id: timestomp-touch-specific
      - id: dd-timestamp-modify
      - id: debugfs-timestamp
      - id: setfile-timestamp-macos
      - id: powershell-timestamp-modify
      - id: timestomp-keyword
