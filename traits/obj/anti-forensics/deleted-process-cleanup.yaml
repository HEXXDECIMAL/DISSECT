# Deleted Process Evidence Removal
# Detects sophisticated patterns for removing evidence of deleted/exited processes
# Malware specifically searches for and removes evidence of its own execution or competitors
# ATT&CK: T1070.004 (File Deletion), T1070.005 (Network Traffic Clearing)
# MBC: B0005 (Defense Evasion)

traits:
  # === Deleted Process Hunting ===
  - id: proc-exe-deleted-search
    desc: Search /proc for deleted processes
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "ls -l /proc/*/exe"
    notes: "Searches for processes marked as (deleted) in /proc filesystem"
    attack: "T1070.004"

  - id: grep-deleted-process
    desc: grep deleted process references
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      substr: "grep deleted"
    notes: "Filters for deleted process references - evidence hunting"
    attack: "T1070.004"

  - id: awk-proc-extraction
    desc: Extract PID from /proc entries
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: "awk -F/"
    notes: "Extracts PID field from /proc entries for targeted killing"
    attack: "T1070.004"

  # === Process Termination for Cleanup ===
  - id: kill-9-deleted-processes
    desc: Send SIGKILL to deleted processes
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "kill -9"
    notes: "Forcibly terminates deleted processes"
    attack: "T1070.004"

  - id: pkill-deleted-pattern
    desc: pkill -9 targeting (deleted) processes
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      substr: "pkill -9 -f '(deleted)'"
    notes: "Pattern-based process killing of deleted references"
    attack: "T1070.004"

  # === Evidence Removal from Shell Configs ===
  - id: sed-bashrc-cleanup
    desc: sed removal from .bashrc files
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: ".bashrc"
    notes: "Targets bash shell configuration file"
    attack: "T1070.004"

  - id: sed-bash-profile-cleanup
    desc: sed removal from .bash_profile files
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: ".bash_profile"
    notes: "Targets bash login profile file"
    attack: "T1070.004"

  - id: sed-profile-cleanup
    desc: sed removal from .profile files
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: ".profile"
    notes: "Targets generic shell profile file"
    attack: "T1070.004"

  - id: sed-zshrc-cleanup
    desc: sed removal from .zshrc files
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: ".zshrc"
    notes: "Targets zsh shell configuration file"
    attack: "T1070.004"

  # === Sed-based Pattern Removal ===
  - id: sed-deleted-pattern-removal
    desc: Remove deleted references
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      substr: "sed -i"
    notes: "In-place sed editing to remove evidence patterns"
    attack: "T1070.004"

  - id: sed-deleted-regex-pattern
    desc: Regex for deleted process removal
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "\\|/usr/bin/\\..* (deleted)|d"
    notes: "Specific sed pattern removing /usr/bin/* (deleted) references"
    attack: "T1070.004"

  - id: sed-generic-deleted-removal
    desc: Sed removal of deleted references
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: ": \\+.*deleted"
        - substr: "(deleted)|d"
    notes: "Sed patterns removing evidence of deleted processes"
    attack: "T1070.004"

  # === Home Directory Targeting ===
  - id: home-directory-iteration
    desc: Iterate through home directories
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      substr: "/root /home"
    notes: "Targets both root and user home directories"
    attack: "T1070.004"

composite_rules:
  - id: deleted-process-detection
    desc: Detection of deleted process searches
    any:
      - id: proc-exe-deleted-search
      - id: grep-deleted-process

  - id: deleted-process-termination
    desc: Termination of deleted processes
    any:
      - id: kill-9-deleted-processes
      - id: pkill-deleted-pattern

  - id: shell-config-evidence-removal
    desc: Evidence removal from shell configuration files
    any:
      - id: sed-bashrc-cleanup
      - id: sed-bash-profile-cleanup
      - id: sed-profile-cleanup
      - id: sed-zshrc-cleanup

  - id: deleted-pattern-removal-methods
    desc: Methods for removing deleted process references
    any:
      - id: sed-deleted-pattern-removal
      - id: sed-deleted-regex-pattern
      - id: sed-generic-deleted-removal

  - id: comprehensive-deleted-cleanup
    desc: Complete workflow for deleted process evidence removal
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1070.004"
    mbc: "B0005"
    notes: |
      Sophisticated forensics evasion pattern:
      1. Search /proc filesystem for deleted processes
      2. Extract PIDs using awk/grep
      3. Forcibly terminate with SIGKILL
      4. Remove evidence from shell configuration files
      5. Use sed to remove specific deleted process references

      Indicates forensics-aware malware designed to cover its tracks.
    all:
      - id: deleted-process-detection
      - id: deleted-process-termination

  - id: targeted-shell-cleanup
    desc: Targeted removal from specific shell files
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1070.004"
    notes: |
      Malware iterates through home directories and removes evidence
      from all shell configuration files (.bashrc, .bash_profile, .profile, .zshrc).
      Pattern indicates multi-user system targeting.
    all:
      - id: home-directory-iteration
      - id: shell-config-evidence-removal
        count_min: 2
      - id: deleted-pattern-removal-methods

  - id: aggressive-evidence-removal
    desc: Aggressive multi-method evidence removal pattern
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1070.004"
    mbc: "B0005"
    notes: |
      Malware implements comprehensive evidence removal strategy:
      - Searches for and kills competing malware processes
      - Removes evidence from process lists
      - Cleans shell history across all home directories
      - Uses sed to remove specific forensic artifacts
      - Indicates highly sophisticated, forensics-aware malware

      Combined with other Kinsing patterns indicates complete evidence destruction.
    all:
      - id: comprehensive-deleted-cleanup
      - id: targeted-shell-cleanup
