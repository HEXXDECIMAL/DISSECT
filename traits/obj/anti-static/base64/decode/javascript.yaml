# Base64 Decode Detection - JavaScript
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1140

defaults:
  for: [javascript, typescript]
  mbc: "B0032"
  attack: "T1140"

traits:
  - id: decode-js
    desc: Base64 decoding in JavaScript
    crit: notable
    conf: 0.66
    if:
      type: string
      substr: "atob("

  - id: decode-exec-js
    desc: Base64 decode and execute
    crit: suspicious
    conf: 0.66
    if:
      type: string
      substr: "eval(atob("

  # Double/nested atob - strong obfuscation signal
  - id: nested-atob
    desc: Nested base64 decode (atob(atob))
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "atob\\(atob\\("

  # Buffer.from double decode
  - id: nested-buffer-base64
    desc: Nested Buffer.from base64 decode
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      regex: "Buffer\\.from\\(Buffer\\.from\\(.{0,50}base64"

composite_rules:
  # Any nested decoding pattern
  - id: nested-decode
    desc: Nested base64 decoding (obfuscation)
    crit: suspicious
    conf: 0.92
    for: [javascript, typescript]
    any:
      - id: nested-atob
      - id: nested-buffer-base64
