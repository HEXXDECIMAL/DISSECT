# XOR Obfuscation Detection
# Detects XOR-based string/data obfuscation patterns
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [elf, macho, pe]
  mbc: "B0032"
  attack: "T1027"

traits:
  # === XOR decode symbol atomic indicators ===
  - id: xor-decode-symbol
    desc: xor_decode symbol
    crit: suspicious
    conf: 0.8
    if:
      type: symbol
      exact: "xor_decode"

  - id: decode-xor-symbol
    desc: decode_xor symbol
    crit: suspicious
    conf: 0.8
    if:
      type: symbol
      exact: "decode_xor"

  - id: xor-decrypt-symbol
    desc: xor_decrypt symbol
    crit: suspicious
    conf: 0.8
    if:
      type: symbol
      exact: "xor_decrypt"

  - id: decrypt-xor-symbol
    desc: decrypt_xor symbol
    crit: suspicious
    conf: 0.8
    if:
      type: symbol
      regex: "decrypt_xor"

  - id: xor-string-symbol
    desc: xor_string symbol
    crit: suspicious
    conf: 0.8
    if:
      type: symbol
      regex: "xor_string"

  # === Single-byte XOR key atomic indicators ===
  - id: xor-key-0x37
    desc: XOR key 0x37 repeated
    crit: inert
    conf: 0.55
    for: [elf]
    if:
      type: content
      regex: "0x37"

  # === Table-based decode atomic indicators ===
  - id: decode-table-symbol
    desc: decode_table symbol
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "decode_table"

  - id: table-decode-symbol
    desc: table_decode symbol
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "table_decode"

  - id: lookup-decode-symbol
    desc: lookup_decode symbol
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "lookup_decode"

  # NOTE: "char_map" is extremely common in font libraries (FreeType, HarfBuzz)
  # where it refers to character-to-glyph mappings. Only flag as obfuscation
  # when combined with other obfuscation indicators (e.g., XOR, decrypt symbols).
  # Removed from standalone matching; only used in composite rules with needs: 2
  - id: char-map-symbol
    desc: char_map symbol
    crit: inert
    conf: 0.3
    if:
      type: symbol
      # Require explicit obfuscation context - char_map alone is too common
      # Match only when preceded/followed by obfuscation-related terms
      regex: "(?:xor|decode|decrypt|obfusc|cipher)[_-]?char_map|char_map[_-]?(?:xor|decode|decrypt|obfusc|cipher)"

  # === Multi-byte XOR key detection ===
  # NOTE: Generic alphanumeric strings are too common in binaries (identifiers,
  # debug strings, version info). These patterns are only useful in composite
  # rules that also require XOR-related symbols or other obfuscation indicators.
  # Disabled as standalone traits due to excessive false positives.
  #
  # - id: xor-key-multibyte-31
  #   desc: 31-byte alphanumeric XOR key pattern
  #   crit: inert
  #   conf: 0.5
  #   for: [elf, macho, pe]
  #   if:
  #     type: string
  #     regex: "\\b[a-zA-Z0-9]{31}\\b"
  #     needs: 1
  #
  # - id: xor-key-multibyte-16-32
  #   desc: 16-32 byte random-looking key in
  #   crit: inert
  #   conf: 0.5
  #   for: [elf, macho, pe]
  #   if:
  #     type: string
  #     regex: "\\b[a-zA-Z0-9]{16,32}\\b"
  #     needs: 1
  - id: xor-key-embedded-homabrews
    desc: "Known homabrews.org XOR key"
    crit: suspicious
    conf: 1.0
    if:
      type: content
      exact: "fYztZORL5VNS7nCUH1ktn5UoJ8VSgaf"

composite_rules:
  - id: xor-decode-loop
    desc: "XOR decryption loop pattern"
    crit: suspicious
    conf: 0.85
    needs: 1
    any:
      - id: xor-decode-symbol
      - id: decode-xor-symbol
      - id: xor-decrypt-symbol
      - id: decrypt-xor-symbol
      - id: xor-string-symbol

  - id: table-based-decode
    desc: "Table-based decoding function"
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: decode-table-symbol
      - id: table-decode-symbol
      - id: lookup-decode-symbol
      - id: char-map-symbol

  - id: string-decrypt
    desc: "String decryption capability"
    crit: suspicious
    conf: 0.8
    any:
      - id: xor-decode-loop
      - id: table-based-decode
