# Obfuscation Logic Detection
# Detects common obfuscation/deobfuscation code patterns in binaries
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # Stack string construction pattern - 5+ mov [rbp-x], imm8 in sequence
  # Pattern: C6 45 XX YY (mov byte ptr [rbp-XX], YY)
  - id: stack-string-construction
    desc: Stack string construction pattern (5+
    crit: inert
    conf: 0.4
    attack: "T1027"
    for: [elf, macho, pe]
    if:
      type: hex
      pattern: "C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ??"

  # NOTE: Removed overly broad xor-loop-pattern hex signature.
  # The pattern "30 ?? ?? ?? ?? ?? E2" (XOR + LOOP instruction) matches
  # many legitimate code sequences including games, crypto libraries, and
  # compression routines. XOR-based obfuscation detection should rely on
  # behavioral analysis or more specific patterns (e.g., XOR with hardcoded
  # key in a tight loop with specific register usage).

composite_rules:
  # String obfuscation composite - only stack-string-construction remains
  # after removing overly broad xor-loop-pattern
  - id: string-deobfuscation
    desc: String obfuscation/deobfuscation pattern
    crit: inert
    conf: 0.4
    attack: "T1027"
    for: [elf, macho, pe]
    count_min: 1
    any:
      - id: stack-string-construction
