# Advanced String Array Obfuscation - JavaScript
# Detects sophisticated string array obfuscation patterns used in malware
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # Large random variable names (>30 chars) typical of obfuscators
  - id: large-random-variables
    desc: Large random variable names (obfuscation)
    crit: notable
    conf: 0.75
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\b[A-Z][a-zA-Z0-9_]{25,}\\b"
      count_min: 3
      per_kb_min: 0.1

  # String array with hexadecimal indexing patterns
  - id: string-array-hex-index
    desc: String array with hex indexing
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\w+\\(\\s*0x[0-9a-fA-F]{2,4}\\s*\\)"
      count_min: 5
      per_kb_min: 0.2

  # String assignment to array with hex indices
  - id: hex-array-assignment
    desc: Hex array index assignment pattern
    crit: suspicious
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\[\\s*['\"][0-9a-fA-F]{2,4}['\"]\\s*\\]\\s*=\\s*['\"][^'\"]+['\"]"
      count_min: 3

  # String array declaration with large obfuscated variable names
  - id: obfuscated-string-array
    desc: Obfuscated string array declaration
    crit: suspicious
    conf: 0.82
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "var\\s+[A-Z][a-zA-Z0-9_]{20,}\\s*=\\s*[A-Z][a-zA-Z0-9_]{20,}\\s*;"

  # Function call with hex string argument pattern
  - id: hex-string-function-call
    desc: Function call with hex string argument
    crit: notable
    conf: 0.78
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\w+\\s*\\(\\s*['\"][0-9a-fA-F]{6,}['\"]\\s*\\)"
      count_min: 2

  # Multiple concatenated string literals (typical in deobfuscation)
  - id: massive-string-concatenation
    desc: Massive string concatenation operations
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\+\\s*['\"][^'\"]{20,}['\"]"
      count_min: 10
      per_kb_min: 0.5

  # Array element access with computed indices
  - id: computed-array-access
    desc: Array access with computed indices
    crit: notable
    conf: 0.72
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\w+\\[\\s*\\w+\\s*\\+\\s*0x[0-9a-fA-F]+\\s*\\]"
      count_min: 3

composite_rules:
  # Advanced string array obfuscation composite
  - id: advanced-string-array-obfuscation
    desc: Advanced string array obfuscation pattern
    crit: suspicious
    conf: 0.92
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    needs: 2
    any:
      - id: large-random-variables
      - id: string-array-hex-index
      - id: hex-array-assignment
      - id: obfuscated-string-array
    all:
      - id: massive-string-concatenation

  # String deobfuscation routine
  - id: string-deobfuscation-routine
    desc: String deobfuscation routine
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027.002"
    for: [javascript, typescript]
    all:
      - id: large-random-variables
      - id: string-array-hex-index
      - id: massive-string-concatenation
    any:
      - id: hex-array-assignment
      - id: computed-array-access