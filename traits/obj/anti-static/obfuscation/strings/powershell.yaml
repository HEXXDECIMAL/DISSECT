# String Obfuscation Detection - PowerShell
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027, T1059.001

defaults:
  for: [powershell, batch, shell]
  mbc: "B0032"
  attack: "T1027"

traits:
  # Character array obfuscation - [char[]]@(...) or -join [char[]]@(...)
  - id: ps-chararray
    desc: PowerShell char array obfuscation
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "\\[char\\[\\]\\]@\\("

  # Alternative: -join(... charcode patterns
  - id: ps-join-char
    desc: PowerShell join with char conversion
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "-join\\s*\\[char\\[\\]\\]"

  # Numeric character codes pattern (many numbers in array)
  - id: ps-numeric-chararray
    desc: Numeric character array payload
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "@\\(\\d{1,3}(,\\d{1,3}){10,}\\)"

  # [char]N pattern for individual characters
  - id: ps-individual-char
    desc: Individual char casting
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\[char\\]\\d{2,3}"

  # ToCharArray with pipeline for ROT cipher
  - id: ps-rot-cipher
    desc: ROT cipher pattern
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "\\.ToCharArray\\(\\)\\s*\\|\\s*%\\s*\\{"

  # iex or Invoke-Expression
  - id: ps-iex
    desc: Invoke-Expression (iex) call
    crit: notable
    conf: 0.75
    for: [powershell, batch, shell]
    attack: "T1059.001"
    if:
      type: string
      regex: "\\biex\\b|Invoke-Expression"
      case_insensitive: true

  # Execution policy bypass
  - id: ps-ep-bypass
    desc: Execution policy bypass
    crit: suspicious
    conf: 0.9
    for: [powershell, batch, shell]
    attack: "T1059.001"
    if:
      type: string
      regex: "-e[px]\\s+[Bb]ypass|-ExecutionPolicy\\s+[Bb]ypass"

  # Hidden window style
  - id: ps-hidden-window
    desc: Hidden window execution
    crit: suspicious
    conf: 0.85
    for: [powershell, batch, shell]
    attack: "T1564.003"
    if:
      type: string
      regex: "-[Ww]indow[Ss]tyle\\s+[Hh]idden|-[Ww]\\s+[Hh]idden"

  # NoProfile flag (avoid loading user profile)
  - id: ps-noprofile
    desc: NoProfile flag
    crit: notable
    conf: 0.7
    for: [powershell, batch, shell]
    if:
      type: string
      regex: "-[Nn]o[Pp]rofile|-[Nn]op\\b"

  # Encoded command
  - id: ps-encoded-command
    desc: Base64 encoded command
    crit: suspicious
    conf: 0.9
    for: [powershell, batch, shell]
    attack: "T1027"
    if:
      type: string
      regex: "-[Ee]ncoded[Cc]ommand|-[Ee][Cc]\\s"

composite_rules:
  # Character array obfuscation pattern
  - id: ps-chararray-obfuscation
    desc: PowerShell char array obfuscation
    crit: suspicious
    conf: 0.9
    for: [powershell, batch, shell]
    count_min: 1
    any:
      - id: ps-chararray
      - id: ps-join-char
      - id: ps-numeric-chararray

  # Obfuscated eval - char array + iex
  - id: ps-obfuscated-eval
    desc: Obfuscated PowerShell eval
    crit: hostile
    conf: 0.95
    attack: "T1027"
    for: [powershell, batch, shell]
    all:
      - id: ps-iex
    any:
      - id: ps-chararray
      - id: ps-join-char
      - id: ps-numeric-chararray
      - id: ps-rot-cipher

  # Evasive execution flags
  - id: ps-evasive-flags
    desc: Evasive PowerShell execution
    crit: suspicious
    conf: 0.85
    for: [powershell, batch, shell]
    count_min: 2
    any:
      - id: ps-ep-bypass
      - id: ps-hidden-window
      - id: ps-noprofile
      - id: ps-encoded-command
