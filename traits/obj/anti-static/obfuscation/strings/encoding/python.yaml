# String Obfuscation Detection - Python
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

defaults:
  # String patterns work in both Python source and frozen executables (PyInstaller, Nuitka, etc.)
  for: [python, elf, macho, pe]
  mbc: "B0032"
  attack: "T1027"

traits:
  # Migrated from YARA: hex escape sequences like \x41\x42\x43\x44
  - id: python-hex
    desc: "Detects hex-encoded string patterns (\\xNN"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(\\\\x[0-9a-fA-F]{2}){4,}"

  # Migrated from YARA: octal escape sequences like \101\102\103\104
  - id: python-octal
    desc: "Detects octal-encoded string patterns (\\NNN"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(\\\\[0-7]{3}){4,}"

  - id: python-chr
    desc: "Character code manipulation (chr/ord)"
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: '\\b(chr|ord)\('

  # AST-based detection (Python source only)
  - id: concatenated-execution
    desc: "String concatenation in execution sink"
    crit: suspicious
    conf: 0.85
    for: [python]
    if:
      type: ast
      query: |
        ((call
          function: (identifier) @func
          arguments: (argument_list
            (binary_operator
              left: (string)
              operator: "+"
              right: (string))))
         (#match? @func "^(exec|eval|b64decode|system|compile)$"))

  - id: python-exec-eval
    desc: "Dynamic code execution via exec()"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: 'exec\(|eval\('

  # === Decoding function atomic indicators ===
  # Removed b64decode-call duplicate - use cap/data/encode/base64::b64decode-string

  - id: fromhex-call
    desc: fromhex function
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "fromhex"

  - id: bytes-fromhex-call
    desc: bytes.fromhex function
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "bytes.fromhex"

  - id: bz2-decompress-call
    desc: bz2.decompress function
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "bz2.decompress"

  # Removed zlib-decompress-call duplicate - use cap/data/compression/library::zlib-decompress-symbol (symbol is more precise)
  # Removed marshal-loads-call duplicate - use cap/data/serialization/unsafe::marshal-loads-symbol (symbol is more precise)

  # Reverse byte order in encoded/hex data - anti-analysis technique
  # Avoid false positives from legitimate slice operations by requiring context
  - id: reverse-bytes
    desc: Reverses byte order of encoded data
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: "(?:fromhex|b64decode|unhexlify)\\(.{0,50}\\[::-1\\]|\\[::-1\\].{0,50}(?:fromhex|b64decode|unhexlify)"

  # === Density-Based Obfuscation Detection ===
  # Legitimate code rarely has more than a few chr() calls.
  # Obfuscated code builds entire strings character by character.

  - id: python-dense-chr-calls
    desc: Dense chr() calls (string building)
    crit: suspicious
    conf: 0.90
    mbc: "B0032"
    attack: "T1027"
    if:
      type: raw
      regex: "chr\\s*\\(\\s*\\d{1,3}\\b"
      count_min: 15
      per_kb_min: 3.0
    unless:
      - type: basename
        regex: '(?i)^(?:test_.*|.*_test)\.py$'

  - id: python-dense-hex-escapes
    desc: Dense hex escape sequences
    crit: suspicious
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    # Small binaries with dense hex escapes are more suspicious
    size_max: 5000
    if:
      type: string
      regex: '(\\x[0-9a-fA-F]{2}){4,}'
      count_min: 20
      per_kb_min: 5.0
    unless:
      - type: basename
        regex: '(?i)^(?:test_.*|.*_test)\.py$'
      - type: raw
        substr: "WalImageFile"

  - id: dense-octal-escapes
    desc: Dense octal escape sequences
    crit: suspicious
    conf: 0.88
    mbc: "B0032"
    attack: "T1027"
    if:
      type: string
      regex: '(\\[0-7]{3}){4,}'
      count_min: 10
      per_kb_min: 2.0
    unless:
      - type: basename
        regex: '(?i)^(?:test_.*|.*_test)\.py$'

  # Heavy use of ord() often accompanies XOR/cipher operations
  - id: dense-ord-calls
    desc: Dense ord() calls (cipher operations)
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    if:
      type: raw
      regex: "\\bord\\s*\\("
      count_min: 20
      per_kb_min: 3.0
    unless:
      - type: basename
        regex: '(?i)^(?:test_.*|.*_test)\.py$'

  # Lambda chains are used for obfuscation in Python
  - id: dense-lambda-chains
    desc: Dense lambda expressions (obfuscation)
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    if:
      type: raw
      regex: "((?:\\(|:)\\s*lambda\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*:.{0,50}lambda\\s+[a-zA-Z_][a-zA-Z0-9_]*)|(\\(\\s*lambda\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*:.{0,50}\\)\\s*\\()"
      count_min: 8
      per_kb_min: 2.0
    unless:
      - type: basename
        regex: '(?i)^(?:test_.*|.*_test)\.py$'

composite_rules:
  # Decode functions composite
  - id: python-decode-functions
    desc: "Decoding functions for encoded payloads"
    crit: notable
    conf: 0.7
    any:
      - id: cap/data/encode/base64::b64decode-string
      - id: fromhex-call
      - id: bytes-fromhex-call
      - id: bz2-decompress-call
      - id: cap/data/compression/library::zlib-decompress-symbol
      - id: cap/data/serialization/unsafe::marshal-loads-symbol

  - id: execute-decoded-content
    desc: "Direct execution of decoded content"
    crit: hostile
    conf: 0.98
    all:
      - id: python-exec-eval
      - id: python-decode-functions
      - id: python-chr

  - id: python-encoded-pattern
    desc: "Detects encoded string patterns (hex"
    crit: notable
    any:
      - id: python-hex
      - id: python-octal

  - id: obfuscated-execution
    desc: "Direct execution of encoded string"
    crit: hostile
    conf: 0.95
    all:
      - id: python-exec-eval
      - id: python-encoded-pattern
      - id: python-chr
