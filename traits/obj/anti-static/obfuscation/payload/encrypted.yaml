# Encrypted Payload Detection
# Detects encrypted/obfuscated payload droppers via section analysis
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [macho, elf, pe]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === Section Ratio Indicators ===

  - id: large-const-section
    desc: "Large __const section (>80% of"
    crit: suspicious
    conf: 0.8
    for: [macho]
    if:
      type: section_ratio
      section: "__const"
      compare_to: "total"
      min_ratio: 0.80

  - id: large-data-section
    desc: "Large .data section (>70% of"
    crit: suspicious
    conf: 0.75
    for: [elf, pe]
    if:
      type: section_ratio
      section: "\\.(data|rdata)"
      compare_to: "total"
      min_ratio: 0.70

  - id: tiny-cstring
    desc: "Tiny __cstring section (<0.1% of"
    crit: notable
    conf: 0.7
    for: [macho]
    if:
      type: section_ratio
      section: "__cstring"
      compare_to: "total"
      max_ratio: 0.001

  - id: minimal-text
    desc: "Small code section (<5% of"
    crit: notable
    conf: 0.65
    for: [macho]
    if:
      type: section_ratio
      section: "__text"
      compare_to: "total"
      max_ratio: 0.05

  # === Entropy Indicators ===

  # NOTE: Many legitimate system binaries have high-entropy __const sections
  # (lookup tables, compressed data, crypto constants). Downgraded to notable.
  # Only suspicious when combined with other indicators in composite rules.
  - id: high-entropy-const
    desc: "High entropy in __const section"
    crit: notable
    conf: 0.6
    mbc: "C0027"
    for: [macho]
    if:
      type: section_entropy
      section: "__const"
      min_entropy: 7.5

  # NOTE: High entropy in data sections is common in legitimate software:
  # - Games (compressed assets, lookup tables)
  # - Multimedia apps (embedded media)
  # - Crypto software (key material, random data)
  # - System libraries (lookup tables, compression, Unicode tables)
  # Only suspicious when combined with other indicators (see composites).
  - id: high-entropy-data
    desc: "High entropy in data section"
    crit: notable
    conf: 0.6
    mbc: "C0027"
    for: [elf, pe]
    if:
      type: section_entropy
      section: "\\.(data|rdata|rodata)"
      min_entropy: 7.5
    # System libraries commonly have high-entropy lookup tables
    downgrade:
      any:
        - type: basename
          regex: "^lib(X11|xcb|ssl|crypto|c|z|png|jpeg|xml|curl|pcre|iconv|icu|freetype|fontconfig|harfbuzz|cairo|pango|glib|gtk|qt)\\b"

  - id: high-entropy-text
    desc: "High entropy in code section"
    crit: suspicious
    conf: 0.9
    mbc: "B0032.002"
    if:
      type: section_entropy
      section: "(__text|\\.text)"
      min_entropy: 7.0

  # === String Concealment ===

  - id: string-concealment
    desc: "Very few visible strings (<10)"
    crit: notable
    conf: 0.7
    if:
      type: string_count
      max: 10
      min_length: 4

  - id: no-strings
    desc: "No visible strings in binary"
    crit: suspicious
    conf: 0.8
    for: [macho, elf, pe]
    if:
      type: string_count
      max: 0
      min_length: 4

  # === Import Patterns ===

  - id: math-cipher-imports
    desc: "Math functions (cipher indicator) with"
    crit: suspicious
    conf: 0.85
    for: [macho]
    if:
      type: import_combination
      required:
        - "^_?system$"
      suspicious:
        - "^_?(cos|sin|tan|exp|pow|log|sqrt|fmod|hypot|log1p)$"
      min_suspicious: 4

  - id: minimal-imports
    desc: "Very few imports (<50) with"
    crit: notable
    conf: 0.7
    if:
      type: import_combination
      required:
        - "^_?system$"
      max_total: 50

composite_rules:
  # === Encrypted Dropper Detection ===

  - id: encrypted-payload-dropper
    desc: "Encrypted payload dropper (large encrypted"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    mbc: "B0032"
    for: [macho]
    needs: 2
    any:
      - id: large-const-section
      - id: high-entropy-const
      - id: tiny-cstring
      - id: minimal-text
      - id: string-concealment

  - id: cipher-dropper
    desc: "Cipher-based dropper (math imports +"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    mbc: "C0027"
    for: [macho]
    all:
      - id: math-cipher-imports
      - id: high-entropy-const
    any:
      - id: string-concealment
      - id: tiny-cstring

  - id: elf-encrypted-dropper
    desc: "Encrypted payload dropper (ELF)"
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    mbc: "B0032"
    for: [elf]
    needs: 2
    any:
      - id: large-data-section
      - id: high-entropy-data
      - id: string-concealment

  # === Obfuscated Daemon Dropper (HOSTILE) ===
  # Combines encrypted payload indicators with daemon and exec behavior
  # This pattern is highly suspicious: encrypted binary + backgrounding + command exec

  - id: obfuscated-macos-daemon-dropper
    desc: "Obfuscated macOS daemon dropper (encrypted payload"
    crit: hostile
    conf: 0.92
    attack: "T1027"
    mbc: "B0032"
    for: [macho]
    # Complexity: all(2) + any(2) + file_types(1) = 5 >= 4 âœ“
    all:
      - id: high-entropy-const
      - id: tiny-cstring
    any:
      - id: obj/persist/daemon/init/macos-double-fork-daemon
      - id: cap/exec/command/shell/shell-execution
