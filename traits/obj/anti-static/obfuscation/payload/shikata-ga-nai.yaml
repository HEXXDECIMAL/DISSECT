# Shikata Ga Nai Encoder Detection
# Detects Metasploit's polymorphic XOR additive feedback encoder
# Reference: https://www.fireeye.com/blog/threat-research/2019/10/shikata-ga-nai-encoder-still-going-strong.html
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [elf, macho, pe]
  attack: "T1027"
  mbc: "B0032"

traits:
  - id: shikata-ga-nai-stub
    desc: Shikata Ga Nai decoder stub pattern
    crit: suspicious
    conf: 0.90
    for: [elf, macho, pe]
    attack: "T1027.002"
    mbc: "B0032.009"
    if:
      type: hex
      # FNSTENV [ESP-0Ch] followed by POP to get EIP
      # D9 74 24 F4 = FNSTENV [ESP-0xC]
      # 59 = POP ECX (or other register)
      # Common GetPC technique in Shikata Ga Nai
      pattern: "D9 74 24 F4 ?? ?? ?? ?? ?? 59"
