# Large Obfuscated Payload Detection - Python
# Detects large blobs of encoded data embedded in scripts
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # === Hex decoding functions ===
  - id: binascii-unhexlify
    desc: Hex decoding via binascii.unhexlify
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1140"
    for: [python]
    if:
      type: content
      substr: "binascii.unhexlify"

  - id: unhexlify-import
    desc: unhexlify function import
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1140"
    for: [python]
    if:
      type: content
      regex: "from\\s+binascii\\s+import.{0,50}unhexlify"

  - id: binascii-import
    desc: binascii module import
    crit: inert
    conf: 0.9
    for: [python]
    if:
      type: content
      regex: "import\\s+binascii\\b"

  # === Content-based exec/eval detection ===
  # These use content: instead of string: to match function calls in source
  - id: exec-function-call
    desc: exec() function call
    crit: notable
    conf: 0.7
    mbc: "E1059"
    attack: "T1059"
    for: [python]
    if:
      type: content
      regex: "exec\\s*\\("

  - id: eval-function-call
    desc: eval() function call
    crit: notable
    conf: 0.7
    mbc: "E1059"
    attack: "T1059"
    for: [python]
    if:
      type: content
      # Match eval( preceded by = or ( or : or , (assignment/call/dict/args)
      # Excludes: def eval(), .eval(), etc.
      regex: "[=(,]\\s*eval\\s*\\("

  # Large base64-like string (512+ chars)
  - id: large-base64-string
    desc: Large base64-like string (512+ chars)
    crit: notable
    conf: 0.75
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "[A-Za-z0-9+/]{512,}"

  # Large hex string (1024+ chars)
  - id: large-hex-string
    desc: Large hex-encoded string (1024+ chars)
    crit: notable
    conf: 0.75
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "[0-9a-fA-F]{1024,}"

  # exec() with decode pattern
  - id: exec-decode-pattern
    desc: exec() with decode chain (payload
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "exec\\s*\\([^)]*decode\\s*\\("

  # eval() with decode pattern
  - id: eval-decode-pattern
    desc: eval() with decode chain (payload
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "eval\\s*\\([^)]*decode\\s*\\("

  # compile() with exec pattern
  - id: compile-exec-pattern
    desc: compile() with exec (dynamic code
    crit: suspicious
    conf: 0.8
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "compile\\s*\\([^)]+,\\s*['\"][^'\"]+['\"]\\s*,\\s*['\"]exec['\"]\\s*\\)"

  # === Compiled Python bytecode (.pyc) disguised as .py ===
  # Python bytecode magic number in a .py file indicates the file was
  # compiled and renamed to evade source-level analysis.
  # CB0D = Python 3.13, A70D = 3.12, 610D = 3.11, 420D = 3.10
  # The 0D0A trailer and co_code marker (E3) confirm valid bytecode.
  - id: pyc-magic-in-py
    desc: Python bytecode magic in .py file
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1036.008"
    for: [python]
    if:
      type: yara
      source: |
        rule pyc_magic_in_py {
          strings:
            $pyc = { ( CB | A7 | 61 | 42 | 6F | 55 ) 0D 0D 0A }
          condition:
            $pyc
        }

  # unhexlify name in bytecode (without binascii. prefix)
  # Compiled bytecode stores function names as separate identifiers
  - id: unhexlify-in-bytecode
    desc: unhexlify reference in bytecode
    crit: notable
    conf: 0.75
    mbc: "B0032"
    attack: "T1140"
    for: [python]
    if:
      type: content
      substr: "unhexlify"

  # Bytecode containing both exec and eval names alongside __import__
  # Strong indicator of multi-stage payload decoding
  - id: bytecode-exec-eval-import
    desc: Bytecode with exec eval and __import__
    crit: suspicious
    conf: 0.85
    mbc: "E1059"
    attack: "T1059"
    for: [python]
    if:
      type: yara
      source: |
        rule bytecode_exec_eval_import {
          strings:
            $exec = "exec" ascii
            $eval = "eval" ascii
            $import = "__import__" ascii
            $unhex = "unhexlify" ascii
          condition:
            $exec and $eval and $import and $unhex
        }

  # Self-reading bytecode: __file__ + open + read in content
  # Bytecode that reads its own file to extract embedded payload
  - id: bytecode-self-reader
    desc: Bytecode reads own file for payload
    crit: suspicious
    conf: 0.90
    mbc: "B0032"
    attack: "T1027"
    for: [python]
    if:
      type: yara
      source: |
        rule bytecode_self_reader {
          strings:
            $file = "__file__" ascii
            $open = "open" ascii
            $read = "read" ascii
            $exec = "exec" ascii
            $join = "''.join" ascii
          condition:
            $file and $open and $read and ($exec or $join)
        }

composite_rules:
  # === Hex decode execution patterns ===
  # exec(binascii.unhexlify(...)) - classic malware obfuscation
  # Complexity: file_types(+1) + all(+2) + any(+1) = 4
  - id: exec-unhexlify
    desc: Execute hex-decoded payload
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [python]
    all:
      - id: exec-function-call
      - id: binascii-unhexlify
    any:
      - id: unhexlify-import
      - id: binascii-import
      - id: obj/anti-static/obfuscation/code-metrics::low-whitespace

  # Large encoded string composite (migrated from YARA)
  - id: large-encoded-string
    desc: Large high-entropy string literal (likely
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [python]
    any:
      - id: large-base64-string
      - id: large-hex-string

  # Payload execution composite
  - id: payload-execution
    desc: Large encoded payload with dynamic
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [python]
    all:
      - id: large-encoded-string
    any:
      - id: exec-decode-pattern
      - id: eval-decode-pattern
      - id: compile-exec-pattern

  # Compiled bytecode with payload execution pipeline
  # Self-reading + exec/eval/import + unhexlify + obfuscation indicators
  # Precision: for(+0.3) + all(+2) + any(+1) + any(+1) = 4.3
  - id: bytecode-payload-execution
    desc: Compiled bytecode payload execution pipeline
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [python]
    all:
      - id: bytecode-exec-eval-import
      - id: bytecode-self-reader
    any:
      - id: unhexlify-in-bytecode
      - id: obj/anti-static/obfuscation/code-metrics::minified-code
      - id: obj/anti-static/obfuscation/tools::known-obfuscator-detected
