# Mach-O Data-to-Code Ratio Anomalies
# Detects binaries where data significantly dominates logic (dropper pattern)
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  platforms: [macos]
  for: [macho]
  mbc: "B0032"

traits:
  - id: low-code-to-data-ratio
    desc: "Very low code-to-data ratio (large payload)"
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: binary.code_to_data_ratio
      max: 0.1  # Code is less than 10% of data size

composite_rules:
  - id: macho-extreme-data-to-code-ratio
    desc: "Mach-O extreme data-to-code ratio (possible encrypted payload)"
    crit: suspicious
    conf: 0.9
    # High-confidence: Low code ratio PLUS other packing/obfuscation markers
    all:
      - id: low-code-to-data-ratio
    any:
      - id: obj/anti-static/obfuscation/binary-metrics::dominant-section
      - id: meta/binary/structure::minimal-string-count
      - id: obj/anti-static/obfuscation/payload::high-entropy-const

  - id: macho-high-entropy-data-dropper
    desc: "Mach-O high-entropy data payload dropper"
    crit: hostile
    conf: 0.95
    # Combines ratio anomaly with high entropy and execution capability
    all:
      - id: macho-extreme-data-to-code-ratio
      - id: obj/anti-static/obfuscation/payload::high-entropy-const
      - id: cap/exec/command/shell::system-call-symbol
    none:
      - id: meta/signed/platform::apple