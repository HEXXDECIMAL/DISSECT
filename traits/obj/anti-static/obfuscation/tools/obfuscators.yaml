# Python Obfuscator Detection
# Detects known Python obfuscators and generic obfuscation patterns
# ATT&CK: T1027 (Obfuscated Files)
# MBC: E1014 (Data Encoding)

defaults:
  crit: notable
  attack: "T1027"
  mbc: "E1014"
  for: [python]

traits:
  # === Obfuscator Signatures ===
  - id: blankobf-signature
    desc: BlankOBF obfuscator signature
    crit: suspicious
    conf: 0.95
    if:
      type: content
      substr: "Obfuscated with BlankOBF"

  - id: pyarmor-signature
    desc: PyArmor obfuscator signature
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: "pyarmor|__pyarmor"

  - id: pyobfuscate-signature
    desc: PyObfuscate signature
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: "pyobfuscate\\s*=\\s*\\(|https://pyobfuscate\\.com|obfuscated|obfuscator"

  # Oas-obf bytecode obfuscator: compiles Python to .pyc with custom
  # encoding, uses class "Kramer" with __decode__/_rasputin/_execute methods
  - id: oas-obf-signature
    desc: Oas-obf bytecode obfuscator signature
    crit: suspicious
    conf: 0.95
    if:
      type: content
      substr: "Oas-obf"

  # === Variable Name Obfuscation ===
  - id: underscore-only-variables
    desc: Underscore only variable names
    crit: suspicious
    conf: 0.80
    if:
      type: content
      regex: "^_{3,20}="

  - id: excessive-underscore-vars
    desc: Excessive underscore variables
    crit: suspicious
    conf: 0.75
    if:
      type: content
      regex: "_{10,50}="

  # Dense underscore variables indicate heavy obfuscation.
  # Legitimate Python might have 1-2 underscore names; obfuscated code
  # has 10+ per KB where all variables are replaced with underscores.
  - id: dense-underscore-obfuscation
    desc: Dense underscore variable obfuscation
    crit: suspicious
    conf: 0.92
    if:
      type: content
      regex: "_{3,}\\s*="
      count_min: 10
      per_kb_min: 2.0

  # === eval(compile()) Pattern ===
  - id: eval-compile-chain
    desc: eval compile execution chain
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: "eval\\(.{0,50}compile\\("

  - id: nested-eval-compile
    desc: Nested eval compile patterns
    crit: suspicious
    conf: 0.95
    if:
      type: content
      regex: "eval\\(compile\\(.{0,50}eval\\(compile"

  # === Extreme Line Length ===
  - id: extreme-line-length
    desc: Extreme line length (data table or obfuscation)
    crit: notable
    conf: 0.85
    if:
      type: metrics
      field: "text.max_line_length"
      min: 500000
    unless:
      - type: basename
        regex: "\\.html?$"
      - type: string
        regex: "Jinja2"

  # === Import Obfuscation ===
  - id: obfuscated-import-pattern
    desc: Obfuscated import pattern
    crit: suspicious
    conf: 0.80
    if:
      type: content
      regex: "__import__.{0,50}compile|compile.{0,50}__import__"

composite_rules:
  # === Obfuscator Detection ===
  - id: known-obfuscator-detected
    desc: Known obfuscator detected
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    needs: 1
    any:
      - id: blankobf-signature
      - id: pyarmor-signature
      - id: pyobfuscate-signature
      - id: oas-obf-signature

  - id: python-obfuscation-suite
    desc: Python code obfuscation suite
    crit: hostile
    conf: 0.95
    attack: "T1027"
    mbc: "E1014"
    for: [python]
    needs: 3
    any:
      - id: eval-compile-chain
      - id: underscore-only-variables
      - id: extreme-line-length
      - id: nested-eval-compile
      - id: known-obfuscator-detected
