# Code Structure Anomalies
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [python, javascript, typescript, shell, php, ruby, perl, go, rust, java, lua, csharp, powershell]
  attack: "T1027"
  mbc: "B0032"

traits:
  - id: no-comments
    desc: "No comments in code (stripped"
    crit: notable
    conf: 0.6
    if:
      type: metrics
      field: comments.total
      max: 0
      min_size: 2048
    unless:
      - type: basename
        regex: '(test_|_test\.|\.test\.|\.spec\.).*\.(py|js|ts|go|php|rb|java)$'

  - id: very-low-comment-ratio
    desc: "Very low comment-to-code ratio (<1%)"
    crit: notable
    conf: 0.65
    if:
      type: metrics
      field: comments.to_code_ratio
      max: 0.01
      min_size: 2048
    unless:
      - type: basename
        regex: '(test_|_test\.|\.test\.|\.spec\.).*\.(py|js|ts|go|php|rb|java)$'

  - id: very-long-lines
    desc: "Very long lines (>1000 chars)"
    crit: notable
    conf: 0.85
    for: [python, javascript, typescript, shell, php, ruby, go, rust, java, lua, csharp, powershell]
    if:
      type: metrics
      field: text.max_line_length
      min: 1000
    unless:
      - type: basename
        regex: "\\.pyc$"

  - id: high-text-entropy
    desc: "High overall text entropy (encoded"
    crit: notable
    conf: 0.8
    for: [python, javascript, typescript, shell, php, ruby, go, java, lua, csharp, powershell]
    if:
      type: metrics
      field: text.char_entropy
      min: 5.5
    unless:
      - type: basename
        regex: "\\.(s|S|asm)$"
      - type: basename
        regex: "\\.md$"

  - id: low-whitespace
    desc: "Very low whitespace ratio (minified/compressed)"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: text.whitespace_ratio
      max: 0.10
      min_size: 512
    unless:
      - type: basename
        regex: '\.pyc$'

composite_rules:
  - id: minified-code
    desc: "Minified/compressed code (multiple indicators)"
    crit: notable
    conf: 0.9
    all:
      - id: low-whitespace
    any:
      - id: obj/anti-static/obfuscation/code-metrics/functions::high-function-density
      - id: obj/anti-static/obfuscation/code-metrics/functions::many-one-liner-functions
      - id: no-comments
      - id: obj/anti-static/obfuscation/code-metrics/identifiers::sequential-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/identifiers::py-sequential-identifiers
    unless:
      - type: basename
        regex: "\\.html?$"
