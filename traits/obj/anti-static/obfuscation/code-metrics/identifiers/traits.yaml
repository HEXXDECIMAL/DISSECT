# Identifier Obfuscation Detection
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [python, javascript, typescript, shell, php, ruby, perl, go, rust, java, lua, csharp, powershell]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === Identifier Obfuscation ===

  - id: many-high-entropy-identifiers
    desc: "Many high-entropy identifiers (>20% have"
    crit: notable
    conf: 0.9
    for: [javascript, typescript, php, perl, java, lua, csharp, powershell]
    if:
      type: metrics
      field: identifiers.high_entropy_ratio
      min: 0.20
      min_size: 10240
    unless:
      - type: basename
        regex: '^[a-z]+\d+\.rs$|^(avx|sse|neon|simd|intrinsic|vpclmul|pclmul|aes).*\.rs$|.*adapter\.(rb|py|php|js|ts)$'
      - type: string
        regex: "trix|actiontext"

  - id: py-many-high-entropy-identifiers
    desc: "Many high-entropy identifiers (>35% have"
    crit: notable
    conf: 0.9
    for: [python]
    if:
      type: metrics
      field: identifiers.high_entropy_ratio
      min: 0.35
      min_size: 4096
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: excessive-single-char-vars
    desc: "Excessive single-character variable names (>30%)"
    crit: notable
    conf: 0.8
    for: [javascript, typescript, shell, php, ruby, java, lua, csharp, powershell]
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.31
      min_size: 1024
    unless:
      - type: basename
        regex: "\\.d\\.ts$|\\.pxd$|\\.pyi$"

  - id: py-excessive-single-char-vars
    desc: "Excessive single-character variable names (>45%)"
    crit: suspicious
    conf: 0.8
    for: [python]
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.45
      min_size: 2048
    unless:
      - type: basename
        regex: "\\.pxd$|\\.pyi$"

  - id: perl-excessive-single-char-vars
    desc: "Excessive single-character variables (Perl)"
    crit: suspicious
    conf: 0.8
    for: [perl]
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.30
      min_size: 4096
    unless:
      - type: basename
        regex: "\\.d\\.ts$"

  - id: numeric-suffix-identifiers
    desc: "Many numeric suffix identifiers (var1,"
    crit: notable
    conf: 0.75
    size_min: 15001
    if:
      type: metrics
      field: identifiers.numeric_suffix_count
      min: 5
    unless:
      - type: basename
        regex: '^(test|spec|mock|stub).*\.rs$|^(avx|sse|neon|simd|intrinsic|vpclmul|pclmul|aes).*\.rs$|.*test.*\.(js|ts|py)$'

  - id: sequential-identifiers
    desc: "Sequential identifiers (a, b, c,"
    crit: notable
    conf: 0.8
    for: [javascript, typescript, php, ruby, perl, go, java, lua, csharp, powershell]
    if:
      type: metrics
      field: identifiers.sequential_names
      min: 5

  - id: py-sequential-identifiers
    desc: "Excessive sequential identifiers (a, b, c, >15%)"
    crit: notable
    conf: 0.8
    for: [python]
    if:
      type: metrics
      field: identifiers.sequential_names
      min: 15
    unless:
      - type: basename
        regex: '\.pyc$'

  - id: low-identifier-reuse
    desc: "Low identifier reuse (each variable"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: identifiers.reuse_ratio
      max: 0.15
      min_size: 2048

composite_rules:
  - id: identifier-obfuscation
    desc: "Identifier obfuscation (random/encoded names)"
    crit: notable
    conf: 0.9
    needs: 2
    any:
      - id: cap/code/metrics/obfuscation::high-entropy-identifiers
      - id: many-high-entropy-identifiers
      - id: obj/anti-static/obfuscation/code-metrics::go-many-high-entropy-identifiers
      - id: py-many-high-entropy-identifiers
      - id: obj/anti-static/obfuscation/code-metrics::rust-many-high-entropy-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/functions::high-entropy-function-names
      - id: low-identifier-reuse
