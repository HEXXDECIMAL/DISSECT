# Go Source Code Metrics for Obfuscation Detection
# Detects obfuscation patterns in Go source code via metrics analysis

defaults:
  for: [go, ruby]
  attack: "T1027"
  mbc: "B0032"

traits:
  - id: go-many-high-entropy-identifiers
    desc: "Many high-entropy identifiers (>40% have"
    crit: notable
    conf: 0.9
    if:
      type: metrics
      field: identifiers.high_entropy_ratio
      min: 0.40
      min_size: 4096

  # === Dangerous Package Usage (Obfuscation/Anti-Analysis) ===

  - id: go-unsafe-usage
    desc: Uses unsafe package for pointer
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: go_metrics.unsafe_usage
      min: 1

  - id: go-reflect-heavy
    desc: Heavy use of reflection (dynamic
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: go_metrics.reflect_usage
      min: 3

  - id: go-plugin-loading
    desc: Uses plugin package for dynamic
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: go_metrics.plugin_usage
      min: 1

  # === Build Directive Abuse (Stealth/Anti-Analysis) ===

  - id: go-linkname-directive
    desc: Uses //go:linkname to access private
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: go_metrics.linkname_count
      min: 1

  - id: go-noescape-directive
    desc: Uses //go:noescape compiler directive
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: go_metrics.noescape_count
      min: 1

  - id: go-cgo-directives
    desc: Uses #cgo preprocessor directives (C interop)
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: go_metrics.cgo_directives
      min: 1

composite_rules:
  # Detect obfuscation via unsafe + reflect
  - id: go-obfuscation-combo
    desc: Uses unsafe and heavy reflection
    crit: suspicious
    conf: 0.85
    all:
      - id: obj/anti-static/obfuscation/code-metrics::go-unsafe-usage
      - id: obj/anti-static/obfuscation/code-metrics::go-reflect-heavy
