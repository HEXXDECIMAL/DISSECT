# Code Metrics-Based Obfuscation Detection
# Detects obfuscation patterns via statistical analysis of code structure
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for:
    [
      python,
      javascript,
      typescript,
      shell,
      php,
      ruby,
      perl,
      go,
      rust,
      java,
      lua,
      csharp,
      powershell,
    ]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === Identifier Obfuscation ===

  - id: high-entropy-identifiers
    desc: "High entropy identifiers (random-looking variable"
    crit: inert
    conf: 0.85
    # NOTE: Shell has its own threshold (3.2) in code-metrics/shell.yaml
    for:
      [
        python,
        javascript,
        typescript,
        php,
        ruby,
        perl,
        go,
        rust,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: identifiers.avg_entropy
      min: 2.5
      min_size: 2048

  - id: many-high-entropy-identifiers
    desc: "Many high-entropy identifiers (>20% have"
    crit: suspicious
    conf: 0.9
    # NOTE: Shell has its own threshold (40%) in code-metrics/shell.yaml
    # NOTE: Python has own threshold (35%) - single-letter vars are legitimate
    # NOTE: Rust intrinsic headers (avx2.rs, vpclmulqdq.rs, etc) have legitimate high-entropy from SIMD/crypto naming
    # NOTE: Database adapters and similar library code have legitimate high-entropy from domain-specific terminology
    # NOTE: min_size 4096 avoids FP on small locale/i18n files where few camelCase identifiers skew the ratio
    for:
      [
        javascript,
        typescript,
        php,
        ruby,
        perl,
        go,
        rust,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: identifiers.high_entropy_ratio
      min: 0.20
      min_size: 4096
    unless:
      - type: basename
        regex: '^[a-z]+\d+\.rs$|^(avx|sse|neon|simd|intrinsic|vpclmul|pclmul|aes).*\.rs$|.*adapter\.(rb|py|php|js|ts)$'

  - id: py-many-high-entropy-identifiers
    desc: "Many high-entropy identifiers (>35% have"
    crit: notable
    conf: 0.9
    for: [python]
    if:
      type: metrics
      field: identifiers.high_entropy_ratio
      min: 0.35
      min_size: 4096
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: excessive-single-char-vars
    desc: "Excessive single-character variable names (>30%)"
    crit: suspicious
    conf: 0.8
    # Python has its own stricter threshold (45%) below; 30% is too noisy for
    # common loop/counter/style patterns in legitimate Python code.
    # Exclude Rust (single-letter vars are standard in mathematical/algorithm code)
    # Exclude small files (tiny scopes where single-letter vars are expected)
    # Perl modules often have minimal boilerplate, so require larger files for this detection
    for:
      [
        javascript,
        typescript,
        shell,
        php,
        ruby,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.30
      min_size: 1024
    unless:
      - type: basename
        regex: "\\.d\\.ts$|\\.pxd$|\\.pyi$"

  - id: py-excessive-single-char-vars
    desc: "Excessive single-character variable names (>45%)"
    crit: suspicious
    conf: 0.8
    for: [python]
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.45
      min_size: 2048
    unless:
      - type: basename
        regex: "\\.pxd$|\\.pyi$"

  - id: perl-excessive-single-char-vars
    desc: "Excessive single-character variables (Perl)"
    crit: suspicious
    conf: 0.8
    for: [perl]
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.30
      min_size: 4096
    unless:
      - type: basename
        regex: "\\.d\\.ts$"

  - id: numeric-suffix-identifiers
    desc: "Many numeric suffix identifiers (var1,"
    crit: notable
    conf: 0.75
    # Exclude small files (testing, vectors, small utilities) where numeric suffixes are standard
    # Exclude Rust intrinsic/SIMD files where array indices and test vectors are normal
    if:
      type: metrics
      field: identifiers.numeric_suffix_count
      min: 5
    unless:
      - type: filesize
        max: 15000
      - type: basename
        regex: '^(test|spec|mock|stub).*\.rs$|^(avx|sse|neon|simd|intrinsic|vpclmul|pclmul|aes).*\.rs$|.*test.*\.(js|ts|py)$'

  - id: sequential-identifiers
    desc: "Sequential identifiers (a, b, c,"
    crit: notable
    conf: 0.8
    # Exclude Python - single-letter loop/parameter vars are standard
    # Exclude Rust - single-letter vars are standard in mathematical/algorithm/SIMD code
    for:
      [
        javascript,
        typescript,
        php,
        ruby,
        perl,
        go,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: identifiers.sequential_names
      min: 5

  - id: py-sequential-identifiers
    desc: "Excessive sequential identifiers (a, b, c, >15%)"
    crit: notable
    conf: 0.8
    for: [python]
    if:
      type: metrics
      field: identifiers.sequential_names
      min: 15
    unless:
      - type: basename
        regex: '\.pyc$'

  - id: low-identifier-reuse
    desc: "Low identifier reuse (each variable"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: identifiers.reuse_ratio
      max: 0.15
      min_size: 2048

  # === High Entropy Function Names ===

  - id: high-entropy-function-names
    desc: "Functions with random-looking names"
    crit: inert
    conf: 0.85
    # NOTE: Shell has its own threshold (10) in code-metrics/shell.yaml
    for:
      [
        python,
        javascript,
        typescript,
        php,
        ruby,
        perl,
        go,
        rust,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: functions.high_entropy_names
      min: 3
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: single-char-function-names
    desc: "Functions with single-character names"
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: functions.single_char_names
      min: 8

  - id: many-anonymous-functions
    desc: "Many anonymous functions"
    crit: notable
    conf: 0.75
    for: [javascript, typescript, python, ruby]
    if:
      type: metrics
      field: functions.anonymous
      min: 5
    unless:
      - type: basename
        regex: "test.*\\.js$|.*\\.test\\.js$|.*\\.spec\\.js$|.*\\.test\\.ts$|.*\\.spec\\.ts$|.*test.*\\.py$|.*_test\\.py$|.*spec.*\\.rb$|.*_spec\\.rb$|\\.window\\.js$"

  - id: high-function-density
    desc: "High function density (>20 functions"
    crit: notable
    conf: 0.85
    if:
      type: metrics
      field: functions.density_per_100_lines
      min: 20
      min_size: 1024
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: many-one-liner-functions
    desc: "Many one-liner functions (minified code"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.one_liners
      min: 5
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: deep-nesting
    desc: "Deeply nested functions (complexity indicator)"
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: functions.max_nesting_depth
      min: 5

  - id: single-char-params
    desc: "Many single-character parameter names"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.single_char_params
      min: 10

  # === String Obfuscation ===

  - id: high-entropy-strings
    desc: "High entropy strings (encoded/encrypted data)"
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: strings.avg_entropy
      min: 4.5
      min_size: 4096

  # NOTE: Small/simple programs legitimately have few strings.
  # Only meaningful combined with other obfuscation indicators.
  - id: few-strings
    desc: "Very few string literals (string"
    crit: inert
    conf: 0.4
    if:
      type: metrics
      field: strings.total
      max: 5
      min_size: 1024

  # === Code Structure Anomalies ===

  - id: no-comments
    desc: "No comments in code (stripped"
    crit: notable
    conf: 0.6
    if:
      type: metrics
      field: comments.total
      max: 0
      min_size: 2048
    unless:
      - type: basename
        regex: '(test_|_test\.|\.test\.|\.spec\.).*\.(py|js|ts|go|php|rb|java)$'

  - id: very-low-comment-ratio
    desc: "Very low comment-to-code ratio (<1%)"
    crit: notable
    conf: 0.65
    if:
      type: metrics
      field: comments.to_code_ratio
      max: 0.01
      min_size: 2048
    unless:
      - type: basename
        regex: '(test_|_test\.|\.test\.|\.spec\.).*\.(py|js|ts|go|php|rb|java)$'

  - id: very-long-lines
    desc: "Very long lines (>1000 chars)"
    crit: notable
    conf: 0.85
    # Exclude Perl: POD documentation legitimately has long lines
    # Exclude Python bytecode: .pyc files are binary, long "lines" are serialization artifacts
    for:
      [
        python,
        javascript,
        typescript,
        shell,
        php,
        ruby,
        go,
        rust,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: text.max_line_length
      min: 1000
    unless:
      - type: basename
        regex: "\\.pyc$"

  - id: high-text-entropy
    desc: "High overall text entropy (encoded"
    crit: suspicious
    conf: 0.8
    # Exclude Perl: legitimate code generators (e.g., cryptographic lookup tables)
    # have naturally high entropy from hex data and special characters
    # Exclude Rust: benchmark and test files legitimately contain diverse string data
    # (multiple languages, emoji) with naturally high entropy
    for:
      [
        python,
        javascript,
        typescript,
        shell,
        php,
        ruby,
        go,
        java,
        lua,
        csharp,
        powershell,
      ]
    if:
      type: metrics
      field: text.char_entropy
      min: 5.5

  - id: low-whitespace
    desc: "Very low whitespace ratio (minified/compressed)"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: text.whitespace_ratio
      max: 0.10
      min_size: 512
    unless:
      - type: basename
        regex: '\.pyc$'

  # === Complexity Anomalies ===

  - id: monster-function
    desc: "Extremely large function (>500 lines)"
    crit: notable
    conf: 0.8
    if:
      type: metrics
      field: functions.over_500_lines
      min: 1

  - id: many-large-functions
    desc: "Multiple very large functions (>100"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.over_100_lines
      min: 5

  - id: many-params
    desc: "Functions with excessive parameters (>7)"
    crit: notable
    conf: 0.65
    if:
      type: metrics
      field: functions.many_params_count
      min: 3

composite_rules:
  # === Combined Obfuscation Detection ===

  - id: minified-code
    desc: "Minified/compressed code (multiple indicators)"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    needs: 3
    any:
      - id: obj/anti-static/obfuscation/code-metrics/high-function-density
      - id: obj/anti-static/obfuscation/code-metrics/many-one-liner-functions
      - id: obj/anti-static/obfuscation/code-metrics/very-long-lines
      - id: obj/anti-static/obfuscation/code-metrics/low-whitespace
      - id: obj/anti-static/obfuscation/code-metrics/no-comments
      - id: obj/anti-static/obfuscation/code-metrics/sequential-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/py-sequential-identifiers

  - id: identifier-obfuscation
    desc: "Identifier obfuscation (random/encoded names)"
    crit: notable
    conf: 0.9
    attack: "T1027"
    needs: 2
    any:
      - id: obj/anti-static/obfuscation/code-metrics/high-entropy-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/many-high-entropy-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/py-many-high-entropy-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/high-entropy-function-names
      - id: obj/anti-static/obfuscation/code-metrics/low-identifier-reuse

  - id: generated-code
    desc: "Machine-generated or transformed code"
    crit: notable
    conf: 0.85
    attack: "T1027"
    needs: 2
    any:
      - id: obj/anti-static/obfuscation/code-metrics/numeric-suffix-identifiers
      - id: obj/anti-static/obfuscation/code-metrics/single-char-function-names
      - id: obj/anti-static/obfuscation/code-metrics/excessive-single-char-vars
      - id: obj/anti-static/obfuscation/code-metrics/py-excessive-single-char-vars
      - id: obj/anti-static/obfuscation/code-metrics/perl-excessive-single-char-vars
      - id: obj/anti-static/obfuscation/code-metrics/single-char-params

  - id: string-hiding
    desc: "String concealment/encoding"
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    all:
      - id: obj/anti-static/obfuscation/code-metrics/high-entropy-strings
    any:
      - id: obj/anti-static/obfuscation/code-metrics/few-strings
      - id: obj/anti-static/obfuscation/code-metrics/high-text-entropy
