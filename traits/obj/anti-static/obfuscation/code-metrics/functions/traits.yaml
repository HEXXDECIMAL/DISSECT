# Function Obfuscation Patterns
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [python, javascript, typescript, shell, php, ruby, perl, go, rust, java, lua, csharp, powershell]
  attack: "T1027"
  mbc: "B0032"

traits:
  - id: high-entropy-function-names
    desc: "Functions with random-looking names"
    crit: notable
    conf: 0.85
    for: [python, javascript, typescript, php, ruby, perl, go, rust, java, lua, csharp, powershell]
    if:
      type: metrics
      field: functions.high_entropy_names
      min: 7
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: single-char-function-names
    desc: "Functions with single-character names"
    crit: notable
    conf: 0.8
    for: [python, javascript, typescript, php, perl, go, rust, java, lua, csharp, powershell]
    size_max: 100000
    if:
      type: metrics
      field: functions.single_char_names
      min: 8
      min_size: 12288
    unless:
      - type: basename
        regex: "^test.*\\.(js|ts|py|rb|php|go|rs|java|cs|ps1|sh)$|.*\\.(test|spec)\\.(js|ts|py|rb|php|go|rs|java|cs|ps1|sh)$|.*_test\\.(go|py|rb|php|rs|java|cs|sh)$|^tests?\\.(rs|py|js|ts|go|java|cs|php|rb|sh)$|ast\\.js$"
      - type: string
        regex: "MathJax|wgxpath"

  - id: many-anonymous-functions
    desc: "Many anonymous functions"
    crit: notable
    conf: 0.75
    for: [javascript, typescript, python, ruby]
    if:
      type: metrics
      field: functions.anonymous
      min: 5
    unless:
      - type: basename
        regex: "test.*\\.js$|.*\\.test\\.js$|.*\\.spec\\.js$|.*\\.test\\.ts$|.*\\.spec\\.ts$|.*test.*\\.py$|.*_test\\.py$|.*spec.*\\.rb$|.*_spec\\.rb$|\\.window\\.js$"

  - id: high-function-density
    desc: "High function density (>20 functions"
    crit: notable
    conf: 0.85
    if:
      type: metrics
      field: functions.density_per_100_lines
      min: 20
      min_size: 1024
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: many-one-liner-functions
    desc: "Many one-liner functions (minified code"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.one_liners
      min: 5
    unless:
      - type: basename
        regex: "\\.pyi$"

  - id: deep-nesting
    desc: "Deeply nested functions (complexity indicator)"
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: functions.max_nesting_depth
      min: 5

  - id: single-char-params
    desc: "Many single-character parameter names"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.single_char_params
      min: 10

composite_rules:
  - id: generated-code
    desc: "Machine-generated or transformed code"
    crit: notable
    conf: 0.85
    needs: 2
    any:
      - id: obj/anti-static/obfuscation/code-metrics/identifiers
      - id: single-char-function-names
      - id: single-char-params
