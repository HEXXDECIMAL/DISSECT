# Distinguish Legitimate Minification from Malicious Obfuscation
# Minified code is compressed but readable, obfuscated code hides intent

defaults:
  for: [javascript, typescript]

composite_rules:
  # Legitimate minification patterns (benign compression)
  - id: minification-pattern
    desc: "Code appears minified by webpack/uglify/terser"
    crit: notable
    conf: 0.8
    all:
      - { id: obj/anti-static/obfuscation/code-metrics/very-long-lines }
      - {
          id: obj/anti-static/obfuscation/code-metrics/single-char-function-names,
        }
    not:
      - { id: obj/anti-static/obfuscation/base64-eval }

  # Hostile obfuscation (malicious encoding)
  - id: hostile-obfuscation
    desc: "Hostile obfuscation techniques (not just"
    crit: suspicious
    conf: 0.90
    any:
      - { id: obj/anti-static/obfuscation/base64-eval }
      - { id: obj/anti-static/obfuscation/encoding/xor-string }

  # Minified library with hostile capabilities (trojanized)
  - id: minified-with-hostile-caps
    desc: "Minified code with hostile capabilities"
    crit: suspicious
    conf: 0.92
    attack: "T1195.002"
    mbc: "B0024"
    all:
      - {
          id: obj/anti-static/obfuscation/minified-vs-obfuscated/minification-pattern,
        }
    any:
      - { id: cap/exec/dropper/activex-object }
      - { id: obj/c2/reverse-shell/socket-command }
      - {
          id: obj/anti-static/obfuscation/minified-vs-obfuscated/hostile-obfuscation,
        }
