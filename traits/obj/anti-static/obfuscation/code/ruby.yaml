# Ruby obfuscation and encoding techniques
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

defaults:
  for: [ruby]
  mbc: "B0032"
  attack: "T1027"

traits:
  - id: base64-decode
    desc: "Base64 decode (potential obfuscation)"
    crit: notable
    conf: 0.88
    if:
      type: raw
      regex: "Base64\\.decode64|Base64\\.strict_decode64"

  - id: base64-encode
    desc: "Base64 encode"
    crit: notable
    conf: 0.88
    attack: "T1027"
    for: [ruby]
    if:
      type: string
      regex: "Base64\\.encode64|Base64\\.strict_encode64"

  - id: marshal-load
    desc: "Marshal deserialization (RCE risk)"
    crit: suspicious
    conf: 0.93
    attack: "T1059"
    for: [ruby]
    if:
      type: string
      regex: "Marshal\\.load|Marshal\\.restore"

  - id: yaml-unsafe-load
    desc: "YAML unsafe deserialization"
    crit: suspicious
    conf: 0.90
    attack: "T1059"
    for: [ruby]
    if:
      type: string
      regex: "YAML\\.load"

  - id: reflection-send
    desc: "Dynamic method invocation"
    crit: notable
    conf: 0.85
    attack: "T1027"
    for: [ruby]
    if:
      type: string
      regex: "\\.send\\(|\\.send"

  - id: const-get
    desc: "Dynamic constant access"
    crit: notable
    conf: 0.90
    attack: "T1027"
    for: [ruby]
    if:
      type: string
      regex: "const_get"

  - id: const-set
    desc: "Dynamic constant definition"
    crit: notable
    conf: 0.90
    attack: "T1027"
    for: [ruby]
    if:
      type: string
      regex: "const_set"

  - id: define-method
    desc: "Dynamic method definition"
    crit: notable
    conf: 0.90
    if:
      type: string
      regex: "define_method"

  # === Density-Based Obfuscation Detection ===
  # Ruby malware uses various techniques to hide payloads.

  # Dense chr/ord calls for character-by-character string building
  - id: ruby-dense-chr-calls
    desc: Dense chr() calls (string building)
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      regex: "\\b\\d+\\.chr\\b"
      count_min: 15
      per_kb_min: 3.0
    unless:
      - type: string
        regex: "IRB"

  # Dense .send() calls for dynamic method invocation
  - id: dense-send-calls
    desc: Dense send() calls (dynamic dispatch)
    crit: suspicious
    conf: 0.88
    if:
      type: raw
      regex: "\\.send\\s*\\("
      count_min: 10
      per_kb_min: 2.0
    unless:
      - type: string
        regex: "IRB|ActiveSupport"

  # eval with string manipulation
  - id: dense-eval-calls
    desc: Dense eval calls
    crit: suspicious
    conf: 0.92
    if:
      type: raw
      regex: "\\beval\\s*\\("
      count_min: 8
      per_kb_min: 1.5
    unless:
      - type: string
        regex: "IRB"

  # instance_eval/class_eval/module_eval
  - id: dense-metaprogramming
    desc: Dense metaprogramming eval
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "(instance_eval|class_eval|module_eval)\\s*[({]"
      count_min: 10
      per_kb_min: 2.0
    unless:
      - type: string
        regex: "IRB"

  # pack/unpack for binary encoding
  - id: dense-pack-calls
    desc: Dense pack/unpack calls
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "\\.(pack|unpack)\\s*\\(\\s*['\"][^'\"]*(m0?|H\\*|h\\*|B\\*|b\\*|C\\*|c\\*|u|w)['\"]"
      count_min: 10
      per_kb_min: 2.0
    unless:
      - type: string
        regex: "IRB"

  # String interpolation abuse #{...}
  - id: dense-interpolation
    desc: Dense string interpolation
    crit: notable
    conf: 0.75
    if:
      type: raw
      regex: "#\\{[^}]+\\}"
      count_min: 15
      per_kb_min: 3.0

composite_rules:
  # Multi-layer Ruby obfuscation
  - id: ruby-obfuscation-suite
    desc: Ruby obfuscation techniques
    crit: suspicious
    conf: 0.95
    needs: 2
    any:
      - id: ruby-dense-chr-calls
      - id: dense-eval-calls
      - id: dense-send-calls
      - id: marshal-load
      - id: base64-decode
