# Framework Header Source Injection Detection
# Detects bundling of raw source code headers (.h files) within frameworks
# This is a supply-chain attack pattern where attacker-controlled code is disguised as
# legitimate library headers (OpenSSL, libcrypto, etc.) within app bundles
# Legitimate apps should use precompiled binaries, not raw source headers
#
# ATT&CK: T1195.001 (Supply Chain Compromise - Compromise Software Dependencies)
# MBC: B0005 (Defense Evasion)

defaults:
  for: [c]
  crit: suspicious
  attack: "T1195.001"
  mbc: "B0005"

traits:
  # === OpenSSL source header markers ===
  # evp.h contains distinctive OpenSSL EVP API markers
  - id: openssl-evp-header
    desc: OpenSSL EVP header with cryptographic API definitions
    crit: notable
    conf: 0.95
    if:
      type: raw
      regex: "typedef.{0,50}EVP_(CIPHER|MD|PKEY)(_CTX)?|#define EVP_(CIPHER|MD|PKEY)(_CTX)?"

  - id: openssl-copyright-block
    desc: OpenSSL copyright and license header
    crit: notable
    conf: 0.90
    if:
      type: string
      substr: "Eric Young (eay@cryptsoft.com)"

  - id: openssl-project-copyright
    desc: Modern OpenSSL Project copyright
    crit: inert
    conf: 0.95
    if:
      type: raw
      substr: "The OpenSSL Project Authors"

  # === Generic OpenSSL header signatures ===
  - id: openssl-crypto-header
    desc: OpenSSL crypto header markers
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "HEADER_ENVELOPE_H|OPENSSL_ALGORITHM_DEFINES|EVP_MAX_MD_SIZE"

  # === Cryptography library headers ===
  - id: libcrypto-marker
    desc: libcrypto header definitions
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "EVP_CIPHER_CTX|EVP_MD_CTX|struct evp_pkey_st"

composite_rules:
  # Supply-chain injection pattern: OpenSSL headers bundled unexpectedly
  - id: openssl-source-injection
    desc: OpenSSL header source injected into framework
    crit: suspicious
    conf: 0.90
    for: [c]
    any:
      - id: openssl-evp-header
      - id: openssl-copyright-block
      - id: openssl-crypto-header
    unless:
      - id: openssl-project-copyright
