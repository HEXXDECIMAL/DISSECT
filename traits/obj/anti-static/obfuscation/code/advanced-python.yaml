# Python Advanced Obfuscation Detection
# Detects sophisticated obfuscation patterns in Python malware
# ATT&CK: T1027 (Obfuscated Files)
# MBC: E1014 (Data Encoding)

defaults:
  crit: suspicious
  attack: "T1027"
  mbc: "E1014"
  for: [python]

traits:
  # === Unicode Variable Names ===
  - id: unicode-variable-names
    desc: Unicode variable names
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "(?:^|\\n)\\s*(?:[\\u4E00-\\u9FFF\\u3040-\\u309F\\u30A0-\\u30FF][\\u4E00-\\u9FFF\\u3040-\\u309F\\u30A0-\\u30FFA-Za-z0-9_]{0,63}|[A-Za-z_][A-Za-z0-9_]{0,62}[\\u4E00-\\u9FFF\\u3040-\\u309F\\u30A0-\\u30FF][A-Za-z0-9_]{0,63})\\s*=[^=\\n]"

  - id: chinese-char-variables
    desc: Chinese character variables
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      regex: "[\u4e00-\u9fff]+="

  # === Bit Shift Obfuscation ===
  - id: bit-shift-arithmetic
    desc: Bit shift obfuscation
    crit: suspicious
    conf: 0.80
    if:
      type: raw
      regex: "<<[0-9]+.{0,50}>>[0-9]+|>>[0-9]+.{0,50}<<[0-9]+"

  - id: arithmetic-expression-chains
    desc: Complex arithmetic chains
    crit: suspicious
    conf: 0.75
    if:
      type: raw
      regex: "[*].{0,30}//.{0,30}[|].{0,30}<<.{0,30}>>"

  # === getattr/__builtins__ Obfuscation ===
  - id: getattr-builtins-obfuscation
    desc: getattr builtins obfuscation
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      regex: "getattr\\((?:__builtins__|.{0,30}builtins)\\s*,\\s*(?:[A-Za-z_][A-Za-z0-9_]{0,40}|[\"'][^\"'\\n]{1,20}[\"']\\s*\\+\\s*[\"'][^\"'\\n]{1,20}[\"']|chr\\(|bytes\\(|base64\\.|decode\\()"
    unless:
      - type: basename
        regex: '(test_|_test\.|\.test\.|\.spec\.).*\.py$'

  - id: getattr-obfuscated-access
    desc: getattr obfuscated access
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "getattr\\(.{0,40},\\s*(?:[\"'][^\"'\\n]{1,20}[\"']\\s*\\+\\s*[\"'][^\"'\\n]{1,20}[\"']|chr\\([^\\n\\)]{1,20}\\)\\s*\\+\\s*chr\\([^\\n\\)]{1,20}\\))"

  # === State Machine Pattern ===
  - id: magic-number-state-machine
    desc: Magic number state machine
    crit: suspicious
    conf: 0.80
    if:
      type: raw
      regex: "while.{0,30}:[^}]{0,50}if.{0,30}==.{0,30}[0-9]{5,}"

  - id: obfuscated-state-variable
    desc: Obfuscated state variable
    crit: suspicious
    conf: 0.75
    if:
      type: raw
      regex: "[\u4e00-\u9fff]{5,}\\s*=\\s*[0-9]+"

  # === COM/Object Instantiation ===
  - id: com-dispatch-usage
    desc: COM Dispatch usage
    crit: notable
    conf: 0.85
    if:
      type: raw
      regex: "\\bwin32com\\b|\\bpythoncom\\b"

  - id: ctypes-windll-usage
    desc: ctypes windll usage
    crit: notable
    conf: 0.70
    if:
      type: raw
      regex: "ctypes\\.windll|windll\\.shell32"

  # === chr() String Reconstruction via map ===
  - id: join-map-getattr-chr
    desc: String built via join(map(getattr(__builtins__)))
    crit: suspicious
    conf: 0.92
    if:
      type: raw
      substr: "join(map(getattr(__builtins__"
      count_min: 3

  # === Builtin repr introspection for chr ===
  # Constructs "chr" by extracting chars from repr of builtins:
  # oct.__str__()[-3] → 'c', hex.__str__()[-4] → 'h', copyright.__str__()[4] → 'r'
  - id: builtin-repr-chr-construction
    desc: Builds chr via builtin repr introspection
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "(?:oct|hex|copyright|credits|license)\\.__str__\\(\\)"
      count_min: 3

  # === Admin Check Bypass ===
  - id: admin-check-ctypes
    desc: Admin check via ctypes
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "IsUserAnAdmin|IsAdmin|CheckTokenMembership"

composite_rules:
  # === Advanced Obfuscation Detection ===
  - id: advanced-python-obfuscation
    desc: Advanced Python obfuscation
    crit: suspicious
    conf: 0.90
    attack: "T1027"
    for: [python]
    needs: 3
    any:
      - id: unicode-variable-names
      - id: bit-shift-arithmetic
      - id: getattr-builtins-obfuscation
      - id: builtin-repr-chr-construction

  - id: state-machine-obfuscation
    desc: State machine obfuscation
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    mbc: "E1014"
    platforms: [all]
    needs: 2
    any:
      - id: magic-number-state-machine
      - id: obfuscated-state-variable
      - id: chinese-char-variables

  - id: windows-com-elevation
    desc: Windows COM elevation attempt
    crit: suspicious
    conf: 0.95
    attack: "T1078"
    mbc: "E1059"
    platforms: [windows]
    needs: 2
    any:
      - id: com-dispatch-usage
      - id: admin-check-ctypes
      - id: ctypes-windll-usage

  # === Supply Chain Attack Detection ===
  # Obfuscated Python setup.py with persistence indicators
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: obfuscated-setup-py-trojan
    desc: Heavily obfuscated setup.py trojan
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    for: [python]
    all:
      - id: advanced-python-obfuscation
      - id: state-machine-obfuscation
      - id: com-dispatch-usage
