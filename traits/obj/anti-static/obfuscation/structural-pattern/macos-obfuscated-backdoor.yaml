# Structurally Obfuscated Backdoor Pattern (macOS)
# Detects malware using structural obfuscation to hide malicious behavior
# Combines: minimal strings + high execution frequency + large encrypted data
# This pattern has NO legitimate use - always indicates sophisticated malware

defaults:
  for: [macho]
  platforms: [macos]
  attack: "T1027"
  mbc: "F0001"

composite_rules:
  # HOSTILE: String-sparse command orchestration backdoor
  # Precision: all(4) + for(1) + any(1) + none(1) = 7 (exceeds 4.0 threshold)
  - id: string-sparse-command-backdoor
    desc: String-sparse command orchestration backdoor
    crit: hostile
    conf: 0.96
    attack: "T1027,T1059,T1543"
    mbc: "F0001,B0009"
    all:
      # Structural obfuscation
      - id: obj/anti-static/obfuscation/payload::extreme-string-sparsity-macos
      # Command execution capability
      - id: cap/process/create/shell
      # Persistence mechanism
      - id: obj/persist/daemon/init::daemon-fork
      - id: obj/persist/daemon/init::daemon-setsid
    # Additional obfuscation or execution indicators
    any:
      - id: cap/process/create/shell::excessive-popen
      - id: obj/anti-static/obfuscation/payload::high-entropy-data-macos
      - id: meta/binary/structure::many-high-entropy-strings
    # Must be unsigned (legitimate apps are signed)
    none:
      - id: meta/signed/platform::apple

  # HOSTILE: Structurally anomalous malware (all indicators)
  # Precision: all(3) + for(1) + any(2, needs:2) + none(1) = 7
  - id: structurally-anomalous-malware
    desc: Malware with extreme structural anomalies
    crit: hostile
    conf: 0.97
    attack: "T1027,T1059"
    all:
      # Triple structural anomalies
      - id: meta/binary/structure::extreme-text-to-string-ratio
      - id: meta/binary/structure::data-dominates-cstring
      - id: obj/anti-static/obfuscation/payload::extreme-string-sparsity-macos
    # Execution capability
    any:
      - id: cap/process/create/shell::excessive-popen
      - id: cap/process/create/shell::extreme-popen
      - id: cap/process/create/shell::capture-command-output
    needs: 2  # At least 2 execution indicators
    # Must be unsigned
    none:
      - id: meta/signed/platform::apple

  # SUSPICIOUS: Obfuscated payload with execution
  # Not quite HOSTILE but very suspicious combination
  - id: obfuscated-execution-pattern
    desc: Obfuscated binary with command execution
    crit: suspicious
    conf: 0.92
    attack: "T1027,T1059"
    all:
      - id: obj/anti-static/obfuscation/payload::string-obfuscated-malware
      - id: cap/process/create/shell::excessive-popen

  # SUSPICIOUS: High-density execution in small binary
  - id: dense-execution-small-binary
    desc: High-density command execution pattern
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    size_max: 300000  # Less than 300KB
    all:
      - id: cap/process/create/shell::excessive-popen
    any:
      - id: obj/anti-static/obfuscation/payload::extreme-string-sparsity-macos
      - id: meta/binary/structure::extreme-minimal-strings

  # SUSPICIOUS: Multiple structural + behavioral anomalies
  - id: multi-anomaly-malware
    desc: Multiple structural and behavioral anomalies
    crit: suspicious
    conf: 0.93
    attack: "T1027,T1059"
    all:
      - id: meta/binary/structure::structural-anomaly-pattern
      - id: cap/process/create/shell
    any:
      - id: obj/persist/daemon/init::unix-daemon-persistence
      - id: obj/lateral/social-engineering/masquerading::suspicious-generic-naming
      - id: obj/c2/backdoor/binary::unexpected-process-ops
    none:
      - id: meta/signed/platform::apple

  # HOSTILE: All anomalies present (nuclear option)
  # Precision: all(5) + for(1) + any(2) + none(1) = 9
  - id: fully-obfuscated-backdoor
    desc: Fully obfuscated backdoor malware
    crit: hostile
    conf: 0.99
    attack: "T1027,T1036,T1059,T1543"
    all:
      # Structural
      - id: obj/anti-static/obfuscation/payload::extreme-string-sparsity-macos
      - id: obj/anti-static/obfuscation/payload::high-entropy-data-macos
      # Execution
      - id: cap/process/create/shell::excessive-popen
      # Persistence
      - id: obj/persist/daemon/init::unix-daemon-persistence
      # Masquerading
      - id: obj/lateral/social-engineering/masquerading::suspicious-generic-naming
    # Additional obfuscation
    any:
      - id: meta/binary/structure::many-high-entropy-strings
      - id: meta/binary/structure::extreme-text-to-string-ratio
    # Must be unsigned
    none:
      - id: meta/signed/platform::apple
