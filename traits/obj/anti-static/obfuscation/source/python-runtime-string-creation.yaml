# Python Runtime String Creation Obfuscation
# Detects techniques used to construct strings (like 'chr') at runtime from builtins
# to avoid static string analysis.

defaults:
  crit: suspicious
  conf: 0.85
  for: [python]
  attack: "T1027"
  mbc: "E1014"

traits:
  - id: builtin-str-slice-construction
    desc: Constructs strings by slicing builtin type representations
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      # Matches: type.__str__() or type.__repr__() followed by slicing/indexing
      # e.g. oct.__str__()[-3], int.__repr__()[0]
      regex: '(?:int|str|float|oct|hex|list|tuple|dict|copyright|credits|license)\.(?:__str__|__repr__)\s*\(\s*\)\s*\[[^\]]{1,120}\]'

  - id: getattr-builtins-bitwise
    desc: getattr on builtins with bitwise operations
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      # Matches: getattr(__builtins__, ... << ... | ...)
      regex: 'getattr\s*\(\s*(?:__builtins__|builtins)\s*,[^,]{1,120}(?:<<|>>|\||&|\^)[^,]{1,120}\)'

  - id: join-map-getattr
    desc: String reconstruction via join(map(getattr(...)))
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      # Matches: .join(map(getattr
      regex: '\.join\s*\(\s*map\s*\(\s*getattr'

  - id: obfuscated-chr-lookup
    desc: Obfuscated lookup of 'chr' function
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      # Matches construction of 'chr' specifically using the known pattern parts
      regex: '(?:oct|hex)\.__str__\(\)\[[^\]]{1,120}\]\s*\+\s*(?:oct|hex)\.__str__\(\)\[[^\]]{1,120}\]\s*\+\s*copyright\.__str__\(\)'
