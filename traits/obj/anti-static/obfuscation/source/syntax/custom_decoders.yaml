# Custom JS/JScript Decoders
# Detects custom decoding routines commonly used in JScript malware

traits:
  - id: js-prototype-extension
    desc: String.prototype extension
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      regex: 'String\.prototype\.[\w]+\s*=\s*function'

  - id: js-replace-map
    desc: String replacement using map object
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      regex: '\.replace\(\s*\w+\s*,\s*\w+\[\w+\]\s*\)'

  - id: js-split-join-empty
    desc: Split-join pattern (custom decoding)
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      regex: 'this\.split\("[^"]{1,120}"\)\.join\(""\)'

  - id: js-base64-custom-loop
    desc: Custom Base64 decoding loop with bitwise operations
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      regex: 'String\.fromCharCode\(\s*\(\s*[\w\[\]]+\s*<<\s*2\s*\)\s*\|\s*\(\s*\(\s*[\w\[\]]+\s*&\s*0x30\s*\)\s*>>\s*4\s*\)\s*\)'