# Process Injection Detection - Windows
# MBC: B0033 (Process Injection)
# ATT&CK: T1055

defaults:
  for: [pe, dll]
  platforms: [windows]

traits:
  # NtWriteVirtualMemory: no canonical equivalent, kept as atomic
  - id: nt-write-virtual-memory
    desc: NT native write to virtual memory
    crit: suspicious
    conf: 0.9
    mbc: "B0033"
    attack: "T1055"
    if:
      type: symbol
      exact: "NtWriteVirtualMemory"
    downgrade:
      any:
        - type: string
          substr: "ApiSet Stub DLL"
        - type: string
          substr: "Valve Corp."

composite_rules:
  # process-inject-api: composite referencing canonical injection/memory traits
  # CreateRemoteThread: obj/defense-evasion/process/injection/runtime::create-remote-thread (canonical)
  # WriteProcessMemory: obj/defense-evasion/process/injection/runtime::write-process-memory (canonical)
  # VirtualAllocEx: cap/mem/protect/modify::virtual-alloc-ex (canonical)
  - id: process-inject-api
    desc: Process injection via Windows API
    crit: suspicious
    conf: 0.66
    mbc: "B0033"
    attack: "T1055"
    any:
      - id: obj/defense-evasion/process/injection/runtime::create-remote-thread
      - id: obj/defense-evasion/process/injection/runtime::write-process-memory
      - id: cap/mem/protect/modify::virtual-alloc-ex
      - id: nt-write-virtual-memory
