# Linux Kernel Rootkit Detection - File, Process, and Module Hiding
# MBC: Defense Evasion, Privilege Escalation  
# ATT&CK: T1014 (Rootkit), T1068 (Exploitation for Privilege Escalation)

traits:
  # DIRECTORY ENTRY MANIPULATION (FILE/PROCESS HIDING)
  # ============================================================

  - id: d-reclen-manipulation
    desc: Directory entry record length manipulation
    crit: suspicious
    conf: 0.98
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "d_reclen"

  - id: d-name-access
    desc: Directory entry name field access
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "d_name"

  - id: simple-strtoul-call
    desc: String to unsigned long conversion
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: call
      exact: "simple_strtoul"

  - id: memmove-call
    desc: Memory move operation (often used
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "memmove"

  - id: memcmp-dirent-context
    desc: Memory comparison (file prefix matching
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "memcmp"

  # ============================================================
  # MODULE HIDING TECHNIQUES
  # ============================================================

  - id: sect-attrs-removal
    desc: Module section attributes removal (hide
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "sect_attrs"

  - id: list-add-call
    desc: Kernel list addition (module unhiding
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: call
      exact: "list_add"

  - id: kfree-call
    desc: Kernel memory free (often used
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "kfree"

  # ============================================================
  # SUSPICIOUS COMMENT PATTERNS
  # ============================================================

  - id: corruption-mention-comment
    desc: Code mentions corruption/corrupting
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "corrupt"
      case_insensitive: true

  - id: hiding-mention-comment
    desc: Code mentions hiding/hidden
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "(?i)hid(?:e|ing|den).{0,50}\\b(?:kernel|module|process|task|socket|connection|port|file|dir|pid|proc|sys)\\b"
    not:
      - substr: "ssid"
      - substr: "hidden flag"
      - substr: "want_hidden"

  - id: stealthy-mention-comment
    desc: Code mentions stealth/stealthy
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "stealth"
      case_insensitive: true

  - id: unauthorized-mention-comment
    desc: Code mentions unauthorized access
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "unauthori[sz]ed"
      case_insensitive: true

  - id: defeating-mention-comment
    desc: Code mentions defeating protections
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "defeat"
      case_insensitive: true

  - id: persistence-mention-comment
    desc: Code mentions persistence
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "persist"
      case_insensitive: true

  - id: polymorphic-mention-comment
    desc: Code mentions polymorphic techniques
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "polymorphic"
      case_insensitive: true

  - id: covert-channel-mention-comment
    desc: Code mentions covert channels/communication
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "covert"
      case_insensitive: true

  # ============================================================
  # COMMENT/METADATA DETECTION
  # ============================================================

  - id: rootkit-mention-comment
    desc: Code explicitly mentions rootkit
    crit: suspicious
    conf: 1.0
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "rootkit"
      case_insensitive: true

  - id: malware-mention-comment
    desc: Code explicitly mentions malware/backdoor
    crit: suspicious
    conf: 1.0
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "malware|backdoor"
      case_insensitive: true

  - id: privesc-mention-comment
    desc: Code explicitly mentions privilege escalation
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "privilege.?escalation|privesc"
      case_insensitive: true

  - id: evasion-mention-comment
    desc: Code mentions evasion techniques
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "evasion|evade"
      case_insensitive: true

  - id: syscall-hook-mention-comment
    desc: Code mentions syscall hooking
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "syscall.{0,20}(hook|intercept)"
      case_insensitive: true

  # ============================================================
  # FUNCTION NAMING PATTERNS
  # ============================================================

  - id: hide-function-name
    desc: Function name suggests hiding capability
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: identifier
      regex: "hide|invisible|stealth"
      case_insensitive: true

  - id: hook-syscall-function-name
    desc: Function name suggests syscall hooking
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: function
      regex: "hook.{0,20}(sys|syscall)"
      case_insensitive: true

  # ============================================================
  # OBFUSCATED NAMING PATTERNS
  # ============================================================

  - id: random-prefix-function
    desc: Function with random-looking prefix (obfuscation)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: function
      regex: "^([a-f0-9]{8,}|x[a-f0-9]{8,})_"
    not:
      - regex: "^(CRYPTO|OpenSSL|ssize|ares_)"

  - id: underscore-heavy-naming
    desc: Heavy underscore usage in names
    crit: suspicious
    conf: 0.6
    for: [c]
    if:
      type: ast
      node: declaration
      regex: "^__[a-z]{1,40}(?:_[a-z0-9]{1,40}){1,8}"
    not:
      - regex: "^__declspec\\b"

  # ============================================================
