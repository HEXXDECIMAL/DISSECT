# Linux Kernel Rootkit Detection Traits
# These detect common rootkit behaviors in C source code
# MBC: Defense Evasion, Privilege Escalation
# ATT&CK: T1014 (Rootkit), T1068 (Exploitation for Privilege Escalation)

traits:
  # ============================================================
  # KERNEL MODULE HEADERS (string-based for reliable detection)
  # ============================================================

  - id: kprobes-include-str
    desc: linux/kprobes.h include (kernel hooking)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    if:
      type: string
      regex: "linux/kprobes\\.h"

  - id: dirent-include-str
    desc: linux/dirent.h include (file hiding)
    crit: suspicious
    conf: 0.9
    attack: "T1014"
    for: [c]
    if:
      type: string
      regex: "linux/dirent\\.h"

  - id: linkage-include-str
    desc: linux/linkage.h include (kernel ABI)
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: string
      regex: "linux/linkage\\.h"

  - id: kallsyms-lookup-name-str
    desc: kallsyms_lookup_name string (symbol resolution)
    crit: suspicious
    conf: 0.98
    mbc: "F0004"
    attack: "T1014"
    for: [c]
    if:
      type: string
      exact: "kallsyms_lookup_name"

  - id: syscall-table-str
    desc: __syscall_table reference
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    if:
      type: string
      regex: "__syscall_table"

  - id: linux-dirent-str
    desc: linux_dirent structure
    crit: suspicious
    conf: 0.9
    attack: "T1014"
    for: [c]
    if:
      type: string
      regex: "\\blinux_dirent\\b"

  - id: cr0-variable-str
    desc: cr0 register variable
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: string
      regex: "\\bcr0\\b"

  - id: force-order-str
    desc: __force_order variable (CR0 compiler barrier)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: string
      regex: "__force_order"

  - id: nr-getdents-str
    desc: NR_getdents syscall number reference
    crit: suspicious
    conf: 0.9
    attack: "T1014"
    for: [c]
    if:
      type: string
      regex: "NR_getdents"

  # ============================================================
  # KERNEL MODULE HEADERS (AST-based)

  - id: kernel-module-header
    desc: Linux kernel module header (loadable
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/module.h"

  - id: kernel-header
    desc: Linux kernel header
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/kernel.h"

  - id: kernel-syscalls-header
    desc: Linux syscall definitions (syscall hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/syscalls.h"

  - id: kernel-dirent-header
    desc: Linux directory entry header (file
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/dirent.h"

  - id: kernel-cred-header
    desc: Linux credentials header (privilege escalation)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/cred.h"

  - id: kernel-kallsyms-header
    desc: Linux kallsyms header (kernel symbol
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/kallsyms.h"

  - id: kernel-ftrace-header
    desc: Linux ftrace header (function tracing/hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/ftrace.h"

  - id: kernel-kprobes-header
    desc: Linux kprobes header (kernel probing/hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/kprobes.h"

  - id: kernel-procfs-header
    desc: Linux procfs header (process hiding)
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: import
      exact: "linux/proc_fs.h"

  - id: ftrace-helper-include
    desc: Ftrace helper library (common rootkit
    crit: suspicious
    conf: 0.99
    for: [c]
    if:
      type: ast
      kind: import
      exact: "ftrace_helper"

  # ============================================================
  # KERNEL FUNCTION CALLS
  # ============================================================

  - id: kallsyms-lookup
    desc: Kernel symbol lookup (rootkit indicator)
    crit: suspicious
    conf: 0.98
    mbc: "F0004"
    for: [c]
    if:
      type: ast
      kind: call
      exact: "kallsyms_lookup_name"

  - id: prepare-creds-call
    desc: Prepare kernel credentials (privilege escalation)
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    if:
      type: ast
      kind: call
      exact: "prepare_creds"

  - id: commit-creds-call
    desc: Commit kernel credentials (privilege escalation)
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    if:
      type: ast
      kind: call
      exact: "commit_creds"

  - id: list-del-call
    desc: Kernel list deletion (module hiding)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: call
      exact: "list_del"

  - id: cr0-read-call
    desc: Read CR0 register (memory protection
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast
      kind: call
      exact: "read_cr0"

  - id: cr0-write-call
    desc: Write CR0 register (disable write
    crit: suspicious
    conf: 0.99
    for: [c]
    if:
      type: ast
      kind: call
      exact: "write_cr0"

  - id: kzalloc-call
    desc: Kernel memory allocation
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: call
      exact: "kzalloc"

  - id: copy-from-user-call
    desc: Copy data from user space
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: call
      exact: "copy_from_user"

  - id: copy-to-user-call
    desc: Copy data from kernel to
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: call
      exact: "copy_to_user"

  # ============================================================
  # MODULE MACROS
  # ============================================================

  - id: module-license-macro
    desc: Kernel module license declaration
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: call
      exact: "MODULE_LICENSE"

  - id: module-init-macro
    desc: Kernel module initialization function
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast
      kind: call
      exact: "module_init"

  - id: module-exit-macro
    desc: Kernel module exit function
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: call
      exact: "module_exit"

  - id: for-each-process-macro
    desc: Kernel process enumeration macro
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: call
      exact: "for_each_process"

  # ============================================================
  # DECLARATIONS / STRUCTURES
  # ============================================================

  - id: syscall-table-decl
    desc: Syscall table pointer (syscall hooking)
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "sys_call_table"

  - id: task-struct-decl
    desc: Task structure access (process manipulation)
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "task_struct"

  - id: cred-struct-decl
    desc: Credential structure access (privilege escalation)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "struct cred"

  - id: linux-dirent-decl
    desc: Directory entry structure (file/process hiding)
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "linux_dirent"

  - id: pt-regs-decl
    desc: Register state structure (syscall interception)
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "pt_regs"

  # ============================================================
  # EXPRESSION PATTERNS
  # ============================================================

  - id: syscall-number-ref
    desc: Direct syscall number reference (syscall
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: binary_op
      exact: "__NR_"

  - id: proc-root-ino-ref
    desc: Proc filesystem root inode (process
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: binary_op
      exact: "PROC_ROOT_INO"

  - id: cr0-wp-bit-manipulation
    desc: CR0 write-protect bit manipulation
    crit: suspicious
    conf: 0.99
    for: [c]
    if:
      type: ast
      kind: binary_op
      exact: "0x00010000"

  - id: this-module-ref
    desc: Kernel module self-reference (module hiding)
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "THIS_MODULE"

  # ============================================================
  # COMMENT/METADATA DETECTION
  # ============================================================

  - id: rootkit-mention-comment
    desc: Code explicitly mentions rootkit
    crit: suspicious
    conf: 1.0
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "rootkit"
      case_insensitive: true

  - id: malware-mention-comment
    desc: Code explicitly mentions malware/backdoor
    crit: suspicious
    conf: 1.0
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "malware|backdoor"
      case_insensitive: true

  - id: privesc-mention-comment
    desc: Code explicitly mentions privilege escalation
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "privilege.?escalation|privesc"
      case_insensitive: true

  - id: evasion-mention-comment
    desc: Code mentions evasion techniques
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "evasion|evade"
      case_insensitive: true

  - id: syscall-hook-mention-comment
    desc: Code mentions syscall hooking
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "syscall.{0,20}(hook|intercept)"
      case_insensitive: true

  # ============================================================
  # FUNCTION NAMING PATTERNS
  # ============================================================

  - id: hide-function-name
    desc: Function name suggests hiding capability
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: function
      regex: "hide|invisible|stealth"
      case_insensitive: true

  - id: hook-syscall-function-name
    desc: Function name suggests syscall hooking
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: function
      regex: "hook.{0,20}(sys|syscall)"
      case_insensitive: true

  # ============================================================
  # INLINE ASSEMBLY
  # ============================================================

  - id: asm-cr0-manipulation
    desc: Inline assembly manipulating CR0 register
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast
      node: asm_statement
      exact: "cr0"
      case_insensitive: true

  - id: asm-syscall-invocation
    desc: Inline assembly with direct syscall
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      node: asm_statement
      regex: "int.{0,10}0x80|syscall|sysenter"

  # ============================================================
  # DIRECTORY ENTRY MANIPULATION (FILE/PROCESS HIDING)
  # ============================================================

  - id: d-reclen-manipulation
    desc: Directory entry record length manipulation
    crit: suspicious
    conf: 0.98
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "d_reclen"

  - id: d-name-access
    desc: Directory entry name field access
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "d_name"

  - id: simple-strtoul-call
    desc: String to unsigned long conversion
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: call
      exact: "simple_strtoul"

  - id: memmove-call
    desc: Memory move operation (often used
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "memmove"

  - id: memcmp-dirent-context
    desc: Memory comparison (file prefix matching
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "memcmp"

  # ============================================================
  # MODULE HIDING TECHNIQUES
  # ============================================================

  - id: sect-attrs-removal
    desc: Module section attributes removal (hide
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "sect_attrs"

  - id: list-add-call
    desc: Kernel list addition (module unhiding
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: call
      exact: "list_add"

  - id: kfree-call
    desc: Kernel memory free (often used
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "kfree"

  # ============================================================
  # SYSCALL HOOKING INFRASTRUCTURE
  # ============================================================

  - id: asmlinkage-decl
    desc: Assembly linkage declaration (syscall calling
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "asmlinkage"

  - id: t-syscall-typedef
    desc: Syscall function pointer typedef
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      node: type_definition
      regex: "t_syscall|syscall_fn|sys_call_ptr"

  - id: orig-syscall-pattern
    desc: Original syscall saving pattern (hooking
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "orig_"

  - id: pt-regs-register-access
    desc: Direct register access via pt_regs
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "pt_regs->"

  - id: pt-regs-di-access
    desc: RDI register access (first syscall
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "->di"

  - id: pt-regs-si-access
    desc: RSI register access (second syscall
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "->si"

  # ============================================================
  # KERNEL STRUCTURE TRAVERSAL
  # ============================================================

  - id: current-files-access
    desc: Current process file table access
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "current->files"

  - id: fdt-access
    desc: File descriptor table access
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "->fdt"

  - id: f-path-dentry-access
    desc: File path dentry access (inode
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "f_path.dentry"

  - id: d-inode-access
    desc: Dentry inode access
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "->d_inode"

  - id: i-ino-access
    desc: Inode number access (filesystem identification)
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "i_ino"

  - id: i-rdev-access
    desc: Inode device number access
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "i_rdev"

  - id: major-macro-call
    desc: MAJOR device number extraction
    crit: suspicious
    conf: 0.75
    for: [c]
    if:
      type: ast
      kind: call
      exact: "MAJOR"

  # ============================================================
  # USER/KERNEL BOUNDARY
  # ============================================================

  - id: user-annotation
    desc: __user annotation (kernel/userspace boundary marker)
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "__user"

  - id: gfp-kernel-alloc
    desc: GFP_KERNEL allocation flag
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "GFP_KERNEL"

  # ============================================================
  # MODULE LIFECYCLE
  # ============================================================

  - id: init-attribute
    desc: __init module initialization attribute
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: function
      exact: "__init"

  - id: exit-attribute
    desc: __exit module cleanup attribute
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: function
      exact: "__exit"

  - id: module-author-macro
    desc: MODULE_AUTHOR declaration (attacker attribution)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "MODULE_AUTHOR"

  - id: module-description-macro
    desc: MODULE_DESCRIPTION declaration
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: call
      exact: "MODULE_DESCRIPTION"

  - id: dual-bsd-gpl-license
    desc: Dual BSD/GPL license (common rootkit
    crit: suspicious
    conf: 0.6
    for: [c]
    if:
      type: ast
      kind: string
      exact: "Dual BSD/GPL"

  # ============================================================
  # SIGNAL-BASED BACKDOOR CONTROL
  # ============================================================

  - id: custom-signal-define
    desc: Custom signal definition (backdoor trigger)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    if:
      type: ast
      node: preproc_def
      regex: "SIG[A-Z]+"

  - id: signal-switch-handler
    desc: Signal-based switch handler (command dispatch)
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      node: switch_statement
      exact: "sig"
      case_insensitive: true

  # ============================================================
  # TASK/PROCESS MANIPULATION
  # ============================================================

  - id: task-flags-manipulation
    desc: Task flags manipulation (process hiding
    crit: suspicious
    conf: 0.98
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: attribute
      regex: "task->flags|p->flags"

  - id: pf-invisible-flag
    desc: PF_INVISIBLE flag value (0x10000000)
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: binary_op
      exact: "0x10000000"

  - id: xor-assign-flags
    desc: XOR assignment on flags (toggle
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: assignment
      regex: "\\^="

  - id: current-macro-ref
    desc: Current task reference macro
    crit: suspicious
    conf: 0.75
    for: [c]
    if:
      type: ast
      kind: identifier
      regex: "^current$"

  # ============================================================
  # CREDENTIAL MANIPULATION
  # ============================================================

  - id: uid-zero-assign
    desc: UID set to zero (root
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    if:
      type: ast
      kind: assignment
      regex: "uid.{0,10}=.{0,10}0|->uid = 0"

  - id: gid-zero-assign
    desc: GID set to zero (root
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    if:
      type: ast
      kind: assignment
      regex: "gid.{0,10}=.{0,10}0|->gid = 0"

  - id: euid-egid-access
    desc: Effective UID/GID access (privilege escalation)
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: attribute
      regex: "euid|egid|suid|sgid|fsuid|fsgid"

  # ============================================================
  # COMPILER/MEMORY ORDERING
  # ============================================================

  - id: force-order-variable
    desc: __force_order variable (prevent CR0 write
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "__force_order"

  - id: volatile-asm
    desc: Volatile inline assembly (prevent optimization)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      node: asm_statement
      exact: "volatile"

  # ============================================================
  # GETDENTS HOOKING SPECIFIC
  # ============================================================

  - id: getdents-hook-function
    desc: getdents hook function (directory listing
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    if:
      type: ast
      kind: function
      exact: "getdents"
      case_insensitive: true

  - id: nr-getdents-ref
    desc: __NR_getdents syscall number reference
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast
      node: subscript_expression
      exact: "__NR_getdents"

  - id: nr-kill-ref
    desc: __NR_kill syscall number reference (signal
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      node: subscript_expression
      exact: "__NR_kill"

  # ============================================================
  # SUSPICIOUS COMMENT PATTERNS
  # ============================================================

  - id: corruption-mention-comment
    desc: Code mentions corruption/corrupting
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "corrupt"
      case_insensitive: true

  - id: hiding-mention-comment
    desc: Code mentions hiding/hidden
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "hid(e|ing|den)"
      case_insensitive: true

  - id: stealthy-mention-comment
    desc: Code mentions stealth/stealthy
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "stealth"
      case_insensitive: true

  - id: unauthorized-mention-comment
    desc: Code mentions unauthorized access
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      regex: "unauthori[sz]ed"
      case_insensitive: true

  - id: defeating-mention-comment
    desc: Code mentions defeating protections
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "defeat"
      case_insensitive: true

  - id: persistence-mention-comment
    desc: Code mentions persistence
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "persist"
      case_insensitive: true

  - id: polymorphic-mention-comment
    desc: Code mentions polymorphic techniques
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "polymorphic"
      case_insensitive: true

  - id: covert-channel-mention-comment
    desc: Code mentions covert channels/communication
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast
      kind: comment
      exact: "covert"
      case_insensitive: true

  # ============================================================
  # OBFUSCATED NAMING PATTERNS
  # ============================================================

  - id: random-prefix-function
    desc: Function with random-looking prefix (obfuscation)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast
      kind: function
      regex: "^[a-z]{3,5}[0-9]?_"

  - id: underscore-heavy-naming
    desc: Heavy underscore usage in names
    crit: suspicious
    conf: 0.6
    for: [c]
    if:
      type: ast
      node: declaration
      regex: "^__[a-z]+"

  # ============================================================
  # RETURN VALUE MANIPULATION
  # ============================================================

  - id: esrch-return
    desc: Return -ESRCH (no such process
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast
      node: return_statement
      exact: "ESRCH"

  - id: error-code-return
    desc: Kernel error code return
    crit: suspicious
    conf: 0.6
    for: [c]
    if:
      type: ast
      node: return_statement
      regex: "-E[A-Z]+"

  # ============================================================
  # KERNEL MODULE LOADING (FILELESS) - micro-traits
  # ============================================================

  - id: memfd-create-call
    desc: memfd_create function call
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: symbol
      pattern: "memfd_create"

  - id: sys-memfd-create-ref
    desc: SYS_memfd_create syscall reference
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: string
      exact: "SYS_memfd_create"

  - id: finit-module-call
    desc: finit_module function call
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: symbol
      pattern: "finit_module"

  - id: sys-finit-module-ref
    desc: SYS_finit_module syscall reference
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: string
      exact: "SYS_finit_module"

  # ============================================================
  # MEMORY PROTECTION BYPASS (PTE) - micro-traits
  # ============================================================

  - id: lookup-address-call
    desc: lookup_address kernel function call
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: call
      exact: "lookup_address"

  - id: page-rw-flag
    desc: _PAGE_RW memory protection flag
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: string
      exact: "_PAGE_RW"

  - id: page-nx-flag
    desc: _PAGE_NX memory protection flag
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: string
      exact: "_PAGE_NX"

  # ============================================================
  # ELF BINARY PATCHING - micro-traits
  # ============================================================

  - id: elf64-ehdr-decl
    desc: Elf64_Ehdr structure declaration
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "Elf64_Ehdr"

  - id: elf64-shdr-decl
    desc: Elf64_Shdr structure declaration
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "Elf64_Shdr"

  - id: elf64-phdr-decl
    desc: Elf64_Phdr structure declaration
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast
      node: declaration
      exact: "Elf64_Phdr"

  - id: elf-entry-field
    desc: e_entry ELF entry point field
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast
      kind: attribute
      exact: "e_entry"

  - id: patch-string-ref
    desc: patch string reference
    crit: inert
    conf: 0.6
    for: [c]
    if:
      type: string
      word: "patch"

composite_rules:
  # memfd_create composite
  - id: memfd-create
    desc: memfd_create usage (memory-backed file)
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    count_min: 1
    any:
      - id: memfd-create-call
      - id: sys-memfd-create-ref

  # finit_module composite
  - id: finit-module
    desc: finit_module usage (module loading)
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    count_min: 1
    any:
      - id: finit-module-call
      - id: sys-finit-module-ref

  # Fileless LKM loading (migrated from YARA)
  - id: fileless-lkm-loading
    desc: Fileless kernel module loading (memfd_create
    crit: suspicious
    conf: 1.0
    attack: "T1620"
    for: [elf, c]
    all:
      - id: memfd-create
      - id: finit-module

  # Page protection flag composite
  - id: page-protection-flag
    desc: Memory page protection flags
    crit: suspicious
    conf: 0.9
    for: [c]
    count_min: 1
    any:
      - id: page-rw-flag
      - id: page-nx-flag

  # PTE manipulation (migrated from YARA)
  - id: pte-manipulation
    desc: Direct PTE manipulation to bypass
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    all:
      - id: lookup-address-call
      - id: page-protection-flag

  # ELF headers composite
  - id: elf64-headers
    desc: ELF64 structure headers
    crit: suspicious
    conf: 0.85
    for: [c]
    all:
      - id: elf64-ehdr-decl
      - id: elf64-shdr-decl
      - id: elf64-phdr-decl

  # ELF patching (migrated from YARA)
  - id: elf-patching
    desc: ELF binary structural patching (Infection)
    crit: suspicious
    conf: 0.95
    attack: "T1542.001"
    for: [c]
    all:
      - id: elf64-headers
    any:
      - id: elf-entry-field
      - id: patch-string-ref

  # Advanced LKM Rootkit Flow
  - id: advanced-lkm-rootkit
    desc: "Advanced LKM rootkit detected"
    crit: suspicious
    conf: 0.95

  # ============================================================
  # ROOTKIT HEADER DETECTION (string-based composites)
  # ============================================================

  # Kernel hooking infrastructure (kprobes for symbol resolution)
  - id: kprobes-kallsyms
    desc: Kprobes with kallsyms (kernel 5.7+ symbol bypass)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    all:
      - id: kprobes-include-str
      - id: kallsyms-lookup-name-str

  # Syscall hooking infrastructure
  - id: syscall-hook-setup
    desc: Syscall hooking setup (table+dirent)
    crit: suspicious
    conf: 0.9
    attack: "T1014"
    for: [c]
    count_min: 2
    any:
      - id: syscall-table-str
      - id: dirent-include-str
      - id: linux-dirent-str
      - id: nr-getdents-str

  # CR0 manipulation (memory write protection bypass)
  - id: cr0-bypass
    desc: CR0 write protection bypass
    crit: suspicious
    conf: 0.9
    for: [c]
    count_min: 1
    any:
      - id: cr0-variable-str
      - id: force-order-str

  # Rootkit header pattern (kernel module with hooking)
  - id: rootkit-header
    desc: Rootkit header file pattern
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    all:
      - id: linkage-include-str
    count_min: 2
    any:
      - id: kprobes-include-str
      - id: dirent-include-str
      - id: kallsyms-lookup-name-str
      - id: syscall-table-str
      - id: linux-dirent-str

  # Full rootkit header detection
  - id: lkm-rootkit-header
    desc: LKM rootkit header detected
    crit: hostile
    conf: 0.98
    attack: "T1014"
    for: [c]
    all:
      - id: linkage-include-str
      - id: kprobes-kallsyms
    count_min: 1
    any:
      - id: syscall-hook-setup
      - id: cr0-bypass
