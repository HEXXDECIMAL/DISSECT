# Kernel Rootkit Detection
# ATT&CK: T1014 (Rootkit)
# MBC: F0015 (Hijack Execution Flow)

traits:
  # === Kernel Symbol Resolution ===
  - id: proc-kallsyms
    desc: /proc/kallsyms kernel symbol file
    crit: notable
    conf: 0.75
    mbc: "F0015"
    attack: "T1014"
    if:
      type: string
      substr: "/proc/kallsyms"

  - id: proc-ksyms
    desc: /proc/ksyms legacy kernel symbol file
    crit: notable
    conf: 0.75
    mbc: "F0015"
    attack: "T1014"
    if:
      type: string
      substr: "/proc/ksyms"

  - id: lookup-address
    desc: lookup_address kernel function
    crit: notable
    conf: 0.8
    mbc: "F0015"
    if:
      type: symbol
      regex: "lookup_address"

  - id: kallsyms-lookup-fn
    desc: kallsyms_lookup kernel function
    crit: notable
    conf: 0.8
    mbc: "F0015"
    if:
      type: symbol
      regex: "kallsyms_lookup"

  # === TCP/UDP Seq Show Functions ===
  - id: tcp4-seq-show
    desc: tcp4_seq_show function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: symbol
      regex: "tcp4_seq_show"

  - id: tcp6-seq-show
    desc: tcp6_seq_show function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: symbol
      regex: "tcp6_seq_show"

  - id: udp4-seq-show
    desc: udp4_seq_show function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: symbol
      regex: "udp4_seq_show"

  - id: udp6-seq-show
    desc: udp6_seq_show function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: symbol
      regex: "udp6_seq_show"

  - id: proc-net-tcp
    desc: /proc/net/tcp path
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: string
      substr: "/proc/net/tcp"

  # === Proc Filesystem Hiding ===
  - id: proc-root-readdir
    desc: proc_root_readdir function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: symbol
      regex: "proc_root_readdir"

  - id: proc-iterate
    desc: proc_iterate function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    for: [elf, c]
    if:
      type: symbol
      regex: "proc_iterate"

  - id: proc-fill-cache
    desc: proc_fill_cache function
    crit: notable
    conf: 0.8
    for: [elf, c]
    if:
      type: symbol
      regex: "proc_fill_cache"

  - id: filldir
    desc: filldir callback function
    crit: notable
    conf: 0.75
    for: [elf, c]
    if:
      type: symbol
      regex: "filldir"

  - id: filldir64
    desc: filldir64 callback function
    crit: notable
    conf: 0.75
    for: [elf, c]
    if:
      type: symbol
      regex: "filldir64"

  - id: pid-getattr
    desc: pid_getattr function
    crit: notable
    conf: 0.8
    for: [elf, c]
    if:
      type: symbol
      regex: "pid_getattr"

  # === Syscall Table Manipulation ===
  - id: sys-call-table
    desc: sys_call_table reference
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: symbol
      regex: "sys_call_table"

  - id: sys-getpriority
    desc: sys_getpriority syscall
    crit: inert
    conf: 0.5
    for: [elf, c]
    if:
      type: symbol
      regex: "sys_getpriority"

  - id: sys-getdents
    desc: sys_getdents syscall
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: symbol
      regex: "sys_getdents"

  - id: sys-getdents64
    desc: sys_getdents64 syscall
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: symbol
      regex: "sys_getdents64"

  - id: sys-kill
    desc: sys_kill syscall
    crit: inert
    conf: 0.5
    for: [elf, c]
    if:
      type: symbol
      regex: "sys_kill"

  - id: orig-cr0
    desc: orig_cr0 CR0 register backup
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    for: [elf, c]
    if:
      type: string
      substr: "orig_cr0"

  - id: write-cr0
    desc: write_cr0 function
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    for: [elf, c]
    if:
      type: symbol
      regex: "write_cr0"

  - id: native-write-cr0
    desc: native_write_cr0 function
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    for: [elf, c]
    if:
      type: symbol
      regex: "native_write_cr0"

  # === Kernel Module Markers ===
  - id: init-module
    desc: init_module entry point
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "init_module"

  - id: cleanup-module
    desc: cleanup_module exit point
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "cleanup_module"

  - id: this-module
    desc: __this_module reference
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "__this_module"

  - id: vermagic
    desc: vermagic= kernel version magic
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "vermagic="

  - id: modinfo-section
    desc: .modinfo section
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: ".modinfo"

  - id: gnu-linkonce
    desc: .gnu.linkonce section
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: ".gnu.linkonce"

  # === Netfilter Hook Functions ===
  - id: nf-register-hook
    desc: nf_register_hook function
    crit: notable
    conf: 0.8
    mbc: "F0015"
    if:
      type: symbol
      regex: "nf_register_hook"

  - id: nf-register-net-hook
    desc: nf_register_net_hook function
    crit: notable
    conf: 0.8
    mbc: "F0015"
    if:
      type: symbol
      regex: "nf_register_net_hook"

  - id: nf-unregister-hook
    desc: nf_unregister_hook function
    crit: notable
    conf: 0.8
    if:
      type: symbol
      regex: "nf_unregister_hook"

  - id: nf-hookfn
    desc: nf_hookfn callback type
    crit: notable
    conf: 0.75
    if:
      type: string
      substr: "nf_hookfn"

  - id: nf-accept
    desc: NF_ACCEPT verdict
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "NF_ACCEPT"

  - id: nf-drop
    desc: NF_DROP verdict
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "NF_DROP"

  # === VFS Layer Functions ===
  - id: vfs-read
    desc: vfs_read function
    crit: inert
    conf: 0.5
    for: [elf, c]
    if:
      type: symbol
      regex: "vfs_read"

  - id: vfs-write
    desc: vfs_write function
    crit: inert
    conf: 0.5
    for: [elf, c]
    if:
      type: symbol
      regex: "vfs_write"

  - id: vfs-readdir
    desc: vfs_readdir function
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: symbol
      regex: "vfs_readdir"

  - id: iterate-dir
    desc: iterate_dir function
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: symbol
      regex: "iterate_dir"

  - id: file-operations
    desc: file_operations struct
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: string
      substr: "file_operations"

  - id: inode-operations
    desc: inode_operations struct
    crit: notable
    conf: 0.7
    for: [elf, c]
    if:
      type: string
      substr: "inode_operations"

  # === Diamorphine Rootkit Indicators ===
  - id: diamorphine-name
    desc: Diamorphine rootkit name
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: string
      regex: "(?i)diamorphine"

  - id: is-invisible
    desc: is_invisible function
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "is_invisible"

  - id: module-hidden
    desc: module_hidden flag
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "module_hidden"

  - id: hide-module
    desc: hide_module function
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "hide_module"

  - id: give-root
    desc: give_root function
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    for: [elf, c]
    if:
      type: string
      substr: "give_root"

  - id: hacked-kill
    desc: hacked_kill function
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "hacked_kill"

  - id: orig-getdents
    desc: orig_getdents function
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "orig_getdents"

  # === Reptile Rootkit Indicators ===
  - id: reptile-name
    desc: Reptile rootkit name
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: string
      regex: "(?i)reptile"

  - id: khook
    desc: khook framework marker
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "khook"

  - id: kmatryoshka
    desc: kmatryoshka packer marker
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "kmatryoshka"

  - id: reptile-hide
    desc: reptile_hide function
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: string
      substr: "reptile_hide"

  - id: magic-packet
    desc: YOURMAGICPACKET trigger
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      substr: "YOURMAGICPACKET"

  - id: reptile-cmd
    desc: reptile_cmd backdoor
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: string
      substr: "reptile_cmd"

  # === Syslogk Rootkit Indicators ===
  - id: syslogk-name
    desc: Syslogk rootkit name
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    if:
      type: string
      regex: "(?i)syslogk"

  - id: rekoobe-magic
    desc: Rekoobe magic string (PgSD93iu)
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    if:
      type: string
      substr: "PgSD93iu"

composite_rules:
  # Kallsyms lookup (migrated from YARA)
  - id: kallsyms-lookup
    desc: Accesses /proc/kallsyms for kernel symbol
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    count_min: 1
    any:
      - id: proc-kallsyms
      - id: proc-ksyms
      - id: lookup-address
      - id: kallsyms-lookup-fn

  # TCP seq show functions helper
  - id: tcp-seq-funcs
    desc: TCP/UDP seq_show hook functions
    crit: suspicious
    conf: 0.85
    for: [elf, c]
    count_min: 1
    any:
      - id: tcp4-seq-show
      - id: tcp6-seq-show
      - id: udp4-seq-show
      - id: udp6-seq-show

  # TCP hiding (migrated from YARA)
  - id: tcp-hiding
    desc: Hooks TCP sequence show function
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    count_min: 1
    any:
      - id: tcp-seq-funcs
      - id: proc-net-tcp

  # Proc hiding functions helper
  - id: proc-hiding-funcs
    desc: Proc filesystem hiding functions
    crit: suspicious
    conf: 0.85
    for: [elf, c]
    count_min: 2
    any:
      - id: proc-root-readdir
      - id: proc-iterate
      - id: proc-fill-cache
      - id: filldir
      - id: filldir64
      - id: pid-getattr


  # Syscall hook target helper
  - id: syscall-targets
    desc: Syscall hook targets
    crit: notable
    conf: 0.7
    for: [elf, c]
    count_min: 1
    any:
      - id: sys-getpriority
      - id: sys-getdents
      - id: sys-getdents64
      - id: sys-kill

  # CR0 manipulation helper
  - id: cr0-manipulation
    desc: CR0 write protection bypass
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    count_min: 1
    any:
      - id: orig-cr0
      - id: write-cr0
      - id: native-write-cr0

  # Syscall hook (migrated from YARA)
  - id: syscall-hook
    desc: Syscall table manipulation patterns
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    count_min: 1
    any:
      - id: syscall-table-hook
      - id: cr0-manipulation

  # Syscall table hook helper
  - id: syscall-table-hook
    desc: Syscall table with hook targets
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    all:
      - id: sys-call-table
      - id: syscall-targets

  # Module format markers helper
  - id: module-markers
    desc: Kernel module format markers
    crit: inert
    conf: 0.5
    count_min: 3
    any:
      - id: init-module
      - id: cleanup-module
      - id: this-module
      - id: vermagic
      - id: modinfo-section
      - id: gnu-linkonce


  # Netfilter hook registration helper
  - id: nf-registration
    desc: Netfilter hook registration functions
    crit: notable
    conf: 0.8
    count_min: 1
    any:
      - id: nf-register-hook
      - id: nf-register-net-hook
      - id: nf-unregister-hook
      - id: nf-hookfn

  # Netfilter verdicts helper
  - id: nf-verdicts
    desc: Netfilter verdict values
    crit: inert
    conf: 0.5
    count_min: 1
    any:
      - id: nf-accept
      - id: nf-drop

  # Netfilter hook (migrated from YARA)
  - id: netfilter-hook
    desc: Netfilter hook manipulation for packet
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    count_min: 2
    any:
      - id: nf-registration
      - id: nf-verdicts

  # VFS operations helper
  - id: vfs-operations
    desc: VFS operation structures
    crit: notable
    conf: 0.7
    for: [elf, c]
    count_min: 1
    any:
      - id: file-operations
      - id: inode-operations

  # VFS functions helper
  - id: vfs-functions
    desc: VFS layer functions
    crit: notable
    conf: 0.6
    for: [elf, c]
    count_min: 1
    any:
      - id: vfs-read
      - id: vfs-write
      - id: vfs-readdir
      - id: iterate-dir

  # VFS hook (migrated from YARA)
  - id: vfs-hook
    desc: VFS layer hooking for file
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    all:
      - id: vfs-operations
      - id: vfs-functions

  # Diamorphine behavior helper
  - id: diamorphine-behavior
    desc: Diamorphine behavior markers
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    count_min: 1
    any:
      - id: module-hidden
      - id: hide-module
      - id: give-root

  # Diamorphine hook helper
  - id: diamorphine-hooks
    desc: Diamorphine hook markers
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    all:
      - id: hacked-kill
      - id: orig-getdents

  # Diamorphine detection (migrated from YARA)
  - id: diamorphine
    desc: Diamorphine kernel rootkit indicators
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    count_min: 1
    any:
      - id: diamorphine-name
      - id: diamorphine-with-behavior
      - id: diamorphine-hooks

  # Diamorphine with behavior helper
  - id: diamorphine-with-behavior
    desc: Diamorphine with behavior markers
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    all:
      - id: is-invisible
      - id: diamorphine-behavior

  # Reptile (migrated from YARA)
  - id: reptile
    desc: Reptile kernel rootkit indicators
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    count_min: 1
    any:
      - id: reptile-name
      - id: reptile-markers

  # Reptile markers helper
  - id: reptile-markers
    desc: Reptile rootkit markers
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    count_min: 2
    any:
      - id: khook
      - id: kmatryoshka
      - id: reptile-hide
      - id: magic-packet
      - id: reptile-cmd

  # Syslogk behavior helper
  - id: syslogk-behavior
    desc: Syslogk rootkit behavior
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    all:
      - id: proc-kallsyms
      - id: tcp4-seq-show

  # Syslogk (migrated from YARA)
  - id: syslogk
    desc: Syslogk kernel rootkit indicators
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    count_min: 1
    any:
      - id: syslogk-behavior
      - id: syslogk-name
      - id: rekoobe-magic

  # Full kernel rootkit detection
  - id: lkm-rootkit
    desc: Linux Kernel Module rootkit detected
    crit: hostile
    conf: 0.95
    mbc: "F0015"
    attack: "T1014"
    for: [elf, c]
    all:
      - id: module-markers
      - id: lkm-rootkit-behavior
      - id: kallsyms-lookup

  # LKM rootkit behavior helper
  - id: lkm-rootkit-behavior
    desc: LKM rootkit behavior indicators
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    count_min: 1
    any:
      - id: syscall-hook
      - id: proc-hiding-funcs
      - id: tcp-hiding
      - id: vfs-hook
