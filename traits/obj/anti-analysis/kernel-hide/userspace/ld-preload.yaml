# Userspace Rootkit Detection - LD_PRELOAD Hooking
# MBC: F0015 (Hijack Execution Flow)
# ATT&CK: T1574.006 (Dynamic Linker Hijacking)

traits:
  # === LD_PRELOAD environment micro-traits ===
  - id: ld-preload-env
    desc: References LD_PRELOAD environment variable
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "LD_PRELOAD"

  - id: ld-library-path-env
    desc: References LD_LIBRARY_PATH environment variable
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "LD_LIBRARY_PATH"

  # === Hooking infrastructure micro-traits ===
  # NOTE: dlsym-call moved to cap/exec/dylib/load/dlsym (proper taxonomy).
  # This file retains references to cap/exec/dylib/load/dlsym for composite rules.

  - id: rtld-next-ref
    desc: RTLD_NEXT macro reference
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "RTLD_NEXT"

  - id: dlsym-rtld-next-pattern
    desc: dlsym(RTLD_NEXT pattern
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "dlsym\\s*\\(\\s*RTLD_NEXT"

  # NOTE: Removed generic libc function string traits (fopen-string, readdir-string, etc.)
  # These match nearly every binary and create excessive noise. The libc-targets composite
  # and libc-hook-targets rules have been removed as they relied on these overly generic patterns.
  # Rootkit detection should focus on the hook infrastructure (dlsym + RTLD_NEXT) combined
  # with specific rootkit indicators (hide_pid, proc hiding, etc.) rather than generic function names.

  # === Symbiote rootkit indicators ===
  - id: skullseclabs-string
    desc: skullseclabs author string
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: string
      substr: "skullseclabs"

  - id: dnscat-string
    desc: DNSCAT C2 string
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: string
      substr: "DNSCAT"

  - id: hooked-string
    desc: Hooked function indicator
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: string
      substr: "Hooked"

  # NOTE: "Static" as a standalone string is too generic - appears in debug info,
  # type systems, and graphics libraries. This trait is only meaningful in combination
  # with other Symbiote rootkit indicators in the symbiote composite rule.
  # Changed to match more specific context patterns.
  - id: static-string
    desc: Static hook indicator
    crit: inert
    conf: 0.5
    for: [elf]
    if:
      type: string
      # Match patterns like "Static: <function>" that Symbiote uses
      regex: 'Static:\s+\w+'

  - id: original-prefix
    desc: original_ function prefix (hook backup)
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: string
      # Match original_ followed by common hooked function names, not just any original_ prefix
      regex: "original_(?:open|read|write|stat|fopen|readdir|execve|connect|socket|getdents|unlink)"
    # System libraries, compiler tools, and debuggers may have these for legitimate wrapper/forwarding purposes
    # Note: Must reference atomic traits (not composites) since traits are evaluated before composites
    unless:
      - id: cap/exec/load/gnu-coreutils-ref
      - id: cap/exec/load/glibc-ref
      - id: cap/exec/load/systemd-ref
      - id: cap/exec/load/libc-characteristic-symbols
      - id: cap/exec/load/llvm-project-ref
      - id: cap/exec/load/llvm-lib-ref
      - id: cap/exec/load/gcc-project-ref
      - id: cap/exec/load/gdb-debugger-ref
      - id: cap/exec/load/lldb-debugger-ref
      - id: cap/exec/load/debugger-ptrace-marker

  - id: real-prefix
    desc: real_ function prefix (hook backup)
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: string
      # Match real_ followed by common hooked function names, not just any real_ prefix
      regex: "real_(?:open|read|write|stat|fopen|readdir|execve|connect|socket|getdents|unlink)"
    # System libraries, compiler tools, and debuggers may have these for legitimate wrapper/forwarding purposes
    # Note: Must reference atomic traits (not composites) since traits are evaluated before composites
    unless:
      - id: cap/exec/load/gnu-coreutils-ref
      - id: cap/exec/load/glibc-ref
      - id: cap/exec/load/systemd-ref
      - id: cap/exec/load/libc-characteristic-symbols
      - id: cap/exec/load/llvm-project-ref
      - id: cap/exec/load/llvm-lib-ref
      - id: cap/exec/load/gcc-project-ref
      - id: cap/exec/load/gdb-debugger-ref
      - id: cap/exec/load/lldb-debugger-ref
      - id: cap/exec/load/debugger-ptrace-marker

  # === /proc hiding micro-traits ===
  - id: proc-self-string
    desc: /proc/self path reference
    crit: inert
    conf: 0.4
    for: [elf, c]
    if:
      type: string
      substr: "/proc/self"

  - id: proc-pid-pattern
    desc: /proc/[pid] path pattern
    crit: inert
    conf: 0.4
    for: [elf, c]
    if:
      type: string
      regex: "/proc/[0-9]+"

  - id: proc-net-string
    desc: /proc/net path reference
    crit: inert
    conf: 0.4
    for: [elf, c]
    if:
      type: string
      substr: "/proc/net"

  - id: hide-pid-string
    desc: hide_pid string reference
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      word: "hide_pid"

  - id: hidden-proc-string
    desc: hidden_proc string reference
    crit: suspicious
    conf: 0.9
    for: [elf, c]
    if:
      type: string
      word: "hidden_proc"

  # === ld.so backup micro-traits ===
  - id: backup-ld-string
    desc: backup_ld string reference
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: string
      word: "backup_ld"

  - id: orig-ld-string
    desc: orig_ld string reference
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: string
      word: "orig_ld"

  - id: real-ld-string
    desc: real_ld string reference
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: string
      word: "real_ld"

  - id: ld-so-bak-pattern
    desc: ld.so backup file pattern
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: string
      regex: "ld[\\-_\\.]so[.\\-_]?bak"
      case_insensitive: true

  - id: backup-ld-so-file
    desc: .backup_ld.so file reference
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: string
      substr: ".backup_ld.so"

  # Dynamic linker hook symbol (_dlfcn_hook)
  - id: dlfcn-hook-symbol
    desc: Contains _dlfcn_hook symbol (dynamic linker
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf]
    if:
      type: string
      substr: "_dlfcn_hook"

  # ld.so.preload file path (rootkit installation target)
  - id: ld-so-preload-file
    desc: References /etc/ld.so.preload file
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf, shell]
    if:
      type: string
      substr: "/etc/ld.so.preload"

  # ld.so.preload clearing (removing hooks or preparing for new ones)
  - id: ld-so-preload-clear
    desc: Clears /etc/ld.so.preload content
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1574.006"
    for: [shell]
    if:
      type: string
      regex: '(cat\s+/dev/null\s*>\s*/etc/ld\.so\.preload|>\s*/etc/ld\.so\.preload|echo\s*>\s*/etc/ld\.so\.preload|truncate\s+.{0,50}\s*/etc/ld\.so\.preload)'

  # chattr on ld.so.preload (removing protection to modify it)
  - id: ld-so-preload-chattr
    desc: Removes file attributes from ld.so.preload
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1574.006"
    for: [shell]
    if:
      type: string
      regex: 'chattr\s+[-][ia]+\s+/etc/ld\.so\.preload'

  # __libc_dlopen_mode (internal glibc dynamic loading)
  - id: libc-dlopen-mode
    desc: Uses __libc_dlopen_mode (internal glibc loader)
    crit: suspicious
    conf: 0.8
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf]
    if:
      type: string
      substr: "__libc_dlopen_mode"

composite_rules:
  # LD_PRELOAD env composite (migrated from YARA)
  - id: ld-preload
    desc: References LD_PRELOAD environment variable
    crit: notable
    conf: 0.8
    count_min: 1
    any:
      - id: ld-preload-env
      - id: ld-library-path-env

  # Hook infrastructure composite
  - id: hook-infrastructure
    desc: Hooking infrastructure (dlsym + RTLD_NEXT)
    crit: suspicious
    conf: 0.9
    count_min: 1
    any:
      - id: dlsym-rtld-next-pattern
    all:
      - id: cap/exec/dylib/load/dlsym
      - id: rtld-next-ref

  # dlsym RTLD_NEXT pattern (migrated from YARA)
  - id: dlsym-rtld-next
    desc: Uses dlsym with RTLD_NEXT (function
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1574.006"
    count_min: 1
    any:
      - id: dlsym-rtld-next-pattern
      - id: hook-infrastructure

  # Hook indicator composite
  - id: hook-indicator
    desc: Hook implementation indicator
    crit: notable
    conf: 0.7
    count_min: 2
    any:
      - id: cap/exec/dylib/load/dlsym
      - id: rtld-next-ref
      - id: ld-preload-env
      - id: dlsym-rtld-next-pattern
    unless:
      - id: cap/exec/load/system-lib-marker

  # Hook prefix composite
  - id: hook-prefixes
    desc: Function hook prefixes (original_/real_)
    crit: notable
    conf: 0.7
    for: [elf]
    all:
      - id: original-prefix
      - id: real-prefix

  # Symbiote rootkit (migrated from YARA)
  - id: symbiote
    desc: Symbiote rootkit indicators
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf]
    count_min: 1
    any:
      - id: skullseclabs-string
      - id: dnscat-string
      - id: hook-prefixes
    all:
      - id: hooked-string
      - id: static-string

  # /proc paths composite
  - id: proc-paths
    desc: Multiple /proc path references
    crit: inert
    conf: 0.4
    for: [elf, c]
    count_min: 3
    any:
      - id: proc-self-string
      - id: proc-pid-pattern
      - id: proc-net-string

  # proc hiding (migrated from YARA)
  - id: proc-hiding
    desc: Patterns for hiding processes via
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf, c]
    count_min: 1
    any:
      - id: hide-pid-string
      - id: hidden-proc-string
      - id: proc-paths

  # ld backup pattern (migrated from YARA)
  - id: ld-backup-pattern
    desc: Dynamic linker backup/restore pattern
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf]
    count_min: 1
    any:
      - id: backup-ld-string
      - id: orig-ld-string
      - id: real-ld-string
      - id: ld-so-bak-pattern
      - id: backup-ld-so-file

  # Full LD_PRELOAD rootkit
  - id: ld-preload-rootkit
    desc: LD_PRELOAD userspace rootkit (Symbiote-style)
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf]
    all:
      - id: dlsym-rtld-next
    any:
      - id: proc-hiding
      - id: symbiote
      - id: hook-prefixes

  # LD_PRELOAD installation rootkit
  - id: ld-preload-installer
    desc: LD_PRELOAD rootkit installer (modifies
    crit: suspicious
    conf: 0.95
    mbc: "F0015"
    attack: "T1574.006"
    for: [elf]
    all:
      - id: ld-so-preload-file
    any:
      - id: ld-backup-pattern
      - id: libc-dlopen-mode
      - id: dlsym-rtld-next
