# Rootkit Detection - Linux Userspace
# MBC: B0003 (Rootkit)
# ATT&CK: T1014

traits:
  # === Rootkit String Markers ===
  - id: rootkit-string
    desc: Rootkit string reference
    crit: suspicious
    conf: 0.7
    mbc: "B0003"
    attack: "T1014"
    if:
      type: string
      regex: "(?i)rootkit"

  - id: hide-pid
    desc: hide_pid function
    crit: suspicious
    conf: 0.85
    mbc: "B0003"
    attack: "T1014"
    if:
      type: string
      substr: "hide_pid"

  - id: hide-file
    desc: hide_file function
    crit: suspicious
    conf: 0.85
    mbc: "B0003"
    attack: "T1014"
    if:
      type: string
      substr: "hide_file"

  # === LD_PRELOAD Injection ===
  - id: ld-preload-file
    desc: /etc/ld.so.preload injection target
    crit: suspicious
    conf: 0.85
    mbc: "B0003"
    attack: "T1574.006"
    if:
      type: string
      substr: "/etc/ld.so.preload"

  # === Directory listing hooking ===
  # Note: Rootkit libraries EXPORT malicious readdir/getdents to intercept calls.
  # Normal binaries only IMPORT these from libc. We detect this by requiring
  # the binary has exports (most normal binaries like fd have 0 exports).
  - id: readdir-symbol
    desc: readdir function symbol
    crit: inert
    conf: 0.5
    for: [elf]
    if:
      type: symbol
      regex: "^readdir"

  - id: getdents-symbol
    desc: getdents function symbol
    crit: inert
    conf: 0.5
    for: [elf]
    if:
      type: symbol
      regex: "^getdents"

  - id: has-exports
    desc: Binary exports symbols
    crit: inert
    conf: 0.5
    for: [elf]
    if:
      type: exports_count
      min: 1

  # === Process Filtering Functions ===
  - id: filter-process-name
    desc: Process filtering function reference
    crit: suspicious
    conf: 0.85
    mbc: "B0003"
    attack: "T1014"
    if:
      type: string
      regex: "(process_to_filter|filter_process|hide_process|should_hide|filtered_process)"

  - id: original-readdir-backup
    desc: Backed-up original readdir function
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    if:
      type: string
      regex: "^original_readdir"

composite_rules:
  # Composite for readdir hook detection - requires the binary to have exports
  # (shared libraries export functions, normal executables typically don't)
  - id: readdir-hook
    desc: Exported readdir function (directory listing hook)
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf]
    all:
      - id: readdir-symbol
      - id: has-exports

  - id: getdents-hook
    desc: Exported getdents function (directory listing hook)
    crit: suspicious
    conf: 0.85
    mbc: "F0015"
    attack: "T1014"
    for: [elf]
    all:
      - id: getdents-symbol
      - id: has-exports

  # Direct hooked library rootkit (exported function hooking)
  - id: hooked-library
    desc: Userspace rootkit library with hooked functions
    crit: suspicious
    conf: 0.9
    mbc: "F0015"
    attack: "T1014"
    for: [elf]
    all:
      - id: cap/exec/dylib/load/dlsym
    any:
      - id: readdir-hook
      - id: getdents-hook

  # Linux userspace rootkit (migrated from YARA)
  - id: rootkit
    desc: Linux rootkit patterns
    crit: suspicious
    conf: 0.66
    mbc: "B0003"
    attack: "T1014"
    needs: 2
    any:
      - id: rootkit-string
      - id: hide-pid
      - id: hide-file
      - id: ld-preload-file
      - id: readdir-hook
      - id: getdents-hook

  # === HOSTILE: Process-Hiding Rootkit Library ===
  # Detects userspace rootkit libraries that actively hide processes
  # Pattern: exported readdir hook + process filtering logic + backed-up original functions
  # Complexity: for(+1) + all(+3) = 4 >= 4 âœ“
  - id: process-hiding-rootkit
    desc: Process-hiding rootkit library
    crit: hostile
    conf: 0.95
    mbc: "B0003"
    attack: "T1014"
    for: [elf]
    all:
      - id: hooked-library
      - id: filter-process-name
      - id: original-readdir-backup
