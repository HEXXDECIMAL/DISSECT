# eBPF Offensive Rootkit Traits
# Detects malicious usage of eBPF for hooking, hiding, and privilege escalation
# Patterns derived from TripleCross and other eBPF rootkits

traits:
  # === eBPF Section Markers ===
  - id: sec-syscall-enter
    desc: 'SEC("tp/syscalls/sys_enter_") tracepoint'
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      regex: 'SEC\("t(p|racepoint)/syscalls/sys_enter_'

  - id: sec-syscall-exit
    desc: 'SEC("tp/syscalls/sys_exit_") tracepoint'
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      regex: 'SEC\("t(p|racepoint)/syscalls/sys_exit_'

  - id: sec-xdp
    desc: 'SEC("xdp") section marker'
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      exact: 'SEC("xdp'

  - id: sec-uprobe
    desc: 'SEC("uprobe/") section marker'
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      exact: 'SEC("uprobe/'

  # === XDP Packet Structures ===
  - id: xdp-md-struct
    desc: struct xdp_md packet context
    crit: inert
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      exact: "struct xdp_md"

  - id: xdp-data-end
    desc: XDP data_end pointer
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: string
      exact: "data_end"

  - id: xdp-iph
    desc: IP header struct reference
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: string
      exact: "iph"

  - id: xdp-tcph
    desc: TCP header struct reference
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: string
      exact: "tcph"

  # NOTE: Standalone "payload" is too generic - matches legitimate binaries.
  # Only meaningful in XDP/eBPF context with other XDP indicators.
  - id: xdp-payload
    desc: Packet payload reference
    crit: inert
    conf: 0.5
    for: [c]
    if:
      type: string
      # Match XDP-specific payload access patterns, not generic "payload" word
      regex: "(?:xdp|packet|ctx)[_-]?(?:payload|data)|payload[_-]?(?:ptr|offset|len)"

  # === Intent Markers ===
  # Moved to feat/intent/

  # === Go eBPF Libraries ===
  - id: cilium-ebpf
    desc: github.com/cilium/ebpf library
    crit: notable
    conf: 0.85
    for: [go]
    if:
      type: string
      exact: "github.com/cilium/ebpf"

  - id: libbpfgo
    desc: github.com/aquasecurity/libbpfgo library
    crit: notable
    conf: 0.85
    for: [go]
    if:
      type: string
      exact: "github.com/aquasecurity/libbpfgo"

  - id: datadog-ebpf
    desc: github.com/DataDog/ebpf library
    crit: notable
    conf: 0.85
    for: [go]
    if:
      type: string
      exact: "github.com/DataDog/ebpf"

  - id: ebpf-new-collection
    desc: ebpf.NewCollection function
    crit: notable
    conf: 0.85
    for: [go]
    if:
      type: string
      exact: "ebpf.NewCollection"

  - id: ebpf-new-program
    desc: ebpf.NewProgram function
    crit: notable
    conf: 0.85
    for: [go]
    if:
      type: string
      exact: "ebpf.NewProgram"

  - id: load-pinned-program
    desc: LoadPinnedProgram function
    crit: notable
    conf: 0.85
    for: [go]
    if:
      type: string
      exact: "LoadPinnedProgram"

  # === Offensive Intent ===
  - id: rootkit-string
    desc: Rootkit string reference
    crit: suspicious
    conf: 0.8
    if:
      type: string
      word: "rootkit"
      case_insensitive: true

  - id: hide-string
    desc: Hide string reference
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "hide"
      case_insensitive: true

  - id: bypass-string
    desc: Bypass string reference
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "bypass"
      case_insensitive: true

  # NOTE: Moved to feat/intent/ since this is a generic intent marker, not eBPF-specific
  # The composite rules that need this should reference feat/intent/patch-code
  # - id: patch-string
  #   desc: Patch string reference
  #   crit: inert
  #   conf: 0.5
  #   for: [c, elf, go]
  #   if:
  #     type: string
  #     regex: "(?i)(?:memory[_-]?patch|patch[_-]?(?:code|byte|func|hook|syscall)|kernel[_-]?patch|runtime[_-]?patch)"

  # === eBPF Manipulation Functions ===
  - id: bpf-probe-write-user
    desc: bpf_probe_write_user function (memory patching)
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: symbol
      pattern: "bpf_probe_write_user"

  # === Sensitive File References ===
  - id: sudoers-ref
    desc: Sudoers file reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)sudoers"

  - id: shadow-ref
    desc: Shadow file reference
    crit: notable
    conf: 0.7
    if:
      type: string
      # Match /etc/shadow path or shadow file context, not graphics shadow
      regex: "/etc/shadow(?:\\b|$)|shadow[_-](?:file|passwd|db|hash)"
    # Graphics/system libraries shouldn't be flagged for shadow file references
    unless:
      - id: meta/library/graphics-lib-marker
      - id: cap/exec/load/system-lib-marker

  - id: passwd-ref
    desc: Passwd file reference
    crit: notable
    conf: 0.6
    if:
      type: string
      # Match passwd file paths only, not getpwnam/getpwuid (legitimate POSIX functions)
      # These functions are used by nearly every program to look up user info
      regex: "/etc/passwd(?:\\b|$)|passwd[_-](?:file|db|hash)"

  # === Directory Entry Hiding ===
  - id: getdents64-tracepoint
    desc: tp/syscalls/sys_exit_getdents64 tracepoint
    crit: suspicious
    conf: 0.9
    for: [c, elf]
    if:
      type: string
      exact: "tp/syscalls/sys_exit_getdents64"

  - id: d-reclen
    desc: d_reclen dirent field
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: string
      exact: "d_reclen"

  # === Uprobe Hooking ===
  - id: crypt-verify
    desc: crypt_verify function reference
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      exact: "crypt_verify"

  - id: password-string
    desc: Password string reference
    crit: inert
    conf: 0.4
    for: [c, elf]
    if:
      type: string
      # Match password in credential hooking context, not generic UI/prompt usage
      # Require programming patterns like password_buf, password_ptr, etc.
      regex: "(?:password[_-]?(?:buf|ptr|len|hash|data|struct|arg)|get[_-]?password|check[_-]?password)"

  # === HTTP Manipulation ===
  - id: http-routes
    desc: http_routes manipulation
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      exact: "http_routes"

  - id: http-edit
    desc: HTTP_EDIT action
    crit: suspicious
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      exact: "HTTP_EDIT"

  - id: http-drop
    desc: HTTP_DROP action
    crit: suspicious
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      exact: "HTTP_DROP"

  # NOTE: This trait is only meaningful in eBPF/XDP packet manipulation context.
  # It's used in the http-manipulation composite rule which requires sec-xdp.
  # For standalone detection, "HTTP" is too generic (every web-related tool has it).
  # Restricted to C source files where it indicates eBPF program development.
  - id: http-string
    desc: HTTP packet manipulation marker
    crit: inert
    conf: 0.3
    for: [c]
    if:
      type: string
      # Match HTTP in packet manipulation context, not general HTTP protocol refs
      regex: "HTTP[_-](?:EDIT|DROP|PASS|REDIRECT|HIJACK)|packet.{0,20}HTTP|HTTP.{0,20}packet"

composite_rules:
  # eBPF syscall hooking (migrated from YARA)
  - id: syscall-hooking
    desc: eBPF program hooking syscall tracepoints
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c, elf]
    count_min: 1
    any:
      - id: sec-syscall-enter
      - id: sec-syscall-exit

  # XDP packet inspection helper
  - id: xdp-packet-inspection
    desc: XDP packet inspection primitives
    crit: notable
    conf: 0.7
    for: [c, elf]
    count_min: 3
    any:
      - id: xdp-data-end
      - id: xdp-iph
      - id: xdp-tcph
      - id: xdp-payload

  # Intent markers helper (eBPF context only)
  # Requires eBPF context markers, not just generic intent strings
  - id: offensive-intent
    desc: Offensive intent markers
    crit: notable
    conf: 0.7
    for: [c, elf, rust]
    all:
      # Require some eBPF indicator to avoid FPs on games/generic binaries
      - id: ebpf-indicator
    any:
      - id: meta/intent/magic
      - id: meta/intent/trigger
      - id: meta/intent/backdoor
      - id: meta/intent/secret

  # Helper: any eBPF-related indicator
  - id: ebpf-indicator
    desc: eBPF-related markers
    crit: inert
    conf: 0.6
    for: [c, elf]
    count_min: 1
    any:
      - id: sec-syscall-enter
      - id: sec-syscall-exit
      - id: sec-xdp
      - id: sec-uprobe
      - id: xdp-md-struct
      - id: cilium-ebpf
      - id: libbpfgo
      - id: datadog-ebpf

  # XDP backdoor composite (migrated from YARA)
  - id: xdp-backdoor
    desc: XDP-based network backdoor or packet
    crit: suspicious
    conf: 0.95
    attack: "T1205"
    for: [c, elf]
    all:
      - id: xdp-section-marker
      - id: xdp-packet-inspection
      - id: offensive-intent

  # XDP section marker helper
  - id: xdp-section-marker
    desc: XDP section markers
    crit: notable
    conf: 0.8
    for: [c, elf]
    count_min: 1
    any:
      - id: sec-xdp
      - id: xdp-md-struct

  # Go eBPF loader (migrated from YARA)
  - id: go-loader
    desc: Go-based eBPF program loader using
    crit: notable
    conf: 0.9
    for: [go]
    count_min: 1
    any:
      - id: cilium-ebpf
      - id: libbpfgo
      - id: datadog-ebpf
      - id: ebpf-new-collection
      - id: ebpf-new-program
      - id: load-pinned-program

  # Go offensive sections helper
  - id: go-ebpf-sections
    desc: Go eBPF offensive section references
    crit: notable
    conf: 0.8
    for: [go]
    count_min: 1
    any:
      - id: sec-syscall-enter
      - id: sec-syscall-exit
      - id: sec-xdp
      - id: sec-uprobe

  # Go offensive intent helper
  - id: go-offensive-intent
    desc: Go eBPF offensive intent markers
    crit: notable
    conf: 0.7
    for: [go]
    count_min: 1
    any:
      - id: rootkit-string
      - id: hide-string
      - id: bypass-string
      # NOTE: patch-string removed - too generic, causes FPs on legitimate tools

  # Go offensive program (migrated from YARA)
  - id: go-offensive-program
    desc: Go loader referencing offensive eBPF
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [go]
    all:
      - id: go-ebpf-sections
      - id: go-offensive-intent


  # Sensitive file helper
  - id: sensitive-file-ref
    desc: Sensitive system file references
    crit: notable
    conf: 0.7
    count_min: 1
    any:
      - id: sudoers-ref
      - id: shadow-ref
      - id: passwd-ref

  # Sudoers manipulation (migrated from YARA)
  - id: sudoers-manipulation
    desc: eBPF-based runtime manipulation of sudoers
    crit: suspicious
    conf: 1.0
    attack: "T1068"
    for: [c, elf]
    all:
      - id: sensitive-file-ref
      - id: bpf-probe-write-user

  # Dirent hiding (migrated from YARA)
  - id: dirent-hiding
    desc: eBPF-based file/directory hiding via getdents
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c, elf]
    all:
      - id: getdents64-tracepoint
      - id: d-reclen
      - id: bpf-probe-write-user

  # Uprobe hooking (migrated from YARA)
  - id: uprobe-hooking
    desc: eBPF program hooking user-space functions
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c, elf]
    all:
      - id: sec-uprobe
      - id: uprobe-target

  # Uprobe target helper
  - id: uprobe-target
    desc: Uprobe credential targets
    crit: notable
    conf: 0.7
    for: [c, elf]
    count_min: 1
    any:
      - id: crypt-verify
      - id: password-string

  # HTTP manipulation helper
  - id: http-manipulation-action
    desc: HTTP manipulation actions
    crit: suspicious
    conf: 0.8
    for: [c, elf]
    count_min: 1
    any:
      - id: http-routes
      - id: http-edit
      - id: http-drop

  # HTTP manipulation (migrated from YARA)
  - id: http-manipulation
    desc: eBPF program performing HTTP traffic
    crit: suspicious
    conf: 0.95
    attack: "T1557"
    for: [c, elf]
    all:
      - id: sec-xdp
      - id: http-string
      - id: http-manipulation-action

  # High-Confidence eBPF Rootkit
  - id: advanced-rootkit
    desc: "Advanced eBPF rootkit detected"
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c, elf, go]
    count_min: 2
    any:
      - id: syscall-hooking
      - id: xdp-backdoor
      - id: bpf-probe-write-user
      - id: sudoers-manipulation
      - id: dirent-hiding
      - id: uprobe-hooking
      - id: http-manipulation
      - id: go-offensive-program
