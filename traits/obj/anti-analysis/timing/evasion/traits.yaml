# Anti-Analysis - Timing Primitives
# MBC: B0001.032 (Timing/Delay Check)
# ATT&CK: T1497.001 (Virtualization/Sandbox Evasion: System Checks)

defaults:
  for: [elf, macho, pe, dll]
  mbc: "B0001.032"
  attack: "T1497.001"

traits:
  - id: rdtsc
    desc: RDTSC instruction (hardware timestamp)
    crit: inert
    conf: 0.5
    if:
      type: hex
      pattern: "0F 31"

  - id: sys-clock-gettime
    desc: clock_gettime function (syscall)
    crit: inert
    conf: 0.4
    if:
      type: string
      word: "clock_gettime"

  - id: sys-gettimeofday
    desc: gettimeofday function (syscall)
    crit: inert
    conf: 0.4
    if:
      type: string
      word: "gettimeofday"

  # NOTE: "time" is far too generic - matches Go runtime, standard library, etc.
  # Changed to more specific pattern
  - id: time-func
    desc: time function
    crit: inert
    conf: 0.2
    if:
      type: string
      regex: '\btime\(\)'

composite_rules:
  # NOTE: Go runtime uses RDTSC and time functions legitimately for scheduling
  # and performance. Downgraded to inert to avoid false positives.
  - id: primitive
    desc: "Hardware timing primitive (potential anti-analysis)"
    crit: inert
    conf: 0.4
    all:
      - id: rdtsc
    any:
      - id: sys-clock-gettime
      - id: sys-gettimeofday
      - id: time-func
