# Timing and Delay Tactics Detection
# Detects sleep/delay functions used for evasion or rate limiting
# ATT&CK: T1497.003 (Virtualization/Sandbox Evasion: Time Based Evasion)

defaults:
  attack: "T1497.003"
  mbc: "B0003.005"
  crit: notable

traits:
  # sleep/usleep/nanosleep: use cap/os/time/query::sleep-func etc. (canonical)
  # clock_gettime/gettimeofday: use cap/os/time/query (canonical)

composite_rules:
  - id: delay-capability
    desc: "Program can delay execution (sleep/timing)"
    crit: notable
    conf: 0.5
    any:
      - id: cap/os/time/query::sleep-func
      - id: cap/os/time/query::usleep-func
      - id: cap/os/time/query::nanosleep-func

  # Timing measurement
  # NOTE: clock_gettime and gettimeofday are extremely common in legitimate software
  # including graphics/video libraries (frame timing), database systems (query timing),
  # profilers, async I/O libraries (event scheduling), and any application that
  # measures performance.
  - id: timing-measurement
    desc: "Measures execution time (timing attacks"
    crit: notable
    conf: 0.4
    attack: "T1497.003"
    any:
      - id: cap/os/time/query::clock_gettime
      - id: cap/os/time/query::gettimeofday
    downgrade:
      any:
        - id: cap/dylib/load/video-lib-marker
        - id: cap/dylib/library::graphics-lib-marker
        - id: cap/dylib/library::system-lib-marker
        - id: cap/dylib/load/async-io-lib-marker

  # Delay with network = evasion or C2 beaconing
  # NOTE: nanosleep + socket is extremely common in any network program.
  # This pattern alone is NOT suspicious - nearly all network tools use this.
  - id: delay-with-network
    desc: "Network communication with delays (C2"
    crit: notable
    conf: 0.5
    attack: "T1497.003"
    all:
      - id: delay-capability
    any:
      - id: cap/comm/socket/create
      - id: cap/comm/download/curl::libcurl-http

  # Timing measurement + delay = sandbox evasion
  # NOTE: clock_gettime + nanosleep is extremely common in legitimate software.
  # This pattern alone is NOT suspicious - nearly all async I/O uses this.
  # Only suspicious when combined with actual anti-analysis indicators.
  - id: timing-evasion
    desc: "Timing measurement with delays (sandbox/VM"
    crit: notable
    conf: 0.5
    attack: "T1497.003"
    mbc: "B0003.005"
    all:
      - id: timing-measurement
      - id: delay-capability
