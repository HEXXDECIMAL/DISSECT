# Advanced Stack Introspection
# Detects sophisticated anti-debugging via stack/exception manipulation
# Indicator of APT and advanced malware

traits:
  - id: rtl-capture-context
    desc: Stack context capture (RtlCaptureContext)
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlCaptureContext"
    attack: "T1062"
    mbc: "B0032"

  - id: rtl-lookup-entry
    desc: Stack entry lookup (RtlLookupFunctionEntry)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlLookupFunctionEntry"
    attack: "T1062"
    mbc: "B0032"

  - id: rtl-virtual-unwind
    desc: Stack unwinding (RtlVirtualUnwind)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlVirtualUnwind"
    attack: "T1062"
    mbc: "B0032"

  - id: rtl-add-function-table
    desc: Function table manipulation (RtlAddFunctionTable)
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlAddFunctionTable"
    attack: "T1062"
    mbc: "B0032"

composite_rules:
  - id: stack-introspection-suite
    desc: Advanced stack introspection capability
    crit: notable
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1062"
    mbc: "B0032"
    needs: 2
    any:
      - id: rtl-capture-context
      - id: rtl-lookup-entry
      - id: rtl-virtual-unwind
      - id: rtl-add-function-table

  - id: advanced-debugging-evasion
    desc: Advanced stack-based debugging evasion
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1062"
    mbc: "B0032"
    all:
      - id: stack-introspection-suite
      - id: obj/anti-analysis/evasion/suite/

