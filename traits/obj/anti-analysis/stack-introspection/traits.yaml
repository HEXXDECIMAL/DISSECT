# Advanced Stack Introspection
# Detects sophisticated anti-debugging via stack/exception manipulation
# Indicator of APT and advanced malware

traits:
  - id: rtl-capture-context
    desc: Stack context capture (RtlCaptureContext)
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlCaptureContext"
    notes: "Captures CPU context for advanced stack manipulation"
    attack: "T1062"
    mbc: "B0032"

  - id: rtl-lookup-entry
    desc: Stack entry lookup (RtlLookupFunctionEntry)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlLookupFunctionEntry"
    notes: "Retrieves function entry info from stack tables"
    attack: "T1062"
    mbc: "B0032"

  - id: rtl-virtual-unwind
    desc: Stack unwinding (RtlVirtualUnwind)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlVirtualUnwind"
    notes: "Performs manual stack unwinding for introspection"
    attack: "T1062"
    mbc: "B0032"

  - id: rtl-add-function-table
    desc: Function table manipulation (RtlAddFunctionTable)
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "RtlAddFunctionTable"
    notes: "Modifies exception handling function tables"
    attack: "T1062"
    mbc: "B0032"

composite_rules:
  - id: stack-introspection-suite
    desc: Advanced stack introspection capability
    crit: notable
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1062"
    mbc: "B0032"
    notes: |
      Detects sophisticated stack/exception manipulation for anti-debugging.

      Techniques:
      - Stack frame inspection (RtlCaptureContext)
      - Function entry enumeration (RtlLookupFunctionEntry)
      - Manual stack unwinding (RtlVirtualUnwind)
      - Exception handler manipulation (RtlAddFunctionTable)

      Indicates advanced anti-debugging/anti-analysis:
      - Detects debuggers by inspecting stack
      - Detects exception handlers
      - Detects function preambles

      Seen in:
      - APT malware (Carbanak, Fin7, APT33)
      - Sophisticated banking trojans (Trickbot variants)
      - Loader malware (Chrysalis family)

    count_min: 2
    any:
      - id: rtl-capture-context
      - id: rtl-lookup-entry
      - id: rtl-virtual-unwind
      - id: rtl-add-function-table

  - id: advanced-debugging-evasion
    desc: Advanced stack-based debugging evasion
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1062"
    mbc: "B0032"
    notes: |
      Combines stack introspection with anti-analysis checks.
      Indicates highly sophisticated malware.

    all:
      - id: stack-introspection-suite
      - id: obj/anti-analysis/evasion-suite/evasion-aware-malware

