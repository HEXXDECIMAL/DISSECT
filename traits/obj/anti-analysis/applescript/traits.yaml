# AppleScript Evasion and Social Engineering Detection
# Detects malicious AppleScript techniques used by macOS malware
# ATT&CK: T1059.002 (AppleScript), T1564.003 (Hidden Window)
# MBC: E1564 (Hide Artifacts)
# Note: These traits apply to any file type that can invoke osascript

defaults:
  attack: "T1059.002"
  platforms: [macos]
  # Include all file types that can invoke osascript
  for: [shell, applescript, python, elf, macho, ruby, perl, javascript]

traits:
  # Window hiding via AppleScript
  - id: hide-window
    desc: "AppleScript Terminal window hiding"
    crit: suspicious
    conf: 0.9
    mbc: "E1564.003"
    attack: "T1564.003"
    if:
      type: string
      regex: "set visible of (the )?front window to false|set visible to false"

  # Hide all windows of application
  - id: hide-application
    desc: "AppleScript application hiding"
    crit: suspicious
    conf: 0.85
    attack: "T1564.003"
    if:
      type: string
      regex: "tell application.{0,30}to set visible.{0,10}false|set visible of.{0,30}application"

  # osascript execution (inline AppleScript)
  - id: osascript-exec
    desc: "osascript command execution"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "osascript\\s+-e\\s+['\"]"

  # do shell script execution
  - id: do-shell-script
    desc: "AppleScript shell command execution"
    crit: suspicious
    conf: 0.85
    attack: "T1059.004"
    if:
      type: string
      substr: "do shell script"

  # === Password dialog atomic indicators ===
  - id: dialog-password
    desc: display dialog with password
    crit: inert
    conf: 0.7
    attack: "T1056.002"
    if:
      type: string
      regex: "display dialog.{0,50}password"

  - id: default-answer-password
    desc: default answer password prompt
    crit: inert
    conf: 0.7
    attack: "T1056.002"
    if:
      type: string
      regex: "default answer.{0,30}password"

  - id: with-hidden-answer
    desc: with hidden answer directive
    crit: inert
    conf: 0.7
    attack: "T1056.002"
    if:
      type: string
      substr: "with hidden answer"

  # === Fake system dialog atomic indicators ===
  - id: icon-caution-button
    desc: icon caution with button
    crit: inert
    conf: 0.6
    attack: "T1056.002"
    if:
      type: string
      regex: "with icon caution.{0,30}button"

  - id: icon-stop-button
    desc: icon stop with button
    crit: inert
    conf: 0.6
    attack: "T1056.002"
    if:
      type: string
      regex: "with icon stop.{0,30}button"

  - id: icon-note-button
    desc: icon note with button
    crit: inert
    conf: 0.6
    attack: "T1056.002"
    if:
      type: string
      regex: "with icon note.{0,30}button"

  - id: dialog-enter-password
    desc: display dialog enter password
    crit: inert
    conf: 0.7
    attack: "T1056.002"
    if:
      type: string
      regex: "display dialog.{0,30}enter.{0,20}password"

  # Administrator privileges via do shell script
  - id: admin-privileges
    desc: "AppleScript privilege escalation"
    crit: suspicious
    conf: 0.9
    attack: "T1548.004"
    if:
      type: string
      regex: "with administrator privileges|administrator privileges"

  # === Keystroke logging atomic indicators ===
  - id: keystroke-cmd
    desc: keystroke command
    crit: inert
    conf: 0.6
    attack: "T1056.001"
    if:
      type: string
      substr: "keystroke"

  - id: key-code-cmd
    desc: key code command
    crit: inert
    conf: 0.6
    attack: "T1056.001"
    if:
      type: string
      substr: "key code"

  - id: system-events-key
    desc: System Events key manipulation
    crit: inert
    conf: 0.7
    attack: "T1056.001"
    if:
      type: string
      regex: "tell application.{0,30}System Events.{0,30}key"

  # tell application pattern (AppleScript automation)
  - id: tell-application
    desc: "AppleScript tell application block"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "tell application|osascript"

  # Hidden answer input (password masking)
  - id: hidden-answer
    desc: "AppleScript hidden input field"
    crit: suspicious
    conf: 0.85
    attack: "T1056.002"
    if:
      type: string
      regex: "default answer|with hidden answer"

composite_rules:
  # Password dialog composite
  - id: password-dialog
    desc: "AppleScript password input dialog"
    crit: suspicious
    conf: 0.95
    attack: "T1056.002"
    mbc: "E1056.002"
    needs: 1
    any:
      - id: dialog-password
      - id: default-answer-password
      - id: with-hidden-answer

  # Fake system dialog composite
  - id: fake-system-dialog
    desc: "AppleScript fake system prompt"
    crit: suspicious
    conf: 0.9
    attack: "T1056.002"
    needs: 1
    any:
      - id: icon-caution-button
      - id: icon-stop-button
      - id: icon-note-button
      - id: dialog-enter-password

  # Keystroke logging composite
  - id: keystroke-logging
    desc: "AppleScript keystroke monitoring"
    crit: suspicious
    conf: 0.9
    attack: "T1056.001"
    needs: 1
    any:
      - id: keystroke-cmd
      - id: key-code-cmd
      - id: system-events-key

  # Password phishing pattern
  - id: password-phishing
    desc: "AppleScript password phishing attack"
    crit: suspicious
    conf: 0.95
    attack: "T1056.002"
    for: [shell, applescript]
    all:
      - id: tell-application
      - id: password-dialog
    any:
      - id: hidden-answer
      - id: fake-system-dialog

  # Stealthy AppleScript execution
  - id: stealthy-execution
    desc: "Hidden AppleScript execution"
    crit: hostile
    conf: 0.9
    attack: "T1564.003"
    for: [shell, applescript]
    all:
      - id: hide-window
      - id: do-shell-script
      - id: tell-application
