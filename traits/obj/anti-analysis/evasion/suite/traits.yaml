# Evasion Awareness Suite
# Detects malware with multiple anti-analysis checks
# Generic indicator of sophisticated malware

traits:
  - id: timing-check-api
    desc: Timing API sandbox detection
    crit: notable
    conf: 0.8
    platforms: [all]
    for: [pe, elf, macho]
    if:
      type: symbol
      any:
        - exact: "QueryPerformanceCounter"
        - exact: "gettimeofday"
        - exact: "clock_gettime"
    mbc: "C0025"

  - id: cpu-feature-check
    desc: CPU feature detection for evasion
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "IsProcessorFeaturePresent"
    mbc: "B0009"

composite_rules:
  - id: evasion-aware-malware
    desc: Malware with multiple anti-analysis awareness checks
    crit: suspicious
    conf: 0.85
    attack: "T1497"
    mbc: "B0001"
    platforms: [all]
    for: [pe, elf, macho]
    all:
      - id: obj/anti-analysis/debugger/detect::win-comprehensive
    any:
      - id: timing-check-api
      - id: cpu-feature-check
      - id: obj/anti-analysis/emulator/detect::comprehensive
    downgrade:
      any:
        - id: meta/quality/versioned

  - id: anti-forensics-defensive
    desc: Malware with both anti-analysis AND anti-forensics capabilities
    crit: hostile
    conf: 0.9
    attack: "T1562"
    mbc: "B0005"
    platforms: [all]
    for: [pe, elf, macho]
    all:
      - id: evasion-aware-malware
    any:
      - id: obj/anti-forensics/log-clear
      - id: obj/anti-forensics/self-delete
