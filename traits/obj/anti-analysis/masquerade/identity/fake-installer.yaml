# Fake Installer Detection
# Detects malware masquerading as legitimate installers (e.g. Homebrew)
# ATT&CK: T1036.005 (Masquerading: Match Legitimate Name or Location)
# MBC: F0004 (Masquerading)

defaults:
  for: [shell]

traits:
  # === Legitimate Context (Homebrew) ===
  - id: homebrew-prefix
    desc: "Homebrew prefix variable"
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "HOMEBREW_PREFIX"

  - id: brew-no-install
    desc: "Homebrew no-install marker"
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "brew.no_install"

  - id: homebrew-repo
    desc: "Homebrew repository URL"
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "github.com/Homebrew/brew"

  # === Suspicious Behaviors ===
  - id: dscl-authonly-loop
    desc: "macOS dscl phishing loop"
    crit: suspicious
    conf: 0.95
    attack: "T1056.002"
    if:
      type: raw
      regex: "dscl . authonly.{0,50}while"

  - id: sudo-refresh-stdin
    desc: "Refreshes sudo via stdin"
    crit: suspicious
    conf: 0.9
    attack: "T1548.002"
    if:
      type: raw
      substr: "sudo -v -S"

  - id: homabrews-domain
    desc: "Fake Homebrew typosquatting domain"
    crit: suspicious
    conf: 1.0
    attack: "T1036.005"
    if:
      type: string
      substr: "homabrews.org"

  - id: base64-password
    desc: "Base64 encodes password variable"
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "echo.{0,50}password.{0,50}base64"

  - id: fake-macos-installer-msg
    desc: "Fake macOS Installer message"
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "macOS-Installer:.{0,100}apple\\.com"

composite_rules:
  # Helper: Legitimate Homebrew context markers
  - id: homebrew-context
    desc: "Homebrew context markers"
    crit: notable
    conf: 0.6
    needs: 2
    any:
      - id: homebrew-prefix
      - id: brew-no-install
      - id: homebrew-repo

  # Helper: Suspicious installer behaviors
  - id: fake-installer-behaviors
    desc: "Suspicious installer behaviors"
    crit: suspicious
    conf: 0.9
    any:
      - id: dscl-authonly-loop
      - id: homabrews-domain
      - id: sudo-refresh-stdin
      - id: base64-password
      - id: fake-macos-installer-msg

  # Main detection rule
  - id: fake-homebrew-installer
    desc: "Homebrew installer masquerade"
    crit: hostile
    conf: 0.98
    attack: "T1036.005"
    mbc: "F0004"
    platforms: [macos, linux]
    all:
      - id: homebrew-context
      - id: fake-installer-behaviors

  # Fake macOS installer with execution
  - id: fake-macos-installer-exec
    desc: "Fake macOS installer with hidden execution"
    crit: hostile
    conf: 1.0
    attack: "T1036.005"
    all:
      - id: fake-macos-installer-msg
      - id: cap/exec/shell/methods::base64-decode-exec
