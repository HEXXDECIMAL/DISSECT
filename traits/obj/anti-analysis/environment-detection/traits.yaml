# Environment Detection & Probing
# Detects malware checking system environment
# Generic indicator for evasion-aware malware

traits:
  - id: getenv-api
    desc: Environment variable access
    crit: inert
    conf: 0.5
    platforms: [windows, linux, macos]
    for: [pe, elf, macho]
    if:
      type: symbol
      any:
        - exact: "GetEnvironmentStringsW"
        - exact: "GetEnvironmentStringsA"
        - exact: "FreeEnvironmentStringsW"
        - exact: "GetEnvironmentVariable"
    notes: "Accesses system environment variables"

  - id: console-check-api
    desc: Console environment check
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      any:
        - exact: "GetConsoleMode"
        - exact: "GetConsoleOutputCP"
        - exact: "GetConsoleScreenBufferInfo"
    notes: "Checks for console environment (sandbox detection)"
    attack: "T1497"
    mbc: "B0001"

  - id: write-console-api
    desc: Console output capability
    crit: inert
    conf: 0.5
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "WriteConsoleW"
    notes: "Writes to console (may indicate output logging)"

composite_rules:
  - id: console-environment-detection
    desc: Console environment detection checks
    crit: suspicious
    conf: 0.75
    platforms: [windows]
    for: [pe]
    attack: "T1497.001"
    mbc: "B0001"
    notes: |
      Checks for console environment indicators.

      Sandbox detection via:
      - Console not available (detected via GetConsoleMode failure)
      - Console output properties (GetConsoleOutputCP)
      - Console buffer info (GetConsoleScreenBufferInfo)

      Analysis environment often missing console or has unusual properties.

      Seen in:
      - Advanced loaders (Chrysalis ConsoleApplication2.exe)
      - Sandbox-aware malware
      - Environment-adaptive trojans

    count_min: 2
    any:
      - id: console-check-api
      - id: write-console-api

  - id: environment-aware-malware
    desc: Environment-aware malware adaptation
    crit: suspicious
    conf: 0.8
    platforms: [all]
    for: [pe, elf, macho]
    attack: "T1497"
    mbc: "B0001"
    notes: |
      Combines environment probing with evasion awareness.
      Indicates behavior modification based on environment.

    any:
      - id: getenv-api
      - id: console-environment-detection

  - id: environment-adaptive-behavior
    desc: Adaptive behavior based on environment
    crit: suspicious
    conf: 0.85
    platforms: [all]
    for: [pe, elf, macho]
    attack: "T1497"
    mbc: "B0001"
    notes: |
      Environment checks combined with control flow changes.
      Indicates actual behavior adaptation.

    all:
      - id: environment-aware-malware
      - id: cap/data/control-flow

