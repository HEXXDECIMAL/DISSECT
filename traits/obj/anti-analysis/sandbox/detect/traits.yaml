# Sandbox Detection
# MBC: OB0001 (Anti-Behavioral Analysis) â†’ B0007 (Sandbox Detection)
# ATT&CK: T1497.001 (Virtualization/Sandbox Evasion: System Checks)

traits:
  # === Sandbox hostname atomic indicators ===
  - id: hostname-19olltd
    desc: DESKTOP-19OLLTD sandbox hostname
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    if:
      type: string
      substr: "DESKTOP-19OLLTD"

  - id: hostname-b0t93d6
    desc: DESKTOP-B0T93D6 sandbox hostname
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    if:
      type: string
      substr: "DESKTOP-B0T93D6"

  - id: hostname-vrsqlag
    desc: DESKTOP-VRSQLAG sandbox hostname
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    if:
      type: string
      substr: "DESKTOP-VRSQLAG"

  - id: hostname-john-pc
    desc: JOHN-PC sandbox hostname
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    if:
      type: string
      substr: "JOHN-PC"

  - id: hostname-julia-pc
    desc: JULIA-PC sandbox hostname
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    if:
      type: string
      substr: "JULIA-PC"

  - id: hostname-lisa-pc
    desc: LISA-PC sandbox hostname
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    if:
      type: string
      substr: "LISA-PC"

  - id: username-sandbox
    desc: Common sandbox usernames
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.8
    if:
      type: string
      # Use word boundaries and require username-like context
      # Excludes legitimate uses like "entering sandbox" or "sandbox.sb" profiles
      regex: "\\b(user|USER|username|USERNAME|User|Username)\\s*[=:]\\s*(malware|sandbox|virus|sample|test|admin)\\b"
      case_insensitive: true

  - id: sleep-accel
    desc: Sleep acceleration detection (sandbox evasion)
    crit: inert
    mbc: "B0007"
    attack: "T1497.003"
    conf: 0.5
    for: [elf, macho, so, dylib, pe, dll, c]
    if:
      type: symbol
      # Use exact match to avoid matching Go runtime functions like runtime.notesleep
      regex: "^_?(sleep|Sleep|usleep|nanosleep)$"

  # === Sandbox artifact file path atomic indicators ===
  - id: path-c-analysis
    desc: C:\analysis sandbox path
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.6
    if:
      type: string
      substr: "C:\\analysis"

  - id: path-c-sandbox
    desc: C:\sandbox sandbox path
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.6
    if:
      type: string
      substr: "C:\\sandbox"

  - id: path-tmp-analysis
    desc: /tmp/analysis sandbox path
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.6
    if:
      type: string
      substr: "/tmp/analysis"

composite_rules:
  # Sandbox hostname composite
  - id: hostname-sandbox
    desc: Common sandbox hostnames
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.8
    needs: 1
    any:
      - id: hostname-19olltd
      - id: hostname-b0t93d6
      - id: hostname-vrsqlag
      - id: hostname-john-pc
      - id: hostname-julia-pc
      - id: hostname-lisa-pc

  # Sandbox file path composite
  - id: file-check-sandbox
    desc: Sandbox artifact file checks
    crit: suspicious
    mbc: "B0007"
    attack: "T1497.001"
    conf: 0.7
    needs: 1
    any:
      - id: path-c-analysis
      - id: path-c-sandbox
      - id: path-tmp-analysis
