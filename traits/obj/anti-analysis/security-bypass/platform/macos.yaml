# macOS Security Bypass Detection
# ATT&CK: T1553.001 (Subvert Trust Controls: Gatekeeper Bypass)

defaults:
  attack: "T1553.001"
  # Note: xattr is macOS-specific but platform detection doesn't work on scripts
  # The xattr command itself indicates macOS targeting

traits:
  # === Gatekeeper/quarantine bypass patterns ===
  - id: xattr-clear-before-exec
    desc: xattr -c followed by chmod/execute
    crit: suspicious
    conf: 0.9
    for: [shell]
    if:
      type: raw
      regex: 'xattr\s+-c\s+[^&\n]{1,120}&&[^&\n]{0,120}(chmod|\.\/)'

  - id: curl-xattr-chmod-chain
    desc: curl+xattr+chmod execution chain
    crit: suspicious
    conf: 0.95
    for: [shell]
    if:
      type: raw
      regex: 'curl[^&]{0,120}&&[^&]{0,120}xattr[^&]{0,120}&&[^&]{0,120}chmod[^&]{0,120}&&[^&]{0,120}\./'

  # === Trust/Certificate manipulation ===
  - id: macos-add-trusted-cert
    desc: Installs a trusted root certificate on macOS
    crit: suspicious
    conf: 0.95
    attack: "T1553.004"
    if:
      type: string
      regex: "security\\s+add-trusted-cert"

  # === Proxy manipulation ===
  - id: macos-set-web-proxy
    desc: Configures a web proxy on macOS
    crit: suspicious
    conf: 0.9
    attack: "T1090"
    if:
      type: string
      regex: "networksetup\\s+-set(secure)?webproxy"

composite_rules:
  # Gatekeeper bypass: xattr clear + execution
  # Complexity: all(2) + file_types(1) = 3 -> suspicious
  - id: gatekeeper-bypass
    desc: macOS Gatekeeper bypass via xattr
    crit: suspicious
    conf: 0.9
    for: [shell]
    all:
      - id: cap/fs/attributes/xattr::xattr-clear
      - id: obj/exec/dropper/script::chmod-plus-x-cmd

  # Full dropper chain: download + quarantine bypass + execute
  # Complexity: all(4) = 4 -> hostile
  - id: dropper-gatekeeper-bypass
    desc: Download and execute with Gatekeeper bypass
    crit: hostile
    conf: 0.95
    for: [shell]
    all:
      - id: obj/exec/dropper/script::curl-download
      - id: cap/fs/attributes/xattr::xattr-clear
      - id: obj/exec/dropper/script::chmod-plus-x-cmd
      - id: obj/exec/dropper/script::execute-dot-slash
