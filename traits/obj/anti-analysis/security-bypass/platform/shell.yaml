# Security Monitoring Agent Bypass Detection
# Detects attempts to disable security monitoring and detection agents
# ATT&CK: T1562.001 (Impair Defenses: Disable or Modify Tools)
#
# NOTE: MAC controls (SELinux/AppArmor) moved to obj/impact/degrade/mac/
# NOTE: Firewall controls moved to obj/impact/degrade/firewall/
# This file focuses on disabling monitoring/detection agents (true anti-analysis)

defaults:
  crit: suspicious
  attack: "T1562.001"
  for: [shell]

traits:

  # === Cloud Security Agent Removal ===
  - id: aliyun-agent-disable
    desc: Aliyun security agent disable
    conf: 0.95
    if:
      type: content
      regex: "(?:pkill|kill)[^;]{0,20}aliyun|aegis[^;]{0,20}uninstall|systemctl\\s+(?:stop|disable)\\s+aliyun"

  - id: cloud-agent-uninstall
    desc: Cloud security agent uninstall
    conf: 0.90
    if:
      type: content
      # Detects uninstall scripts for cloud agents
      regex: "(?:qcloud|aegis|YunJing)[^;]{0,30}uninstall|update\\.aegis\\.aliyun\\.com/download/uninstall"

  # === Watchdog/NMI Disable ===
  - id: nmi-watchdog-disable
    desc: NMI watchdog disable (crash detection)
    conf: 0.85
    if:
      type: content
      regex: "nmi_watchdog\\s*=\\s*0|echo\\s+['\"]?0['\"]?[^>]{0,20}>[^\\n]{0,50}nmi_watchdog"

composite_rules:
  # Multiple monitoring agents disabled
  - id: multi-agent-disable
    desc: Multiple monitoring agents disabled
    crit: hostile
    conf: 0.95
    attack: "T1562.001"
    needs: 2
    any:
      - id: aliyun-agent-disable
      - id: cloud-agent-uninstall
      - id: nmi-watchdog-disable
