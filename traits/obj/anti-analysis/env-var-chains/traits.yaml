# Environment Variable Manipulation Chains
# Detects evasion techniques using environment variable manipulation
# Generic indicator for advanced malware behavior

traits:
  - id: path-prepend-tmp
    desc: PATH variable prepended with /tmp
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "PATH=/tmp"
        - substr: "export PATH=/tmp"
        - regex: "export\\s+PATH=/tmp"
    attack: "T1547.001"

  - id: ld-library-path-manipulation
    desc: LD_LIBRARY_PATH environment variable set
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "LD_LIBRARY_PATH="
        - substr: "export LD_LIBRARY_PATH"
        - regex: "export\\s+LD_LIBRARY_PATH"
    attack: "T1574.006"

  - id: histfile-dev-null
    desc: HISTFILE disabled via /dev/null
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "HISTFILE=/dev/null"
        - substr: "export HISTFILE=/dev/null"
        - regex: "export\\s+HISTFILE=/dev/null"
    attack: "T1562.003"

  - id: histsize-zero
    desc: HISTSIZE zero for history evasion
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "HISTSIZE=0"
        - substr: "export HISTSIZE=0"
        - regex: "export\\s+HISTSIZE=0"
    attack: "T1562.003"

  - id: histcontrol-ignorealltps
    desc: HISTCONTROL ignoring all history
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "HISTCONTROL=ignorealltps"
        - substr: "export HISTCONTROL=ignorealltps"
    attack: "T1562.003"

  - id: prompt-command-clear
    desc: PROMPT_COMMAND clearing history
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "PROMPT_COMMAND=\"history -c\""
        - substr: "PROMPT_COMMAND=history -c"
    attack: "T1562.003"

  - id: ld-audit-hook
    desc: LD_AUDIT dynamic linker hook
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "LD_AUDIT="
        - substr: "export LD_AUDIT"
        - regex: "export\\s+LD_AUDIT"
    attack: "T1574.006"

  - id: shell-opts-disable
    desc: Shell options disabled for tracing
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "set +x"
        - substr: "set -x"
        - regex: "set\\s+[+-]x"
    attack: "T1562.004"

  - id: ld-preload-injection
    desc: LD_PRELOAD library injection setup
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "LD_PRELOAD="
        - substr: "export LD_PRELOAD"
        - regex: "export\\s+LD_PRELOAD"
    attack: "T1574.006"

composite_rules:
  - id: history-evasion-setup
    desc: Shell history evasion chain
    crit: suspicious
    conf: 0.90
    for: [elf, shell]
    attack: "T1562.003"
    count_min: 2
    any:
      - id: histfile-dev-null
      - id: histsize-zero
      - id: histcontrol-ignorealltps
      - id: prompt-command-clear

  - id: dynamic-linker-manipulation
    desc: Dynamic linker environment setup
    crit: suspicious
    conf: 0.88
    for: [elf, shell]
    attack: "T1574.006"
    count_min: 2
    any:
      - id: ld-library-path-manipulation
      - id: ld-audit-hook
      - id: ld-preload-injection

  - id: env-variable-evasion-chain
    desc: Multiple evasion environment variables
    crit: hostile
    conf: 0.92
    for: [elf, shell]
    attack: "T1562.003"
    mbc: "E1014"
    notes: |
      Comprehensive environment variable evasion setup.
      Combines:
      - History evasion (HISTFILE, HISTSIZE)
      - Path manipulation for trojanized tools
      - Dynamic linker hijacking preparation
      - Shell tracing disablement

      This indicates:
      - Advanced evasion technique implementation
      - Preparation for privilege escalation
      - Code injection and hijacking setup
      - Post-exploitation cover-up tactics
    all:
      - id: history-evasion-setup
      - id: path-prepend-tmp
      - id: dynamic-linker-manipulation
