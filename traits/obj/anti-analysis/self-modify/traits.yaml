# Self-Modification Patterns
# These patterns indicate code that modifies itself at runtime
# Can be legitimate (JIT, hot-patching) or malicious (polymorphic malware)

defaults:
  for: [pe, elf, macho, dll, so, dylib]

traits:
  # === Memory protection (atomic) ===
  - id: mprotect-unix
    desc: Unix mprotect system call
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: '\bmprotect\b'

  - id: virtualprotect-win
    desc: Windows VirtualProtect API
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: VirtualProtect

  - id: virtualprotectex-win
    desc: Windows VirtualProtectEx API
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: VirtualProtectEx

  - id: prot-write
    desc: PROT_WRITE memory protection constant
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: '\bPROT_WRITE\b'

  - id: prot-exec
    desc: PROT_EXEC memory protection constant
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: '\bPROT_EXEC\b'

  - id: page-rwx
    desc: PAGE_EXECUTE_READWRITE constant
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: PAGE_EXECUTE_READWRITE

  # === Self-overwriting (atomic) ===
  - id: proc-self-mem
    desc: /proc/self/mem access for self-modification
    crit: suspicious
    conf: 0.85
    if:
      type: string
      exact: /proc/self/mem

  - id: proc-self-maps
    desc: /proc/self/maps memory map access
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: /proc/self/maps

  - id: writeprocessmemory
    desc: Windows WriteProcessMemory API
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: WriteProcessMemory

  - id: self-patch-ref
    desc: Self-patch terminology
    crit: suspicious
    conf: 0.85
    if:
      type: string
      exact: "self-patch"
      case_insensitive: true

  # === Code cave (atomic) ===
  - id: codecave-ref
    desc: Code cave terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: '\bcodecave\b|code cave'
      case_insensitive: true

  - id: slack-space-ref
    desc: Slack space terminology
    crit: suspicious
    conf: 0.75
    if:
      type: string
      exact: "slack space"
      case_insensitive: true

  - id: nop-sled
    desc: Long NOP sled byte sequence
    crit: notable
    conf: 0.7
    if:
      type: hex
      pattern: "90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90"
    unless:
      - id: meta/language/go

  # === Hook installation (atomic) ===
  - id: setwindowshook
    desc: Windows SetWindowsHookEx API
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: SetWindowsHookEx

  - id: inline-hook-ref
    desc: Inline hook terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "inline hook"
      case_insensitive: true

  - id: detour-ref
    desc: Detour/hooking terminology
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: detour
      case_insensitive: true

  # NOTE: Go runtime uses trampolines legitimately for function calls
  - id: trampoline-ref
    desc: Trampoline hook terminology
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: trampoline
      case_insensitive: true

  - id: ld-preload
    desc: LD_PRELOAD library injection
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '\bLD_PRELOAD\b'

  - id: dyld-insert
    desc: macOS DYLD_INSERT_LIBRARIES injection
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: '\bDYLD_INSERT_LIBRARIES\b'

  # === IAT/GOT hooking (atomic) ===
  - id: import-descriptor
    desc: PE IMAGE_IMPORT_DESCRIPTOR structure
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: IMAGE_IMPORT_DESCRIPTOR

  - id: import-address-table
    desc: Import Address Table reference
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: ImportAddressTable

  - id: iat-ref
    desc: IAT abbreviation reference
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: '\bIAT\b'

  - id: got-plt-section
    desc: ELF .got.plt section reference
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: .got.plt

  - id: got-ref
    desc: GOT abbreviation reference
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: '\bGOT\b'

  # === Polymorphic/metamorphic (atomic) ===
  - id: polymorphic-ref
    desc: Polymorphic code terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: polymorphic
      case_insensitive: true

  - id: metamorphic-ref
    desc: Metamorphic code terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: metamorphic
      case_insensitive: true

  - id: self-modifying-ref
    desc: Self-modifying code terminology
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "self-modifying"
      case_insensitive: true

  # NOTE: XOR loop patterns are common in legitimate software (crypto, compression,
  # RNG, games). Only meaningful as an indicator when combined with other self-modify
  # indicators in the polymorphic composite.
  - id: xor-loop-pattern
    desc: XOR decryption loop byte pattern
    crit: inert
    conf: 0.4
    if:
      type: hex
      pattern: "30 ?? 4? 83 ?? ?? 7?"

composite_rules:
  # Memory protection changes
  - id: mprotect
    desc: Memory protection modification (mprotect/VirtualProtect)
    crit: notable
    conf: 0.85
    count_min: 1
    any:
      - id: mprotect-unix
      - id: virtualprotect-win
      - id: virtualprotectex-win
      - id: prot-write
      - id: prot-exec
      - id: page-rwx

  # Self-overwriting code
  - id: self-overwrite
    desc: Self-overwriting code patterns
    crit: suspicious
    conf: 0.8
    count_min: 1
  # Code cave injection
    any:
      - id: proc-self-maps
      - id: proc-self-mem
      - id: writeprocessmemory
      - id: self-patch-ref
  - id: code-cave
    desc: Code cave or slack space
    crit: suspicious
    conf: 0.75
    count_min: 2
    any:
      - id: codecave-ref
      - id: slack-space-ref
      - id: nop-sled

  # Hook installation
  # NOTE: Removed trampoline-ref since Go runtime uses trampolines legitimately
  - id: hook-install
    desc: Dynamic interposition hook patterns
    crit: notable
    conf: 0.7
    count_min: 1
    any:
      - id: setwindowshook
      - id: inline-hook-ref
      - id: detour-ref
      - id: ld-preload
      - id: dyld-insert

  # IAT/GOT hooking - require 2+ indicators to avoid false positives
  # from standard ELF sections like .got.plt
  - id: iat-hook
    desc: Import Address Table hooking
    crit: notable
    conf: 0.7
    count_min: 2
    any:
      - id: import-descriptor
      - id: import-address-table
      - id: iat-ref
      - id: got-plt-section
      - id: got-ref

  # Polymorphic/metamorphic indicators
  # NOTE: Require 2+ indicators to avoid FPs on debuggers, security tools, and
  # academic software that analyze/discuss polymorphic techniques
  - id: polymorphic
    desc: Polymorphic or metamorphic code indicators
    crit: suspicious
    conf: 0.75
    count_min: 2
    any:
      - id: polymorphic-ref
      - id: metamorphic-ref
      - id: self-modifying-ref
      - id: xor-loop-pattern

  # Active self-modification
  - id: active
    desc: Active self-modification behavior
    crit: notable
    conf: 0.9
    all:
      - id: obj/anti-analysis/self-modify/mprotect
    any:
      - id: obj/anti-analysis/self-modify/self-overwrite
      - id: obj/anti-analysis/self-modify/hook-install
