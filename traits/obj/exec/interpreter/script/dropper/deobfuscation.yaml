# Runtime Deobfuscation Composite Rules
# Detects patterns of runtime string deobfuscation

composite_rules:
  - id: multi-layer-deobfuscation
    desc: "Multi-layer runtime string deobfuscation"
    crit: hostile
    conf: 0.9
    for: [javascript, typescript]
    all:
      - id: obj/anti-static/obfuscation/source/string::self-modifying-string-replace
      - id: obj/anti-static/obfuscation/source/string::custom-delimiter-obfuscation
    any:
      - id: obj/anti-static/obfuscation/source/string::base64-function-keyword
      - id: obj/exec/interpreter/script/embedded::powershell-cmdlet-patterns

  - id: obfuscation-with-duplicate-names
    desc: "Code inflation with duplicate function names"
    crit: hostile
    conf: 0.95
    for: [javascript, typescript]
    all:
      - id: obj/anti-static/obfuscation/source/names::duplicate-function-names
    any:
      - id: obj/anti-static/obfuscation/source/string::char-expansion-obfuscation
      - id: obj/anti-static/obfuscation/source/string::cyrillic-junk-padding
      - id: obj/anti-static/obfuscation/source/string::custom-delimiter-obfuscation

  - id: embedded-code-with-deobfuscation
    desc: "High embedded code with runtime deobfuscation"
    crit: hostile
    conf: 0.85
    for: [javascript, typescript, powershell]
    all:
      - id: obj/anti-static/obfuscation/source/metrics::high-embedded-code-ratio
    any:
      - id: obj/anti-static/obfuscation/source/string::self-modifying-string-replace
      - id: obj/anti-static/obfuscation/source/string::chained-replace-calls
      - id: obj/anti-static/obfuscation/source/string::powershell-replace-operator
