# Automatic Dependency Installation - Python pip
# Detects runtime package installation, common in malware droppers
# ATT&CK: T1059.006 (Command and Scripting Interpreter: Python)

defaults:
  for: [python]
  mbc: "B0024"
  attack: "T1059.006"
  crit: suspicious

traits:
  # subprocess pip install - most common pattern
  - id: subprocess-install
    desc: "Runtime pip install via subprocess"
    conf: 0.9
    if:
      type: string
      regex: "subprocess\\.[a-z_]+\\(.{0,220}pip.{0,120}install"

  # sys.executable -m pip pattern
  - id: sys-executable
    desc: "pip install using sys.executable"
    conf: 0.95
    if:
      type: string
      regex: "sys\\.executable.{0,120}-m.{0,120}pip.{0,120}install"

  # os.system pip install
  - id: os-system
    desc: "Runtime pip install via os.system"
    conf: 0.9
    if:
      type: string
      regex: "os\\.system\\(.{0,220}pip.{0,120}install"

  # importlib fallback pattern (try import, except install)
  - id: try-import-install
    desc: "Try-except import with fallback pip"
    conf: 0.85
    if:
      type: string
      # Matches pattern in try/except blocks
      regex: "except[^:]{0,120}:.{0,50}pip.{0,20}install|ImportError.{0,50}pip.{0,20}install"

  # pip.main() direct call
  - id: main-call
    desc: "Direct pip.main() installation"
    conf: 0.9
    if:
      type: string
      regex: "pip\\.main\\(\\[.{0,50}install"

  # pip.main() call via content (catches obfuscated arguments)
  - id: main-call-content
    desc: "Direct pip.main() call in source"
    conf: 0.85
    if:
      type: raw
      regex: "pip\\.main\\("

  # Direct import pip statement (not subprocess-based)
  # Malware imports pip directly to call pip.main() for runtime installs
  - id: import-pip-module
    desc: "Direct pip module import"
    conf: 0.80
    crit: notable
    if:
      type: raw
      substr: "import pip"

  # ensurepip module usage
  - id: ensurepip
    desc: "pip bootstrapping via ensurepip"
    conf: 0.8
    crit: notable
    if:
      type: string
      regex: "ensurepip"

  # === Try/except block atomic indicators ===
  - id: try-colon
    desc: "try: statement"
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "try:"

  - id: except-colon-pattern
    desc: except statement with colon
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "except[^:]{0,120}:"

  - id: import-statement
    desc: import statement
    crit: notable
    conf: 0.4
    if:
      type: string
      regex: "import\\s+\\w+"

  - id: pip-install-pattern
    desc: pip install pattern
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "pip.{0,50}install"

  # === Content-based try/except indicators ===
  # Catches obfuscated samples where string extraction fails
  # but control flow keywords remain in raw source

  - id: except-module-not-found-content
    desc: "except ModuleNotFoundError in source"
    crit: notable
    conf: 0.80
    if:
      type: raw
      substr: "except ModuleNotFoundError"

  - id: except-import-error-content
    desc: "except ImportError in source"
    crit: notable
    conf: 0.70
    if:
      type: raw
      substr: "except ImportError"

composite_rules:
  # Migrated from YARA
  - id: yara-pip-fallback-install
    desc: Try import with pip install
    conf: 0.95
    crit: suspicious
    all:
      - { id: try-colon }
      - { id: except-colon-pattern }
      - { id: import-statement }
      - { id: pip-install-pattern }

  # Content-based: catches obfuscated samples where try/except
  # and import keywords are visible but string literals aren't
  # Complexity: all(+3) = 3 (SUSPICIOUS)
  - id: pip-fallback-install-content
    desc: "Try-import with pip.main() auto-install"
    conf: 0.90
    crit: suspicious
    all:
      - id: import-pip-module
      - id: main-call-content
    any:
      - id: except-module-not-found-content
      - id: except-import-error-content
