# Nemucod Downloader Detection
# Detects the Nemucod JScript downloader family via its unique obfuscation patterns

defaults:
  crit: hostile
  conf: 0.95
  for: [javascript]

composite_rules:
  - id: js-nemucod-downloader-windows4
    desc: Nemucod JScript Downloader (Split-Join Decoder)
    all:
      - id: obj/anti-static/obfuscation/js::js-prototype-extension
      - id: obj/anti-static/obfuscation/js::js-split-join-empty
    any:
      - id: obj/anti-static/obfuscation/js::js-dynamic-global-access-array
      - id: cap/data/encode/base64::alphabet-script
      - id: obj/exfil/channel/oob::http-b64
      - id: obj/execution/interpreter/script/wsh::adodb-fragment-short
      - id: obj/execution/interpreter/script/wsh::wscript-shell-fragment-short

  - id: js-nemucod-downloader-windows
    desc: Nemucod JScript Downloader (Map-Replace Decoder)
    all:
      - id: obj/anti-static/obfuscation/js::js-prototype-extension
      - id: obj/anti-static/obfuscation/js::js-replace-map
    any:
      - id: obj/anti-static/obfuscation/js::js-dynamic-global-access-array
      - id: cap/data/encode/base64::alphabet-script
      - id: obj/exfil/channel/oob::http-b64
      - id: obj/execution/interpreter/script/wsh::adodb-fragment-short
      - id: obj/execution/interpreter/script/wsh::wscript-shell-fragment-short

  - id: js-nemucod-downloader-jitter
    desc: Nemucod JScript Downloader (Jitter Evasion)
    all:
      - id: cap/time/measure/delta::js-date-diff-jitter-check
    any:
      - id: obj/execution/interpreter/script/wsh::wsh-tiny-fragment-assignment
      - id: obj/execution/interpreter/script/wsh::wscript-shell-fragment
      - id: obj/execution/interpreter/script/wsh::wscript-shell-fragment-short