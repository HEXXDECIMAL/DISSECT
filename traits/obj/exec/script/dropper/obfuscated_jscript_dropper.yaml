# Obfuscated JScript Stream Downloader
# Detects obfuscated JScript downloaders using a specific while/try-catch loop
# waiting for readyState or network connectivity, combined with tiny fragments
# of ADODB.Stream or XMLHTTP.

defaults:
  crit: hostile
  conf: 1.0
  for: [javascript]

composite_rules:
  # Helper: Match any of the suspicious fragments
  - id: obfuscated-adodb-fragments
    desc: Tiny obfuscated ADODB/XMLHTTP fragments
    crit: suspicious
    any:
      - id: obj/exec/interpreter/script/wsh/

  # Main Rule: Combine loop + fragments + payload handling
  - id: obfuscated-adodb-dropper
    desc: Obfuscated ADODB/XMLHTTP dropper behavior
    all:
      # 1. Probabilistic loader loop
      - id: obj/exec/dropper/behavior::probabilistic-loader-loop
      # 2. Any of the fragments
      - id: obj/exec/script/dropper::obfuscated-adodb-fragments
      # 3. Payload handling (write/save)
      - id: obj/exec/interpreter/script/wsh::payload-handling-fragment-tiny-exact