# Obfuscated JScript Dropper Detection
# Detects heavily obfuscated JavaScript/JScript droppers using specific techniques
# ATT&CK: T1027 (Obfuscated Files or Information)
# MBC: B0032 (Obfuscated Files or Information)

defaults:
  for: [javascript]
  crit: hostile

composite_rules:
  # Obfuscated XOR Dropper (JScript)
  # Detects JScript code using XOR decryption loops with hex-encoded strings
  # Complexity: 4
  - id: js-obfuscated-xor-dropper
    desc: "Obfuscated JScript XOR dropper"
    conf: 0.95
    attack: "T1027"
    mbc: "B0032"
    all:
      - id: js-xor-decoder-logic
      - id: js-obfuscated-strings

  - id: js-xor-decoder-logic
    desc: "JScript XOR decoder logic"
    crit: suspicious
    conf: 0.8
    any:
      - id: cap/data/encode/xor::js-xor-decoder-loop
      - id: cap/data/encode/xor::js-xor-decoder-ast

  - id: js-obfuscated-strings
    desc: "JScript obfuscated strings"
    crit: notable
    conf: 0.8
    any:
      - id: obj/anti-static/obfuscation/strings/encoding::js-interspersed-hex-escapes
      - id: obj/anti-static/obfuscation/strings/encoding::js-hex-escape
      - id: obj/anti-static/obfuscation/strings/encoding::fromcharcode
    downgrade:
      any:
        - type: string
          regex: "BinaryParser|Jonas Raoni Soares Silva"

  # Obfuscated JScript Dropper (Incremental String Building)
  # Detects JScript code using high density of small function calls to construct payload
  - id: js-incremental-string-dropper
    desc: "Obfuscated JScript dropper using incremental string building"
    crit: hostile
    conf: 0.95
    attack: "T1027"
    mbc: "B0032"
    all:
      - id: cap/anti-static/obfuscation/js::js-dense-string-building
    any:
      - id: obj/anti-static/obfuscation/code-metrics/functions::high-function-density
      - id: cap/exec/eval/dynamic::js-eval-construction
      - id: cap/exec/eval/dynamic::js-indirect-eval-this
      - id: cap/exec/eval/dynamic::js-indirect-eval-this-assign
      - id: js-indirect-eval-via-global-var
      - id: cap/exec/script/wsh

  - id: js-indirect-eval-via-global-var
    desc: "Indirect eval via global object reference"
    crit: suspicious
    conf: 0.9
    all:
      - id: cap/exec/eval/dynamic::js-assign-global-this
      - id: cap/exec/eval/dynamic::bracket-property-access-var
    downgrade:
      any:
        - id: meta/library/prototype::copyright
    unless:
      - id: cap/exec/eval/dynamic::js-assign-common-root
      - id: meta/library/jquery::domain
      - id: meta/library/jquery::version-string
      - id: meta/library/jquery::copyright
      - id: meta/library/jquery::fn-extend
      - id: meta/library/prototype::copyright
      - id: meta/library/prototype::version-string
      - id: meta/library/prototype::header-x
      - id: meta/quality::versioned

  # Obfuscated Hex-Encoded Dropper (Node.js/JS)
  # Detects Buffer.from(hex) execution combined with known hex-encoded shell commands
  - id: js-hex-encoded-dropper
    desc: "Obfuscated JavaScript dropper using hex-encoded commands"
    crit: hostile
    conf: 0.95
    attack: "T1027"
    mbc: "B0032"
    all:
      - id: obj/anti-static/obfuscation/code::buffer-from-hex-exec
    any:
      - id: cap/exec/command/shell/hex # Detects any hex-encoded shell command