# Malicious extconf.rb Dropper
# ATT&CK: T1105 (Ingress Tool Transfer), T1059 (Command Execution)

defaults:
  crit: hostile
  conf: 1.0

composite_rules:
  - id: extconf-rename-exec
    desc: extconf.rb renames a file to executable (Dropper)
    all:
      - id: obj/exec/dropper/script::filename-extconf
      - id: obj/exec/dropper/script::ruby-ast-rename-to-exe

  - id: extconf-fragmented-download
    desc: extconf.rb performs fragmented URL download
    all:
      - id: obj/exec/dropper/script::filename-extconf
      - id: obj/exec/dropper/script::ruby-ast-fragmented-url-fetch

  - id: extconf-os-check-exec
    desc: extconf.rb checks for Windows and executes command
    all:
      - id: obj/exec/dropper/script::filename-extconf
      - id: obj/exec/dropper/script::ruby-ast-check-windows-regex
      - id: cap/process/create/shell/lang::ruby-exec
    needs: 3
