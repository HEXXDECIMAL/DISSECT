# Windows Batch Dropper Traits
# Detects malicious batch script patterns for downloading and executing payloads
# MBC: C0002 (Download), B0024 (Execution)
# ATT&CK: T1105 (Ingress Tool Transfer), T1059.003 (Windows Command Shell)

traits:
  # Download Patterns
  - id: curl-to-temp
    desc: Download to TEMP directory
    crit: suspicious
    conf: 0.9
    mbc: "C0002"
    attack: "T1074.001"
    for: [shell, batch]
    if:
      type: raw
      regex: "%TEMP%|%TMP%|\\\\Temp\\\\"

  - id: powershell-download
    desc: PowerShell download cradle in batch
    crit: notable
    conf: 0.9
    mbc: "C0002"
    attack: "T1059.001"
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)powershell.{0,100}(?:DownloadFile|Invoke-WebRequest|iwr\\s|wget\\s)"

  - id: certutil-download
    desc: Certutil download abuse (LOLBin technique)
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    if:
      type: raw
      regex: "certutil\\s+.{0,50}-urlcache.{0,30}-split.{0,30}-f"

  - id: bitsadmin-download
    desc: BitsAdmin download abuse (LOLBin technique)
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    if:
      type: raw
      regex: "bitsadmin\\s+.{0,50}\\/transfer"

  # Execution Patterns
  - id: start-hidden
    desc: Start process hidden (/B flag)
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    attack: "T1564"
    for: [batch]
    if:
      type: raw
      regex: "start\\s+[\"']?[\"']?\\s*/[Bb]"

  - id: temp-var
    desc: TEMP environment variable
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)%TEMP%|%TMP%"

  - id: exe-extension
    desc: .exe file reference
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)\\.exe\\b"

  - id: start-cmd
    desc: start command
    crit: notable
    conf: 0.5
    for: [batch]
    if:
      type: raw
      regex: "(?i)\\bstart\\b"

  - id: run-from-temp
    desc: Execute binary from TEMP directory
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059.003"
    for: [batch]
    if:
      type: raw
      regex: "(?i)start[^\\n]{0,220}(%TEMP%|%TMP%)[^\\n]{0,220}\\.exe"

  # Persistence/Markers
  - id: done-marker
    desc: Execution marker file (run-once pattern)
    crit: notable
    conf: 0.75
    for: [shell, batch]
    if:
      type: raw
      regex: "if exist.{0,30}\\.done|echo\\.>.{0,30}\\.done|\\.installed|\\.complete"

  # Evasion
  - id: echo-off
    desc: Echo off (hide command output)
    crit: notable
    conf: 0.6
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)@echo\\s+off"

  - id: redirect-null
    desc: Redirect output to null (hide
    crit: notable
    conf: 0.7
    mbc: "F0005"
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)>nul|2>nul"

  - id: delayed-expansion
    desc: Delayed expansion enabled (advanced scripting)
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      substr: "EnableDelayedExpansion"

  - id: curl-cmd
    desc: curl command
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)\\bcurl\\b"

  - id: wget-cmd
    desc: wget command
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)\\bwget\\b"

  - id: download-file-ps
    desc: PowerShell DownloadFile
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)DownloadFile"

  - id: certutil-cmd
    desc: certutil command
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)\\bcertutil\\b"

  - id: certutil-urlcache
    desc: certutil urlcache (LOLBin download)
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)certutil[^\\n]{0,220}-urlcache"

  - id: certutil-urlcache-split-force
    desc: certutil urlcache with split force flags
    crit: suspicious
    conf: 0.98
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)certutil(?:\\.exe)?\\s+[^\\n]{0,120}-urlcache[^\\n]{0,60}-split[^\\n]{0,60}-f"

  - id: wmic-arch-check
    desc: Check OS architecture via WMIC
    crit: notable
    conf: 0.8
    attack: "T1082"
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)wmic[^\\n]{0,220}osarchitecture"

  - id: bitsadmin-cmd
    desc: bitsadmin command
    crit: notable
    conf: 0.5
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)\\bbitsadmin\\b"

  - id: output-flag
    desc: Output flag -o
    crit: notable
    conf: 0.4
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)-o\\b"

  - id: call-cmd
    desc: call command
    crit: notable
    conf: 0.4
    for: [shell, batch]
    if:
      type: raw
      regex: "(?i)(?:^|[^-\\w])call(?:$|[^-\\w])"

  # PowerShell launcher from batch
  - id: powershell-exe
    desc: PowerShell.exe invocation
    crit: notable
    conf: 0.7
    for: [shell, batch]
    attack: "T1059.001"
    if:
      type: raw
      regex: "(?i)powershell(\\.exe)?"

  # PowerShell with -c flag (command)
  - id: powershell-command
    desc: PowerShell command flag
    crit: notable
    conf: 0.7
    for: [shell, batch]
    attack: "T1059.001"
    if:
      type: raw
      regex: "(?i)powershell[^\\n]{0,220}-[Cc]\\s"

  # OutFile parameter (download to disk)
  - id: outfile-param
    desc: OutFile parameter
    crit: notable
    conf: 0.75
    for: [shell, batch, powershell]
    if:
      type: raw
      regex: "(?i)-OutFile"

  # Go build stealth compilation
  - id: go-build-cmd
    desc: Go build command
    crit: notable
    conf: 0.8
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bgo\\s+build\\b"

  - id: go-ldflags-strip
    desc: Go strip flag in ldflags
    crit: notable
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [shell, batch]
    # Stealth binaries are typically small
    size_max: 5000
    if:
      type: string
      regex: "ldflags.{0,50}(-s\\s+-w|\\s-s\\s+|\\s-s\\b)"
    unless:
      - type: raw
        substr: "mkall"

  - id: go-ldflags-hide-gui
    desc: Go hide GUI window flag
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    attack: "T1564"
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)-H=windowsgui"

  - id: go-linkmode-external
    desc: Go external linkmode compilation
    crit: notable
    conf: 0.7
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)linkmode=external"

composite_rules:
  # Download tool composite
  - id: download-tool
    desc: Download tool usage
    crit: notable
    conf: 0.7
    for: [shell, batch]
    any:
      - id: curl-cmd
      - id: wget-cmd
      - id: download-file-ps
      - id: certutil-cmd
      - id: bitsadmin-cmd

  # Execute composite
  - id: exec-cmd
    desc: Execution command
    crit: notable
    conf: 0.6
    for: [shell, batch]
    any:
      - id: start-cmd
      - id: exe-extension
      - id: call-cmd

  # Download + Execute Combo (Batch-specific)
  - id: batch-download-execute
    desc: Download and execute pattern (batch)
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [batch]
    all:
      - id: echo-off
      - id: download-tool
      - id: exec-cmd
      - id: output-flag

  # PowerShell launcher from batch
  - id: powershell-launcher
    desc: PowerShell launcher in batch
    crit: notable
    conf: 0.8
    for: [shell, batch]
    all:
      - id: powershell-exe
      - id: powershell-command

  # PowerShell download cradle in batch (Invoke-WebRequest + OutFile)
  - id: powershell-download-cradle
    desc: PowerShell download cradle
    crit: notable
    conf: 0.9
    mbc: "C0002"
    attack: "T1059.001"
    for: [shell, batch]
    all:
      - id: powershell-exe
    any:
      - id: outfile-param
      - id: powershell-download

  # Go build stealth compilation pattern
  - id: go-build-stealth
    desc: Go build with stealth flags
    crit: suspicious
    conf: 0.92
    mbc: "B0032"
    attack: "T1027"
    for: [shell, batch]
    all:
      - id: go-build-cmd
    any:
      - id: go-ldflags-strip
      - id: go-ldflags-hide-gui

  # Hostile Batch Dropper (Download + Execute + Self-Delete)
  - id: batch-dropper-hostile
    desc: Hostile Batch Dropper (Download + Execute + Self-Delete)
    crit: hostile
    conf: 0.99
    mbc: "C0002"
    attack: "T1059.003"
    for: [batch]
    all:
      - id: cap/fs/file/delete::batch-self-delete
    any:
      - id: powershell-download
      - id: powershell-download-cradle
      - id: certutil-download
      - id: bitsadmin-download
      - id: curl-to-temp
      - id: batch-download-execute
      - id: obj/anti-static/obfuscation/source/string::rundll32-obfuscated-env-var
