# File Enumeration Pattern
# Detects malware searching files for encryption/infection
# Generic indicator for ransomware, worms, data exfiltration

traits:
  - id: file-find-api
    desc: File enumeration API (FindFirstFileExW)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FindFirstFileExW"
    notes: "Used to search filesystem for target files"
    attack: "T1083"
    mbc: "C0000"

  - id: file-iterate-api
    desc: File iteration API (FindNextFileW)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FindNextFileW"
    notes: "Iterates through enumerated files"
    attack: "T1083"
    mbc: "C0000"

  - id: file-close-api
    desc: File search termination (FindClose)
    crit: inert
    conf: 0.6
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "FindClose"
    notes: "Cleanup for file enumeration handles"

composite_rules:
  - id: file-enumeration-targeting
    desc: File system enumeration pattern
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1083"
    mbc: "C0000"
    notes: |
      Detects file system enumeration pattern common in:
      - Ransomware (searching for files to encrypt)
      - Worms (searching for files to infect)
      - Data exfiltration (searching for specific file types)
      - Information gathering

      Pattern: FindFirstFileExW + FindNextFileW
      Indicates: Systematic file targeting capability

      Seen in:
      - Ryuk, Conti, LockBit (ransomware)
      - Emotet, Trickbot (worms/mass infection)
      - Carbanak, Fin7 (data targeting)

    all:
      - id: file-find-api
      - id: file-iterate-api

  - id: file-enumeration-with-access
    desc: File enumeration + access combination
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [pe]
    attack: "T1083"
    mbc: "C0000"
    notes: |
      Combines file enumeration with file access APIs.
      Indicates actual file operations following search.

      Pattern suggests:
      1. Search filesystem (FindFirstFileExW)
      2. Iterate results (FindNextFileW)
      3. Access files (CreateFileW)

    all:
      - id: file-enumeration-targeting
      - id: cap/fs/file/open

