# Lateral Movement - SSH Worm Composite Rules
# ATT&CK: T1021.004 (Remote Services: SSH)

defaults:
  # SSH-related strings can be embedded in any file type
  for: ["*"]

composite_rules:
  # === SSH Worm Detection ===

  - id: shell-worm
    desc: SSH worm implemented in shell
    crit: suspicious
    conf: 0.95
    attack: "T1021.004"
    mbc: "E1021"
    all:
      - id: dot-ssh-ref
    needs: 3
    any:
      - id: strict-host-disable
      - id: known-hosts-bypass
      - id: connect-timeout
      - id: remote-curl
      - id: remote-wget
      - id: authorized-keys
      - id: known-hosts-file
      - id: ssh-config-parse

  # === SSH Attack Tool ===
  # NOTE: attack-ref is a single condition composite rule, moved to traits section
  # in lateral/ssh/connect/traits.yaml

  # === SSH Key Theft + Lateral Movement ===

  - id: key-based-spread
    desc: SSH key theft for lateral
    crit: suspicious
    conf: 0.85
    attack: "T1552.004"
    all:
      - id: dot-ssh-ref
    any:
      - id: key-id-rsa
      - id: key-pem

  # === SSH Host Discovery ===

  - id: host-discovery
    desc: SSH target host discovery
    crit: suspicious
    conf: 0.8
    attack: "T1018"
    needs: 2
    any:
      - id: authorized-keys
      - id: known-hosts-file
      - id: ssh-config-parse
      - id: bash-history-ssh
      - id: getent-hosts
