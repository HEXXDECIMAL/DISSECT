# Shell Script Network Scanning
# Detects shell scripts that perform network reconnaissance/scanning
# ATT&CK: T1046 (Network Service Discovery)
# MBC: E1046

defaults:
  attack: "T1046"
  mbc: "E1046"
  for: [shell]

traits:
  # === xargs-based scanning patterns ===

  - id: xargs-network-loop
    desc: xargs executing command per line
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # cat FILE | xargs -l COMMAND (line-based execution)
      regex: "cat\\s+\\S+\\s*\\|\\s*xargs\\s+[^\\n]*-l[^\\n]*\\."

  - id: xargs-call-script
    desc: xargs executing local script
    crit: notable
    conf: 0.8
    if:
      type: raw
      # xargs calling ./ script (dot prefix = hidden/local)
      regex: "xargs\\s+[^\\n]*\\./\\.[a-z_]+"

  - id: pipe-loop-pattern
    desc: Pipe to xargs for iteration
    crit: notable
    conf: 0.7
    if:
      type: raw
      # Generic pipe to xargs pattern
      regex: "\\|\\s*xargs\\s+[^\\n]*-[a-z]*l"

  # === Scanner invocation patterns ===

  - id: script-probes-port
    desc: Shell script probes specific port
    crit: notable
    conf: 0.75
    if:
      type: raw
      # Script references specific port (FTP=21, SSH=22, HTTP=80, etc)
      # Avoid matching dates (2022-11-22) or versions (1.22) by excluding - and . delimiters
      regex: "(?:^|[^\\d\\.-])(21|22|23|25|53|80|110|139|143|443|445|3306|3389)(?:$|[^\\d\\.-])"
    unless:
      # Exclude dates like "22 Feb" or "22 Jan 2022"
      - type: raw
        regex: "\\b(21|22)\\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)"

  - id: script-loops-ips
    desc: Script loops over IP addresses
    crit: notable
    conf: 0.8
    if:
      type: raw
      # Common patterns: for each $1, for i in IPs, while read ip, etc
      regex: "(?:while\\s+read\\s+(?:ip|host|target|addr)|for\\s+(?:ip|host|target|addr)\\s+in)"

  - id: dotfiles-in-script
    desc: References hidden scripts
    crit: notable
    conf: 0.85
    # Small binaries/scripts with hidden paths are more suspicious
    size_max: 5000
    if:
      type: raw
      # Calling /.SCRIPT or ./.SCRIPT (covert execution)
      regex: "\\./\\.\\w+|/\\.\\w+\\s"
    unless:
      - type: raw
        regex: "library|compiler|builtins"

composite_rules:
  # xargs-based loop with dotfiles: characteristic of statdx-scan style
  # Complexity: all(3) + for(1) = 4 >= 4 âœ“ SUSPICIOUS->HOSTILE upgrade
  - id: xargs-dotfile-loop
    desc: xargs looping with hidden script calls
    crit: suspicious
    conf: 0.90
    all:
      - id: xargs-network-loop
      - id: dotfiles-in-script
      - id: pipe-loop-pattern
