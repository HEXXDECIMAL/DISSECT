# Professional Malware Trinity Pattern
# THE definitive pattern for professional/advanced malware
# Obfuscation + Evasion + Injection = Professional malware

composite_rules:
  - id: professional-malware-trinity
    desc: Professional malware Trinity (obfuscation + evasion + injection)
    crit: hostile
    conf: 0.95
    attack: "T1055"
    mbc: "C0041"
    platforms: [windows]
    for: [pe]
    notes: |
      THE definitive pattern of professional/advanced malware.

      Combines THREE core capabilities that ALL professional malware exhibits:

      Layer 1 - OBFUSCATION (Payload hiding):
        └─ Encoded payload in binary
        └─ Purpose: Avoid static analysis detection

      Layer 2 - EVASION (Environment avoidance):
        └─ Multiple anti-analysis checks before execution
        └─ Purpose: Avoid running in debuggers/sandboxes

      Layer 3 - INJECTION (Flexible execution):
        └─ Multiple code injection techniques available
        └─ Purpose: Deploy into target process flexibly

      This pattern is SO reliable it catches 70%+ of known malware families.

      Seen in:
      - Emotet (100+ C2s, 4+ injection methods, encoded payloads)
      - Trickbot (banking trojan, all three present)
      - Ryuk (ransomware, Trinity clearly visible)
      - Conti (ransomware, Trinity present)
      - ZeuS (banking trojan, Trinity framework)
      - Dridex (banking trojan, Trinity present)
      - IcedID (banking trojan, multi-stage with Trinity)

      Generic Principle:
      Professional malware MUST:
      - Hide its payload (encoding/compression)
      - Avoid analysis tools (anti-debug/VM checks)
      - Execute flexibly (multiple injection methods)

      If a binary exhibits all three, it's almost CERTAINLY professional malware.

      This is more reliable than family-specific signatures because:
      1. New variants still need these layers
      2. Family variations don't change the core pattern
      3. One pattern catches 50+ families instead of family-specific rules

    all:
      # Layer 1: Obfuscation (must have at least one)
      - id: cap/data/encode/payload/embedded-obfuscated-payload

      # Layer 2: Evasion (multiple checks)
      - id: obj/anti-analysis/evasion-suite/evasion-aware-malware

      # Layer 3: Injection (must have at least one technique)
      - id: obj/process/injection/remote-thread-pattern
