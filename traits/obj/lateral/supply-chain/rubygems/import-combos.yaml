# RubyGems Supply Chain - Suspicious Import Combinations
# Detects unusual import patterns in Ruby gems
# ATT&CK: T1195.002 (Compromise Software Supply Chain)

defaults:
  for: [ruby]
  attack: "T1195.002"

traits:
  # === File detection ===
  - id: gemspec-file
    desc: Ruby gemspec file
    crit: notable
    conf: 1.0
    if:
      type: basename
      regex: "\\.gemspec$"

  - id: extconf-file
    desc: Ruby native extension config
    crit: notable
    conf: 1.0
    if:
      type: basename
      exact: "extconf.rb"

  - id: in-extension-dir
    desc: File is in Ruby extension directory
    crit: inert
    if:
      type: raw
      regex: "ext/.{0,50}"

  # === Require patterns ===
  - id: require-net-http
    desc: Requires net/http
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "require\\s+['\"]net/http['\"]"

  # === Shell execution patterns ===
  - id: system-call
    desc: system() shell execution
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "\\bsystem\\s*\\("

  - id: backtick-exec
    desc: Backtick shell execution
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "`[^`]+`"

  - id: percent-x-exec
    desc: Percent-x shell execution
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "%x\\{|%x\\["

  - id: io-popen-exec
    desc: IO.popen execution
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "IO\\.popen"

  - id: open3-exec
    desc: Open3 execution
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "Open3\\.(capture|popen)"

  # === Eval patterns ===
  # NOTE: eval-call moved to cap/exec/eval/dynamic (content type, not string)

  - id: instance-eval
    desc: instance_eval call
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "instance_eval"

  # Removed class-eval duplicate - use cap/exec/eval/dynamic::class-eval

  # === Base64 patterns ===
  - id: base64-decode
    desc: Base64 decode call
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "Base64\\.(decode64|encode64)"

  # === Obfuscation patterns ===
  - id: eval-base64-decode
    desc: eval with Base64 decode
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: "eval\\s*\\(\\s*Base64\\.decode64"

  - id: hex-escape-dense
    desc: Dense hex escape sequences
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "\\\\x[0-9a-f]{2}\\\\x[0-9a-f]{2}"
      count_min: 10

  - id: pack-hex
    desc: pack('H*') hex decode
    crit: notable
    conf: 0.8
    if:
      type: raw
      regex: "\\.pack\\(['\"]H\\*['\"]\\)"

  - id: load-call
    desc: load() dynamic load
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "\\bload\\s*\\("

  # === Credential paths ===
  - id: ssh-private-key-path
    desc: SSH private key path
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: ".ssh/id_rsa"

  # Removed aws-credentials-path duplicate - use cap/fs/path/sensitive/cloud::aws-credentials

  - id: netrc-path
    desc: .netrc file path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: ".netrc"

  # Removed browser-login-data duplicate - use cap/fs/path/sensitive/browser::login-data

  - id: chrome-config-path
    desc: Chrome config path
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: "\\.config/(google-chrome|chromium)"

  # === Webhook patterns ===
  - id: ruby-discord-webhook
    desc: Discord webhook URL
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "discord(app)?\\.com/api/webhooks"

  # === Remote download patterns ===
  - id: remote-binary-url
    desc: Remote binary URL
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "https?://[^\\s]+\\.(so|dll|dylib|exe|sh|rb)"

  # === Reverse shell patterns ===
  - id: tcpsocket-exec
    desc: TCPSocket with exec
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "TCPSocket\\.new.{0,50}(exec|system|spawn|`)"

  - id: socket-stdin
    desc: Socket redirecting stdin
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: "Socket\\.tcp.{0,100}\\$stdin"

  - id: stdin-reopen
    desc: STDIN reopen pattern
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "dup2.{0,30}STDIN|STDIN.{0,30}reopen"

  # === File operations ===
  - id: file-read-write
    desc: File read/write operations
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "File\\.(read|write|open|delete)"

composite_rules:
  # === INERT: Common legitimate patterns ===

  - id: http-client-imports
    desc: HTTP client imports
    crit: notable
    conf: 0.5
    any:
      - id: meta/import/ruby::net/http
      - id: meta/import/ruby::faraday
      - id: meta/import/ruby::httparty
      - id: meta/import/ruby::rest-client
      - id: require-net-http

  - id: file-imports
    desc: File operation imports
    crit: notable
    conf: 0.5
    any:
      - id: meta/import/ruby::fileutils
      - id: file-read-write

  # === NOTABLE: Patterns that define gem purpose ===

  - id: shell-exec-imports
    desc: Shell execution patterns
    crit: notable
    conf: 0.7
    any:
      - id: meta/import/ruby::open3
      - id: system-call
      - id: backtick-exec
      - id: percent-x-exec
      - id: io-popen-exec
      - id: open3-exec

  - id: eval-imports
    desc: Dynamic code evaluation
    crit: notable
    conf: 0.75
    any:
      - id: cap/exec/eval/dynamic::eval-call-ruby
      - id: instance-eval
      - id: class-eval

  - id: base64-imports
    desc: Base64 encoding operations
    crit: notable
    conf: 0.5
    any:
      - id: meta/import/ruby::base64
      - id: base64-decode

  # === SUSPICIOUS: Unusual patterns in gem context ===

  - id: gemspec-shell-exec
    desc: Gemspec executes shell commands
    crit: suspicious
    conf: 0.85
    all:
      - id: gemspec-file
      - id: shell-exec-imports

  - id: extconf-remote-download
    desc: Native extension downloads remote code
    crit: suspicious
    conf: 0.85
    all:
      - id: extconf-file
      - id: http-client-imports
    any:
      - id: remote-binary-url
      - id: shell-exec-imports

  - id: extconf-tracking-pixel
    desc: Native extension contacts tracking pixel or logging service
    crit: hostile
    conf: 0.95
    all:
      - id: extconf-file
      - id: http-client-imports
      - id: obj/discovery/network/scan::plaintext-ip-services

  - id: network-eval-exec-chain
    desc: Network fetch with eval and exec
    crit: suspicious
    conf: 0.9
    all:
      - id: http-client-imports
      - id: eval-imports
    any:
      - id: shell-exec-imports
      - id: load-call

  - id: obfuscated-payload
    desc: Obfuscated code payload
    crit: suspicious
    conf: 0.85
    any:
      - id: eval-base64-decode
      - id: hex-escape-dense
      - id: pack-hex

  - id: credential-path-access
    desc: Accesses credential storage paths
    crit: suspicious
    conf: 0.9
    any:
      - id: ssh-private-key-path
      - id: cap/fs/path/sensitive/cloud::aws-credentials
      - id: netrc-path
      - id: cap/fs/path/sensitive/browser::login-data
      - id: chrome-config-path

  - id: webhook-exfil
    desc: Webhook data exfiltration
    crit: suspicious
    conf: 0.85
    all:
      - id: http-client-imports
    any:
      - id: ruby-discord-webhook
      - id: obj/lateral/supply-chain/npm/install::telegram-bot-api

  # === HOSTILE: Clear malware patterns ===

  # gemspec downloads and evals remote code
  # Precision: all(3) = 3.0, + for(1) = 4.0 (meets hostile threshold)
  - id: gemspec-remote-eval
    desc: Gemspec downloads and evaluates remote code
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    all:
      - id: gemspec-file
      - id: http-client-imports
      - id: eval-imports

  # Credential stealer pattern
  # Precision: all(3) + any(1) = 4.0 (meets hostile threshold)
  - id: credential-stealer
    desc: Steals and exfiltrates credentials
    crit: hostile
    conf: 0.95
    mbc: "E1555"
    attack: "T1555"
    all:
      - id: credential-path-access
      - id: file-imports
      - id: http-client-imports

  # Reverse shell pattern
  # Precision: all(1) + any(hostile traits) = 4.0+ (meets hostile threshold)
  - id: reverse-shell-pattern
    desc: Ruby reverse shell pattern
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1059.004"
    all:
      - id: meta/import/ruby/socket
    any:
      - id: tcpsocket-exec
      - id: socket-stdin
      - id: stdin-reopen

  # Install-time dropper pattern
  # Precision: all(2) = 2.0, + for(1) = 3.0, + hostile trait(1) = 4.0 (meets hostile threshold)
  - id: extconf-dropper
    desc: Ruby native extension performs dropper behavior
    crit: hostile
    conf: 0.98
    mbc: "B0024"
    all:
      - id: extconf-file
      - id: obj/exec/dropper/stealth::ruby-dropper-rename-exec

  # Malicious installer renames and executes dropped payload
  - id: rubygem-dropper-rename-exec
    desc: Malicious installer renames and executes dropped payload
    crit: hostile
    conf: 0.95
    attack: "T1059"
    all:
      - id: obj/lateral/supply-chain/rubygems::extconf-file
      - id: cap/exec/dropper/script::ruby-ast-rename-to-exe
    any:
      - id: cap/exec/command/shell/lang::ruby-exec

  # Build script fetches remote content and then renames+executes payload.
  - id: extconf-http-fetch-rename-exec
    desc: extconf.rb fetches remote content then renames and executes payload
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    all:
      - id: extconf-file
      - id: cap/exec/script/extconf::extconf-http-fetch
      - id: cap/exec/dropper/script::ruby-ast-rename-to-exe
      - id: cap/exec/command/shell/lang::ruby-exec

  # Generic rename and execute in extconf.rb (handles variable arguments)
  - id: extconf-rename-exec-generic
    desc: extconf.rb renames a file and executes a command (generic)
    crit: hostile
    conf: 0.95
    all:
      - id: extconf-file
      - id: cap/exec/dropper/script::ruby-ast-file-rename
      - id: cap/exec/command/shell/lang::ruby-exec
