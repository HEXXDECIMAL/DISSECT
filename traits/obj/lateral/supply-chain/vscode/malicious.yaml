# Malicious VSCode Extension Patterns
# Detects high-confidence malicious patterns in VSCode extensions
# These combine multiple indicators to reduce false positives

traits:
  # NOTE: YARA kept for api-usage - requires fullword match on "activate" which
  # DISSECT doesn't support, plus regex patterns for require/import
  - id: api-usage
    description: Uses VSCode API (extension marker)
    crit: inert
    confidence: 1.0
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule vscode_api_usage {
          strings:
            $require = /require\(['"]vscode['"]\)/ ascii
            $import = /from\s+['"]vscode['"]/ ascii
            $namespace = "vscode." ascii
            $activate = "activate" ascii fullword
          condition:
            any of them
        }

  # === Atomic indicators for post-install-exec ===
  - id: activate-word
    description: activate keyword
    crit: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "activate"

  - id: globalState-word
    description: globalState keyword
    crit: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "globalState"

  - id: postInstall-word
    description: postInstall keyword
    crit: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "postInstall"

  - id: exec-pattern
    description: exec function pattern
    crit: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "exec(Sync|Async)?"

  # === Atomic indicators for credential-theft ===
  - id: ssh-dir
    description: .ssh directory reference
    crit: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: ".ssh"

  - id: aws-dir
    description: .aws directory reference
    crit: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: ".aws"

  - id: npmrc-file
    description: .npmrc file reference
    crit: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: ".npmrc"

  - id: env-file
    description: .env file reference
    crit: notable
    confidence: 0.6
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: ".env"

  - id: readFile-pattern
    description: readFile function pattern
    crit: inert
    confidence: 0.6
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "read(File|FileSync)"

  - id: post-method
    description: POST HTTP method
    crit: inert
    confidence: 0.6
    file_types: [javascript, typescript]
    condition:
      type: string
      exact: "POST"

  # AST-based HTTP patterns (more robust than string matching)
  - id: http-request-ast
    desc: HTTP request via require('http')
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "http\\.request|https\\.request"

  - id: http-get-ast
    desc: HTTP GET via require('http')
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "http\\.get|https\\.get"

  - id: child-process-require
    desc: child_process module require
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: ast
      kind: import
      exact: "child_process"

  - id: child-process-exec-ast
    desc: child_process exec/spawn call
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "exec(Sync)?\\(|spawn(Sync)?\\(|execFile(Sync)?\\("

  - id: new-function-constructor
    desc: new Function() constructor (dynamic code)
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      exact: "new Function"

  # VSCode namespace usage pattern
  - id: vscode-namespace
    description: Uses VSCode namespace
    crit: inert
    confidence: 1.0
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "vscode\\."

  # Persistence location references
  - id: persistence-locations
    description: References persistence locations (startup/autorun paths)
    crit: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "APPDATA|Startup|crontab|launchd|systemd"

  # File write operations
  - id: file-write-ops
    description: File write or copy operations
    crit: inert
    confidence: 1.0
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "write(File|FileSync)|copy(File|FileSync)"

composite_rules:
  # State helpers
  - id: state-markers
    description: State management markers (globalState or postInstall)
    crit: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    count_min: 1
    any:
      - id: globalState-word
      - id: postInstall-word

  # Credential paths
  - id: credential-paths
    description: Sensitive credential file/directory paths
    crit: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    count_min: 1
    any:
      - id: ssh-dir
      - id: aws-dir
      - id: npmrc-file
      - id: env-file

  # HTTP/network capability (broader than just POST string)
  - id: network-capability
    description: HTTP/network communication capability
    crit: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    count_min: 1
    any:
      - id: post-method
      - id: http-request-ast
      - id: http-get-ast
      - id: cap/comm/http/request/javascript/https-request
      - id: cap/comm/http/request/javascript/http-request
      - id: cap/comm/http/request/javascript/axios
      - id: cap/comm/http/request/javascript/node-fetch-import

  # Execution capability (child_process or dynamic code)
  - id: exec-capability
    description: Code execution capability
    crit: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    count_min: 1
    any:
      - id: exec-pattern
      - id: child-process-require
      - id: child-process-exec-ast
      - id: new-function-constructor

  # Post-Install Code Execution
  - id: post-install-exec
    description: Post-install script execution (dropper pattern)
    crit: suspicious
    confidence: 0.95
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript, typescript]
    all:
      - id: activate-word
      - id: exec-capability

  # Extension Credential Theft (original - requires network send)
  - id: credential-theft
    description: VSCode extension accessing sensitive credentials
    crit: suspicious
    confidence: 0.9
    mbc: "E1519"
    attack: "T1555"
    file_types: [javascript, typescript]
    all:
      - id: credential-paths
      - id: readFile-pattern
      - id: network-capability

  # Extension Credential Access (alternate - file ops + exec without network)
  - id: credential-access-exec
    description: VSCode extension with credential access and execution
    crit: suspicious
    confidence: 0.85
    mbc: "E1519"
    attack: "T1555"
    file_types: [javascript, typescript]
    all:
      - id: credential-paths
      - id: readFile-pattern
      - id: exec-capability

  # Staged Decryption and Execution inside a VSCode Extension
  - id: staged-dropper
    description: VSCode extension with staged decryption
    crit: hostile
    confidence: 0.99
    mbc: "B0032"
    attack: "T1027"
    file_types: [javascript, typescript]
    all:
      - id: js-decrypt-eval
      - id: api-usage
      - id: vscode-namespace

  # Extension Persistence via well-known hooks
  - id: persistence
    description: Extension establishing persistence
    crit: hostile
    confidence: 0.95
    mbc: "F0011"
    attack: "T1547"
    file_types: [javascript, typescript]
    all:
      - id: api-usage
      - id: persistence-locations
      - id: file-write-ops

  # Obfuscated VSCode extension with credential access
  # This catches malware that uses dynamic code + accesses sensitive paths
  - id: obfuscated-credential-stealer
    description: Obfuscated VSCode extension with credential access
    crit: hostile
    confidence: 0.95
    mbc: "B0032"
    attack: "T1555"
    file_types: [javascript, typescript]
    all:
      - id: new-function-constructor
      - id: credential-paths
      - id: readFile-pattern
      - id: activate-word

  # VSCode extension with dynamic code execution + exec/spawn
  - id: dynamic-exec-extension
    description: VSCode extension with dynamic code and process execution
    crit: hostile
    confidence: 0.9
    mbc: "B0024"
    attack: "T1059"
    file_types: [javascript, typescript]
    all:
      - id: new-function-constructor
      - id: child-process-exec-ast
      - id: activate-word
