# Malicious VSCode Extension Patterns
# Detects high-confidence malicious patterns in VSCode extensions
# These combine multiple indicators to reduce false positives

traits:
  # NOTE: YARA kept for api-usage - requires fullword match on "activate" which
  # DISSECT doesn't support, plus regex patterns for require/import
  - id: api-usage
    desc: Uses VSCode API (extension marker)
    crit: notable
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule vscode_api_usage {
          strings:
            $require = /require\(['"]vscode['"]\)/ ascii
            $import = /from\s+['"]vscode['"]/ ascii
            $namespace = "vscode." ascii
          condition:
            // activate is too common to be a standalone extension marker
            any of them
        }

  # === Atomic indicators for post-install-exec ===
  - id: activate-word
    desc: activate keyword
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      substr: "activate"

  - id: postInstall-word
    desc: postInstall keyword
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      substr: "postInstall"

  - id: exec-pattern
    desc: exec function pattern
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "exec(Sync|Async)?"

  # === Atomic indicators for credential-theft ===
  - id: ssh-dir
    desc: .ssh directory reference
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: ".ssh"

  - id: aws-dir
    desc: .aws directory reference
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      exact: ".aws"

  - id: npmrc-file
    desc: .npmrc file reference
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      substr: ".npmrc"

  - id: readFile-pattern
    desc: readFile function pattern
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "read(File|FileSync)"

  # VSCode namespace usage pattern
  - id: vscode-namespace
    desc: Uses VSCode namespace
    crit: notable
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: string
      regex: "vscode\\."

  # Persistence location references
  - id: persistence-locations
    desc: References persistence locations (startup/autorun paths)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "APPDATA|Startup|crontab|launchd|systemd"

  # File write operations
  - id: file-write-ops
    desc: File write or copy operations
    crit: notable
    conf: 1.0
    for: [javascript, typescript]
    if:
      type: string
      regex: "write(File|FileSync)|copy(File|FileSync)"

composite_rules:
  # State helpers
  - id: state-markers
    desc: State management markers (globalState or postInstall)
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    any:
      - id: obj/lateral/supply-chain/vscode::globalState
      - id: postInstall-word

  # Credential paths
  - id: credential-paths
    desc: Sensitive credential file/directory paths
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    any:
      - id: ssh-dir
      - id: aws-dir
      - id: npmrc-file
      - id: meta/quality/config::dotenv-file

  # Send methods
  - id: send-methods
    desc: HTTP send methods
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    any:
      - id: cap/comm/http/post::post-method
      - id: cap/comm/http/request::fetch-call
      - id: cap/comm/http/request::axios

  # Post-Install Code Execution
  - id: post-install-exec
    desc: Post-install script execution (dropper pattern)
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059"
    for: [javascript, typescript]
    all:
      - id: activate-word
      - id: state-markers
      - id: exec-pattern

  # Extension Credential Theft
  - id: credential-theft
    desc: VSCode extension accessing sensitive credentials
    crit: suspicious
    conf: 0.9
    mbc: "E1519"
    attack: "T1555"
    for: [javascript, typescript]
    all:
      - id: credential-paths
      - id: readFile-pattern
      - id: send-methods

  # Staged Decryption and Execution inside a VSCode Extension
  - id: staged-dropper
    desc: VSCode extension with staged decryption
    crit: suspicious
    conf: 0.99
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: known/malware/dropper::js-decrypt-eval
      - id: api-usage
      - id: vscode-namespace

  # Extension Persistence via well-known hooks
  - id: persistence
    desc: Extension establishing persistence
    crit: suspicious
    conf: 0.95
    mbc: "F0011"
    attack: "T1547"
    for: [javascript, typescript]
    all:
      - id: api-usage
      - id: persistence-locations
      - id: file-write-ops
