# Rust Supply Chain Attack Patterns
# ATT&CK: T1195 (Supply Chain Compromise)

traits:
  # === Suspicious crate atomic indicators ===
  # These use `type: raw` because crate names appear as code identifiers, not string literals
  - id: sha-rust-crate
    desc: sha_rust suspicious crate
    crit: suspicious
    conf: 0.8
    attack: "T1195"
    for: [rust]
    if:
      type: raw
      substr: "sha_rust::"

  - id: rust-sha-crate
    desc: rust_sha suspicious crate
    crit: suspicious
    conf: 0.8
    attack: "T1195"
    for: [rust]
    if:
      type: raw
      substr: "rust_sha::"

  - id: reqwest-rust-crate
    desc: reqwest_rust suspicious crate
    crit: suspicious
    conf: 0.8
    attack: "T1195"
    for: [rust]
    if:
      type: raw
      substr: "reqwest_rust::"

  - id: tokio-rust-crate
    desc: tokio_rust suspicious crate
    crit: suspicious
    conf: 0.8
    attack: "T1195"
    for: [rust]
    if:
      type: raw
      substr: "tokio_rust::"

  - id: base64-rust-crate
    desc: base64_rust suspicious crate
    crit: suspicious
    conf: 0.8
    attack: "T1195"
    for: [rust]
    if:
      type: raw
      substr: "base64_rust::"

  # === Misspelled word atomic indicators ===
  # Use type: raw since these are identifiers in code, not string literals
  - id: filte-var-typo
    desc: filte_var misspelling
    crit: notable
    conf: 0.7
    for: [rust]
    if:
      type: raw
      substr: "filte_var"

  - id: connecion-typo
    desc: connecion misspelling
    crit: notable
    conf: 0.7
    for: [rust]
    if:
      type: raw
      substr: "connecion"

  - id: payloaad-typo
    desc: payloaad misspelling
    crit: notable
    conf: 0.7
    for: [rust]
    if:
      type: raw
      substr: "payloaad"

  - id: exfiltrat-word
    desc: exfiltrat word fragment
    crit: notable
    conf: 0.7
    for: [rust]
    if:
      type: raw
      substr: "exfiltrat"

  # === Dummy key/value atomic indicators ===
  - id: dummy-key-word
    desc: dummy_key reference
    crit: inert
    conf: 0.5
    for: [rust]
    if:
      type: string
      substr: "dummy_key"

  - id: dummy-value-word
    desc: dummy_value reference
    crit: inert
    conf: 0.5
    for: [rust]
    if:
      type: string
      substr: "dummy_value"

  # === Library pattern atomic indicators ===
  - id: pub-struct
    desc: pub struct declaration
    crit: inert
    conf: 0.5
    for: [rust]
    if:
      type: raw
      substr: "pub struct "

  - id: pub-enum
    desc: pub enum declaration
    crit: inert
    conf: 0.5
    for: [rust]
    if:
      type: raw
      substr: "pub enum "

  - id: impl-keyword
    desc: impl keyword
    crit: inert
    conf: 0.5
    for: [rust]
    if:
      type: raw
      substr: "impl "

  - id: pub-trait
    desc: pub trait declaration
    crit: inert
    conf: 0.5
    for: [rust]
    if:
      type: raw
      substr: "pub trait "

composite_rules:
  # Suspicious crate composite
  - id: suspicious-crate-call
    desc: Call to suspicious-looking crate
    crit: suspicious
    conf: 0.8
    attack: "T1195"
    for: [rust]
    any:
      - id: sha-rust-crate
      - id: rust-sha-crate
      - id: reqwest-rust-crate
      - id: tokio-rust-crate
      - id: base64-rust-crate

  # Misspelled words composite
  - id: misspelled-common-words
    desc: Misspelled common words in identifiers
    crit: notable
    conf: 0.7
    for: [rust]
    any:
      - id: filte-var-typo
      - id: connecion-typo
      - id: payloaad-typo
      - id: exfiltrat-word

  # Library pattern composite (requires 2 of them)
  - id: internal-lib-pattern
    desc: Generic indicator of legitimate library
    crit: inert
    conf: 0.5
    for: [rust]
    needs: 2
    any:
      - id: pub-struct
      - id: pub-enum
      - id: impl-keyword
      - id: pub-trait

  # Dummy keys composite
  - id: dummy-keys-hashmap
    desc: Usage of dummy keys in HashMap
    crit: notable
    conf: 0.6
    for: [rust]
    any:
      - id: dummy-key-word
      - id: dummy-value-word

  # Combined trojanized library detection
  - id: trojanized-lib
    desc: Trojanized Rust library
    crit: hostile
    conf: 0.85
    attack: "T1195.001"
    mbc: "B0024"
    for: [rust]
    all:
      - id: internal-lib-pattern
      - id: suspicious-crate-call
      - id: misspelled-common-words
