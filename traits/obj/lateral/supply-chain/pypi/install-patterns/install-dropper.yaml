# PyPI Supply-Chain Attack Patterns
# Install-time dropper: download + write executable + execute
# ATT&CK: T1195.002 (Compromise Software Supply Chain)

defaults:
  for: [python]
  attack: "T1195.002"

traits:
  # === Command Execution in Python ===
  # os.system, subprocess.call, etc.

  # Removed os-system-string duplicate - use cap/process/create/shell::python-os-system

  # === Windows Execution Patterns ===
  # Windows-specific command execution (start command, cmd.exe)

  - id: windows-start-command
    desc: Windows start command execution
    crit: suspicious
    conf: 0.85
    if:
      type: string
      # Pattern: 'start' command followed by executable/path
      # Matches: start notepad.exe, start calc, etc. (not "start with")
      regex: '\bstart\s+[''"]?[a-zA-Z0-9._\\/-]+\.(exe|bat|cmd|ps1|scr|msi|com)'
    unless:
      - type: basename
        regex: '\.pyc$'

  - id: os-system-start-concat
    desc: os.system('start ' + ...) pattern
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: 'os\.system\s*\(\s*[''"]start\s+[''"]\s*\+'

  - id: windows-computername-env
    desc: COMPUTERNAME environment access
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "COMPUTERNAME"

  # === Executable File Extensions ===
  # Writing/downloading executable files

  - id: exe-file-extension
    desc: .exe file extension reference
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: '\.exe\b'
    not:
      - "python.exe"
      - "pip.exe"
      - regex: '\bwhich\b.{0,100}\.exe'
      - regex: '\bfind\b.{0,100}\.exe'

  - id: scr-file-extension
    desc: .scr file extension (screensaver/executable)
    crit: notable
    conf: 0.95
    if:
      type: raw
      regex: '\.scr[''"]'

  # === Binary File Write Patterns ===
  # Writing binary content to files (dropper behavior)

  - id: binary-file-write
    desc: Binary mode file write
    crit: notable
    conf: 0.8
    if:
      type: string
      # open(..., 'wb') pattern
      word: "wb"

  - id: open-write-content
    desc: open().write() to file
    crit: notable
    conf: 0.8
    if:
      type: symbol
      regex: 'open\(.{0,100}\)\.write'

  # === Suspicious URL Patterns ===
  # Downloads from suspicious domains that look fake/impersonating

  - id: python-release-impersonation-url
    desc: Fake Python release URL
    crit: suspicious
    conf: 0.95
    if:
      type: string
      # Domains pretending to be official Python downloads
      regex: 'https?://[a-z0-9-]*python[a-z0-9-]*\.[a-z]+/[^\s]{0,50}\.(exe|scr|msi|bat|cmd|ps1)'

  - id: executable-download-url
    desc: URL ending in executable extension
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: 'https?://[^\s''"]+\.(exe|scr|msi|bat|cmd|ps1|dll)(?:[?#][^\s''"]*)?$'

  # === Install Hook Pattern ===
  # setup.py install command override (post-install execution)

  - id: install-run-override
    desc: Install command run() override
    crit: notable
    conf: 0.85
    if:
      type: symbol
      exact: "install.run"

  - id: cmdclass-install
    desc: cmdclass install hook
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: 'cmdclass.{0,50}[''"]install[''"]'

  # === Suspicious random module import in setup.py ===
  # Legitimate setup.py files don't need the random module.
  # Malware obfuscators use it for variable name generation and junk code.
  - id: setup-py-import-random
    desc: random module imported in setup.py
    crit: notable
    conf: 0.80
    attack: "T1027"
    if:
      type: raw
      substr: "import random"

  # === Deprecated distutils import (content-based) ===
  # Malicious setup.py frequently uses `from distutils.core import setup`
  # instead of modern setuptools. Content-based to catch obfuscated files
  # where AST string extraction yields few results.
  - id: distutils-import-content
    desc: Deprecated distutils import in source
    crit: notable
    conf: 0.80
    attack: "T1195.002"
    if:
      type: raw
      substr: "from distutils"

  # === User home directory resolution in setup.py ===
  # setup.py using os.path.expanduser to resolve user-specific paths (e.g. ~/Desktop)
  # indicates targeting user directories for file drops or shortcut enumeration.
  # Legitimate setup.py files never need to resolve the user's home directory.
  - id: setup-py-expanduser
    desc: User home directory resolution in setup.py
    crit: notable
    conf: 0.85
    attack: "T1083"
    if:
      type: raw
      substr: "os.path.expanduser"

  # === Shortcut target executable fingerprinting ===
  # Uses os.path.basename to extract the exe name from a shortcut's TargetPath.
  # Used to selectively inject extensions into specific browsers (Chrome, Edge, etc.).
  - id: setup-py-shortcut-target-fingerprint
    desc: Shortcut target executable fingerprinting
    crit: notable
    conf: 0.85
    attack: "T1518"
    if:
      type: raw
      substr: "os.path.basename"

  # === File write to disk in setup.py ===
  # setup.py writing arbitrary files to disk is dropper behavior.
  # Distinct from binary-file-write (wb mode) — catches text payload drops too.
  - id: setup-py-file-write
    desc: File write operation in setup.py
    crit: notable
    conf: 0.80
    if:
      type: raw
      substr: ".write("

  # === PowerShell -EncodedCommand in Python String ===
  # Python script invokes PowerShell with base64-encoded command.
  # Hides the actual payload from string-based analysis.
  # Extremely high signal: no legitimate Python package does this.
  - id: powershell-encoded-command-in-string
    desc: PowerShell encoded command in Python string
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    if:
      type: raw
      regex: 'powershell.{0,60}-[Ee](ncoded)?[Cc](ommand)?\s+[A-Za-z0-9+/=]{20,}'

  # === Cross-Language PowerShell Download Cradle ===
  # Python script invokes PowerShell Invoke-WebRequest to download payloads
  # Common in PyPI supply-chain attacks targeting Windows
  - id: powershell-download-in-string
    desc: PowerShell download cradle in Python string
    crit: suspicious
    conf: 0.9
    attack: "T1059.001"
    if:
      type: string
      regex: '(?:Invoke-WebRequest|IWR|DownloadFile|DownloadString|Start-BitsTransfer).{0,100}(?:https?://|\$env:)'
      case_insensitive: true

  # === PowerShell Archive Extraction ===
  # Expand-Archive cmdlet used to extract downloaded payloads
  - id: powershell-expand-archive
    desc: PowerShell archive extraction in string
    crit: suspicious
    conf: 0.9
    attack: "T1140"
    if:
      type: string
      substr: "Expand-Archive"

  # === ProgramData Drop Location ===
  # C:/ProgramData is commonly used as a writable drop location
  # by supply-chain malware (writable by all users, less scrutinized)
  - id: programdata-drop-path
    desc: ProgramData directory as drop location
    crit: notable
    conf: 0.85
    attack: "T1074.001"
    if:
      type: string
      regex: 'C:[/\\\\]ProgramData[/\\\\]'
      case_insensitive: true

  # === Deceptive Install Progress Message ===
  # Supply-chain packages print fake "Installing dependencies" messages
  # to social-engineer users into waiting while malicious code runs
  - id: deceptive-install-message
    desc: Deceptive install progress message
    crit: suspicious
    conf: 0.85
    attack: "T1204.001"
    if:
      type: string
      regex: '[Ii]nstalling dependencies.{0,50}(?:please wait|please be patient)'

  # === Surveillance/RAT Dependency Installation ===
  # Mass installation of surveillance-capable libraries (screenshots, keylogging,
  # clipboard, input control) via pip is a strong RAT staging indicator
  - id: surveillance-deps-install
    desc: Surveillance library mass installation
    crit: suspicious
    conf: 0.9
    attack: "T1059.006"
    if:
      type: string
      regex: 'pip install.{0,200}(?:pyscreenshot|pynput|pydirectinput|pyperclip|keyring)'

  # === Windows cmd /c move (file rename staging) ===
  # Dropper pattern: rename downloaded file to executable extension before execution.
  # Common in Python supply-chain attacks that download payload → rename to .bat → execute.
  - id: cmd-move-rename
    desc: Windows cmd /c move file rename
    crit: notable
    conf: 0.85
    attack: "T1036.005"
    if:
      type: string
      regex: 'cmd /c move\b'

  # === Windows cmd /c del (artifact cleanup) ===
  # Post-execution cleanup: delete the dropped payload after running it.
  # Dropper anti-forensics pattern.
  - id: cmd-del-cleanup
    desc: Windows cmd /c del artifact cleanup
    crit: notable
    conf: 0.85
    attack: "T1070.004"
    if:
      type: string
      regex: 'cmd /c del\b'

  # === Windows admin privilege check via net session ===
  # net session returns "Access is denied" for non-admin users.
  # Malware uses this to gate privileged payloads.
  - id: net-session-admin-check
    desc: Windows admin check via net session
    crit: suspicious
    conf: 0.9
    attack: "T1033"
    if:
      type: raw
      substr: "net session"

  # === COM automation import in setup.py ===
  # setup.py importing win32com.client (COM automation) is a strong supply-chain
  # indicator. Used by extension dropper families to manipulate Windows shortcuts
  # via WScript.Shell COM objects. No legitimate package imports COM automation
  # in its setup.py.
  - id: setup-py-win32com-import
    desc: COM automation import in setup.py
    crit: suspicious
    conf: 0.90
    attack: "T1559.001"
    if:
      type: raw
      substr: "from win32com.client import Dispatch"

  # === Directory creation in setup.py ===
  # setup.py using os.path.exists + os.makedirs to create directories
  # is dropper staging behavior — creating drop locations for payloads.
  - id: setup-py-mkdir-staging
    desc: Directory staging in setup.py
    crit: notable
    conf: 0.85
    attack: "T1074.001"
    if:
      type: raw
      substr: "os.path.exists"

  # === Environment variable access in setup.py ===
  # setup.py using os.getenv to access environment variables (APPDATA, LOCALAPPDATA, etc.)
  # is a strong supply-chain indicator. Legitimate setup.py uses setup() kwargs
  # or environment markers, not os.getenv for directory resolution.
  - id: setup-py-getenv
    desc: Environment variable access in setup.py
    crit: notable
    conf: 0.85
    attack: "T1082"
    if:
      type: raw
      substr: "os.getenv"

  # === Social engineering admin install prompt ===
  # Typosquat packages urge users to install with admin/root privileges.
  # Legitimate packages rarely request elevated permissions in descriptions.
  - id: admin-install-social-engineering
    desc: Social engineering admin install request
    crit: suspicious
    conf: 0.9
    attack: "T1204.001"
    if:
      type: string
      regex: '(?:admin|root|elevated|sudo).{0,15}(?:permission|privilege|right).{0,15}(?:install|run|solv)'
      case_insensitive: true

  # === pip install command string ===
  # Atomic trait for pip install commands in strings (e.g., inside os.system)
  - id: pip-install-string
    desc: pip install command string
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: 'pip.{0,20}install'

  # === pip module string ===
  # Atomic trait for pip module reference (e.g. -m pip)
  - id: pip-module-string
    desc: pip module reference string
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: '-m\s+pip'

composite_rules:
  # === Robust setup.py indicator ===
  # Combines multiple ways to identify a setup.py file
  - id: robust-setup-py
    desc: setup.py installation file
    crit: inert
    conf: 1.0
    any:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: obj/lateral/supply-chain/pypi/install-patterns::setuptools-setup-call
      - id: distutils-import-content

  # === Command Execution Composite ===
  - id: python-command-exec
    desc: Python command execution
    crit: notable
    conf: 0.85
    any:
      - id: cap/process/create/shell::python-os-system
      - id: cap/process/create/subprocess::methods

  # === HOSTILE: PyPI Auto-Install Dropper ===
  - id: pypi-install-autoinstall-dropper
    desc: PyPI setup.py executes pip install command
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    attack: "T1195.002"
    all:
      - id: robust-setup-py
      - id: python-command-exec
    any:
      - id: pip-install-string
      - id: pip-module-string
      - id: obj/exec/autoinstall/pip::pip-install-pattern

  # === Windows Command Execution ===
  - id: windows-start-exec
    desc: Windows start command with executable
    crit: suspicious
    conf: 0.9
    all:
      - id: windows-start-command
      - id: python-command-exec

  # === Executable Download Pattern ===
  # HTTP request + executable extension
  - id: executable-download
    desc: Downloads executable file
    crit: suspicious
    conf: 0.9
    all:
      - id: cap/comm/http/request::request-python
      - id: executable-download-url

  # === Binary File Drop ===
  # Writing binary content to file system
  - id: binary-file-drop
    desc: Binary file write to disk
    crit: suspicious
    conf: 0.85
    all:
      - id: binary-file-write
      - id: exe-file-extension
    any:
      - id: python-command-exec
      - id: cap/comm/http/request::request-python
    unless:
      - id: meta/builder/pip::setuptools-package-index

  # === .scr to .exe Extension Mismatch ===
  - id: scr-to-exe-mismatch
    desc: .scr to .exe extension mismatch (dropper pattern)
    crit: hostile
    conf: 0.98
    all:
      - id: scr-file-extension
      - id: exe-file-extension
    any:
      - id: binary-file-write
      - id: open-write-content

  # === HOSTILE: PyPI Install-Time Dropper ===
  - id: pypi-install-dropper
    desc: PyPI install-time dropper
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1204.002"
    all:
      - id: robust-setup-py
      - id: cap/comm/http/request::request-python
      - id: binary-file-write
      - id: python-command-exec

  # === HOSTILE: PyPI Install-Time Downloader ===
  # setup.py downloads content and writes it to a file, then executes it.
  # More generic than pypi-install-dropper (doesn't require 'wb' mode).
  - id: pypi-install-downloader
    desc: PyPI install-time downloader and executor
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1204.002"
    all:
      - id: robust-setup-py
      - id: cap/comm/http/request::request-python
      - id: setup-py-file-write
      - id: python-command-exec

  # === HOSTILE: Download-Execute Chain ===
  - id: download-execute-chain
    desc: Downloads and executes file
    crit: hostile
    conf: 0.92
    mbc: "E1204"
    attack: "T1204.002"
    all:
      - id: executable-download
      - id: binary-file-write
      - id: python-command-exec

  # === HOSTILE: PyPI Setup.py C2 Dropper ===
  - id: pypi-c2-dropper
    desc: PyPI setup.py downloads and executes C2 payload
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1204.002"
    all:
      - id: robust-setup-py
      - id: obj/c2/infrastructure/ip::http-raw-ip-url
      - id: binary-file-write
      - id: cap/process/create/subprocess::methods

  # === Windows File Rename-Execute-Delete Dropper ===
  - id: windows-rename-execute-delete
    desc: Windows file rename-execute-delete dropper chain
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1059.003"
    all:
      - id: cap/process/create/shell::cmd-exe
      - id: cmd-move-rename
      - id: cmd-del-cleanup

  # === HOSTILE: PyPI Browser Extension Dropper ===
  - id: pypi-browser-extension-dropper
    desc: PyPI package drops browser extension via shortcut hijack
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1176"
    all:
      - id: robust-setup-py
      - id: obj/exec/autoinstall/pip::main-call-content
      - id: obj/persist/startup/registry::windows-shortcut-argument-injection
      - id: obj/anti-static/obfuscation/code::advanced-python-obfuscation

  # === HOSTILE: PyPI Shortcut Hijack Dropper ===
  - id: pypi-shortcut-hijack-dropper
    desc: PyPI package enumerates and hijacks browser shortcuts
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1176"
    all:
      - id: robust-setup-py
      - id: obj/exec/autoinstall/pip::main-call-content
      - id: obj/persist/startup/registry::windows-shortcut-walk-modify
      - id: cap/fs/directory/mkdir::mkdir-python

  # === HOSTILE: PyPI COM Automation Extension Dropper ===
  - id: pypi-com-extension-dropper
    desc: PyPI setup.py uses COM automation to drop extension
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1176"
    all:
      - id: setup-py-win32com-import
      - id: setup-py-getenv
      - id: setup-py-file-write
      - id: obj/persist/startup/registry::create-shortcut

  # === SUSPICIOUS: Browser Shortcut Target Fingerprinting ===
  - id: shortcut-target-browser-fingerprint
    desc: Browser fingerprinting via shortcut TargetPath
    crit: suspicious
    conf: 0.90
    attack: "T1518"
    all:
      - id: setup-py-shortcut-target-fingerprint
      - id: obj/persist/startup/registry::shortcut-target-path
    any:
      - id: obj/persist/startup/registry::shortcut-arguments
      - id: obj/persist/startup/registry::create-shortcut

  # === HOSTILE: Install-Time Gated Execution ===
  - id: install-time-gated-execution
    desc: Platform-gated install-time execution in setup.py
    crit: hostile
    conf: 0.90
    mbc: "B0024"
    attack: "T1195.002"
    all:
      - id: robust-setup-py
      - id: cap/os/info/system::sys-platform-check
      - id: cap/os/info/system::sys-argv-access
      - id: obj/exec/autoinstall/pip::main-call-content
    downgrade:
      any:
        - id: meta/quality/versioned

  # === HOSTILE: Obfuscated Setup.py File Dropper ===
  - id: obfuscated-setup-py-file-dropper
    desc: Obfuscated setup.py writes payload files to disk
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1195.002"
    all:
      - id: robust-setup-py
      - id: obj/anti-static/obfuscation/code::advanced-python-obfuscation
      - id: setup-py-file-write
      - id: cap/fs/directory/mkdir::mkdir-python

  # === HOSTILE: PyPI PowerShell Dropper ===
  - id: pypi-powershell-dropper
    desc: PyPI setup.py PowerShell download-execute chain
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1059.001"
    all:
      - id: robust-setup-py
      - id: obj/exec/dropper/stealth::subprocess-popen
      - id: powershell-download-in-string
      - id: obj/exec/background/daemon::powershell-hidden

  # === HOSTILE: PyPI PowerShell Encoded Dropper ===
  - id: pypi-powershell-encoded-dropper
    desc: PyPI setup.py with encoded PowerShell payload
    crit: hostile
    conf: 0.98
    mbc: "E1204"
    attack: "T1059.001"
    all:
      - id: robust-setup-py
      - id: obj/exec/dropper/stealth::subprocess-popen
      - id: powershell-encoded-command-in-string
      - id: obj/exec/background/daemon::powershell-hidden

  # === HOSTILE: PyPI Setup.py PowerShell Stager ===
  - id: pypi-powershell-stager
    desc: PyPI setup.py downloads and stages hidden payload
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    attack: "T1195.002"
    all:
      - id: robust-setup-py
      - id: powershell-download-in-string
      - id: powershell-expand-archive
      - id: obj/exec/interpreter/vbscript/interpreter::vbs-powershell-launch

  # === HOSTILE: PyPI Extension Dropper with Admin Gating ===
  - id: pypi-extension-dropper-admin-gated
    desc: PyPI setup.py drops extension with admin gating
    crit: hostile
    conf: 0.95
    mbc: "E1204"
    attack: "T1195.002"
    all:
      - id: setup-py-getenv
      - id: cap/os/admin/check::ctypes-is-admin
      - id: cap/fs/directory/mkdir::mkdir-python
      - id: setup-py-file-write

  # === HOSTILE: Windows Impersonation Dropper ===
  - id: python-impersonation-dropper
    desc: Fake Python release dropper
    crit: hostile
    conf: 0.98
    mbc: "E1204"
    attack: "T1036.005"
    all:
      - id: python-release-impersonation-url
      - id: binary-file-write
      - id: python-command-exec