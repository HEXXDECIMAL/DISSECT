# Supply Chain - Dropper in Python Module Init
# Detects malware that downloads and executes payloads during module initialization
# Common pattern: platform detection -> download binary -> chmod -> execute -> delete
# ATT&CK: T1195.002 (Supply Chain Compromise), T1059.006 (Python)
# MBC: B0024 (Dropper)

defaults:
  for: [python]
  mbc: "B0024"
  attack: "T1195.002"

traits:
  # Platform detection in module init (suspicious when combined with other indicators)
  - id: platform-system-call
    desc: platform.system() OS detection
    crit: notable
    conf: 0.6
    if:
      type: ast
      kind: call
      regex: "platform\\.system\\(\\)"

  - id: platform-machine-call
    desc: platform.machine() architecture detection
    crit: notable
    conf: 0.6
    if:
      type: ast
      kind: call
      regex: "platform\\.machine\\(\\)"

  # Combined OS and arch detection (common in droppers targeting specific platforms)
  - id: platform-checks
    desc: Combined platform.system and platform.machine
    crit: notable
    conf: 0.75
    if:
      type: raw
      regex: "platform\\.system.{0,50}platform\\.machine|platform\\.machine.{0,50}platform\\.system"

  # OS string checks (match extracted string literals)
  - id: linux-string-check
    desc: Linux OS string in condition
    crit: notable
    conf: 0.5
    if:
      type: string
      word: "Linux"

  - id: darwin-string-check
    desc: Darwin/macOS string in condition
    crit: notable
    conf: 0.5
    if:
      type: string
      word: "Darwin"

  - id: arch-string-check
    desc: Architecture string checks
    crit: notable
    conf: 0.5
    if:
      type: raw
      regex: '"(x86|AMD64|arm64|aarch64)" in platform'

  # Import of safe_download or similar dropper functions
  - id: import-safe-download
    desc: safe_download function import
    crit: notable
    conf: 0.7
    if:
      type: raw
      substr: "import safe_download"

  # Combination: download function with delete=True
  - id: download-with-delete
    desc: Download with delete=True parameter
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      substr: "delete=True"

  # Download and run function call pattern
  - id: safe-run-call
    desc: Call to safe_run execution function
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      regex: "safe_run\\s*\\("

  # os.system shell execution (common in init droppers)
  - id: os-system-call
    desc: os.system() shell execution
    crit: notable
    conf: 0.70
    if:
      type: ast
      kind: call
      regex: "os\\.system\\("

  # Platform check with os.system in same file (dropper pattern)
  - id: platform-os-system-combo
    desc: Platform check with os.system
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: "platform\\.system.{0,50}os\\.system|os\\.system.{0,50}platform\\.system"

  # Inline shell download+execute pattern: wget ... && tar ... && ./
  - id: inline-wget-exec
    desc: Inline wget download and execute
    crit: suspicious
    conf: 0.90
    if:
      type: string
      regex: "wget\\s+https?://.{10,300}&&.{0,50}(tar|chmod|\\./)"

  # nohup background execution
  - id: nohup-background
    desc: nohup background execution
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "nohup\\s+\\./[a-zA-Z_]"

  # Linux platform conditional
  - id: linux-in-platform
    desc: Linux in platform.system() check
    crit: notable
    conf: 0.6
    mbc: "B0012"
    attack: "T1082"
    if:
      type: raw
      substr: '"Linux" in platform.system()'

composite_rules:
  # Platform-targeted dropper detection
  - id: platform-targeted-download
    desc: Platform-targeted binary download
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    for: [python]
    needs: 2
    any:
      - id: platform-checks
      - id: linux-string-check
      - id: darwin-string-check
      - id: arch-string-check
    all:
      - id: cap/exec/dropper/tmp-run::tmp-path

  # Full dropper pattern: detect platform, download, execute
  - id: init-dropper
    desc: Supply chain dropper in module init
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    for: [python]
    needs: 3
    any:
      - id: platform-checks
      - id: linux-string-check
      - id: darwin-string-check
      - id: arch-string-check
      - id: download-with-delete
      - id: safe-run-call
      - id: import-safe-download
      - id: cap/exec/dropper/tmp-run::tmp-path
      - id: cap/exec/dropper/tmp-run::tmp-path-short
      - id: os-system-call
      - id: platform-os-system-combo
      - id: inline-wget-exec
      - id: nohup-background
      - id: linux-in-platform

  # os.system with wget dropper pattern (Ultralytics-style)
  - id: os-system-wget-dropper
    desc: os.system wget download and execute
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    for: [python]
    all:
      - id: os-system-call
      - id: inline-wget-exec
