# GitPython Malicious Usage Detection
# Detects malware using GitPython for malicious cloning during install
# ATT&CK: T1071.001 (Web Protocols), T1105 (Ingress Tool Transfer)
# MBC: E1105 (Tool Transfer)

defaults:
  crit: suspicious
  attack: "T1071.001"
  mbc: "E1105"
  for: [python]

traits:
  # === GitPython Import ===
  - id: gitpython-import
    desc: GitPython import
    crit: notable
    conf: 0.70
    if:
      type: string
      substr: "gitpython"

  - id: git-module-import
    desc: Git module import
    crit: notable
    conf: 0.70
    if:
      type: string
      exact: "git"

  # === Malicious Cloning Patterns ===
  - id: git-clone-url
    desc: Git clone with URL
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "git\\.Git.{0,50}clone|clone.{0,50}github\\.com"

  - id: git-clone-in-setup
    desc: Git clone during setup
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "install.{0,50}clone|clone.{0,50}install|setup.{0,50}clone"

  # === Suspicious Repo Names ===
  - id: obfuscated-repo-name
    desc: Obfuscated repository name
    crit: suspicious
    conf: 0.70
    if:
      type: string
      regex: "(not|no|anti|un|dis).{0,50}(grabber|logger|stealer|malware|virus)|^[a-z]{8,15}[0-9]{2,4}$"

  # === Post-Install Execution ===
  - id: cmdclass-custom-install
    desc: Custom install command class
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: "cmdclass.{0,50}install|CustomInstallCommand"

  - id: install-hook-execution
    desc: Install hook execution
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "class.{0,50}install.{0,50}run|def run.{0,50}install"

composite_rules:
  # === GitPython Malicious Usage ===
  - id: gitpython-malicious-clone
    desc: GitPython malicious cloning
    crit: suspicious
    conf: 0.90
    attack: "T1105"
    r#for: [python]
    count_min: 2
    any:
      - id: git-clone-url
      - id: git-clone-in-setup
      - id: cap/data/text/malware/suspicious-repo-name
    all:
      - id: gitpython-import

  - id: supply-chain-gitclone
    desc: Supply chain via git clone
    crit: suspicious
    conf: 0.95
    attack: "T1071.001"
    mbc: "E1105"
    platforms: [all]
    count_min: 2
    any:
      - id: gitpython-malicious-clone
      - id: cmdclass-custom-install
      - id: install-hook-execution
