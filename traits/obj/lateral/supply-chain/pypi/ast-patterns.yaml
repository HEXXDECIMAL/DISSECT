# Supply Chain AST Pattern Detection
# Uses AST patterns to detect suspicious setup.py structures
# ATT&CK: T1195.001 (Supply Chain)
# MBC: B0030 (C2 Communication)

defaults:
  crit: suspicious
  attack: "T1195.001"
  mbc: "B0030"
  for: [python]

traits:
  # === AST Pattern: Import Inside Method ===
  - id: ast-import-in-method
    desc: Import inside method body
    crit: suspicious
    conf: 0.80
    if:
      type: ast
      kind: function
      regex: "def run\\(self\\):.{0,50}^\\s+import"

  # === AST Pattern: Method Override ===
  - id: ast-install-method-override
    desc: Override install run method
    crit: suspicious
    conf: 0.85
    if:
      type: ast
      kind: function
      exact: "def run\\(self\\):"

  # === AST Pattern: Sequential Clone Calls ===
  - id: ast-multiple-clone-calls
    desc: Multiple clone() calls in function
    crit: suspicious
    conf: 0.85
    if:
      type: ast
      kind: call
      exact: "\\.clone\\(.{0,50}\\)"
      count_min: 2

  # === AST Pattern: Environment Set in Method ===
  - id: ast-env-set-in-method
    desc: Environment manipulation in method
    crit: notable
    conf: 0.70
    if:
      type: ast
      kind: assignment
      exact: "os\\.environ\\[.{0,50}\\]"

  # === AST Pattern: Sequential File Operations ===
  - id: ast-clone-move-execute-chain
    desc: Clone move execute chain
    crit: suspicious
    conf: 0.90
    if:
      type: ast
      kind: call
      exact: "(clone|rename|startfile)"
      count_min: 3

  # === AST Pattern: cmdclass with Custom Install ===
  - id: ast-cmdclass-install-override
    desc: cmdclass install override
    crit: suspicious
    conf: 0.85
    if:
      type: ast
      node: keyword_argument
      exact: "cmdclass.{0,50}install"

composite_rules:
  # === AST-Based Supply Chain Detection ===
  - id: ast-supply-chain-hook
    desc: Supply chain hook via AST
    crit: suspicious
    conf: 0.90
    attack: "T1195.001"
    file_types: [python]
    count_min: 2
    any:
      - id: ast-import-in-method
      - id: ast-install-method-override
      - id: ast-cmdclass-install-override

  - id: ast-multi-stage-payload
    desc: Multi-stage payload delivery AST
    crit: hostile
    conf: 0.95
    attack: "T1195.001"
    mbc: "E1105"
    platforms: [all]
    all:
      - id: ast-multiple-clone-calls
      - id: ast-clone-move-execute-chain
