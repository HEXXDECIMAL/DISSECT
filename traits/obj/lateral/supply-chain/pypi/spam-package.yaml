# PyPI Supply-Chain Attack Patterns
# Affiliate spam and SEO abuse packages
# ATT&CK: T1195.002 (Compromise Software Supply Chain)

defaults:
  for: [python]
  attack: "T1195.002"

traits:
  # === Affiliate Link Spam ===
  # Packages that exist only to redirect users to affiliate/spam URLs
  # These packages abuse PyPI as a distribution channel for spam

  - id: clickbank-affiliate-url
    desc: Clickbank affiliate link URL
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "hop\\.clickbank\\.net"

  - id: affiliate-network-url
    desc: Affiliate network redirect URL
    crit: suspicious
    conf: 0.9
    if:
      type: string
      # Common affiliate networks used for spam
      regex: "\\b(?:hop\\.clickbank\\.net|jvz[0-9]*\\.com|warriorplus\\.com|digistore24\\.com|clickbooth\\.com|shareasale\\.com|cj\\.com|impact\\.com)\\b"
    not:
      - type: string
        regex: "^https?://(?:www\\.)?(?:shareasale|cj|impact)\\.com/?$"  # Homepages OK

  - id: tid-tracking-param
    desc: tid= tracking parameter in URL
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "[?&]tid="

  # === SEO Spam Package Names ===
  # Package names designed to exploit search engines

  - id: free-download-in-name
    desc: Free Download spam text
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "\\bfree\\s+download\\b"
      case_insensitive: true

  # === Dynamic Dependency Injection ===
  # Reading requirements from external file at install time
  # This can be used to inject malicious dependencies

  - id: dynamic-install-requires
    desc: Dynamic install_requires from file
    crit: notable
    conf: 0.85
    if:
      type: content
      regex: "install_requires\\s*=\\s*\\w+\\.read\\(|install_requires\\s*=\\s*read_requirements"

composite_rules:
  # === SUSPICIOUS: Affiliate Spam Package ===
  # Setup.py with affiliate network URL - PyPI abuse for spam distribution
  # Complexity: for(+1) + all(+2) = 3 (SUSPICIOUS)
  - id: pypi-affiliate-spam
    desc: PyPI package with affiliate spam URL
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1195.002"
    all:
      - id: obj/lateral/supply-chain/pypi::setup-py-file
      - id: affiliate-network-url

  # === SUSPICIOUS: Clickbank Affiliate Package ===
  # Specifically Clickbank which is heavily abused for spam
  # Complexity: for(+1) + all(+2) = 3 (SUSPICIOUS)
  - id: pypi-clickbank-spam
    desc: PyPI package with Clickbank affiliate link
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1195.002"
    all:
      - id: obj/lateral/supply-chain/pypi::setup-py-file
      - id: clickbank-affiliate-url

  # === SUSPICIOUS: SEO Spam Package ===
  # Package with "Free Download" and affiliate URL
  # Complexity: for(+1) + all(+2) = 3 (SUSPICIOUS)
  - id: pypi-seo-spam-package
    desc: PyPI SEO spam package
    crit: suspicious
    conf: 0.92
    mbc: "B0024"
    attack: "T1195.002"
    all:
      - id: free-download-in-name
      - id: affiliate-network-url
