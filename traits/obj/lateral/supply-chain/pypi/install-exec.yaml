# Supply Chain - Install-time Code Execution (Python)
# Detects malicious code executed during package installation
# Common in typosquatting attacks and supply chain compromises
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)

defaults:
  for: [python]
  mbc: "B0030"
  attack: "T1195.002"

traits:
  # os.system call at module level (outside functions)
  - id: module-level-system
    desc: "os.system at module level (install-time"
    crit: suspicious
    conf: 0.85
    if:
      type: ast
      query: |
        ((module
          (expression_statement
            (call
              function: (attribute
                object: (identifier) @mod
                attribute: (identifier) @meth))))
         (#eq? @mod "os")
         (#eq? @meth "system"))
    downgrade:
      none:
        - type: basename
          exact: "setup.py"
        - type: basename
          exact: "__init__.py"

  # Import-triggered execution
  - id: import-trigger
    desc: "Code execution triggered by import"
    crit: suspicious
    conf: 0.8
    if:
      type: string
      # os.system or subprocess at top-level in __init__.py
      regex: "^(import|from).{0,100}\\n.{0,100}os\\.system|^(import|from).{0,100}\\n.{0,100}subprocess\\."

  # Try-except ImportError with installation
  - id: import-fallback-install
    desc: "Import fallback with automatic package"
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "except\\s*(ImportError)?.{0,50}:\\s*\\n?\\s*(os\\.system|subprocess)"

  # NOTE: YARA kept for setup-py-exec - requires NOT conditions to exclude legitimate
  # patterns (setup.py sdist, bdist_wheel, twine, pytest, etc.). DISSECT doesn't support
  # NOT conditions in composite rules yet.
  - id: setup-py-exec-yara-core
    desc: "setup.py exec/network markers (YARA)"
    crit: inert
    conf: 0.95
    if:
      type: yara
      source: |
        rule setup_py_malicious_exec {
          meta:
            description = "Detects setup.py files with code execution or network activity"
          strings:
            $setup = "setup(" ascii
            $setuptools = "from setuptools" ascii
            $distutils = "from distutils" ascii
            $os_system = "os.system(" ascii
            $subprocess = "subprocess." ascii
            $exec = "exec(" ascii
            $eval = "eval(" ascii
            $pip = "pip install" ascii nocase
            // Network activity
            $requests = "requests." ascii
            $urllib = "urllib." ascii
            $aiohttp = "aiohttp" ascii
            $httpx = "httpx" ascii
            $socket = "socket." ascii
            $webhook = "webhook" ascii nocase
            // Legitimate publishing/build patterns (excludes)
            $legit_sdist = "setup.py sdist" ascii nocase
            $legit_bdist = "bdist_wheel" ascii nocase
            $legit_twine = "twine upload" ascii nocase
            $legit_test = "setup.py test" ascii nocase
            $legit_pytest = "def test_" ascii
            // Reading version file with exec is common
            $legit_version_exec = "exec(f.read()" ascii
            $legit_version_exec2 = "exec(open(" ascii
            $legit_version_exec3 = "exec(compile(" ascii
            $legit_literal_eval = "ast.literal_eval" ascii
            // Testing commands
            $legit_develop = "setup.py develop" ascii nocase
            // Compiler/tool version checking (subprocess + --version)
            $legit_version_check = "'--version'" ascii
            $legit_version_check2 = "\"--version\"" ascii
            // Git revision checking (subprocess + git rev-parse)
            $legit_git_rev = "rev-parse" ascii
            // Scientific / complex build patterns
            $legit_numpy = "numpy.distutils" ascii
            $legit_config = "Configuration(" ascii
          condition:
            ($setup or $setuptools or $distutils) and
            ($os_system or $subprocess or $exec or $eval or $pip or $requests or $urllib or $aiohttp or $httpx or $socket or $webhook) and
            // Exclude if any legitimate publishing/build patterns found
            not any of ($legit*)
        }

  # NOTE: YARA kept for init-py-exec - requires NOT conditions to exclude legitimate
  # patterns (pypi.org, readthedocs, github.com, setup tools, etc.)
  - id: init-py-exec-yara-core
    desc: "__init__.py with immediate code execution (YARA core)"
    crit: inert
    conf: 0.9
    mbc: "B0030"
    if:
      type: yara
      source: |
        rule init_py_malicious_exec {
          meta:
            description = "Detects __init__.py with immediate code execution"
          strings:
            $init_marker = "__version__" ascii
            $os_system = "os.system(" ascii
            $subprocess_run = "subprocess.run(" ascii
            $subprocess_call = "subprocess.call(" ascii
            $subprocess_popen = "subprocess.Popen(" ascii
            $pip = "pip install" ascii nocase
            $http = /https?:\/\// ascii
            // Legitimate patterns (excludes)
            $legit_sdist = "setup.py sdist" ascii nocase
            $legit_bdist = "bdist_wheel" ascii nocase
            $legit_twine = "twine upload" ascii nocase
            $legit_setup = "from setuptools" ascii
            $legit_version_read = "exec(f.read()" ascii
            $legit_version_read2 = "exec(open(" ascii
            $legit_pypi = "pypi.org" ascii nocase
            $legit_readthedocs = "readthedocs" ascii nocase
            $legit_github = "github.com" ascii nocase
            $legit_version_check = "'--version'" ascii
            $legit_version_check2 = "'-version'" ascii
          condition:
            $init_marker and
            ($os_system or $subprocess_run or $subprocess_call or $subprocess_popen) and
            ($pip or $http) and
            // Exclude if any legitimate publishing/build patterns found
            not any of ($legit*)
        }

  # NOTE: YARA kept for dependency-injection - requires combining try/except ImportError
  # with pip install patterns in a specific structural way that's difficult to express
  # with simple atomic + composite rules
  # Requires subprocess execution, not just sys.executable reference
  - id: dependency-injection-yara
    desc: "Package installs additional dependencies at"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    if:
      type: yara
      source: |
        rule runtime_dependency_injection {
          meta:
            description = "Package that installs dependencies during import/setup"
          strings:
            $try = "try:" ascii
            $except = /except\s*(ImportError)?:/
            $import = /import\s+\\w+/ ascii
            $pip_install = "pip install" ascii nocase
            $subprocess = "subprocess" ascii
            // Legitimate test code markers
            $pytest = "pytest" ascii
            $test = "def test_" ascii
          condition:
            $try and $except and $import and $pip_install and $subprocess and
            not any of ($pytest, $test)
        }

composite_rules:
  - id: setup-py-exec-yara
    desc: "setup.py with suspicious code execution"
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1195.002"
    all:
      - id: obj/lateral/supply-chain/pypi::setup-py-file
      - id: setup-py-exec-yara-core
    unless:
      - type: content
        regex: "scipy|numpy|docutils"

  - id: init-py-exec-yara
    desc: "__init__.py with immediate code execution"
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1195.002"
    all:
      - id: obj/lateral/supply-chain/pypi::init-py-file
      - id: init-py-exec-yara-core
