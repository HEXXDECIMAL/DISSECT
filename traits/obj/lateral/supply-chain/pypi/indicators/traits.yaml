# Composite Metadata Detection Rules
# Complex patterns combining multiple metadata anomalies

composite_rules:
  # === Dependency Confusion Indicators Helper ===
  - id: depconf-victim-indicators
    desc: Dependency confusion victim-targeting language
    crit: notable
    conf: 0.90
    attack: "T1195.002"
    for: [all]
    platforms: [all]
    any:
      - id: obj/lateral/supply-chain/pypi/depconf

  # === No Description Helper ===
  - id: pkginfo-no-description
    desc: PKG-INFO with empty or missing description
    crit: notable
    conf: 0.70
    for: [all]
    platforms: [all]
    any:
      - id: obj/lateral/supply-chain/pypi/description::pkginfo-no-description-body
      - id: obj/lateral/supply-chain/pypi/description::pkginfo-missing-description

  # === Throwaway Package Indicators ===
  - id: pkginfo-low-effort-indicators
    desc: PKG-INFO with low-effort package indicators
    crit: notable
    conf: 0.70
    attack: "T1036.005"
    for: [all]
    platforms: [all]
    any:
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-free-hosting-homepage
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-security-claim

  # === Cloned README Body Indicators ===
  - id: pkginfo-cloned-readme-body
    desc: PKG-INFO body with cloned library README content
    crit: notable
    conf: 0.80
    attack: "T1036.005"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    any:
      - id: obj/lateral/supply-chain/pypi/cloned-body

  # === Suspicious Metadata Profile ===
  - id: suspicious-setup-metadata
    desc: Suspicious setup.py metadata
    crit: suspicious
    conf: 0.80
    attack: "T1036.005"
    for: [python]
    needs: 3
    any:
      - id: obj/lateral/supply-chain/pypi/description::minimal-description
      - id: obj/lateral/supply-chain/pypi/author::placeholder-author
      - id: obj/lateral/supply-chain/pypi/email::generic-email
      - id: obj/lateral/supply-chain/pypi/version::suspicious-version-pattern
      - id: obj/lateral/supply-chain/pypi/keywords::typosquatting-keyword

  - id: malware-setup-profile
    desc: Malicious setup.py profile
    crit: suspicious
    conf: 0.85
    attack: "T1036.005"
    mbc: "F0004"
    platforms: [all]
    needs: 4
    any:
      - id: suspicious-setup-metadata
      - id: obj/lateral/supply-chain/pypi/keywords::empty-keywords
      - id: obj/lateral/supply-chain/pypi/general::empty-classifiers
      - id: obj/lateral/supply-chain/pypi/description::single-word-description

  # === PKG-INFO Metadata Anomalies ===
  - id: pkg-info-unknown-fields
    desc: PKG-INFO with UNKNOWN metadata fields
    crit: notable
    conf: 0.75
    attack: "T1036.005"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    needs: 3
    any:
      - id: obj/lateral/supply-chain/pypi/summary::unknown-summary
      - id: obj/lateral/supply-chain/pypi/homepage::unknown-homepage
      - id: obj/lateral/supply-chain/pypi/author::unknown-author
      - id: obj/lateral/supply-chain/pypi/general::unknown-license
      - id: obj/lateral/supply-chain/pypi/general::unknown-platform
      - id: obj/lateral/supply-chain/pypi/description::unknown-description
      - id: obj/lateral/supply-chain/pypi/email::unknown-author-email

  # === All-UNKNOWN Metadata Package ===
  - id: pkginfo-all-unknown-metadata
    desc: PKG-INFO with all metadata fields UNKNOWN
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/summary::unknown-summary
      - id: obj/lateral/supply-chain/pypi/homepage::unknown-homepage
      - id: obj/lateral/supply-chain/pypi/author::unknown-author
      - id: obj/lateral/supply-chain/pypi/description::unknown-description
      - id: obj/lateral/supply-chain/pypi/email::unknown-author-email
    none:
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-dev-version

  # === Social Engineering Supply Chain Package ===
  - id: pkg-info-privilege-social-engineering
    desc: PKG-INFO requests elevated install privileges
    crit: suspicious
    conf: 0.92
    attack: "T1204.001"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/summary::summary-requests-admin
      - id: obj/lateral/supply-chain/pypi/general::unknown-platform

  # === PKG-INFO with Malware-Related Keywords ===
  - id: pkg-info-malware-keywords
    desc: PKG-INFO with malware-related keywords
    crit: suspicious
    conf: 0.92
    attack: "T1036.005"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/keywords::malware-keyword-in-keywords

  # === PoC/Beacon Package with Placeholder Metadata ===
  - id: poc-beacon-placeholder-package
    desc: PoC/beacon package with placeholder metadata
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: depconf-victim-indicators
      - id: obj/lateral/supply-chain/pypi/author::placeholder-author-pkginfo

  # === Throwaway Package Profile ===
  - id: pkginfo-throwaway-package
    desc: PKG-INFO with throwaway package indicators
    crit: suspicious
    conf: 0.85
    attack: "T1036.005"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/general::unknown-platform
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-lowest-version
      - id: pkginfo-low-effort-indicators

  # === Dependency Confusion Package ===
  - id: depconf-victim-package
    desc: Dependency confusion package targeting victims
    crit: hostile
    conf: 0.92
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/version::depconf-high-version
      - id: obj/lateral/supply-chain/pypi/depconf::summary-mentions-victim
      - id: obj/lateral/supply-chain/pypi/depconf::summary-poc-research
      - id: obj/lateral/supply-chain/pypi/depconf::summary-confirms-install

  # === Dependency Confusion setup.py ===
  - id: depconf-victim-setup-py
    desc: Dependency confusion setup.py targeting victims
    crit: hostile
    conf: 0.92
    attack: "T1195.002"
    mbc: "F0004"
    for: [python]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: obj/lateral/supply-chain/pypi/description::desc-mentions-victim
      - id: obj/lateral/supply-chain/pypi/description::desc-poc-research
      - id: obj/lateral/supply-chain/pypi/description::desc-confirms-install

  # === Minimal PKG-INFO Shell Package ===
  - id: pkginfo-minimal-shell-package
    desc: Minimal PKG-INFO shell package
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-single-word-summary
      - id: obj/lateral/supply-chain/pypi/general::pkginfo-tiny
    none:
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-dev-version

  # === Tiny PKG-INFO with Lowest Version ===
  - id: pkginfo-skeleton-package
    desc: Skeleton PKG-INFO with lowest version
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-lowest-version
      - id: obj/lateral/supply-chain/pypi/general::pkginfo-tiny

  # === PKG-INFO with Low Version and Minimal Summary ===
  - id: pkginfo-low-version-minimal-summary
    desc: PKG-INFO with low version and minimal summary
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-lowest-version
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-single-word-summary

  # === PKG-INFO with Low Version and Offensive Tool Description ===
  - id: pkginfo-low-version-offensive-description
    desc: PKG-INFO with low version and offensive tool description
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-lowest-version
      - id: obj/lateral/scan/port::brute-force-ref

  # === PKG-INFO Placeholder Package ===
  - id: pkginfo-placeholder-package
    desc: PKG-INFO with placeholder summary and empty description body
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: pkginfo-no-description
    any:
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-placeholder-summary
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-low-effort-summary

  # === PKG-INFO with Stripped Metadata ===
  - id: pkginfo-stripped-metadata-package
    desc: PKG-INFO with stripped metadata fields
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-no-summary
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-no-homepage
      - id: obj/lateral/supply-chain/pypi/author::pkginfo-short-author

  # === PKG-INFO Skeleton Supply-Chain Package ===
  - id: pkginfo-skeleton-supply-chain-package
    desc: Skeleton PKG-INFO with no contact or description
    crit: hostile
    conf: 0.92
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-no-summary
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-no-homepage
      - id: obj/lateral/supply-chain/pypi/author::pkginfo-short-author
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-no-author-email

  # === PKG-INFO with Anonymous Email + Missing Metadata ===
  - id: pkginfo-anonymous-author-skeleton
    desc: PKG-INFO with anonymous email and sparse metadata
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-no-homepage
      - id: pkginfo-no-description

  # === pyproject.toml Anonymous Email + Missing Metadata ===
  - id: pyproject-anonymous-skeleton
    desc: pyproject.toml with anonymous email and no URLs
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-is-pyproject
      - id: obj/lateral/supply-chain/pypi/email::pyproject-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pyproject-no-urls
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-no-dependencies

  # === pyproject.toml Skeleton Package ===
  - id: pyproject-skeleton-with-entrypoint
    desc: Skeleton pyproject.toml with script entry point
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-is-pyproject
      - id: obj/lateral/supply-chain/pypi/description::pyproject-placeholder-description
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-empty-dependencies
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-has-script-entrypoint

  # === Cloned Library Identity Package ===
  - id: pkginfo-cloned-library-identity
    desc: PKG-INFO impersonating a popular library
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-no-homepage
      - id: pkginfo-cloned-readme-body

  # === Malware-Named Package with Anonymous Author ===
  - id: pkginfo-malware-named-anonymous
    desc: Package with offensive name and anonymous author
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/name::pkginfo-name-malware-term
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-no-homepage

  # === PKG-INFO with Inflated Version + Cloned Identity ===
  - id: pkginfo-inflated-cloned-identity
    desc: Inflated-version PKG-INFO impersonating library
    crit: suspicious
    conf: 0.92
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/version::pkginfo-inflated-version
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pkginfo-no-homepage
      - id: pkginfo-cloned-readme-body

  # === pyproject.toml with Inflated Version + Anonymous Skeleton ===
  - id: pyproject-inflated-anonymous-skeleton
    desc: Inflated-version pyproject.toml with anonymous author
    crit: suspicious
    conf: 0.92
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-is-pyproject
      - id: obj/lateral/supply-chain/pypi/version::pyproject-inflated-version
      - id: obj/lateral/supply-chain/pypi/email::pyproject-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pyproject-no-urls
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-no-dependencies

  # === pyproject.toml Boilerplate Inflated Anonymous Skeleton ===
  - id: pyproject-boilerplate-inflated-skeleton
    desc: Inflated pyproject.toml with boilerplate description
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-is-pyproject
      - id: obj/lateral/supply-chain/pypi/version::pyproject-inflated-version
      - id: obj/lateral/supply-chain/pypi/email::pyproject-privacy-email
      - id: obj/lateral/supply-chain/pypi/homepage::pyproject-no-urls
      - id: obj/lateral/supply-chain/pypi/pyproject::pyproject-no-dependencies
      - id: obj/lateral/supply-chain/pypi/description::pyproject-boilerplate-description

  # === PKG-INFO Filler Package with Anonymous Author ===
  - id: pkginfo-filler-anonymous-package
    desc: Filler PKG-INFO with no author attribution
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/author::pkginfo-no-author
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-no-author-email
    any:
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-low-effort-summary
      - id: obj/lateral/supply-chain/pypi/summary::pkginfo-placeholder-summary

  # === PKG-INFO Deceptive Throwaway Package ===
  - id: pkginfo-deceptive-throwaway
    desc: PKG-INFO with deceptive throwaway metadata
    crit: suspicious
    conf: 0.88
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/homepage::unknown-homepage
      - id: obj/lateral/supply-chain/pypi/email::pkginfo-no-author-email
      - id: pkginfo-no-description
      - id: obj/lateral/supply-chain/pypi/author::pkginfo-numeric-author

  # === Impersonation Package with Social Engineering ===
  - id: pkginfo-impersonation-social-engineering
    desc: Impersonation package with privilege social engineering
    crit: hostile
    conf: 0.93
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/summary::summary-requests-admin
      - id: obj/lateral/supply-chain/pypi/cloned-body::pkginfo-body-has-badges
      - id: obj/lateral/supply-chain/pypi/general::unknown-platform

  # === Misspelled Privilege Request with Cloned README ===
  - id: pkginfo-misspelled-impersonation
    desc: Misspelled social engineering with cloned README
    crit: hostile
    conf: 0.93
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/summary::summary-misspelled-privilege-request
      - id: obj/lateral/supply-chain/pypi/summary::summary-requests-admin
      - id: obj/lateral/supply-chain/pypi/cloned-body::pkginfo-body-has-badges

  # === Messaging Platform Lure Package ===
  - id: pkginfo-messaging-lure-package
    desc: Messaging platform lure package with sparse metadata
    crit: hostile
    conf: 0.93
    attack: "T1195.002"
    mbc: "F0004"
    for: [all]
    platforms: [all]
    all:
      - id: obj/lateral/supply-chain/pypi/general::is-pkginfo-file
      - id: obj/lateral/supply-chain/pypi/name::pkginfo-name-messaging-security-lure
      - id: obj/lateral/supply-chain/pypi/homepage::unknown-homepage
      - id: obj/lateral/supply-chain/pypi/description::unknown-description
