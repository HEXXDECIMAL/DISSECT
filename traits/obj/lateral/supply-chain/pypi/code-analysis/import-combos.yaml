# PyPI Supply Chain - Suspicious Import Combinations
# Detects unusual import patterns in Python packages, especially setup.py
# ATT&CK: T1195.002 (Compromise Software Supply Chain)

defaults:
  for: [python]
  attack: "T1195.002"

traits:
  # === Browser data path strings ===
  - id: chrome-windows-path
    desc: Chrome Windows data path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "Local/Google/Chrome"

  - id: edge-windows-path
    desc: Edge Windows data path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "Local/Microsoft/Edge"

  - id: firefox-unix-path
    desc: Firefox Unix data path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: ".mozilla/firefox"

  - id: chrome-macos-path
    desc: Chrome macOS data path
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "Application Support/Google/Chrome"

  # === Shellcode/memory execution patterns ===
  - id: prot-exec-string
    desc: PROT_EXEC memory protection
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: "PROT_EXEC|PAGE_EXECUTE"

  # === Clipboard patterns ===
  - id: clipboard-string
    desc: Clipboard reference
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "clipboard"

composite_rules:
  # === INERT: Common legitimate patterns ===

  # Network client package pattern
  - id: network-client-imports
    desc: Network client import pattern
    crit: notable
    conf: 0.6
    any:
      - id: meta/import/python/requests
      - id: meta/import/python/urllib/
      - id: meta/import/python/http/
      - id: meta/import/python/socket

  # === NOTABLE: Patterns that define package purpose ===

  # Crypto + network - could be security tool or malware
  - id: crypto-network-imports
    desc: Cryptography with network capability
    crit: notable
    conf: 0.75
    all:
      - id: network-client-imports
    any:
      - id: meta/import/python/cryptography/
      - id: meta/import/python/hashlib
      - id: meta/import/python/hmac

  # ctypes + mmap - shellcode/native code execution pattern
  - id: ctypes-mmap-combo
    desc: ctypes with memory mapping
    crit: notable
    conf: 0.8
    all:
      - id: meta/import/python/ctypes
      - id: meta/import/python/mmap

  # === SUSPICIOUS: Unusual patterns in setup.py context ===

  # setup.py with socket imports - packaging shouldn't need sockets
  - id: setup-py-socket-imports
    desc: setup.py imports socket module
    crit: suspicious
    conf: 0.85
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: meta/import/python/socket

  # setup.py with ctypes - no legitimate reason for FFI in setup
  - id: setup-py-ctypes-imports
    desc: setup.py imports ctypes module
    crit: suspicious
    conf: 0.85
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: meta/import/python/ctypes

  # setup.py with keyboard/input capture - surveillance in package install
  - id: setup-py-input-capture
    desc: setup.py imports input capture modules
    crit: suspicious
    conf: 0.9
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
    any:
      - id: meta/import/python/pynput
      - id: meta/import/python/keyboard
      - id: meta/import/python/pyautogui

  # Browser data paths
  - id: browser-paths
    desc: Browser data directory paths
    crit: notable
    conf: 0.8
    any:
      - id: chrome-windows-path
      - id: edge-windows-path
      - id: firefox-unix-path
      - id: chrome-macos-path

  # setup.py accessing browser data paths
  - id: setup-py-browser-paths
    desc: setup.py references browser data paths
    crit: suspicious
    conf: 0.9
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: browser-paths

  # Shellcode loader pattern: ctypes + mmap + struct
  - id: shellcode-loader-imports
    desc: Potential shellcode loader import pattern
    crit: suspicious
    conf: 0.85
    all:
      - id: meta/import/python/ctypes
      - id: meta/import/python/mmap
    any:
      - id: meta/import/python/struct
      - id: prot-exec-string

  # === HOSTILE: Clear malware patterns in setup.py ===

  # setup.py with full dropper chain
  # Precision: all(4) = 4.0 (meets hostile threshold)
  - id: setup-py-dropper-imports
    desc: setup.py with dropper import chain
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: meta/import/python/socket
      - id: meta/import/python/base64
    any:
      - id: meta/import/python/os/system
      - id: meta/import/python/subprocess/
      - id: cap/exec/eval/

  # setup.py with clipboard + network = clipper malware
  # Precision: all(3) + any(1) = 4.0 (meets hostile threshold)
  - id: setup-py-clipper-imports
    desc: setup.py with crypto clipper imports
    crit: hostile
    conf: 0.95
    mbc: "E1510"
    attack: "T1115"
    all:
      - id: obj/lateral/supply-chain/pypi/general::setup-py-file
      - id: network-client-imports
    any:
      - id: meta/import/python/pyperclip
      - id: clipboard-string
