# PyPI Supply-Chain Attack Patterns
# Install-time system info exfiltration
# ATT&CK: T1195.002 (Compromise Software Supply Chain)

defaults:
  for: [python]
  attack: "T1195.002"

traits:
  # === Decoy/Placeholder Patterns ===
  # Malicious packages often have minimal __init__.py files that just
  # print a confirmation message. Legitimate packages have actual code.

  - id: print-installed-string
    desc: Prints "installed" confirmation
    crit: suspicious
    conf: 0.85
    if:
      type: string
      # Match: print("...installed..."), output("...installed"), or return with installed as confirmation
      regex: "(?:print|send|http|request|post)\\s*\\([^)]{0,100}\\binstalled\\b"
      case_insensitive: true
    not:
      # Legitimate contexts where "installed" is expected
      - regex: "not\\s+installed"
      - regex: "is\\s+installed"
      - regex: "must be installed"
      - regex: "already\\s+installed"
      - regex: "packages? installed"
      - regex: "successfully\\s+installed"
      - regex: "pip\\s+install"
      # Common legitimate patterns
      - regex: "ImportError.*installed"
      - regex: "devtools"
      - regex: "sqlalchemy"

  - id: placeholder-ellipsis
    desc: Placeholder ellipsis string
    crit: notable
    conf: 0.75
    if:
      type: string
      # Just dots as placeholder output ("...", "....", etc)
      regex: "^\\.{2,}$"

  - id: tiny-python-file
    desc: Tiny Python file
    crit: notable
    conf: 0.8
    if:
      type: filesize
      max: 100
    unless:
      - type: content
        regex: "^(?:from\\s+\\S+\\s+import|import\\s+\\S+)"

  - id: small-no-imports
    desc: Small Python file with no imports
    crit: notable
    conf: 0.75
    if:
      type: filesize
      max: 500
    unless:
      - type: content
        substr: "import "

  - id: empty-file
    desc: Empty file (0 bytes)
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: filesize
      max: 0

  - id: webhook-package-name
    desc: Package name contains webhook
    crit: notable
    conf: 0.9
    if:
      type: string
      exact: "webhook"
      case_insensitive: true

  - id: init-py-file
    desc: __init__.py file
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: basename
      exact: "__init__.py"

  - id: setup-py-file
    desc: setup.py file
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: basename
      exact: "setup.py"

  - id: setuptools-setup-call
    desc: setuptools setup() call
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "setup"

  # === Probe/Test Print Patterns ===
  # Malicious typosquat/dependency confusion packages often include
  # print("test ...") at module level to confirm code execution on install.

  - id: probe-print-test
    desc: Probe print with test prefix string
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "^test\\s"

  # === Suspicious URL Patterns ===
  # Exfil endpoints commonly seen in supply-chain attacks

  - id: suspicious-php-endpoint
    desc: PHP endpoint URL
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "https?://[^/]+/[^'\"\\s]*\\.php"

  - id: version-check-url
    desc: Suspicious version check URL
    crit: suspicious
    conf: 0.9
    if:
      type: string
      # Pattern: Version.php, version.php, check.php etc
      regex: "https?://[^/]+/[Vv]ersion\\.php|https?://[^/]+/[Cc]heck\\.php"

  # === Base64 Encoding for Exfil ===
  - id: base64-encode-call
    desc: base64.b64encode() call
    crit: notable
    conf: 0.7
    if:
      type: symbol
      regex: "base64\\.(b64encode|encodestring)"

  - id: base64-encode-string
    desc: base64 encode reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "base64\\.(b64encode|encodestring)"

  # === Data Concatenation Patterns ===
  # Malware typically concatenates victim info with delimiters

  - id: triple-hash-delimiter
    desc: Triple hash data delimiter
    crit: suspicious
    conf: 0.85
    if:
      type: string
      exact: "###"

  - id: data-concat-pattern
    desc: String concatenation with delimiter
    crit: notable
    conf: 0.75
    if:
      type: content
      # Pattern: var = val1 + "###" + val2 + "###" + ...
      regex: "=\\s*\\w+\\s*\\+\\s*['\"]###['\"]\\s*\\+\\s*\\w+"

  # === HTTP POST with Data ===
  - id: urlopen-with-data
    desc: urllib.urlopen with data parameter
    crit: suspicious
    conf: 0.85
    if:
      type: content
      # Both Python 2 and 3 patterns
      regex: "urlopen\\s*\\([^)]*,\\s*(?:data=)?['\"]?\\w+"

  - id: vid-parameter
    desc: vid= POST parameter
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "vid="

composite_rules:
  # === Empty __init__.py in webhook/exfil-targeting package ===
  # When an empty __init__.py appears in a package with "webhook" in the name,
  # it's highly suspicious - suggests supply-chain attack targeting Discord users
  # or webhook-based exfiltration infrastructure.
  # Complexity: all(+3) = 3 (suspicious, not quite hostile due to archive limitations)
  - id: empty-init-webhook-package
    desc: Empty __init__.py in webhook-focused package
    crit: suspicious
    conf: 0.9
    attack: "T1195.002"
    all:
      - id: empty-file
      - id: webhook-package-name

  # === Empty __init__.py (shell package) ===
  # Published PyPI packages with empty __init__.py provide no runtime
  # functionality - exists solely as a vehicle for install-time attacks.
  # Complexity: all(+2) + for(+1) = 3 (SUSPICIOUS)
  - id: empty-init-py
    desc: Empty __init__.py in published package
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    for: [all]
    all:
      - id: init-py-file
      - id: empty-file

  # === Decoy/Placeholder __init__.py ===
  # Malicious PyPI packages often have minimal __init__.py files that just
  # confirm installation. This is a supply-chain indicator.
  # Complexity: for(+1) + all(+3) = 4 (meets threshold)
  - id: decoy-init-py
    desc: Decoy __init__.py with install confirmation
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    all:
      - id: init-py-file
      - id: tiny-python-file
      - id: print-installed-string

  # === Stub Python file with Placeholder ===
  # Malicious typosquat packages often have minimal Python files with
  # placeholder content like print("...") - provides no real functionality.
  # Note: basename matching doesn't work for archive members, so we can't check
  # for __init__.py specifically. This matches any tiny Python file with placeholder.
  # Complexity: for(+1) + all(+2) = 3 (SUSPICIOUS maintained)
  - id: stub-placeholder-file
    desc: Stub Python file with placeholder content
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    all:
      - id: tiny-python-file
      - id: placeholder-ellipsis

  # === Stub Module with No Imports ===
  # Name-squatting/typosquat packages contain small Python modules with
  # no imports - just trivial placeholder code. Real modules import things.
  # Complexity: for(+1) + all(+2) + size_max(+1) = 4 (SUSPICIOUS)
  - id: stub-squatter-module
    desc: Stub Python module with no imports
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    size_max: 500
    all:
      - id: small-no-imports
      - id: cap/data/control-flow/for-loop

  # Base64 encoding composite
  - id: base64-encode
    desc: Base64 encoding capability
    crit: notable
    conf: 0.8
    needs: 1
    any:
      - id: base64-encode-call
      - id: base64-encode-string

  # Data collection with delimiter (fingerprint payload)
  - id: fingerprint-payload-concat
    desc: Fingerprint data concatenation
    crit: suspicious
    conf: 0.9
    all:
      - id: triple-hash-delimiter
    any:
      - id: obj/discovery/system/getuser-call
      - id: obj/discovery/system/getuser-string
      - id: obj/discovery/system/gethostname-call
      - id: obj/discovery/system/gethostname-string

  # === HOSTILE: PyPI Install-Time Exfiltration ===
  # Classic pattern: setup.py collects system info, base64 encodes, POSTs to external server
  # Complexity: for(+1) + all(+4) = 5 (meets HOSTILE threshold)

  - id: pypi-install-exfil
    desc: PyPI install-time system exfiltration
    crit: hostile
    conf: 0.95
    mbc: "E1041"
    attack: "T1020"
    all:
      - id: setup-py-file
      - id: obj/discovery/system/python-sysinfo-multi
      - id: base64-encode
      - id: cap/comm/http/request/python/request-python

  # Lighter variant without setup.py check
  # Complexity: for(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: python-sysinfo-exfil
    desc: Python system info exfiltration
    crit: hostile
    conf: 0.92
    mbc: "E1041"
    attack: "T1020"
    all:
      - id: obj/discovery/system/python-sysinfo-multi
      - id: base64-encode
      - id: cap/comm/http/request/python/request-python

  # === HOSTILE: Python Environment Variable Exfiltration ===
  # Pattern: enumerate environ + base64 encode + HTTP send
  # Classic supply-chain attack: steal all env vars (AWS keys, tokens, secrets)
  # Complexity: for(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: python-envvar-exfil
    desc: Python environment variable exfiltration
    crit: hostile
    conf: 0.95
    mbc: "E1041"
    attack: "T1020"
    all:
      - id: cap/os/env/vars/py-environ-enumerate
      - id: base64-encode
      - id: cap/comm/http/request/request-python

  # Fingerprint with VID parameter (high confidence)
  # Complexity: for(+1) + all(+3) = 4 (meets SUSPICIOUS threshold; HOSTILE would need >=4)
  - id: pypi-vid-exfil
    desc: PyPI VID exfiltration pattern
    crit: suspicious
    conf: 0.98
    mbc: "E1041"
    attack: "T1020"
    all:
      - id: vid-parameter
      - id: base64-encode
      - id: cap/comm/http/request/python/request-python

  # === SUSPICIOUS: PyPI Probe Package ===
  # Typosquat/dependency confusion probe: setup.py imports a network library
  # (requests) and prints a test/probe message to confirm code execution.
  # No real package functionality â€” just a phone-home probe.
  # Complexity: for(+1) + all(+3) = 4 (SUSPICIOUS)
  - id: pypi-probe-package
    desc: PyPI typosquat probe package
    crit: suspicious
    conf: 0.90
    attack: "T1195.002"
    all:
      - id: setup-py-file
      - id: obj/creds/browser/import-requests
      - id: probe-print-test

