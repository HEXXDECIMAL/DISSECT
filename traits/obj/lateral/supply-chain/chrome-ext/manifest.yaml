# Chrome Extension Manifest Patterns
# Detects suspicious patterns in Chrome extension manifest.json files
# Uses type: kv for semantic JSON path queries

defaults:
  for: [chrome-manifest]

traits:
  # === Manifest Version Detection ===
  - id: manifest-v3
    desc: Chrome extension using Manifest V3
    crit: inert
    conf: 0.95
    if:
      type: kv
      path: "manifest_version"
      exact: "3"

  - id: manifest-v2
    desc: Uses deprecated Manifest V2
    crit: notable
    conf: 0.95
    if:
      type: kv
      path: "manifest_version"
      exact: "2"

  # === Dangerous Permissions ===
  - id: permission-all-urls
    desc: Requests all URLs access
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "permissions"
      exact: "<all_urls>"

  - id: permission-active-tab
    desc: Extension requests activeTab permission
    crit: notable
    conf: 0.9
    if:
      type: kv
      path: "permissions"
      exact: "activeTab"

  - id: permission-tabs
    desc: Extension requests tabs permission
    crit: notable
    conf: 0.9
    if:
      type: kv
      path: "permissions"
      exact: "tabs"

  - id: permission-web-request
    desc: Extension requests webRequest permission
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "permissions"
      regex: "webRequest|webRequestBlocking"

  - id: permission-cookies
    desc: Extension requests cookies permission
    crit: suspicious
    conf: 0.9
    if:
      type: kv
      path: "permissions"
      exact: "cookies"

  - id: permission-history
    desc: Extension requests history permission
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "permissions"
      exact: "history"

  - id: permission-bookmarks
    desc: Extension requests bookmarks permission
    crit: notable
    conf: 0.9
    if:
      type: kv
      path: "permissions"
      exact: "bookmarks"

  - id: permission-geolocation
    desc: Extension requests geolocation permission
    crit: suspicious
    conf: 0.9
    if:
      type: kv
      path: "permissions"
      exact: "geolocation"

  - id: permission-clipboard-read
    desc: Extension can read clipboard
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "permissions"
      exact: "clipboardRead"

  - id: permission-clipboard-write
    desc: Extension can write clipboard
    crit: notable
    conf: 0.9
    if:
      type: kv
      path: "permissions"
      exact: "clipboardWrite"

  - id: permission-native-messaging
    desc: Extension uses native messaging
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "permissions"
      exact: "nativeMessaging"

  - id: permission-debugger
    desc: Uses debugger API
    crit: suspicious
    conf: 0.98
    if:
      type: kv
      path: "permissions"
      exact: "debugger"

  - id: permission-proxy
    desc: Extension can modify proxy settings
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "permissions"
      exact: "proxy"

  - id: permission-declarative-net-request
    desc: Extension uses declarativeNetRequest
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "permissions"
      regex: "declarativeNetRequest|declarativeNetRequestWithHostAccess"

  # === Host Permissions (broad access) ===
  - id: host-all-urls
    desc: Host permission for all URLs
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "host_permissions"
      exact: "<all_urls>"

  - id: host-all-http
    desc: Access to all HTTP sites
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "host_permissions"
      regex: "^\\*://\\*/\\*$|^https?://\\*/\\*$"

  - id: host-shopping-sites
    desc: Extension targets e-commerce sites
    crit: notable
    conf: 0.9
    if:
      type: kv
      path: "host_permissions"
      regex: "amazon\\.|ebay\\.|walmart\\.|aliexpress\\."

  # === Content Scripts ===
  - id: content-script-all-urls
    desc: Content script on all URLs
    crit: suspicious
    conf: 0.95
    if:
      type: kv
      path: "content_scripts[*].matches"
      exact: "<all_urls>"

  - id: content-script-run-at-start
    desc: Content script runs at document_start
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "content_scripts[*].run_at"
      exact: "document_start"

  - id: content-script-all-frames
    desc: Content script runs in all frames
    crit: notable
    conf: 0.8
    if:
      type: kv
      path: "content_scripts[*].all_frames"
      exact: "true"

  - id: content-script-shopping
    desc: Content script targets shopping sites
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "content_scripts[*].matches"
      regex: "amazon\\.|ebay\\.|walmart\\.|aliexpress\\."

  # === Background Scripts ===
  - id: background-persistent
    desc: Extension uses persistent background page
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "background.persistent"
      exact: "true"

  - id: background-service-worker
    desc: Extension uses service worker (MV3)
    crit: inert
    conf: 0.9
    if:
      type: kv
      path: "background.service_worker"

  # === Suspicious Manifest Patterns ===
  - id: externally-connectable
    desc: Extension allows external connections
    crit: suspicious
    conf: 0.9
    if:
      type: kv
      path: "externally_connectable"

  - id: update-url-external
    desc: Non-Google update URL
    crit: suspicious
    conf: 0.9
    if:
      type: kv
      path: "update_url"
      regex: "^https?://(?!clients2\\.google\\.com)"

  - id: web-accessible-resources
    desc: Exposes resources to web
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "web_accessible_resources"

  # === Chrome Extension Marker ===
  - id: is-chrome-manifest
    desc: Chrome extension manifest file
    crit: inert
    conf: 0.95
    if:
      type: kv
      path: "manifest_version"

composite_rules:
  # Overprivileged extension
  - id: overprivileged
    desc: Extension requests excessive permissions
    crit: suspicious
    conf: 0.9
    needs: 3
    any:
      - id: permission-all-urls
      - id: host-all-urls
      - id: permission-web-request
      - id: permission-cookies
      - id: permission-history
      - id: permission-clipboard-read
      - id: permission-native-messaging
      - id: permission-debugger
      - id: permission-proxy

  # E-commerce targeting extension
  - id: ecommerce-targeting
    desc: Extension specifically targets shopping sites
    crit: notable
    conf: 0.85
    all:
      - id: is-chrome-manifest
    any:
      - id: host-shopping-sites
      - id: content-script-shopping

  # Broad host access with content scripts
  - id: broad-content-injection
    desc: Extension can inject content into many sites
    crit: suspicious
    conf: 0.9
    all:
      - id: is-chrome-manifest
    any:
      - id: content-script-all-urls
      - id: permission-all-urls
      - id: host-all-urls
      - id: host-all-http

  # Suspicious permissions combination for data theft
  - id: data-theft-permissions
    desc: Extension has permissions enabling data theft
    crit: suspicious
    conf: 0.95
    all:
      - id: is-chrome-manifest
    needs: 2
    any:
      - id: permission-cookies
      - id: permission-history
      - id: permission-clipboard-read
      - id: permission-web-request

  # Deprecated manifest with dangerous permissions
  - id: deprecated-with-dangerous
    desc: MV2 extension with dangerous permissions
    crit: suspicious
    conf: 0.9
    all:
      - id: manifest-v2
    any:
      - id: permission-all-urls
      - id: host-all-urls
      - id: permission-web-request
      - id: permission-debugger
