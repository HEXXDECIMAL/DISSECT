# Malicious Chrome Extension Patterns
# Detects high-confidence malicious patterns in browser extensions

traits:
  # === URL Parameter Manipulation ===
  - id: url-searchparams-set
    desc: Sets URL search parameters
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\.searchParams\\.set\\(|params\\.set\\("

  - id: url-searchparams-append
    desc: Appends URL search parameters
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\.searchParams\\.append\\(|params\\.append\\("

  - id: url-searchparams-delete
    desc: Deletes URL search parameters
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "\\.searchParams\\.delete\\(|searchParams\\.delete\\("

  - id: new-url-constructor
    desc: Creates URL object for manipulation
    crit: notable
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "new URL\\("

  - id: url-tostring
    desc: Converts URL object to string
    crit: inert
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "\\.toString\\(\\)"

  # === Link Manipulation ===
  - id: link-href-assignment
    desc: Modifies link href attribute
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "link\\.href\\s*=|element\\.href\\s*=|\\.href\\s*=\\s*url"

  - id: queryselector-href
    desc: Selects elements by href attribute
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      regex: "querySelectorAll\\(['\"][^'\"]*href|querySelector\\(['\"][^'\"]*href"

  - id: queryselector-product-links
    desc: Selects product/shopping links
    crit: notable
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: raw
      regex: "querySelectorAll\\([^)]{0,50}/dp/|querySelectorAll\\([^)]{0,50}/gp/product"

  # === Affiliate Tag Patterns ===
  - id: affiliate-tag-variable
    desc: Defines affiliate tag variable
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: "AFFILIATE_TAG|affiliateTag|affiliate_tag|REFERRAL_TAG|referralTag|PARTNER_ID|partnerId"

  - id: amazon-affiliate-tag
    desc: Amazon affiliate tag pattern
    crit: suspicious
    conf: 0.95
    for: [javascript, typescript]
    if:
      type: string
      regex: "['\"]tag['\"]\\s*,\\s*['\"][a-zA-Z0-9]+-[0-9]{2}['\"]"

  - id: params-tag-set
    desc: Sets 'tag' URL parameter
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\.set\\(['\"]tag['\"]|params\\.set\\(['\"]tag|searchParams\\.set\\(['\"]tag"

  - id: params-tag-append
    desc: Appends 'tag' URL parameter
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\.append\\(['\"]tag['\"]|params\\.append\\(['\"]tag|searchParams\\.append\\(['\"]tag"

  - id: params-ref-manipulation
    desc: Manipulates ref/referral parameters
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: string
      regex: "searchParams\\.(set|append)\\(['\"]ref['\"]|searchParams\\.(set|append)\\(['\"]referral"

  - id: params-has-tag-check
    desc: Checks if tag parameter exists
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: raw
      regex: "params\\.has\\(['\"]tag['\"]|searchParams\\.has\\(['\"]tag"

  # === E-commerce Domain Targeting ===
  - id: amazon-domain-check
    desc: Checks for Amazon domain
    crit: notable
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: raw
      regex: "hostname\\.includes\\(['\"]amazon|hostname\\.match\\([^)]{0,30}amazon|domain.{0,20}amazon"

  - id: shopping-site-targeting
    desc: Targets e-commerce shopping sites
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: string
      regex: "amazon\\.com|ebay\\.com|walmart\\.com|target\\.com|bestbuy\\.com|aliexpress\\.com"

  # === DOM Injection Patterns ===
  - id: inject-script-element
    desc: Injects script element into page
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: "createElement\\(['\"]script['\"]\\)|appendChild\\([^)]{0,30}script|insertBefore\\([^)]{0,30}script"
    downgrade:
      any:
        - id: meta/library/jquery::domain
        - id: meta/library/jquery::version-string
        - id: meta/library/jquery::copyright
        - id: meta/library/jquery::fn-extend
    unless:
      - id: meta/library/jquery::domain
      - id: meta/library/jquery::version-string
      - id: meta/library/jquery::copyright
      - id: meta/library/jquery::fn-extend

  - id: inject-iframe
    desc: Injects iframe into page
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: "createElement\\(['\"]iframe['\"]\\)|appendChild\\([^)]{0,30}iframe"
    downgrade:
      any:
        - id: meta/library/jquery::domain
        - id: meta/library/jquery::version-string
        - id: meta/library/jquery::copyright
        - id: meta/library/jquery::fn-extend
    unless:
      - id: meta/library/jquery::domain
      - id: meta/library/jquery::version-string
      - id: meta/library/jquery::copyright
      - id: meta/library/jquery::fn-extend

  # === External Communication ===
  - id: external-domain-hardcoded
    desc: Hardcoded external domain
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "https?://[a-zA-Z0-9][-a-zA-Z0-9]*\\.(io|xyz|top|click|link|info)/[a-zA-Z]"

composite_rules:
  # URL parameter manipulation capability
  - id: url-param-manipulation
    desc: Extension manipulates URL parameters
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    all:
      - id: new-url-constructor
    any:
      - id: url-searchparams-set
      - id: url-searchparams-append
      - id: url-searchparams-delete

  # Affiliate link injection (general)
  - id: affiliate-injection
    desc: Extension injects affiliate tracking
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    all:
      - id: url-param-manipulation
    any:
      - id: affiliate-tag-variable
      - id: params-tag-set
      - id: params-tag-append
      - id: params-ref-manipulation

  # Amazon affiliate hijacking specifically
  - id: amazon-affiliate-hijack
    desc: Extension hijacks Amazon affiliate links
    crit: hostile
    conf: 0.95
    mbc: "E1480"
    attack: "T1565.002"
    for: [javascript, typescript]
    all:
      - id: amazon-domain-check
      - id: queryselector-product-links
    any:
      - id: params-tag-set
      - id: params-tag-append

  # Complete affiliate fraud pattern (replaces existing tags)
  - id: affiliate-tag-replacement
    desc: Extension replaces existing affiliate tags
    crit: hostile
    conf: 0.98
    mbc: "E1480"
    attack: "T1565.002"
    for: [javascript, typescript]
    all:
      - id: params-has-tag-check
      - id: params-tag-set
      - id: link-href-assignment

  # Link rewriting on shopping sites
  - id: shopping-link-rewrite
    desc: Extension rewrites links on shopping sites
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    all:
      - id: shopping-site-targeting
      - id: link-href-assignment
    any:
      - id: url-searchparams-set
      - id: url-searchparams-append

  # Persistent DOM monitoring for links
  - id: persistent-link-monitor
    desc: Extension persistently monitors and modifies links
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript]
    all:
      - id: obj/lateral/supply-chain/chrome-ext/markers::mutation-observer
      - id: queryselector-href
    any:
      - id: link-href-assignment
      - id: url-searchparams-set

  # Extension with external C2-like domain
  - id: external-c2-domain
    desc: Extension contacts suspicious external domain
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript]
    all:
      - id: obj/lateral/supply-chain/chrome-ext/markers::is-extension
      - id: external-domain-hardcoded
