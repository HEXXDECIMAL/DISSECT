# Affiliate Link Hijacking Patterns
# Detection of affiliate ID injection and link manipulation

traits:
  # === Affiliate Link Hijacking Patterns ===
  - id: amazon-product-url-pattern
    desc: Amazon product URL pattern
    crit: notable
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      regex: "/(?:dp|gp/product)/"

  - id: url-searchparams-api
    desc: URL searchParams API usage
    crit: notable
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      regex: "searchParams"

  - id: url-params-set
    desc: URL params modification
    crit: notable
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      regex: "params\\.(?:set|append)"

  - id: href-assignment
    desc: Link href modification
    crit: notable
    conf: 0.85
    for: [javascript]
    if:
      type: raw
      regex: "\\.href\\s*="

  - id: affiliate-tag-constant
    desc: Affiliate tag variable
    crit: notable
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      regex: "[A-Z_]*(?:AFFILIATE|REFERRAL)[A-Z_]*TAG"

  - id: tag-param-literal
    desc: Tag parameter string literal
    crit: notable
    conf: 0.7
    for: [javascript]
    if:
      type: raw
      regex: "['\"]tag['\"]\\s*[:=]"

  - id: ext-mutation-observer
    desc: MutationObserver DOM monitoring
    crit: notable
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      regex: "MutationObserver"

  - id: amazon-hostname-check
    desc: Amazon hostname detection
    crit: notable
    conf: 0.85
    for: [javascript]
    if:
      type: raw
      regex: "hostname.{0,50}amazon|amazon.{0,50}hostname"
      case_insensitive: true

  - id: queryselector-link-targeting
    desc: Link element selection
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: raw
      regex: "querySelectorAll\\([^)]{0,120}a\\[href"

composite_rules:
  # === Affiliate Link Hijacking Detection ===

  # URL parameter modification capability
  - id: url-param-modification
    desc: URL parameter modification
    crit: notable
    conf: 0.85
    for: [javascript]
    needs: 2
    any:
      - id: url-searchparams-api
      - id: url-params-set
      - id: href-assignment
      - id: tag-param-literal

  # Amazon affiliate link targeting
  - id: amazon-link-targeting
    desc: Amazon link targeting
    crit: notable
    conf: 0.85
    for: [javascript]
    needs: 2
    any:
      - id: amazon-product-url-pattern
      - id: amazon-hostname-check
      - id: queryselector-link-targeting

  # Generic affiliate link hijacking pattern (cross-platform)
  - id: affiliate-link-hijack
    desc: Affiliate link hijacking
    crit: suspicious
    conf: 0.9
    attack: "T1565.001"
    for: [javascript]
    all:
      - id: url-param-modification
      - id: href-assignment
    any:
      - id: affiliate-tag-constant
      - id: tag-param-literal

  # Amazon affiliate hijacking (specific)
  - id: ext-amazon-affiliate-hijack
    desc: Amazon affiliate hijacking
    crit: suspicious
    conf: 0.95
    attack: "T1565.001"
    for: [javascript]
    all:
      - id: amazon-link-targeting
      - id: url-param-modification
      - id: href-assignment

  # Persistent affiliate hijack via MutationObserver (hostile - complexity 4+)
  - id: persistent-affiliate-hijack
    desc: Persistent affiliate hijacking
    crit: hostile
    conf: 0.95
    attack: "T1565.001"
    for: [javascript]
    all:
      - id: ext-mutation-observer
      - id: href-assignment
      - id: url-param-modification
    any:
      - id: amazon-link-targeting
      - id: affiliate-tag-constant

  # Chrome extension affiliate fraud
  - id: extension-affiliate-fraud
    desc: Extension affiliate fraud
    crit: hostile
    conf: 0.95
    attack: "T1565.001"
    for: [javascript]
    all:
      - id: obj/lateral/supply-chain/chrome-ext/markers::chrome-extension-context
      - id: ext-mutation-observer
      - id: href-assignment
      - id: url-param-modification
