# NPM Supply Chain - Suspicious Import Combinations
# Detects unusual import patterns in npm packages
# ATT&CK: T1195.002 (Compromise Software Supply Chain)

defaults:
  for: [javascript, typescript]
  attack: "T1195.002"

traits:
  # === Module require patterns ===
  # Note: require-https, require-fs, require-child-process defined in suspicious.yaml

  - id: child-process-exec
    desc: child_process exec/spawn call
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "child_process\\.(exec|spawn|execSync)"

  - id: vm-run-context
    desc: vm.runInContext call
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "vm\\.runInContext"

  # === Obfuscation patterns ===
  - id: buffer-from-b64
    desc: Buffer.from with large base64
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "Buffer\\.from\\(['\"][A-Za-z0-9+/=]{100,}['\"]"

  - id: atob-large
    desc: atob with large base64
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "atob\\(['\"][A-Za-z0-9+/=]{100,}['\"]"

  - id: hex-escape-dense
    desc: Dense hex escape sequences
    crit: suspicious
    conf: 0.85
    if:
      type: content
      regex: "\\\\x[0-9a-f]{2}\\\\x[0-9a-f]{2}\\\\x[0-9a-f]{2}"
      count_min: 20

  # === Webhook exfil patterns ===
  # Note: discord-webhook defined in suspicious.yaml

  - id: telegram-bot-api
    desc: Telegram bot API URL
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "api\\.telegram\\.org/bot"

  # === Browser data paths ===
  - id: chrome-windows-userdata
    desc: Chrome Windows User Data path
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "Local/Google/Chrome/User Data"

  - id: chrome-appdata
    desc: Chrome AppData path
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "AppData/Local/Google/Chrome"

  - id: chrome-linux-config
    desc: Chrome Linux config path
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: ".config/google-chrome"

  - id: chrome-macos-support
    desc: Chrome macOS Application Support path
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "Application Support/Google/Chrome"

  - id: firefox-profiles
    desc: Firefox profiles path
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: ".mozilla/firefox/profiles"

  # === Credential database patterns ===
  - id: login-data-file
    desc: Browser Login Data file
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: "Login Data|cookies\\.sqlite|logins\\.json"

  - id: leveldb-reference
    desc: LevelDB reference (browser storage)
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "leveldb"

  # === Install hook patterns (package.json) ===
  - id: scripts-preinstall-shell
    desc: preinstall runs shell command
    crit: suspicious
    conf: 0.85
    for: [packagejson]
    if:
      type: kv
      path: "scripts.preinstall"
      regex: "\\b(curl|wget|node|sh|bash|powershell)\\b"

  - id: scripts-postinstall-shell
    desc: postinstall runs shell command
    crit: suspicious
    conf: 0.85
    for: [packagejson]
    if:
      type: kv
      path: "scripts.postinstall"
      regex: "\\b(curl|wget|node|sh|bash|powershell)\\b"

  - id: scripts-preinstall-pipe
    desc: preinstall download-execute pipe
    crit: suspicious
    conf: 0.95
    for: [packagejson]
    if:
      type: kv
      path: "scripts.preinstall"
      regex: "(curl|wget).{0,50}(\\||;|&&).{0,20}(node|sh|bash|eval)"

  - id: scripts-postinstall-pipe
    desc: postinstall download-execute pipe
    crit: suspicious
    conf: 0.95
    for: [packagejson]
    if:
      type: kv
      path: "scripts.postinstall"
      regex: "(curl|wget).{0,50}(\\||;|&&).{0,20}(node|sh|bash|eval)"

  - id: scripts-preinstall-node-e
    desc: preinstall node -e with URL
    crit: suspicious
    conf: 0.95
    for: [packagejson]
    if:
      type: kv
      path: "scripts.preinstall"
      regex: "node\\s+-e\\s+['\"].{0,100}https?://"

  - id: scripts-postinstall-node-e
    desc: postinstall node -e with URL
    crit: suspicious
    conf: 0.95
    for: [packagejson]
    if:
      type: kv
      path: "scripts.postinstall"
      regex: "node\\s+-e\\s+['\"].{0,100}https?://"

composite_rules:
  # === INERT: Common legitimate patterns ===

  - id: http-client-imports
    desc: HTTP client imports
    crit: inert
    conf: 0.5
    any:
      - id: meta/import/npm/axios
      - id: meta/import/npm/node-fetch
      - id: meta/import/npm/got
      - id: meta/import/npm/request
      - id: require-https

  - id: fs-imports
    desc: File system imports
    crit: inert
    conf: 0.5
    any:
      - id: meta/import/npm/fs
      - id: meta/import/npm/fs-extra
      - id: require-fs

  # === NOTABLE: Patterns that define package purpose ===

  - id: child-process-imports
    desc: Child process execution imports
    crit: notable
    conf: 0.7
    any:
      - id: meta/import/npm/child_process
      - id: require-child-process
      - id: child-process-exec

  - id: dynamic-eval-imports
    desc: Dynamic code evaluation patterns
    crit: notable
    conf: 0.75
    any:
      - id: cap/exec/eval/dynamic/javascript
      - id: vm-run-context

  # === SUSPICIOUS: Unusual patterns ===

  - id: install-hook-exec
    desc: Install hook with command execution
    crit: suspicious
    conf: 0.85
    for: [packagejson]
    any:
      - id: scripts-preinstall-shell
      - id: scripts-postinstall-shell

  - id: obfuscated-payload
    desc: Obfuscated payload in package
    crit: suspicious
    conf: 0.85
    any:
      - id: buffer-from-b64
      - id: atob-large
      - id: hex-escape-dense

  - id: network-eval-exec-chain
    desc: Network fetch with eval and exec
    crit: suspicious
    conf: 0.9
    all:
      - id: http-client-imports
      - id: dynamic-eval-imports
      - id: child-process-imports

  - id: webhook-exfil-pattern
    desc: Webhook with file system access
    crit: suspicious
    conf: 0.85
    all:
      - id: fs-imports
    any:
      - id: discord-webhook
      - id: telegram-bot-api

  - id: browser-data-access
    desc: Accesses browser data directories
    crit: suspicious
    conf: 0.9
    any:
      - id: chrome-windows-userdata
      - id: chrome-appdata
      - id: chrome-linux-config
      - id: chrome-macos-support
      - id: firefox-profiles

  # === HOSTILE: Clear malware patterns ===

  # Install hook download-execute
  # Precision: any(4 hostile traits) = 4.0+ (meets hostile threshold)
  - id: install-hook-dropper
    desc: Install hook downloads and executes payload
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    for: [packagejson]
    any:
      - id: scripts-preinstall-pipe
      - id: scripts-postinstall-pipe
      - id: scripts-preinstall-node-e
      - id: scripts-postinstall-node-e

  # Browser credential stealer
  # Precision: all(4) = 4.0 (meets hostile threshold)
  - id: browser-credential-stealer
    desc: Steals browser credentials
    crit: hostile
    conf: 0.95
    mbc: "E1555"
    attack: "T1555.003"
    all:
      - id: browser-data-access
      - id: fs-imports
      - id: http-client-imports
    any:
      - id: login-data-file
      - id: leveldb-reference
