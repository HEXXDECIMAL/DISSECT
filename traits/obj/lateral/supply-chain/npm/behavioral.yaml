# NPM Behavioral Context Traits
# These capture when and how code executes in npm package context
# Helps distinguish install-time vs runtime behavior

defaults:
  for: [javascript]

traits:
  # === INSTALL-TIME BEHAVIOR (Suspicious Context) ===

  # NOTE: YARA kept for auto-execute - requires multiline/structural patterns with NOT conditions
  - id: auto-execute
    desc: Code auto-executes on require/import
    crit: notable
    conf: 0.8
    if:
      type: yara
      source: |
        rule auto_execute {
          strings:
            $iife = /^\s*\((?:async\s+)?(?:function|\(\s*\)|[a-z_$][a-z0-9_$]*\s*=>)/ ascii
            $call = /^[a-z_$][a-z0-9_$]*\s*\(\s*\)\s*;?\s*$/ ascii
            $export = "module.exports" ascii
          condition:
            any of ($iife, $call) and not $export
        }

  # NOTE: YARA kept for side-effect-only - requires NOT conditions across multiple patterns
  - id: side-effect-only
    desc: Module produces side effects without
    crit: notable
    conf: 0.8
    if:
      type: yara
      source: |
        rule side_effect_only {
          strings:
            $export1 = "module.exports" ascii
            $export2 = "exports." ascii
            $export3 = /^export\s/ ascii
            $http1 = /require\(['"]http['"]\)/ ascii
            $http2 = /import.*from\s+['"]http['"]/ ascii
            $fs1 = /require\(['"]fs['"]\)/ ascii
            $fs2 = /import.*from\s+['"]fs['"]/ ascii
            $exec = "exec(" ascii
            $spawn = "spawn(" ascii
          condition:
            (any of ($http*, $fs*, $exec, $spawn)) and not any of ($export*)
        }

  # NOTE: YARA kept for network-on-load - requires combining IIFE pattern with network calls
  - id: network-on-load
    desc: Network request during module initialization
    crit: suspicious
    conf: 0.85
    if:
      type: yara
      source: |
        rule network_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $fetch = "fetch(" ascii
            $http = "https.request" ascii
            $axios = "axios" ascii
            $got = "got(" ascii
          condition:
            $iife and any of ($fetch, $http, $axios, $got)
        }

  # NOTE: YARA kept for write-on-load - requires combining IIFE pattern with file writes
  - id: write-on-load
    desc: File write during module initialization
    crit: suspicious
    conf: 0.85
    if:
      type: yara
      source: |
        rule write_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $write1 = "writeFileSync" ascii
            $write2 = "writeFile(" ascii
            $append = "appendFile" ascii
          condition:
            $iife and any of ($write*, $append)
        }

  # NOTE: YARA kept for spawn-on-load - requires combining IIFE pattern with process spawning
  - id: spawn-on-load
    desc: Process spawned during module initialization
    crit: suspicious
    conf: 0.9
    if:
      type: yara
      source: |
        rule spawn_on_load {
          strings:
            $iife = /^\((?:async\s+)?(?:function|\()/ ascii
            $exec = "exec(" ascii
            $spawn = "spawn(" ascii
            $fork = "fork(" ascii
          condition:
            $iife and any of ($exec, $spawn, $fork)
        }

  # === STRUCTURAL INDICATORS ===

  # Very small file (< 500 bytes)
  # NOTE: YARA kept for filesize check - DISSECT doesn't support filesize conditions
  - id: tiny-file
    desc: Very small code file
    crit: notable
    conf: 0.6
    if:
      type: yara
      source: |
        rule tiny_file {
          condition:
            filesize < 500
        }

  # Medium file with no functions
  # NOTE: YARA kept for filesize check - DISSECT doesn't support filesize conditions
  - id: script-blob
    desc: Medium-sized file with no function
    crit: notable
    conf: 0.7
    if:
      type: yara
      source: |
        rule script_blob {
          strings:
            $func = /function\s+\w+\s*\(/ ascii
            $arrow = /const\s+\w+\s*=\s*(?:async\s+)?\([^)]*\)\s*=>/ ascii
            $class = /class\s+\w+/ ascii
          condition:
            filesize > 500 and filesize < 5000 and not any of ($func, $arrow, $class)
        }

  # === INTERPRETER EXECUTION PATTERNS ===

  # === Python interpreter atomic indicators ===
  - id: python-c-flag
    desc: python -c flag
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "python3?\\s+-c"

  - id: python-stdin-flag
    desc: python stdin flag
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "python3?\\s+-"

  # === Node interpreter atomic indicators ===
  - id: node-e-flag
    desc: node -e flag
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "node\\s+-e"

  - id: node-eval-flag
    desc: node --eval flag
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "node\\s+--eval"

  # === CHILD PROCESS PATTERNS ===

  # spawn call
  - id: spawn-call
    desc: Process spawn call
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "spawn\\("

  # exec call
  - id: exec-call
    desc: Process exec call
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "exec\\("

  # child_process module reference
  - id: child-process-import
    desc: Node child_process module usage
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "child_process"

  # === INSTALL-TIME STEALTH PATTERNS ===
  # Malware that checks if running during npm install to hide output

  - id: is-preinstall-check
    desc: isPreinstall variable check (install-time stealth)
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1195.002"
    if:
      type: content
      regex: "\\bisPreinstall\\b"

  - id: npm-lifecycle-env-check
    desc: npm_lifecycle_event environment check
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1195.002"
    if:
      type: content
      regex: "npm_lifecycle_event|npm_lifecycle_script"

  - id: not-is-preinstall-guard
    desc: Negated preinstall stealth guard
    crit: suspicious
    conf: 0.92
    mbc: "B0024"
    attack: "T1195.002"
    if:
      type: content
      regex: "!\\s*isPreinstall|if\\s*\\(!\\s*isPreinstall"

  # === EXFILTRATION FUNCTION NAMING ===
  # Explicit exfiltration function names are strong indicators

  - id: send-data-function
    desc: sendData function (exfiltration)
    crit: suspicious
    conf: 0.85
    mbc: "E1041"
    attack: "T1041"
    if:
      type: content
      regex: "(?:async\\s+)?function\\s+sendData\\s*\\(|sendData\\s*=\\s*(?:async\\s+)?(?:function|\\()"

  - id: send-via-websocket-function
    desc: sendViaWebSocket function (backup C2)
    crit: suspicious
    conf: 0.9
    mbc: "E1041"
    attack: "T1041"
    if:
      type: content
      regex: "(?:async\\s+)?function\\s+sendViaWebSocket\\s*\\(|sendViaWebSocket\\s*\\("

  - id: exfil-function-call
    desc: Call to sendData/exfil function
    crit: notable
    conf: 0.8
    mbc: "E1041"
    attack: "T1041"
    if:
      type: content
      regex: "\\bsendData\\s*\\(|\\bexfilData\\s*\\(|\\bsendInfo\\s*\\("

  # === DYNAMIC C2 ENDPOINT ===
  # Dynamic endpoint selection is common in supply chain malware

  - id: get-available-endpoint
    desc: getAvailableEndpoint function (C2 selection)
    crit: suspicious
    conf: 0.88
    mbc: "B0030"
    attack: "T1071"
    if:
      type: content
      regex: "getAvailableEndpoint\\s*\\(|getEndpoint\\s*\\(|selectEndpoint\\s*\\("

  - id: build-query-params
    desc: buildQueryParams function (URL exfil encoding)
    crit: notable
    conf: 0.75
    mbc: "E1041"
    attack: "T1041"
    if:
      type: content
      regex: "buildQueryParams\\s*\\("

  # === WEBSOCKET BACKUP CHANNEL ===
  # WebSocket as fallback C2 channel

  - id: websocket-fallback
    desc: WebSocket fallback/backup channel
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: content
      regex: "WebSocket\\s+(?:Backup|backup|fallback)|sendViaWebSocket|ws\\.send\\("

  # === HEADER-BASED BACKDOOR PATTERNS ===
  # getcookies-style backdoors that extract commands from HTTP headers

  - id: header-regex-extraction
    desc: Header regex command extraction
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: content
      # Pattern matches: req.headers.something.replace(/regex/, ...) or JSON.stringify(req.headers).replace(...)
      regex: "(?:req\\.headers|headers).{0,100}\\.replace\\s*\\(\\s*/[^/]+/"

  - id: hex-require-bracket-method
    desc: Hex-escaped bracket method access
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    if:
      type: content
      # Pattern: require('\x...')['...'](  - obfuscated module with bracket method access
      regex: "require\\s*\\(\\s*['\"]\\\\x[0-9a-fA-F]{2}.{0,50}['\"]\\s*\\)\\s*\\[\\s*['\"]"

  - id: buffer-alloc-large
    desc: Large buffer allocation (command assembly)
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: "Buffer\\.alloc\\s*\\(\\s*0x[fF]{2,}"

  - id: buffer-write-loop
    desc: Staged buffer payload assembly
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    if:
      type: content
      # Pattern: buffer[index] = value in a loop
      regex: "\\w+\\[\\s*\\w+\\s*\\+\\s*\\w+\\s*\\]\\s*=\\s*\\w+\\[\\s*\\w+\\s*\\]"

  - id: settimeout-code-exec
    desc: setTimeout with code execution
    crit: notable
    conf: 0.75
    if:
      type: content
      # setTimeout with arrow function that calls something suspicious
      regex: "setTimeout\\s*\\(\\s*\\(\\s*\\)\\s*=>\\s*\\{"

  - id: hex-vm-import
    desc: Hex-escaped vm module import
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1059"
    if:
      type: content
      # \x76\x6d = 'vm'
      regex: "require\\s*\\(\\s*['\"]\\\\x76\\\\x6d['\"]\\s*\\)"

  - id: hex-runinthiscontext
    desc: Hex-escaped runInThisContext method
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1059"
    if:
      type: content
      # \x72\x75\x6e\x49\x6e\x54\x68\x69\x73\x43\x6f\x6e\x74\x65\x78\x74 = 'runInThisContext'
      regex: "\\\\x72\\\\x75\\\\x6e\\\\x49\\\\x6e\\\\x54\\\\x68\\\\x69\\\\x73\\\\x43\\\\x6f\\\\x6e\\\\x74\\\\x65\\\\x78\\\\x74"

  - id: test-harness-in-production
    desc: Test harness import in production
    crit: suspicious
    conf: 0.8
    mbc: "B0024"
    attack: "T1195.002"
    if:
      type: content
      # Unusual: importing test/harness in non-test file
      regex: "require\\s*\\(\\s*['\"][^'\"]*(?:test|spec)[/\\\\]harness[^'\"]*['\"]\\s*\\)"

  # === C2 DATA SERVER PATTERNS ===
  # Detects server infrastructure packages: express + socket.io + file upload

  - id: express-fileupload-dep
    desc: express-fileupload dependency
    crit: notable
    conf: 0.8
    for: [javascript, all]
    if:
      type: symbol
      exact: "express-fileupload"

  - id: socket-io-dep
    desc: socket.io dependency
    crit: notable
    conf: 0.8
    for: [javascript, all]
    if:
      type: symbol
      exact: "socket.io"

  - id: express-dep
    desc: express dependency
    crit: inert
    conf: 0.9
    for: [javascript, all]
    if:
      type: symbol
      exact: "express"

  - id: base64-encode-function
    desc: base64 encoding function/method
    crit: notable
    conf: 0.7
    mbc: "E1041"
    attack: "T1041"
    for: [javascript]
    if:
      type: content
      regex: "toString\\s*\\(\\s*['\"]base64['\"]\\s*\\)|Buffer\\.from\\s*\\([^)]*\\)['\"]base64"

composite_rules:
  # Python interpreter exec composite
  - id: python-interpreter-exec
    desc: Python interpreter with inline code
    crit: suspicious
    conf: 0.8
    needs: 1
    any:
      - id: python-c-flag
      - id: python-stdin-flag

  # Node interpreter exec composite
  - id: node-interpreter-exec
    desc: Node interpreter with inline code
    crit: suspicious
    conf: 0.8
    needs: 1
    any:
      - id: node-e-flag
      - id: node-eval-flag

  # Spawn or exec composite
  - id: spawn-or-exec-call
    desc: Process spawn or exec function
    crit: notable
    conf: 0.8
    needs: 1
    any:
      - id: spawn-call
      - id: exec-call

  # npm package with interpreter dropper (hostile combination)
  - id: interpreter-dropper-package
    desc: npm package that downloads and
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    for: [javascript, typescript]
    any:
      - id: python-interpreter-exec
      - id: node-interpreter-exec
    all:
      - id: spawn-or-exec-call
      - id: child-process-import

  # Supply-chain trojan with obfuscated payload
  - id: obfuscated-trojan
    desc: Obfuscated supply-chain trojan
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0022"
    for: [javascript] # +1 complexity
    all: # +3 complexity (3 required patterns)
      - id: obj/anti-static/obfuscation/code-metrics
      - id: obj/anti-static/obfuscation/strings/js-version-marker
      - id: obj/anti-static/obfuscation/strings/js-charat-loop
    # Total complexity: 1 + 3 = 4 (meets HOSTILE threshold)

  # Advanced evasion with multiple techniques
  - id: advanced-evasion-trojan
    desc: Multi-layer obfuscated malware
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    mbc: "B0032"
    for: [javascript]
    all:
      - id: obj/anti-static/obfuscation/strings/js-string-deobfuscation
      - id: cap/exec/eval/dynamic/Function-constructor
    any:
      - id: obj/anti-static/obfuscation/strings/js-global-manipulation
      - id: cap/exec/eval/dynamic/obfuscated-iife
      - id: obj/anti-static/obfuscation/strings/js-require-alias

  # === INSTALL-TIME STEALTH COMPOSITES ===

  # Helper: any install-time stealth check
  - id: install-stealth-check
    desc: Install-time stealth mechanism
    crit: suspicious
    conf: 0.88
    mbc: "B0024"
    attack: "T1195.002"
    for: [javascript]
    needs: 1
    any:
      - id: is-preinstall-check
      - id: not-is-preinstall-guard
      - id: npm-lifecycle-env-check

  # Helper: HTTP POST exfiltration capability
  - id: http-post-exfil
    desc: HTTP POST exfiltration
    crit: notable
    conf: 0.75
    for: [javascript]
    needs: 1
    any:
      - id: cap/comm/http/post/post
      - id: obj/exfil/http/node/node-post-json

  # === SUPPLY CHAIN EXFIL COMPOSITES (HOSTILE) ===

  # Stealth exfil during install: isPreinstall + HTTP POST
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: stealth-install-exfil
    desc: Stealthy exfiltration during npm install
    crit: hostile
    conf: 0.95
    mbc: "E1041"
    attack: "T1195.002"
    for: [javascript]
    all:
      - id: install-stealth-check
      - id: http-post-exfil
      - id: cap/comm/http/websocket/websocket

  # Dual-channel exfil: HTTP + WebSocket backup
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: dual-channel-exfil
    desc: Dual HTTP/WebSocket exfiltration channels
    crit: hostile
    conf: 0.93
    mbc: "B0030"
    attack: "T1071.001"
    for: [javascript]
    all:
      - id: send-data-function
      - id: send-via-websocket-function
      - id: cap/comm/http/post/post

  # Dynamic C2 with exfil function
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: dynamic-c2-exfil
    desc: Dynamic C2 endpoint with exfiltration
    crit: hostile
    conf: 0.92
    mbc: "B0030"
    attack: "T1071.001"
    for: [javascript]
    all:
      - id: get-available-endpoint
      - id: exfil-function-call
      - id: cap/comm/http/post/post

  # Complete npm exfiltrator pattern (all indicators)
  # Complexity: file_types(+1) + all(+4) = 5 (exceeds HOSTILE threshold)
  - id: npm-exfiltrator
    desc: Complete npm supply chain exfiltrator
    crit: hostile
    conf: 0.98
    mbc: "E1041"
    attack: "T1195.002"
    for: [javascript]
    all:
      - id: install-stealth-check
      - id: exfil-function-call
      - id: get-available-endpoint
      - id: cap/comm/http/post/post

  # === HEADER-TRIGGERED BACKDOOR COMPOSITES ===

  # Obfuscated VM code execution (getcookies-style backdoor)
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: obfuscated-vm-backdoor
    desc: Obfuscated vm.runInThisContext backdoor
    crit: hostile
    conf: 0.98
    mbc: "B0022"
    attack: "T1059.007"
    for: [javascript]
    all:
      - id: hex-vm-import
      - id: hex-runinthiscontext
      - id: obj/anti-static/obfuscation/strings/js-hex-escape

  # Header-based command injection backdoor
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: header-command-backdoor
    desc: HTTP header-based command injection
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    for: [javascript]
    all:
      - id: header-regex-extraction
      - id: buffer-alloc-large
      - id: settimeout-code-exec

  # Generic obfuscated bracket-access backdoor
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: bracket-access-backdoor
    desc: Obfuscated require with bracket method access
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1059.007"
    for: [javascript]
    all:
      - id: hex-require-bracket-method
      - id: obj/anti-static/obfuscation/strings/js-hex-escape
      - id: settimeout-code-exec

  # === C2 DATA SERVER COMPOSITES ===

  # C2 server infrastructure pattern (express + socket.io + file-upload)
  # Pattern: C2 receiver server that collects file uploads and broadcasts over WebSocket
  # Complexity: for(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: c2-data-server
    desc: C2 data collection/exfiltration server
    crit: suspicious
    conf: 0.92
    mbc: "B0030"
    attack: "T1041"
    for: [javascript, all]
    all:
      - id: express-fileupload-dep
      - id: socket-io-dep
      - id: express-dep
