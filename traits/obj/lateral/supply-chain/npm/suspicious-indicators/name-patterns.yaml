# NPM Package Name Anomaly Patterns
# Detects suspicious package naming patterns in package.json
# ATT&CK: T1195.002 (Supply Chain Compromise)
# These patterns indicate typosquatting, name confusion, or malicious intent

defaults:
  for: [packagejson]

traits:
  # === Package name contains credential theft keywords ===

  - id: name-dump-keyword
    desc: Package name contains "dump" keyword
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: '"name":\s*"[^"]*dump[^"]*"'
      case_insensitive: true

  - id: name-grab-keyword
    desc: Package name contains "grab" keyword
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: '"name":\s*"[^"]*grab(?:ber)?[^"]*"'
      case_insensitive: true

  - id: name-steal-keyword
    desc: Package name contains "steal" keyword
    crit: suspicious
    conf: 0.85
    if:
      type: content
      regex: '"name":\s*"[^"]*steal(?:er)?[^"]*"'
      case_insensitive: true

  - id: name-hack-keyword
    desc: Package name contains "hack" keyword
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: '"name":\s*"[^"]*hack(?:er|ing)?[^"]*"'
      case_insensitive: true

  - id: name-crack-keyword
    desc: Package name contains "crack" keyword
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: '"name":\s*"[^"]*crack(?:er)?[^"]*"'
      case_insensitive: true

  - id: name-token-keyword
    desc: Package name contains "token" keyword
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*token[^"]*"'
      case_insensitive: true

  - id: name-logger-keyword
    desc: Package name contains "logger" keyword
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*logger[^"]*"'
      case_insensitive: true

  - id: name-exfil-keyword
    desc: Package name contains "exfil" keyword
    crit: suspicious
    conf: 0.9
    if:
      type: content
      regex: '"name":\s*"[^"]*exfil[^"]*"'
      case_insensitive: true

  # === Package name contains target application names ===

  - id: name-discord-target
    desc: Package name contains "discord"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*discord[^"]*"'
      case_insensitive: true

  - id: name-telegram-target
    desc: Package name contains "telegram"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*telegram[^"]*"'
      case_insensitive: true

  - id: name-slack-target
    desc: Package name contains "slack"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*slack[^"]*"'
      case_insensitive: true

  - id: name-wallet-target
    desc: Package name contains "wallet"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*wallet[^"]*"'
      case_insensitive: true

  - id: name-crypto-target
    desc: Package name contains crypto
    crit: inert
    conf: 0.4
    if:
      type: content
      regex: '"name":\s*"[^"]*crypto[^"]*"'
      case_insensitive: true

  - id: name-metamask-target
    desc: Package name contains "metamask"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*metamask[^"]*"'
      case_insensitive: true

  - id: name-browser-target
    desc: Package name contains "browser"
    crit: inert
    conf: 0.4
    if:
      type: content
      regex: '"name":\s*"[^"]*browser[^"]*"'
      case_insensitive: true

  - id: name-password-target
    desc: Package name contains "password"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"[^"]*pass(?:word)?[^"]*"'
      case_insensitive: true

  # === Package name prefixes legitimate tool names (typosquatting) ===

  - id: name-mysql-prefix
    desc: Package name prefixes "mysql"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"mysql-[^"]*"'
      case_insensitive: true

  - id: name-express-prefix
    desc: Package name prefixes "express"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"express-[^"]*"'
      case_insensitive: true

  - id: name-react-prefix
    desc: Package name prefixes "react"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"react-[^"]*"'
      case_insensitive: true

  - id: name-vue-prefix
    desc: Package name prefixes "vue"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"vue-[^"]*"'
      case_insensitive: true

  - id: name-node-prefix
    desc: Package name prefixes "node"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"name":\s*"node-[^"]*"'
      case_insensitive: true

  # === Minimal metadata indicators ===

  # === Keyword-based detection ===

  - id: keyword-dump
    desc: Keywords contain "dump"
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: '"keywords":\s*\[[^\]]*"[^"]*dump[^"]*"'
      case_insensitive: true

  - id: keyword-grab
    desc: Keywords contain "grab"
    crit: notable
    conf: 0.7
    if:
      type: content
      regex: '"keywords":\s*\[[^\]]*"[^"]*grab[^"]*"'
      case_insensitive: true

  - id: keyword-steal
    desc: Keywords contain "steal"
    crit: suspicious
    conf: 0.85
    if:
      type: content
      regex: '"keywords":\s*\[[^\]]*"[^"]*steal[^"]*"'
      case_insensitive: true

  - id: keyword-token
    desc: Keywords contain "token"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"keywords":\s*\[[^\]]*"[^"]*token[^"]*"'
      case_insensitive: true

  - id: keyword-discord
    desc: Keywords contain "discord"
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: '"keywords":\s*\[[^\]]*"[^"]*discord[^"]*"'
      case_insensitive: true

composite_rules:
  # === Credential theft keywords in name ===

  - id: name-has-theft-keyword
    desc: Package name contains theft-related keyword
    crit: notable
    conf: 0.75
    any:
      - id: name-dump-keyword
      - id: name-grab-keyword
      - id: name-steal-keyword
      - id: name-hack-keyword
      - id: name-crack-keyword
      - id: name-exfil-keyword

  # === Target application in name ===

  - id: name-has-target-app
    desc: Package name contains target application
    crit: inert
    conf: 0.5
    any:
      - id: name-discord-target
      - id: name-telegram-target
      - id: name-slack-target
      - id: name-wallet-target
      - id: name-metamask-target
      - id: name-password-target

  # === Theft keyword + target app in name (SUSPICIOUS) ===
  # Pattern: "mysql-dumpdiscord", "grab-telegram-token", etc.

  - id: name-theft-target-combo
    desc: Package name combines theft keyword with target app
    crit: suspicious
    conf: 0.9
    all:
      - id: name-has-theft-keyword
      - id: name-has-target-app

  # === Keywords contain suspicious terms ===

  - id: keyword-theft-patterns
    desc: Keywords contain theft-related terms
    crit: notable
    conf: 0.75
    any:
      - id: keyword-dump
      - id: keyword-grab
      - id: keyword-steal

  - id: keyword-target-patterns
    desc: Keywords contain target app terms
    crit: inert
    conf: 0.5
    any:
      - id: keyword-discord
      - id: keyword-token

  # === Keyword theft + target combo ===

  - id: keyword-theft-target-combo
    desc: Keywords combine theft and target terms
    crit: suspicious
    conf: 0.85
    all:
      - id: keyword-theft-patterns
      - id: keyword-target-patterns

  # === Suspicious name without metadata ===
  # Malicious packages often have minimal metadata

  - id: theft-name-no-repo
    desc: Theft keyword in name without repository
    crit: suspicious
    conf: 0.85
    all:
      - id: name-has-theft-keyword
    none:
      - id: obj/lateral/supply-chain/npm/suspicious-indicators::npm-has-repository

  - id: theft-name-no-bugs
    desc: Theft keyword in name without bugs URL
    crit: suspicious
    conf: 0.85
    all:
      - id: name-has-theft-keyword
    none:
      - id: obj/lateral/supply-chain/npm/suspicious-indicators::has-bugs-url

  - id: theft-name-no-homepage
    desc: Theft keyword in name without homepage
    crit: suspicious
    conf: 0.85
    all:
      - id: name-has-theft-keyword
    none:
      - id: obj/lateral/supply-chain/npm/suspicious-indicators::has-homepage

  # === Credential stealer package name pattern (SUSPICIOUS) ===
  # Complexity: 3 (all) = 3 -> suspicious (needs 4 for hostile)

  - id: credential-stealer-naming
    desc: Package naming suggests credential stealer
    crit: suspicious
    conf: 0.9
    attack: "T1195.002"
    all:
      - id: name-theft-target-combo
      - id: keyword-target-patterns
    none:
      - id: obj/lateral/supply-chain/npm/suspicious-indicators::npm-has-repository
