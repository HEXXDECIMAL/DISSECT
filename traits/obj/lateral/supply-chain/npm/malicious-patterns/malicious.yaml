# NPM Malicious Package Patterns (Supply-Chain Specific)
# ATT&CK: T1195.002 (Supply Chain Compromise)
# These patterns are specific to npm supply-chain attacks, not generic behaviors
defaults:
  for: [packagejson]

traits:
  # === Lifecycle hook atomic indicators ===
  - id: npm-malicious-preinstall-hook
    desc: preinstall lifecycle hook
    crit: inert
    conf: 0.6
    if:
      type: raw
      regex: '"preinstall"\\s*:'

composite_rules:
  # Lifecycle hook helpers
  - id: lifecycle-hook
    desc: NPM lifecycle hook
    crit: inert
    conf: 0.6
    any:
      - id: npm-malicious-preinstall-hook
      - id: obj/lateral/supply-chain/npm/metadata::postinstall-hook-key

  # Download command helpers
  - id: download-command
    desc: Download command (curl or wget)
    crit: notable
    conf: 0.7
    any:
      - id: cap/comm/http/client::curl-cmd
      - id: cap/comm/http/client::wget-cmd

  # Node eval helpers
  - id: node-eval
    desc: Node inline eval (node -e
    crit: notable
    conf: 0.8
    any:
      - id: cap/exec/eval/dynamic/

  # NPM preinstall/postinstall abuse with dropper behavior
  - id: lifecycle-dropper
    desc: NPM lifecycle script with dropper
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    all:
      - id: lifecycle-hook
      - id: download-command

  # NPM package with inline node eval in hooks
  - id: hook-node-eval
    desc: NPM install hook with node
    crit: suspicious
    conf: 0.95
    attack: "T1059.007"
    mbc: "B0024"
    all:
      - id: lifecycle-hook
      - id: node-eval

  # Install hook spawns child process
  - id: hook-child-process
    desc: NPM install hook using child_process
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    all:
      - id: lifecycle-hook
      - id: cap/exec/command/shell::child-process-require
