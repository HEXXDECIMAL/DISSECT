# NPM Supply Chain Stealer Patterns
# Detects malicious packages that import credential/data stealers
# ATT&CK: T1195.002 (Supply Chain Compromise: Software Supply Chain)

defaults:
  attack: "T1195.002"
  for: [javascript, typescript]

traits:
  # === STEALER MODULE IMPORTS ===
  # Importing from a local stealer/grabber module is a clear malicious indicator

  - id: local-stealer-import
    desc: Import from local stealer module
    crit: suspicious
    conf: 0.95
    mbc: "E1059"
    if:
      type: string
      regex: "from\\s+['\"]\\./(?:stealer|grabber|logger|exfil)['\"]|require\\(['\"]\\./(?:stealer|grabber|logger|exfil)['\"]\\)"
      case_insensitive: true

  - id: stealer-string
    desc: Stealer module string reference
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "./stealer"

  - id: grabber-string
    desc: Grabber module string reference
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "./grabber"

  # === CLOUD SANDBOX DETECTION ===
  # Checking for /app homedir indicates Heroku/container sandbox detection

  - id: homedir-app-check
    desc: Homedir /app sandbox check
    crit: suspicious
    conf: 0.9
    mbc: "B0007"
    attack: "T1497.001"
    if:
      type: string
      regex: "homedir\\(\\)\\s*===?\\s*['\"]/?app['\"]"

  - id: app-path-string
    desc: /app path string (cloud sandbox)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "/app"

  # === POSTINSTALL FLAG CHECK ===
  # Checking for --postinstall flag in argv is common in npm supply chain attacks

  - id: postinstall-argv-check
    desc: Check for --postinstall in argv
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    if:
      type: string
      regex: "process\\.argv\\.(?:includes|indexOf)\\(['\"]--postinstall['\"]\\)"

  - id: postinstall-flag-string
    desc: --postinstall flag string
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "--postinstall"

  # === GLOBAL STATE MANIPULATION ===
  # Setting global flags for malware state tracking

  - id: global-dunder-assignment
    desc: Global __variable assignment
    crit: notable
    conf: 0.75
    mbc: "B0024"
    if:
      type: string
      regex: "global\\.__[a-z_]+"
      case_insensitive: true

  - id: global-postinstall-flag
    desc: Global postinstall state flag
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    if:
      type: string
      regex: "global\\.__[a-z_]*postinstall"
      case_insensitive: true

  # === DUNDER VARIABLE PATTERNS (content matching for .d.ts files) ===
  # TypeScript declaration files don't extract identifiers as strings
  # These patterns catch malware state tracking variables in declarations

  - id: dunder-postinstall-decl
    desc: Dunder postinstall variable declaration
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    if:
      type: content
      regex: "__[a-z_]*postinstall"
      case_insensitive: true

  - id: dunder-token-decl
    desc: Dunder token storage variable
    crit: suspicious
    conf: 0.85
    mbc: "E1059"
    attack: "T1528"
    if:
      type: content
      regex: "__[a-z_]*_token\\b"
      case_insensitive: true

  # === STEALER BASENAME DETECTION ===
  # Files named stealer/grabber are strong indicators

  - id: stealer-basename
    desc: File named stealer
    crit: suspicious
    conf: 0.9
    mbc: "E1059"
    for: [javascript]
    if:
      type: string
      regex: "^[Ss]tealer\\."

  - id: grabber-basename
    desc: File named grabber
    crit: suspicious
    conf: 0.9
    mbc: "E1059"
    for: [javascript]
    if:
      type: string
      regex: "^grabber\\."
      case_insensitive: true

composite_rules:
  # Stealer module import (any form)
  - id: stealer-import
    desc: Local stealer/grabber module import
    crit: suspicious
    conf: 0.9
    any:
      - id: local-stealer-import
      - id: stealer-string
      - id: grabber-string

  # Cloud sandbox detection
  - id: cloud-sandbox-check
    desc: Cloud environment sandbox detection
    crit: suspicious
    conf: 0.85
    mbc: "B0007"
    attack: "T1497.001"
    all:
      - id: obj/discovery/host/system::os-homedir-call
      - id: app-path-string

  # Postinstall hook abuse
  - id: postinstall-abuse
    desc: NPM postinstall hook abuse
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    any:
      - id: postinstall-argv-check
      - id: postinstall-flag-string

  # Supply chain stealer package (HOSTILE)
  # Complexity: file_types(+1) + all(+3) = 4
  - id: supply-chain-stealer
    desc: NPM supply chain stealer package
    crit: hostile
    conf: 0.98
    mbc: "E1059"
    for: [javascript, typescript]
    all:
      - id: stealer-import
      - id: postinstall-abuse
      - id: obj/discovery/host/system::os-homedir-call

  # Stealer with sandbox evasion (HOSTILE)
  # Complexity: file_types(+1) + all(+3) = 4
  - id: stealer-sandbox-evasion
    desc: Stealer with sandbox evasion
    crit: hostile
    conf: 0.98
    mbc: "B0007"
    attack: "T1497.001"
    for: [javascript, typescript]
    all:
      - id: stealer-import
      - id: cloud-sandbox-check
      - id: cap/process/exit/terminate::process-exit

  # Stealer declaration file (combines basename + credential storage patterns)
  # Complexity: file_types(+1) + all(+3) = 4
  - id: stealer-declaration
    desc: Stealer module declaration with token storage
    crit: hostile
    conf: 0.95
    mbc: "E1059"
    attack: "T1528"
    for: [javascript, typescript]
    all:
      - id: stealer-basename
      - id: dunder-token-decl
      - id: dunder-postinstall-decl

  # Stealer file with postinstall tracking (slightly lower bar)
  # Complexity: file_types(+1) + all(+2) = 3 -> suspicious
  - id: stealer-postinstall-tracking
    desc: Stealer file with postinstall state
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    for: [javascript, typescript]
    all:
      - id: stealer-basename
      - id: dunder-postinstall-decl

  # Token theft declaration pattern (any file)
  # Complexity: file_types(+1) + all(+2) = 3 -> suspicious
  - id: token-theft-declaration
    desc: Token storage with postinstall tracking
    crit: suspicious
    conf: 0.88
    mbc: "E1059"
    attack: "T1528"
    for: [javascript, typescript]
    all:
      - id: dunder-token-decl
      - id: dunder-postinstall-decl
