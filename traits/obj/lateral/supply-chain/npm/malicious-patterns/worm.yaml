# NPM Worm / Replication Behaviors
# ATT&CK: T1098 (Account Manipulation), T1562 (Defense Evasion)
# MBC: F0001 (Worm-like Replication)

defaults:
  attack: "T1098"
  mbc: "F0001"

traits:
  - id: npm-owner-add-exec
    desc: Executes npm owner add command
    crit: suspicious
    for: [javascript, typescript]
    if:
      type: string
      regex: 'npm\s+owner\s+add'

  - id: npm-whoami-exec
    desc: Executes npm whoami command
    crit: notable
    for: [javascript, typescript]
    if:
      type: string
      regex: 'npm\s+whoami'

  - id: npm-profile-url
    desc: NPM user profile URL pattern
    crit: inert
    for: [javascript, typescript]
    if:
      type: string
      regex: 'npmjs\.org/~'

  - id: remove-postinstall
    desc: Removes postinstall script
    crit: suspicious
    for: [javascript, typescript]
    if:
      type: string
      regex: 'delete\s+\w+\.scripts\.postinstall'

composite_rules:
  - id: npm-package-worm
    desc: NPM package worm (adds owner to packages)
    crit: hostile
    for: [javascript, typescript]
    all:
      - id: npm-owner-add-exec
      - id: npm-whoami-exec
    any:
      - id: npm-profile-url
      - id: remove-postinstall