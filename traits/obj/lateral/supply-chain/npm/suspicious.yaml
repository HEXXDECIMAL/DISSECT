# NPM Package Structure Anomalies
# Patterns specific to npm supply-chain attacks - package structure and metadata
# Generic JS behaviors should be in their objective directories

defaults:
  for: [packagejson]

traits:
  # === Export detection micro-traits ===
  - id: module-exports-pattern
    desc: CommonJS module.exports pattern
    crit: inert
    conf: 0.8
    for: [javascript]
    if:
      type: ast
      kind: assignment
      exact: "module.exports"

  - id: exports-dot-pattern
    desc: CommonJS exports.{0,50} pattern
    crit: inert
    conf: 0.8
    for: [javascript]
    if:
      type: ast
      kind: assignment
      exact: "exports."

  - id: esm-export-pattern
    desc: ESM export statement
    crit: inert
    conf: 0.8
    for: [javascript]
    if:
      type: ast
      node: export_statement
      exact: "export"

  # === Node.js require micro-traits ===
  - id: require-os
    desc: require('os') import
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: ast
      query: |
        ((call_expression
          function: (identifier) @fn
          arguments: (arguments (string) @arg))
         (#eq? @fn "require")
         (#match? @arg "'os'|\"os\""))

  - id: require-child-process
    desc: require('child_process') import
    crit: notable
    conf: 0.8
    for: [javascript]
    if:
      type: ast
      query: |
        ((call_expression
          function: (identifier) @fn
          arguments: (arguments (string) @arg))
         (#eq? @fn "require")
         (#match? @arg "'child_process'|\"child_process\""))

  - id: require-https
    desc: require('https') import
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: ast
      query: |
        ((call_expression
          function: (identifier) @fn
          arguments: (arguments (string) @arg))
         (#eq? @fn "require")
         (#match? @arg "'https'|\"https\""))

  - id: require-fs
    desc: require('fs') import
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: ast
      query: |
        ((call_expression
          function: (identifier) @fn
          arguments: (arguments (string) @arg))
         (#eq? @fn "require")
         (#match? @arg "'fs'|\"fs\""))

  # === package.json micro-traits ===
  - id: pkg-dependencies
    desc: Package has dependencies field
    crit: inert
    conf: 0.9
    if:
      type: string
      substr: '"dependencies":'

  - id: pkg-preinstall-hook
    desc: Package has preinstall hook
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: '"preinstall":'

  - id: pkg-postinstall-hook
    desc: Package has postinstall hook
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: '"postinstall":'

  - id: pkg-install-hook
    desc: Package has install hook
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: '"install":'

  - id: pkg-version-001
    desc: Package version 0.0.1 (brand new)
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: '"version": "0.0.1"'

  - id: pkg-repository
    desc: Package has repository field
    crit: inert
    conf: 0.9
    if:
      type: string
      substr: '"repository":'

  # Package writes to node_modules (persistence)
  - id: node-modules-write
    desc: Package writes to node_modules directory
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: "(?:writeFile|writeFileSync|appendFile)\\s*\\([^)]*node_modules"

  # Reads .npmrc (token theft)
  - id: npmrc-read
    desc: Reads .npmrc file (token theft)
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: "(?:readFile|readFileSync)\\s*\\([^)]*\\.npmrc"

  # Package writes to package.json (persistence)
  - id: package-json-write
    desc: Writes to package.json file
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript]
    if:
      type: string
      regex: "writeFileSync\\s*\\([^)]*package\\.json|writeFile\\s*\\([^)]*package\\.json"

  # Scoped package mimicking popular library
  - id: scoped-typosquat
    desc: Scoped package mimicking well-known package
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: '"name":\\s*"@[^/]+/(react|vue|angular|express|lodash|axios|webpack|babel|typescript|eslint|prettier|jest|mocha)'

  # === Orphan child process micro-traits ===
  - id: child-dot-unref
    desc: child.unref() call (orphan process)
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      exact: ".unref()"

  - id: spawn-unref
    desc: spawn().unref() call (orphan process)
    crit: notable
    conf: 0.75
    for: [javascript, typescript]
    if:
      type: string
      regex: "spawn\\([^)]+\\)\\.unref\\(\\)"

  # === Silent process execution micro-traits ===
  - id: stdio-ignore-string
    desc: "stdio: 'ignore' pattern"
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "stdio:\\s*['\"]ignore['\"]"

  - id: stdio-ignore-array
    desc: "stdio: [...ignore...] pattern"
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "stdio:\\s*\\[.{0,50}ignore"

  # Bug bounty / security research markers
  - id: bug-bounty-marker
    desc: Bug bounty or security research
    crit: notable
    conf: 0.9
    for: [javascript, packagejson]
    if:
      type: string
      regex: "bug\\s*bounty|hackerone|bugcrowd|security\\s*research|proof\\s*of\\s*concept|PoC|benign\\s*test"
      case_insensitive: true

  # === Filesize micro-traits ===
  - id: small-file-5k
    desc: Small file under 5KB
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: filesize
      max: 5120

  # === OOB exfil domain micro-traits ===
  - id: oast-fun-domain
    desc: oast.fun exfil domain
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    if:
      type: string
      substr: "oast.fun"

  - id: oastify-domain
    desc: oastify.com exfil domain
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    if:
      type: string
      substr: "oastify.com"

  - id: oast-me-domain
    desc: oast.me exfil domain
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    if:
      type: string
      substr: "oast.me"

  - id: webhook-site-domain
    desc: webhook.site exfil domain
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    if:
      type: string
      substr: "webhook.site"

  - id: pipedream-domain
    desc: pipedream.net exfil domain
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    if:
      type: string
      substr: "pipedream.net"

  - id: discord-webhook
    desc: Discord webhook exfil endpoint
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    if:
      type: string
      substr: "discord.com/api/webhooks"

  # === Placeholder/Default Author Patterns ===
  # Malicious packages often use placeholder author values

  - id: placeholder-author-your-name
    desc: Placeholder author "Your Name"
    crit: suspicious
    conf: 0.85
    for: [packagejson]
    if:
      type: content
      regex: '"author":\s*"Your Name"'

  - id: placeholder-author-generic
    desc: Generic placeholder author patterns
    crit: notable
    conf: 0.75
    for: [packagejson]
    if:
      type: content
      regex: '"author":\s*"(?:author|your name|name|test|user|admin|example|sample|anonymous)"'
      case_insensitive: true

  # === Minimal Metadata Patterns ===
  # Malicious packages often lack standard package metadata

  - id: pkg-no-description-short
    desc: Very short/empty description
    crit: inert
    conf: 0.7
    for: [packagejson]
    if:
      type: content
      regex: '"description":\s*"[^"]{0,15}"'

  - id: pkg-main-resp-path
    desc: Main uses resp/ directory
    crit: notable
    conf: 0.7
    for: [packagejson]
    if:
      type: content
      contains: '"main": "resp/'

  # === CDN/Template Facade Patterns ===
  # Phishing packages often pretend to be CDN assets or templates

  - id: cdn-keyword-facade
    desc: CDN-related keywords
    crit: inert
    conf: 0.6
    for: [packagejson]
    if:
      type: content
      regex: '"keywords":\s*\[[^\]]*"(?:jsdelivr|cdn|cloudflare|unpkg)"'

  - id: template-keyword
    desc: Template keyword in package
    crit: inert
    conf: 0.5
    for: [packagejson]
    if:
      type: content
      contains: '"template"'

  # === Deceptive Placeholder Package Patterns ===
  # Attackers use "dependency confusion placeholder" descriptions to social-engineer their way
  # past security review. These packages claim to be protective but may be malicious.

  - id: desc-dependency-confusion
    desc: Description mentions dependency confusion
    crit: notable
    conf: 0.8
    for: [packagejson]
    if:
      type: content
      regex: '"description":\s*"[^"]*dependency\s*confusion[^"]*"'
      case_insensitive: true

  - id: desc-placeholder-package
    desc: Description mentions placeholder package
    crit: notable
    conf: 0.75
    for: [packagejson]
    if:
      type: content
      regex: '"description":\s*"[^"]*placeholder[^"]*"'
      case_insensitive: true

  - id: desc-prevent-squat
    desc: Description claims to prevent squatting
    crit: notable
    conf: 0.75
    for: [packagejson]
    if:
      type: content
      regex: '"description":\s*"[^"]*(prevent|protect|reserve|claim)[^"]*(squat|confusion|typo)[^"]*"'
      case_insensitive: true

  # === JavaScript Placeholder Announcement ===
  # Code that outputs "placeholder package" messages is suspicious
  # Legitimate placeholder packages don't need to announce themselves in code
  # This is a social engineering technique to appear benign

  - id: js-placeholder-announcement
    desc: Code announces placeholder package status
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1195.002"
    for: [javascript]
    if:
      type: string
      regex: "(?:placeholder|reserved|do not use|prevent(?:s|ing)?\\s+(?:dependency\\s+)?confusion)"
      case_insensitive: true

  - id: pkg-version-100
    desc: Package version 1.0.0 (initial release)
    crit: inert
    conf: 0.5
    for: [packagejson]
    if:
      type: content
      exact: '"version": "1.0.0"'

composite_rules:
  # Has exports composite
  - id: has-exports
    desc: Module has exports
    crit: inert
    conf: 0.8
    for: [javascript]
    needs: 1
    any:
      - id: module-exports-pattern
      - id: exports-dot-pattern
      - id: esm-export-pattern

  # Dangerous requires for tiny packages
  - id: dangerous-requires
    desc: Dangerous Node.js API imports
    crit: notable
    conf: 0.8
    for: [javascript]
    needs: 3
    any:
      - id: require-os
      - id: require-child-process
      - id: require-https
      - id: require-fs

  # Single file with dangerous APIs - migrated from YARA
  - id: single-file-dangerous
    desc: Tiny npm package using dangerous
    crit: suspicious
    conf: 0.85
    for: [javascript]
    all:
      - id: small-file-5k
      - id: dangerous-requires

  # Install hooks composite
  - id: install-hooks
    desc: Package has install hooks
    crit: notable
    conf: 0.85
    needs: 1
    any:
      - id: pkg-preinstall-hook
      - id: pkg-postinstall-hook
      - id: pkg-install-hook

  # No deps with hooks - migrated from YARA
  - id: no-deps-with-hooks
    desc: Package has install hooks but
    crit: suspicious
    conf: 0.85
    all:
      - id: install-hooks
    none:
      - id: pkg-dependencies

  # Multiple install hooks - migrated from YARA
  - id: multiple-hooks
    desc: Package has multiple install lifecycle
    crit: suspicious
    conf: 0.85
    needs: 2
    any:
      - id: pkg-preinstall-hook
      - id: pkg-postinstall-hook
      - id: pkg-install-hook

  # New version with hooks - migrated from YARA
  - id: new-version-hooks
    desc: Brand new version (0.0.1) with
    crit: suspicious
    conf: 0.8
    all:
      - id: pkg-version-001
      - id: install-hooks

  # Missing metadata with hooks - migrated from YARA
  - id: missing-metadata-hooks
    desc: Package missing standard metadata but
    crit: suspicious
    conf: 0.85
    all:
      - id: install-hooks
    none:
      - id: pkg-repository

  # Child unref composite
  - id: child-unref
    desc: Orphan child process (unref pattern)
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript]
    needs: 1
    any:
      - id: child-dot-unref
      - id: spawn-unref

  # Stdio ignore composite
  - id: stdio-ignore
    desc: Silent process execution (stdio ignored)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    needs: 1
    any:
      - id: stdio-ignore-string
      - id: stdio-ignore-array

  # Multiple OOB exfil domains - migrated from YARA
  - id: multi-oob
    desc: Multiple OOB exfiltration endpoints
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, packagejson]
    needs: 2
    any:
      - id: oast-fun-domain
      - id: oastify-domain
      - id: oast-me-domain
      - id: webhook-site-domain
      - id: pipedream-domain
      - id: discord-webhook

  # === Placeholder/Suspicious Metadata Composites ===

  # Placeholder author with no repository - highly suspicious
  - id: placeholder-no-repo
    desc: Placeholder author without repository
    crit: suspicious
    conf: 0.85
    for: [packagejson]
    all:
      - id: placeholder-author-your-name
    none:
      - id: pkg-repository

  # === Data Exfiltration Patterns ===

  # System info exfiltration - small npm package collects system info and sends via HTTP POST
  # This is the classic npm supply-chain telemetry/data exfiltration pattern
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: npm-data-exfil
    desc: NPM package exfiltrates system info via HTTP
    crit: hostile
    conf: 0.95
    attack: "T1020"
    mbc: "E1041"
    for: [javascript]
    all:
      - id: obj/discovery/system/js-sysinfo-multi
      - id: cap/comm/http/post/post
      - id: small-file-5k

  # Victim identification with HTTP POST - slightly less certainty but still hostile
  # Complexity: file_types(+1) + all(+3) = 4
  - id: npm-victim-exfil
    desc: NPM package sends victim ID via HTTP POST
    crit: hostile
    conf: 0.92
    attack: "T1020"
    mbc: "E1041"
    for: [javascript]
    all:
      - id: obj/discovery/system/js-victim-id
      - id: cap/comm/http/post/post
      - id: small-file-5k

  # Suspicious combo: system info + HTTP but larger file
  - id: npm-sysinfo-http
    desc: NPM package with system info and HTTP POST
    crit: suspicious
    conf: 0.85
    attack: "T1082"
    for: [javascript]
    all:
      - id: obj/discovery/system/js-victim-id
      - id: cap/comm/http/post/post

  # === Deceptive Placeholder Package Composites ===

  # Dependency confusion mention in description (without verification)
  # Packages claiming to be "dependency confusion placeholders" are often
  # the dependency confusion attack itself - a social engineering cover story
  - id: dependency-confusion-claim
    desc: Package claims dependency confusion protection
    crit: notable
    conf: 0.8
    for: [packagejson]
    needs: 1
    any:
      - id: desc-dependency-confusion
      - id: desc-placeholder-package
      - id: desc-prevent-squat

  # Deceptive placeholder: claims protection but lacks legitimacy markers
  # This is suspicious because legitimate placeholder packages typically have:
  # - A repository link to the organization claiming the namespace
  # - Contact information or homepage
  # - A more detailed description explaining the reservation
  - id: deceptive-placeholder-package
    desc: Deceptive dependency confusion placeholder
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    mbc: "B0024"
    for: [packagejson]
    all:
      - id: dependency-confusion-claim
      - id: obj/lateral/supply-chain/npm/no-repository-field
      - id: obj/lateral/supply-chain/npm/no-bugs-field
