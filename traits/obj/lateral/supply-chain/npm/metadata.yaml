# npm Package Metadata Patterns
# Detects suspicious metadata patterns in package.json
# These patterns often indicate malicious or typosquatting packages

defaults:
  for: [packagejson]

traits:
  # === VSCode Extension Detection ===
  - id: vscode-extension
    desc: Package is a VSCode extension
    crit: inert
    conf: 0.95
    if:
      type: kv
      path: "engines.vscode"

  # === Install Hooks ===
  - id: preinstall-hook-key
    desc: Package has preinstall script
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "scripts.preinstall"

  - id: postinstall-hook-key
    desc: Package has postinstall script
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "scripts.postinstall"

  - id: install-hook-key
    desc: Package has install script
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "scripts.install"

  # === Version Patterns ===
  - id: version-1.0.0
    desc: Package version is 1.0.0
    crit: inert
    conf: 0.6
    if:
      type: kv
      path: "version"
      exact: "1.0.0"

  # === Repository/Homepage Patterns ===
  - id: npm-homepage-url
    desc: Package homepage points to npm
    crit: notable
    conf: 0.75
    if:
      type: kv
      path: "homepage"
      substr: "npmjs.com"

  - id: npm-repo-url
    desc: Repository URL points to npm
    crit: notable
    conf: 0.75
    if:
      type: kv
      path: "repository.url"
      substr: "npmjs.com"

  - id: repository-key
    desc: Package has repository field
    crit: inert
    conf: 0.9
    if:
      type: kv
      path: "repository"

  - id: has-bugs-url
    desc: Package has bugs URL
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "bugs.url"

  - id: has-homepage
    desc: Package has homepage URL
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "homepage"

  - id: repo-url-git-host
    desc: Repository on GitHub/GitLab/Bitbucket
    crit: inert
    conf: 0.9
    if:
      type: kv
      path: "repository.url"
      regex: "github\\.com|gitlab\\.com|bitbucket\\.org"

  # === Description Patterns ===
  - id: desc-lightweight
    desc: Description mentions lightweight
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      substr: "lightweight"
      case_insensitive: true

  - id: desc-modern-web-apps
    desc: Description mentions modern web apps
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      regex: "modern.*(web|app)"
      case_insensitive: true

  - id: desc-universal
    desc: Description mentions universal
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      substr: "universal"
      case_insensitive: true

  - id: desc-powerful-library
    desc: Description mentions powerful library
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      regex: "powerful.*(library|framework)"
      case_insensitive: true

  - id: desc-simple-easy
    desc: Description mentions simple/easy
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      regex: "simple|easy"
      case_insensitive: true

# === Composite Rules ===
composite_rules:
  # Install hook group
  - id: install-hooks
    desc: Package has install hook
    crit: inert
    conf: 0.6
    any:
      - id: preinstall-hook-key
      - id: postinstall-hook-key
      - id: install-hook-key

  # Version 1.0.0 with install hooks
  - id: version-1.0.0-with-hooks
    desc: Version 1.0.0 with install hooks
    crit: suspicious
    conf: 0.75
    all:
      - id: version-1.0.0
      - id: install-hooks

  # npm URL as homepage/repository
  - id: npm-as-homepage
    desc: Package uses npmjs.com as homepage
    crit: notable
    conf: 0.8
    any:
      - id: npm-homepage-url
      - id: npm-repo-url

  # Repository presence check
  - id: npm-has-repository
    desc: Package has repository URL
    crit: inert
    conf: 0.5
    any:
      - id: repository-key
      - id: repo-url-git-host

  # Missing repository with install hooks
  - id: no-repo-with-hooks
    desc: Package has install hooks but no repo
    crit: suspicious
    conf: 0.85
    all:
      - id: install-hooks
    none:
      - id: npm-has-repository

  # Generic descriptions group
  - id: generic-descriptions
    desc: Package has generic marketing description
    crit: inert
    conf: 0.5
    needs: 2
    any:
      - id: desc-lightweight
      - id: desc-modern-web-apps
      - id: desc-universal
      - id: desc-powerful-library
      - id: desc-simple-easy

  # Generic description with hooks
  - id: generic-desc-with-hooks
    desc: Generic description with install hooks
    crit: suspicious
    conf: 0.8
    all:
      - id: generic-descriptions
      - id: install-hooks
