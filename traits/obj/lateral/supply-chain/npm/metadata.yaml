# npm Package Metadata Patterns
# Detects suspicious metadata patterns in package.json
# These patterns often indicate malicious or typosquatting packages

defaults:
  for: [packagejson]

traits:
  # === VSCode Extension Detection ===
  - id: vscode-extension
    desc: Package is a VSCode extension
    crit: inert
    conf: 0.95
    if:
      type: kv
      path: "engines.vscode"

  # === Install Hooks ===
  - id: preinstall-hook-key
    desc: Package has preinstall script
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "scripts.preinstall"

  - id: postinstall-hook-key
    desc: Package has postinstall script
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "scripts.postinstall"

  - id: install-hook-key
    desc: Package has install script
    crit: notable
    conf: 0.85
    if:
      type: kv
      path: "scripts.install"

  # === Version Patterns ===
  - id: version-1.0.0
    desc: Package version is 1.0.0
    crit: inert
    conf: 0.6
    if:
      type: kv
      path: "version"
      exact: "1.0.0"

  # === Repository/Homepage Patterns ===
  - id: npm-homepage-url
    desc: Package homepage points to npm
    crit: notable
    conf: 0.75
    if:
      type: kv
      path: "homepage"
      substr: "npmjs.com"

  - id: npm-repo-url
    desc: Repository URL points to npm
    crit: notable
    conf: 0.75
    if:
      type: kv
      path: "repository.url"
      substr: "npmjs.com"

  - id: repository-key
    desc: Package has repository field
    crit: inert
    conf: 0.9
    if:
      type: kv
      path: "repository"

  - id: has-bugs-url
    desc: Package has bugs URL
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "bugs.url"

  - id: has-homepage
    desc: Package has homepage URL
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "homepage"

  - id: repo-url-git-host
    desc: Repository on GitHub/GitLab/Bitbucket
    crit: inert
    conf: 0.9
    if:
      type: kv
      path: "repository.url"
      regex: "github\\.com|gitlab\\.com|bitbucket\\.org"

  # === Repository Format Patterns ===

  # GitHub shorthand: "User/repo-name" (no full URL)
  # npm supports this as a shorthand for GitHub repositories
  # Typosquats often copy the original repo field directly
  - id: repo-shorthand-format
    desc: Repository uses GitHub shorthand format
    crit: inert
    conf: 0.8
    if:
      type: kv
      path: "repository"
      regex: "^[A-Za-z0-9_.-]+/[a-z0-9][a-z0-9._-]*$"

  # Package name is a hyphenated multi-word name
  # Common target for word-swap typosquatting (e.g., config-cordova vs cordova-config)
  - id: name-hyphenated-multiword
    desc: Package name has hyphenated multi-word format
    crit: inert
    conf: 0.7
    if:
      type: kv
      path: "name"
      regex: "^[a-z][a-z0-9]*(-[a-z][a-z0-9]*)+$"

  # Package version suggests maturity (>= 0.2.0 or >= 1.0.0)
  # Mature packages should have complete metadata (bugs, homepage)
  # Version inflation is a dependency confusion indicator
  - id: version-mature
    desc: Package version suggests maturity
    crit: inert
    conf: 0.6
    if:
      type: kv
      path: "version"
      regex: "^0\\.[2-9]\\.|^[1-9]"

  # === Description Patterns ===
  - id: desc-lightweight
    desc: Description mentions lightweight
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      substr: "lightweight"
      case_insensitive: true

  - id: desc-modern-web-apps
    desc: Description mentions modern web apps
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      regex: "modern.*(web|app)"
      case_insensitive: true

  - id: desc-universal
    desc: Description mentions universal
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      substr: "universal"
      case_insensitive: true

  - id: desc-powerful-library
    desc: Description mentions powerful library
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      regex: "powerful.*(library|framework)"
      case_insensitive: true

  - id: desc-simple-easy
    desc: Description mentions simple/easy
    crit: inert
    conf: 0.5
    if:
      type: kv
      path: "description"
      regex: "simple|easy"
      case_insensitive: true

# === Composite Rules ===
composite_rules:
  # Install hook group
  - id: install-hooks
    desc: Package has install hook
    crit: inert
    conf: 0.6
    any:
      - id: preinstall-hook-key
      - id: postinstall-hook-key
      - id: install-hook-key

  # Version 1.0.0 with install hooks
  - id: version-1.0.0-with-hooks
    desc: Version 1.0.0 with install hooks
    crit: suspicious
    conf: 0.75
    all:
      - id: version-1.0.0
      - id: install-hooks

  # npm URL as homepage/repository
  - id: npm-as-homepage
    desc: Package uses npmjs.com as homepage
    crit: notable
    conf: 0.8
    any:
      - id: npm-homepage-url
      - id: npm-repo-url

  # Repository presence check
  - id: npm-has-repository
    desc: Package has repository URL
    crit: inert
    conf: 0.5
    any:
      - id: repository-key
      - id: repo-url-git-host

  # Missing repository with install hooks
  - id: no-repo-with-hooks
    desc: Package has install hooks but no repo
    crit: suspicious
    conf: 0.85
    all:
      - id: install-hooks
    none:
      - id: npm-has-repository

  # Generic descriptions group
  - id: generic-descriptions
    desc: Package has generic marketing description
    crit: inert
    conf: 0.5
    needs: 2
    any:
      - id: desc-lightweight
      - id: desc-modern-web-apps
      - id: desc-universal
      - id: desc-powerful-library
      - id: desc-simple-easy

  # Generic description with hooks
  - id: generic-desc-with-hooks
    desc: Generic description with install hooks
    crit: suspicious
    conf: 0.8
    all:
      - id: generic-descriptions
      - id: install-hooks

  # === Cloned/Copied Package Identity ===
  # When a package has a GitHub shorthand repo pointing to someone else's project
  # but is missing standard auto-generated metadata fields (bugs, homepage),
  # it suggests the package.json was copied from the original and the name changed.
  # This is an indicator of typosquatting or name-confusion attacks.
  # Many legitimate small packages also match, so crit is notable not suspicious.
  - id: cloned-package-identity
    desc: Copied package.json with incomplete metadata
    crit: notable
    conf: 0.75
    attack: "T1195.002"
    all:
      - id: repo-shorthand-format
      - id: name-hyphenated-multiword
    none:
      - id: has-bugs-url
      - id: has-homepage

  # Mature version with cloned identity
  # A package claiming version >= 0.2.0 should have complete metadata.
  # Combined with shorthand repo and missing bugs/homepage, this strongly
  # suggests the package was copied from another project with a new name.
  # This pattern is common in typosquatting and dependency confusion attacks.
  # Complexity: all(+3) + none(+0.6+2) = 5.6 (meets suspicious threshold)
  - id: mature-cloned-package
    desc: Mature version with cloned incomplete metadata
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    mbc: "F0004"
    all:
      - id: version-mature
      - id: repo-shorthand-format
      - id: name-hyphenated-multiword
    none:
      - id: has-bugs-url
      - id: has-homepage
