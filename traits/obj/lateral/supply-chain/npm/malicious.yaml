# NPM Malicious Package Patterns (Supply-Chain Specific)
# ATT&CK: T1195.002 (Supply Chain Compromise)
# These patterns are specific to npm supply-chain attacks, not generic behaviors

traits:
  # === Lifecycle hook atomic indicators ===
  - id: preinstall-hook
    desc: preinstall lifecycle hook
    crit: inert
    conf: 0.6
    r#for: [packagejson]
    if:
      type: content


composite_rules:
  # Lifecycle hook helpers
  - id: lifecycle-hook
    desc: NPM lifecycle hook (preinstall or
    crit: inert
    conf: 0.6
    r#for: [packagejson]
    count_min: 1
    any:
      - id: preinstall-hook
      - id: postinstall-hook

  # Download command helpers
  - id: download-command
    desc: Download command (curl or wget)
    crit: notable
    conf: 0.7
    r#for: [packagejson]
    count_min: 1
    any:
      - id: curl-command
      - id: wget-command

  # Pipe to shell helpers
  - id: pipe-to-shell
    desc: Pipe to shell interpreter
    crit: notable
    conf: 0.75
    r#for: [packagejson]
    count_min: 1
    any:
      - id: pipe-to-bash
      - id: pipe-to-sh
      - id: pipe-to-node

  # Node eval helpers
  - id: node-eval
    desc: Node inline eval (node -e
    crit: notable
    conf: 0.8
    r#for: [packagejson]
    count_min: 1
    any:
      - id: node-dash-e
      - id: node-eval-flag

  # NPM preinstall/postinstall abuse with dropper behavior
  - id: lifecycle-dropper
    desc: NPM lifecycle script with dropper
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    r#for: [packagejson]
    all:
      - id: lifecycle-hook
      - id: download-command
      - id: pipe-to-shell

  # NPM package with inline node eval in hooks
  - id: hook-node-eval
    desc: NPM install hook with node
    crit: suspicious
    conf: 0.95
    attack: "T1059.007"
    mbc: "B0024"
    r#for: [packagejson]
    all:
      - id: lifecycle-hook
      - id: node-eval

  # Install hook spawns child process
  - id: hook-child-process
    desc: NPM install hook using child_process
    crit: suspicious
    conf: 0.85
    attack: "T1195.002"
    r#for: [packagejson]
    all:
      - id: lifecycle-hook
      - id: child-process-module
