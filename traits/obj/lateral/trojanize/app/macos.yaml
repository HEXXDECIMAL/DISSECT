# macOS Application Trojanization
# Detects replacement of legitimate applications with malicious versions
# ATT&CK: T1574.001 (Hijack Execution Flow: DLL Search Order Hijacking)
# Note: Conceptually similar - replacing legitimate executables

defaults:
  attack: "T1574.001"
  platforms: [macos]
  crit: suspicious

traits:
  # === macOS app bundle hijacking indicators ===
  - id: cfbundle-exe-key
    desc: CFBundleExecutable key manipulation
    crit: notable
    conf: 0.7
    attack: "T1574.001"
    if:
      type: string
      substr: "CFBundleExecutable"

  - id: app-contents-path
    desc: .app/Contents/ bundle path access
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: ".app/Contents/"

  # Ledger Live application path
  - id: ledger-app-path
    desc: "Ledger Live application path reference"
    conf: 0.85
    if:
      type: string
      substr: "/Applications/Ledger Live.app"

  # === pkill atomic indicators ===
  - id: pkill-ledger-live
    desc: pkill Ledger Live
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "pkill.{0,30}Ledger Live"

  - id: killall-ledger
    desc: killall Ledger
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "killall.{0,30}Ledger"

  # === Remove applications atomic indicators ===
  - id: rm-applications-dir
    desc: rm -r /Applications/
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "rm\\s+-r.{0,50}\"/Applications/"

  - id: sudo-rm-app
    desc: sudo rm .app
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "sudo.{0,30}rm.{0,50}\\.app"

  # === Unzip applications atomic indicators ===
  - id: unzip-to-applications
    desc: unzip to /Applications
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "unzip.{0,50}/Applications"

  - id: unzip-d-applications
    desc: unzip -d /Applications
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "unzip.{0,30}-d.{0,30}/Applications"

  # === Download app atomic indicators ===
  - id: curl-app-zip
    desc: curl .app.zip download
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "curl.{0,100}\\.app\\.zip"

  - id: curl-app-archive
    desc: curl app.zip download
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "curl.{0,100}app\\.zip"

  - id: wget-app-zip
    desc: wget .app.zip download
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "wget.{0,100}\\.app\\.zip"

  # === App replacement atomic indicators ===
  - id: rm-app-unzip
    desc: rm .app && unzip pattern
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "rm.{0,50}\\.app.{0,30}&&.{0,30}unzip"

  - id: rm-app-cp
    desc: rm .app && cp pattern
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "rm.{0,50}\\.app.{0,30}&&.{0,30}cp"

  # === Programmatic app launch indicators ===
  - id: nsworkspace-open-file
    desc: NSWorkspace openFile programmatic launch
    crit: notable
    conf: 0.8
    for: [macho]
    if:
      type: string
      substr: "openFile:"

  - id: nsworkspace-shared
    desc: NSWorkspace sharedWorkspace singleton
    crit: inert
    conf: 0.7
    for: [macho]
    if:
      type: string
      substr: "sharedWorkspace"

  - id: path-append-component
    desc: Path construction via ObjC method
    crit: inert
    conf: 0.6
    for: [macho]
    if:
      type: string
      substr: "stringByAppendingPathComponent:"

  # === Native app infection indicators ===
  - id: infect-apps-symbol
    desc: Application infection function name
    crit: suspicious
    conf: 0.9
    attack: "T1080"
    platforms: [all]
    for: [macho, elf]
    if:
      type: string
      regex: "_(infectApps|infect_apps|InfectApps)"

  - id: copy-self-symbol
    desc: Self-copy function name
    crit: suspicious
    conf: 0.85
    attack: "T1080"
    platforms: [all]
    for: [macho, elf]
    if:
      type: string
      regex: "_(copySelf|copy_self|CopySelf)"

  - id: install-hooks-symbol
    desc: Hook installation function name
    crit: suspicious
    conf: 0.85
    attack: "T1574"
    platforms: [all]
    for: [macho, elf]
    if:
      type: string
      regex: "_(installHooks|install_hooks|InstallHooks)"

composite_rules:
  # Self-replication indicators
  - id: self-replication-symbols
    desc: Self-replicating infection symbols
    crit: suspicious
    conf: 0.9
    attack: "T1080"
    platforms: [all]
    for: [macho, elf]
    needs: 2
    any:
      - id: infect-apps-symbol
      - id: copy-self-symbol
      - id: install-hooks-symbol

  # macOS application infector worm
  # Complexity: all(3) + for(1) = 4 (meets hostile threshold)
  - id: app-infector-worm
    desc: macOS application infector worm
    crit: hostile
    conf: 0.95
    attack: "T1080"
    platforms: [all]
    for: [macho]
    all:
      - id: self-replication-symbols
      - id: obj/discovery/software/spotlight-app-enum
      - id: cap/exec/command/shell/shell-symbols

  - id: pkill-ledger
    desc: "Kill Ledger Live process"
    conf: 0.9
    needs: 1
    any:
      - id: pkill-ledger-live
      - id: killall-ledger

  - id: rm-applications
    desc: "Remove application from /Applications"
    crit: suspicious
    conf: 0.9
    needs: 1
    any:
      - id: rm-applications-dir
      - id: sudo-rm-app

  - id: unzip-applications
    desc: "Unzip to /Applications directory"
    crit: suspicious
    conf: 0.85
    needs: 1
    any:
      - id: unzip-to-applications
      - id: unzip-d-applications

  - id: download-app-zip
    desc: "Download application archive"
    crit: suspicious
    conf: 0.85
    needs: 1
    any:
      - id: curl-app-zip
      - id: curl-app-archive
      - id: wget-app-zip

  - id: app-replacement
    desc: "Application replacement pattern"
    crit: suspicious
    conf: 0.8
    needs: 1
    any:
      - id: rm-app-unzip
      - id: rm-app-cp

  # App termination group
  - id: app-termination
    desc: App termination or removal
    crit: suspicious
    conf: 0.8
    for: [shell, applescript, python]
    needs: 1
    any:
      - id: pkill-ledger
      - id: rm-applications

  # App replacement group
  - id: app-replace-action
    desc: App replacement action
    crit: suspicious
    conf: 0.8
    for: [shell, applescript, python]
    needs: 1
    any:
      - id: unzip-applications
      - id: download-app-zip

  # Ledger Live replacement attack
  - id: ledger-trojanize
    desc: "Ledger Live application replacement attack"
    crit: hostile
    conf: 0.95
    attack: "T1574.001"
    for: [shell, applescript, python]
    all:
      - id: ledger-app-path
      - id: app-termination
      - id: app-replace-action

  # App bundle hijack: CFBundleExecutable patching + bundle path access
  - id: app-bundle-hijack
    desc: macOS app bundle executable hijacking
    crit: suspicious
    conf: 0.85
    attack: "T1574.001"
    all:
      - id: cfbundle-exe-key
      - id: app-contents-path

  # Programmatic app launch: NSWorkspace openFile + path construction
  - id: nsworkspace-app-launch
    desc: Programmatic app launch via NSWorkspace
    crit: notable
    conf: 0.85
    attack: "T1204.002"
    for: [macho]
    all:
      - id: nsworkspace-open-file
      - id: nsworkspace-shared

  # Watchdog relaunch: monitors process by PID + relaunches app
  # Complexity: all(3) + for(1) = 4 (meets hostile threshold)
  - id: watchdog-relaunch
    desc: Process watchdog with app relaunch
    crit: hostile
    conf: 0.9
    attack: "T1547.001"
    for: [macho]
    all:
      - id: cap/process/info/get-process-for-pid
      - id: nsworkspace-app-launch
      - id: cap/os/time/query/sleep

  # Generic app replacement
  - id: app-trojanize
    desc: "macOS application replacement attack"
    crit: suspicious
    conf: 0.9
    attack: "T1574.001"
    for: [shell, applescript, python]
    all:
      - id: rm-applications
      - id: unzip-applications
