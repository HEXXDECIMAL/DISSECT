# Memory Exploitation Chain
# Detects complete memory exploitation patterns
# Generic indicator across all advanced malware families

composite_rules:
  - id: executable-memory-allocation
    desc: Allocate executable memory
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    notes: |
      VirtualAlloc/VirtualAllocEx for code injection payload.
      First step in memory exploitation.

    any:
      - id: cap/mem/allocate/executable/windows

  - id: memory-protection-evasion
    desc: Modify memory protection for execution
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    notes: |
      VirtualProtect/VirtualProtectEx to enable code execution.
      Changes memory from RW to RX or RWX.

    any:
      - id: cap/mem/protect/modify

  - id: memory-exploitation-chain
    desc: Complete memory exploitation sequence
    crit: hostile
    conf: 0.92
    platforms: [windows]
    for: [pe]
    attack: "T1055"
    mbc: "B0033"
    notes: |
      Combines allocation + protection + injection.
      Full memory exploitation chain for deploying shellcode.

      Pattern observed in:
      - Ransomware (Ryuk, Conti, LockBit)
      - Banking trojans (Emotet, Trickbot)
      - APT malware (Carbanak, Fin7)

    all:
      - id: executable-memory-allocation
      - id: memory-protection-evasion
      - id: cap/process/inject/memory

  - id: memory-injection-pattern
    desc: Memory protection+injection exploitation pattern
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1055"
    mbc: "B0033"
    notes: |
      Combines memory protection modification with process injection.
      Common pattern for code injection into remote processes.

    all:
      - id: obj/lateral/memory-exploitation/memory-protection-evasion
      - id: cap/process/inject/memory

  - id: complete-injection-framework
    desc: Multi-layered memory+injection framework
    crit: hostile
    conf: 0.92
    platforms: [windows]
    for: [pe]
    attack: "T1055"
    mbc: "B0033"
    notes: |
      Combines allocated executable memory + protection + injection.
      Complete memory exploitation framework for code injection.

      Indicators of professional malware:
      - Ransomware (Ryuk, Conti, LockBit)
      - Banking trojans (Emotet, Trickbot)
      - APT malware (Carbanak, Fin7)

    all:
      - id: executable-memory-allocation
      - id: memory-protection-evasion
      - id: cap/process/inject/memory

