# Lateral Movement - Exploit Scanner/Deployer (Python)
# Mass exploitation tools that iterate over IP lists
# ATT&CK: T1210 (Exploitation of Remote Services)

defaults:
  for: [python]
  attack: "T1210"

traits:
  # Reading IP list from file
  - id: ip-list-read
    desc: Reading IP addresses from file
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "open\\([^)]*\\)\\.(read|readlines)\\(\\)"

  # POST request to variable IP/host
  - id: post-to-target
    desc: HTTP POST to dynamic target
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "(requests|aiohttp|httpx)\\.post\\s*\\(\\s*f['\"]"

  # === Threading atomic indicators ===
  - id: threading-dot-start
    desc: threading.start usage
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "threading.start"

  # Exploit path patterns (common vuln endpoints)
  - id: exploit-endpoint
    desc: Common exploit endpoint pattern
    crit: notable
    conf: 0.85
    # Small binaries with exploit paths are more suspicious
    size_max: 5000
    if:
      type: string
      regex: '\\$[0-9]{4,5}|/cgi-bin/|/admin/|/wp-admin|shell\\.php|cmd\\.asp'
    unless:
      - type: content
        regex: "fastapi|tutorial"

  # IP list sources - command line argument
  - id: ip-list-argv
    desc: IP list from command line
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "sys.argv[1]"

  # === IP list variable atomic indicators ===
  - id: ip-list-word
    desc: ip_list variable naming
    crit: inert
    conf: 0.4
    if:
      type: string
      substr: "ip_list"

  - id: targets-word
    desc: targets variable naming
    crit: inert
    conf: 0.4
    if:
      type: string
      substr: "targets"

  # HTTP library - aiohttp
  - id: http-aiohttp
    desc: Async HTTP via aiohttp library
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "aiohttp"

  # Exploit indicator - CVE reference
  - id: cve-reference
    desc: CVE identifier in code
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "CVE-[0-9]{4}-[0-9]{4,}"

  # Exploit indicator - exploit code comment
  - id: exploit-code-comment
    desc: Exploit mentioned in comment
    crit: notable
    conf: 0.6
    if:
      type: content
      regex: "#.{0,50}exploit|//.{0,50}exploit|/\\*.{0,50}exploit"

  # Exploit indicator - shell endpoint
  - id: shell-endpoint
    desc: Shell endpoint in URL
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "shell\\.(php|asp|jsp)|/shell[/?]"

  # Exploit indicator - shell command execution
  - id: shell-exec-pattern
    desc: Shell command execution pattern
    crit: notable
    conf: 0.6
    if:
      type: content
      regex: "(exec|system|passthru)\\s*\\(.{0,50}\\$_(GET|POST)"

  # Subprocess shell with user input
  - id: subprocess-shell-user-input
    desc: subprocess shell with user input
    crit: suspicious
    conf: 0.75
    if:
      type: content
      regex: "subprocess\\.(run|call|Popen).{0,50}(shell\\s*=\\s*True).{0,50}(input|argv|request)"

  # Exploit indicator - pawn keyword
  - id: pawn-keyword
    desc: Contains pawn keyword
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "(?i)pawn"

  # Threading - Thread class
  - id: threading-thread
    desc: Uses threading.Thread class
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "threading.Thread"

  # Async - asyncio
  - id: asyncio-usage
    desc: Uses asyncio library
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "asyncio"

  # Multiprocessing
  - id: multiprocessing-usage
    desc: Uses multiprocessing library
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "multiprocessing"

  # SSL bypass - verify=False
  - id: ssl-verify-false
    desc: SSL verify disabled
    crit: notable
    conf: 0.6
    if:
      type: content
      regex: "(?s)(requests|aiohttp|httpx|urllib3)\\.(get|post|put|delete|head|patch|request)\\s*\\(.{0,50}verify\\s*=\\s*False"

  # SSL bypass - verify_ssl=False
  - id: ssl-verify-ssl-false
    desc: SSL verify_ssl disabled
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "verify_ssl=False"

  # SSL bypass - InsecureRequestWarning
  - id: ssl-insecure-warning
    desc: Suppresses InsecureRequestWarning
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "InsecureRequestWarning"

  # File upload - files dict pattern
  - id: files-dict
    desc: Files dict for upload
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "files={"

  # File upload - multipart
  - id: multipart-upload
    desc: Multipart file upload
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "multipart"

  # File open call for exploit context
  # By itself this is a common Python idiom; only meaningful in composites
  - id: file-open
    desc: File open call in exploit context
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "open\\([^)]*\\)\\.(read|readlines)"

  # Binary read mode
  - id: binary-read-mode
    desc: Binary read mode
    crit: notable
    conf: 0.4
    if:
      type: string
      exact: "'rb'"

  # HTTP post method with dynamic target
  - id: http-post-call
    desc: HTTP POST method to dynamic target
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "(requests|aiohttp|httpx|urllib)\\.post"

  # For loop iteration - only notable when iterating over network targets
  - id: for-loop-iteration
    desc: For loop over network targets
    crit: notable
    conf: 0.4
    if:
      type: string
      regex: "for\\s+\\w+\\s+in\\s+(ip_list|targets|hosts|ips|addr)"

composite_rules:
  # IP list variable composite
  - id: ip-list-var
    desc: IP list variable naming pattern
    crit: notable
    conf: 0.5
    needs: 1
    any:
      - id: ip-list-word
      - id: targets-word

  # Threaded requests composite
  - id: threaded-requests
    desc: Multi-threaded network requests
    crit: notable
    conf: 0.6
    needs: 1
    any:
      - id: threading-thread
      - id: threading-dot-start

  # SSL disabled composite
  - id: ssl-disabled
    desc: SSL certificate verification disabled
    crit: suspicious
    conf: 0.8
    all:
      - id: http-post-call
    needs: 1
    any:
      - id: ssl-verify-false
      - id: ssl-verify-ssl-false
      - id: ssl-insecure-warning

  # Mass exploit scanner/deployer
  - id: mass-exploiter
    desc: Mass exploitation tool (IP list)
    crit: suspicious
    conf: 0.95
    attack: "T1210"
    mbc: "B0030"
    all:
      - id: http-post-call
    any:
      - id: ip-list-read
      - id: cve-reference

  # Vulnerability scanner with file upload
  - id: file-upload-exploit
    desc: File upload exploitation tool
    crit: suspicious
    conf: 0.9
    attack: "T1210"
    all:
      - id: files-dict
      - id: file-open
      - id: http-post-call
