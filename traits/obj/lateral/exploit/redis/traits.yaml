# Lateral Movement - Redis Exploitation
# Redis RCE attack patterns (unauthorized command injection, crontab write)
# ATT&CK: T1210 (Exploitation of Remote Services)
# ATT&CK: T1059.004 (Command and Scripting Interpreter: Unix Shell)

defaults:
  attack: "T1210"
  platforms: [all]

traits:
  # === Atomic: Redis RCE Commands ===

  - id: flushall
    desc: Redis FLUSHALL command
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "flushall"

  - id: config-set-dir
    desc: Redis CONFIG SET dir command
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: 'config\s+set\s+dir\s+"?/'

  - id: config-set-dbfilename
    desc: Redis CONFIG SET dbfilename command
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: 'config\s+set\s+dbfilename\s+'

  - id: redis-save-cmd
    desc: Redis SAVE command
    crit: notable
    conf: 0.6
    if:
      type: string
      # Match standalone "save" in Redis command context
      regex: '^\s*save\s*$'

  - id: redis-cron-path
    desc: Redis cron directory target
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: 'config\s+set\s+dir\s+"?/var/spool/cron|config\s+set\s+dir\s+"?/etc/cron\.d'

  - id: redis-crontab-path
    desc: Redis crontab target
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: 'config\s+set\s+dir\s+"?/etc/"?\s*.{0,50}config\s+set\s+dbfilename\s+"?crontab'

  - id: redis-backup-set
    desc: Redis SET backup payload
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: 'set\s+backup[0-9]+\s+"'

  - id: slaveof-cmd
    desc: Redis SLAVEOF replication command
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: 'slaveof\s+[0-9.]+\s+[0-9]+'

composite_rules:
  # Redis RCE via file write (cron injection)
  # Complexity: all(4) + any(1) = 5 -> hostile
  - id: redis-rce-cron
    desc: Redis RCE via cron injection
    crit: hostile
    conf: 0.98
    attack: "T1210"
    mbc: "B0030"
    all:
      - id: flushall
      - id: config-set-dir
      - id: config-set-dbfilename
      - id: redis-backup-set
    any:
      - id: redis-cron-path
      - id: redis-crontab-path

  # Redis exploitation (file write to arbitrary path)
  - id: redis-file-write
    desc: Redis exploitation via file write
    crit: suspicious
    conf: 0.95
    attack: "T1210"
    all:
      - id: config-set-dir
      - id: config-set-dbfilename

  # Redis backup payload injection
  - id: redis-payload-inject
    desc: Redis payload injection via SET
    crit: suspicious
    conf: 0.9
    attack: "T1210"
    all:
      - id: redis-backup-set
      - id: config-set-dir
