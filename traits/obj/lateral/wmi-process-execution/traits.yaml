# WMI-Based Process Execution (Fileless Malware)
# Detects Windows Management Instrumentation for process spawning
# Generic indicator for fileless malware, RATs, and advanced threats

traits:
  - id: wmi-connection
    desc: WMI connection via winmgmts
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "winmgmts:"
    notes: "Windows Management Instrumentation connection (fileless malware technique)"
    attack: "T1047"
    mbc: "E1043"

  - id: win32-process-query
    desc: Win32_Process WMI class
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "Win32_Process"
    notes: "WMI process management class (process execution)"
    attack: "T1047"
    mbc: "E1043"

  - id: process-startup-config
    desc: Win32_ProcessStartup config
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "Win32_ProcessStartup"
    notes: "WMI process startup configuration (process execution control)"
    attack: "T1047"
    mbc: "E1043"

  - id: wmi-get-object
    desc: GetObject WMI retrieval
    crit: inert
    conf: 0.6
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "GetObject("
    notes: "GetObject API for COM/WMI objects"
    attack: "T1047"

  - id: hidden-window-flag
    desc: Hidden window execution
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "ShowWindow = 0"
        - substr: "ShowWindow=0"
        - substr: "SW_HIDE"
        - regex: "ShowWindow\\s*=\\s*0"
    notes: "Process execution with hidden window (SW_HIDE flag)"
    attack: "T1027"
    mbc: "E1003"

  - id: process-create-call
    desc: Process creation via Create
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: ".Create("
    notes: "Direct process creation method call"
    attack: "T1047"
    mbc: "E1043"

composite_rules:
  - id: wmi-process-spawn
    desc: WMI process execution
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    attack: "T1047"
    mbc: "E1043"
    notes: |
      WMI-based process execution detected.

      WMI (Windows Management Instrumentation) provides
      fileless malware execution capability:

      - No child process parent relationship
      - Difficult to detect without behavioral monitoring
      - Used by advanced malware and APT groups
      - Typical in Emotet, Trickbot, Wizard Spider

      Execution via:
      - GetObject("winmgmts:...")
      - Win32_Process class
      - Win32_ProcessStartup configuration
      - .Create() method invocation

    count_min: 2
    any:
      - id: wmi-connection
      - id: win32-process-query
      - id: process-startup-config
      - id: process-create-call

  - id: wmi-fileless-malware
    desc: WMI fileless malware
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [javascript]
    attack: "T1047"
    mbc: "E1043"
    notes: |
      Complete WMI fileless malware pattern.
      Combines process execution with hidden execution.

      This indicates:
      - Sophisticated malware development
      - Intended evasion of traditional detection
      - Professional threat actor capabilities
      - Likely advanced malware or APT

    all:
      - id: wmi-process-spawn
      - id: hidden-window-flag

  - id: wmi-lateral-movement
    desc: WMI lateral movement
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [javascript]
    attack: "T1047"
    mbc: "E1080"
    notes: |
      WMI process execution with network capability.
      Indicates lateral movement or remote exploitation.

    all:
      - id: wmi-process-spawn
      - id: cap/comm

