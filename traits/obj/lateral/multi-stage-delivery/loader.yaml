# Multi-Stage Loader Architecture
# Detects loaders with encoded payload + dynamic loading + code injection
# Core pattern for 70% of advanced malware

traits:
  - id: dynamic-library-loading
    desc: Dynamic library loading capability
    crit: notable
    conf: 0.85
    platforms: [windows, linux, macos]
    for: [pe, elf, macho]
    if:
      type: import_combination
      required: ["LoadLibrary", "GetProcAddress"]
      min_suspicious: 2
    notes: "Enables flexible runtime module loading"
    attack: "T1129"
    mbc: "C0007"

  - id: remote-code-injection
    desc: Remote process code injection capability
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [pe]
    if:
      type: import_combination
      suspicious: ["CreateRemoteThread", "WriteProcessMemory", "VirtualAllocEx"]
      min_suspicious: 1
    notes: "Capability to inject code into other processes"
    attack: "T1055"
    mbc: "C0041"

composite_rules:
  - id: multi-stage-loader
    desc: Multi-stage malware loader with obfuscation and injection
    crit: hostile
    conf: 0.9
    attack: "T1545"
    mbc: "B0024"
    platforms: [windows]
    for: [pe]
    notes: |
      Complete multi-stage loader pattern:
      1. Embedded obfuscated payload (encoded blob)
      2. Dynamic module loading (flexible injection)
      3. Remote code injection (deploy into running process)

      Generic pattern seen in:
      - Emotet (multi-encoding + dynamic loading)
      - Trickbot (DLL loader + injection)
      - Ryuk (encoded payload + injection)
      - Maze, ZeuS, Dridex, IcedID

      This combination indicates Stage 1 malware designed to:
      - Avoid static analysis (encoding)
      - Adapt to environment (dynamic loading)
      - Execute in target process (injection)

    all:
      - id: cap/data/encode/payload/embedded-obfuscated-payload
      - id: dynamic-library-loading
      - id: remote-code-injection

  - id: flexible-execution-framework
    desc: Flexible malware execution with multiple deployment methods
    crit: suspicious
    conf: 0.85
    attack: "T1055"
    mbc: "B0024"
    platforms: [windows]
    for: [pe]
    notes: |
      Multiple code execution techniques available indicates:
      - Flexible deployment strategy
      - Expected defensive measures
      - Can adapt injection method by environment

    count_min: 3
    any:
      - id: obj/process/injection/remote-thread-pattern
      - id: obj/process/injection/process-hollowing
      - id: obj/process/injection/apc-injection
      - id: cap/process/inject/atom-bombing/atom-bombing-capable
