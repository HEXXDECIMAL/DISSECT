# macOS Security Framework Privilege Escalation
# Detects privilege escalation attempts using Apple's Security Framework APIs
# ATT&CK: T1548.004 (Abuse Elevation Control Mechanism)

defaults:
  for: [macho, dylib, c]
  platforms: [macos]
  attack: "T1548.004"

composite_rules:
  - id: auth-privesc-api-combo
    desc: "Authorization APIs for privilege escalation"
    crit: notable
    conf: 0.9
    for: [macho, dylib, c]
    platforms: [macos]
    any:
      - id: cap/process/identity

  # Stealthy privileged script executor
  # Mach-O app that hides from dock, escalates privileges, and executes processes
  # Common pattern in Platypus-wrapped malware droppers
  # Complexity: all(3) + for(1) = 4 (meets hostile threshold)
  - id: stealth-privesc-executor
    desc: "Stealthy privileged process executor"
    crit: hostile
    conf: 0.95
    attack: "T1548.004"
    mbc: "B0030"
    for: [macho]
    platforms: [macos]
    all:
      - id: obj/impact/ui/manipulation::dock-hide
      - id: auth-privesc-api-combo
      - id: obj/c2/network/beacon/periodic::nstask-launch
