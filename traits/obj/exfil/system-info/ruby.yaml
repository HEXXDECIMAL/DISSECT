---
# Ruby System Information Exfiltration
# Detects system fingerprinting and data exfiltration
# ATT&CK: T1082 (System Information Discovery), T1041 (Exfiltration Over C2 Channel)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === System Info Collection ===
  - id: system-info-collect
    desc: System information collection
    crit: notable
    conf: 0.80
    attack: "T1082"
    if:
      type: string
      regex: 'hostname.{0,50}os.{0,50}ip|platform.{0,50}username|info\[.{0,50}hostname|to_json'

  # === Hardcoded IP Exfiltration ===
  - id: hardcoded-ip-exfil
    desc: Hardcoded IP for data exfiltration
    crit: suspicious
    conf: 0.85
    attack: "T1041"
    if:
      type: string
      regex: 'https?://(?!(127\.0\.0\.1|localhost))[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+|https?://(?!(127\.0\.0\.1|localhost))[a-zA-Z0-9][-a-zA-Z0-9]*\.[a-zA-Z0-9][-a-zA-Z0-9]*'
    not:
      - "127.0.0.1"
      - "localhost"

  # === JSON Data Encoding ===
  - id: json-data-encode
    desc: JSON data encoding for exfiltration
    crit: notable
    conf: 0.70
    attack: "T1027"
    if:
      type: string
      regex: 'to_json|JSON\.generate|\.to_json'

  # === Base64 JSON Encoding ===
  - id: base64-json-encode
    desc: Base64 encoded JSON data
    crit: notable
    conf: 0.85
    attack: "T1027"
    if:
      type: string
      regex: 'Base64\.encode64.{0,50}to_json|encode64.{0,50}json|Base64\..{0,50}json'

  # === Rakefile Payload ===
  - id: rakefile-payload
    desc: Rakefile as payload delivery
    crit: notable
    conf: 0.70
    attack: "T1059"
    if:
      type: string
      regex: 'Rakefile|require.{0,50}rake'

composite_rules:
  # === System Info Exfiltration ===
  - id: system-info-exfiltration
    desc: System information exfiltration
    crit: suspicious
    conf: 0.92
    attack: "T1041"
    count_min: 4
    any:
      - id: cap/os/sysinfo/platform-fingerprint
      - id: cap/os/sysinfo/socket-hostname
      - id: cap/os/sysinfo/socket-ip-address
      - id: system-info-collect
      - id: hardcoded-ip-exfil
      - id: base64-json-encode
      - id: obj/discovery/user/username-env

  # === Platform-Specific Payload ===
  - id: platform-specific-payload
    desc: Platform-specific malicious payload
    crit: suspicious
    conf: 0.88
    attack: "T1059"
    count_min: 3
    any:
      - id: cap/os/sysinfo/platform-fingerprint
      - id: rakefile-payload
      - id: system-info-collect
      - id: cap/comm/http/request/ruby-http-get-response
