# File Exfiltration Pattern Detection (Stealer Combinations)
# Detects suspicious combinations indicating data exfiltration
# Based on real-world stealer malware patterns

composite_rules:
  # Combination 1: libcurl + file extensions = stealer
  - id: curl-with-file-targeting
    desc: "HTTP client with credential/wallet file"
    crit: hostile
    conf: 0.95
    attack: "T1041"
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: cap/comm/download/curl/libcurl-http
    count_min: 2
    any:
      - id: obj/collect/file-targeting/credential-files
      - id: obj/collect/file-targeting/wallet-files
      - id: obj/collect/file-targeting/stealer-extension-list
      - id: obj/creds/wallet/mnemonic/wallet-word

  # Combination 2: Binary file modes + network = exfiltration
  # NOTE: Excludes legitimate binaries that naturally combine file I/O with networking:
  # - Debuggers (gdb, lldb) - remote debugging
  # - X11 IPC libraries (libICE, libSM) - session management uses sockets + file auth
  # - Network libraries (libcurl, libssl) - inherently do both
  - id: binary-file-network-exfil
    desc: "Binary file operations with network"
    crit: suspicious
    conf: 0.9
    attack: "T1041"
    for: [elf, macho, pe]
    all:
      - id: cap/fs/file-ops/binary-file-ops
    count_min: 1
    any:
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create
    none:
      - id: cap/exec/load/debugger-tool-marker
      - id: cap/exec/load/x11-ipc-lib-marker
      - id: cap/exec/load/network-lib-marker
      - id: cap/exec/load/graphics-lib-marker

  # Combination 3: fcopyfile + network (macOS)
  - id: macos-file-copy-exfil
    desc: "macOS file copying with network"
    crit: suspicious
    conf: 0.9
    attack: "T1041"
    platforms: [macos]
    for: [macho]
    all:
      - id: cap/fs/file-ops/fcopyfile-macos
    count_min: 1
    any:
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create

  # Combination 4: Directory traversal + file extensions + network
  - id: recursive-file-theft
    desc: "Recursive directory scan with file"
    crit: hostile
    conf: 0.95
    attack: "T1005"
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: cap/fs/directory/traverse
    count_min: 2
    any:
      - id: obj/collect/file-targeting/stealer-extension-list
      - id: obj/collect/file-targeting/credential-files
      - id: obj/collect/file-targeting/wallet-files
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create

  # Combination 5: Hardware UUID + base64 = fingerprint encoding
  - id: encoded-hardware-fingerprint
    desc: "Hardware fingerprint with base64 encoding"
    crit: suspicious
    conf: 0.9
    attack: "T1082"
    for: [elf, macho, pe]
    all:
      - id: cap/data/encode/base64/custom-implementation
    count_min: 1
    any:
      - id: obj/discovery/fingerprint/hardware-uuid-macos
      - id: obj/discovery/fingerprint/machine-id
      - id: obj/discovery/fingerprint/hardware-uuid

  # Combination 6: Custom base64 + XOR + network = obfuscated exfil
  - id: obfuscated-exfiltration
    desc: "Multi-layer encoding with network (obfuscated"
    crit: hostile
    conf: 0.95
    attack: "T1027"
    mbc: "B0032"
    for: [elf, macho, pe]
    all:
      - id: cap/data/encode/base64/custom-implementation
      - id: obj/anti-static/obfuscation/string-decrypt
    count_min: 1
    any:
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create

  # Combination 7: libcurl + fingerprinting + obfuscation
  - id: stealer-trifecta
    desc: "Complete stealer pattern (network +"
    crit: hostile
    conf: 0.98
    attack: "T1041"
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: cap/comm/download/curl/libcurl-http
      - id: obj/anti-static/obfuscation/string-decrypt
    count_min: 1
    any:
      - id: obj/discovery/fingerprint/hardware-uuid-macos
      - id: obj/discovery/fingerprint/machine-id
      - id: obj/discovery/fingerprint/full-system
