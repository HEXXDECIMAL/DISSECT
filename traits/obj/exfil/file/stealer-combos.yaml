# File Exfiltration Pattern Detection (Stealer Combinations)
# Detects suspicious combinations indicating data exfiltration
# Based on real-world stealer malware patterns

composite_rules:
  # Combination 1: libcurl + file extensions = stealer
  - id: curl-with-file-targeting
    desc: "HTTP client with credential/wallet file"
    crit: hostile
    conf: 0.95
    attack: "T1041"
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: cap/comm/download/curl/libcurl-http
    needs: 2
    any:
      - id: obj/collect/file-targeting/credential-files
      - id: obj/collect/file-targeting/wallet-files
      - id: obj/collect/file-targeting/stealer-extension-list
      - id: obj/creds/wallet/mnemonic/wallet-word

  # Combination 2: fcopyfile + network (macOS)
  - id: macos-file-copy-exfil
    desc: "macOS file copying with network"
    crit: suspicious
    conf: 0.9
    attack: "T1041"
    platforms: [macos]
    for: [macho]
    all:
      - id: cap/fs/file-ops/fcopyfile-macos
    needs: 1
    any:
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create

  # Combination 3: Directory traversal + file extensions + network
  # NOTE: Excludes system libraries (libc) which provide these primitives
  - id: recursive-file-theft
    desc: "Recursive directory scan with file"
    crit: hostile
    conf: 0.95
    attack: "T1005"
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: cap/fs/directory/traverse
    needs: 2
    any:
      - id: obj/collect/file-targeting/stealer-extension-list
      - id: obj/collect/file-targeting/credential-files
      - id: obj/collect/file-targeting/wallet-files
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create
    none:
      - id: cap/exec/load/system-lib-marker
      - id: cap/exec/load/network-lib-marker
      - id: cap/exec/load/debugger-tool-marker

  # Combination 4: Hardware UUID + base64 = fingerprint encoding
  - id: encoded-hardware-fingerprint
    desc: "Hardware fingerprint with base64 encoding"
    crit: suspicious
    conf: 0.9
    attack: "T1082"
    for: [elf, macho, pe]
    all:
      - id: cap/data/encode/base64/custom-implementation
    needs: 1
    any:
      - id: obj/discovery/fingerprint/hardware-uuid-macos
      - id: obj/discovery/fingerprint/machine-id
      - id: obj/discovery/fingerprint/hardware-uuid

  # Combination 5: Custom base64 + XOR + network = obfuscated exfil
  - id: obfuscated-exfiltration
    desc: "Multi-layer encoding with network (obfuscated"
    crit: hostile
    conf: 0.95
    attack: "T1027"
    mbc: "B0032"
    for: [elf, macho, pe]
    all:
      - id: cap/data/encode/base64/custom-implementation
      - id: obj/anti-static/obfuscation/string-decrypt
    needs: 1
    any:
      - id: cap/comm/download/curl/libcurl-http
      - id: cap/comm/socket/create

  # Combination 6: libcurl + fingerprinting + obfuscation
  - id: stealer-trifecta
    desc: "Complete stealer pattern (network +"
    crit: hostile
    conf: 0.98
    attack: "T1041"
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: cap/comm/download/curl/libcurl-http
      - id: obj/anti-static/obfuscation/string-decrypt
    needs: 1
    any:
      - id: obj/discovery/fingerprint/hardware-uuid-macos
      - id: obj/discovery/fingerprint/machine-id
      - id: obj/discovery/fingerprint/full-system

  # Combination 7: Chrome cookie path + curl upload
  - id: chrome-cookie-upload
    desc: Chrome cookie theft and upload
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    all:
      - id: obj/creds/browser/chromium/cookies-path
      - id: cap/comm/http/upload/curl-upload-file

  # Combination 8: CookieMiner dropper script
  - id: cookieminer-dropper
    desc: CookieMiner dropper script
    crit: hostile
    conf: 1.0
    attack: "T1059.004"
    mbc: "B0024"
    for: [shell]
    all:
      - id: cap/exec/dropper/script/curl-download
      - id: obj/creds/browser/chromium/cookies-path
      - id: cap/os/admin/legitimate/cp-command
      - id: cap/comm/http/upload/curl-upload-file
