# Shell-based Network Exfiltration
# Behavioral composites that combine shell tools with exfiltration indicators
# ATT&CK: T1041 (Exfiltration Over C2 Channel)
#
# Note: Atomic curl/wget/nc traits moved to comm/http/client/shell.yaml
# This file contains only behavioral composites that indicate exfiltration

defaults:
  mbc: "E1041"
  attack: "T1041"
  for: ["*"]

composite_rules:
  - id: curl-post-data
    desc: Curl POST with data (potential
    crit: suspicious
    conf: 0.85
    all:
      - id: cap/comm/http/client::curl-post
    unless:
      - id: cap/os/admin/legitimate/http-tools/package-manager
      - id: cap/os/admin/legitimate/http-tools/ci-cd-pipeline
      - id: cap/os/admin/legitimate/http-tools/health-check
      - id: cap/os/admin/legitimate/http-tools/installer-script

  - id: curl-upload-file
    desc: Curl file upload
    crit: suspicious
    conf: 0.85
    all:
      - id: cap/comm/http/client::curl-upload
    unless:
      - id: cap/os/admin/legitimate/http-tools/package-manager
      - id: cap/os/admin/legitimate/http-tools/ci-cd-pipeline
      - id: cap/os/admin/legitimate/http-tools/backup-script
      - id: meta/signed/id::com.apple.curl
      - id: cap/comm/download/curl::curl-easy-init

  - id: shell-tool-exfil
    desc: Shell tool exfiltration
    crit: suspicious
    conf: 0.85
    attack: "T1048"
    all:
      - id: cap/comm/http/client::client
    unless:
      - id: cap/os/admin/legitimate::backup-script
      - id: cap/os/admin/legitimate::health-check
      - id: meta/format/json::valid
