# Webhook Exfiltration Detection
# Detects data exfiltration via webhooks (Slack, Discord, etc.)
# ATT&CK: T1041 (Exfiltration Over C2), T1567 (Exfiltration Over Web Service)
# MBC: B0030 (C2 Communication)

defaults:
  crit: suspicious
  attack: "T1041"
  mbc: "B0030"
  for: [python, shell, javascript]

traits:
  # === Slack Webhook ===
  - id: slack-webhook-url
    desc: Slack webhook URL
    crit: suspicious
    conf: 0.90
    if:
      type: string
      regex: "hooks\\.slack\\.com/services"

  - id: slack-incoming-webhook
    desc: Slack incoming webhook
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "slack\\.com.{0,50}webhook|webhook.{0,50}slack"

  # === Discord Webhook ===
  - id: discord-webhook-url
    desc: Discord webhook URL
    crit: suspicious
    conf: 0.90
    if:
      type: string
      regex: "discord(?:app)?\\.com/api/webhooks"

  - id: discord-webhook-pattern
    desc: Discord webhook pattern
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "discord.{0,50}webhook|webhook.{0,50}discord"

  # === Generic Webhook ===
  - id: generic-webhook-url
    desc: Generic webhook URL pattern
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "/webhook|webhook/|/hooks/"

  # === Webhook Data Patterns ===
  - id: webhook-with-system-data
    desc: Webhook with system data
    crit: suspicious
    conf: 0.95
    if:
      type: content
      regex: "webhook.{0,50}(hostname|whoami|ipconfig|ifconfig|systeminfo)|curl.{0,50}webhook.{0,50}json"

  - id: curl-post-webhook
    desc: curl POST to webhook
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "curl.{0,50}-X POST.{0,50}webhook|webhook.{0,50}curl.{0,50}POST"

composite_rules:
  # === Webhook Exfiltration ===
  - id: slack-exfiltration
    desc: Slack webhook exfiltration
    crit: suspicious
    conf: 0.95
    attack: "T1041"
    for: [python, shell]
    needs: 1
    any:
      - id: slack-webhook-url
      - id: slack-incoming-webhook

  - id: discord-exfiltration
    desc: Discord webhook exfiltration
    crit: suspicious
    conf: 0.95
    attack: "T1041"
    for: [python, shell, javascript]
    needs: 1
    any:
      - id: discord-webhook-url
      - id: discord-webhook-pattern

  - id: webhook-c2-channel
    desc: Webhook C2 exfiltration channel
    crit: suspicious
    conf: 0.98
    attack: "T1567"
    mbc: "B0030"
    platforms: [all]
    needs: 2
    any:
      - id: slack-exfiltration
      - id: discord-exfiltration
      - id: webhook-with-system-data
