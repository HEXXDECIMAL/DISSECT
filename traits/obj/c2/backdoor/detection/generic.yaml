# Impact - Remote Access / Reverse Shells
# ATT&CK: T1059 (Command and Scripting Interpreter)
# MBC: B0022 (Remote Access)
# NOTE: Shell path traits (bin-sh, bin-bash) are defined in exec/command/shell/generic.yaml

traits:
  # === Atomic: Reverse Shell Indicators ===

  - id: reverse-shell-ref
    desc: Reverse shell terminology reference
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    platforms: [all]
    if:
      type: string
      regex: "reverse[_\\s]?shell|revshell|r[e3]v[e3]rs[e3][_\\s]*sh[e3]ll"
      case_insensitive: true

  - id: webshell-ref
    desc: Web shell terminology reference
    crit: suspicious
    conf: 0.9
    attack: "T1505.003"
    platforms: [all]
    if:
      type: string
      regex: "w[3e]b[_\\s]*sh[e3]ll"
      case_insensitive: true

  - id: traits-backdoor-ref
    desc: Backdoor terminology reference
    crit: suspicious
    conf: 0.75
    attack: "T1059"
    platforms: [all]
    if:
      type: string
      regex: "\\b[Bb]ackdoor\\b"

  # === Atomic: Bash Reverse Shell ===

  - id: bash-dev-tcp
    desc: Bash /dev/tcp reverse shell
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "bash\\s+-i\\s+>&\\s*/dev/tcp/"

  - id: stdin-redirect
    desc: Stdin redirection (reverse shell indicator)
    crit: suspicious
    conf: 0.7
    attack: "T1059"
    platforms: [all]
    if:
      type: string
      exact: "0>&1"

  # === Atomic: Netcat ===

  - id: nc-pipe
    desc: Netcat with pipe
    crit: suspicious
    conf: 0.7
    attack: "T1059"
    platforms: [linux, macos, unix]
    if:
      type: string
      regex: "\\|\\s*nc\\s"

  # === Atomic: Socket + Shell (Generic) ===
  # Generic "socket" moved to data/text/generic.yaml

  - id: reverse-keyword
    desc: Reverse keyword reference
    crit: inert
    conf: 0.3
    platforms: [all]
    if:
      type: string
      # Require reverse connection/backdoor context, not generic "reverse" word
      regex: "(?i)reverse[_-]?(?:connect|conn|tcp|shell|backdoor|proxy|tunnel)"

  # === Atomic: Ruby Reverse Shell ===

  - id: ruby-tcpsocket-spawn
    desc: Ruby TCPSocket with spawn (reverse
    crit: suspicious
    conf: 0.9
    attack: "T1059.006"
    platforms: [all]
    for: [ruby]
    if:
      type: string
      regex: "spawn\\([\"']/bin/sh[\"'],.{0,64}TCPSocket"

  - id: ruby-tcpsocket-popen
    desc: Ruby TCPSocket with popen (reverse
    crit: suspicious
    conf: 0.9
    attack: "T1059.006"
    platforms: [all]
    for: [ruby]
    if:
      type: string
      regex: "TCPSocket.{0,64}\\.gets.{0,64}IO.popen"

  # === Atomic: Go Reverse Shell Functions ===

  - id: go-child-stdin
    desc: Go exec.Cmd.childStdin
    crit: suspicious
    conf: 0.7
    platforms: [all]
    for: [elf, macho]
    if:
      type: string
      substr: "os/exec.(*Cmd).childStdin"

composite_rules:
  # Perl socket-open reverse shell (migrated from YARA)
  - id: perl-socket-open
    desc: Perl socket with open (reverse
    crit: suspicious
    conf: 0.8
    attack: "T1059.006"
    mbc: "B0022"
    platforms: [all]
    for: [perl]
    all:
      - id: cap/comm/socket/create::socket-call
      - id: cap/comm/socket/create::open-call
      - id: cap/comm/socket/create::fd-redirect
      - id: cap/exec/command/shell::sh-interactive

  - id: mkfifo-netcat-shell
    desc: Reverse shell via mkfifo and
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    mbc: "B0022"
    platforms: [linux, macos, unix]
    all:
      - id: cap/fs/pipe/fifo::mkfifo-cmd
      - id: cap/exec/command/shell::sh-interactive
      - id: nc-pipe

  - id: go-reverse-shell
    desc: Go reverse shell pattern
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    mbc: "B0022"
    platforms: [all]
    for: [elf, macho]
    any:
      - id: cap/exec/command/shell::bin-bash
      - id: cap/exec/command/shell::bin-sh
    all:
      - id: obj/c2/reverse-shell/socket::exec-cmd-run
      - id: go-child-stdin
      - id: cap/comm/socket/connect::dial-tcp

  - id: generic-reverse-shell
    desc: Generic reverse shell pattern (socket
    crit: suspicious
    conf: 0.8
    attack: "T1059"
    platforms: [all]
    all:
      - id: reverse-keyword
      - id: cap/data/text/keywords::socket
    any:
      - id: cap/exec/command/shell::bin-bash
      - id: cap/exec/command/shell::bin-sh
