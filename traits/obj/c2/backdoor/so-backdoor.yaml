# Supply Chain Binary Backdoor - Shared Object (.so) Detection
# Detects malicious shared libraries with backdoor capabilities
# ATT&CK: T1195.002 (Supply Chain Compromise: Compromise Software Supply Chain)
# Examples: triton libtriton.so, various PyPI/npm supply chain attacks with native code

defaults:
  for: [elf]
  platforms: [linux]
  attack: "T1195.002"
  mbc: "B0025"

composite_rules:
  # Network backdoor in shared library
  # Shared libraries with socket server capabilities + shell execution
  # This is highly suspicious - legitimate .so files rarely do this
  - id: so-network-backdoor
    desc: Shared library with network backdoor
    crit: suspicious
    conf: 0.9
    all:
      # Must have socket connectivity
      - id: cap/comm/socket/connect/connect
    any:
      # Plus server capabilities or shell execution
      - id: cap/comm/socket/bind/bind
      - id: cap/comm/socket/listen/accept-sym
      - id: cap/exec/command/shell/c-popen
      - id: cap/exec/command/shell/c-system
      - id: cap/exec/command/popen-call
    # Exclude system network libraries
    none:
      - id: cap/exec/load/network-lib-marker
      - id: cap/exec/load/system-lib-marker

  # Shared library targeting credentials
  # .so with both SSH and shell config access is highly suspicious
  - id: so-credential-targeting
    desc: Shared library targeting user credentials
    crit: suspicious
    conf: 0.85
    attack: "T1552.004"
    count_min: 2
    any:
      - id: obj/creds/ssh/key/dot-ssh-path
      - id: obj/creds/ssh/key/dot-ssh-dir
      - id: obj/persist/shell/config/bash-files
      - id: obj/persist/shell/config/profile
    none:
      - id: cap/exec/load/shell-interpreter
      - id: cap/exec/load/system-lib-marker

  # Shared library with C2 infrastructure
  # .so with suspicious domain + network operations
  - id: so-c2-infrastructure
    desc: Shared library with C2 infrastructure
    crit: suspicious
    conf: 0.9
    all:
      - id: obj/c2/infrastructure/domain/c2-domain
    any:
      - id: cap/comm/socket/connect/connect
      - id: cap/comm/socket/bind/bind
    none:
      - id: cap/exec/load/network-lib-marker

  # Shared library with rootkit capabilities
  # LD_PRELOAD + shell execution in a library is highly suspicious
  - id: so-rootkit-behavior
    desc: Shared library with rootkit behavior
    crit: suspicious
    conf: 0.9
    attack: "T1574.006"
    all:
      - id: cap/os/linker/env/ld-preload
    any:
      - id: cap/exec/command/shell/c-popen
      - id: cap/exec/command/shell/c-system
      - id: cap/exec/command/shell/c-execve
      - id: cap/exec/command/popen-call
      - id: cap/exec/dylib/load/dlsym

  # Full supply chain backdoor pattern
  # Combines multiple suspicious behaviors into hostile indicator
  # Complexity: all(2) + any(4) = 3 base, need file_types for 4
  # Updated: for: adds +1, making complexity = 4
  - id: supply-chain-backdoor
    desc: Supply chain backdoor in shared library
    crit: hostile
    conf: 0.95
    for: [elf]
    all:
      # Must have network + shell execution
      - id: cap/comm/socket/connect/connect
      - id: cap/exec/command/shell/shell-execution
    any:
      # Plus credential targeting or C2 infrastructure
      - id: so-credential-targeting
      - id: so-c2-infrastructure
      - id: obj/c2/infrastructure/domain/c2-domain
      - id: obj/creds/ssh/key/dot-ssh-path
    none:
      - id: cap/exec/load/system-lib-marker
      - id: cap/exec/load/network-lib-marker
      - id: cap/exec/load/shell-interpreter

  # Alternative: Network + credential + rootkit pattern
  # Complexity: all(3) + for: = 4
  - id: library-backdoor-rootkit
    desc: Library backdoor with rootkit and credential theft
    crit: hostile
    conf: 0.95
    for: [elf]
    all:
      - id: cap/comm/socket/connect/connect
      - id: cap/exec/command/shell/shell-execution
      - id: cap/os/linker/env/ld-preload
    any:
      - id: obj/creds/ssh/key/dot-ssh-path
      - id: obj/persist/shell/config/bash-files
    none:
      - id: cap/exec/load/system-lib-marker

  # Simpler pattern: socket + shell + credential paths
  # Complexity: all(3) + any(1 via count_min) = still need more
  # Using file_types: +1 = 4
  - id: network-shell-credential-so
    desc: Library with network, shell, and credential access
    crit: suspicious
    conf: 0.9
    for: [elf]
    all:
      - id: cap/comm/socket/connect/connect
      - id: cap/exec/command/shell/shell-execution
    any:
      - id: obj/creds/ssh/key/dot-ssh-path
      - id: obj/persist/shell/config/bash-files
      - id: obj/c2/infrastructure/domain/c2-domain
    none:
      - id: cap/exec/load/system-lib-marker
      - id: cap/exec/load/shell-interpreter
