# Java C2/RAT Agent Detection
# Detects RAT command and control patterns in Java bytecode
# MBC: Command and Control
# ATT&CK: T1071 (Application Layer Protocol)

defaults:
  for: [java, class]

traits:
  # === Remote execution commands ===
  - id: remote-cmd-string
    desc: Remote command execution indicator
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059"
    if:
      type: string
      substr: "remote-cmd"

  - id: power-shell-string
    desc: PowerShell execution command
    crit: suspicious
    conf: 0.95
    mbc: "B0024"
    attack: "T1059.001"
    if:
      type: string
      substr: "power-shell"

  # === Download and execute ===
  - id: down-n-exec-string
    desc: Download and execute command
    crit: suspicious
    conf: 0.98
    mbc: "B0025"
    attack: "T1105"
    if:
      type: string
      substr: "down-n-exec"

  - id: up-n-exec-string
    desc: Upload and execute command
    crit: suspicious
    conf: 0.98
    mbc: "B0025"
    attack: "T1105"
    if:
      type: string
      substr: "up-n-exec"

  # === Remote desktop/screen ===
  - id: remote-screen-string
    desc: Remote screen access command
    crit: suspicious
    conf: 0.95
    mbc: "B0022"
    attack: "T1113"
    if:
      type: string
      substr: "remote-screen"

  - id: hrdp-new-string
    desc: Hidden RDP session command
    crit: suspicious
    conf: 0.95
    mbc: "B0022"
    attack: "T1021.001"
    if:
      type: string
      substr: "hrdp-new"

  - id: hrdp-res-string
    desc: Hidden RDP resume command
    crit: suspicious
    conf: 0.95
    mbc: "B0022"
    attack: "T1021.001"
    if:
      type: string
      substr: "hrdp-res"

  # === File management ===
  - id: file-manager-string
    desc: File manager command
    crit: suspicious
    conf: 0.9
    mbc: "E1083"
    attack: "T1083"
    if:
      type: string
      substr: "file-manager"

  # === Proxy/tunneling ===
  - id: rev-proxy-string
    desc: Reverse proxy command
    crit: suspicious
    conf: 0.95
    mbc: "B0026"
    attack: "T1090"
    if:
      type: string
      substr: "rev-proxy"

  # === Encryption commands (ransomware indicator) ===
  - id: rw-encrypt-string
    desc: Ransomware encrypt command
    crit: suspicious
    conf: 0.95
    mbc: "B0031"
    attack: "T1486"
    if:
      type: string
      substr: "rw-encrypt"

  - id: rw-decrypt-string
    desc: Ransomware decrypt command
    crit: suspicious
    conf: 0.95
    mbc: "B0031"
    attack: "T1486"
    if:
      type: string
      substr: "rw-decrypt"

  # === Obfuscation markers ===
  - id: allatori-demo
    desc: Allatori obfuscator demo marker
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "ALLATORIxDEMO"

  # === C2 Infrastructure ===
  - id: c2-nonstandard-ports
    desc: Java hardcoded C2 endpoints with non-standard ports
    crit: suspicious
    conf: 0.85
    mbc: "C0002"
    attack: "T1071.001"
    if:
      type: string
      regex: "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}:[0-9]{4,5}"
      count_min: 2

  - id: base64-network-endpoints
    desc: Base64-encoded network endpoints in Java bytecode
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1140"
    if:
      type: base64
      regex: "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}:[0-9]{4,5}"
      count_min: 1

  - id: multiple-c2-endpoints
    desc: Java application with multiple hardcoded C2 endpoints
    crit: suspicious
    conf: 0.8
    mbc: "C0002"
    attack: "T1071.001"
    if:
      type: string
      regex: "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}:[0-9]+"
      count_min: 3

composite_rules:
  # Full-featured Java RAT (STRRat-style)
  - id: rat-comprehensive
    desc: Comprehensive Java RAT with multiple capabilities
    crit: suspicious
    mbc: "B0022"
    attack: "T1219"
    conf: 0.98
    needs: 4
    any:
      # Credential access
      - id: obj/creds/extract/method
      # C2 commands
      - id: remote-cmd-string
      - id: power-shell-string
      - id: down-n-exec-string
      - id: up-n-exec-string
      - id: remote-screen-string
      # Impact
      - id: obj/impact/system-control/rce::reboot-string
      - id: obj/impact/system-control/rce::uninstall-string

  # Java credential stealer
  - id: credential-stealer
    desc: Java-based credential stealing capability
    crit: suspicious
    mbc: "T1555"
    attack: "T1555"
    conf: 0.95
    needs: 2
    any:
      - id: obj/creds/extract/method

  # Java keylogger
  - id: keylogger
    desc: Java keylogging capability
    crit: notable
    mbc: "T1056.001"
    attack: "T1056.001"
    conf: 0.95
    needs: 1
    any:
      - id: obj/creds/extract/method::keylogger-string
      - id: obj/creds/extract/method::o-keylogger-string

  # Java remote access
  - id: remote-access
    desc: Java remote access capability
    crit: suspicious
    mbc: "B0022"
    attack: "T1021"
    conf: 0.95
    needs: 2
    any:
      - id: remote-screen-string
      - id: hrdp-new-string
      - id: hrdp-res-string
      - id: remote-cmd-string
      - id: power-shell-string

  # Java dropper/downloader
  - id: dropper
    desc: Java download and execute capability
    crit: suspicious
    mbc: "B0025"
    attack: "T1105"
    conf: 0.95
    needs: 1
    any:
      - id: down-n-exec-string
      - id: up-n-exec-string

  # Java ransomware indicators
  - id: ransomware
    desc: Java ransomware capability
    crit: suspicious
    mbc: "B0031"
    attack: "T1486"
    conf: 0.95
    all:
      - id: rw-encrypt-string
      - id: rw-decrypt-string

  # Java obfuscated class loader dropper
  - id: classloader-dropper
    desc: Obfuscated Java class loader dropper
    crit: hostile
    mbc: "B0032"
    attack: "T1140"
    conf: 0.92
    all:
      - id: cap/exec/dynamic-load/class::java-defineclass
      - id: cap/exec/dynamic-load/class::java-reflective-invoke
      - id: cap/exec/dynamic-load/class::java-string-reversal
    any:
      - id: cap/exec/dynamic-load/class::java-reflection
      - id: cap/exec/dynamic-load/class::java-defineclass

  # Java Adwind RAT C2 infrastructure pattern
  - id: adwind-c2-infrastructure
    desc: Java Adwind RAT C2 infrastructure pattern
    crit: hostile
    conf: 0.92
    mbc: "C0002"
    attack: "T1071.001"
    any:
      - id: base64-network-endpoints
    all:
      - id: multiple-c2-endpoints
