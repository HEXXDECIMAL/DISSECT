# XDP ICMP Covert Channel Detection
# Detects XDP programs used for ICMP-based covert channels
# ATT&CK: T1095 (Non-Application Layer Protocol)

composite_rules:
  # XDP program + ICMP manipulation + packet reflection = ICMP covert channel
  - id: xdp-icmp-covert
    desc: XDP ICMP covert channel
    crit: suspicious
    conf: 0.95
    attack: "T1095"
    for: [c, elf]
    all:
      - id: cap/os/bpf/program::sec-xdp
      - id: cap/os/bpf/program::icmp-parsing
      - id: cap/os/bpf/program::xdp-tx

  # XDP loader with ICMP covert channel markers
  # Userspace loader that attaches XDP program for ICMP manipulation
  - id: xdp-icmp-loader
    desc: XDP ICMP covert channel loader
    crit: suspicious
    conf: 0.9
    attack: "T1095"
    for: [c, elf]
    all:
      - id: cap/os/bpf/program::xdp-attach
      - id: cap/os/bpf/program::icmp-indicators
    needs: 1
    any:
      - id: cap/os/bpf/program::bpf-skeleton-include
      - id: cap/comm/ip/services::services-icmp
