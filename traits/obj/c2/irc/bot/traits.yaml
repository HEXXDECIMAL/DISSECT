# IRC Bot/C2 Detection Patterns
# ATT&CK: T1071.001 (Application Layer Protocol: Web Protocols)

defaults:
  attack: "T1071.001"

traits:
  # === IRC protocol indicators ===
  - id: irc-privmsg
    desc: IRC PRIVMSG command
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "PRIVMSG "
    unless:
      - type: content
        regex: "ftplib|urllib"

  - id: irc-nick
    desc: IRC NICK command
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "NICK "
    unless:
      - type: content
        regex: "ftplib|urllib"

  - id: irc-user
    desc: IRC USER command
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "USER "
    unless:
      - type: content
        regex: "ftplib|urllib"

  # === Bot command indicators ===
  - id: cmd-login
    desc: Bot login command
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "\\.login\\b"
    unless:
      - type: content
        regex: "ftplib|urllib"

  - id: cmd-udp
    desc: Bot UDP attack command
    crit: inert
    conf: 0.8
    if:
      type: string
      exact: ".udp"

  - id: cmd-tcp
    desc: Bot TCP attack command
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "\\.tcp\\b"

  - id: cmd-shell
    desc: Bot shell command
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "\\.shell\\b"

  # === Tsunami/Kaiten identifiers ===
  - id: tsunami-name
    desc: Tsunami bot name
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "tsunami"
      case_insensitive: true

  - id: kaiten-name
    desc: Kaiten bot name
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "kaiten"
      case_insensitive: true

  # === DDoS indicators ===
  - id: attack-pan
    desc: PAN attack type indicator
    crit: notable
    conf: 0.5
    if:
      type: string
      # PAN attack is specific IRC bot command - require command context
      regex: "(?i)(?:\\.pan\\b|pan[_-]?(?:attack|flood)|\\bpan[_-]?ddos)"

  - id: attack-udp
    desc: UDP attack type indicator
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "\\bUDP[_-]?ATTACK\\b|\\bUDP[_-]?FLOOD\\b"
      case_insensitive: true

  - id: ddos-flood
    desc: Flood attack terminology
    crit: notable
    conf: 0.5
    if:
      type: string
      # Match DDoS flood context, not generic "flood" word
      regex: "(?i)(?:(?:syn|udp|http|icmp|tcp|dns|ack)[_-]?flood|flood[_-]?(?:attack|target|packets?|mode))"

  - id: ddos-attack
    desc: Attack terminology
    crit: notable
    conf: 0.4
    if:
      type: string
      # Match DDoS attack context, not generic "attack" word
      regex: "(?i)(?:ddos[_-]?attack|attack[_-]?(?:target|mode|type|vector|method)|(?:syn|udp|http|icmp)[_-]?attack)"

composite_rules:
  # Helper: IRC protocol
  - id: irc-protocol
    desc: IRC protocol commands
    any:
      - id: irc-privmsg
      - id: irc-nick
      - id: irc-user

  # Helper: DDoS terms
  - id: ddos-attack-terms
    desc: DDoS attack terminology
    any:
      - id: attack-pan
      - id: attack-udp
      - id: ddos-flood
      - id: ddos-attack

  # Tsunami/Kaiten identifier
  - id: tsunami-artifact
    desc: Tsunami/Kaiten IRC bot identifier
    crit: notable
    conf: 0.7
    any:
      - id: tsunami-name
      - id: kaiten-name

  # IRC bot C2 (IRC protocol + any command)
  - id: bot-logic
    desc: IRC-based command and control logic
    crit: suspicious
    conf: 0.8
    all:
      - id: irc-protocol
    any:
      - id: cmd-login
      - id: cmd-udp
      - id: cmd-tcp
      - id: cmd-shell

  # IRC DDoS (IRC protocol + DDoS attack terminology)
  - id: irc-ddos
    desc: IRC-controlled DDoS attack logic
    crit: suspicious
    conf: 0.9
    all:
      - id: irc-protocol
      - id: ddos-attack-terms

  # Tsunami IRC bot with C2 logic
  - id: tsunami-irc-bot
    desc: Tsunami/Kaiten IRC bot with C2
    crit: suspicious
    conf: 0.85
    all:
      - id: obj/c2/irc/bot::tsunami-artifact
      - id: bot-logic

  # Tsunami DDoS bot
  - id: tsunami-ddos-bot
    desc: Tsunami/Kaiten IRC bot with DDoS
    crit: suspicious
    conf: 0.9
    all:
      - id: obj/c2/irc/bot::tsunami-artifact
      - id: obj/c2/irc/bot::irc-ddos

  # IRC bot with DDoS
  - id: irc-bot-ddos
    desc: IRC bot with DDoS attack
    crit: suspicious
    conf: 0.85
    all:
      - id: bot-logic
      - id: obj/c2/irc/bot::irc-ddos
