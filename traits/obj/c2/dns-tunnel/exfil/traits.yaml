# DNS Tunneling Detection
# MBC: C0001 (Command and Control)
# ATT&CK: T1071.004 (Application Layer Protocol: DNS)

defaults:
  mbc: "C0001"
  attack: "T1071.004"

traits:
  # === dnscat2 atomic indicators ===
  - id: dnscat-secret
    desc: dnscat2 secret environment variable
    crit: inert
    conf: 0.9
    if:
      type: string
      substr: DNSCAT_SECRET

  - id: dnscat-name
    desc: dnscat2 tool name reference
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: dnscat
      case_insensitive: true

  - id: dnscat-session
    desc: dnscat2 session state constant
    crit: inert
    conf: 0.9
    if:
      type: string
      substr: SESSION_STATE_ESTABLISHED

  - id: dnscat-packet
    desc: dnscat2 packet debug message
    crit: inert
    conf: 0.8
    if:
      type: string
      substr: "MSG packet"

  # === iodine atomic indicators ===
  - id: iodine-name
    desc: iodine tool name reference
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: iodine

  - id: tun-device
    desc: TUN device access for tunneling
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: /dev/net/tun

  - id: dns-tunnel-phrase
    desc: DNS tunnel terminology
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "dns tunnel"
      case_insensitive: true

  # === Generic DNS tunnel indicators ===
  - id: dns-exfil
    desc: DNS exfiltration terminology
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "dns exfil"
      case_insensitive: true

  - id: dns-c2
    desc: DNS C2 terminology
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "dns c2"
      case_insensitive: true

  - id: subdomain-encode
    desc: Long subdomain encoding pattern
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: '[a-z0-9]{30,}\.[a-z]+\.(com|net|org|io)'

  - id: txt-record
    desc: TXT record reference (DNS exfil)
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "TXT record"

  - id: dns-beacon
    desc: DNS beacon terminology
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "dns beacon"
      case_insensitive: true

  # === DoH C2 indicators ===
  - id: doh-cloudflare
    desc: Cloudflare DoH endpoint
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: cloudflare-dns.com/dns-query

  - id: doh-google
    desc: Google DoH endpoint
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: dns.google/dns-query

  - id: doh-quad9
    desc: Quad9 DoH endpoint
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: dns.quad9.net/dns-query

  - id: doh-json-content
    desc: DoH JSON content type
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: application/dns-json

composite_rules:
  - id: doh-endpoint
    desc: Known DoH endpoint reference
    crit: inert
    conf: 0.7
    needs: 1
    any:
      - id: doh-cloudflare
      - id: doh-google
      - id: doh-quad9

  - id: doh-content
    desc: DoH content-type indicator
    crit: inert
    conf: 0.6
    needs: 1
    any:
      - id: cap/comm/dns/doh::doh-content-type
      - id: doh-json-content

  # dnscat2 protocol
  - id: dnscat
    desc: dnscat2 DNS tunneling tool
    crit: notable
    conf: 0.95
    needs: 1
    any:
      - id: dnscat-secret
      - id: dnscat-name
      - id: dnscat-session
      - id: dnscat-packet

  # iodine DNS tunnel
  - id: iodine
    desc: iodine DNS tunneling tool
    crit: suspicious
    conf: 0.95
    any:
      - id: dns-tunnel-phrase
    all:
      - id: iodine-name
      - id: tun-device

  # Generic DNS tunnel patterns
  - id: generic
    desc: Generic DNS tunneling patterns
    crit: notable
    conf: 0.8
    needs: 1
    any:
      - id: dns-exfil
      - id: dns-c2
      - id: subdomain-encode
      - id: txt-record
      - id: dns-beacon

  # DNS over HTTPS for C2
  - id: doh-c2
    desc: DNS over HTTPS potential C2
    crit: notable
    conf: 0.75
    all:
      - id: doh-endpoint
      - id: doh-content
