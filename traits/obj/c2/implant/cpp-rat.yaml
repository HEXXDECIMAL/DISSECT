# C++ RAT Implant Detection
# Detects native C++ binaries with RAT (Remote Access Trojan) characteristics:
# - Remote shell capabilities (RShell)
# - Heartbeat/beacon functionality
# - C2 server registration
# - System info gathering for victim profiling
# - File operations for remote management
# MBC: B0030 (C2 Communication), B0024 (Remote Access)
# ATT&CK: T1059 (Command Execution), T1071 (Application Layer Protocol)

defaults:
  for: [elf, macho, pe]
  mbc: "B0030"

traits:
  # === Remote Shell Indicators ===
  # RShell (Remote Shell) functions - common in C++ RATs
  - id: rshell-function
    desc: Remote shell function pattern
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    if:
      type: string
      regex: '(RShell(Run|Init|CleanUp)|InitRShellFDS|OnReceivedPacket.{0,30}RShell)'

  # Generic remote command execution patterns
  - id: remote-cmd-exec
    desc: Remote command execution pattern
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    if:
      type: string
      regex: '(ExecShellCmd|RunShellCmd|RemoteExec|ExecCommand|CmdExec)\b'

  # === Heartbeat/Beacon Indicators ===
  # Generic heartbeat patterns (works for C++, Go, etc.)
  - id: heartbeat-function
    desc: C2 heartbeat function
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '(HeartBeat|Heartbeat|SendHeart|setHeart|g_threadHeartBeat)\b'

  # Thread procedure naming (common in C++ RATs)
  - id: heartbeat-thread
    desc: Heartbeat thread procedure
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: 'ThreadProc.{0,20}HeartBeat|HeartBeatThread'

  # === C2 Registration/Session Indicators ===
  # Server registration patterns
  - id: register-to-server
    desc: C2 registration function
    crit: suspicious
    conf: 0.9
    attack: "T1071.001"
    if:
      type: string
      regex: '(RegisterSelfToServer|RegisterToServer|RegisterClient|SelfRegister)\b'

  # Session ID management (C2 victim tracking)
  - id: session-id-mgmt
    desc: C2 session management
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: '(g_szSessionID|GetSessionID|SessionUDFromServer|m_SessionID)\b'

  # Server configuration variables
  - id: server-config-vars
    desc: C2 server config variables
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: '(g_tagSockAddrInServer|g_lpLinuxClientHostCfg|g_lpLinuxClientDefaultCfg)\b'

  # === Victim Profiling/Info Gathering ===
  # BasicInfoGather class (common in C++ RATs for system profiling)
  - id: basic-info-gather-class
    desc: Victim info gathering class
    crit: suspicious
    conf: 0.95
    attack: "T1082"
    if:
      type: string
      regex: '(CBasicInfoGather|BasicInfoGather|SystemInfoGather)'

  # System info format strings (victim profiling output)
  - id: victim-profile-format
    desc: Victim profile format strings
    crit: suspicious
    conf: 0.9
    attack: "T1082"
    if:
      type: string
      regex: '(OSInfo:%s|MachineName:%s|LanIP:%s|Userame:%s|OSBits:%s|GateWay:%s)'

  # === File Operation Indicators ===
  # FileOP (File Operations) patterns for remote file management
  - id: file-op-functions
    desc: Remote file operation functions
    crit: notable
    conf: 0.85
    attack: "T1105"
    if:
      type: string
      regex: '(FileOP(DeleteFile|CreateNewFile|SendDirData|Rename|GetFileSize|ModFileTime|WriteNewFileData)|OnReceive.{0,30}FileOP)'

  # Directory operations for remote enumeration
  - id: dir-op-functions
    desc: Remote directory operations
    crit: notable
    conf: 0.85
    attack: "T1083"
    if:
      type: string
      regex: '(DirOp(Directory|GetDirectoryData|DirectoryDelete)|OnReceiveDirOPTypeCmd)'

  # === Task/Command Dispatch ===
  # Task handling patterns (C2 command dispatch)
  - id: task-dispatch
    desc: C2 task dispatch functions
    crit: notable
    conf: 0.85
    if:
      type: string
      regex: '(OnReceivedPacket.{0,20}Task|RunChildTask|OnReceive.{0,20}NewTask)'

  # Packet data structures (C2 protocol)
  - id: packet-data-struct
    desc: C2 packet structures
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: '(TAG_PACKET_TO_SEND|ListPacketToSend|DataReceiver|DataSender)'

composite_rules:
  # C++ RAT with remote shell and heartbeat
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE
  - id: cpp-rat-rshell-beacon
    desc: C++ RAT with remote shell
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1059.004"
    for: [elf, macho, pe]
    all:
      - id: rshell-function
      - id: heartbeat-function
      - id: cap/exec/command/shell/shell-symbols

  # C++ RAT with registration and victim profiling
  # Complexity: all(4) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: cpp-rat-full-implant
    desc: Full C++ RAT implant
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    for: [elf, macho, pe]
    all:
      - id: heartbeat-function
      - id: register-to-server
      - id: basic-info-gather-class
      - id: cap/exec/command/shell/shell-symbols

  # C++ RAT with heartbeat and C2 registration
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE
  - id: cpp-rat-c2-registration
    desc: C++ RAT with C2 registration
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    for: [elf, macho, pe]
    all:
      - id: heartbeat-function
      - id: register-to-server
      - id: obj/c2/backdoor/socket-symbols

  # C++ RAT with file operations
  # Complexity: all(4) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: cpp-rat-file-mgmt
    desc: C++ RAT with file management
    crit: hostile
    conf: 0.93
    mbc: "B0030"
    attack: "T1105"
    for: [elf, macho, pe]
    all:
      - id: heartbeat-function
      - id: file-op-functions
      - id: dir-op-functions
      - id: obj/c2/backdoor/socket-symbols

  # C++ RAT with victim profiling and persistence indicators
  # Complexity: all(3) + any(1) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: cpp-rat-with-profiling
    desc: C++ RAT with victim profiling
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1082"
    for: [elf, macho, pe]
    all:
      - id: heartbeat-function
      - id: basic-info-gather-class
      - id: victim-profile-format
    any:
      - id: register-to-server
      - id: rshell-function
      - id: obj/persist/cron/elf/crontab-string

  # Generic RAT with heartbeat, session, and task dispatch
  # Complexity: all(4) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: cpp-rat-command-control
    desc: C++ RAT command and control
    crit: hostile
    conf: 0.92
    mbc: "B0030"
    for: [elf, macho, pe]
    all:
      - id: heartbeat-function
      - id: session-id-mgmt
      - id: task-dispatch
      - id: obj/c2/backdoor/socket-symbols
