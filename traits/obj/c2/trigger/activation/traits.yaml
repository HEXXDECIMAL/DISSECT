# C2 Trigger Mechanisms
# Detects out-of-band triggers for malicious activity

traits:
  # ICMP structure references
  - id: icmp-hdr-struct
    desc: ICMP header structure (C)
    crit: inert
    conf: 0.6
    for: [c]
    if:
      type: string
      substr: "struct icmphdr"

  - id: icmp-rcv
    desc: ICMP receive handler
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "icmp_rcv"

  # Magic trigger values
  # NOTE: The standalone value "1337" is far too common in legitimate software
  # (version numbers, protocol constants, X11 IDs, etc.). Only match when in
  # a more specific context suggesting a magic value check.
  - id: magic-1337
    desc: Magic value 1337 (common trigger)
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match 1337 in contexts suggesting a magic value check (port, password, key, etc.)
      regex: "(?:port|pass|key|magic|secret|trigger|backdoor|c2)[=:_\\-\\s]*1337|1337[=:_\\-\\s]*(?:port|pass|key|magic|secret|trigger|backdoor|c2)"

  - id: magic-0x539
    desc: Magic value 0x539 (1337)
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "0x539"

  # NOTE: Removed magic-keyword-lower, magic-keyword-upper, magic-keyword-title
  # The word "magic" is extremely common in legitimate software (file magic,
  # magic numbers, games, etc.). These patterns create false positives.
  # The magic-values composite now only uses numeric magic values (1337, 0x539)
  # which are more specific indicators of C2 triggers.


  # Trigger keywords
  # NOTE: "trigger" and "activate" are extremely common in GUI libraries,
  # databases (SQL triggers), and general programming. Only flag these
  # in specific malware-related contexts (e.g., combined with ICMP, magic values).
  # These atomic traits are disabled by setting very specific patterns;
  # only the composite rules should use them in combination with other signals.
  - id: trigger-keyword-lower
    desc: trigger keyword (lowercase)
    crit: inert
    conf: 0.3
    if:
      type: string
      # Require malware-specific context: trigger combined with backdoor/c2 terms
      regex: "(?:backdoor|c2|implant|beacon|payload|shell|revshell)[_\\-\\s]*trigger|trigger[_\\-\\s]*(?:backdoor|c2|implant|beacon|payload|shell|revshell)"

  - id: trigger-keyword-upper
    desc: TRIGGER keyword (uppercase)
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?:BACKDOOR|C2|IMPLANT|BEACON|PAYLOAD|SHELL|REVSHELL)[_\\-\\s]*TRIGGER|TRIGGER[_\\-\\s]*(?:BACKDOOR|C2|IMPLANT|BEACON|PAYLOAD|SHELL|REVSHELL)"

  - id: trigger-keyword-title
    desc: Trigger keyword (titlecase)
    crit: inert
    conf: 0.3
    if:
      type: string
      # Only match "Trigger" in malware-specific contexts
      regex: "(?:Backdoor|C2|Implant|Beacon|Payload|Shell|Revshell)[_\\-\\s]*Trigger|Trigger[_\\-\\s]*(?:Backdoor|C2|Implant|Beacon|Payload|Shell|Revshell)"

  - id: activate-keyword-lower
    desc: activate keyword (lowercase)
    crit: inert
    conf: 0.3
    if:
      type: string
      # Require malware-specific context
      regex: "(?:backdoor|c2|implant|beacon|payload|shell|revshell)[_\\-\\s]*activate|activate[_\\-\\s]*(?:backdoor|c2|implant|beacon|payload|shell|revshell)"

  - id: activate-keyword-upper
    desc: ACTIVATE keyword (uppercase)
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?:BACKDOOR|C2|IMPLANT|BEACON|PAYLOAD|SHELL|REVSHELL)[_\\-\\s]*ACTIVATE|ACTIVATE[_\\-\\s]*(?:BACKDOOR|C2|IMPLANT|BEACON|PAYLOAD|SHELL|REVSHELL)"

  - id: activate-keyword-title
    desc: Activate keyword (titlecase)
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?:Backdoor|C2|Implant|Beacon|Payload|Shell|Revshell)[_\\-\\s]*Activate|Activate[_\\-\\s]*(?:Backdoor|C2|Implant|Beacon|Payload|Shell|Revshell)"

  - id: revshell-keyword-lower
    desc: revshell keyword (lowercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?:trigger|activate|backdoor|payload)[_\\-\\s]*revshell|revshell[_\\-\\s]*(?:trigger|activate)"

  - id: revshell-keyword-upper
    desc: REVSHELL keyword (uppercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "REVSHELL"

  - id: revshell-keyword-title
    desc: Revshell keyword (titlecase)
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Revshell"

  # ICMP protocol constant
  - id: icmp-echo-const
    desc: ICMP_ECHO constant
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "ICMP_ECHO"

composite_rules:
  # Helper: ICMP handling context
  - id: icmp-context
    desc: ICMP packet handling context
    any:
      - id: icmp-hdr-struct
      - id: icmp-rcv

  # Helper: Magic value patterns (numeric only - word "magic" removed due to false positives)
  - id: magic-values
    desc: Magic trigger values
    any:
      - id: magic-1337
      - id: magic-0x539

  # Helper: Trigger keywords
  - id: trigger-keywords
    desc: C2 trigger activation keywords
    any:
      - id: trigger-keyword-lower
      - id: trigger-keyword-upper
      - id: trigger-keyword-title
      - id: activate-keyword-lower
      - id: activate-keyword-upper
      - id: activate-keyword-title
      - id: revshell-keyword-lower
      - id: revshell-keyword-upper
      - id: revshell-keyword-title
      - id: icmp-echo-const

  # ICMP Magic Packet Trigger
  - id: icmp-magic-packet
    desc: ICMP packet inspection for magic
    crit: suspicious
    conf: 0.95
    attack: "T1205.001"
    for: [c, go, python]
    all:
      - id: icmp-context
      - id: magic-values
      - id: trigger-keywords
