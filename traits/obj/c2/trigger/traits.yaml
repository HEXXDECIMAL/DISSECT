# C2 Trigger Mechanisms
# Detects out-of-band triggers for malicious activity

traits:
  # ICMP structure references
  - id: icmp-hdr-struct
    desc: ICMP header structure (C)
    crit: inert
    conf: 0.6
    for: [c]
    if:
      type: string
      exact: "struct icmphdr"

  - id: icmp-rcv
    desc: ICMP receive handler
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "icmp_rcv"

  # Magic trigger values
  - id: magic-1337
    desc: Magic value 1337 (common trigger)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "1337"

  - id: magic-0x539
    desc: Magic value 0x539 (hex for
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "0x539"

  # NOTE: Removed magic-keyword-lower, magic-keyword-upper, magic-keyword-title
  # The word "magic" is extremely common in legitimate software (file magic,
  # magic numbers, games, etc.). These patterns create false positives.
  # The magic-values composite now only uses numeric magic values (1337, 0x539)
  # which are more specific indicators of C2 triggers.


  # Trigger keywords
  - id: trigger-keyword-lower
    desc: trigger keyword (lowercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "trigger"

  - id: trigger-keyword-upper
    desc: TRIGGER keyword (uppercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "TRIGGER"

  - id: trigger-keyword-title
    desc: Trigger keyword (titlecase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "Trigger"

  - id: activate-keyword-lower
    desc: activate keyword (lowercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "activate"

  - id: activate-keyword-upper
    desc: ACTIVATE keyword (uppercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "ACTIVATE"

  - id: activate-keyword-title
    desc: Activate keyword (titlecase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "Activate"

  - id: revshell-keyword-lower
    desc: revshell keyword (lowercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "revshell"

  - id: revshell-keyword-upper
    desc: REVSHELL keyword (uppercase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "REVSHELL"

  - id: revshell-keyword-title
    desc: Revshell keyword (titlecase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "Revshell"

  # ICMP protocol constant
  - id: icmp-echo-const
    desc: ICMP_ECHO constant
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "ICMP_ECHO"

composite_rules:
  # Helper: ICMP handling context
  - id: icmp-context
    desc: ICMP packet handling context
    any:
      - id: icmp-hdr-struct
      - id: icmp-rcv

  # Helper: Magic value patterns (numeric only - word "magic" removed due to false positives)
  - id: magic-values
    desc: Magic trigger values
    any:
      - id: magic-1337
      - id: magic-0x539

  # Helper: Trigger keywords
  - id: trigger-keywords
    desc: C2 trigger activation keywords
    any:
      - id: trigger-keyword-lower
      - id: trigger-keyword-upper
      - id: trigger-keyword-title
      - id: activate-keyword-lower
      - id: activate-keyword-upper
      - id: activate-keyword-title
      - id: revshell-keyword-lower
      - id: revshell-keyword-upper
      - id: revshell-keyword-title
      - id: icmp-echo-const

  # ICMP Magic Packet Trigger
  - id: icmp-magic-packet
    desc: ICMP packet inspection for magic
    crit: suspicious
    conf: 0.95
    attack: "T1205.001"
    for: [c, go, python]
    all:
      - id: icmp-context
      - id: magic-values
      - id: trigger-keywords
