# C2 Typosquatting Domain Detection
# Detects malware using typosquatted domains to impersonate legitimate services
# ATT&CK: T1036.005 (Masquerading: Match Legitimate Name or Location)
# MBC: B0030 (C2 Communication)

defaults:
  crit: suspicious
  attack: "T1036.005"
  mbc: "B0030"
  for: ["*"]

traits:
  # === GitHub Typosquatting ===
  - id: typosquat-git-hub-domain
    desc: Git typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "git-hub\\.[a-z]{2,}"

  - id: typosquat-githab-domain
    desc: Githab typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "githab\\.[a-z]{2,}"

  - id: typosquat-githup-domain
    desc: Githup typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "githup\\.[a-z]{2,}"

  # === Generic Typosquatting Patterns ===
  - id: typosquat-double-letter
    desc: Double letter typosquat
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "(giithub|githhub|githuub|githubb)\\.[a-z]{2,}"

  - id: typosquat-letter-swap
    desc: Letter swap typosquat
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "(githuk\\.|gihhub\\.|gituhb\\.|githbu\\.|githyb\\.)[a-z]{2,}"
    not:
      - "github.com"
      - "github.io"
      - "githubusercontent.com"
      - "github.blog"
      - "github.community"
      - "github.dev"
      - "github.help"
      - "github.jobs"
      - "github.market"
      - "github.shop"
      - "github.status"
      - "githubapp.com"
      - "githubstatus.com"
      - "github.yml"
      - "github.yaml"
      - "github.json"
      - "github.rb"
      - "github.sh"
      - "github.js"
      - "github.png"
      - "github.svg"
      - "github.md"
      - "github.txt"

  # === Popular Service Typosquatting ===
  - id: typosquat-google-domain
    desc: Google typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "(gooogle|googel|goggle)\\.[a-z]{2,}"

  - id: typosquat-apple-domain
    desc: Apple typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "(appple|aple|applee)\\.[a-z]{2,}"

  - id: typosquat-microsoft-domain
    desc: Microsoft typosquat domain
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "(microsof|microsft|micrsoft)\\.[a-z]{2,}"

  # === C2 Protocol Indicators ===
  - id: c2-view-php-endpoint
    desc: C2 view.php endpoint
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "view\\.php\\?"

  - id: c2-gate-php-endpoint
    desc: C2 gate.php endpoint
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "gate\\.php"

  - id: c2-panel-php-endpoint
    desc: C2 panel.php endpoint
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "panel\\.php"

composite_rules:
  # === Typosquatting Detection Composites ===
  - id: github-typosquat
    desc: GitHub typosquatting domain
    crit: suspicious
    conf: 0.95
    attack: "T1036.005"
    mbc: "B0030"
    for: [python, javascript, shell]
    needs: 1
    any:
      - id: typosquat-git-hub-domain
      - id: typosquat-githab-domain
      - id: typosquat-githup-domain
      - id: typosquat-double-letter
      - id: typosquat-letter-swap

  - id: popular-service-typosquat
    desc: Popular service typosquatting
    crit: suspicious
    conf: 0.95
    attack: "T1036.005"
    needs: 1
    any:
      - id: typosquat-google-domain
      - id: typosquat-apple-domain
      - id: typosquat-microsoft-domain

  - id: c2-php-endpoint
    desc: C2 PHP endpoint pattern
    crit: notable
    conf: 0.80
    attack: "T1071.001"
    needs: 1
    any:
      - id: c2-view-php-endpoint
      - id: c2-gate-php-endpoint
      - id: c2-panel-php-endpoint

  # === High-Confidence C2 Detection ===
  - id: typosquat-c2-combo
    desc: Typosquat domain with C2 endpoint
    crit: suspicious
    conf: 0.98
    attack: "T1036.005"
    mbc: "B0030"
    for: [python, javascript, shell]
    platforms: [all]
    needs: 2
    all:
      - id: github-typosquat
      - id: c2-php-endpoint
