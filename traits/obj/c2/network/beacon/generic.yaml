# C2 Network Communication Patterns
# MBC: B0030 (C2 Communication)
# ATT&CK: T1071.001 (Web Protocols)

traits:
  # === HTTP template atomic indicators ===
  - id: post-template
    desc: POST template with placeholder
    crit: inert
    conf: 0.6
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "POST\\s+%s\\s+HTTP"

  - id: get-template
    desc: GET template with placeholder
    crit: inert
    conf: 0.6
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "GET\\s+%s\\s+HTTP"

  - id: hardcoded-ip
    desc: Hardcoded IP address
    crit: suspicious
    conf: 0.75
    mbc: "B0030"
    # Size constraint: Compiled binaries have byte patterns that look like IPs.
    # C2 implants with hardcoded IPs are typically compact (<300KB) for stealth.
    size_max: 300000
    if:
      type: string
      # Match IP-like patterns; external_ip validates they're routable external addresses
      regex: '\b[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\b'
      external_ip: true

  - id: user-agent-rotation
    desc: Multiple User-Agent strings (evasion technique)
    crit: suspicious
    conf: 0.80
    mbc: "F0001.004"
    attack: "T1036"
    if:
      type: string
      regex: "User-Agent:"
      needs: 3
  # === Bot User-Agent atomic indicators ===
  - id: googlebot-ua
    desc: Googlebot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "Googlebot"

  - id: bingbot-ua
    desc: bingbot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "bingbot"

  - id: baiduspider-ua
    desc: Baiduspider User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "Baiduspider"

  - id: yandexbot-ua
    desc: YandexBot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "YandexBot"

  - id: duckduckbot-ua
    desc: DuckDuckBot User-Agent
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "DuckDuckBot"

  - id: wget-download
    desc: wget download command (payload fetching)
    crit: suspicious
    conf: 0.80
    mbc: "E1105"
    attack: "T1105"
    if:
      type: string
      regex: "wget\\s+https?://"

  # === Typosquatting C2 domains ===
  - id: typosquat-git-hub
    desc: Git typosquat domain
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      substr: "git-hub"

  - id: typosquat-domain-pattern
    desc: Typosquat domain pattern
    crit: suspicious
    conf: 0.80
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "(githu[bk]\\.|gi[th]hub\\.|github\\.(?!com|io|org)[a-z]{2,}|githab\\.|githyb\\.)"

  # === C2 Command Protocols ===
  - id: c2-command-pattern-numeric
    desc: Numeric C2 command protocol
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: 'cmd[_-]?type.{0,5}=.{0,5}["'']?[0-9]{3}["'']?'

  - id: c2-response-pattern-numeric
    desc: C2 response code parsing
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "res\\[.{0,10}:.{0,10}\\+.{0,5}[0-9]{3}"

  # === C2 Beaconing Patterns ===
  - id: sleep-in-while-true
    desc: Infinite loop with sleep delay
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    for: [python, javascript, shell]
    if:
      type: string
      regex: "while\\s+True:.*?sleep\\s*\\("

  - id: c2-polling-loop
    desc: C2 polling with sleep interval
    crit: suspicious
    conf: 0.80
    mbc: "B0030"
    attack: "T1071.001"
    for: [python, javascript, shell]
    if:
      type: string
      regex: "(while.{0,50}True|while\\s+1).{0,50}sleep"

  # === JSON C2 Communication ===
  - id: json-content-type-header
    desc: JSON content-type for C2 communication
    crit: notable
    conf: 0.70
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "application/json.{0,50}charset"

composite_rules:
  # HTTP template composite
  - id: http-template
    desc: HTTP request template with placeholders
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    needs: 1
    any:
      - id: post-template
      - id: get-template

  - id: bot-user-agent
    desc: Search engine bot User-Agent (DDoS/evasion)
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    needs: 1
    any:
      - id: googlebot-ua
      - id: bingbot-ua
      - id: baiduspider-ua
      - id: yandexbot-ua
      - id: duckduckbot-ua

  - id: direct-http-c2
    desc: Direct HTTP C2 infrastructure
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    # Size constraint: Large binaries (Rust/Go with regex, Unicode tables, SQLite) often have
    # byte patterns that look like IPs. C2 implants are typically compact (<1.5MB).
    size_max: 1500000
    any:
      - id: obj/c2/infrastructure/ip/http-raw-ip-url-content
      - id: obj/c2/infrastructure/ip/http-raw-ip-url-string
      - id: obj/c2/infrastructure/ip/hardcoded-ipv4

  - id: c2-http-ip-binary
    desc: HTTP IP-based C2 in binary
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    for: [elf, macho, pe]
    # Size constraint: C2 implants are typically compact (<1.5MB) for stealth.
    # Large binaries (Rust/Go with regex, Unicode tables, SQLite) often have byte patterns
    # that look like IPs but are actually lookup tables or compressed data.
    size_max: 1500000
    all:
      - id: direct-http-c2
      - id: cap/exec/command
      - id: cap/comm/socket
