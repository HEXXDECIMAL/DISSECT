# C2 Network Communication Patterns
# MBC: B0030 (C2 Communication)
# ATT&CK: T1071.001 (Web Protocols)

traits:
  # === HTTP template atomic indicators ===
  - id: post-template
    desc: POST HTTP template with format specifier
    crit: notable
    conf: 0.6
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "POST\\s+%s\\s+HTTP"

  - id: get-template
    desc: GET HTTP template with format specifier
    crit: notable
    conf: 0.6
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "GET\\s+%s\\s+HTTP"

  - id: hardcoded-ip
    desc: Hardcoded IP endpoint
    crit: suspicious
    conf: 0.75
    mbc: "B0030"
    for: [elf, macho, pe]
    # Size constraint: Compiled binaries have byte patterns that look like IPs.
    # C2 implants with hardcoded IPs are typically compact (<150KB) for stealth.
    size_max: 150000
    if:
      type: string
      # Objective-level C2 should require endpoint context, not bare dotted quads
      # Require protocol (http/s) OR an explicit port number
      regex: '(https?://[0-9]{1,3}(?:\.[0-9]{1,3}){3}(?:[/:][^\s"''<>]{0,120})?|[0-9]{1,3}(?:\.[0-9]{1,3}){3}:[0-9]{2,5}\b)'
      external_ip: true
      section: data
    # Certificate DER-encoded data contains byte patterns that look like IPs.
    # Signed system DLLs are not C2 beacons.
    # Windows PE manifests indicate SDK-built binaries whose .text section
    # machine code produces false IP matches from instruction byte patterns.
    downgrade:
      any:
        - type: string
          substr: "Certificate"
        - type: string
          substr: "DigiCert"
        - type: string
          substr: "Python Software Foundation"
        - type: string
          substr: "schemas-microsoft-com:asm"
        - type: string
          substr: "Microsoft Corporation"
        - type: string
          substr: "Microsoft速 Windows速 Operating System"
    # API set forwarding stubs contain certificate DER data that matches
    # as IPs but are definitively not C2 beacons.
    unless:
      - type: string
        substr: "ApiSet Stub DLL"

  # Multiple hardcoded IPs in a small binary suggests C2 infrastructure
  # with failover/redundancy - a common malware pattern
  - id: multiple-hardcoded-ips
    desc: Multiple hardcoded IP endpoints (C2 redundancy)
    crit: suspicious
    conf: 0.90
    mbc: "B0030"
    attack: "T1071.001"
    for: [elf, macho, pe]
    size_max: 500000
    if:
      type: string
      # Require protocol (http/s) OR an explicit port number
      regex: '(https?://[0-9]{1,3}(?:\.[0-9]{1,3}){3}(?:[/:][^\s"''<>]{0,120})?|[0-9]{1,3}(?:\.[0-9]{1,3}){3}:[0-9]{2,5}\b)'
      external_ip: true
      section: data
      count_min: 3
    downgrade:
      any:
        - type: string
          substr: "Certificate"
        - type: string
          substr: "DigiCert"
        - type: string
          substr: "Python Software Foundation"
        - type: string
          substr: "schemas-microsoft-com:asm"
        - type: string
          substr: "Microsoft Corporation"
        - type: string
          substr: "Microsoft速 Windows速 Operating System"
    unless:
      - type: string
        substr: "ApiSet Stub DLL"
      - type: string
        substr: "Certificate"

  # Compact C2 implants have dense communication patterns - many indicators
  # packed into a small binary. Legitimate tools spread these across larger code.
  - id: compact-beacon
    desc: Dense C2 patterns in compact binary
    crit: suspicious
    conf: 0.88
    mbc: "B0030"
    attack: "T1071.001"
    for: [elf, macho, pe]
    size_max: 100000
    if:
      type: string
      regex: "(User-Agent|POST\\s+|GET\\s+|HTTP/1\\.|Content-Type)"
      count_min: 5
      per_kb_min: 0.5

  - id: user-agent-header-multiple
    desc: Multiple User-Agent header entries
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "User-Agent:"
      count_min: 3

  - id: user-agent-literal-pool
    desc: Multiple concrete User-Agent literals
    crit: notable
    conf: 0.80
    if:
      type: string
      regex: "User-Agent:\\s*(Mozilla/5\\.0|curl/[0-9]|Wget/[0-9]|python-requests/[0-9]|Go-http-client/[0-9]|okhttp/[0-9]|libwww-perl|Java/[0-9]|PowerShell/[0-9]|WinHTTP|Microsoft\\s+BITS)"
      count_min: 2

  - id: user-agent-rotation-keywords
    desc: User-Agent randomization or rotation terms
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "(user.?agent.{0,20}(rotate|rotation|random|rand|cycle|switch|pool|list)|random\\.choice\\(.{0,40}[Uu]ser.?[Aa]gent|Math\\.random\\(.{0,40}[Uu]ser.?[Aa]gent|shuffle\\(.{0,40}[Uu]ser.?[Aa]gent)"
      case_insensitive: true
  # === Bot User-Agent atomic indicators ===
  - id: googlebot-ua
    desc: Googlebot User-Agent
    crit: notable
    conf: 0.7
    if:
      type: string
      # Require version slash or full bot string to avoid matching browser detection lists
      regex: "(?i)Googlebot/\\d|Mozilla/5\\.0\\s+\\+http://www\\.google\\.com/bot\\.html"

  - id: bingbot-ua
    desc: bingbot User-Agent
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)bingbot/\\d"

  - id: baiduspider-ua
    desc: Baiduspider User-Agent
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)Baiduspider/\\d"

  - id: yandexbot-ua
    desc: YandexBot User-Agent
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)YandexBot/\\d"

  - id: duckduckbot-ua
    desc: DuckDuckBot User-Agent
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)DuckDuckBot/\\d"

  - id: wget-download
    desc: wget download command (payload fetching)
    crit: suspicious
    conf: 0.80
    mbc: "E1105"
    attack: "T1105"
    if:
      type: string
      regex: "wget\\s+https?://"

  # === Typosquatting C2 domains ===
  - id: typosquat-git-hub
    desc: Git typosquat domain
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      substr: "git-hub"

  - id: typosquat-domain-pattern
    desc: Typosquat domain pattern
    crit: suspicious
    conf: 0.80
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      # Avoid matching literal 'github.' as a stem to prevent false positives on 'github.com'
      # that fail the 'not' filter due to partial matching.
      regex: "githuk\\.|gihub\\.|gthub\\.|githhub\\.|githab\\.|githyb\\.|github\\.[a-z]{2,}"
    not:
      - substr: "github.com"
      - substr: "github.io"
      - substr: "github.org"

  # === C2 Command Protocols ===
  - id: c2-command-pattern-numeric
    desc: Numeric C2 command protocol
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: 'cmd[_-]?type.{0,5}=.{0,5}["'']?[0-9]{3}["'']?'

  - id: c2-response-pattern-numeric
    desc: C2 response code parsing
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "res\\[.{0,10}:.{0,10}\\+.{0,5}[0-9]{3}"

  # === C2 Beaconing Patterns ===
  - id: sleep-in-while-true
    desc: Infinite loop with sleep delay
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    for: [python, javascript, shell]
    if:
      type: string
      regex: "while\\s+True:.*?sleep\\s*\\("

  - id: c2-polling-loop
    desc: C2 polling with sleep interval
    crit: suspicious
    conf: 0.80
    mbc: "B0030"
    attack: "T1071.001"
    for: [python, javascript, shell]
    if:
      type: string
      regex: "(while.{0,50}True|while\\s+1).{0,50}sleep"

  # === JSON C2 Communication ===
  - id: json-content-type-header
    desc: JSON content-type for C2 communication
    crit: notable
    conf: 0.70
    mbc: "B0030"
    attack: "T1071.001"
    if:
      type: string
      regex: "application/json.{0,50}charset"

composite_rules:
  # HTTP template composite
  - id: http-template
    desc: HTTP request template with placeholders
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    any:
      - id: post-template
      - id: get-template

  - id: bot-user-agent
    desc: Search engine bot User-Agent (DDoS/evasion)
    crit: notable
    conf: 0.85
    mbc: "B0030"
    attack: "T1071.001"
    any:
      - id: googlebot-ua
      - id: bingbot-ua
      - id: baiduspider-ua
      - id: yandexbot-ua
      - id: duckduckbot-ua

  - id: user-agent-rotation
    desc: Multiple User-Agent strings (evasion technique)
    crit: suspicious
    conf: 0.82
    mbc: "F0001.004"
    attack: "T1036"
    all:
      - id: user-agent-header-multiple
      - id: user-agent-literal-pool
      - id: user-agent-rotation-keywords

  - id: direct-http-c2
    desc: Direct HTTP C2 infrastructure
    crit: notable
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    # Size constraint: Large binaries (Rust/Go with regex, Unicode tables, SQLite) often have
    # byte patterns that look like IPs. C2 implants are typically compact (<1.5MB).
    size_max: 1500000
    all:
      - id: obj/c2/infrastructure/ip

  - id: c2-http-ip-binary
    desc: HTTP IP-based C2 in binary
    crit: notable
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    for: [elf, macho, pe]
    # Size constraint: C2 implants are typically compact (<1.5MB) for stealth.
    # Large binaries (Rust/Go with regex, Unicode tables, SQLite) often have byte patterns
    # that look like IPs but are actually lookup tables or compressed data.
    size_max: 1500000
    all:
      - id: direct-http-c2
      - id: cap/process/create/
      - id: cap/comm/socket/
