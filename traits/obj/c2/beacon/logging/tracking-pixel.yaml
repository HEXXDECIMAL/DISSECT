# C2 Beaconing to tracking/logging services
# Detects malware that uses tracking pixels or IP loggers for beaconing
# ATT&CK: T1071.001 (Web Protocols)
# MBC: B0030 (C2 Communication)

defaults:
  crit: suspicious
  attack: "T1071.001"
  mbc: "B0030"

composite_rules:
  - id: ruby-tracking-pixel-beacon
    desc: Ruby HTTP request to tracking/logging service (beaconing)
    all:
      - id: cap/comm/http/lib/netlib::request-ruby
    any:
      - id: obj/discovery/network/scan::iplogger
      - id: obj/discovery/network/scan::iplogger-keyword
      - id: obj/discovery/network/scan::iplogger-b64
      - id: cap/c2/infrastructure/network::ruby-ast-fragmented-iplogger
      - id: cap/c2/infrastructure/network::ruby-ast-fragmented-iplogger-alt

  - id: python-tracking-pixel-beacon
    desc: Python HTTP request to tracking/logging service (beaconing)
    all:
      - id: cap/comm/http/lib/requests::requests-python
    any:
      - id: obj/discovery/network/scan::iplogger
      - id: obj/discovery/network/scan::iplogger-keyword
      - id: obj/discovery/network/scan::iplogger-b64

  - id: generic-tracking-pixel-beacon
    desc: HTTP request to tracking/logging service (beaconing)
    all:
      - id: cap/comm/http/request::request
    any:
      - id: obj/discovery/network/scan::iplogger
      - id: obj/discovery/network/scan::iplogger-keyword
      - id: obj/discovery/network/scan::iplogger-b64
