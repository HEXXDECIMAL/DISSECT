# Shell Script Dropper Detection
# Detects shell scripts that download and execute remote payloads
# ATT&CK: T1105 (Ingress Tool Transfer), T1059.004 (Command and Scripting Interpreter: Unix Shell)
# MBC: B0030 (Dropper)

defaults:
  crit: suspicious
  attack: "T1105"
  mbc: "B0030"
  for: [shell]

traits:
  # === Download and Execute Patterns ===
  - id: download-execute
    desc: Downloads and executes remote script
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    if:
      type: raw
      # curl/wget piped to sh/bash
      regex: "(?:curl|wget)\\s+[^|]{0,50}\\|\\s*(?:sh|bash)"

  - id: download-execute-quiet
    desc: Silent download and execute
    crit: suspicious
    conf: 0.95
    attack: "T1059.004"
    if:
      type: raw
      # curl -s or wget -q piped to shell
      regex: "(?:curl\\s+-[so]|wget\\s+-[qO])\\s+[^|]{0,50}\\|\\s*(?:sh|bash)"

  - id: download-save-execute
    desc: Downloads, saves, and executes
    crit: suspicious
    conf: 0.90
    if:
      type: raw
      # wget -O file url && chmod +x && ./file pattern
      regex: "(?:curl\\s+-o|wget\\s+-O)\\s+\\S+[^&]{0,50}&&[^&]{0,30}chmod\\s+\\+x"

  - id: download-url-hardcoded
    desc: Hardcoded download URL
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # HTTP URL in wget/curl command
      regex: "(?:curl|wget)\\s+[^\\n]{0,50}https?://[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+"

  # === Loader/Downloader Selection ===
  - id: loader-selection
    desc: Selects curl or wget dynamically
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # Checking for curl/wget availability and setting variable
      regex: "if[^;]{0,30}command\\s+-v\\s+(?:curl|wget)|(?:LDR|WGET|DL)\\s*=[^;]{0,30}(?:curl|wget)"

  # === Payload Verification ===
  - id: md5-verification
    desc: MD5 checksum verification
    crit: notable
    conf: 0.80
    if:
      type: raw
      regex: "md5sum\\s+\\S+\\s*\\|\\s*awk"

  - id: payload-checksum-compare
    desc: Payload integrity verification
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      # Comparing MD5 hash to expected value
      regex: "\\$MD5[^=]{0,20}=[^$]{0,20}\\$sum|\\$sum[^=]{0,20}=[^$]{0,20}\\$MD5|checkExists"

composite_rules:
  # Full dropper pattern: selects downloader, downloads, verifies, executes
  # Complexity: all(4) + for(1) = 5 >= 4 âœ“ HOSTILE
  - id: verified-dropper
    desc: Verified payload dropper
    crit: hostile
    conf: 0.95
    attack: "T1105"
    all:
      - id: loader-selection
      - id: download-url-hardcoded
      - id: payload-checksum-compare
      - id: download-save-execute

  # Simple dropper: download and execute with hardcoded URL
  # Complexity: all(2) + for(1) = 3 < 4, stays SUSPICIOUS
  - id: simple-dropper
    desc: Simple download-execute dropper
    crit: suspicious
    conf: 0.90
    attack: "T1105"
    all:
      - id: download-execute
      - id: download-url-hardcoded
