composite_rules:
  - id: nemucod-co-uk-fragment
    desc: Nemucod C2 domain fragment variant
    crit: suspicious
    conf: 0.9
    for: [javascript]
    any:
      - id: cap/data/string/nemucod-url-fragment::co-uk-tld
      - id: cap/data/string/nemucod-url-fragment::co-uk-tld-nodot

  - id: nemucod-adodb-write-path
    desc: Nemucod ADODB stream write/save chain (literal or obfuscated)
    crit: suspicious
    conf: 0.92
    for: [javascript]
    any:
      - id: cap/fs/write/file::adodb-savetofile
      - id: cap/fs/write/file::adodb-savetofile-obfuscated-fragments
      - id: obj/exec/interpreter/script/wsh::adodb-fragment-tiny-exact

  - id: nemucod-run-method
    desc: Nemucod execution method call (literal or dynamic WScript property)
    crit: suspicious
    conf: 0.9
    for: [javascript]
    any:
      - id: cap/process/create/shell/wsh::wscript-shell-run
      - id: cap/data/source/obfuscation/js::js-wscript-dynamic-property-raw
      - id: cap/data/source/obfuscation/js::js-wscript-dynamic-property-ast

  - id: nemucod-fragment-combination
    desc: Nemucod specific URL fragment combination (qw4o and co.uk)
    crit: suspicious
    conf: 0.9
    for: [javascript]
    all:
      - id: cap/data/string/nemucod-url-fragment::qw4o-fragment
      - id: obj/c2/dropper/nemucod::nemucod-co-uk-fragment

  - id: fragmented-url-dropper
    desc: Detects Nemucod JScript dropper using fragmented C2 URL construction, download via ADODB.Stream, and execution via WScript.Shell.
    crit: hostile
    conf: 0.98
    attack: T1059.007, T1105, T1027
    mbc: B0017, B0018, B0032
    for: [javascript]
    all:
      - id: cap/host/interpreter/jscript::is-jscript
      - id: obj/c2/dropper/nemucod::nemucod-adodb-write-path
      - id: obj/c2/dropper/nemucod::nemucod-run-method
      - id: cap/data/source/obfuscation/js::nemucod-wsh-fragments
    any:
      - id: cap/data/string/nemucod-url-fragment::js-fragmented-url-construction
      - id: cap/data/string/nemucod-url-fragment::js-fragmented-url-regex
      - id: obj/c2/dropper/nemucod::nemucod-fragment-combination
