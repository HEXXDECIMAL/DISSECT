# Batch-based Dropper Objectives
# Detects intentional payload delivery via Windows Batch scripts

defaults:
  crit: hostile
  conf: 0.9
  platforms: [windows]
  for: [batch]

composite_rules:
  - id: batch-lolbin-dropper
    desc: Batch script using LOLBins to download and execute
    attack: "T1105"
    mbc: "C0002"
    all:
      - id: obj/exec/dropper/script::download-tool
      - id: obj/exec/dropper/script::exec-cmd
    any:
      - id: obj/exec/dropper/script::certutil-urlcache
      - id: obj/exec/dropper/script::bitsadmin-download
      - id: obj/exec/dropper/script::powershell-download

  - id: batch-staging-dropper
    desc: Batch script downloading and executing from staging directory
    attack: "T1105"
    mbc: "E1074"
    all:
      - id: obj/exec/dropper/script::download-tool
      - id: obj/exec/dropper/script::exec-cmd
    any:
      - id: cap/fs/file/write/staging::users-public-path
      - id: obj/exec/dropper/script::run-from-temp

  - id: batch-arch-aware-dropper
    desc: Architecture-aware batch dropper
    attack: "T1105"
    mbc: "C0002"
    all:
      - id: obj/exec/dropper/script::download-tool
      - id: obj/exec/dropper/script::wmic-arch-check
    any:
      - id: obj/exec/dropper/script::exec-cmd
      - id: cap/fs/file/write/staging::users-public-path

  - id: batch-certutil-tcp-stager
    desc: Batch certutil stager with TCP stage query and architecture split
    attack: "T1105"
    mbc: "B0024"
    all:
      - id: obj/c2/ip::staged-tcp-query
      - id: obj/exec/dropper/script::certutil-urlcache-split-force
      - id: obj/exec/dropper/script::wmic-arch-check
      - id: cap/fs/file/write/staging::users-public-path
    any:
      - id: obj/exec/dropper/script::exec-cmd
      - id: cap/fs/file/delete::del-command
