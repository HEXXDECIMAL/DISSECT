# .NET Dropper Detection
# Detects .NET executables that decode and write payloads to disk
# MBC: B0030 (Dropper), C0027 (File Write)
# ATT&CK: T1027 (Obfuscated Files), T1140 (Deobfuscate/Decode Files)

defaults:
  mbc: "B0030"
  attack: "T1140"
  platforms: [windows]

traits:
  # === Base64 Decode + File Write Pattern ===
  - id: frombase64string
    desc: Base64 string decoding
    crit: notable
    conf: 0.75
    for: [all]
    if:
      type: string
      substr: "FromBase64String"

  - id: convert-frombase64
    desc: Convert.FromBase64String call
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: string
      regex: "Convert.{0,10}FromBase64String|\\[Convert\\]::FromBase64String"

  - id: writeallbytes
    desc: File.WriteAllBytes call
    crit: notable
    conf: 0.75
    for: [all]
    if:
      type: string
      substr: "WriteAllBytes"

  - id: io-file-write
    desc: System.IO.File write method
    crit: notable
    conf: 0.7
    for: [all]
    if:
      type: string
      regex: "System\\.IO\\.File.{0,20}Write|\\[System\\.IO\\.File\\]::Write"

  # === VBS file dropping ===
  - id: vbs-file-write
    desc: VBS file written to disk
    crit: suspicious
    conf: 0.85
    for: [all]
    attack: "T1059.005"
    if:
      type: string
      regex: "\\.vbs['\"]|WriteAllBytes.{0,50}\\.vbs"

  # === Script payload patterns ===
  - id: bat-file-write
    desc: BAT file written to disk
    crit: notable
    conf: 0.8
    for: [all]
    attack: "T1059.003"
    if:
      type: string
      regex: "\\.bat['\"]|WriteAllBytes.{0,50}\\.bat"

  - id: ps1-file-write
    desc: PS1 file written to disk
    crit: notable
    conf: 0.8
    for: [all]
    attack: "T1059.001"
    if:
      type: string
      regex: "\\.ps1['\"]|WriteAllBytes.{0,50}\\.ps1"

composite_rules:
  # Base64 decode and write file
  - id: base64-file-dropper
    desc: Base64 decode and write file
    crit: suspicious
    conf: 0.9
    attack: "T1140"
    for: [pe, dll, csharp]
    all:
      - id: frombase64string
      - id: writeallbytes

  # VBScript dropper from .NET
  - id: dotnet-vbs-dropper
    desc: .NET VBScript dropper
    crit: suspicious
    conf: 0.95
    attack: "T1059.005"
    for: [pe, dll, csharp]
    all:
      - id: base64-file-dropper
      - id: vbs-file-write

  # Script dropper (any script type)
  - id: dotnet-script-dropper
    desc: .NET script file dropper
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    for: [pe, dll, csharp]
    all:
      - id: frombase64string
      - id: writeallbytes
    any:
      - id: vbs-file-write
      - id: bat-file-write
      - id: ps1-file-write

  # Dropper with anti-forensics (drop + delete)
  # Complexity: all(2) + any(1) + file_types(1) = 4
  - id: dropper-with-cleanup
    desc: .NET dropper with anti-forensics
    crit: hostile
    conf: 0.95
    attack: "T1070.004"
    for: [pe, dll]
    all:
      - id: dotnet-vbs-dropper
      - id: obj/anti-forensics/self-delete/file::vbs-file-delete
    any:
      - id: obj/execution/reflective-load/memory::sma-namespace
      - id: obj/execution/reflective-load/memory::runspace-factory

  # .NET PowerShell dropper (drops VBS that launches PowerShell)
  # Complexity: all(3) + file_types(1) = 4
  - id: dotnet-powershell-vbs-dropper
    desc: .NET PowerShell VBS dropper
    crit: hostile
    conf: 0.95
    attack: "T1059.001"
    for: [pe, dll]
    all:
      - id: dotnet-vbs-dropper
      - id: obj/execution/reflective-load/memory::sma-namespace
      - id: obj/execution/reflective-load/memory::add-script
