# Native Binary Dropper Detection
# Detects compiled binaries that decode and execute embedded payloads
# MBC: B0030 (Dropper), B0032 (Obfuscation)
# ATT&CK: T1027.009 (Embedded Payloads), T1059 (Command Execution)

defaults:
  for: [macho, elf, pe]
  mbc: "B0030"
  attack: "T1027.009"

traits:
  # Large hex-encoded payload embedded in binary
  # Pattern: long continuous hex string (20000+ chars = 10KB+ decoded)
  # This is a dropper technique: encode payload as hex, decode at runtime
  # Common in AMOS stealer, cryptominers, and other macOS malware
  - id: large-hex-payload
    desc: Large hex-encoded payload string (10KB+)
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "^[0-9a-fA-F]{20000,}$"

  # Custom encoding alphabet (64 chars with special characters)
  # Malware often uses custom base64-like alphabets for obfuscation
  # Pattern: 60-66 chars containing letters, numbers, AND special chars
  # Examples: ">Ei*=%K6X#<ht!x4P8j(rHF3_pLJc9n1uWy5oqYI7gsbU+$@MSNA&k-)vVCGQZwR"
  # Standard base64 only uses +/= as special chars; custom alphabets use more
  # Key signal: MUST have 3+ distinct special chars from [><*%#!()@$&-+]
  # AND NOT look like printf (%@, %d, etc), XML tags, or Apple constants
  - id: custom-encoding-alphabet
    desc: Custom encoding alphabet (cipher/obfuscation)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    attack: "T1027"
    if:
      type: string
      # Match fixed-length custom base64-like alphabets (64 chars)
      # to avoid matching API/method signatures that include symbols.
      regex: "^[a-zA-Z0-9><*%#!()@$&\\-+]{64}$"
    not:
      # Exclude strings lacking lowercase letters (not alphabet-like)
      - regex: "^[^a-z]*$"
      # Exclude strings lacking uppercase letters
      - regex: "^[^A-Z]*$"
      # Exclude strings lacking digits
      - regex: "^[^0-9]*$"
      # Exclude strings lacking custom special chars
      - regex: "^[^><*%#!()@$&]*$"
      # Exclude strings with 2 or fewer special chars (weak custom alphabet signal)
      - regex: "^(?:[a-zA-Z0-9+\\-]*[><*%#!()@$&]){0,2}[a-zA-Z0-9+\\-]*$"
      # Exclude standard/base64url alphabet-like strings
      - regex: "^[A-Za-z0-9+/=]{64}$"
      - regex: "^[A-Za-z0-9_\\-]{64}$"
      # Exclude printf/format strings (have % at start with letter codes)
      - regex: "^%[a-zA-Z@]"
      # Exclude simple two-char format sequences
      - regex: "^%[@sd]"
      # Exclude XML/HTML tags
      - regex: "^<"
      - regex: ">$"
      # Exclude Apple OS constants (all uppercase)
      - regex: "^[A-Z][A-Z0-9_]+$"
      # Exclude strings with common English words (help text, descriptions)
      - regex: "(?i)(with|line|author|newline|text|format|string)"
      # Exclude strings that are mostly hyphens (formatting separators)
      - regex: "-{10,}"

composite_rules:
  # libcurl network dropper: downloads content via libcurl, writes to disk, executes via shell
  # Pattern seen in kworker_pretenders malware family (2024):
  # - Uses libcurl to download payloads
  # - Writes to user home directory files for persistence
  # - Executes downloaded content via system()
  # - Reads /proc/self/exe for self-discovery
  # Malware droppers are typically small (<500KB) - legitimate tools are much larger
  # Complexity: all(4) + for(1) + size_max(1) = 6 >= 4 ✓ HOSTILE
  - id: libcurl-network-dropper
    desc: libcurl dropper (downloads and executes payload)
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1105"
    for: [elf]
    size_max: 500000
    all:
      - id: cap/comm/download/curl::libcurl-http
      - id: cap/exec/command/shell::shell-execution
      - id: cap/fs/file/operations::binary-file-ops
      - id: cap/fs/proc/info::process-pid-exe

  # Minimal libcurl dropper: stripped binary with curl + system + few imports
  # This variant doesn't need /proc/self/exe but has minimal imports indicating malicious intent
  # Complexity: all(3) + for(1) = 4 >= 4 ✓ HOSTILE
  - id: libcurl-minimal-dropper
    desc: Minimal libcurl dropper (stripped binary)
    crit: hostile
    conf: 0.92
    mbc: "B0030"
    attack: "T1105"
    for: [elf]
    all:
      - id: cap/comm/download/curl::libcurl-http
      - id: cap/exec/command/shell::shell-execution
      - id: obj/anti-static/obfuscation/payload::minimal-imports

  # Hex-encoded dropper: large hex blob + system() + minimal imports
  # This is a classic dropper pattern: decode hex payload and execute via shell
  # Complexity: all(3) + file_types(1) = 4 >= 4 ✓ HOSTILE
  - id: hex-payload-dropper
    desc: Hex-encoded payload dropper (decodes and executes)
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1059"
    for: [macho, elf]
    all:
      - id: large-hex-payload
      - id: obj/anti-static/obfuscation/payload::minimal-imports
      - id: cap/exec/command/shell::shell-execution

  # Obfuscated payload dropper: custom encoding + large payload + exec
  # This pattern is common in macOS malware like FakeZoom/AMOS stealer
  # Uses custom encoding alphabet to decode embedded payload, then executes
  # Complexity: all(3) + file_types(1) = 4 >= 4 ✓ HOSTILE
  - id: custom-encoded-dropper
    desc: Custom-encoded payload dropper
    crit: hostile
    conf: 0.92
    mbc: "B0030"
    attack: "T1059"
    for: [macho, elf]
    all:
      - id: large-hex-payload
      - id: custom-encoding-alphabet
      - id: cap/exec/command/shell::shell-execution
