# Stealth Node.js Dropper Patterns
# ATT&CK: T1195.002 (Supply Chain Compromise), T1059.007 (JavaScript)
# MBC: B0024 (Downloader), F0011 (Background process)
#
# Pattern: NPM packages that spawn detached Node.js processes to execute
# secondary payloads while hiding all I/O. Common in supply-chain attacks.

defaults:
  for: [javascript, typescript]

composite_rules:
  # === Helper composites ===

  - id: stdio-suppressed
    desc: Process stdio suppressed
    crit: suspicious
    conf: 0.85
    any:
      - id: cap/process/spawn::stdio-ignore-array
      - id: cap/process/spawn::stdio-ignore-string

  # === Stealth dropper composite ===

  # Main pattern: detached + stdio hidden + unref = stealthy background execution
  # Complexity: file_types (1) + all (3) = 4 (meets HOSTILE threshold)
  - id: stealth-spawn
    desc: Stealthy detached process spawn
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    for: [javascript]
    all:
      - id: cap/process/spawn::detached-true
      - id: stdio-suppressed
      - id: cap/process/spawn::child-unref-call
    unless:
      - id: meta/dev/testing::node-core-test
      - id: obj/lateral/supply-chain/npm/testing::test-filename-pattern

  # Node.js self-spawning dropper pattern
  # Complexity: file_types (1) + all (4) = 5 (meets HOSTILE threshold)
  - id: node-dropper
    desc: Node.js dropper spawning payload
    crit: hostile
    conf: 0.95
    attack: "T1059.007"
    mbc: "B0024"
    for: [javascript]
    all:
      - id: cap/process/spawn::process-execpath-spawn
      - id: cap/process/spawn::detached-true
      - id: stdio-suppressed
      - id: cap/process/spawn::child-unref-call
    unless:
      - id: meta/dev/testing::node-core-test
      - id: obj/lateral/supply-chain/npm/testing::test-filename-pattern

  # Supply-chain dropper: child_process + stealth spawn + no exports
  # Complexity: file_types (1) + all (3) = 4 (meets HOSTILE threshold)
  - id: supply-chain-dropper
    desc: Supply-chain attack dropper
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "B0024"
    for: [javascript]
    all:
      - id: cap/process/create/shell/lang::child-process-require
      - id: stealth-spawn
