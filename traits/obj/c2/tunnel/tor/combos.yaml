# Tor Hidden Service Dropper Composite Rules
# Combines Tor hidden service setup with dropper and execution behavior
# MBC: B0030 (C2), E1059 (Script Execution)
# ATT&CK: T1090.003 (Multi-hop Proxy), T1059 (Command Execution)

composite_rules:
  # .NET PE that sets up Tor hidden service with PowerShell
  # Complexity: all(4) = 4 -> hostile maintained
  - id: dotnet-tor-backdoor
    desc: .NET Tor hidden service backdoor
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1090.003"
    for: [pe, dll]
    all:
      - id: cap/exec/reflective-load/memory::dotnet-powershell-host
      - id: obj/c2/tunnel/tor::hidden-service-setup
      - id: obj/c2/tunnel/tor::torproject-url
      - id: obj/c2/tunnel/tor::onion-domain

  # Tor hidden service with embedded payloads
  # Complexity: all(3) + any(1) = 4 -> hostile maintained
  - id: tor-payload-dropper
    desc: Tor dropper with embedded payloads
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1140"
    for: [pe, dll]
    all:
      - id: obj/c2/tunnel/tor::hidden-service-setup
      - id: obj/c2/dropper/embedded-payload::frombase64string
      - id: obj/c2/tunnel/tor::onion-domain
    any:
      - id: obj/c2/dropper/embedded-payload::writeallbytes
      - id: cap/exec/vbscript/interpreter::wscript-shell-exec

  # Tor hidden service exposing sensitive ports (RDP/SMB/SSH)
  # Complexity: all(2) + any(1) = 3 -> suspicious (not enough for hostile)
  - id: tor-sensitive-port-exposure
    desc: Tor exposing sensitive services
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1021"
    all:
      - id: obj/c2/tunnel/tor::hidden-service-setup
      - id: obj/c2/tunnel/tor::torproject-url
    any:
      - id: obj/c2/tunnel/tor::rdp-over-tor
      - id: obj/c2/tunnel/tor::smb-over-tor
      - id: obj/c2/tunnel/tor::ssh-over-tor
