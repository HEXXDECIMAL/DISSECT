# Reverse Shell Detection - Go
# MBC: B0033 (Adversary-in-the-Middle)
# ATT&CK: T1059

defaults:
  for: [go, elf, macho, pe]

traits:
  # === Go exec micro-traits ===
  - id: os-exec-command
    desc: os/exec.Command reference
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "os/exec.Command"

  - id: exec-cmd-start
    desc: exec.(*Cmd).Start reference
    crit: notable
    conf: 0.4
    if:
      type: string
      substr: "exec.(*Cmd).Start"

  - id: exec-cmd-run
    desc: exec.(*Cmd).Run reference
    crit: notable
    conf: 0.4
    if:
      type: string
      substr: "exec.(*Cmd).Run"

  # === Go pipe micro-traits ===
  - id: stdin-pipe
    desc: StdinPipe reference
    crit: notable
    conf: 0.5
    if:
      type: string
      substr: "StdinPipe"

  - id: stdout-pipe
    desc: StdoutPipe reference
    crit: notable
    conf: 0.4
    if:
      type: string
      substr: "StdoutPipe"

  - id: stderr-pipe
    desc: StderrPipe reference
    crit: notable
    conf: 0.4
    if:
      type: string
      substr: "StderrPipe"

  - id: stdin-redirect
    desc: Direct stdin redirection
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "Stdin ="

  - id: stdout-redirect
    desc: Direct stdout redirection
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "Stdout ="

  - id: stderr-redirect
    desc: Direct stderr redirection
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "Stderr ="

  # === Shell path micro-traits ===
  # NOTE: cmd-exe moved to obj/exec/interpreter/script/indicators/windows.yaml to avoid duplication

  - id: cmd-plain
    desc: Windows cmd shell reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "cmd"

composite_rules:
  # Go connection composite
  - id: go-net-connection
    desc: Go network connection
    crit: notable
    conf: 0.6
    all:
      - id: cap/comm/socket/

  # Go exec composite
  - id: go-exec
    desc: Go command execution
    crit: notable
    conf: 0.6
    any:
      - id: os-exec-command
      - id: exec-cmd-start
      - id: exec-cmd-run
      - id: cap/process/create/direct::exec-command

  # Go pipe composite
  - id: go-pipe
    desc: Go pipe redirection
    crit: notable
    conf: 0.5
    any:
      - id: stdin-pipe
      - id: stdout-pipe
      - id: stderr-pipe
      - id: stdin-redirect
      - id: stdout-redirect
      - id: stderr-redirect

  # Shell composite
  - id: shell-path
    desc: Shell path reference
    crit: notable
    conf: 0.5
    any:
      - id: cap/process/create/shell::bin-sh
      - id: cap/process/create/shell::bin-bash
      - id: cap/process/create/shell::cmd-exe
      - id: cmd-plain

  # Go reverse shell (migrated from YARA)
  - id: go-reverse-shell
    desc: Go reverse shell implementation patterns
    crit: suspicious
    conf: 0.85
    mbc: "B0033"
    attack: "T1059"
    all:
      - id: go-net-connection
      - id: go-exec
    any:
      - id: go-pipe
      - id: shell-path
