# Reverse Shell Detection - Ruby
# MBC: B0033 (Adversary-in-the-Middle)
# ATT&CK: T1059

defaults:
  for: [ruby]

traits:
  # === Ruby socket micro-traits ===
  - id: tcpsocket-ref
    desc: TCPSocket class reference
    crit: notable
    conf: 0.6
    attack: "T1059"
    if:
      type: string
      substr: "TCPSocket"

  - id: tcpsocket-new
    desc: TCPSocket.new call
    crit: notable
    conf: 0.7
    attack: "T1059"
    if:
      type: ast
      kind: call
      exact: "TCPSocket.new"

  - id: spawn-sh
    desc: spawn with /bin/sh
    crit: suspicious
    conf: 0.8
    attack: "T1059"
    if:
      type: string
      regex: "spawn\\([\"']/bin/sh[\"']"

  - id: io-popen
    desc: IO.popen call
    crit: notable
    conf: 0.6
    attack: "T1059"
    if:
      type: string
      substr: "IO.popen"

  - id: io-popen-ast
    desc: IO.popen AST pattern
    crit: notable
    conf: 0.7
    attack: "T1059"
    if:
      type: ast
      kind: call
      exact: "IO.popen"

  - id: while-loop-cmd
    desc: While loop processing commands
    crit: notable
    conf: 0.75
    attack: "T1059"
    if:
      type: ast
      node: while
      regex: "while.{0,50}gets|while.{0,50}sock"

  - id: socket-gets
    desc: Socket gets call
    crit: notable
    conf: 0.7
    attack: "T1059"
    if:
      type: ast
      kind: call
      regex: "sock.gets|socket.gets"

  - id: copy-stream-socket
    desc: Copy stream to socket
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    if:
      type: ast
      kind: call
      regex: "copy_stream\\s*\\([^\\)]{0,200}\\b(sock|socket|tcpsocket)\\b"

  - id: open3-popen
    desc: Open3 popen call
    crit: notable
    conf: 0.75
    attack: "T1059"
    if:
      type: string
      regex: "Open3\\.popen|popen2e|popen3"

  - id: open3-popen-ast
    desc: Open3 popen AST pattern
    crit: notable
    conf: 0.8
    attack: "T1059"
    if:
      type: ast
      kind: call
      exact: "Open3.popen"

composite_rules:
  # Spawn with TCPSocket pattern
  - id: spawn-tcpsocket
    desc: spawn shell with TCPSocket
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    all:
      - id: spawn-sh
      - id: tcpsocket-ref

  # TCPSocket with IO.popen
  - id: tcpsocket-popen
    desc: TCPSocket with IO.popen
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    needs: 2
    any:
      - id: tcpsocket-ref
      - id: tcpsocket-new
      - id: io-popen
      - id: io-popen-ast

  # TCPSocket with interactive shell
  - id: tcpsocket-sh-i
    desc: TCPSocket with interactive shell
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    all:
      - id: tcpsocket-ref
      - id: cap/exec/command/shell/interactive/bin-sh-interactive

  # Ruby reverse shell with command loop
  - id: ruby-cmd-loop-shell
    desc: Ruby command loop reverse shell
    crit: suspicious
    conf: 0.9
    attack: "T1059"
    needs: 3
    any:
      - id: tcpsocket-new
      - id: tcpsocket-ref
      - id: while-loop-cmd
      - id: socket-gets
      - id: io-popen-ast
      - id: open3-popen
      - id: open3-popen-ast
      - id: copy-stream-socket

  # Ruby reverse shell (migrated from YARA)
  - id: reverse-shell-ruby
    desc: Reverse shell in Ruby
    crit: suspicious
    conf: 0.66
    mbc: "B0033"
    attack: "T1059"
    needs: 1
    any:
      - id: spawn-tcpsocket
      - id: tcpsocket-popen
      - id: tcpsocket-sh-i
      - id: ruby-cmd-loop-shell
