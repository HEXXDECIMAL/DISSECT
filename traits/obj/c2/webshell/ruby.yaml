# Ruby Webshell and Backdoor Detection
# Detects webshell patterns in Ruby web applications
# ATT&CK: T1505.003 (Server Software Component: Web Shell)

defaults:
  crit: suspicious
  attack: "T1505.003"
  for: [ruby]

traits:
  # === Cookie-based Command Channel ===
  - id: http-cookie-extract
    desc: HTTP cookie extraction
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "HTTP_COOKIE"

  - id: cookie-regex-extract
    desc: Cookie value regex extraction
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: "\\['HTTP_COOKIE'\\]\\.(match|scan|=~)"

  # === Rack/Rails Middleware Hooking ===
  - id: rack-middleware-hook
    desc: Rack middleware hooking
    crit: notable
    conf: 0.85
    if:
      type: content
      regex: "Rack::[A-Z][a-zA-Z]+\\.prepend"

  # === Base64 Decode + Eval (RCE pattern) ===
  - id: base64-decode-eval
    desc: Base64 decode to eval
    crit: suspicious
    conf: 0.95
    if:
      type: content
      regex: "eval\\s*\\(\\s*Base64\\.(decode64|urlsafe_decode64|strict_decode64)"

  # === External Data Exfiltration ===
  - id: faraday-exfil
    desc: Faraday HTTP with env data
    crit: suspicious
    conf: 0.85
    if:
      type: content
      regex: "Faraday\\.(get|post).{0,100}ENV\\["

composite_rules:
  # === Ruby Cookie-based Webshell ===
  # Complexity: file_types(+1) + all(+3) = 4 (meets HOSTILE threshold)
  - id: ruby-cookie-webshell
    desc: Ruby cookie-based webshell
    crit: hostile
    conf: 0.95
    attack: "T1505.003"
    mbc: "B0030"
    r#for: [ruby]
    all:
      - id: http-cookie-extract
      - id: cap/data/encode/base64/base64-decode
      - id: cap/exec/eval/eval-call

  # === Ruby Middleware Backdoor ===
  # Complexity: file_types(+1) + all(+4) = 5 (meets HOSTILE threshold)
  - id: ruby-middleware-backdoor
    desc: Ruby middleware backdoor
    crit: hostile
    conf: 0.95
    attack: "T1505.003"
    mbc: "B0030"
    r#for: [ruby]
    all:
      - id: rack-middleware-hook
      - id: cap/exec/eval/prepend-module
      - id: cap/data/encode/base64/base64-decode
      - id: cap/exec/eval/eval-call

  # === Base64 Eval RCE ===
  # Complexity: file_types(+1) + all(+2) = 3 (suspicious)
  - id: base64-eval-rce
    desc: Base64 decode to eval RCE
    crit: suspicious
    conf: 0.95
    attack: "T1059.005"
    r#for: [ruby]
    all:
      - id: cap/data/encode/base64/base64-decode
      - id: cap/exec/eval/eval-call
