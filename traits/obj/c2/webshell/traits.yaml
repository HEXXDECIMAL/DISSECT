# Webshell Detection
# ATT&CK: T1505.003 (Server Software Component: Web Shell)
# MBC: B0030 (Remote Access)

defaults:
  mbc: "B0030"
  attack: "T1505.003"

traits:
  # === PHP webshell atomic indicators ===
  - id: php-tag
    desc: PHP opening tag
    crit: inert
    conf: 0.3
    for: [php]
    if:
      type: string
      substr: "<?php"
      case_insensitive: true

  - id: php-system
    desc: PHP system() function call
    crit: notable
    conf: 0.7
    for: [php]
    if:
      type: string
      substr: "system("

  - id: php-exec
    desc: PHP exec() function call
    crit: notable
    conf: 0.7
    for: [php]
    if:
      type: string
      substr: "exec("

  - id: php-shell-exec
    desc: PHP shell_exec() function call
    crit: notable
    conf: 0.7
    for: [php]
    if:
      type: string
      substr: "shell_exec("

  - id: php-get
    desc: PHP $_GET parameter access
    crit: inert
    conf: 0.4
    for: [php]
    if:
      type: string
      substr: "$_GET["

  - id: php-post
    desc: PHP $_POST parameter access
    crit: inert
    conf: 0.4
    for: [php]
    if:
      type: string
      substr: "$_POST["

  - id: php-request
    desc: PHP $_REQUEST parameter access
    crit: inert
    conf: 0.4
    for: [php]
    if:
      type: string
      substr: "$_REQUEST["

  # === JSP webshell atomic indicators ===
  - id: jsp-runtime
    desc: Java Runtime.getRuntime() call
    crit: notable
    conf: 0.6
    for: [java]
    if:
      type: string
      substr: "Runtime.getRuntime()"

  - id: jsp-exec
    desc: Java .exec() method call
    crit: notable
    conf: 0.5
    for: [java]
    if:
      type: string
      substr: ".exec("

  - id: jsp-get-param
    desc: JSP request.getParameter call
    crit: inert
    conf: 0.4
    for: [java]
    if:
      type: string
      substr: "request.getParameter"

  # === Generic webshell identifiers ===
  - id: identifier
    desc: Webshell-related terminology
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: '\bwebshell\b'
      case_insensitive: true

  # === Known webshell families ===
  - id: c99shell
    desc: c99shell webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '\bc99shell\b'
      case_insensitive: true

  - id: r57shell
    desc: r57shell webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '\br57shell\b'
      case_insensitive: true

  - id: b374k
    desc: b374k webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '\bb374k\b'
      case_insensitive: true

  - id: phpspy
    desc: phpspy webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '\bphpspy\b'
      case_insensitive: true

  - id: wso-shell
    desc: WSO Shell webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: "WSO Shell"

  - id: wso-version
    desc: WSO webshell version marker
    crit: suspicious
    conf: 0.98
    if:
      type: string
      substr: "WSO_VERSION"

  - id: filesman
    desc: FilesMan webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: FilesMan

  - id: china-chopper
    desc: China Chopper webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: "China Chopper"

  - id: weevely
    desc: weevely webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: weevely

  - id: indoxploit
    desc: IndoXploit webshell family
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: '\bIndoXploit\b'
      case_insensitive: true

composite_rules:
  # PHP webshell patterns (php tag + shell func + request param)
  - id: php-shell
    desc: PHP webshell implementation patterns
    crit: suspicious
    conf: 0.9
    all:
      - id: php-tag
    any:
      - id: php-system
      - id: php-exec
      - id: php-shell-exec
      - id: php-get
      - id: php-post
      - id: php-request

    needs: 1
  # JSP webshell patterns
  - id: jsp-shell
    desc: JSP webshell implementation patterns
    crit: suspicious
    conf: 0.9
    all:
      - id: jsp-runtime
      - id: jsp-exec
      - id: jsp-get-param

  # Known webshell family
  - id: specific-family
    desc: Known webshell family identifier
    crit: notable
    conf: 0.9
    needs: 1
    any:
      - id: c99shell
      - id: r57shell
      - id: b374k
      - id: phpspy
      - id: wso-shell
      - id: wso-version
      - id: filesman
      - id: china-chopper
      - id: weevely
      - id: indoxploit

  # Family identified with generic terminology
  - id: family-identified
    desc: Webshell family identified with generic
    crit: suspicious
    conf: 0.85
    all:
      - id: identifier
      - id: obj/c2/webshell/specific-family

  # Webshell detection
  - id: detected
    desc: Webshell implementation detected
    crit: suspicious
    conf: 0.95
    any:
      - id: obj/c2/webshell/php-shell
      - id: obj/c2/webshell/jsp-shell
      - id: obj/c2/webshell/family-identified
