# AppleScript Privilege Escalation Detection
# Detects attempts to gain admin privileges via AppleScript
# ATT&CK: T1548.004 (Abuse Elevation Control Mechanism)

defaults:
  # osascript can be invoked from any language: python subprocess, ruby system(), etc.
  file_types: [applescript, shell, python, ruby, perl, javascript, elf, macho]
  platforms: [macos]
  attack: "T1548.004"

traits:
  # ============================================
  # Admin Privilege Requests
  # ============================================
  - id: admin-privileges
    description: "Requests administrator privileges"
    crit: suspicious
    confidence: 0.9
    condition:
      type: string
      exact: "administrator privileges"

  - id: with-admin-privileges
    description: "do shell script with admin privileges"
    crit: suspicious
    confidence: 0.9
    condition:
      type: string
      exact: "with administrator privileges"

  # ============================================
  # Sudo/Root Patterns
  # ============================================
  - id: sudo-in-script
    description: "Uses sudo in shell script"
    crit: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "do shell script.{0,100}sudo"

  - id: run-as-root
    description: "Attempts to run as root"
    crit: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "(?i)run.{0,30}as.{0,30}root"

composite_rules:
  # ============================================
  # Admin Privilege Escalation
  # ============================================
  - id: admin-privesc
    description: "AppleScript admin privilege escalation"
    crit: suspicious
    confidence: 0.9
    requires_any:
      - {id: admin-privileges}
      - {id: with-admin-privileges}

  # ============================================
  # Shell with Admin Privileges
  # ============================================
  - id: shell-admin
    description: "Shell execution with admin privileges"
    crit: suspicious
    confidence: 0.9
    requires_all:
      - {id: evasion/applescript/do-shell-script}
      - {id: with-admin-privileges}
