# Apple Code Signature Detection

defaults:
  platforms: [macos]
  for: [macho]

traits:
  # === Apple signature atomic indicators ===
  - id: apple-development
    desc: Apple Development certificate
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "Apple Development"

  - id: apple-distribution
    desc: Apple Distribution certificate
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "Apple Distribution"

  - id: developer-id
    desc: Developer ID certificate
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "Developer ID"

  # === Codesign requirement atomic indicators ===
  - id: anchor-apple
    desc: anchor apple requirement
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "anchor apple"

  - id: certificate-leaf
    desc: certificate leaf requirement
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "certificate leaf"

  # === Signature Type (parsed from code signature blob) ===
  - id: as/adhoc
    desc: Ad-hoc code signature
    crit: notable
    conf: 1.0
    if:
      type: trait
      id: meta/signed/as/adhoc

  - id: as/developer-id
    desc: Developer ID signed application
    crit: inert
    conf: 1.0
    if:
      type: trait
      id: meta/signed/as/developer-id

  - id: as/platform
    desc: Apple platform binary
    crit: inert
    conf: 1.0
    if:
      type: trait
      id: meta/signed/as/platform

  - id: as/app-store
    desc: Mac App Store signed application
    crit: inert
    conf: 1.0
    if:
      type: trait
      id: meta/signed/as/app-store

  - id: as/unknown
    desc: Unknown signature type
    crit: inert
    conf: 1.0
    if:
      type: trait
      id: meta/signed/as/unknown

  # === Hardened Runtime ===
  - id: hardened-runtime
    desc: Hardened runtime enabled
    crit: inert
    conf: 1.0
    if:
      type: trait
      id: meta/hardened-runtime

composite_rules:
  - id: signed
    desc: Apple code signature markers
    crit: inert
    conf: 0.85
    needs: 1
    any:
      - id: apple-development
      - id: apple-distribution
      - id: developer-id

  - id: codesign-requirement
    desc: Code signature requirement blob
    crit: inert
    conf: 0.9
    needs: 1
    any:
      - id: anchor-apple
      - id: certificate-leaf
