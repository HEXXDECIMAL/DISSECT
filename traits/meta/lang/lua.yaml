# Lua Programming Language Traits
# Detects common Lua patterns, capabilities, and obfuscation techniques

defaults:
  for: [lua]
  crit: notable

traits:
  # === Environment and Context manipulation ===
  - id: env-access
    desc: Lua environment access (_ENV)
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: "_ENV|getfenv"

  - id: env-modify
    desc: Modifies Lua environment (setfenv)
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: "setfenv"

  # === Code Loading and Execution ===
  - id: exec-dynamic-load
    desc: Dynamic code loading (load, loadstring)
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: "load|loadstring"

  - id: exec-file-execution
    desc: Executes Lua files (dofile)
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: "dofile"

  - id: module-require
    desc: Loads Lua modules (require)
    crit: notable
    conf: 0.8
    if:
      type: symbol
      regex: "require"

  # === System and OS Interaction ===
  - id: os-system-execute
    desc: Executes system commands (os.execute, io.popen)
    crit: suspicious
    conf: 0.95
    if:
      type: symbol
      regex: 'os\.execute|io\.popen'

  - id: os-file-manipulation
    desc: Manipulates files (os.rename, os.remove)
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: 'os\.rename|os\.remove'

  # === Metatable and Proxy patterns ===
  - id: meta-metatable-access
    desc: Uses metatables (setmetatable, getmetatable)
    crit: notable
    conf: 0.7
    if:
      type: symbol
      regex: "setmetatable|getmetatable"

  - id: meta-proxy-usage
    desc: Uses newproxy for object protection
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: "newproxy"

  # === Debug and Reflection ===
  - id: debug-access
    desc: Uses Lua debug module
    crit: notable
    conf: 0.9
    if:
      type: symbol
      regex: 'debug\.'

  # === Obfuscation Patterns ===
  - id: base64-decoder-custom
    desc: Custom Base64 alphabet mapping
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: '\["\+"\]\s*=\s*\d+[,;]'

  - id: bytecode-interpreter
    desc: Lua bytecode interpreter loop
    crit: suspicious
    conf: 0.85
    if:
      type: raw
      regex: 'while\s+g\s+do\s+if\s+g\s*<'

composite_rules:
  - id: lua-obfuscated-script
    desc: Obfuscated Lua script with dynamic execution
    crit: suspicious
    conf: 0.9
    all:
      - id: obj/anti-static/obfuscation/encoding::xor-string
    any:
      - id: base64-decoder-custom
      - id: bytecode-interpreter
      - id: env-access
      - id: exec-dynamic-load

  - id: lua-hostile-loader
    desc: Hostile Lua loader/dropper
    crit: hostile
    conf: 0.9
    all:
      - id: lua-obfuscated-script
    any:
      - id: os-system-execute
      - id: exec-file-execution
      - id: debug-access
