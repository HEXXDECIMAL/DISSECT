# Go Language Malware Patterns
# Patterns commonly seen in Go-based malware vs legitimate Go programs

defaults:
  for: [elf, macho, pe, go]

traits:
  # === Browser credential harvesting ===
  - id: chrome-string
    desc: Chrome browser string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "Chrome"

  - id: firefox-string
    desc: Firefox browser string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "Firefox"

  - id: go-sqlite3
    desc: go-sqlite3 library import
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "go-sqlite3"

  # === Windows credential decryption ===
  - id: crypt-unprotect-data
    desc: CryptUnprotectData Windows API
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "CryptUnprotectData"

  # === Environment variable access ===
  - id: os-getenv
    desc: os.Getenv function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "os.Getenv"

  - id: aws-access-string
    desc: AWS_ACCESS environment variable
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "AWS_ACCESS"

  - id: aws-secret-string
    desc: AWS_SECRET environment variable
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "AWS_SECRET"

  # === Process injection - ptrace ===
  - id: syscall-ptrace-attach
    desc: syscall.PtraceAttach function
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "syscall.PtraceAttach"

  - id: syscall-ptrace-cont
    desc: syscall.PtraceCont function
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "syscall.PtraceCont"

  # Removed duplicates - use obj/defense-evasion/process/injection/memory::ptrace-poketext and ::process-vm-writev

  - id: proc-mem-glob
    desc: /proc/*/mem file pattern
    crit: inert
    conf: 0.8
    if:
      type: string
      substr: "/proc/*/mem"

  # === Process injection - Windows DLL ===
  - id: create-remote-thread
    desc: CreateRemoteThread Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "CreateRemoteThread"

  # Removed virtual-alloc-ex duplicate - use cap/mem/protect/traits::virtual-alloc-ex (same pattern, canonical location)

  # === Keylogger - Windows hooks ===
  - id: set-windows-hook-ex
    desc: SetWindowsHookEx Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "SetWindowsHookEx"

  # Removed duplicate - use obj/creds/keylog/capture::windows-asynckey (or cap if available)

  - id: get-key-state
    desc: GetKeyState Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "GetKeyState"

  # === Keylogger - X11 ===
  - id: x-query-keymap
    desc: XQueryKeymap X11 function
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "XQueryKeymap"

  - id: x-open-display
    desc: XOpenDisplay X11 function
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "XOpenDisplay"

  # === Keylogger - Linux input ===
  - id: dev-input-path
    desc: /dev/input device path
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "/dev/input"

  - id: evdev-string
    desc: evdev Linux input driver
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "evdev"

  # === Anti-analysis - VM detection ===
  # Removed vmware-string duplicate - use obj/anti-analysis/vm/detect::vendor-vmware
  # Removed virtualbox-string duplicate - use obj/anti-analysis/emulator/detect::virtualbox-string
  # Removed qemu-string duplicate - use obj/anti-analysis/emulator/detect::qemu-string

  # === Anti-analysis - debugger detection ===
  # Removed duplicate - use obj/exec/native/api::debugger-detect-api
  # Removed proc-self-status duplicate - use cap/fs/proc/info/linux::process-self-status

  - id: tracer-pid
    desc: TracerPid debugger detection field
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "TracerPid"

  # === Anti-analysis - timing ===
  - id: time-sleep
    desc: time.Sleep function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "time.Sleep"

  - id: time-now
    desc: time.Now function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "time.Now"

  # === C2 beacon - HTTP ===
  - id: net-http-import
    desc: net/http package import
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "net/http"

  - id: http-client
    desc: http.Client type
    crit: inert
    conf: 0.6
    if:
      type: symbol
      exact: "http.Client"

  # === C2 beacon - timing ===
  - id: time-ticker
    desc: time.Ticker type
    crit: inert
    conf: 0.6
    if:
      type: symbol
      exact: "time.Ticker"

  # === C2 beacon - encoding ===
  - id: encoding-base64-import
    desc: encoding/base64 package import
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "encoding/base64"

  - id: encoding-json-import
    desc: encoding/json package import
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "encoding/json"

composite_rules:
  # === Helper composites ===
  - id: browser-strings
    desc: Browser name strings
    any:
      - { id: chrome-string }
      - { id: firefox-string }
      - { id: cap/fs/path/sensitive/browser::login-data }
      - { id: obj/creds/browser/firefox::cookies }

  - id: aws-env-vars
    desc: AWS environment variable names
    any:
      - { id: aws-access-string }
      - { id: aws-secret-string }

  - id: ptrace-functions
    desc: Ptrace system call functions
    any:
      - { id: syscall-ptrace-attach }
      - { id: syscall-ptrace-cont }
      - { id: obj/defense-evasion/process/injection/memory::ptrace-poketext }

  - id: memory-write-funcs
    desc: Memory write functions
    any:
      - { id: obj/defense-evasion/process/injection/memory::process-vm-writev }
      - { id: proc-mem-glob }

  - id: dll-injection-funcs
    desc: DLL injection Windows APIs
    all:
      - { id: obj/defense-evasion/process/injection/code::create-remote-thread }
      - { id: cap/mem/protect/traits::virtual-alloc-ex }

  - id: windows-hook-funcs
    desc: Windows keyboard hook functions
    any:
      - { id: set-windows-hook-ex }
      - { id: obj/creds/keylog/capture::windows-asynckey }
      - { id: get-key-state }

  - id: x11-keylog-funcs
    desc: X11 keylogging functions
    # NOTE: These functions are core X11 APIs. Only flag as keylogging
    # if they appear in a non-X11 library context (i.e., an application
    # importing them, not libX11 itself exporting them)
    for: [elf, macho, pe]
    all:
      - { id: x-query-keymap }
      - { id: x-open-display }
    unless:
      # Exclude X11 libraries themselves - they legitimately export these functions
      - type: raw
        regex: "^lib(X11|xcb|Xext|Xt|Xmu|Xi|Xrandr|Xrender|Xfixes|Xcomposite|Xdamage|Xinput|Xinerama|Xss|Xkb)\\b"
      - type: string
        regex: "X11R[0-9]|xenocara|xorg"

  - id: linux-input-keylog
    desc: Linux input device keylogging
    all:
      - { id: dev-input-path }
      - { id: evdev-string }

  - id: vm-strings
    desc: VM detection strings
    any:
      - { id: obj/anti-analysis/vm/detect::vendor-vmware }
      - { id: obj/anti-analysis/emulator/detect::virtualbox-string }
      - { id: obj/anti-analysis/emulator/detect::qemu-string }

  - id: debugger-detection
    desc: Debugger detection patterns
    any:
      - { id: obj/exec/native/api::debugger-detect-api }
      - { id: cap/fs/proc/info/linux::process-self-status }
      - { id: tracer-pid }

  - id: timing-funcs
    desc: Time-based functions
    all:
      - { id: time-sleep }
      - { id: time-now }

  - id: http-client-funcs
    desc: HTTP client functions
    any:
      - { id: net-http-import }
      - { id: http-client }

  - id: interval-funcs
    desc: Periodic execution functions
    any:
      - { id: time-ticker }
      - { id: time-sleep }

  - id: encoding-imports
    desc: Encoding package imports
    any:
      - { id: encoding-base64-import }
      - { id: encoding-json-import }

  - id: http-customization
    desc: HTTP request customization
    any:
      - { id: cap/comm/http/request::user-agent-header }
      - { id: encoding-imports }

  # === Browser credential harvesting ===
  - id: browser-cred-harvest
    desc: Browser credential database harvesting
    crit: suspicious
    conf: 0.85
    all:
      - { id: browser-strings, needs: 2 }
      - { id: go-sqlite3 }

  # === AWS credential harvesting ===
  - id: aws-cred-harvest
    desc: AWS credential environment variable harvesting
    crit: suspicious
    conf: 0.85
    all:
      - { id: os-getenv }
      - { id: aws-env-vars }

  # === Migrated from YARA ===
  - id: credential-harvest
    desc: Go credential harvesting patterns
    crit: suspicious
    conf: 0.85
    any:
      - { id: browser-cred-harvest }
      - { id: crypt-unprotect-data }
      - { id: aws-cred-harvest }

  - id: process-inject
    desc: Go process injection patterns
    crit: notable
    conf: 0.85
    size_max: 2097152
    any:
      - { id: ptrace-functions }
      - { id: memory-write-funcs }
      - { id: dll-injection-funcs }

  - id: keylogger
    desc: Go keylogger implementation patterns
    crit: suspicious
    conf: 0.85
    for: [go]
    size_max: 500000
    any:
      - { id: windows-hook-funcs }
      - { id: x11-keylog-funcs }
      - { id: linux-input-keylog }

  # Helper: timing + vm-strings combo
  - id: timing-vm-combo
    desc: Timing functions with VM strings
    all:
      - { id: timing-funcs }
      - { id: vm-strings }

  - id: anti-analysis
    desc: Go anti-analysis and evasion patterns
    crit: suspicious
    conf: 0.8
    for: [go]
    any:
      - { id: vm-strings }
      - { id: debugger-detection }
      - { id: timing-vm-combo }

  - id: c2-beacon
    desc: Go C2 beacon/implant patterns
    crit: suspicious
    conf: 0.8
    all:
      - { id: http-client-funcs }
      - { id: interval-funcs }
      - { id: http-customization }
