# Go Language Malware Patterns
# Patterns commonly seen in Go-based malware vs legitimate Go programs

defaults:
  for: [elf, macho, pe, go]

traits:
  # === Browser credential harvesting ===
  - id: chrome-string
    desc: Chrome browser string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "Chrome"

  - id: firefox-string
    desc: Firefox browser string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "Firefox"

  - id: go-sqlite3
    desc: go-sqlite3 library import
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "go-sqlite3"

  # === Windows credential decryption ===
  - id: crypt-unprotect-data
    desc: CryptUnprotectData Windows API
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "CryptUnprotectData"

  # === Environment variable access ===
  - id: os-getenv
    desc: os.Getenv function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "os.Getenv"

  - id: aws-access-string
    desc: AWS_ACCESS environment variable
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "AWS_ACCESS"

  - id: aws-secret-string
    desc: AWS_SECRET environment variable
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "AWS_SECRET"

  # === Process injection - ptrace ===
  - id: syscall-ptrace-attach
    desc: syscall.PtraceAttach function
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "syscall.PtraceAttach"

  - id: syscall-ptrace-cont
    desc: syscall.PtraceCont function
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "syscall.PtraceCont"

  - id: ptrace-poketext
    desc: PTRACE_POKETEXT constant
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "PTRACE_POKETEXT"

  # === Process injection - memory write ===
  - id: process-vm-writev
    desc: process_vm_writev syscall
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "process_vm_writev"

  - id: proc-mem-glob
    desc: /proc/*/mem file pattern
    crit: inert
    conf: 0.8
    if:
      type: string
      exact: "/proc/*/mem"

  # === Process injection - Windows DLL ===
  - id: create-remote-thread
    desc: CreateRemoteThread Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "CreateRemoteThread"

  - id: virtual-alloc-ex
    desc: VirtualAllocEx Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "VirtualAllocEx"

  # === Keylogger - Windows hooks ===
  - id: set-windows-hook-ex
    desc: SetWindowsHookEx Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "SetWindowsHookEx"

  - id: get-async-key-state
    desc: GetAsyncKeyState Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "GetAsyncKeyState"

  - id: get-key-state
    desc: GetKeyState Windows API
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "GetKeyState"

  # === Keylogger - X11 ===
  - id: x-query-keymap
    desc: XQueryKeymap X11 function
    crit: inert
    conf: 0.8
    if:
      type: symbol
      exact: "XQueryKeymap"

  - id: x-open-display
    desc: XOpenDisplay X11 function
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "XOpenDisplay"

  # === Keylogger - Linux input ===
  - id: dev-input-path
    desc: /dev/input device path
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "/dev/input"

  - id: evdev-string
    desc: evdev Linux input driver
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "evdev"

  # === Anti-analysis - VM detection ===
  - id: vmware-string
    desc: VMware VM detection string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "VMware"

  - id: virtualbox-string
    desc: VirtualBox VM detection string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "VirtualBox"

  - id: qemu-string
    desc: QEMU VM detection string
    crit: inert
    conf: 0.6
    if:
      type: string
      word: "QEMU"

  # === Anti-analysis - debugger detection ===
  - id: is-debugger-present
    desc: IsDebuggerPresent Windows API
    crit: inert
    conf: 0.75
    if:
      type: symbol
      exact: "IsDebuggerPresent"

  - id: proc-self-status
    desc: /proc/self/status file path
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/proc/self/status"

  - id: tracer-pid
    desc: TracerPid debugger detection field
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "TracerPid"

  # === Anti-analysis - timing ===
  - id: time-sleep
    desc: time.Sleep function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "time.Sleep"

  - id: time-now
    desc: time.Now function
    crit: inert
    conf: 0.5
    if:
      type: symbol
      exact: "time.Now"

  # === C2 beacon - HTTP ===
  - id: net-http-import
    desc: net/http package import
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "net/http"

  - id: http-client
    desc: http.Client type
    crit: inert
    conf: 0.6
    if:
      type: symbol
      exact: "http.Client"

  # === C2 beacon - timing ===
  - id: time-ticker
    desc: time.Ticker type
    crit: inert
    conf: 0.6
    if:
      type: symbol
      exact: "time.Ticker"

  # === C2 beacon - HTTP headers ===
  - id: user-agent-header
    desc: User-Agent HTTP header
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "User-Agent"

  # === C2 beacon - encoding ===
  - id: encoding-base64-import
    desc: encoding/base64 package import
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "encoding/base64"

  - id: encoding-json-import
    desc: encoding/json package import
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "encoding/json"

  # === C2 beacon - command execution ===
  - id: exec-command
    desc: exec.Command function
    crit: inert
    conf: 0.6
    if:
      type: symbol
      exact: "exec.Command"

composite_rules:
  # === Helper composites ===
  - id: browser-strings
    desc: Browser name strings
    any:
      - { id: chrome-string }
      - { id: firefox-string }
      - { id: obj/creds/browser/chromium/login-data }
      - { id: obj/creds/browser/firefox/cookies-sqlite }

  - id: aws-env-vars
    desc: AWS environment variable names
    any:
      - { id: aws-access-string }
      - { id: aws-secret-string }

  - id: ptrace-functions
    desc: Ptrace system call functions
    any:
      - { id: syscall-ptrace-attach }
      - { id: syscall-ptrace-cont }
      - { id: ptrace-poketext }

  - id: memory-write-funcs
    desc: Memory write functions
    any:
      - { id: process-vm-writev }
      - { id: proc-mem-glob }

  - id: dll-injection-funcs
    desc: DLL injection Windows APIs
    all:
      - { id: create-remote-thread }
      - { id: virtual-alloc-ex }

  - id: windows-hook-funcs
    desc: Windows keyboard hook functions
    any:
      - { id: set-windows-hook-ex }
      - { id: get-async-key-state }
      - { id: get-key-state }

  - id: x11-keylog-funcs
    desc: X11 keylogging functions
    all:
      - { id: x-query-keymap }
      - { id: x-open-display }

  - id: linux-input-keylog
    desc: Linux input device keylogging
    all:
      - { id: dev-input-path }
      - { id: evdev-string }

  - id: vm-strings
    desc: VM detection strings
    any:
      - { id: vmware-string }
      - { id: virtualbox-string }
      - { id: qemu-string }

  - id: debugger-detection
    desc: Debugger detection patterns
    any:
      - { id: is-debugger-present }
      - { id: proc-self-status }
      - { id: tracer-pid }

  - id: timing-funcs
    desc: Time-based functions
    all:
      - { id: time-sleep }
      - { id: time-now }

  - id: http-client-funcs
    desc: HTTP client functions
    any:
      - { id: net-http-import }
      - { id: http-client }

  - id: interval-funcs
    desc: Periodic execution functions
    any:
      - { id: time-ticker }
      - { id: time-sleep }

  - id: encoding-imports
    desc: Encoding package imports
    any:
      - { id: encoding-base64-import }
      - { id: encoding-json-import }

  - id: http-customization
    desc: HTTP request customization
    any:
      - { id: user-agent-header }
      - { id: encoding-imports }

  # === Browser credential harvesting ===
  - id: browser-cred-harvest
    desc: Browser credential database harvesting
    crit: suspicious
    conf: 0.85
    all:
      - { id: browser-strings, count_min: 2 }
      - { id: go-sqlite3 }

  # === AWS credential harvesting ===
  - id: aws-cred-harvest
    desc: AWS credential environment variable harvesting
    crit: suspicious
    conf: 0.85
    all:
      - { id: os-getenv }
      - { id: aws-env-vars }

  # === Migrated from YARA ===
  - id: credential-harvest
    desc: Go credential harvesting patterns
    crit: suspicious
    conf: 0.85
    any:
      - { id: browser-cred-harvest }
      - { id: crypt-unprotect-data }
      - { id: aws-cred-harvest }

  - id: process-inject
    desc: Go process injection patterns
    crit: suspicious
    conf: 0.85
    any:
      - { id: ptrace-functions }
      - { id: memory-write-funcs }
      - { id: dll-injection-funcs }

  - id: keylogger
    desc: Go keylogger implementation patterns
    crit: suspicious
    conf: 0.85
    any:
      - { id: windows-hook-funcs }
      - { id: x11-keylog-funcs }
      - { id: linux-input-keylog }

  # Helper: timing + vm-strings combo
  - id: timing-vm-combo
    desc: Timing functions with VM strings
    all:
      - { id: timing-funcs }
      - { id: vm-strings }

  - id: anti-analysis
    desc: Go anti-analysis and evasion patterns
    crit: suspicious
    conf: 0.8
    any:
      - { id: vm-strings }
      - { id: debugger-detection }
      - { id: timing-vm-combo }

  - id: c2-beacon
    desc: Go C2 beacon/implant patterns
    crit: suspicious
    conf: 0.8
    all:
      - { id: http-client-funcs }
      - { id: interval-funcs }
      - { id: http-customization }
      - { id: exec-command }
