# File format magic byte detection at file start (offset 0)
#
# These traits detect file format signatures at the expected location.
# Using offset: 0 or 
# file formats, not embedded content or coincidental byte patterns.

traits:
  # Binary executable formats
  - id: elf-header
    desc: ELF binary magic at file start
    crit: inert
    conf: 1.0
    for: [elf, all]
    if:
      type: hex
      pattern: "7F 45 4C 46" # \x7fELF
      offset: 0

  - id: macho-32
    desc: Mach-O 32-bit magic at file start
    crit: inert
    conf: 1.0
    for: [macho, all]
    if:
      type: hex
      pattern: "CE FA ED FE" # feedface (little-endian)
      offset: 0

  - id: macho-64
    desc: Mach-O 64-bit magic at file start
    crit: inert
    conf: 1.0
    for: [macho, all]
    if:
      type: hex
      pattern: "CF FA ED FE" # feedfacf (little-endian)
      offset: 0

  # NOTE: CAFEBABE is used for both Mach-O fat binaries and Java class files.
  # This ambiguity is handled by file type detection; this trait just notes the magic.
  - id: cafebabe-magic
    desc: "CAFEBABE magic (Mach-O fat binary or"
    crit: inert
    conf: 1.0
    for: [macho, class, all]
    if:
      type: hex
      pattern: "CA FE BA BE"
      offset: 0

  - id: pe-dos-stub
    desc: PE/DOS MZ header at file start
    crit: inert
    conf: 1.0
    for: [pe, dll, all]
    if:
      type: hex
      pattern: "4D 5A" # MZ
      offset: 0

  # Archive formats
  - id: zip-archive
    desc: ZIP archive magic at file start
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "50 4B 03 04" # PK..
      offset: 0

  - id: zip-empty
    desc: Empty ZIP archive magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "50 4B 05 06" # PK..
      offset: 0

  - id: gzip
    desc: GZIP compressed file magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "1F 8B 08" # gzip magic + deflate
      offset: 0

  - id: bzip2
    desc: BZIP2 compressed file magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "42 5A 68" # BZh
      offset: 0

  - id: xz
    desc: XZ compressed file magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "FD 37 7A 58 5A 00" # XZ magic
      offset: 0

  - id: 7z
    desc: 7-Zip archive magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "37 7A BC AF 27 1C" # 7z magic
      offset: 0

  - id: rar-v4
    desc: RAR v4 archive magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "52 61 72 21 1A 07 00" # Rar!...
      offset: 0

  - id: rar-v5
    desc: RAR v5 archive magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "52 61 72 21 1A 07 01 00" # Rar!....
      offset: 0

  - id: tar-ustar
    desc: USTAR tar archive magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "75 73 74 61 72" # ustar
      offset: 257 # USTAR magic is at offset 257

  - id: ar-archive
    desc: AR archive magic (static libraries, .deb)
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: raw
      exact: "!<arch>\n"
      offset: 0

  - id: rpm-package
    desc: RPM package magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "ED AB EE DB"
      offset: 0

  - id: bplist
    desc: Binary Plist magic at file start
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "62 70 6C 69 73 74 30 30" # bplist00
      offset: 0

  # Document/data formats
  - id: pdf
    desc: PDF document magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: raw
      substr: "%PDF-"
      

  - id: sqlite3
    desc: SQLite3 database magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: raw
      exact: "SQLite format 3\x00"
      offset: 0

  # Image formats (useful for polyglot detection)
  - id: png
    desc: PNG image magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "89 50 4E 47 0D 0A 1A 0A"
      offset: 0

  - id: jpeg
    desc: JPEG image magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "FF D8 FF"
      offset: 0

  - id: gif
    desc: GIF image magic
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: raw
      regex: "^GIF8[79]a"
      offset: 0

  # Text encoding BOMs
  - id: utf8-bom
    desc: UTF-8 byte order mark
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "EF BB BF"
      offset: 0

  - id: utf16-le-bom
    desc: UTF-16 little-endian BOM
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "FF FE"
      offset: 0

  - id: utf16-be-bom
    desc: UTF-16 big-endian BOM
    crit: inert
    conf: 1.0
    for: [all]
    if:
      type: hex
      pattern: "FE FF"
      offset: 0

  # Suspicious: executable magic NOT at file start (embedded payload)
  # These complement cap/data/embedded but use the new offset constraint syntax
  - id: embedded-elf
    desc: ELF magic found past file header
    crit: inert
    conf: 0.85
    for: [all]
    if:
      type: hex
      pattern: "7F 45 4C 46"
      

  - id: embedded-pe
    desc: MZ/PE magic found past file header
    crit: suspicious
    conf: 0.85
    for: [elf, macho, shell, python, javascript] # Suspicious only for non-PE file types
    if:
      type: hex
      pattern: "4D 5A [2-4096] 50 45 00 00"
      

  - id: embedded-pe-in-pe
    desc: Embedded PE resource in executable
    crit: notable # Common for PE files with resources
    conf: 0.7
    for: [pe, dll]
    if:
      type: hex
      pattern: "4D 5A"
      

  - id: embedded-zip
    desc: ZIP magic found past file header
    crit: notable
    conf: 0.8
    for: [elf, macho, pe] # Only flag in executables
    if:
      type: hex
      pattern: "50 4B 03 04"
      
