# Filesystem Capabilities
# Covers file operations, directory manipulation, permissions, etc.

simple_rules:
  # File reading
  - symbol: open
    capability: fs/read
    description: Open files for reading
    confidence: 0.6

  - symbol: fopen
    capability: fs/read
    description: Open files for reading (stdio)
    confidence: 0.6

  - symbol: read
    capability: fs/read
    description: Read file data
    confidence: 0.6

  - symbol: fread
    capability: fs/read
    description: Read file data (stdio)
    confidence: 0.6

  # File writing
  - symbol: write
    capability: fs/write
    description: Write file data
    confidence: 0.6

  - symbol: fwrite
    capability: fs/write
    description: Write file data (stdio)
    confidence: 0.6

  - symbol: creat
    capability: fs/write
    description: Create files
    confidence: 0.8

  # File deletion
  - symbol: unlink
    capability: fs/delete
    description: Delete files
    confidence: 0.9

  - symbol: remove
    capability: fs/delete
    description: Delete files
    confidence: 0.9

  - symbol: rmdir
    capability: fs/delete
    description: Delete directories
    confidence: 0.9

  # Permissions
  - symbol: chmod
    capability: fs/permissions/modify
    description: Change file permissions
    confidence: 0.8

  - symbol: fchmod
    capability: fs/permissions/modify
    description: Change file permissions
    confidence: 0.8

  - symbol: chown
    capability: fs/permissions/modify
    description: Change file ownership
    confidence: 0.8

  - symbol: fchown
    capability: fs/permissions/modify
    description: Change file ownership
    confidence: 0.8

  # Directory operations
  - symbol: mkdir
    capability: fs/directory/create
    description: Create directories
    confidence: 0.8

  - symbol: opendir
    capability: fs/directory/read
    description: Open directories
    confidence: 0.7

  - symbol: readdir
    capability: fs/directory/read
    description: Read directory contents
    confidence: 0.7

  # File metadata
  - symbol: stat
    capability: fs/metadata/read
    description: Get file metadata
    confidence: 0.5

  - symbol: lstat
    capability: fs/metadata/read
    description: Get file metadata (no symlink follow)
    confidence: 0.5

  - symbol: fstat
    capability: fs/metadata/read
    description: Get file metadata
    confidence: 0.5

composite_rules:
  # Ransomware file encryption
  - capability: fs/ransomware/encrypt-files
    description: Encrypt files across filesystem
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Directory traversal
      - type: symbol_or_string
        any:
          - opendir
          - readdir
          - FindFirstFile
          - FindNextFile
          - NSFileManager

      # File reading
      - type: symbol
        pattern: 'fopen|open|fread|read|ReadFile'

      # File writing
      - type: symbol
        pattern: 'fwrite|write|WriteFile'

      # Encryption
      - type: symbol_or_string
        any:
          - AES_encrypt
          - CCCrypt
          - CryptEncrypt
          - EVP_Encrypt

  # Mass file deletion (wiper malware)
  - capability: fs/wiper/mass-delete
    description: Mass file deletion behavior
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Directory iteration
      - type: symbol_or_string
        any:
          - readdir
          - FindNextFile

      # File deletion
      - type: symbol
        pattern: 'unlink|remove|DeleteFile'

      # No ransom note (wiper vs ransomware)
      - type: string
        regex: '(ransom|decrypt|payment|bitcoin)'
        case_insensitive: true
        min_count: 0

  # Hidden file creation
  - capability: fs/stealth/hidden-files
    description: Create hidden files
    confidence: 0.8
    platforms: [all]

    requires_any:
      # Unix hidden files (dot prefix)
      - type: string
        regex: '/\.[a-zA-Z0-9_-]+'

      # Windows hidden attribute
      - type: symbol_or_string
        any:
          - SetFileAttributes
          - FILE_ATTRIBUTE_HIDDEN

      # macOS hidden attribute
      - type: string
        regex: 'chflags.*hidden'

  # System file modification
  - capability: fs/system/modify-critical
    description: Modify critical system files
    confidence: 0.95
    platforms: [all]

    requires_count: 2
    conditions:
      # Critical Unix files
      - type: string
        regex: '(/etc/passwd|/etc/shadow|/etc/sudoers|/etc/hosts)'

      # Critical Windows files
      - type: string
        regex: '(system32|windows\\system|boot\.ini|ntldr)'
        case_insensitive: true

      # Critical macOS files
      - type: string
        regex: '(/System/Library|/private/etc|/Library/LaunchDaemons)'

      # File write capability
      - type: symbol
        pattern: 'fwrite|write|WriteFile'

  # Log file deletion
  - capability: fs/anti-forensics/delete-logs
    description: Delete log files to evade forensics
    confidence: 0.85
    platforms: [all]

    requires_all:
      # Log file paths
      - type: string
        regex: '(\.log|/var/log|syslog|auth\.log|EventLog)'
        case_insensitive: true

      # File deletion
      - type: symbol
        pattern: 'unlink|remove|DeleteFile'

  # Timestomping
  - capability: fs/anti-forensics/timestamp-manipulation
    description: Manipulate file timestamps (timestomping)
    confidence: 0.9
    platforms: [all]

    requires_any:
      # Unix timestamp functions
      - type: symbol_or_string
        any:
          - utime
          - utimes
          - futimes
          - utimensat

      # Windows timestamp functions
      - type: symbol
        pattern: 'SetFileTime'

      # macOS/BSD
      - type: symbol
        pattern: 'setattrlist'

  # File exfiltration staging
  - capability: fs/exfil/staging
    description: Stage files for exfiltration
    confidence: 0.8
    platforms: [all]

    requires_all:
      # Temporary directory usage
      - type: symbol_or_string
        any:
          - mkdtemp
          - tmpfile
          - '/tmp'
          - GetTempPath
          - NSTemporaryDirectory

      # File copying/archiving
      - type: symbol_or_string
        any:
          - fread
          - fwrite
          - CopyFile
          - archive
          - zip
          - tar

      # Network capability (for exfil)
      - type: symbol_or_string
        any:
          - socket
          - connect
          - URLSession
          - WinHttp

  # Recursive directory deletion
  - capability: fs/destruction/recursive-delete
    description: Recursively delete directory trees
    confidence: 0.85
    platforms: [all]

    requires_all:
      # Directory traversal
      - type: symbol
        pattern: 'readdir|FindNextFile'

      # Recursive pattern (function calls itself)
      - type: yara_match
        namespace: fs

      # File deletion
      - type: symbol
        pattern: 'unlink|rmdir|DeleteFile|RemoveDirectory'

  # Configuration file access
  - capability: fs/config/read
    description: Read application configuration files
    confidence: 0.75
    platforms: [all]

    requires_count: 2
    conditions:
      # Config file patterns
      - type: string
        regex: '\.(conf|config|ini|yaml|yml|json|plist|xml)'
        case_insensitive: true

      # Config paths
      - type: string
        regex: '(/etc/|\.config/|AppData|Library/Preferences)'

      # File read
      - type: symbol
        pattern: 'fopen|open|fread|ReadFile'

  # File monitoring/watching
  - capability: fs/monitor/file-watch
    description: Monitor filesystem for changes
    confidence: 0.8
    platforms: [all]

    requires_any:
      # Linux inotify
      - type: symbol_or_string
        any:
          - inotify_init
          - inotify_add_watch

      # macOS FSEvents
      - type: symbol_or_string
        any:
          - FSEventStreamCreate
          - kqueue

      # Windows
      - type: symbol
        pattern: 'ReadDirectoryChangesW'

  # Alternate data streams (Windows ADS)
  - capability: fs/stealth/alternate-data-streams
    description: Use Windows Alternate Data Streams
    confidence: 0.9
    platforms: [windows]
    file_types: [pe, dll]

    requires_all:
      # ADS syntax
      - type: string
        regex: ':[a-zA-Z0-9_]+:' # file.txt:hidden:$DATA

      # File operations
      - type: symbol
        pattern: 'CreateFile|fopen'

  # MBR/bootloader modification
  - capability: fs/bootkit/mbr-modify
    description: Modify Master Boot Record or bootloader
    confidence: 0.95
    platforms: [all]

    requires_count: 2
    conditions:
      # Raw disk access
      - type: string
        regex: '(/dev/[sh]d[a-z]|\\\\\.\\PhysicalDrive)'

      # MBR sector (first 512 bytes)
      - type: string
        regex: '\x55\xAA'

      # Low-level write
      - type: symbol
        pattern: 'write|WriteFile'

  # Secure file wiping
  - capability: fs/anti-forensics/secure-wipe
    description: Securely wipe files (DoD 5220.22-M)
    confidence: 0.85
    platforms: [all]

    requires_all:
      # Random data overwrites
      - type: symbol_or_string
        any:
          - RAND_bytes
          - arc4random
          - /dev/urandom

      # Multiple write passes
      - type: symbol
        pattern: 'fwrite|write|WriteFile'

      # File deletion after wiping
      - type: symbol
        pattern: 'unlink|remove|DeleteFile'

  # Volume shadow copy deletion (Windows ransomware)
  - capability: fs/anti-recovery/shadow-delete
    description: Delete Volume Shadow Copies
    confidence: 0.95
    platforms: [windows]
    file_types: [pe, dll]

    requires_any:
      # vssadmin command
      - type: string
        regex: 'vssadmin.*delete.*shadows'
        case_insensitive: true

      # wmic command
      - type: string
        regex: 'wmic.*shadowcopy.*delete'
        case_insensitive: true

      # COM interface
      - type: symbol_or_string
        any:
          - IVssBackupComponents
          - DeleteSnapshots
