# Suspicious npm Package Patterns
# These patterns are often PRESENT in malware and ABSENT in legitimate packages
# Useful for differential ML analysis

traits:
  # IIFE at top level (immediate side effects)
  - id: eco/npm/suspicious/iife-execution
    description: Immediately invoked function expression (side-effect execution)
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: string
      regex: "^\\(\\s*(?:async\\s+)?(?:function|\\(|\\)\\s*=>)[^]*\\)\\s*\\(\\s*\\)"

  # No exports (side-effect only module)
  - id: eco/npm/suspicious/no-exports
    description: Module has no exports (side-effect only)
    criticality: notable
    confidence: 0.7
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule no_exports {
          strings:
            $export1 = "module.exports" ascii
            $export2 = "exports." ascii
            $export3 = /^export\s/ ascii
          condition:
            not any of ($export*)
        }

  # Only uses Node built-ins (no external deps)
  - id: eco/npm/suspicious/only-builtins
    description: Code only uses Node.js built-in modules
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule only_node_builtins {
          strings:
            $builtin1 = "require('os')" ascii
            $builtin2 = "require('fs')" ascii
            $builtin3 = "require('https')" ascii
            $builtin4 = "require('http')" ascii
            $builtin5 = "require('child_process')" ascii
            $builtin6 = "require('path')" ascii
            $builtin7 = "require('crypto')" ascii
            $builtin8 = /require\(['"]node:/ ascii
          condition:
            2 of ($builtin*)
        }

  # Executes on require/import
  - id: eco/npm/suspicious/executes-on-import
    description: Code executes immediately when imported
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule executes_on_import {
          strings:
            $iife1 = /^\(async\s*\(\)\s*=>\s*\{/ ascii
            $iife2 = /^\(function\s*\(\)\s*\{/ ascii
            $iife3 = /^\(\(\)\s*=>\s*\{/ ascii
            $toplevel_call = /^[a-z][a-zA-Z0-9]*\(\)/ ascii
          condition:
            any of them
        }

  # Single small file package
  - id: eco/npm/suspicious/minimal-package
    description: Package has minimal structure (single small file)
    criticality: notable
    confidence: 0.7
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule minimal_package {
          condition:
            filesize < 5KB
        }

  # Uses dangerous APIs without proper context
  - id: eco/npm/suspicious/dangerous-apis
    description: Uses multiple dangerous APIs together
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule dangerous_api_combo {
          strings:
            $os = "require('os')" ascii
            $os2 = "require(\"os\")" ascii
            $os3 = "from 'os'" ascii
            $cp = "require('child_process')" ascii
            $cp2 = "require(\"child_process\")" ascii
            $cp3 = "from 'child_process'" ascii
            $net = "require('https')" ascii
            $net2 = "require('http')" ascii
            $net3 = /require\(['"]node:https?['"]\)/ ascii
          condition:
            (any of ($os*)) and (any of ($cp*) or any of ($net*))
        }

  # Temp directory usage
  - id: eco/npm/suspicious/temp-dir-usage
    description: Writes to system temp directory
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: string
      regex: "os\\.tmpdir\\(\\)|/tmp/|\\\\temp\\\\"

  # Random/unique file naming
  - id: eco/npm/suspicious/random-filename
    description: Generates random or unique filenames
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: string
      regex: "Math\\.random\\(\\)\\.toString\\(36\\)|crypto\\.randomBytes|uuid|nanoid"

  # Missing package.json fields
  - id: eco/npm/suspicious/missing-metadata
    description: Package missing standard metadata fields
    criticality: notable
    confidence: 0.7
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule missing_metadata {
          strings:
            $repo = "\"repository\":" ascii
            $keywords = "\"keywords\":" ascii
            $author = /"author":\s*"[^"]+@/ ascii
          condition:
            not $repo and not $keywords and not $author
        }

  # Scoped package with suspicious pattern
  - id: eco/npm/suspicious/scoped-typosquat
    description: Scoped package mimicking well-known package
    criticality: suspicious
    confidence: 0.85
    file_types: [packagejson]
    condition:
      type: string
      regex: '"name":\\s*"@[^/]+/(react|vue|angular|express|lodash|axios|webpack|babel|typescript|eslint|prettier|jest|mocha)'

  # Uses eval-like patterns
  - id: eco/npm/suspicious/eval-pattern
    description: Uses eval or Function constructor
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: string
      regex: "\\beval\\s*\\(|new\\s+Function\\s*\\(|vm\\.runIn"

  # Dynamically requires modules
  - id: eco/npm/suspicious/dynamic-require
    description: Dynamically constructs require paths
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: string
      regex: "require\\s*\\(\\s*[a-zA-Z_$][a-zA-Z0-9_$]*\\s*\\)|require\\s*\\(\\s*`"

  # Silent error suppression
  - id: eco/npm/suspicious/silent-errors
    description: Silently suppresses errors
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: string
      regex: "catch\\s*\\([^)]*\\)\\s*\\{\\s*\\}|\\.catch\\s*\\(\\s*\\(\\s*\\)\\s*=>\\s*\\{\\s*\\}\\s*\\)"

  # Writes executable files
  - id: eco/npm/suspicious/writes-executable
    description: Writes files then makes them executable
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule writes_executable {
          strings:
            $write1 = "writeFileSync" ascii
            $write2 = "writeFile" ascii
            $chmod = "chmod" ascii
            $exec1 = "exec(" ascii
            $exec2 = "spawn(" ascii
          condition:
            any of ($write*) and ($chmod or any of ($exec*))
        }

  # Obfuscated variable names
  - id: eco/npm/suspicious/obfuscated-names
    description: Uses obfuscated variable names
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: string
      regex: "(?:var|let|const)\\s+_0x[a-f0-9]+|(?:var|let|const)\\s+[a-zA-Z]\\d{3,}"

  # Network request in install hook
  - id: eco/npm/suspicious/install-network
    description: Makes network request during package install
    criticality: suspicious
    confidence: 0.9
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule install_network {
          strings:
            $hook1 = "\"preinstall\":" ascii
            $hook2 = "\"postinstall\":" ascii
            $hook3 = "\"install\":" ascii
            $curl = "curl " ascii
            $wget = "wget " ascii
            $fetch = "fetch" ascii
            $http = "http" ascii
          condition:
            any of ($hook*) and any of ($curl, $wget, $fetch, $http)
        }

  # Inline node execution in install hooks
  - id: eco/npm/suspicious/node-eval-hook
    description: Install hook uses node -e for inline code execution
    criticality: suspicious
    confidence: 0.9
    attack: "T1059.007"
    file_types: [packagejson]
    condition:
      type: yara
      source: |
        rule node_eval_hook {
          strings:
            $hook1 = "\"preinstall\":" ascii
            $hook2 = "\"postinstall\":" ascii
            $hook3 = "\"install\":" ascii
            $node_e = "node -e" ascii
            $node_eval = "node --eval" ascii
          condition:
            any of ($hook*) and any of ($node_e, $node_eval)
        }

  # Console.log override (hiding output)
  - id: eco/npm/suspicious/console-override
    description: Overrides console.log (potential output hiding)
    criticality: notable
    confidence: 0.8
    file_types: [javascript]
    condition:
      type: string
      regex: "console\\.log\\s*=|const\\s+l\\s*=\\s*console\\.log"

  # Process object shadowing
  - id: eco/npm/suspicious/process-shadow
    description: Shadows built-in process object (evasion technique)
    criticality: suspicious
    confidence: 0.85
    attack: "T1027"
    file_types: [javascript]
    condition:
      type: string
      regex: "const\\s+process\\s*=\\s*\\{|let\\s+process\\s*=\\s*\\{|var\\s+process\\s*=\\s*\\{"

  # Retry loop pattern (resilient malware)
  - id: eco/npm/suspicious/retry-loop
    description: Retry loop pattern (resilient execution)
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule retry_loop_pattern {
          strings:
            $retry1 = "retrycnt" ascii nocase
            $retry2 = "retryCount" ascii
            $retry3 = "retry_count" ascii
            $retry4 = "maxRetries" ascii
            $retry5 = "attempts" ascii
            $while = "while" ascii
            $loop = "for" ascii
          condition:
            any of ($retry*) and any of ($while, $loop)
        }

  # Bug bounty / security research markers
  - id: eco/npm/suspicious/bug-bounty-marker
    description: Bug bounty or security research marker
    criticality: notable
    confidence: 0.9
    file_types: [javascript, packagejson]
    condition:
      type: string
      regex: "bug\\s*bounty|hackerone|bugcrowd|security\\s*research|proof\\s*of\\s*concept|PoC|benign\\s*test"

  # Stdio ignore pattern (silent execution)
  - id: eco/npm/suspicious/stdio-ignore
    description: Silent process execution (stdio ignored)
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "stdio:\\s*['\"]ignore['\"]|stdio:\\s*\\[.*ignore"

  # Child unref pattern (orphan process)
  - id: eco/npm/suspicious/child-unref
    description: Orphan child process (unref pattern)
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "child\\.unref\\(\\)|spawn\\([^)]+\\)\\.unref\\(\\)"

  # SSL/TLS verification skip
  - id: eco/npm/suspicious/ssl-skip
    description: SSL certificate verification disabled
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "rejectUnauthorized:\\s*false|NODE_TLS_REJECT_UNAUTHORIZED.*0"

  # Fetch with no-cors (potential exfil)
  - id: eco/npm/suspicious/fetch-no-cors
    description: Fetch with no-cors mode (potential exfiltration)
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "mode:\\s*['\"]no-cors['\"]"

  # Axios interceptor manipulation
  - id: eco/npm/suspicious/axios-interceptor
    description: Axios request/response interceptor
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "axios\\.interceptors\\.(request|response)\\.use"

  # Empty main/index file (shell package)
  - id: eco/npm/suspicious/empty-main
    description: Main file has minimal or no code
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule empty_main {
          condition:
            filesize < 100
        }

  # Hostname collection
  - id: eco/npm/suspicious/hostname-collection
    description: Collects system hostname
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "os\\.hostname\\(\\)|require\\(['\"]os['\"]\\)\\.hostname"

  # Username collection
  - id: eco/npm/suspicious/username-collection
    description: Collects system username
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "os\\.userInfo\\(\\)|process\\.env\\.USER|process\\.env\\.USERNAME"

  # Network interface enumeration
  - id: eco/npm/suspicious/network-enum
    description: Enumerates network interfaces
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "os\\.networkInterfaces\\(\\)"

  # IP address extraction pattern
  - id: eco/npm/suspicious/ip-extraction
    description: Extracts IP addresses from network interfaces
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule ip_extraction {
          strings:
            $net = "networkInterfaces" ascii
            $family = "family" ascii
            $ipv4 = "IPv4" ascii
            $address = "address" ascii
          condition:
            $net and ($family or $ipv4) and $address
        }

  # Buffer concat with HTTP (data aggregation before exfil)
  - id: eco/npm/suspicious/buffer-concat-http
    description: Buffer concatenation with HTTP request (potential exfil)
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule buffer_concat_http {
          strings:
            $concat = "Buffer.concat" ascii
            $http1 = "https.request" ascii
            $http2 = "http.request" ascii
            $fetch = "fetch(" ascii
            $axios = "axios" ascii
          condition:
            $concat and any of ($http*, $fetch, $axios)
        }

  # JSON stringify with HTTP (object exfil)
  - id: eco/npm/suspicious/json-stringify-http
    description: JSON serialization with HTTP request
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule json_stringify_http {
          strings:
            $stringify = "JSON.stringify" ascii
            $http1 = "https.request" ascii
            $http2 = "http.request" ascii
            $fetch = "fetch(" ascii
            $post = "POST" ascii
          condition:
            $stringify and any of ($http*, $fetch) and $post
        }

  # Environment variable access (secrets)
  - id: eco/npm/suspicious/env-secrets
    description: Accesses environment variables (potential secrets)
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(API_KEY|SECRET|TOKEN|PASSWORD|CREDENTIALS|AWS_|GITHUB_TOKEN)"

  # CI/CD credential targeting
  - id: eco/npm/suspicious/cicd-credentials
    description: Accesses CI/CD environment credentials
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule cicd_credentials {
          strings:
            $jenkins = "JENKINS_TOKEN" ascii
            $jenkins2 = "JENKINS_API_TOKEN" ascii
            $github = "GITHUB_TOKEN" ascii
            $gh = "GH_TOKEN" ascii
            $gitlab = "GITLAB_TOKEN" ascii
            $gitlab2 = "CI_JOB_TOKEN" ascii
            $circle = "CIRCLE_TOKEN" ascii
            $travis = "TRAVIS_TOKEN" ascii
            $npm = "NPM_TOKEN" ascii
            $npm2 = "NPM_AUTH_TOKEN" ascii
            $docker = "DOCKER_TOKEN" ascii
            $docker2 = "DOCKERHUB_TOKEN" ascii
            $aws = "AWS_SECRET_ACCESS_KEY" ascii
            $aws2 = "AWS_SESSION_TOKEN" ascii
            $azure = "AZURE_CREDENTIALS" ascii
            $gcp = "GOOGLE_APPLICATION_CREDENTIALS" ascii
          condition:
            any of them
        }

  # Full process.env dump
  - id: eco/npm/suspicious/env-dump
    description: Dumps entire process.env (secrets exfiltration)
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule env_dump {
          strings:
            $dump1 = "JSON.stringify(process.env)" ascii
            $dump2 = "Object.keys(process.env)" ascii
            $dump3 = "Object.entries(process.env)" ascii
            $dump4 = "{ ...process.env }" ascii
            $spread = /\{\s*\.\.\.process\.env\s*\}/ ascii
          condition:
            any of them
        }

  # File system traversal pattern
  - id: eco/npm/suspicious/fs-traversal
    description: File system directory traversal
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule fs_traversal {
          strings:
            $readdir = "readdirSync" ascii
            $readdir2 = "readdir(" ascii
            $recurse = "recursive" ascii
            $walk = "walkSync" ascii
            $glob = "globSync" ascii
          condition:
            any of ($readdir*) and $recurse or any of ($walk, $glob)
        }

  # Home directory access
  - id: eco/npm/suspicious/home-dir-access
    description: Accesses user home directory
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "os\\.homedir\\(\\)|process\\.env\\.HOME|process\\.env\\.USERPROFILE"

  # Chrome/browser data paths
  - id: eco/npm/suspicious/browser-data-path
    description: References browser data directories
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "Application Support/Google/Chrome|AppData.*Local.*Google.*Chrome|.config/google-chrome"

  # Encoding chain (multiple encoding layers)
  - id: eco/npm/suspicious/encoding-chain
    description: Multiple encoding transformations (obfuscation)
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule encoding_chain {
          strings:
            $b64_1 = "atob(" ascii
            $b64_2 = "btoa(" ascii
            $b64_3 = "Buffer.from" ascii
            $b64_4 = "toString('base64')" ascii
            $b64_5 = "toString(\"base64\")" ascii
            $hex = "toString('hex')" ascii
            $hex2 = "toString(\"hex\")" ascii
          condition:
            2 of them
        }

  # Process spawn with shell option
  - id: eco/npm/suspicious/spawn-shell
    description: Process spawn with shell option enabled
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "spawn\\([^)]*\\{[^}]*shell:\\s*true"

  # Require with variable path
  - id: eco/npm/suspicious/require-variable
    description: Dynamic require with variable path
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: string
      regex: "require\\(\\s*[a-zA-Z_$][a-zA-Z0-9_$]*\\s*\\)|require\\(\\s*`"

  # Webpack/bundler comment stripping
  - id: eco/npm/suspicious/bundler-minified
    description: Code appears minified/bundled
    criticality: notable
    confidence: 0.7
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule bundler_minified {
          strings:
            $webpack = "__webpack_require__" ascii
            $parcel = "__parcel__" ascii
            $rollup = "_interopDefault" ascii
            $esbuild = "__esModule" ascii
          condition:
            any of them
        }

  # Process cwd in file operations
  - id: eco/npm/suspicious/cwd-file-access
    description: Uses current working directory for file access
    criticality: notable
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.cwd\\(\\).*(?:readFile|writeFile|readdir)"

  # Await inside try without proper error handling
  - id: eco/npm/suspicious/silent-async-error
    description: Silent async error suppression
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "try\\s*\\{[^}]*await[^}]*\\}\\s*catch\\s*\\([^)]*\\)\\s*\\{\\s*\\}"

  # Top-level await with network (immediate exfil)
  - id: eco/npm/suspicious/toplevel-await-network
    description: Top-level await with network request
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule toplevel_await_network {
          strings:
            $await = /^await\s+(?:fetch|https?\.|axios)/ ascii
            $iife = /^\(async\s*\(\)\s*=>\s*\{/ ascii
          condition:
            $await or $iife
        }

  # Hardcoded token/key pattern
  - id: eco/npm/suspicious/hardcoded-token
    description: Hardcoded API token or key pattern
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:token|apiKey|api_key|secret|password)\\s*[=:]\\s*['\"][A-Za-z0-9_-]{20,}['\"]"

  # setTimeout with network callback
  - id: eco/npm/suspicious/delayed-network
    description: Delayed network request execution
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule delayed_network {
          strings:
            $timeout = "setTimeout" ascii
            $interval = "setInterval" ascii
            $fetch = "fetch(" ascii
            $http = "https.request" ascii
            $axios = "axios" ascii
          condition:
            any of ($timeout, $interval) and any of ($fetch, $http, $axios)
        }

  # Process exit handler with network
  - id: eco/npm/suspicious/exit-handler-network
    description: Process exit handler with network activity
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule exit_handler_network {
          strings:
            $exit1 = "process.on('exit'" ascii
            $exit2 = "process.on(\"exit\"" ascii
            $exit3 = "beforeExit" ascii
            $fetch = "fetch" ascii
            $http = "http" ascii
          condition:
            any of ($exit*) and any of ($fetch, $http)
        }

  # Network in error handler (report to attacker)
  - id: eco/npm/suspicious/error-network
    description: Network request in error handler
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule error_network {
          strings:
            $catch = /catch\s*\([^)]*\)\s*\{[^}]*(?:fetch|http|axios|request)/ ascii
            $onerror = /onerror\s*=\s*[^;]*(?:fetch|http)/ ascii
          condition:
            any of them
        }

  # No function definitions (script-only)
  - id: eco/npm/suspicious/no-functions
    description: Code has no function definitions (script-only execution)
    criticality: notable
    confidence: 0.7
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule no_functions {
          strings:
            $func1 = /^function\s+\w+/ ascii
            $func2 = /^const\s+\w+\s*=\s*(?:async\s+)?function/ ascii
            $func3 = /^const\s+\w+\s*=\s*(?:async\s+)?\(/ ascii
            $arrow = /^const\s+\w+\s*=\s*\([^)]*\)\s*=>/ ascii
          condition:
            not any of them and filesize < 10KB
        }

  # Immediately calls main/run function
  - id: eco/npm/suspicious/immediate-main
    description: Immediately calls main/run function on load
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:main|run|start|init|execute)\\s*\\(\\s*\\)\\s*;?\\s*$"

  # Single require + immediate execution
  - id: eco/npm/suspicious/require-execute
    description: Single require followed by immediate execution
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule require_execute {
          strings:
            $req = /^const\s+\{\s*\w+\s*\}\s*=\s*require\(['"]\w+['"]\)/ ascii
            $call = /^\w+\(\)/ ascii
          condition:
            $req and $call and filesize < 500
        }

  # Uses atob/btoa in Node (unusual - browser APIs)
  - id: eco/npm/suspicious/browser-api-node
    description: Uses browser-only APIs in Node context
    criticality: notable
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule browser_api_node {
          strings:
            $atob = "atob(" ascii
            $btoa = "btoa(" ascii
            $require = "require(" ascii
          condition:
            any of ($atob, $btoa) and $require
        }

  # Writes to package.json (persistence)
  - id: eco/npm/suspicious/package-json-write
    description: Writes to package.json file
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "writeFileSync\\s*\\([^)]*package\\.json|writeFile\\s*\\([^)]*package\\.json"

  # Modifies node_modules
  - id: eco/npm/suspicious/node-modules-write
    description: Writes to node_modules directory
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:writeFile|writeFileSync|appendFile)\\s*\\([^)]*node_modules"

  # Reads .npmrc (credentials)
  - id: eco/npm/suspicious/npmrc-read
    description: Reads .npmrc file (potential token theft)
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:readFile|readFileSync)\\s*\\([^)]*\\.npmrc"

  # Reads .yarnrc (credentials)
  - id: eco/npm/suspicious/yarnrc-read
    description: Reads .yarnrc file (potential token theft)
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:readFile|readFileSync)\\s*\\([^)]*\\.yarnrc"

  # Concatenates user data for exfil
  - id: eco/npm/suspicious/data-concat
    description: Concatenates user/system data (potential exfil prep)
    criticality: notable
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule data_concat {
          strings:
            $hostname = "hostname()" ascii
            $username = "userInfo()" ascii
            $cwd = "process.cwd()" ascii
            $concat = "+" ascii
            $template = "${" ascii
          condition:
            2 of ($hostname, $username, $cwd) and any of ($concat, $template)
        }

  # Base64 encodes collected data
  - id: eco/npm/suspicious/base64-data
    description: Base64 encodes collected system data
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule base64_data {
          strings:
            $b64_1 = "toString('base64')" ascii
            $b64_2 = "toString(\"base64\")" ascii
            $btoa = "btoa(" ascii
            $buffer = "Buffer.from" ascii
            $os = "os." ascii
            $env = "process.env" ascii
          condition:
            any of ($b64_1, $b64_2, $btoa) and ($buffer or $os or $env)
        }

  # Hex encodes collected data
  - id: eco/npm/suspicious/hex-data
    description: Hex encodes collected system data
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule hex_data {
          strings:
            $hex_1 = "toString('hex')" ascii
            $hex_2 = "toString(\"hex\")" ascii
            $buffer = "Buffer.from" ascii
            $os = "os." ascii
            $env = "process.env" ascii
          condition:
            any of ($hex_1, $hex_2) and ($buffer or $os or $env)
        }

  # Creates hidden files
  - id: eco/npm/suspicious/hidden-file
    description: Creates hidden files (dot prefix)
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:writeFile|writeFileSync)\\s*\\([^)]*['\"]\\.[a-zA-Z]"

  # Multiple OOB domains (redundant exfil)
  - id: eco/npm/suspicious/multi-oob
    description: Multiple OOB exfiltration endpoints
    criticality: suspicious
    confidence: 0.9
    file_types: [javascript, typescript, packagejson]
    condition:
      type: yara
      source: |
        rule multi_oob {
          strings:
            $oast1 = "oast.fun" ascii nocase
            $oast2 = "oastify.com" ascii nocase
            $oast3 = "oast.me" ascii nocase
            $webhook = "webhook.site" ascii nocase
            $pipedream = "pipedream.net" ascii nocase
            $discord = "discord.com/api/webhooks" ascii nocase
          condition:
            2 of them
        }

  # Uses DNS for data exfil
  - id: eco/npm/suspicious/dns-exfil
    description: Uses DNS queries for data exfiltration
    criticality: suspicious
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule dns_exfil {
          strings:
            $dns1 = "dns.resolve" ascii
            $dns2 = "dns.lookup" ascii
            $dns3 = "require('dns')" ascii
            $dns4 = "require(\"dns\")" ascii
            $data = /\$\{.*(?:hostname|username|userInfo|cwd).*\}\./ ascii
          condition:
            any of ($dns*) and $data
        }

