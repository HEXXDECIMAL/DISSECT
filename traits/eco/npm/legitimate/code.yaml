# Legitimate JavaScript Code Patterns
# These patterns are typically PRESENT in legitimate code and ABSENT in malware
# Useful for differential ML analysis

traits:
  # Has module.exports (CommonJS export)
  - id: eco/npm/legitimate/has-cjs-export
    description: Code exports functionality via CommonJS
    criticality: inert
    confidence: 0.85
    file_types: [javascript]
    condition:
      type: string
      regex: "module\\.exports\\s*=|exports\\.[a-zA-Z]"

  # Has ES module export
  - id: eco/npm/legitimate/has-esm-export
    description: Code exports functionality via ES modules
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "^export\\s+(default|const|function|class|async|let|var|\\{)"

  # Has class definition
  - id: eco/npm/legitimate/has-class
    description: Code defines classes
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "^class\\s+[A-Z][a-zA-Z0-9]*|export\\s+class\\s+[A-Z]"

  # Has JSDoc comments
  - id: eco/npm/legitimate/has-jsdoc
    description: Code has JSDoc documentation
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "/\\*\\*[\\s\\S]*?@(?:param|returns?|type|typedef|example)"

  # Has proper error handling
  - id: eco/npm/legitimate/has-try-catch
    description: Code has try-catch error handling
    criticality: inert
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "try\\s*\\{[^}]+\\}\\s*catch"

  # Has async/await
  - id: eco/npm/legitimate/has-async-await
    description: Code uses async/await patterns
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "async\\s+function|async\\s*\\(|await\\s+"

  # Has Promise usage
  - id: eco/npm/legitimate/has-promise
    description: Code uses Promises
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "new\\s+Promise\\(|\\.then\\(|\\.catch\\(|Promise\\.(?:all|race|resolve|reject)"

  # Has named function definitions
  - id: eco/npm/legitimate/has-named-functions
    description: Code has named function definitions
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "^(?:async\\s+)?function\\s+[a-z][a-zA-Z0-9]*\\s*\\("

  # Imports from node_modules
  - id: eco/npm/legitimate/imports-dependencies
    description: Code imports from external packages
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"][^./][^'\"]+['\"]\\)|from\\s+['\"][^./][^'\"]+['\"]"

  # Has TypeScript types
  - id: eco/npm/legitimate/has-typescript-types
    description: Code has TypeScript type annotations
    criticality: inert
    confidence: 0.9
    file_types: [typescript]
    condition:
      type: string
      regex: ":\\s*(?:string|number|boolean|object|any|void|never|unknown|null|undefined|Array|Record|Promise)\\b"

  # Has interface/type definitions
  - id: eco/npm/legitimate/has-type-definitions
    description: Code defines TypeScript interfaces or types
    criticality: inert
    confidence: 0.9
    file_types: [typescript]
    condition:
      type: string
      regex: "^(?:export\\s+)?(?:interface|type)\\s+[A-Z]"

  # Has EventEmitter pattern
  - id: eco/npm/legitimate/has-eventemitter
    description: Code uses EventEmitter pattern
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "extends\\s+EventEmitter|require\\(['\"]events['\"]\\)"

  # Has Stream usage
  - id: eco/npm/legitimate/has-stream
    description: Code uses Node.js streams
    criticality: inert
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"]stream['\"]\\)|Readable|Writable|Transform|Duplex"

  # Has Buffer with encoding (legitimate usage)
  - id: eco/npm/legitimate/has-buffer-encoding
    description: Code uses Buffer with explicit encoding
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "Buffer\\.from\\([^)]+,\\s*['\"](?:utf8|utf-8|ascii|hex|binary)['\"]\\)"

  # Has callback pattern
  - id: eco/npm/legitimate/has-callback-pattern
    description: Code uses Node.js callback pattern
    criticality: inert
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "function\\s*\\([^)]*,\\s*(?:callback|cb|done|next)\\)"

  # Has configuration object pattern
  - id: eco/npm/legitimate/has-config-object
    description: Code uses configuration objects
    criticality: inert
    confidence: 0.75
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:config|options|settings|opts)\\s*=\\s*\\{|function\\s*\\([^)]*(?:config|options|settings)\\)"

  # Has default export
  - id: eco/npm/legitimate/has-default-export
    description: Code has default export
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "export\\s+default|module\\.exports\\s*="

  # Uses 'use strict'
  - id: eco/npm/legitimate/use-strict
    description: Code uses strict mode
    criticality: inert
    confidence: 0.75
    file_types: [javascript]
    condition:
      type: string
      exact: "'use strict'"

  # Has test blocks (describe/it/test)
  - id: eco/npm/legitimate/has-test-blocks
    description: Code contains test definitions
    criticality: inert
    confidence: 0.95
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "\\b(?:describe|it|test|expect)\\s*\\("

  # Has assertion library usage
  - id: eco/npm/legitimate/has-assertions
    description: Code uses assertion patterns
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:assert|expect|should)\\s*[.\\(]|toBe\\(|toEqual\\(|toMatch\\("

  # Uses popular web framework
  - id: eco/npm/legitimate/uses-web-framework
    description: Code uses established web framework
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"](?:express|koa|fastify|hapi|next|nuxt)['\"]\\)|from ['\"](?:express|koa|fastify|hapi|next|nuxt)['\"]"

  # Has middleware pattern
  - id: eco/npm/legitimate/has-middleware
    description: Code uses middleware pattern
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:app|router)\\.use\\(|middleware\\s*[=:]"

  # Has route definitions
  - id: eco/npm/legitimate/has-routes
    description: Code defines HTTP routes
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:app|router)\\.(?:get|post|put|delete|patch)\\s*\\(['\"]/"

  # Has proper logging
  - id: eco/npm/legitimate/has-logging
    description: Code uses logging library
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"](?:winston|pino|bunyan|log4js|debug)['\"]\\)|logger\\.|log\\.(?:info|warn|error|debug)"

  # Has schema validation
  - id: eco/npm/legitimate/has-validation
    description: Code uses schema validation
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"](?:joi|yup|zod|ajv)['\"]\\)|z\\.object\\(|Joi\\.object\\("

  # Has database interaction
  - id: eco/npm/legitimate/has-database
    description: Code interacts with database
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"](?:mongoose|sequelize|knex|pg|mysql|mongodb)['\"]\\)|prisma\\.|\\$queryRaw"

  # Has React/Vue/Angular patterns
  - id: eco/npm/legitimate/has-frontend-framework
    description: Code uses frontend framework patterns
    criticality: inert
    confidence: 0.9
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:React|Vue|Component)\\.(?:createElement|defineComponent)|@Component\\(|useEffect\\(|useState\\("

  # Has decorator patterns
  - id: eco/npm/legitimate/has-decorators
    description: Code uses TypeScript/ES decorators
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "@(?:Controller|Injectable|Service|Module|Component|Prop|Watch)\\("

  # Has dependency injection
  - id: eco/npm/legitimate/has-di-pattern
    description: Code uses dependency injection
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "(?:inject|provide|@Inject|container\\.resolve|inversify)"

  # Has CLI argument parsing
  - id: eco/npm/legitimate/has-cli-args
    description: Code parses CLI arguments
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "require\\(['\"](?:commander|yargs|meow|minimist)['\"]\\)|program\\.(?:command|option)\\("

  # Has proper error class
  - id: eco/npm/legitimate/has-error-class
    description: Code defines custom error classes
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "class\\s+\\w+Error\\s+extends\\s+Error"

  # Has getter/setter
  - id: eco/npm/legitimate/has-accessors
    description: Code uses getters/setters
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "\\bget\\s+\\w+\\s*\\(\\)|\\bset\\s+\\w+\\s*\\("

  # Has symbol usage
  - id: eco/npm/legitimate/has-symbols
    description: Code uses Symbol for private properties
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "Symbol\\s*\\(|Symbol\\.(?:for|iterator|asyncIterator)"

  # Has WeakMap/WeakSet (private data pattern)
  - id: eco/npm/legitimate/has-weak-collections
    description: Code uses WeakMap/WeakSet patterns
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "new\\s+Weak(?:Map|Set)\\s*\\("

  # Has Proxy usage
  - id: eco/npm/legitimate/has-proxy
    description: Code uses Proxy for metaprogramming
    criticality: inert
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "new\\s+Proxy\\s*\\("

  # Has generator functions
  - id: eco/npm/legitimate/has-generators
    description: Code uses generator functions
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "function\\s*\\*|yield\\s+"

  # Multiple named exports
  - id: eco/npm/legitimate/has-multiple-exports
    description: Code has multiple named exports
    criticality: inert
    confidence: 0.85
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule multiple_exports {
          strings:
            $exp1 = /^export (const|function|class|let|var|async)/ ascii
            $exp2 = /exports\.[a-zA-Z]+ =/ ascii
            $exp3 = /module\.exports = \{/ ascii
          condition:
            #exp1 >= 2 or #exp2 >= 2 or $exp3
        }
