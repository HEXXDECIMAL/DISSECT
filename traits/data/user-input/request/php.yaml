# PHP User Input (Superglobal) Access Traits
# These are critical for webshell/backdoor detection
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  - id: get
    desc: HTTP GET parameter access ($_GET)
    crit: notable
    conf: 0.85
    attack: "T1059"
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_GET"
      regex: true

  - id: post
    desc: HTTP POST parameter access ($_POST)
    crit: notable
    conf: 0.85
    attack: "T1059"
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_POST"
      regex: true

  - id: request
    desc: HTTP REQUEST parameter access ($_REQUEST)
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_REQUEST"
      regex: true

  - id: cookie
    desc: HTTP Cookie access ($_COOKIE)
    crit: notable
    conf: 0.8
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_COOKIE"
      regex: true

  - id: server
    desc: Server variable access ($_SERVER)
    crit: notable
    conf: 0.75
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_SERVER"
      regex: true

  - id: files
    desc: File upload access ($_FILES)
    crit: suspicious
    conf: 0.85
    attack: "T1105"
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_FILES"
      regex: true

  - id: session
    desc: Session variable access ($_SESSION)
    crit: notable
    conf: 0.75
    for: [php]
    if:
      type: ast_pattern
      node_type: variable_name
      pattern: "\\$_SESSION"
      regex: true

  - id: script-filename
    desc: Access to script filename (self-reference)
    crit: suspicious
    conf: 0.85
    for: [php]
    if:
      type: string
      exact: "SCRIPT_FILENAME"

  - id: http-user-agent
    desc: Access to HTTP User-Agent header
    crit: notable
    conf: 0.7
    for: [php]
    if:
      type: string
      exact: "HTTP_USER_AGENT"

  - id: http-referer
    desc: Access to HTTP Referer header
    crit: notable
    conf: 0.7
    for: [php]
    if:
      type: string
      exact: "HTTP_REFERER"

  # === extract atomic indicators ===
  - id: extract-get
    desc: extract from $_GET
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "extract\\s*\\(\\s*\\$_GET"

  - id: extract-post
    desc: extract from $_POST
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "extract\\s*\\(\\s*\\$_POST"

  - id: extract-request
    desc: extract from $_REQUEST
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "extract\\s*\\(\\s*\\$_REQUEST"

  - id: extract-cookie
    desc: extract from $_COOKIE
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "extract\\s*\\(\\s*\\$_COOKIE"

  - id: extract-server
    desc: extract from $_SERVER
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "extract\\s*\\(\\s*\\$_SERVER"

  # === parse_str atomic indicators ===
  - id: parse-str-get
    desc: parse_str from $_GET
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "parse_str\\s*\\(\\s*\\$_GET"

  - id: parse-str-post
    desc: parse_str from $_POST
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "parse_str\\s*\\(\\s*\\$_POST"

  - id: parse-str-request
    desc: parse_str from $_REQUEST
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "parse_str\\s*\\(\\s*\\$_REQUEST"

  - id: parse-str-cookie
    desc: parse_str from $_COOKIE
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "parse_str\\s*\\(\\s*\\$_COOKIE"

  - id: parse-str-server
    desc: parse_str from $_SERVER
    crit: inert
    conf: 0.7
    for: [php]
    if:
      type: string
      regex: "parse_str\\s*\\(\\s*\\$_SERVER"

composite_rules:
  - id: extract-input
    desc: Extracts variables from user input (potential backdoor)
    crit: suspicious
    conf: 0.9
    for: [php]
    count_min: 1
    any:
      - id: extract-get
      - id: extract-post
      - id: extract-request
      - id: extract-cookie
      - id: extract-server

  - id: parse-str-input
    desc: Parses user input into variables
    crit: suspicious
    conf: 0.9
    for: [php]
    count_min: 1
    any:
      - id: parse-str-get
      - id: parse-str-post
      - id: parse-str-request
      - id: parse-str-cookie
      - id: parse-str-server
