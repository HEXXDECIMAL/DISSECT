# HTTP Request Operations - Python
# MBC: C0002 (HTTP Communication)
# ATT&CK: T1071.001

defaults:
  file_types: [python]

traits:
  # === HTTP library atomic indicators ===
  - id: requests-get
    description: requests.get call
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: "requests.get"

  - id: requests-post
    description: requests.post call
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: "requests.post"

  - id: urllib-urlopen
    description: urllib.request.urlopen call
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: "urllib.request.urlopen"

  - id: aiohttp-session
    description: aiohttp.ClientSession usage
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: "aiohttp.ClientSession"

  - id: httpx-get
    description: httpx.get call
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: "httpx.get"

  - id: httpx-post
    description: httpx.post call
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      exact: "httpx.post"

  - id: url-literal
    description: "Direct URL literal in HTTP request"
    criticality: notable
    confidence: 0.8
    file_types: [python]
    condition:
      type: ast_query
      language: python
      query: |
        (call
          function: (attribute
            object: (identifier) @obj
            attribute: (identifier) @meth)
          arguments: (argument_list
            (string) @url))
        (#match? @obj "^(requests|urqt|urllib|urllib2|req|r|client|http|session|httpx)$")
        (#match? @meth "^(get|post|urlopen|urlretrieve|request)$")

composite_rules:
  # HTTP request composite
  - id: request-python
    description: "Performs HTTP request (urllib, requests, aiohttp, httpx)"
    criticality: inert
    confidence: 0.9
    requires_count: 1
    conditions:
      - id: requests-get
      - id: requests-post
      - id: urllib-urlopen
      - id: aiohttp-session
      - id: httpx-get
      - id: httpx-post

  # HTTP GET composite
  - id: get
    description: "Performs HTTP GET request"
    criticality: notable
    confidence: 0.9
    requires_count: 1
    conditions:
      - id: requests-get
      - id: httpx-get

  # HTTP POST composite
  - id: post
    description: "Performs HTTP POST request (Exfiltration indicator)"
    criticality: notable
    confidence: 0.9
    requires_count: 1
    conditions:
      - id: requests-post
      - id: httpx-post

# Note: Exfiltration composite rule moved to exfil/http/python.yaml