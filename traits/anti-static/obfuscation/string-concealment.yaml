# String Concealment Detection
# Detects binaries with suspiciously low string counts
# Malware obfuscates strings at compile time to hide behavior
# ATT&CK: T1027.010 (Obfuscated Files or Information: Command Obfuscation)

defaults:
  attack: "T1027.010"
  mbc: "F0001.005"
  for: [elf, macho, pe]

traits:
  # === Tiny cstring section ===
  - id: tiny-cstring-section
    desc: "Suspiciously small string section (<100 bytes in >50KB binary)"
    crit: suspicious
    conf: 0.9
    if:
      type: section_ratio
      section: "(__TEXT\\.__cstring|^\\.rodata\\.|^\\.rdata)"
      regex: true
      compare_to: "total"
      max_ratio: 0.002  # Less than 0.2% of binary is strings
    unless:
      - id: feat/binary/size-tiny  # Don't flag tiny binaries

  - id: minimal-strings
    desc: "Binary has very few readable strings (possible runtime decryption)"
    crit: suspicious
    conf: 0.85
    if:
      type: string_count
      max: 50
      min_length: 4
    unless:
      - id: feat/binary/size-tiny

composite_rules:
  # String concealment pattern
  - id: string-concealment
    desc: "String obfuscation via runtime decryption (tiny cstring + execution)"
    crit: suspicious
    conf: 0.9
    attack: "T1027.010"
    all:
      - id: tiny-cstring-section
    count_min: 1
    any:
      - id: exec/command/shell
      - id: comm/socket/create
      - id: fs/file-ops/binary-file-ops
