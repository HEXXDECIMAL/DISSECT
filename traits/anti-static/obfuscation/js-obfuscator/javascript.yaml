# JavaScript Obfuscator Detection
# Detects signatures of javascript-obfuscator and similar tools
# ATT&CK: T1027 (Obfuscated Files or Information)

traits:
  # === Infinite loop atomic indicators ===
  - id: while-not-not-array
    desc: while(!![]) infinite loop pattern
    crit: notable
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "while\\s*\\(\\s*!!\\[\\]\\s*\\)"

  - id: while-not-zero
    desc: while(!0) infinite loop pattern
    crit: notable
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "while\\s*\\(\\s*!0\\s*\\)"

  - id: while-not-space-zero
    desc: while(! 0) infinite loop pattern
    crit: notable
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "while\\s*\\(\\s*!\\s*0\\s*\\)"

  # === String array rotation atomic indicators ===
  - id: push-shift-pattern
    desc: push then shift rotation pattern
    crit: inert
    conf: 0.75
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "push.*shift"

  - id: shift-push-pattern
    desc: shift then push rotation pattern
    crit: inert
    conf: 0.75
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "shift.*push"

  # === Buffer hex encoding atomic indicators ===
  - id: buffer-from-hex-word
    desc: Buffer.from with hex word
    crit: notable
    conf: 0.7
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "Buffer\\.from.*hex"

  - id: buffer-from-hex-single
    desc: Buffer.from with 'hex' string
    crit: notable
    conf: 0.7
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      exact: "Buffer.from.*'hex'"

  - id: buffer-from-hex-double
    desc: Buffer.from with "hex" string
    crit: notable
    conf: 0.7
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      exact: 'Buffer.from.*"hex"'

  # === fromCharCode atomic indicators ===
  - id: string-fromcharcode
    desc: String.fromCharCode method
    crit: notable
    conf: 0.75
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      exact: "String.fromCharCode"

  - id: fromcharcode-call
    desc: fromCharCode( call
    crit: notable
    conf: 0.75
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      exact: "fromCharCode("

  - id: obfuscator-variables
    desc: JavaScript obfuscator tool signature (_0x naming pattern)
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "_0x[a-fA-F0-9]{4,8}"
      min_count: 10
      search_raw: true

  - id: hex-literal-density
    desc: High density of hex literals (obfuscated arithmetic)
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    if:
      type: string
      regex: "0x[a-fA-F0-9]+"
      min_count: 50
      search_raw: true

composite_rules:
  # Infinite loop composite
  - id: infinite-loop
    desc: Obfuscated infinite loop (while(!![]) pattern)
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    for: [javascript]
    count: 1
    any:
      - id: while-not-not-array
      - id: while-not-zero
      - id: while-not-space-zero

  # String array rotation composite
  - id: string-array-rotation
    desc: String array with rotation decoder (obfuscation)
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    count: 1
    any:
      - id: push-shift-pattern
      - id: shift-push-pattern

  # Buffer hex encoding composite
  - id: buffer-hex-encoding
    desc: Buffer with hex encoding (obfuscation)
    crit: suspicious
    conf: 0.8
    attack: "T1027"
    for: [javascript]
    count: 1
    any:
      - id: buffer-from-hex-word
      - id: buffer-from-hex-single
      - id: buffer-from-hex-double

  # fromCharCode composite
  - id: fromCharCode
    desc: String.fromCharCode obfuscation
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    count: 1
    any:
      - id: string-fromcharcode
      - id: fromcharcode-call
