# JavaScript Obfuscator Detection
# Detects signatures of javascript-obfuscator and similar tools
# ATT&CK: T1027 (Obfuscated Files or Information)

traits:
  # === Infinite loop atomic indicators ===
  - id: while-not-not-array
    desc: while(!![]) infinite loop pattern
    crit: notable
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    if:
      type: content


composite_rules:
  # Infinite loop composite
  - id: infinite-loop
    desc: Obfuscated infinite loop (while(!![]) pattern)
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    for: [javascript]
    count_min: 1
    any:
      - id: while-not-not-array
      - id: while-not-zero
      - id: while-not-space-zero

  # String array rotation composite
  - id: string-array-rotation
    desc: String array with rotation decoder (obfuscation)
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    count_min: 1
    any:
      - id: push-shift-pattern
      - id: shift-push-pattern

  # Buffer hex encoding composite
  - id: buffer-hex-encoding
    desc: Buffer with hex encoding (obfuscation)
    crit: suspicious
    conf: 0.8
    attack: "T1027"
    for: [javascript]
    count_min: 1
    any:
      - id: buffer-from-hex-word
      - id: buffer-from-hex-single
      - id: buffer-from-hex-double

  # fromCharCode composite
  - id: fromCharCode
    desc: String.fromCharCode obfuscation
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript]
    count_min: 1
    any:
      - id: string-fromcharcode
      - id: fromcharcode-call
