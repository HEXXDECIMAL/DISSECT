# Large Obfuscated Payload Detection - Python
# Detects large blobs of encoded data embedded in scripts
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # === Hex decoding functions ===
  - id: binascii-unhexlify
    desc: Hex decoding via binascii.unhexlify
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1140"
    for: [python]
    if:
      type: content
      substr: "binascii.unhexlify"

  - id: unhexlify-import
    desc: unhexlify function import
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1140"
    for: [python]
    if:
      type: content
      regex: "from\\s+binascii\\s+import.{0,50}unhexlify"

  # === Content-based exec/eval detection ===
  # These use content: instead of string: to match function calls in source
  - id: exec-function-call
    desc: exec() function call
    crit: notable
    conf: 0.7
    mbc: "E1059"
    attack: "T1059"
    for: [python]
    if:
      type: content
      regex: "exec\\s*\\("

  - id: eval-function-call
    desc: eval() function call
    crit: notable
    conf: 0.7
    mbc: "E1059"
    attack: "T1059"
    for: [python]
    if:
      type: content
      regex: "eval\\s*\\("

  # Large base64-like string (512+ chars)
  - id: large-base64-string
    desc: Large base64-like string (512+ chars)
    crit: notable
    conf: 0.75
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "[A-Za-z0-9+/]{512,}"

  # Large hex string (1024+ chars)
  - id: large-hex-string
    desc: Large hex-encoded string (1024+ chars)
    crit: notable
    conf: 0.75
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "[0-9a-fA-F]{1024,}"

  # exec() with decode pattern
  - id: exec-decode-pattern
    desc: exec() with decode chain (payload
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "exec\\s*\\([^)]*decode\\s*\\("

  # eval() with decode pattern
  - id: eval-decode-pattern
    desc: eval() with decode chain (payload
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "eval\\s*\\([^)]*decode\\s*\\("

  # compile() with exec pattern
  - id: compile-exec-pattern
    desc: compile() with exec (dynamic code
    crit: suspicious
    conf: 0.8
    attack: "T1027"
    for: [python]
    if:
      type: string
      regex: "compile\\s*\\([^)]+,\\s*['\"][^'\"]+['\"]\\s*,\\s*['\"]exec['\"]\\s*\\)"

composite_rules:
  # === Hex decode execution patterns ===
  # exec(binascii.unhexlify(...)) - classic malware obfuscation
  # Complexity: file_types(+1) + all(+2) + any(+1) = 4
  - id: exec-unhexlify
    desc: Execute hex-decoded payload
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    file_types: [python]
    all:
      - id: exec-function-call
      - id: binascii-unhexlify
    any:
      - id: unhexlify-import
      - id: anti-static/obfuscation/code-metrics/low-whitespace

  # Large encoded string composite (migrated from YARA)
  - id: large-encoded-string
    desc: Large high-entropy string literal (likely
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [python]
    count_min: 1
    any:
      - id: large-base64-string
      - id: large-hex-string

  # Payload execution composite
  - id: payload-execution
    desc: Large encoded payload with dynamic
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [python]
    all:
      - id: large-encoded-string
    any:
      - id: exec-decode-pattern
      - id: eval-decode-pattern
      - id: compile-exec-pattern
