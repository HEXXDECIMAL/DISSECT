# Cipher-based Obfuscation Detection
# Detects RC4, custom XOR ciphers, and table-based encoding in binaries
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for: [elf, pe, macho, dll, so, dylib]
  attack: "T1027"

traits:
  - id: rc4-sbox-init
    desc: "RC4 S-box initialization pattern (256-byte permutation)"
    crit: notable
    conf: 0.6
    mbc: "C0027.001"
    if:
      type: yara
      source: |
        rule rc4_sbox_init {
          meta:
            description = "RC4 S-box initialization (256 iterations)"
          strings:
            // Common: mov reg, 256 or cmp reg, 256
            $x86_256_mov = { B? 00 01 00 00 }
            $x86_256_cmp = { 81 F? 00 01 00 00 }
            // Sequential bytes 0-255 in data (initialized S-box)
            $sbox_partial = { 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F }
          condition:
            $sbox_partial or ($x86_256_mov and $x86_256_cmp)
        }

  - id: cipher-key-schedule
    desc: "Cipher key schedule function"
    crit: notable
    conf: 0.7
    mbc: "C0027"
    if:
      type: symbol
      pattern: "key_schedule|ksa|init_key|setup_key|expand_key"

  - id: stream-cipher-decrypt
    desc: "Stream cipher decryption function"
    crit: notable
    conf: 0.6
    mbc: "C0027"
    if:
      type: symbol
      pattern: "stream_decrypt|prga|rc4_crypt|arc4|cipher_stream"

  - id: hardcoded-hex-charset
    desc: "Hardcoded hex encoding charset (encoding/decoding)"
    crit: notable
    conf: 0.5
    mbc: "C0026"
    if:
      type: string
      exact: "0123456789abcdef"

  - id: hardcoded-base64-charset
    desc: "Hardcoded Base64 charset"
    crit: notable
    conf: 0.4
    mbc: "C0026"
    if:
      type: string
      regex: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\\+/"

composite_rules:
  - id: rc4-cipher
    desc: "RC4 or RC4-like stream cipher detected"
    crit: notable
    conf: 0.7
    mbc: "C0027.001"
    any:
      - id: anti-static/obfuscation/encoding/rc4-sbox-init
      - id: anti-static/obfuscation/encoding/stream-cipher-decrypt
      - id: anti-static/obfuscation/encoding/cipher-key-schedule
      - id: anti-static/obfuscation/encoding/hardcoded-hex-charset

    count: 1