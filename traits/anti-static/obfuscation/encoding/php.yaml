# PHP Anti-Static Analysis / Obfuscation Traits
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  - id: base64-decode
    desc: Base64 decoding (potential payload)
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1140"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "base64_decode"

  - id: base64-encode
    desc: Base64 encoding
    crit: inert
    conf: 0.6
    for: [php]
    if:
      type: ast
      kind: call
      exact: "base64_encode"

  - id: gzinflate
    desc: Gzip decompression (packed payload)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    attack: "T1140"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "gzinflate"

  - id: gzuncompress
    desc: Zlib decompression (packed payload)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    attack: "T1140"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "gzuncompress"

  - id: gzdecode
    desc: Gzip decoding (packed payload)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    attack: "T1140"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "gzdecode"

  - id: rot13
    desc: ROT13 encoding/decoding
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "str_rot13"

  - id: chr-ord
    desc: Character code manipulation
    crit: notable
    conf: 0.65
    mbc: "B0032"
    for: [php]
    if:
      type: ast
      kind: call
      regex: "chr|ord"

  - id: eval
    desc: Dynamic code execution via eval
    crit: suspicious
    conf: 0.95
    mbc: "E1059"
    attack: "T1059"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "eval"

  - id: create-function
    desc: Dynamic function creation (deprecated, often
    crit: suspicious
    conf: 0.9
    mbc: "E1059"
    attack: "T1059"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "create_function"

  - id: preg-replace-e
    desc: preg_replace with /e modifier (code
    crit: suspicious
    conf: 0.95
    mbc: "E1059"
    attack: "T1059"
    for: [php]
    if:
      type: ast
      kind: call
      regex: "preg_replace\\s*\\(['\"][^'\"]*\\/[a-zA-Z]*e[a-zA-Z]*['\"]"

  - id: assert-dynamic
    desc: Assert with dynamic code (code
    crit: suspicious
    conf: 0.85
    mbc: "E1059"
    attack: "T1059"
    for: [php]
    if:
      type: ast
      kind: call
      exact: "assert"

  - id: xor-string
    desc: XOR string manipulation (obfuscation)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    if:
      type: ast
      kind: binary_op
      regex: "\\^"

  - id: xor-loop
    desc: Loop performing XOR on user
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    if:
      type: ast
      node: for_statement
      regex: "\\^="

  - id: strrev
    desc: String reversal (obfuscation)
    crit: notable
    conf: 0.7
    mbc: "B0032"
    if:
      type: ast
      kind: call
      exact: "strrev"

  - id: hex2bin
    desc: Hex to binary conversion (obfuscation)
    crit: notable
    conf: 0.75
    mbc: "B0032"
    if:
      type: ast
      kind: call
      exact: "hex2bin"

  - id: bin2hex
    desc: Binary to hex conversion (obfuscation)
    crit: notable
    conf: 0.75
    mbc: "B0032"
    if:
      type: ast
      kind: call
      exact: "bin2hex"

  - id: substitution-cipher
    desc: Potential substitution cipher (obfuscation)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    if:
      type: ast
      kind: call
      regex: "str_replace\\s*\\(\\s*array\\s*\\([^)]+\\)\\s*,\\s*array\\s*\\([^)]+\\)"

  - id: pack
    desc: Packs data into binary string
    crit: notable
    conf: 0.7
    if:
      type: ast
      kind: call
      exact: "pack"

  - id: unpack
    desc: Unpacks data from binary string
    crit: notable
    conf: 0.7
    if:
      type: ast
      kind: call
      exact: "unpack"

  - id: variable-function-call
    desc: Variable function call (obfuscation)
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    if:
      type: ast
      kind: call
      regex: "^(\\$|\\{).{0,50}\\("

  - id: dynamic-variable-call
    desc: Dynamic variable function call (e.g.
    crit: suspicious
    conf: 0.95
    if:
      type: ast
      kind: call
      regex: "\\$\\{.{0,50}\\}"

  - id: dynamic-superglobal-call
    desc: Superglobal used as function (obfuscated
    crit: suspicious
    conf: 0.98
    mbc: "B0032"
    if:
      type: ast
      kind: call
      regex: "\\$_(GET|POST|REQUEST|COOKIE|SERVER)"

  - id: subscript-function-call
    desc: Subscript used as function (obfuscated
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    if:
      type: ast
      kind: call
      regex: "\\$\\w+\\s*\\[[^]]+\\]\\s*\\("

  - id: simple-variable-call
    desc: Variable used as function (obfuscated
    crit: suspicious
    conf: 0.8
    mbc: "B0032"
    if:
      type: ast
      kind: call
      regex: "\\$\\w+\\s*\\("

  - id: dynamic-superglobal-simple
    desc: Superglobal used as function (obfuscated
    crit: suspicious
    conf: 0.98
    mbc: "B0032"
    if:
      type: ast
      kind: call
      regex: "\\$_(GET|POST|REQUEST|COOKIE|SERVER)"
