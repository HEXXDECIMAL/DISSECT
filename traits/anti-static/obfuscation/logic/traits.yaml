# Obfuscation Logic Detection
# Detects common obfuscation/deobfuscation code patterns in binaries
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # Stack string construction pattern - 5+ mov [rbp-x], imm8 in sequence
  # Pattern: C6 45 XX YY (mov byte ptr [rbp-XX], YY)
  - id: stack-string-construction
    desc: Stack string construction pattern (5+
    crit: inert
    conf: 0.4
    attack: "T1027"
    for: [elf, macho, pe]
    if:
      type: hex
      pattern: "C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ??"

  # XOR decryption loop pattern
  - id: xor-loop-pattern
    desc: XOR decryption loop pattern
    crit: inert
    conf: 0.4
    attack: "T1027"
    for: [elf, macho, pe]
    if:
      type: hex
      # xor reg, reg; inc/add; cmp; jne loop
      pattern: "30 ?? ?? ?? ?? ?? E2"

composite_rules:
  # String obfuscation composite (migrated from YARA)
  - id: string-deobfuscation
    desc: String obfuscation/deobfuscation pattern
    crit: inert
    conf: 0.4
    attack: "T1027"
    for: [elf, macho, pe]
    count_min: 1
    any:
      - id: stack-string-construction
      - id: xor-loop-pattern
