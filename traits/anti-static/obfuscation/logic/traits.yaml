# Obfuscation Logic Detection
# Detects common obfuscation/deobfuscation code patterns in binaries

traits:
  - id: string-deobfuscation
    desc: "String obfuscation/deobfuscation pattern"
    crit: notable
    conf: 0.65
    attack: "T1027"
    for: [elf, macho, pe]
    if:
      type: yara
      source: |
        rule string_obfuscation {
          strings:
            // XOR deobfuscation loop
            $xor1 = { 30 ?? 4? FF C? 3? ?? 7? }  // xor byte, inc, cmp, jl
            $xor2 = { 32 ?? 4? 83 ?? ?? 7? }     // xor byte, inc, cmp, jl
            // Stack string construction
            $stack1 = { C6 45 ?? ?? C6 45 ?? ?? C6 45 ?? ?? }  // mov [rbp-x], imm8
            $stack2 = { C7 45 ?? ?? ?? ?? ?? C7 45 ?? ?? ?? ?? ?? }  // mov [rbp-x], imm32
          condition:
            any of them
        }
