# PHP-Specific Metrics-Based Obfuscation Detection
# Detects PHP webshell and malware obfuscation patterns

defaults:
  file_types: [php]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === PHP-Specific Obfuscation Patterns ===

  - id: anti-static/obfuscation/code-metrics/php-encoded-strings
    description: "High entropy strings (base64/gzinflate encoded)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: strings.avg_entropy
      min: 4.5

  - id: anti-static/obfuscation/code-metrics/php-obfuscated-vars
    description: "Obfuscated PHP variable names"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: metrics
      field: identifiers.avg_entropy
      min: 3.2

  - id: anti-static/obfuscation/code-metrics/php-single-long-line
    description: "Single very long line (webshell pattern)"
    criticality: suspicious
    confidence: 0.9
    condition:
      type: metrics
      field: text.max_line_length
      min: 1000

  - id: anti-static/obfuscation/code-metrics/php-many-short-functions
    description: "Many short functions (deobfuscation layers)"
    criticality: notable
    confidence: 0.75
    condition:
      type: metrics
      field: functions.one_liners
      min: 8

  - id: anti-static/obfuscation/code-metrics/php-non-ascii-identifiers
    description: "Many non-ASCII identifiers (obfuscation)"
    criticality: suspicious
    confidence: 0.9
    condition:
      type: metrics
      field: identifiers.avg_entropy
      min: 0.8

  - id: anti-static/obfuscation/code-metrics/php-high-non-ascii-ratio
    description: "High non-ASCII byte ratio (packed/obfuscated)"
    criticality: hostile
    confidence: 0.95
    condition:
      type: metrics
      field: text.non_ascii_ratio
      min: 0.5

  - id: anti-static/obfuscation/code-metrics/php-non-ascii-call
    description: "Function call with non-ASCII name (obfuscation)"
    criticality: hostile
    confidence: 0.98
    condition:
      type: ast_pattern
      node_type: function_call_expression
      pattern: "[^\\x00-\\x7F]"
      regex: true

  - id: anti-static/obfuscation/code-metrics/php-non-ascii-variable
    description: "Variable with non-ASCII name (obfuscation)"
    criticality: hostile
    confidence: 0.98
    condition:
      type: ast_pattern
      node_type: variable_name
      pattern: "[^\\x00-\\x7F]"
      regex: true

  - id: anti-static/obfuscation/code-metrics/php-non-ascii-name
    description: "Identifier with non-ASCII characters (obfuscation)"
    criticality: hostile
    confidence: 0.98
    condition:
      type: ast_pattern
      node_type: name
      pattern: "[^\\x00-\\x7F]"
      regex: true

  - id: anti-static/obfuscation/code-metrics/php-non-ascii-subscript
    description: "Subscript with non-ASCII characters (obfuscation)"
    criticality: hostile
    confidence: 0.98
    condition:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "[^\\x00-\\x7F]"
      regex: true

composite_rules:
  - id: anti-static/obfuscation/php-webshell-pattern
    description: "PHP webshell obfuscation pattern"
    criticality: hostile
    confidence: 0.9
    requires_count: 2
    conditions:
      - type: trait
        id: php-encoded-strings
      - type: trait
        id: php-single-long-line
      - type: trait
        id: php-obfuscated-vars
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments

  - id: anti-static/obfuscation/php-encoded-payload
    description: "PHP with encoded payload"
    criticality: suspicious
    confidence: 0.85
    requires_all:
      - type: trait
        id: php-encoded-strings
    requires_any:
      - type: trait
        id: php-obfuscated-vars
      - type: trait
        id: php-many-short-functions
