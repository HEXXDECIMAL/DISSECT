# PHP-Specific Metrics-Based Obfuscation Detection
# Detects PHP webshell and malware obfuscation patterns

defaults:
  for: [php]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === PHP-Specific Obfuscation Patterns ===

  - id: php-encoded-strings
    desc: "High entropy strings (base64/gzinflate encoded)"
    crit: suspicious
    conf: 0.85
    file_types: [php]
    if:
      type: metrics
      field: strings.avg_entropy
      min: 4.5

  - id: php-obfuscated-vars
    desc: "Obfuscated PHP variable names"
    crit: suspicious
    conf: 0.8
    file_types: [php]
    if:
      type: metrics
      field: identifiers.avg_entropy
      min: 3.2

  - id: php-single-long-line
    desc: "Single very long line (webshell"
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: text.max_line_length
      min: 1000

  - id: php-many-short-functions
    desc: "Many short functions (deobfuscation layers)"
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: functions.one_liners
      min: 8

  - id: php-non-ascii-identifiers
    desc: "Many non-ASCII identifiers (obfuscation)"
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: identifiers.avg_entropy
      min: 0.8

  - id: php-high-non-ascii-ratio
    desc: "High non-ASCII byte ratio (packed/obfuscated)"
    crit: suspicious
    conf: 0.95
    if:
      type: metrics
      field: text.non_ascii_ratio
      min: 0.5

  - id: php-non-ascii-call
    desc: "Function call with non-ASCII name"
    crit: suspicious
    conf: 0.98
    if:
      type: ast
      kind: call
      regex: "[^\\x00-\\x7F]"

  - id: php-non-ascii-variable
    desc: "Variable with non-ASCII name (obfuscation)"
    crit: suspicious
    conf: 0.98
    if:
      type: ast
      node: variable_name
      regex: "[^\\x00-\\x7F]"

  - id: php-non-ascii-name
    desc: "Identifier with non-ASCII characters (obfuscation)"
    crit: suspicious
    conf: 0.98
    if:
      type: ast
      node: name
      regex: "[^\\x00-\\x7F]"

  - id: php-non-ascii-subscript
    desc: "Subscript with non-ASCII characters (obfuscation)"
    crit: suspicious
    conf: 0.98
    if:
      type: ast
      node: subscript_expression
      regex: "[^\\x00-\\x7F]"

composite_rules:
  - id: php-webshell-pattern
    desc: "PHP webshell pattern detected"
    crit: suspicious
    conf: 0.95
    count_min: 2
    any:
      - id: anti-static/obfuscation/code-metrics/php-encoded-strings
      - id: anti-static/obfuscation/code-metrics/php-single-long-line
      - id: anti-static/obfuscation/code-metrics/php-obfuscated-vars
      - id: anti-static/obfuscation/code-metrics/no-comments

  - id: php-encoded-payload
    desc: "PHP with encoded payload"
    crit: suspicious
    conf: 0.85
    all:
      - id: anti-static/obfuscation/code-metrics/php-encoded-strings
    any:
      - id: anti-static/obfuscation/code-metrics/php-obfuscated-vars
      - id: anti-static/obfuscation/code-metrics/php-many-short-functions
