# PowerShell-Specific Metrics-Based Obfuscation Detection
# Detects PowerShell obfuscation patterns used in malware

defaults:
  file_types: [powershell]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === PowerShell-Specific Obfuscation Patterns ===

  - id: ps-encoded-commands
    description: "High entropy strings (encoded PowerShell payloads)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: strings.avg_entropy
      min: 4.0

  - id: ps-obfuscated-vars
    description: "Obfuscated PowerShell variable names"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: metrics
      field: identifiers.avg_entropy
      min: 3.0

  - id: ps-single-line-script
    description: "Single long line PowerShell (encoded command)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: text.max_line_length
      min: 500

  - id: ps-many-single-char
    description: "Many single-character variables"
    criticality: notable
    confidence: 0.75
    condition:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.35

  - id: ps-no-comments
    description: "No comments in PowerShell script"
    criticality: notable
    confidence: 0.6
    condition:
      type: metrics
      field: comments.total
      max: 0

composite_rules:
  - id: ps-invoke-obfuscation
    description: "Invoke-Obfuscation tool output pattern"
    criticality: hostile
    confidence: 0.9
    requires_count: 2
    conditions:
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-encoded-commands
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-obfuscated-vars
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-single-line-script
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-many-single-char

  - id: ps-encoded-downloader
    description: "Encoded PowerShell downloader"
    criticality: hostile
    confidence: 0.9
    requires_all:
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-encoded-commands
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-no-comments
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-single-line-script
      - type: trait
        id: anti-static/obfuscation/code-metrics/ps-obfuscated-vars
