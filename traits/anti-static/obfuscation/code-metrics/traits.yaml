# Code Metrics-Based Obfuscation Detection
# Detects obfuscation patterns via statistical analysis of code structure
# ATT&CK: T1027 (Obfuscated Files or Information)

defaults:
  for:
    [
      python,
      javascript,
      typescript,
      shell,
      php,
      ruby,
      perl,
      go,
      rust,
      java,
      lua,
      csharp,
      powershell,
    ]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === Identifier Obfuscation ===

  - id: high-entropy-identifiers
    desc: "High entropy identifiers (random-looking variable"
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: identifiers.avg_entropy
      min: 2.5

  - id: many-high-entropy-identifiers
    desc: "Many high-entropy identifiers (>20% have"
    crit: suspicious
    conf: 0.9
    if:
      type: metrics
      field: identifiers.high_entropy_ratio
      min: 0.20

  - id: excessive-single-char-vars
    desc: "Excessive single-character variable names (>30%)"
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.30

  - id: numeric-suffix-identifiers
    desc: "Many numeric suffix identifiers (var1,"
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: identifiers.numeric_suffix_count
      min: 5

  - id: sequential-identifiers
    desc: "Sequential identifiers (a, b, c,"
    crit: notable
    conf: 0.8
    if:
      type: metrics
      field: identifiers.sequential_names
      min: 5

  - id: low-identifier-reuse
    desc: "Low identifier reuse (each variable"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: identifiers.reuse_ratio
      max: 0.15

  # === Function Obfuscation ===

  - id: high-entropy-function-names
    desc: "Functions with random-looking names"
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: functions.high_entropy_names
      min: 3

  - id: single-char-function-names
    desc: "Functions with single-character names"
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: functions.single_char_names
      min: 3

  - id: many-anonymous-functions
    desc: "Many anonymous functions"
    crit: notable
    conf: 0.75
    for: [javascript, typescript, python, ruby]
    if:
      type: metrics
      field: functions.anonymous
      min: 5

  - id: high-function-density
    desc: "High function density (>20 functions"
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: functions.density_per_100_lines
      min: 20
      min_size: 1024

  - id: many-one-liner-functions
    desc: "Many one-liner functions (minified code"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.one_liners
      min: 5

  - id: deep-nesting
    desc: "Deeply nested functions (complexity indicator)"
    crit: notable
    conf: 0.75
    if:
      type: metrics
      field: functions.max_nesting_depth
      min: 5

  - id: single-char-params
    desc: "Many single-character parameter names"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.single_char_params
      min: 10

  # === String Obfuscation ===

  - id: high-entropy-strings
    desc: "High entropy strings (encoded/encrypted data)"
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: strings.avg_entropy
      min: 4.0

  # NOTE: Small/simple programs legitimately have few strings.
  # Only meaningful combined with other obfuscation indicators.
  - id: few-strings
    desc: "Very few string literals (string"
    crit: inert
    conf: 0.4
    if:
      type: metrics
      field: strings.total
      max: 5
      min_size: 1024

  # === Code Structure Anomalies ===

  - id: no-comments
    desc: "No comments in code (stripped"
    crit: notable
    conf: 0.6
    if:
      type: metrics
      field: comments.total
      max: 0
      min_size: 2048

  - id: very-low-comment-ratio
    desc: "Very low comment-to-code ratio (<1%)"
    crit: notable
    conf: 0.65
    if:
      type: metrics
      field: comments.to_code_ratio
      max: 0.01
      min_size: 2048

  - id: very-long-lines
    desc: "Very long lines (>500 chars"
    crit: suspicious
    conf: 0.85
    if:
      type: metrics
      field: text.max_line_length
      min: 500

  - id: high-text-entropy
    desc: "High overall text entropy (encoded"
    crit: suspicious
    conf: 0.8
    if:
      type: metrics
      field: text.char_entropy
      min: 5.5

  - id: low-whitespace
    desc: "Very low whitespace ratio (minified/compressed)"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: text.whitespace_ratio
      max: 0.10

  # === Complexity Anomalies ===

  - id: monster-function
    desc: "Extremely large function (>500 lines)"
    crit: notable
    conf: 0.8
    if:
      type: metrics
      field: functions.over_500_lines
      min: 1

  - id: many-large-functions
    desc: "Multiple very large functions (>100"
    crit: notable
    conf: 0.7
    if:
      type: metrics
      field: functions.over_100_lines
      min: 5

  - id: many-params
    desc: "Functions with excessive parameters (>7)"
    crit: notable
    conf: 0.65
    if:
      type: metrics
      field: functions.many_params_count
      min: 3

composite_rules:
  # === Combined Obfuscation Detection ===

  - id: minified-code
    desc: "Minified/compressed code (multiple indicators)"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    count_min: 3
    any:
      - id: anti-static/obfuscation/code-metrics/high-function-density
      - id: anti-static/obfuscation/code-metrics/many-one-liner-functions
      - id: anti-static/obfuscation/code-metrics/very-long-lines
      - id: anti-static/obfuscation/code-metrics/low-whitespace
      - id: anti-static/obfuscation/code-metrics/no-comments
      - id: anti-static/obfuscation/code-metrics/sequential-identifiers

  - id: identifier-obfuscation
    desc: "Identifier obfuscation (random/encoded names)"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    count_min: 2
    any:
      - id: anti-static/obfuscation/code-metrics/high-entropy-identifiers
      - id: anti-static/obfuscation/code-metrics/many-high-entropy-identifiers
      - id: anti-static/obfuscation/code-metrics/high-entropy-function-names
      - id: anti-static/obfuscation/code-metrics/low-identifier-reuse

  - id: generated-code
    desc: "Machine-generated or transformed code"
    crit: notable
    conf: 0.85
    attack: "T1027"
    count_min: 2
    any:
      - id: anti-static/obfuscation/code-metrics/numeric-suffix-identifiers
      - id: anti-static/obfuscation/code-metrics/single-char-function-names
      - id: anti-static/obfuscation/code-metrics/excessive-single-char-vars
      - id: anti-static/obfuscation/code-metrics/single-char-params

  - id: string-hiding
    desc: "String concealment/encoding"
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    all:
      - id: anti-static/obfuscation/code-metrics/high-entropy-strings
    any:
      - id: anti-static/obfuscation/code-metrics/few-strings
      - id: anti-static/obfuscation/code-metrics/high-text-entropy
