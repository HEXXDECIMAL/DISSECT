# Shell-Specific Metrics-Based Obfuscation Detection
# Detects shell script obfuscation patterns

defaults:
  file_types: [shell]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === Shell-Specific Obfuscation Patterns ===

  - id: sh-single-char-vars
    description: "Excessive single-character variables in shell"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: metrics
      field: identifiers.single_char_ratio
      min: 0.40

  - id: sh-obfuscated-identifiers
    description: "Obfuscated shell variable names"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: identifiers.avg_entropy
      min: 3.0

  - id: sh-encoded-payload
    description: "Shell script with encoded payload strings"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: strings.avg_entropy
      min: 4.0

  - id: sh-long-lines
    description: "Very long shell lines (compressed/obfuscated)"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: metrics
      field: text.max_line_length
      min: 300

  - id: sh-no-functions
    description: "No shell functions (inline obfuscation)"
    criticality: notable
    confidence: 0.6
    condition:
      type: metrics
      field: functions.total
      max: 0

composite_rules:
  - id: sh-encoded-dropper
    description: "Shell script with encoded payload dropper"
    criticality: hostile
    confidence: 0.9
    requires_all:
      - type: trait
        id: anti-static/obfuscation/code-metrics/sh-encoded-payload
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/sh-long-lines
      - type: trait
        id: anti-static/obfuscation/code-metrics/sh-obfuscated-identifiers

  - id: sh-compact-malware
    description: "Compacted shell malware pattern"
    criticality: suspicious
    confidence: 0.85
    requires_count: 2
    conditions:
      - type: trait
        id: anti-static/obfuscation/code-metrics/sh-single-char-vars
      - type: trait
        id: anti-static/obfuscation/code-metrics/sh-long-lines
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments
      - type: trait
        id: anti-static/obfuscation/code-metrics/sh-no-functions
