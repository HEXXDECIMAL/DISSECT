# Python-Specific Metrics-Based Obfuscation Detection
# Detects Python obfuscation patterns common in PyPI malware

defaults:
  file_types: [python]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === Python-Specific Obfuscation Patterns ===

  - id: py-lambda-abuse
    description: "Excessive lambda functions (obfuscation via lambdas)"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: metrics
      field: functions.anonymous
      min: 15

  - id: py-single-line-heavy
    description: "Many one-liner functions (compressed code)"
    criticality: notable
    confidence: 0.75
    condition:
      type: metrics
      field: functions.one_liners
      min: 10

  - id: py-nested-functions
    description: "Nested function definitions (closure obfuscation)"
    criticality: notable
    confidence: 0.7
    condition:
      type: metrics
      field: functions.nested_functions
      min: 5

  - id: py-encoded-strings
    description: "High string entropy (base64/hex encoded payloads)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: strings.avg_entropy
      min: 4.5

composite_rules:
  - id: py-pyobfuscate-pattern
    description: "Python obfuscator tool output"
    criticality: suspicious
    confidence: 0.85
    requires_count: 2
    conditions:
      - type: trait
        id: anti-static/obfuscation/code-metrics/high-entropy-identifiers
      - type: trait
        id: anti-static/obfuscation/code-metrics/py-lambda-abuse
      - type: trait
        id: anti-static/obfuscation/code-metrics/py-encoded-strings
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments

  - id: py-pypi-malware-pattern
    description: "PyPI malware obfuscation pattern"
    criticality: hostile
    confidence: 0.9
    requires_all:
      - type: trait
        id: anti-static/obfuscation/code-metrics/py-encoded-strings
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/single-char-function-names
      - type: trait
        id: anti-static/obfuscation/code-metrics/high-entropy-identifiers
