# JavaScript-Specific Metrics-Based Obfuscation Detection
# Detects JS obfuscation patterns common in npm malware and web exploits

defaults:
  file_types: [javascript, typescript]
  attack: "T1027"
  mbc: "B0032"

traits:
  # === JavaScript-Specific Obfuscation Patterns ===

  - id: js-arrow-function-abuse
    description: "Excessive anonymous arrow functions (obfuscation pattern)"
    criticality: suspicious
    confidence: 0.8
    condition:
      type: metrics
      field: functions.anonymous
      min: 20

  - id: js-iife-heavy
    description: "High function density with one-liners (IIFE obfuscation)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: metrics
      field: functions.density_per_100_lines
      min: 15

  - id: js-deep-callback-nesting
    description: "Deep function nesting (callback hell or obfuscation)"
    criticality: notable
    confidence: 0.75
    condition:
      type: metrics
      field: functions.max_nesting_depth
      min: 6

  - id: js-webpack-minified
    description: "Webpack/bundler minified output pattern"
    criticality: notable
    confidence: 0.7
    condition:
      type: metrics
      field: text.max_line_length
      min: 1000

composite_rules:
  - id: js-obfuscator-pattern
    description: "JavaScript obfuscator tool output"
    criticality: suspicious
    confidence: 0.9
    requires_count: 3
    conditions:
      - type: trait
        id: anti-static/obfuscation/code-metrics/high-entropy-identifiers
      - type: trait
        id: anti-static/obfuscation/code-metrics/js-arrow-function-abuse
      - type: trait
        id: anti-static/obfuscation/code-metrics/high-entropy-strings
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments

  - id: js-npm-malware-pattern
    description: "npm malware obfuscation pattern (install script)"
    criticality: hostile
    confidence: 0.9
    requires_all:
      - type: trait
        id: anti-static/obfuscation/code-metrics/high-entropy-identifiers
      - type: trait
        id: anti-static/obfuscation/code-metrics/no-comments
    requires_any:
      - type: trait
        id: anti-static/obfuscation/code-metrics/js-webpack-minified
      - type: trait
        id: anti-static/obfuscation/code-metrics/very-long-lines
