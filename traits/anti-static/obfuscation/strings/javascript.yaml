# String Obfuscation Detection - JavaScript
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # fromCharCode obfuscation - using AST
  - id: fromcharcode
    desc: String obfuscation via fromCharCode
    crit: notable
    conf: 0.66
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "fromCharCode"

  # Unicode escape sequences used to hide strings
  - id: js-unicode-escape
    desc: Unicode escape sequences used to
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\u[0-9a-fA-F]{4}){4,}'

  # Hex escape sequences
  - id: js-hex-escape
    desc: Hex escape sequences used to
    crit: notable
    conf: 0.75
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\x[0-9a-fA-F]{2}){4,}'

  # Buffer.from with encoding (atomic)
  - id: js-buffer-from-base64
    desc: Buffer.from with base64 encoding
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\([^,]+,\\s*['\"]base64['\"]\\)"

  - id: js-buffer-from-hex
    desc: Buffer.from with hex encoding
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\([^,]+,\\s*['\"]hex['\"]\\)"

  # === Hex URL array micro-traits ===
  - id: hex-const-array
    desc: Const array containing long hex
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "const\\s+\\w+\\s*=\\s*\\[\\s*['\"][0-9a-fA-F]{20,}['\"]"

  - id: array-map-call
    desc: Array .map() call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: ".map("

  - id: buffer-from-call
    desc: Buffer.from call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "Buffer.from"

  - id: hex-encoding-string
    desc: hex encoding string literal
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      regex: "['\"]hex['\"]"

  - id: array-join-call
    desc: Array .join() call
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: ".join("

  # === Remote fetch micro-traits ===
  - id: https-get-call
    desc: https.get() call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "https.get"

  - id: http-get-call
    desc: http.get() call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "http.get"

  - id: underscore-fetch-call
    desc: _fetch() internal call
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      exact: "_fetch"

  - id: base64-encoding-string
    desc: base64 encoding string literal
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      regex: "['\"]base64['\"]"

  - id: trim-call
    desc: .trim() call
    crit: inert
    conf: 0.4
    for: [javascript, typescript]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: ".trim()"

  # Array join obfuscation
  - id: js-array-join
    desc: Array join pattern used to
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\[['\"][^'\"]+['\"](?:,\\s*['\"][^'\"]+['\"]){5,}\\]\\.join"

  # Dynamic code execution patterns (atomic) - using AST
  - id: js-eval-call
    desc: eval() call
    crit: inert
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: ast_query
      language: javascript
      query: |
        (call_expression
          function: (identifier) @fn)
        (#eq? @fn "eval")

  - id: js-function-call
    desc: Function() constructor
    crit: inert
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "Function("

  - id: js-new-function
    desc: new Function constructor
    crit: inert
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: ast_query
      language: javascript
      query: |
        (new_expression
          constructor: (identifier) @fn)
        (#eq? @fn "Function")

  # Dynamic require with variable (non-literal) argument
  - id: js-dynamic-require-call
    desc: Dynamic require with non-literal module
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: 'require\([^"'']'

composite_rules:
  # Buffer decode composite
  - id: js-buffer-decode
    desc: Buffer.from used to decode strings
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: js-buffer-from-base64
      - id: js-buffer-from-hex

  # Dynamic exec composite
  - id: js-dynamic-exec
    desc: Dynamic code execution via eval
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: js-eval-call
      - id: js-function-call
      - id: js-new-function

  # HTTP get composite
  - id: http-get
    desc: HTTP/HTTPS GET request
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: https-get-call
      - id: http-get-call
      - id: underscore-fetch-call

  # Hex URL array (migrated from YARA)
  - id: hex-url-array
    desc: Hex-encoded URL stored as array
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: hex-const-array
      - id: array-map-call
      - id: buffer-from-call
      - id: hex-encoding-string
      - id: array-join-call

  # Remote base64 decode (migrated from YARA)
  - id: remote-base64-decode
    desc: Fetches remote content and decodes
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: http-get
      - id: buffer-from-call
      - id: base64-encoding-string
      - id: trim-call

  # Unicode obfuscation with execution
  - id: js-unicode-exec
    desc: Unicode obfuscated string executed (evasion)
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: js-unicode-escape
      - id: js-dynamic-exec
      - id: fromcharcode

  # Dynamic require with obfuscation
  - id: js-dynamic-require
    desc: Dynamic require with obfuscated module
    crit: suspicious
    conf: 0.85
    all:
      - id: js-dynamic-require-call
      - id: js-unicode-escape
