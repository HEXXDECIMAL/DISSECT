# String Obfuscation Detection - JavaScript
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

traits:
  # fromCharCode obfuscation
  - id: fromcharcode
    desc: String obfuscation via fromCharCode
    crit: notable
    conf: 0.66
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      exact: fromCharCode

  # Unicode escape sequences used to hide strings
  - id: js-unicode-escape
    desc: Unicode escape sequences used to hide strings
    crit: suspicious
    conf: 0.85
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\u[0-9a-fA-F]{4}){4,}'

  # Hex escape sequences
  - id: js-hex-escape
    desc: Hex escape sequences used to hide strings
    crit: notable
    conf: 0.75
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      regex: '(\\x[0-9a-fA-F]{2}){4,}'

  # Buffer.from with encoding (atomic)
  - id: js-buffer-from-base64
    desc: Buffer.from with base64 encoding
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\([^,]+,\\s*['\"]base64['\"]\\)"

  - id: js-buffer-from-hex
    desc: Buffer.from with hex encoding
    crit: inert
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\([^,]+,\\s*['\"]hex['\"]\\)"

  # Hex-encoded URL in array (common npm malware pattern)
  # Pattern: array of hex strings that decode to URL parts
  - id: hex-url-array
    desc: Hex-encoded URL stored as array elements (C2 obfuscation)
    crit: suspicious
    conf: 0.9
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule hex_url_array {
          strings:
            // Array containing hex strings (each 20+ chars = at least 10 bytes)
            $arr1 = /const\s+\w+\s*=\s*\[\s*"[0-9a-fA-F]{20,}"/ ascii
            $arr2 = /const\s+\w+\s*=\s*\[\s*'[0-9a-fA-F]{20,}'/ ascii
            // .map() with Buffer.from hex decode pattern
            $map_decode = ".map(" ascii
            $buffer = "Buffer.from" ascii
            $hex1 = "'hex'" ascii
            $hex2 = "\"hex\"" ascii
            $join = ".join(" ascii
          condition:
            any of ($arr*) and $map_decode and $buffer and any of ($hex*) and $join
        }

  # Base64-encoded content fetched and decoded
  - id: remote-base64-decode
    desc: Fetches remote content and decodes as base64 (payload delivery)
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule remote_base64_decode {
          strings:
            // Network fetch
            $fetch1 = "https.get" ascii
            $fetch2 = "http.get" ascii
            $fetch3 = "_fetch" ascii
            // Response handling + base64 decode
            $decode = "Buffer.from" ascii
            $b64_1 = "'base64'" ascii
            $b64_2 = "\"base64\"" ascii
            $trim = ".trim()" ascii
          condition:
            any of ($fetch*) and $decode and any of ($b64_*) and $trim
        }

  # Array join obfuscation
  - id: js-array-join
    desc: Array join pattern used to construct strings
    crit: notable
    conf: 0.6
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\[['\"][^'\"]+['\"](?:,\\s*['\"][^'\"]+['\"]){5,}\\]\\.join"

  # Dynamic code execution patterns (atomic)
  - id: js-eval-call
    desc: eval() call
    crit: inert
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "eval("

  - id: js-function-call
    desc: Function() constructor
    crit: inert
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "Function("

  - id: js-new-function
    desc: new Function constructor
    crit: inert
    conf: 0.5
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "new Function"

  # Dynamic require with variable (non-literal) argument
  - id: js-dynamic-require-call
    desc: Dynamic require with non-literal module name
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: 'require\([^"'']'

composite_rules:
  # Buffer decode composite
  - id: js-buffer-decode
    desc: Buffer.from used to decode strings at runtime
    crit: notable
    conf: 0.7
    for: [javascript, typescript]
    count: 1
    any:
      - id: js-buffer-from-base64
      - id: js-buffer-from-hex

  # Dynamic exec composite
  - id: js-dynamic-exec
    desc: Dynamic code execution via eval or Function constructor
    crit: notable
    conf: 0.7
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    count: 1
    any:
      - id: js-eval-call
      - id: js-function-call
      - id: js-new-function

  # Unicode obfuscation with execution
  - id: js-unicode-exec
    desc: Unicode obfuscated string executed (evasion)
    crit: hostile
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: js-unicode-escape
      - id: js-dynamic-exec
      - id: fromcharcode

  # Dynamic require with obfuscation
  - id: js-dynamic-require
    desc: Dynamic require with obfuscated module name
    crit: suspicious
    conf: 0.85
    all:
      - id: js-dynamic-require-call
      - id: js-unicode-escape
