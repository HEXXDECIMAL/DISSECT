# String Obfuscation Detection - Python
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

defaults:
  file_types: [python]
  mbc: "B0032"
  attack: "T1027"

traits:
  - id: python-hex
    description: "Detects hex-encoded string patterns"
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule python_hex_obfuscation {
          strings:
            $hex = /(\\x[0-9a-fA-F]{2}){4,}/
          condition:
            $hex
        }

  - id: python-octal
    description: "Detects octal-encoded string patterns"
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule python_octal_obfuscation {
          strings:
            $oct = /(\\[0-7]{3}){4,}/
          condition:
            $oct
        }

  - id: python-chr
    description: "Character code manipulation (chr/ord)"
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      regex: '\\b(chr|ord)\('

  - id: concatenated-execution
    description: "String concatenation in execution sink (Evasion)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: ast_query
      language: python
      query: |
        (call
          function: (identifier) @func
          arguments: (argument_list
            (binary_operator
              left: (_)
              operator: "+"
              right: (_))))
        (#match? @func "^(exec|eval|b64decode|system|compile)$")

composite_rules:
  - id: execute-decoded-content
    description: "Direct execution of decoded content (Dynamic Dropper)"
    criticality: hostile
    confidence: 0.98
    requires_all:
      - type: string
        regex: 'exec\(|eval\('
      - type: string
        regex: 'b64decode|fromhex|bytes\.fromhex|bz2\.decompress|zlib\.decompress|marshal\.loads'
      - type: trait
        id: anti-static/obfuscation/strings/python-chr

  - id: python-encoded-pattern
    description: "Detects encoded string patterns (hex or octal)"
    criticality: notable
    requires_any:
      - type: trait
        id: anti-static/obfuscation/strings/python-hex
      - type: trait
        id: anti-static/obfuscation/strings/python-octal

  - id: obfuscated-execution
    description: "Direct execution of encoded string (Dynamic Dropper)"
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: string
        regex: 'exec\(|eval\('
      - type: trait
        id: anti-static/obfuscation/strings/python-encoded-pattern
      - type: trait
        id: anti-static/obfuscation/strings/python-chr
