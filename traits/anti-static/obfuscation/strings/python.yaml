# String Obfuscation Detection - Python
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

defaults:
  for: [python]
  mbc: "B0032"
  attack: "T1027"

traits:
  - id: python-hex
    desc: "Detects hex-encoded string patterns"
    crit: notable
    conf: 0.7
    if:
      type: yara
      source: |
        rule python_hex_obfuscation {
          strings:
            $hex = /(\\x[0-9a-fA-F]{2}){4,}/
          condition:
            $hex
        }

  - id: python-octal
    desc: "Detects octal-encoded string patterns"
    crit: notable
    conf: 0.7
    if:
      type: yara
      source: |
        rule python_octal_obfuscation {
          strings:
            $oct = /(\\[0-7]{3}){4,}/
          condition:
            $oct
        }

  - id: python-chr
    desc: "Character code manipulation (chr/ord)"
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: '\\b(chr|ord)\('

  - id: concatenated-execution
    desc: "String concatenation in execution sink (Evasion)"
    crit: suspicious
    conf: 0.85
    if:
      type: ast_query
      language: python
      query: |
        (call
          function: (identifier) @func
          arguments: (argument_list
            (binary_operator
              left: (_)
              operator: "+"
              right: (_))))
        (#match? @func "^(exec|eval|b64decode|system|compile)$")

  - id: python-exec-eval
    desc: "Dynamic code execution via exec() or eval()"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: 'exec\(|eval\('

  # === Decoding function atomic indicators ===
  - id: b64decode-call
    desc: base64 b64decode function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "b64decode"

  - id: fromhex-call
    desc: fromhex function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "fromhex"

  - id: bytes-fromhex-call
    desc: bytes.fromhex function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bytes.fromhex"

  - id: bz2-decompress-call
    desc: bz2.decompress function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bz2.decompress"

  - id: zlib-decompress-call
    desc: zlib.decompress function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "zlib.decompress"

  - id: marshal-loads-call
    desc: marshal.loads function
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "marshal.loads"

composite_rules:
  # Decode functions composite
  - id: python-decode-functions
    desc: "Decoding functions for encoded payloads"
    crit: notable
    conf: 0.7
    count: 1
    any:
      - id: b64decode-call
      - id: fromhex-call
      - id: bytes-fromhex-call
      - id: bz2-decompress-call
      - id: zlib-decompress-call
      - id: marshal-loads-call

  - id: execute-decoded-content
    desc: "Direct execution of decoded content (Dynamic Dropper)"
    crit: hostile
    conf: 0.98
    all:
      - id: python-exec-eval
      - id: python-decode-functions
      - id: python-chr

  - id: python-encoded-pattern
    desc: "Detects encoded string patterns (hex or octal)"
    crit: notable
    any:
      - id: python-hex
      - id: python-octal

  - id: obfuscated-execution
    desc: "Direct execution of encoded string (Dynamic Dropper)"
    crit: hostile
    conf: 0.95
    all:
      - id: python-exec-eval
      - id: python-encoded-pattern
      - id: python-chr
