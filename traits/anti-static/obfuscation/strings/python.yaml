# String Obfuscation Detection - Python
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

defaults:
  file_types: [python]
  mbc: "B0032"
  attack: "T1027"

traits:
  - id: python-hex
    description: "Detects hex-encoded string patterns"
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule python_hex_obfuscation {
          strings:
            $hex = /(\\x[0-9a-fA-F]{2}){4,}/
          condition:
            $hex
        }

  - id: python-octal
    description: "Detects octal-encoded string patterns"
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule python_octal_obfuscation {
          strings:
            $oct = /(\\[0-7]{3}){4,}/
          condition:
            $oct
        }

  - id: python-chr
    description: "Character code manipulation (chr/ord)"
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      regex: '\\b(chr|ord)\('

  - id: concatenated-execution
    description: "String concatenation in execution sink (Evasion)"
    criticality: suspicious
    confidence: 0.85
    condition:
      type: ast_query
      language: python
      query: |
        (call
          function: (identifier) @func
          arguments: (argument_list
            (binary_operator
              left: (_)
              operator: "+"
              right: (_))))
        (#match? @func "^(exec|eval|b64decode|system|compile)$")

  - id: python-exec-eval
    description: "Dynamic code execution via exec() or eval()"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: 'exec\(|eval\('

  # === Decoding function atomic indicators ===
  - id: b64decode-call
    description: base64 b64decode function
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "b64decode"

  - id: fromhex-call
    description: fromhex function
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "fromhex"

  - id: bytes-fromhex-call
    description: bytes.fromhex function
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "bytes.fromhex"

  - id: bz2-decompress-call
    description: bz2.decompress function
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "bz2.decompress"

  - id: zlib-decompress-call
    description: zlib.decompress function
    criticality: inert
    confidence: 0.5
    condition:
      type: string
      exact: "zlib.decompress"

  - id: marshal-loads-call
    description: marshal.loads function
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      exact: "marshal.loads"

composite_rules:
  # Decode functions composite
  - id: python-decode-functions
    description: "Decoding functions for encoded payloads"
    criticality: notable
    confidence: 0.7
    requires_count: 1
    conditions:
      - id: b64decode-call
      - id: fromhex-call
      - id: bytes-fromhex-call
      - id: bz2-decompress-call
      - id: zlib-decompress-call
      - id: marshal-loads-call

  - id: execute-decoded-content
    description: "Direct execution of decoded content (Dynamic Dropper)"
    criticality: hostile
    confidence: 0.98
    requires_all:
      - id: python-exec-eval
      - id: python-decode-functions
      - id: python-chr

  - id: python-encoded-pattern
    description: "Detects encoded string patterns (hex or octal)"
    criticality: notable
    requires_any:
      - id: python-hex
      - id: python-octal

  - id: obfuscated-execution
    description: "Direct execution of encoded string (Dynamic Dropper)"
    criticality: hostile
    confidence: 0.95
    requires_all:
      - id: python-exec-eval
      - id: python-encoded-pattern
      - id: python-chr
