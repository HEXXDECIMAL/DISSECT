# String Obfuscation Detection - Python
# MBC: B0032 (Obfuscated Files or Information)
# ATT&CK: T1027

defaults:
  # String patterns work in both Python source and frozen executables (PyInstaller, Nuitka, etc.)
  for: [python, elf, macho, pe]
  mbc: "B0032"
  attack: "T1027"

traits:
  # Migrated from YARA: hex escape sequences like \x41\x42\x43\x44
  - id: python-hex
    desc: "Detects hex-encoded string patterns (\\xNN"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(\\\\x[0-9a-fA-F]{2}){4,}"

  # Migrated from YARA: octal escape sequences like \101\102\103\104
  - id: python-octal
    desc: "Detects octal-encoded string patterns (\\NNN"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(\\\\[0-7]{3}){4,}"

  - id: python-chr
    desc: "Character code manipulation (chr/ord)"
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: '\\b(chr|ord)\('

  # AST-based detection (Python source only)
  - id: concatenated-execution
    desc: "String concatenation in execution sink"
    crit: suspicious
    conf: 0.85
    for: [python]
    if:
      type: ast
      language: python
      query: |
        (call
          function: (identifier) @func
          arguments: (argument_list
            (binary_operator
              left: (_)
              operator: "+"
              right: (_))))
        (#match? @func "^(exec|eval|b64decode|system|compile)$")

  - id: python-exec-eval
    desc: "Dynamic code execution via exec()"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: 'exec\(|eval\('

  # === Decoding function atomic indicators ===
  - id: b64decode-call
    desc: base64 b64decode function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "b64decode"

  - id: fromhex-call
    desc: fromhex function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "fromhex"

  - id: bytes-fromhex-call
    desc: bytes.fromhex function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bytes.fromhex"

  - id: bz2-decompress-call
    desc: bz2.decompress function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bz2.decompress"

  - id: zlib-decompress-call
    desc: zlib.decompress function
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "zlib.decompress"

  - id: marshal-loads-call
    desc: marshal.loads function
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "marshal.loads"

  # Reverse byte order - anti-analysis technique
  - id: reverse-bytes
    desc: Reverses byte order before processing
    crit: suspicious
    conf: 0.9
    if:
      type: content
      regex: "\\[::-1\\]"

composite_rules:
  # Decode functions composite
  - id: python-decode-functions
    desc: "Decoding functions for encoded payloads"
    crit: notable
    conf: 0.7
    count_min: 1
    any:
      - id: b64decode-call
      - id: fromhex-call
      - id: bytes-fromhex-call
      - id: bz2-decompress-call
      - id: zlib-decompress-call
      - id: marshal-loads-call

  - id: execute-decoded-content
    desc: "Direct execution of decoded content"
    crit: hostile
    conf: 0.98
    all:
      - id: python-exec-eval
      - id: python-decode-functions
      - id: python-chr

  - id: python-encoded-pattern
    desc: "Detects encoded string patterns (hex"
    crit: notable
    any:
      - id: python-hex
      - id: python-octal

  - id: obfuscated-execution
    desc: "Direct execution of encoded string"
    crit: hostile
    conf: 0.95
    all:
      - id: python-exec-eval
      - id: python-encoded-pattern
      - id: python-chr
