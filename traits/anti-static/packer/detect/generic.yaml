# Packer Detection
# MBC: F0001 (Packing)
# ATT&CK: T1027.002

traits:
  - id: upx-marker
    description: UPX packer marker string
    criticality: inert
    confidence: 0.8
    condition:
      type: string
      regex: 'UPX[!01]'

  - id: aspack-marker
    description: ASPack packer marker
    criticality: inert
    confidence: 0.8
    condition:
      type: string
      exact: aPack

  - id: petite-marker
    description: Petite packer marker
    criticality: inert
    confidence: 0.8
    condition:
      type: string
      exact: petite

  - id: themida-marker
    description: Themida packer marker
    criticality: inert
    confidence: 0.8
    condition:
      type: string
      exact: Themida

  - id: vmprotect-marker
    description: VMProtect packer marker
    criticality: inert
    confidence: 0.8
    condition:
      type: string
      exact: VMProtect

  - id: upx-section-yara
    description: UPX packed binary section via YARA
    criticality: suspicious
    confidence: 0.95
    mbc: "F0001.008"
    file_types: [pe, elf, macho]
    condition:
      type: yara
      source: |
        import "pe"
        import "elf"
        import "macho"

        rule upx_section {
          condition:
            (pe.is_pe and for any section in pe.sections : (section.name matches /^(UPX\d+|\.UPX\d+)$/)) or
            (elf.number_of_sections > 0 and for any section in elf.sections : (section.name matches /^(UPX\d+|\.UPX\d+)$/)) or
            (macho.number_of_segments > 0 and for any segment in macho.segments : (segment.segname matches /^(UPX\d+|\.UPX\d+)$/))
        }

  - id: vmprotect-section-yara
    description: VMProtect packed binary section via YARA
    criticality: suspicious
    confidence: 0.95
    mbc: "F0001"
    file_types: [pe, elf, macho]
    condition:
      type: yara
      source: |
        import "pe"
        import "elf"
        import "macho"

        rule vmp_section {
          condition:
            (pe.is_pe and for any section in pe.sections : (section.name matches /^\.vmp[0-9]+$/)) or
            (elf.number_of_sections > 0 and for any section in elf.sections : (section.name matches /^\.vmp[0-9]+$/)) or
            (macho.number_of_segments > 0 and for any segment in macho.segments : (segment.segname matches /^\.vmp[0-9]+$/))
        }

composite_rules:
  - id: detect
    description: Packed/compressed executable
    criticality: notable
    confidence: 0.66
    mbc: "F0001"
    attack: "T1027.002"
    requires_count: 1
    conditions:
      - id: upx-marker
      - id: aspack-marker
      - id: petite-marker
      - id: themida-marker
      - id: vmprotect-marker

  - id: upx
    description: "UPX packed binary (section)"
    criticality: suspicious
    confidence: 0.95
    mbc: "F0001.008"
    file_types: [pe, elf, macho]
    requires_all:
      - id: upx-section-yara

  - id: vmprotect
    description: "VMProtect packed binary (section)"
    criticality: suspicious
    confidence: 0.95
    mbc: "F0001"
    file_types: [pe, elf, macho]
    requires_all:
      - id: vmprotect-section-yara
