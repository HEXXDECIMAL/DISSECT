# eBPF Offensive Rootkit Traits
# Detects malicious usage of eBPF for hooking, hiding, and privilege escalation
# Patterns derived from TripleCross and other eBPF rootkits

traits:
  # = :::::::::::::::::::::::::::::::::===========================
  # eBPF HOOKING AND TRACEPOINTS
  # ============================================================

  - id: kernel/rootkit/ebpf/syscall-hooking
    description: eBPF program hooking syscall tracepoints
    criticality: hostile
    confidence: 0.95
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule ebpf_syscall_hooking {
          strings:
            $sec1 = "SEC(\"tp/syscalls/sys_enter_" ascii
            $sec2 = "SEC(\"tp/syscalls/sys_exit_" ascii
            $sec3 = "SEC(\"tracepoint/syscalls/sys_enter_" ascii
            $sec4 = "SEC(\"tracepoint/syscalls/sys_exit_" ascii
          condition:
            any of them
        }

  - id: kernel/rootkit/ebpf/xdp-backdoor
    description: XDP-based network backdoor or packet interception
    criticality: hostile
    confidence: 0.95
    attack: "T1205"
    condition:
      type: yara
      source: |
        rule ebpf_xdp_backdoor {
          strings:
            $xdp1 = "SEC(\"xdp" ascii
            $xdp2 = "struct xdp_md" ascii
            // Packet inspection primitives (offset math + byte comparison)
            $p1 = "data_end" ascii
            $p2 = "data" ascii
            $p3 = "iph" ascii
            $p4 = "tcph" ascii
            $p5 = "payload" ascii
            // Intent markers
            $i1 = "magic" ascii nocase
            $i2 = "trigger" ascii nocase
            $i3 = "backdoor" ascii nocase
            $i4 = "secret" ascii nocase
          condition:
            (any of ($xdp*)) and (3 of ($p*)) and (any of ($i*))
        }

  # ============================================================
  # Go-BASED eBPF LOADERS
  # ============================================================

  - id: kernel/rootkit/ebpf/go-loader
    description: Go-based eBPF program loader using common libraries
    criticality: notable
    confidence: 0.9
    file_types: [go]
    condition:
      type: yara
      source: |
        rule ebpf_go_loader {
          strings:
            $lib1 = "github.com/cilium/ebpf" ascii
            $lib2 = "github.com/aquasecurity/libbpfgo" ascii
            $lib3 = "github.com/DataDog/ebpf" ascii
            $func1 = "ebpf.NewCollection" ascii
            $func2 = "ebpf.NewProgram" ascii
            $func3 = "LoadPinnedProgram" ascii
          condition:
            any of them
        }

  - id: kernel/rootkit/ebpf/go-offensive-program
    description: Go loader referencing offensive eBPF sections
    criticality: hostile
    confidence: 0.95
    file_types: [go]
    condition:
      type: yara
      source: |
        rule ebpf_go_offensive_sections {
          strings:
            $s1 = "tp/syscalls/sys_enter_" ascii
            $s2 = "tp/syscalls/sys_exit_" ascii
            $s3 = "xdp" ascii
            $s4 = "uprobe" ascii
            // Combined with offensive intent
            $i1 = "rootkit" ascii nocase
            $i2 = "hide" ascii nocase
            $i3 = "bypass" ascii nocase
            $i4 = "patch" ascii nocase
          condition:
            (any of ($s*)) and (any of ($i*))
        }

  # ============================================================
  # eBPF DECEPTION AND MANIPULATION
  # ============================================================

  - id: kernel/rootkit/ebpf/probe-write-user
    description: eBPF program writing to user-space memory (PATCHING)
    criticality: hostile
    confidence: 1.0
    attack: "T1562.001"
    condition:
      type: yara
      source: |
        rule ebpf_probe_write_user {
          strings:
            $write = "bpf_probe_write_user" ascii
          condition:
            $write
        }

  - id: kernel/rootkit/ebpf/sudoers-manipulation
    description: eBPF-based runtime manipulation of sudoers or shadow in memory
    criticality: hostile
    confidence: 1.0
    attack: "T1068"
    condition:
      type: yara
      source: |
        rule ebpf_sensitive_file_patch {
          strings:
            $s1 = "sudoers" ascii nocase
            $s2 = "shadow" ascii nocase
            $s3 = "passwd" ascii nocase
            $s4 = "bpf_probe_write_user" ascii
          condition:
            (any of ($s1, $s2, $s3)) and $s4
        }

  - id: kernel/rootkit/ebpf/dirent-hiding
    description: eBPF-based file/directory hiding via getdents record length manipulation
    criticality: hostile
    confidence: 0.95
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule ebpf_dirent_hiding {
          strings:
            $tp = "tp/syscalls/sys_exit_getdents64" ascii
            $reclen = "d_reclen" ascii
            $write = "bpf_probe_write_user" ascii
          condition:
            $tp and $reclen and $write
        }

  - id: kernel/rootkit/ebpf/uprobe-hooking
    description: eBPF program hooking user-space functions (uprobes)
    criticality: hostile
    confidence: 0.95
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule ebpf_uprobe_hooking {
          strings:
            $sec = "SEC(\"uprobe/" ascii
            $crypt = "crypt_verify" ascii
            $passwd = "password" ascii
          condition:
            $sec and ($crypt or $passwd)
        }

  - id: kernel/rootkit/ebpf/http-manipulation
    description: eBPF program performing HTTP traffic manipulation (XDP)
    criticality: hostile
    confidence: 0.95
    attack: "T1557"
    condition:
      type: yara
      source: |
        rule ebpf_http_manipulation {
          strings:
            $http = "HTTP" ascii
            $route = "http_routes" ascii
            $edit = "HTTP_EDIT" ascii
            $drop = "HTTP_DROP" ascii
            $xdp = "SEC(\"xdp" ascii
          condition:
            $xdp and $http and (any of ($route, $edit, $drop))
        }

composite_rules:
  # High-Confidence eBPF Rootkit
  - id: kernel/rootkit/ebpf/advanced-rootkit
    description: Highly confident eBPF-based offensive rootkit (TripleCross style)
    criticality: hostile
    confidence: 0.99
    requires_count: 2
    conditions:
      - type: trait
        id: kernel/rootkit/ebpf/syscall-hooking
      - type: trait
        id: kernel/rootkit/ebpf/xdp-backdoor
      - type: trait
        id: kernel/rootkit/ebpf/probe-write-user
      - type: trait
        id: kernel/rootkit/ebpf/sudoers-manipulation
      - type: trait
        id: kernel/rootkit/ebpf/dirent-hiding
      - type: trait
        id: kernel/rootkit/ebpf/uprobe-hooking
      - type: trait
        id: kernel/rootkit/ebpf/http-manipulation
      - type: trait
        id: kernel/rootkit/ebpf/go-offensive-program
