# Kernel Rootkit Detection
# ATT&CK: T1014 (Rootkit)
# MBC: F0015 (Hijack Execution Flow)

traits:
  # Kernel symbol resolution via /proc/kallsyms
  - id: rootkit/kernel/kallsyms-lookup
    description: Accesses /proc/kallsyms for kernel symbol resolution
    criticality: suspicious
    confidence: 0.85
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule kallsyms_lookup {
          strings:
            $kallsyms = "/proc/kallsyms" ascii
            $ksyms = "/proc/ksyms" ascii
            $lookup_addr = "lookup_address" ascii
            $kallsyms_lookup = "kallsyms_lookup" ascii
          condition:
            any of them
        }

  # TCP connection hiding via tcp4_seq_show hook
  - id: rootkit/kernel/tcp-hiding
    description: Hooks TCP sequence show function to hide connections
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule tcp_hiding {
          strings:
            $tcp4_seq = "tcp4_seq_show" ascii
            $tcp6_seq = "tcp6_seq_show" ascii
            $udp4_seq = "udp4_seq_show" ascii
            $udp6_seq = "udp6_seq_show" ascii
            $proc_net = "/proc/net/tcp" ascii
          condition:
            any of ($tcp4_seq, $tcp6_seq, $udp4_seq, $udp6_seq) or
            ($proc_net and #proc_net > 2)
        }

  # Process hiding via proc filesystem hooks
  - id: rootkit/kernel/proc-hiding
    description: Hooks proc filesystem to hide processes
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule proc_hiding_kernel {
          strings:
            $proc_readdir = "proc_root_readdir" ascii
            $proc_iterate = "proc_iterate" ascii
            $proc_fill = "proc_fill_cache" ascii
            $filldir = "filldir" ascii
            $filldir64 = "filldir64" ascii
            $pid_getattr = "pid_getattr" ascii
          condition:
            2 of them
        }

  # Syscall table hooking
  - id: rootkit/kernel/syscall-hook
    description: Syscall table manipulation patterns
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule syscall_hook {
          strings:
            $sys_call = "sys_call_table" ascii
            $sys_getpriority = "sys_getpriority" ascii
            $sys_getdents = "sys_getdents" ascii
            $sys_getdents64 = "sys_getdents64" ascii
            $sys_kill = "sys_kill" ascii
            $orig_cr0 = "orig_cr0" ascii
            $write_cr0 = "write_cr0" ascii
            $native_write = "native_write_cr0" ascii
          condition:
            ($sys_call and any of ($sys_get*, $sys_kill)) or
            any of ($orig_cr0, $write_cr0, $native_write)
        }

  # Kernel module markers (ELF relocatable)
  - id: rootkit/kernel/module-format
    description: Kernel module initialization patterns
    criticality: notable
    confidence: 0.7
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule kernel_module {
          strings:
            $init_module = "init_module" ascii
            $cleanup_module = "cleanup_module" ascii
            $module_init = "__this_module" ascii
            $vermagic = "vermagic=" ascii
            $modinfo = ".modinfo" ascii
            $gnu_linkonce = ".gnu.linkonce" ascii
          condition:
            3 of them
        }

  # Netfilter hook manipulation
  - id: rootkit/kernel/netfilter-hook
    description: Netfilter hook manipulation for packet filtering
    criticality: suspicious
    confidence: 0.85
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule netfilter_hook {
          strings:
            $nf_register = "nf_register_hook" ascii
            $nf_register_net = "nf_register_net_hook" ascii
            $nf_unregister = "nf_unregister_hook" ascii
            $nf_hookfn = "nf_hookfn" ascii
            $NF_ACCEPT = "NF_ACCEPT" ascii
            $NF_DROP = "NF_DROP" ascii
          condition:
            2 of them
        }

  # File hiding via VFS hooks
  - id: rootkit/kernel/vfs-hook
    description: VFS layer hooking for file hiding
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule vfs_hook {
          strings:
            $vfs_read = "vfs_read" ascii
            $vfs_write = "vfs_write" ascii
            $vfs_readdir = "vfs_readdir" ascii
            $iterate_dir = "iterate_dir" ascii
            $file_operations = "file_operations" ascii
            $inode_operations = "inode_operations" ascii
          condition:
            ($file_operations or $inode_operations) and
            any of ($vfs_read, $vfs_write, $vfs_readdir, $iterate_dir)
        }

  # Diamorphine rootkit patterns
  - id: rootkit/kernel/diamorphine
    description: Diamorphine kernel rootkit indicators
    criticality: hostile
    confidence: 0.95
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule diamorphine {
          strings:
            $diamorphine = "diamorphine" ascii nocase
            $is_invisible = "is_invisible" ascii
            $module_hidden = "module_hidden" ascii
            $hide_module = "hide_module" ascii
            $give_root = "give_root" ascii
            $hacked_kill = "hacked_kill" ascii
            $orig_getdents = "orig_getdents" ascii
          condition:
            $diamorphine or ($is_invisible and any of ($module_hidden, $hide_module, $give_root)) or
            ($hacked_kill and $orig_getdents)
        }

  # Reptile rootkit patterns
  - id: rootkit/kernel/reptile
    description: Reptile kernel rootkit indicators
    criticality: hostile
    confidence: 0.95
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule reptile {
          strings:
            $reptile = "reptile" ascii nocase
            $khook = "khook" ascii
            $kmatryoshka = "kmatryoshka" ascii
            $hide_proc = "reptile_hide" ascii
            $magic_packet = "YOURMAGICPACKET" ascii
            $backdoor = "reptile_cmd" ascii
          condition:
            $reptile or 2 of them
        }

  # Syslogk rootkit patterns
  - id: rootkit/kernel/syslogk
    description: Syslogk kernel rootkit indicators
    criticality: hostile
    confidence: 0.95
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule syslogk {
          strings:
            $syslogk = "syslogk" ascii nocase
            $proc_kallsyms = "/proc/kallsyms" ascii
            $tcp4_show = "tcp4_seq_show" ascii
            $rekoobe = "PgSD93iu" ascii
          condition:
            ($proc_kallsyms and $tcp4_show) or $syslogk or $rekoobe
        }

composite_rules:
  # Full kernel rootkit detection
  - id: rootkit/kernel/lkm-rootkit
    description: Linux Kernel Module rootkit detected
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: trait
        id: rootkit/kernel/module-format
    requires_any:
      - type: trait
        id: rootkit/kernel/syscall-hook
      - type: trait
        id: rootkit/kernel/proc-hiding
      - type: trait
        id: rootkit/kernel/tcp-hiding
