# Cryptocurrency Wallet Mnemonic/Seed Phrase Theft Detection
# Detects code targeting BIP-39 mnemonic recovery phrases
# ATT&CK: T1555 (Credentials from Password Stores)
# MBC: B0028 (Credential Theft)

defaults:
  attack: "T1555"
  mbc: "B0028"
  criticality: suspicious

traits:
  # BIP-39 word count patterns (12, 15, 18, 21, 24 words)
  - id: word-count-check
    description: "Mnemonic word count validation (12/15/18/21/24)"
    confidence: 0.85
    criticality: hostile
    condition:
      type: string
      regex: "split\\([^)]*\\)\\s*\\.\\s*length\\s*[=!<>]+\\s*(12|15|18|21|24)|len\\([^)]*split[^)]*\\)\\s*[=!<>]+\\s*(12|15|18|21|24)|words?_?count\\s*[=!<>]+\\s*(12|15|18|21|24)"

  # Common mnemonic-related variable/function names
  - id: variable-names
    description: "Mnemonic-related variable or function names"
    confidence: 0.8
    condition:
      type: string
      regex: "\\b(mnemonic|seed_phrase|seedphrase|recovery_phrase|recoveryPhrase|secret_words|secretWords|wallet_words|walletWords)\\s*[=:]"

  # BIP-39 wordlist references
  - id: bip39-wordlist
    description: "BIP-39 wordlist reference"
    confidence: 0.85
    condition:
      type: string
      regex: "bip39|bip-39|wordlist|word_list|english\\.txt.*mnemonic|mnemonic.*english\\.txt"

  # Mnemonic validation patterns
  - id: validation-pattern
    description: "Mnemonic phrase validation logic"
    confidence: 0.85
    criticality: hostile
    condition:
      type: string
      regex: "validate.*mnemonic|mnemonic.*valid|check.*seed.*phrase|verify.*recovery"

  # Private key extraction in wallet context (not general crypto)
  - id: private-key-hex
    description: "Wallet private key extraction"
    confidence: 0.85
    criticality: hostile
    condition:
      type: string
      # Require wallet/crypto context, not just "private_key" which is used by SSH/TLS
      # "dump.*private" removed - matches debug output like "dump: C192:%{private" in Bluetooth
      regex: "(wallet|eth|btc|crypto|metamask|phantom).*private_?key|export.*(wallet|crypto|eth|btc).*key"

  # Bitcoin WIF private key format detection
  - id: bitcoin-wif
    description: "Bitcoin WIF private key format reference"
    confidence: 0.85
    criticality: hostile
    condition:
      type: string
      # Require wallet/bitcoin context - "wif" alone matches wireless interface
      regex: "wallet_import_format|WIF.*key|WIF.*private|bitcoin.*wif|wif.*bitcoin|decode.*wif|encode.*wif|to_?wif|from_?wif"

  # HD wallet derivation path patterns
  - id: derivation-path
    description: "HD wallet derivation path (BIP-44/49/84)"
    confidence: 0.8
    condition:
      type: string
      regex: "m/44'/|m/49'/|m/84'/|m/86'/|derivation_?path|derivationPath"

  # Keystore/JSON wallet file patterns
  - id: keystore-file
    description: "Ethereum keystore file reference"
    confidence: 0.8
    condition:
      type: string
      # Ethereum-specific patterns, avoid matching OS "keystore" services
      regex: "UTC--.*--[a-fA-F0-9]{40}|ethereum.*keystore|keystore.*ethereum|web3.*keystore|\\.json.*wallet"

composite_rules:
  # Mnemonic extraction with file/network operations
  - id: stealer-pattern
    description: "Mnemonic phrase theft (extraction + exfiltration)"
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: string
        regex: "mnemonic|seed_phrase|seedphrase|recovery_phrase|secret_words"
      - type: string
        regex: "requests\\.(post|get)|urllib|socket\\.|fetch\\(|XMLHttpRequest"

  # Multiple wallet-related patterns = wallet stealer
  - id: comprehensive-stealer
    description: "Comprehensive wallet credential theft"
    criticality: hostile
    confidence: 0.95
    requires_count: 3
    conditions:
      - type: string
        regex: "mnemonic|seed_phrase|recovery_phrase"
      - type: string
        regex: "private_?key|privateKey"
      - type: string
        regex: "keystore|keystores"
      - type: string
        regex: "derivation.*path|m/44'/"
      - type: string
        regex: "bip39|bip-39|wordlist"
