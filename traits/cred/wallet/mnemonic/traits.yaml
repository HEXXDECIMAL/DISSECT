# Cryptocurrency Wallet Mnemonic/Seed Phrase Theft Detection
# Detects code targeting BIP-39 mnemonic recovery phrases
# ATT&CK: T1555 (Credentials from Password Stores)
# MBC: B0028 (Credential Theft)

defaults:
  attack: "T1555"
  mbc: "B0028"
  crit: suspicious

traits:
  # BIP-39 word count patterns (12, 15, 18, 21, 24 words)
  - id: word-count-check
    desc: "Mnemonic word count validation (12/15/18/21/24)"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      regex: "split\\([^)]*\\)\\s*\\.\\s*length\\s*[=!<>]+\\s*(12|15|18|21|24)|len\\([^)]*split[^)]*\\)\\s*[=!<>]+\\s*(12|15|18|21|24)|words?_?count\\s*[=!<>]+\\s*(12|15|18|21|24)"

  # Common mnemonic-related variable/function names
  - id: variable-names
    desc: "Mnemonic-related variable or function names"
    conf: 0.8
    if:
      type: string
      regex: "\\b(mnemonic|seed_phrase|seedphrase|recovery_phrase|recoveryPhrase|secret_words|secretWords|wallet_words|walletWords)\\s*[=:]"

  # BIP-39 wordlist references
  - id: bip39-wordlist
    desc: "BIP-39 wordlist reference"
    conf: 0.85
    if:
      type: string
      regex: "bip39|bip-39|wordlist|word_list|english\\.txt.*mnemonic|mnemonic.*english\\.txt"

  # Mnemonic validation patterns
  - id: validation-pattern
    desc: "Mnemonic phrase validation logic"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      regex: "validate.*mnemonic|mnemonic.*valid|check.*seed.*phrase|verify.*recovery"

  # Private key extraction in wallet context (not general crypto)
  - id: private-key-hex
    desc: "Wallet private key extraction"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      # Require wallet/crypto context, not just "private_key" which is used by SSH/TLS
      # "dump.*private" removed - matches debug output like "dump: C192:%{private" in Bluetooth
      regex: "(wallet|eth|btc|crypto|metamask|phantom).*private_?key|export.*(wallet|crypto|eth|btc).*key"

  # Bitcoin WIF private key format detection
  - id: bitcoin-wif
    desc: "Bitcoin WIF private key format reference"
    conf: 0.85
    crit: suspicious
    if:
      type: string
      # Require wallet/bitcoin context - "wif" alone matches wireless interface
      regex: "wallet_import_format|WIF.*key|WIF.*private|bitcoin.*wif|wif.*bitcoin|decode.*wif|encode.*wif|to_?wif|from_?wif"

  # HD wallet derivation path patterns
  - id: derivation-path
    desc: "HD wallet derivation path (BIP-44/49/84)"
    conf: 0.8
    if:
      type: string
      regex: "m/44'/|m/49'/|m/84'/|m/86'/|derivation_?path|derivationPath"

  # Keystore/JSON wallet file patterns
  - id: keystore-file
    desc: "Ethereum keystore file reference"
    conf: 0.8
    if:
      type: string
      # Ethereum-specific patterns, avoid matching OS "keystore" services
      regex: "UTC--.*--[a-fA-F0-9]{40}|ethereum.*keystore|keystore.*ethereum|web3.*keystore|\\.json.*wallet"

  # === Mnemonic/seed phrase term atomic indicators ===
  - id: mnemonic-word
    desc: mnemonic term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "mnemonic"

  - id: seed-phrase-underscore
    desc: seed_phrase term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "seed_phrase"

  - id: seedphrase-word
    desc: seedphrase term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "seedphrase"

  - id: recovery-phrase-word
    desc: recovery_phrase term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "recovery_phrase"

  - id: secret-words-word
    desc: secret_words term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "secret_words"

  # === Network exfiltration atomic indicators ===
  - id: requests-post
    desc: Python requests.post call
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "requests\\.post"

  - id: requests-get
    desc: Python requests.get call
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "requests\\.get"

  - id: urllib-word
    desc: urllib reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "urllib"

  - id: socket-dot
    desc: socket module usage
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "socket\\."

  - id: fetch-call
    desc: JavaScript fetch call
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "fetch\\("

  - id: xmlhttprequest-word
    desc: XMLHttpRequest reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "XMLHttpRequest"

  # === Wallet/crypto context atomic indicators ===
  - id: wallet-word
    desc: wallet term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "wallet"

  - id: crypto-word
    desc: crypto term
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "crypto"

  - id: metamask-word
    desc: MetaMask reference
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "metamask"

  - id: phantom-word
    desc: Phantom wallet reference
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "phantom"

  - id: browser-word
    desc: browser term
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "browser"

  # === Private key variable atomic indicators ===
  - id: private-key-underscore
    desc: private_key variable
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "private_key"

  - id: privatekey-nospace
    desc: privatekey variable (no separator)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "privatekey"

  - id: privatekey-camel
    desc: privateKey variable (camelCase)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "privateKey"

  # === Keystore reference atomic indicators ===
  - id: keystore-singular
    desc: keystore reference
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "keystore"

  - id: keystores-plural
    desc: keystores reference (plural)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "keystores"

  # === Derivation path atomic indicators ===
  - id: derivation-path-words
    desc: derivation path words
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "derivation.*path"

  - id: bip44-path-prefix
    desc: BIP-44 derivation path prefix (m/44'/)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "m/44'/"

  # === BIP-39 reference atomic indicators ===
  - id: bip39-exact
    desc: bip39 reference
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bip39"

  - id: bip-39-hyphen
    desc: bip-39 reference (hyphenated)
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "bip-39"

  - id: wordlist-word
    desc: wordlist reference
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "wordlist"

composite_rules:
  # Mnemonic terms composite
  - id: mnemonic-terms
    desc: Mnemonic or seed phrase terminology
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: mnemonic-word
      - id: seed-phrase-underscore
      - id: seedphrase-word
      - id: recovery-phrase-word
      - id: secret-words-word

  # Wallet context composite
  - id: wallet-context
    desc: Wallet or cryptocurrency context
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: wallet-word
      - id: crypto-word
      - id: metamask-word
      - id: phantom-word
      - id: browser-word

  # Network exfiltration composite
  - id: network-exfil
    desc: Network request patterns for exfiltration
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: requests-post
      - id: requests-get
      - id: urllib-word
      - id: socket-dot
      - id: fetch-call
      - id: xmlhttprequest-word

  # Private key variable composite
  - id: private-key-var
    desc: Private key variable or property
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: private-key-underscore
      - id: privatekey-nospace
      - id: privatekey-camel

  # Keystore reference composite
  - id: keystore-ref
    desc: Keystore reference
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: keystore-singular
      - id: keystores-plural

  # Derivation path composite
  - id: derivation-pattern
    desc: Wallet derivation path pattern
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: derivation-path-words
      - id: bip44-path-prefix

  # BIP-39 reference composite
  - id: bip39-ref
    desc: BIP-39 or wordlist reference
    crit: notable
    conf: 0.7
    requires_count: 1
    any:
      - id: bip39-exact
      - id: bip-39-hyphen
      - id: wordlist-word

  # Mnemonic extraction with file/network operations
  - id: stealer-pattern
    desc: "Mnemonic phrase theft (extraction + exfiltration)"
    crit: hostile
    conf: 0.95
    attack: "T1555"
    mbc: "B0028"
    for: [python, javascript]
    all:
      - id: mnemonic-terms
      - id: network-exfil
      - id: wallet-context

  # Multiple wallet-related patterns = wallet stealer
  - id: comprehensive-stealer
    desc: "Comprehensive wallet credential theft"
    crit: hostile
    conf: 0.95
    attack: "T1555"
    mbc: "B0028"
    for: [python, javascript, elf, pe, macho]
    requires_count: 3
    any:
      - id: mnemonic-terms
      - id: private-key-var
      - id: keystore-ref
      - id: derivation-pattern
      - id: bip39-ref
