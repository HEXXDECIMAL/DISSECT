# Cryptocurrency Wallet Provider Access - JavaScript
# Detects JavaScript code interacting with injected wallet providers (MetaMask, etc.)
# ATT&CK: T1555.003 (Credentials from Password Stores), T1539 (Steal Web Session Cookie)

defaults:
  file_types: [javascript]
  attack: "T1555.003"
  criticality: suspicious

traits:
  # window.ethereum - MetaMask and EIP-1193 compatible wallets
  - id: ethereum-provider
    description: "Web3 wallet provider access (window.ethereum)"
    confidence: 0.75
    condition:
      type: string
      regex: "window\\.ethereum|window\\[['\"]ethereum['\"]\\]"

  # ethereum.request method - primary wallet interaction API
  - id: ethereum-request
    description: "Ethereum wallet request API"
    confidence: 0.8
    condition:
      type: string
      regex: "ethereum\\.request\\s*\\(|\\['\"]request['\"]\\]\\s*\\("

  # eth_requestAccounts - request wallet connection
  - id: eth-request-accounts
    description: "Request wallet accounts (eth_requestAccounts)"
    confidence: 0.85
    condition:
      type: string
      regex: "eth_requestAccounts|eth_accounts|eth_accoun"

  # eth_sendTransaction - send transaction
  - id: eth-send-transaction
    description: "Send Ethereum transaction (eth_sendTransaction)"
    confidence: 0.9
    criticality: suspicious
    condition:
      type: string
      regex: "eth_sendTransaction|eth_sendTr"

  # ERC-20 approve function selector (0x095ea7b3)
  - id: erc20-approve
    description: "ERC-20 token approve function selector"
    confidence: 0.85
    criticality: suspicious
    condition:
      type: string
      exact: "0x095ea7b3"

  # ERC-20 transfer function selector (0xa9059cbb)
  - id: erc20-transfer
    description: "ERC-20 token transfer function selector"
    confidence: 0.8
    condition:
      type: string
      exact: "0xa9059cbb"

  # ERC-20 transferFrom function selector (0x23b872dd)
  - id: erc20-transferFrom
    description: "ERC-20 token transferFrom function selector"
    confidence: 0.85
    criticality: suspicious
    condition:
      type: string
      exact: "0x23b872dd"

  # Function name patterns for wallet drainers
  - id: drainer-function-names
    description: "Suspicious wallet drainer function names"
    confidence: 0.9
    criticality: suspicious
    condition:
      type: string
      regex: "function\\s+(check|drain|steal|grab|hijack).*(wallet|ethereum|eth|crypto)|function\\s+(runmask|newdlocal|checkethereumw)"

composite_rules:
  # Wallet provider access + transaction sending = wallet drainer
  - id: wallet-drainer
    description: "Cryptocurrency wallet drainer (provider access + transaction)"
    criticality: hostile
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    file_types: [javascript]
    requires_all:
      - type: string
        regex: "window\\.ethereum|ethereum\\.request"
      - type: string
        regex: "eth_sendTransaction|eth_requestAccounts|0x095ea7b3|0x23b872dd"
      - type: string
        regex: "function\\s+(drain|steal|grab)|MAX_UINT256|setApprovalForAll"
