# Credential Access - Firefox Browser Data Theft
# ATT&CK: T1555.003 (Credentials from Password Stores: Credentials from Web Browsers)

traits:
  # === Path/File References ===

  - id: path
    description: Firefox browser reference
    criticality: notable
    confidence: 0.6
    attack: "T1555.003"
    condition:
      type: string
      exact: "Firefox"

  - id: cookies-sqlite
    description: Firefox cookies.sqlite database
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.003"
    condition:
      type: string
      exact: "cookies.sqlite"

  - id: formhistory-sqlite
    description: Firefox formhistory.sqlite database
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    condition:
      type: string
      exact: "formhistory.sqlite"

  - id: logins-json
    description: Firefox logins.json file
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    condition:
      type: string
      exact: "logins.json"

  - id: key4-db
    description: Firefox key4.db (master password database)
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.003"
    condition:
      type: string
      exact: "key4.db"

  - id: cert9-db
    description: Firefox cert9.db certificate store
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.003"
    condition:
      type: string
      exact: "cert9.db"

  # === NSS Library (used for decryption) ===

  - id: nss-private
    description: Firefox NSS private key database
    criticality: suspicious
    confidence: 0.8
    attack: "T1555.003"
    condition:
      type: string
      exact: "nssPrivate"

  - id: nss3-lib
    description: Firefox NSS3 library reference
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    condition:
      type: string
      regex: "\\bnss3\\b|libnss3"

  - id: pk11-decrypt
    description: Firefox PK11SDR_Decrypt function
    criticality: suspicious
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    condition:
      type: string
      exact: "PK11SDR_Decrypt"

  # === SQL Queries ===

  - id: moz-cookies-sql
    description: Firefox moz_cookies SQL query
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.003"
    condition:
      type: string
      regex: "SELECT.*FROM\\s+moz_cookies"
      case_insensitive: true

  - id: moz-logins-sql
    description: Firefox moz_logins SQL query
    criticality: suspicious
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    condition:
      type: string
      regex: "SELECT.*FROM\\s+moz_logins"
      case_insensitive: true

composite_rules:
  - id: cookie-theft
    description: Firefox cookie theft
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    requires_all:
      - type: trait
        id: path
      - type: trait
        id: cookies-sqlite

  - id: password-theft
    description: Firefox password/form history theft
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    requires_all:
      - type: trait
        id: path
    requires_any:
      - type: trait
        id: formhistory-sqlite
      - type: trait
        id: nss-private
      - type: trait
        id: logins-json
      - type: trait
        id: key4-db

  - id: nss-decrypt
    description: Firefox NSS decryption (password extraction)
    criticality: hostile
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    file_types: [python, javascript, elf, pe, macho, so, dll]
    requires_any:
      - type: trait
        id: pk11-decrypt
      - type: trait
        id: nss3-lib
    requires_all:
      - type: trait
        id: path
