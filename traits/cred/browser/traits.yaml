# Credential Access - Browser Data Theft (Generic/Cross-browser)
# Cookie theft libraries and multi-browser targeting
# ATT&CK: T1555.003 (Credentials from Password Stores: Credentials from Web Browsers)

traits:
  # === Cookie Theft Libraries ===

  - id: pycookiecheat
    description: Python cookie theft library (pycookiecheat)
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    file_types: [python]
    condition:
      type: string
      exact: "pycookiecheat"

  - id: kooky
    description: Go cookie theft library (kooky)
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    file_types: [go, elf]
    condition:
      type: string
      exact: "browserutils/kooky"

  - id: browser-cookie3
    description: Python browser-cookie3 library
    criticality: suspicious
    confidence: 0.85
    attack: "T1555.003"
    file_types: [python]
    condition:
      type: string
      exact: "browser_cookie3"

  - id: hackbrowserdata
    description: HackBrowserData tool reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    condition:
      type: string
      regex: "\\bhackbrowserdata\\b|HackBrowserData"
      case_insensitive: true

composite_rules:
  # Multi-browser targeting detection
  - id: multi-browser-theft
    description: Multi-browser credential theft
    criticality: suspicious
    confidence: 0.9
    attack: "T1555.003"
    mbc: "B0028"
    file_types: [python, javascript, elf, pe, macho]
    condition:
      type: yara
      source: |
        rule multi_browser_credential_theft {
          meta:
            description = "Targets multiple browsers for credential theft"
          strings:
            // Chromium-based
            $chrome = "Google/Chrome" ascii
            $chromium = "Chromium" ascii
            $edge = "Microsoft/Edge" ascii
            $brave = "BraveSoftware" ascii
            $opera = "Opera" ascii
            $vivaldi = "Vivaldi" ascii
            // Firefox-based
            $firefox = "Firefox" ascii
            $thunderbird = "Thunderbird" ascii
            // Safari
            $safari = "Safari" ascii
            // Common data files
            $login_data = "Login Data" ascii
            $cookies_sqlite = "cookies.sqlite" ascii
            $local_state = "Local State" ascii
          condition:
            // At least 2 browser refs + 1 data file
            2 of ($chrome, $chromium, $edge, $brave, $opera, $vivaldi, $firefox, $safari) and
            1 of ($login_data, $cookies_sqlite, $local_state)
        }

  # Full browser stealer with decryption and exfiltration
  - id: full-stealer-detected
    description: Complete browser credential stealer (theft + decrypt + exfil)
    criticality: hostile
    confidence: 0.98
    attack: "T1555.003"
    mbc: "B0028"
    file_types: [python, javascript, elf, pe, macho]
    condition:
      type: yara
      source: |
        rule complete_browser_stealer {
          meta:
            description = "Full browser credential stealer with exfiltration"
          strings:
            // Browser data paths
            $browser1 = "Chrome" ascii
            $browser2 = "Firefox" ascii
            $browser3 = "Opera" ascii
            $browser4 = "Brave" ascii
            $browser5 = "Edge" ascii
            // Credential data
            $cred1 = "Login Data" ascii
            $cred2 = "encrypted_key" ascii
            $cred3 = "logins.json" ascii
            $cred4 = "key4.db" ascii
            // Decryption
            $decrypt1 = "CryptUnprotectData" ascii
            $decrypt2 = "AES" ascii
            $decrypt3 = ".decrypt(" ascii
            $decrypt4 = "Fernet" ascii
            // SQLite
            $sqlite = "sqlite3" ascii
            // Exfiltration channels
            $exfil1 = /discord(app)?\.com\/api\/webhooks\// ascii
            $exfil2 = "api.telegram.org" ascii
            $exfil3 = "multipart/form-data" ascii
            $exfil4 = ".post(" ascii
          condition:
            filesize < 10MB and
            2 of ($browser*) and
            2 of ($cred*) and
            any of ($decrypt*) and
            ($sqlite or any of ($exfil*))
        }

  # Python browser stealer pattern
  - id: python-stealer
    description: Python-based browser credential stealer
    criticality: suspicious
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    file_types: [python]
    condition:
      type: yara
      source: |
        rule python_browser_stealer {
          meta:
            description = "Python browser credential stealer"
          strings:
            // Python imports
            $import1 = "import sqlite3" ascii
            $import2 = "from Crypto.Cipher import AES" ascii
            $import3 = "from win32crypt import CryptUnprotectData" ascii
            $import4 = "import requests" ascii
            // Browser paths
            $path1 = "LOCALAPPDATA" ascii
            $path2 = "APPDATA" ascii
            $path3 = /Google\\Chrome|\\Google\\Chrome/ ascii
            // Password extraction
            $pwd1 = "password_value" ascii
            $pwd2 = "username_value" ascii
            $pwd3 = "origin_url" ascii
            // Exfil
            $exfil1 = /discord\.com\/api\/webhooks/ ascii
            $exfil2 = "api.telegram.org" ascii
            $exfil3 = "ipinfo.io" ascii
          condition:
            filesize < 5MB and
            any of ($import*) and
            any of ($path*) and
            2 of ($pwd*) and
            any of ($exfil*)
        }
