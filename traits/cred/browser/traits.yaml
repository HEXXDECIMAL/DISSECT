# Credential Access - Browser Data Theft (Generic/Cross-browser)
# Cookie theft libraries and multi-browser targeting
# ATT&CK: T1555.003 (Credentials from Password Stores: Credentials from Web Browsers)

traits:
  # === Cookie Theft Libraries ===

  - id: pycookiecheat
    desc: Python cookie theft library (pycookiecheat)
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    for: [python]
    if:
      type: string
      exact: "pycookiecheat"

  - id: kooky
    desc: Go cookie theft library (kooky)
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    for: [go, elf, macho, pe]
    if:
      type: string
      exact: "browserutils/kooky"

  - id: browser-cookie3
    desc: Python browser-cookie3 library
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    for: [python]
    if:
      type: string
      exact: "browser_cookie3"

  # === HackBrowserData atomic indicators ===
  - id: hackbrowserdata-lower
    desc: hackbrowserdata lowercase reference
    crit: notable
    conf: 0.85
    attack: "T1555.003"
    mbc: "B0028"
    if:
      type: string
      word: "hackbrowserdata"

  - id: hackbrowserdata-camel
    desc: HackBrowserData camelcase reference
    crit: notable
    conf: 0.85
    attack: "T1555.003"
    mbc: "B0028"
    if:
      type: string
      exact: "HackBrowserData"

  # === Browser Path Patterns ===
  - id: google-chrome-path
    desc: Google/Chrome path component
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      exact: "Google/Chrome"

  - id: chromium-string
    desc: Chromium browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Chromium"

  - id: microsoft-edge-path
    desc: Microsoft/Edge path component
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      exact: "Microsoft/Edge"

  - id: brave-software-path
    desc: BraveSoftware path component
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      exact: "BraveSoftware"

  - id: opera-string
    desc: Opera browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Opera"

  - id: vivaldi-string
    desc: Vivaldi browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Vivaldi"

  - id: firefox-string
    desc: Firefox browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Firefox"

  - id: thunderbird-string
    desc: Thunderbird mail client name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Thunderbird"

  - id: safari-string
    desc: Safari browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Safari"

  # === Browser Data Files ===
  - id: local-state-file
    desc: Local State Chrome configuration file
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "Local State"

  # === Additional Browser Names ===
  - id: chrome-string
    desc: Chrome browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Chrome"

  - id: brave-string
    desc: Brave browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Brave"

  - id: edge-string
    desc: Edge browser name
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "Edge"

  # === Credential Data Files ===
  - id: encrypted-key-field
    desc: encrypted_key field in browser database
    crit: inert
    conf: 0.75
    for: [all]
    if:
      type: string
      exact: "encrypted_key"

  - id: logins-json-file
    desc: logins.json Firefox password file
    crit: inert
    conf: 0.75
    for: [all]
    if:
      type: string
      exact: "logins.json"

  - id: key4-db-file
    desc: key4.db Firefox key database
    crit: inert
    conf: 0.75
    for: [all]
    if:
      type: string
      exact: "key4.db"

  # === Decryption Methods ===
  - id: crypt-unprotect-data-str
    desc: CryptUnprotectData Windows API string
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "CryptUnprotectData"

  - id: aes-string
    desc: AES encryption/decryption string
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      word: "AES"

  - id: decrypt-method
    desc: .decrypt( method call
    crit: inert
    conf: 0.65
    for: [python, javascript, elf, macho, pe, dll, so, dylib]
    if:
      type: symbol
      exact: "decrypt"

  - id: fernet-string
    desc: Fernet encryption library
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      word: "Fernet"

  # === SQLite ===
  - id: sqlite3-string
    desc: sqlite3 database library
    crit: inert
    conf: 0.5
    for: [all]
    if:
      type: string
      word: "sqlite3"

  # === Exfiltration Channels ===
  - id: discord-webhook-pattern
    desc: Discord webhook URL pattern
    crit: inert
    conf: 0.8
    for: [all]
    if:
      type: string
      regex: "discord(app)?\\.com/api/webhooks/"

  - id: telegram-api
    desc: Telegram API endpoint
    crit: inert
    conf: 0.8
    for: [all]
    if:
      type: string
      exact: "api.telegram.org"

  - id: multipart-form-data
    desc: multipart/form-data content type
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      exact: "multipart/form-data"

  - id: post-method
    desc: .post( HTTP method call
    crit: inert
    conf: 0.5
    for: [python, javascript, elf, macho, pe, dll, so, dylib]
    if:
      type: symbol
      exact: "post"

  # === Python Imports ===
  - id: import-sqlite3
    desc: import sqlite3 statement
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: "import sqlite3"

  - id: import-crypto-aes
    desc: from Crypto.Cipher import AES
    crit: inert
    conf: 0.6
    for: [python]
    if:
      type: string
      exact: "from Crypto.Cipher import AES"

  - id: import-win32crypt
    desc: from win32crypt import CryptUnprotectData
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      exact: "from win32crypt import CryptUnprotectData"

  - id: import-requests
    desc: import requests statement
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: "import requests"

  # === Windows Environment Variables ===
  - id: localappdata-var
    desc: LOCALAPPDATA environment variable
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      exact: "LOCALAPPDATA"

  - id: appdata-var
    desc: APPDATA environment variable
    crit: inert
    conf: 0.6
    for: [all]
    if:
      type: string
      exact: "APPDATA"

  - id: google-chrome-windows-path
    desc: Google\Chrome Windows path
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      regex: "Google\\\\Chrome|\\\\Google\\\\Chrome"

  # === Password Database Fields ===
  - id: password-value-field
    desc: password_value database column
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "password_value"

  - id: username-value-field
    desc: username_value database column
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "username_value"

  - id: origin-url-field
    desc: origin_url database column
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "origin_url"

  # === Additional Exfil Endpoints ===
  - id: discord-webhook-simple
    desc: discord.com/api/webhooks pattern
    crit: inert
    conf: 0.8
    for: [all]
    if:
      type: string
      regex: "discord\\.com/api/webhooks"

  - id: ipinfo-io
    desc: ipinfo.io IP lookup service
    crit: inert
    conf: 0.7
    for: [all]
    if:
      type: string
      exact: "ipinfo.io"

composite_rules:
  # === Helper composites ===
  - id: chromium-browsers
    desc: Chromium-based browser names
    for: [all]
    any:
      - { id: google-chrome-path }
      - { id: chromium-string }
      - { id: microsoft-edge-path }
      - { id: brave-software-path }
      - { id: opera-string }
      - { id: vivaldi-string }
      - { id: chrome-string }
      - { id: brave-string }
      - { id: edge-string }

  - id: firefox-browsers
    desc: Firefox-based browser names
    for: [all]
    any:
      - { id: firefox-string }
      - { id: thunderbird-string }

  - id: all-browsers
    desc: All browser name patterns
    for: [all]
    any:
      - { id: chromium-browsers }
      - { id: firefox-browsers }
      - { id: safari-string }

  - id: credential-files
    desc: Browser credential data files
    for: [all]
    any:
      - { id: chromium/login-data }
      - { id: firefox/cookies-sqlite }
      - { id: local-state-file }
      - { id: encrypted-key-field }
      - { id: logins-json-file }
      - { id: key4-db-file }

  - id: decryption-methods
    desc: Credential decryption methods
    for: [all]
    any:
      - { id: crypt-unprotect-data-str }
      - { id: aes-string }
      - { id: decrypt-method }
      - { id: fernet-string }

  - id: exfiltration-channels
    desc: Exfiltration endpoints and methods
    for: [all]
    any:
      - { id: discord-webhook-pattern }
      - { id: discord-webhook-simple }
      - { id: telegram-api }
      - { id: multipart-form-data }
      - { id: post-method }
      - { id: ipinfo-io }

  - id: python-imports
    desc: Python credential stealer imports
    for: [python]
    any:
      - { id: import-sqlite3 }
      - { id: import-crypto-aes }
      - { id: import-win32crypt }
      - { id: import-requests }

  - id: windows-paths
    desc: Windows browser data paths
    for: [all]
    any:
      - { id: localappdata-var }
      - { id: appdata-var }
      - { id: google-chrome-windows-path }

  - id: password-fields
    desc: Browser password database fields
    for: [all]
    any:
      - { id: password-value-field }
      - { id: username-value-field }
      - { id: origin-url-field }

  # === Main detection composites ===
  - id: hackbrowserdata
    desc: HackBrowserData tool reference
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    any:
      - { id: hackbrowserdata-lower }
      - { id: hackbrowserdata-camel }

  # Migrated from YARA
  - id: multi-browser-theft
    desc: Multi-browser credential theft
    crit: suspicious
    conf: 0.9
    attack: "T1555.003"
    mbc: "B0028"
    for: [python, javascript, elf, pe, macho]
    all:
      - id: all-browsers
        count: 2
      - id: credential-files

  # Helper composite
  - id: sqlite-or-exfil
    desc: SQLite3 access or exfiltration channels
    any:
      - id: sqlite3-string
      - id: exfiltration-channels

  # Migrated from YARA
  - id: full-stealer-detected
    desc: Complete browser credential stealer (theft + decrypt + exfil)
    crit: suspicious
    conf: 0.98
    attack: "T1555.003"
    mbc: "B0028"
    for: [python, javascript, elf, pe, macho]
    all:
      - id: all-browsers
        count: 2
      - id: credential-files
        count: 2
      - id: decryption-methods
      - id: sqlite-or-exfil

  # Migrated from YARA
  - id: python-stealer
    desc: Python-based browser credential stealer
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    for: [python]
    all:
      - id: python-imports
      - id: windows-paths
      - id: password-fields
        count: 2
      - id: exfiltration-channels
