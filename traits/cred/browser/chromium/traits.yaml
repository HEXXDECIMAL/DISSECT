# Credential Access - Chromium Browser Data Theft
# Covers Chrome, Chromium, Edge, Brave, Opera, Vivaldi, and other Chromium-based browsers
# ATT&CK: T1555.003 (Credentials from Password Stores: Credentials from Web Browsers)

traits:
  # === Path/File References ===

  - id: chrome-path
    desc: Chrome browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    if:
      type: string
      exact: "/Google/Chrome"

  - id: brave-path
    desc: Brave browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    if:
      type: string
      exact: "BraveSoftware/Brave-Browser"

  - id: edge-path
    desc: Microsoft Edge browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    if:
      type: string
      exact: "Microsoft Edge"

  # === Opera path atomic indicators ===
  - id: opera-macos-path
    desc: Opera macOS profile path
    crit: notable
    conf: 0.6
    attack: "T1555.003"
    if:
      type: string
      exact: "com.operasoftware.Opera"

  - id: opera-windows-path
    desc: Opera Windows profile path
    crit: notable
    conf: 0.6
    attack: "T1555.003"
    if:
      type: string
      exact: "Opera Software/Opera"

  - id: operagx-path
    desc: Opera GX browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    if:
      type: string
      exact: "com.operasoftware.OperaGX"

  - id: vivaldi-path
    desc: Vivaldi browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    if:
      type: string
      exact: "Vivaldi"

  # === Arc path atomic indicators ===
  - id: arc-macos-path
    desc: Arc macOS profile path
    crit: notable
    conf: 0.6
    attack: "T1555.003"
    if:
      type: string
      exact: "/Arc/"

  - id: arc-userdata-path
    desc: Arc User Data path
    crit: notable
    conf: 0.6
    attack: "T1555.003"
    if:
      type: string
      exact: "Arc/User Data"

  - id: coccoc-path
    desc: Coccoc browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    if:
      type: string
      exact: "Coccoc"

  - id: cookies-path
    desc: Chromium Cookies file path
    crit: suspicious
    conf: 0.75
    attack: "T1555.003"
    if:
      type: string
      exact: "/Cookies"

  - id: local-state
    desc: Chromium Local State file
    crit: suspicious
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      exact: "Local State"

  - id: login-data
    desc: Chromium Login Data file reference
    crit: suspicious
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      exact: "Login Data"

  - id: web-data
    desc: Chromium Web Data file (passwords, cards)
    crit: suspicious
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      exact: "Web Data"

  # === Encryption/Decryption Keys ===

  - id: encrypted-key
    desc: Chromium encrypted_key field
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    if:
      type: string
      exact: "encrypted_key"

  - id: os-crypt
    desc: Chromium os_crypt structure
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    if:
      type: string
      exact: "os_crypt"

  # === Database Tables ===

  - id: credit-cards-table
    desc: Chromium credit_cards table
    crit: suspicious
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      exact: "credit_cards"

  - id: logins-table
    desc: Chromium logins table reference
    crit: suspicious
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      regex: "\\blogins\\b"

  # === SQL Queries (high confidence) ===

  - id: password-sql
    desc: Chromium Login Data SQL query (password theft)
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    if:
      type: string
      regex: "SELECT.{0,30}origin_url.{0,30}username_value.{0,30}password_value.{0,30}FROM\\s+logins"
      case_insensitive: true

  # === Cookie SQL atomic indicators ===
  - id: chromium-cookie-sql
    desc: Chromium cookies table SQL query
    crit: notable
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      regex: "SELECT.{0,30}host_key.{0,30}encrypted_value.{0,30}FROM\\s+cookies"
      case_insensitive: true

  - id: firefox-cookie-sql
    desc: Firefox moz_cookies table SQL query
    crit: notable
    conf: 0.8
    attack: "T1555.003"
    if:
      type: string
      regex: "SELECT.{0,30}host_key.{0,30}encrypted_value.{0,30}FROM\\s+moz_cookies"
      case_insensitive: true

  - id: credit-card-sql
    desc: Chromium credit card SQL query
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    if:
      type: string
      regex: "SELECT.{0,50}card_number.{0,30}FROM\\s+credit_cards"
      case_insensitive: true

composite_rules:
  # === Atomic Composites ===

  # Opera path composite
  - id: opera-path
    desc: Opera browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    requires_count: 1
    any:
      - id: opera-macos-path
      - id: opera-windows-path

  # Arc path composite
  - id: arc-path
    desc: Arc browser profile path
    crit: suspicious
    conf: 0.7
    attack: "T1555.003"
    requires_count: 1
    any:
      - id: arc-macos-path
      - id: arc-userdata-path

  # Cookie SQL composite
  - id: cookie-sql
    desc: Browser cookie SQL query
    crit: suspicious
    conf: 0.9
    attack: "T1555.003"
    requires_count: 1
    any:
      - id: chromium-cookie-sql
      - id: firefox-cookie-sql

  # === Composite Detections ===

  - id: cookie-theft
    desc: Chrome cookie file access
    crit: suspicious
    conf: 0.85
    attack: "T1555.003"
    all:
      - id: chrome-path
      - id: cookies-path

  - id: master-decrypt
    desc: Chromium master password decryption
    crit: suspicious
    conf: 0.9
    attack: "T1555.003"
    mbc: "E1003"
    all:
      - id: local-state
      - id: encrypted-key
      - id: os-crypt

  - id: password-theft
    desc: Chromium password database theft
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    for: [python, javascript, elf, pe, macho]
    all:
      - id: chrome-path
    any:
      - id: password-sql
      - id: login-data

  - id: credit-card-theft
    desc: Chromium credit card data theft
    crit: hostile
    conf: 0.9
    attack: "T1555.003"
    mbc: "B0028"
    for: [python, javascript, elf, pe, macho]
    all:
      - id: chrome-path
      - id: web-data
      - id: credit-cards-table

  # Multi-browser targeting (stealer behavior)
  - id: multi-browser
    desc: Multiple Chromium browsers targeted (stealer behavior)
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0028"
    for: [python, javascript, applescript, shell, elf, pe, macho]
    requires_count: 3
    any:
      - { id: chrome-path }
      - { id: brave-path }
      - { id: edge-path }
      - { id: opera-path }
      - { id: operagx-path }
      - { id: vivaldi-path }
      - { id: arc-path }
