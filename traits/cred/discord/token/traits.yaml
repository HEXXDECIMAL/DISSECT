# Credential Access - Discord Token Theft
# Stealing Discord authentication tokens from local storage
# ATT&CK: T1555.003 (Credentials from Web Browsers)

defaults:
  attack: "T1555.003"

traits:
  # Discord token regex pattern (standard)
  - id: regex-standard
    desc: Discord token regex pattern
    crit: suspicious
    conf: 0.95
    if:
      type: string
      # Matches: [A-Za-z0-9_-]{24}.[A-Za-z0-9_-]{6}.[A-Za-z0-9_-]{27}
      regex: '\\[\\\\w-\\]\\{24\\}\\.\\[\\\\w-\\]\\{6\\}\\.\\[\\\\w-\\]\\{27\\}'

  # Discord MFA token pattern
  - id: regex-mfa
    desc: Discord MFA token regex pattern
    crit: suspicious
    conf: 0.95
    if:
      type: string
      # Matches: mfa.[A-Za-z0-9_-]{84}
      regex: 'mfa\\.\\[\\\\w-\\]\\{84\\}'

  # Discord token literal pattern (actual token format)
  - id: literal-pattern
    desc: Discord token in code
    crit: suspicious
    conf: 0.9
    if:
      type: string
      # Actual token format: MTIzNDU2Nzg5.Gh1234.abcdef...
      regex: "[MN][A-Za-z0-9]{23,}\\.[A-Za-z0-9_-]{6}\\.[A-Za-z0-9_-]{27}"

  # Discord Local Storage path
  - id: localstorage-path
    desc: Discord Local Storage directory access
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "(?i)(discord|discordcanary|discordptb)[/\\\\]+(Local Storage|leveldb)"

  # Discord API user endpoint (token validation)
  - id: api-users-me
    desc: Discord API user validation endpoint
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me"

  # Discord billing endpoint (payment theft)
  - id: api-billing
    desc: Discord billing/payment API endpoint
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me/billing"

  # Discord payment sources endpoint
  - id: api-payment-sources
    desc: Discord payment sources API endpoint
    crit: suspicious
    conf: 0.95
    if:
      type: string
      exact: "payment-sources"

  # Discord relationships endpoint (friends list)
  - id: api-relationships
    desc: Discord relationships API endpoint
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "users/@me/relationships"

  # Discord channels endpoint (DM access)
  - id: api-channels
    desc: Discord channels API endpoint
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "users/@me/channels"

  # LevelDB storage reference
  - id: leveldb-ref
    desc: LevelDB storage reference
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "leveldb"

  # Local Storage reference
  - id: local-storage-ref
    desc: Local Storage directory reference
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Local Storage"

  # Discord application path
  - id: discord-path
    desc: Discord application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "Discord"

  # Discord Canary path
  - id: discord-canary-path
    desc: Discord Canary application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)discordcanary"

  # Discord PTB path
  - id: discord-ptb-path
    desc: Discord PTB application path reference
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "(?i)discordptb"

  # MFA token prefix
  - id: mfa-prefix
    desc: MFA token prefix indicator
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "mfa."

  # Users/@me API path
  - id: users-me-path
    desc: Discord users/@me API path
    crit: notable
    conf: 0.75
    if:
      type: string
      exact: "users/@me"

  # Discord webhook exfil
  - id: webhook-exfil
    desc: Discord webhook exfiltration endpoint
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "discord(app)?\\.com/api/webhooks/"

  # Telegram API exfil
  - id: telegram-exfil
    desc: Telegram API exfiltration endpoint
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "api.telegram.org"

  # Chrome browser path
  - id: chrome-browser
    desc: Chrome browser reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "Chrome"

  # Opera browser path
  - id: opera-browser
    desc: Opera browser reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "Opera"

  # Brave browser path
  - id: brave-browser
    desc: Brave browser reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "Brave"

  # Edge browser path
  - id: edge-browser
    desc: Edge browser reference
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "Edge"

  # LDB file extension
  - id: ldb-extension
    desc: LevelDB file extension
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: ".ldb"

  # Log file extension
  - id: log-extension
    desc: Log file extension
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: ".log"

  # Token keyword
  - id: token-keyword
    desc: Token keyword reference
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "(?i)token"

composite_rules:
  # Discord token stealer composite
  - id: stealer-detected
    desc: Discord token stealer detected
    crit: suspicious
    conf: 0.98
    attack: "T1555.003"
    mbc: "B0030"
    for: [javascript, python, elf, pe, macho]
    any:
      - id: leveldb-ref
      - id: discord-path
      - id: regex-standard
      - id: webhook-exfil

  # Discord token grabber with browser enumeration
  - id: browser-grabber
    desc: Discord token grabber targeting multiple browsers
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    mbc: "B0030"
    for: [javascript, python, elf, pe, macho]
    all:
      - id: discord-path
      - id: token-keyword
