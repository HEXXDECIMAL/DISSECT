# Credential Access - Discord Token Theft
# Stealing Discord authentication tokens from local storage
# ATT&CK: T1555.003 (Credentials from Web Browsers)

defaults:
  attack: "T1555.003"

traits:
  # Discord token regex pattern (standard)
  - id: regex-standard
    description: Discord token regex pattern
    criticality: suspicious
    confidence: 0.95
    condition:
      type: string
      # Matches: [A-Za-z0-9_-]{24}.[A-Za-z0-9_-]{6}.[A-Za-z0-9_-]{27}
      regex: '\\[\\\\w-\\]\\{24\\}\\.\\[\\\\w-\\]\\{6\\}\\.\\[\\\\w-\\]\\{27\\}'

  # Discord MFA token pattern
  - id: regex-mfa
    description: Discord MFA token regex pattern
    criticality: suspicious
    confidence: 0.95
    condition:
      type: string
      # Matches: mfa.[A-Za-z0-9_-]{84}
      regex: 'mfa\\.\\[\\\\w-\\]\\{84\\}'

  # Discord token literal pattern (actual token format)
  - id: literal-pattern
    description: Discord token in code
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      # Actual token format: MTIzNDU2Nzg5.Gh1234.abcdef...
      regex: "[MN][A-Za-z0-9]{23,}\\.[A-Za-z0-9_-]{6}\\.[A-Za-z0-9_-]{27}"

  # Discord Local Storage path
  - id: localstorage-path
    description: Discord Local Storage directory access
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      regex: "(?i)(discord|discordcanary|discordptb)[/\\\\]+(Local Storage|leveldb)"

  # Discord API user endpoint (token validation)
  - id: api-users-me
    description: Discord API user validation endpoint
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me"

  # Discord billing endpoint (payment theft)
  - id: api-billing
    description: Discord billing/payment API endpoint
    criticality: suspicious
    confidence: 0.95
    condition:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me/billing"

  # Discord payment sources endpoint
  - id: api-payment-sources
    description: Discord payment sources API endpoint
    criticality: suspicious
    confidence: 0.95
    condition:
      type: string
      exact: "payment-sources"

  # Discord relationships endpoint (friends list)
  - id: api-relationships
    description: Discord relationships API endpoint
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "users/@me/relationships"

  # Discord channels endpoint (DM access)
  - id: api-channels
    description: Discord channels API endpoint
    criticality: suspicious
    confidence: 0.8
    condition:
      type: string
      regex: "users/@me/channels"

  # LevelDB storage reference
  - id: leveldb-ref
    description: LevelDB storage reference
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "leveldb"

  # Local Storage reference
  - id: local-storage-ref
    description: Local Storage directory reference
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "Local Storage"

  # Discord application path
  - id: discord-path
    description: Discord application path reference
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "Discord"

  # Discord Canary path
  - id: discord-canary-path
    description: Discord Canary application path reference
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "(?i)discordcanary"

  # Discord PTB path
  - id: discord-ptb-path
    description: Discord PTB application path reference
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "(?i)discordptb"

  # MFA token prefix
  - id: mfa-prefix
    description: MFA token prefix indicator
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      exact: "mfa."

  # Users/@me API path
  - id: users-me-path
    description: Discord users/@me API path
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      exact: "users/@me"

  # Discord webhook exfil
  - id: webhook-exfil
    description: Discord webhook exfiltration endpoint
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      regex: "discord(app)?\\.com/api/webhooks/"

  # Telegram API exfil
  - id: telegram-exfil
    description: Telegram API exfiltration endpoint
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      exact: "api.telegram.org"

  # Chrome browser path
  - id: chrome-browser
    description: Chrome browser reference
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      exact: "Chrome"

  # Opera browser path
  - id: opera-browser
    description: Opera browser reference
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      exact: "Opera"

  # Brave browser path
  - id: brave-browser
    description: Brave browser reference
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      exact: "Brave"

  # Edge browser path
  - id: edge-browser
    description: Edge browser reference
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      exact: "Edge"

  # LDB file extension
  - id: ldb-extension
    description: LevelDB file extension
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      exact: ".ldb"

  # Log file extension
  - id: log-extension
    description: Log file extension
    criticality: notable
    confidence: 0.5
    condition:
      type: string
      exact: ".log"

  # Token keyword
  - id: token-keyword
    description: Token keyword reference
    criticality: notable
    confidence: 0.5
    condition:
      type: string
      regex: "(?i)token"

composite_rules:
  # Discord token stealer composite
  - id: stealer-detected
    description: Discord token stealer detected
    criticality: suspicious
    confidence: 0.98
    attack: "T1555.003"
    mbc: "B0030"
    file_types: [javascript, python, elf, pe, macho]
    requires_any:
      - type: trait
        id: leveldb-ref
      - type: trait
        id: discord-path
      - type: trait
        id: regex-standard
      - type: trait
        id: webhook-exfil

  # Discord token grabber with browser enumeration
  - id: browser-grabber
    description: Discord token grabber targeting multiple browsers
    criticality: suspicious
    confidence: 0.95
    attack: "T1555.003"
    mbc: "B0030"
    file_types: [javascript, python, elf, pe, macho]
    requires_all:
      - type: trait
        id: discord-path
      - type: trait
        id: token-keyword
