# Credential Access - Discord Token Theft
# Stealing Discord authentication tokens from local storage
# ATT&CK: T1555.003 (Credentials from Web Browsers)

defaults:
  attack: "T1555.003"

traits:
  # Discord token regex pattern (standard)
  - id: regex-standard
    description: Discord token regex pattern
    criticality: suspicious
    confidence: 0.95
    condition:
      type: string
      # Matches: [A-Za-z0-9_-]{24}.[A-Za-z0-9_-]{6}.[A-Za-z0-9_-]{27}
      regex: '\\[\\\\w-\\]\\{24\\}\\.\\[\\\\w-\\]\\{6\\}\\.\\[\\\\w-\\]\\{27\\}'

  # Discord MFA token pattern
  - id: regex-mfa
    description: Discord MFA token regex pattern
    criticality: suspicious
    confidence: 0.95
    condition:
      type: string
      # Matches: mfa.[A-Za-z0-9_-]{84}
      regex: 'mfa\\.\\[\\\\w-\\]\\{84\\}'

  # Discord token literal pattern (actual token format)
  - id: literal-pattern
    description: Discord token in code
    criticality: hostile
    confidence: 0.9
    condition:
      type: string
      # Actual token format: MTIzNDU2Nzg5.Gh1234.abcdef...
      regex: "[MN][A-Za-z0-9]{23,}\\.[A-Za-z0-9_-]{6}\\.[A-Za-z0-9_-]{27}"

  # Discord Local Storage path
  - id: localstorage-path
    description: Discord Local Storage directory access
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      regex: "(?i)(discord|discordcanary|discordptb)[/\\\\]+(Local Storage|leveldb)"

  # Discord API user endpoint (token validation)
  - id: api-users-me
    description: Discord API user validation endpoint
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me"

  # Discord billing endpoint (payment theft)
  - id: api-billing
    description: Discord billing/payment API endpoint
    criticality: hostile
    confidence: 0.95
    condition:
      type: string
      regex: "discord(app)?\\.com/api/(v[0-9]+/)?users/@me/billing"

  # Discord payment sources endpoint
  - id: api-payment-sources
    description: Discord payment sources API endpoint
    criticality: hostile
    confidence: 0.95
    condition:
      type: string
      exact: "payment-sources"

  # Discord relationships endpoint (friends list)
  - id: api-relationships
    description: Discord relationships API endpoint
    criticality: suspicious
    confidence: 0.85
    condition:
      type: string
      regex: "users/@me/relationships"

  # Discord channels endpoint (DM access)
  - id: api-channels
    description: Discord channels API endpoint
    criticality: suspicious
    confidence: 0.8
    condition:
      type: string
      regex: "users/@me/channels"

composite_rules:
  # Discord token stealer composite
  - id: stealer-detected
    description: Discord token stealer detected
    criticality: hostile
    confidence: 0.98
    attack: "T1555.003"
    mbc: "B0030"
    condition:
      type: yara
      source: |
        rule discord_token_stealer {
          meta:
            description = "Detects Discord token stealing malware"
          strings:
            // Token extraction patterns
            $leveldb = "leveldb" ascii nocase
            $localstorage = "Local Storage" ascii
            // Discord paths
            $discord_path1 = "Discord" ascii
            $discord_path2 = "discordcanary" ascii nocase
            $discord_path3 = "discordptb" ascii nocase
            // Token regex patterns
            $token_regex1 = /\[\\w-\]\{24\}\.\[\\w-\]\{6\}/ ascii
            $token_regex2 = "mfa." ascii
            // API validation
            $api_me = "users/@me" ascii
            // Exfil indicators
            $webhook = /discord(app)?\.com\/api\/webhooks\// ascii
            $telegram = "api.telegram.org" ascii
          condition:
            filesize < 10MB and
            ($leveldb or $localstorage) and
            any of ($discord_path*) and
            (any of ($token_regex*) or $api_me) and
            any of ($webhook, $telegram)
        }

  # Discord token grabber with browser enumeration
  - id: browser-grabber
    description: Discord token grabber targeting multiple browsers
    criticality: hostile
    confidence: 0.95
    attack: "T1555.003"
    condition:
      type: yara
      source: |
        rule discord_browser_token_grabber {
          meta:
            description = "Discord token grabber enumerating browsers"
          strings:
            $discord = "Discord" ascii
            $chrome = "Chrome" ascii
            $opera = "Opera" ascii
            $brave = "Brave" ascii
            $edge = "Edge" ascii
            $leveldb = "leveldb" ascii
            $ldb = ".ldb" ascii
            $log = ".log" ascii
            $token = "token" ascii nocase
          condition:
            filesize < 10MB and
            $discord and
            2 of ($chrome, $opera, $brave, $edge) and
            ($leveldb or $ldb or $log) and
            $token
        }
