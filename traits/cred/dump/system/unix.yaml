# Credential Dumping - Unix
# MBC: E1003 (OS Credential Dumping)
# ATT&CK: T1003 (OS Credential Dumping)

traits:
  # === Atomic: Password Database Functions ===

  - id: getpwnam
    description: Read user password database (getpwnam)
    criticality: inert
    confidence: 0.7
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [unix, linux, macos]
    file_types: [elf, macho, so, dylib]
    condition:
      type: symbol
      pattern: "getpwnam"

  - id: getpwuid
    description: Read user password database by UID (getpwuid)
    criticality: inert
    confidence: 0.7
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [unix, linux, macos]
    file_types: [elf, macho, so, dylib]
    condition:
      type: symbol
      pattern: "getpwuid"

  - id: getspnam
    description: Read shadow password file (getspnam)
    criticality: notable
    confidence: 0.8
    mbc: "E1003.008"
    attack: "T1003.008"
    platforms: [linux, unix]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "getspnam"

  # === Atomic: Direct File Access ===

  # NOTE: For ELF binaries, shadow file access is common in system utilities
  # Real credential dumping detection requires additional context
  - id: shadow-file
    description: Access to system shadow password file
    criticality: notable
    confidence: 0.9
    attack: "T1003.008"
    condition:
      type: string
      regex: "/etc/(shadow|gshadow|master.passwd)"


  # NOTE: /etc/passwd is defined in discovery/user/traits.yaml as etc-passwd

  # NOTE: System utilities like busybox legitimately access gshadow
  - id: gshadow-file
    description: Group shadow file access (/etc/gshadow)
    criticality: notable
    confidence: 0.6
    attack: "T1003.008"
    platforms: [linux]
    file_types: [elf, macho, shell, perl, python, ruby]
    condition:
      type: string
      exact: "/etc/gshadow"

  - id: master-passwd
    description: BSD master.passwd file access
    criticality: suspicious
    confidence: 0.9
    attack: "T1003.008"
    platforms: [macos, unix]
    file_types: [elf, macho, shell, perl, python, ruby]
    condition:
      type: string
      exact: "/etc/master.passwd"

composite_rules:
  - id: shadow-extraction
    description: Shadow file credential extraction
    criticality: suspicious
    confidence: 0.9
    attack: "T1003.008"
    mbc: "E1003.008"
    platforms: [linux, unix]
    file_types: [elf]
    requires_any:
      - type: trait
        id: getspnam
      - type: trait
        id: shadow-file
