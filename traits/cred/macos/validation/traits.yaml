# macOS Credential Validation Detection
# Detects techniques to validate stolen credentials
# ATT&CK: T1110 (Brute Force), T1078 (Valid Accounts)

defaults:
  attack: "T1110"
  platforms: [macos]
  criticality: suspicious

traits:
  # dscl authonly - verify password without creating session
  - id: dscl-authonly
    description: "macOS dscl password validation (authonly)"
    criticality: suspicious
    confidence: 0.95
    attack: "T1110.001"
    mbc: "E1110"
    condition:
      type: string
      regex: "dscl\\s+\\.\\s+authonly|dscl.*-authonly"

  # dscl read - enumerate user information
  - id: dscl-read
    description: "macOS Directory Services user enumeration"
    criticality: notable
    confidence: 0.7
    attack: "T1087.001"
    condition:
      type: string
      regex: "dscl\\s+\\.\\s+read|dscl.*-read"

  # dscl list - list users/groups
  - id: dscl-list
    description: "macOS Directory Services listing"
    criticality: notable
    confidence: 0.65
    attack: "T1087.001"
    condition:
      type: string
      regex: "dscl\\s+\\.\\s+list|dscl\\s+\\.\\s+-list"

  # NOTE: /etc/passwd is defined in discovery/user/traits.yaml

  # Shadow password access
  - id: shadow-hash
    description: "Access to shadow password hashes"
    criticality: suspicious
    confidence: 0.85
    attack: "T1003.008"
    condition:
      type: string
      regex: "/var/db/dslocal|ShadowHashData|/etc/shadow"

  # Password/credential keyword reference
  - id: credential-keyword
    description: "Password or credential keyword reference"
    criticality: notable
    confidence: 0.6
    condition:
      type: string
      regex: "password|pwd|credential"
      case_insensitive: true

composite_rules:
  # Password validation + capture = credential theft
  - id: validation-theft
    description: "macOS credential capture and validation"
    criticality: hostile
    confidence: 0.95
    attack: "T1110.001"
    file_types: [shell, applescript, python]
    requires_all:
      - type: trait
        id: dscl-authonly
    requires_any:
      - type: trait
        id: credential-keyword
      - type: trait
        id: evasion/applescript/password-dialog
