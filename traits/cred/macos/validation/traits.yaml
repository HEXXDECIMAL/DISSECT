# macOS Credential Validation Detection
# Detects techniques to validate stolen credentials
# ATT&CK: T1110 (Brute Force), T1078 (Valid Accounts)

defaults:
  attack: "T1110"
  platforms: [macos]
  crit: suspicious

traits:
  # === dscl authonly atomic indicators ===
  - id: dscl-dot-authonly
    desc: dscl . authonly command
    crit: notable
    conf: 0.85
    attack: "T1110.001"
    mbc: "E1110"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+authonly"

  - id: dscl-flag-authonly
    desc: dscl -authonly flag
    crit: notable
    conf: 0.85
    attack: "T1110.001"
    mbc: "E1110"
    if:
      type: string
      regex: "dscl.*-authonly"

  # === dscl read atomic indicators ===
  - id: dscl-dot-read
    desc: dscl . read command
    crit: inert
    conf: 0.6
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+read"

  - id: dscl-flag-read
    desc: dscl -read flag
    crit: inert
    conf: 0.6
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl.*-read"

  # === dscl list atomic indicators ===
  - id: dscl-dot-list
    desc: dscl . list command
    crit: inert
    conf: 0.55
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+list"

  - id: dscl-flag-list
    desc: dscl . -list command
    crit: inert
    conf: 0.55
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+-list"

  # NOTE: /etc/passwd is defined in discovery/user/traits.yaml

  # === Shadow password atomic indicators ===
  - id: dslocal-db
    desc: /var/db/dslocal directory
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      exact: "/var/db/dslocal"

  - id: shadow-hash-data
    desc: ShadowHashData reference
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      exact: "ShadowHashData"

  - id: etc-shadow
    desc: /etc/shadow file
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      exact: "/etc/shadow"

  # === Credential keyword atomic indicators ===
  - id: password-word
    desc: password keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "password"
      case_insensitive: true

  - id: pwd-word
    desc: pwd keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "pwd"
      case_insensitive: true

  - id: credential-word
    desc: credential keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "credential"
      case_insensitive: true

composite_rules:
  # dscl authonly composite
  - id: dscl-authonly
    desc: macOS dscl password validation (authonly)
    crit: suspicious
    conf: 0.95
    attack: "T1110.001"
    mbc: "E1110"
    requires_count: 1
    any:
      - id: dscl-dot-authonly
      - id: dscl-flag-authonly

  # dscl read composite
  - id: dscl-read
    desc: macOS Directory Services user enumeration
    crit: notable
    conf: 0.7
    attack: "T1087.001"
    requires_count: 1
    any:
      - id: dscl-dot-read
      - id: dscl-flag-read

  # dscl list composite
  - id: dscl-list
    desc: macOS Directory Services listing
    crit: notable
    conf: 0.65
    attack: "T1087.001"
    requires_count: 1
    any:
      - id: dscl-dot-list
      - id: dscl-flag-list

  # Shadow hash access composite
  - id: shadow-hash
    desc: "Access to shadow password hashes"
    crit: suspicious
    conf: 0.85
    attack: "T1003.008"
    requires_count: 1
    any:
      - id: dslocal-db
      - id: shadow-hash-data
      - id: etc-shadow

  # Credential keyword composite
  - id: credential-keyword
    desc: "Password or credential keyword reference"
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: password-word
      - id: pwd-word
      - id: credential-word

  # Password validation + capture = credential theft
  - id: validation-theft
    desc: "macOS credential capture and validation"
    crit: hostile
    conf: 0.95
    attack: "T1110.001"
    for: [shell, applescript, python]
    all:
      - id: dscl-authonly
    any:
      - id: credential-keyword
      - id: evasion/applescript/password-dialog
