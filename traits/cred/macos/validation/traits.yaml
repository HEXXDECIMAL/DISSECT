# macOS Credential Validation Detection
# Detects techniques to validate stolen credentials
# ATT&CK: T1110 (Brute Force), T1078 (Valid Accounts)

defaults:
  attack: "T1110"
  platforms: [macos]
  criticality: suspicious

traits:
  # dscl authonly - verify password without creating session
  - id: credential/macos/dscl-authonly
    description: "macOS dscl password validation (authonly)"
    criticality: hostile
    confidence: 0.95
    attack: "T1110.001"
    mbc: "E1110"
    condition:
      type: string
      regex: "dscl\\s+\\.\\s+authonly|dscl.*-authonly"

  # dscl read - enumerate user information
  - id: credential/macos/dscl-read
    description: "macOS Directory Services user enumeration"
    criticality: notable
    confidence: 0.7
    attack: "T1087.001"
    condition:
      type: string
      regex: "dscl\\s+\\.\\s+read|dscl.*-read"

  # dscl list - list users/groups
  - id: credential/macos/dscl-list
    description: "macOS Directory Services listing"
    criticality: notable
    confidence: 0.65
    attack: "T1087.001"
    condition:
      type: string
      regex: "dscl\\s+\\.\\s+list|dscl\\s+\\.\\s+-list"

  # Password file access
  - id: credential/macos/etc-passwd
    description: "Access to /etc/passwd"
    criticality: notable
    confidence: 0.6
    attack: "T1003.008"
    condition:
      type: string
      exact: "/etc/passwd"

  # Shadow password access
  - id: credential/macos/shadow-hash
    description: "Access to shadow password hashes"
    criticality: suspicious
    confidence: 0.85
    attack: "T1003.008"
    condition:
      type: string
      regex: "/var/db/dslocal|ShadowHashData|/etc/shadow"

composite_rules:
  # Password validation + capture = credential theft
  - id: credential/macos/validation-theft
    description: "macOS credential capture and validation"
    criticality: hostile
    confidence: 0.95
    attack: "T1110.001"
    requires_all:
      - type: trait
        id: credential/macos/dscl-authonly
    requires_any:
      - type: string
        regex: "password|pwd|credential"
      - type: trait
        id: evasion/applescript/password-dialog
