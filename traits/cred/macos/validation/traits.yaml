# macOS Credential Validation Detection
# Detects techniques to validate stolen credentials
# ATT&CK: T1110 (Brute Force), T1078 (Valid Accounts)

defaults:
  attack: "T1110"
  platforms: [macos]
  crit: suspicious

traits:
  # === dscl authonly atomic indicators ===
  - id: dscl-dot-authonly
    desc: dscl . authonly command
    crit: notable
    conf: 0.85
    attack: "T1110.001"
    mbc: "E1110"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+authonly"

  - id: dscl-flag-authonly
    desc: dscl -authonly flag
    crit: notable
    conf: 0.85
    attack: "T1110.001"
    mbc: "E1110"
    if:
      type: string
      regex: "dscl.{0,30}-authonly"

  # === dscl read atomic indicators ===
  - id: dscl-dot-read
    desc: dscl . read command
    crit: inert
    conf: 0.6
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+read"

  - id: dscl-flag-read
    desc: dscl -read flag
    crit: inert
    conf: 0.6
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl.{0,30}-read"

  # === dscl list atomic indicators ===
  - id: dscl-dot-list
    desc: dscl . list command
    crit: inert
    conf: 0.55
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+list"

  - id: dscl-flag-list
    desc: dscl . -list command
    crit: inert
    conf: 0.55
    attack: "T1087.001"
    if:
      type: string
      regex: "dscl\\s+\\.\\s+-list"

  # NOTE: /etc/passwd is defined in discovery/user/traits.yaml

  # === Shadow password atomic indicators ===
  - id: dslocal-db
    desc: /var/db/dslocal directory
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      exact: "/var/db/dslocal"

  - id: shadow-hash-data
    desc: ShadowHashData reference
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      exact: "ShadowHashData"

  - id: etc-shadow
    desc: /etc/shadow file
    crit: inert
    conf: 0.7
    attack: "T1003.008"
    if:
      type: string
      exact: "/etc/shadow"

  # Credential keyword atomic indicators moved to data/text/generic.yaml

  # === CoreServices Identity API micro-traits ===
  - id: csidentity-auth-password
    desc: "Validates user password against macOS user database (credential testing)"
    crit: suspicious
    conf: 0.9
    attack: "T1110.001"
    mbc: "E1110"
    platforms: [macos]
    for: [macho]
    if:
      type: symbol
      pattern: "CSIdentityAuthenticateUsingPassword"

  - id: csidentity-query-create
    desc: "Creates query to search macOS user directory by username"
    crit: notable
    conf: 0.75
    attack: "T1087.001"
    platforms: [macos]
    for: [macho]
    if:
      type: symbol
      pattern: "CSIdentityQueryCreateForName"

  - id: csidentity-query-execute
    desc: "Executes user directory search on macOS system"
    crit: notable
    conf: 0.75
    attack: "T1087.001"
    platforms: [macos]
    for: [macho]
    if:
      type: symbol
      pattern: "CSIdentityQueryExecute"

  - id: csidentity-query-results
    desc: "Retrieves user account results from macOS directory query"
    crit: notable
    conf: 0.75
    attack: "T1087.001"
    platforms: [macos]
    for: [macho]
    if:
      type: symbol
      pattern: "CSIdentityQueryCopyResults"

  - id: csidentity-authority
    desc: "Accesses macOS default user account authority (Directory Services)"
    crit: notable
    conf: 0.7
    attack: "T1087.001"
    platforms: [macos]
    for: [macho]
    if:
      type: symbol
      pattern: "CSGetDefaultIdentityAuthority"

composite_rules:
  # dscl authonly composite
  - id: dscl-authonly
    desc: macOS dscl password validation (authonly)
    crit: suspicious
    conf: 0.95
    attack: "T1110.001"
    mbc: "E1110"
    count: 1
    any:
      - id: dscl-dot-authonly
      - id: dscl-flag-authonly

  # dscl read composite
  - id: dscl-read
    desc: macOS Directory Services user enumeration
    crit: notable
    conf: 0.7
    attack: "T1087.001"
    count: 1
    any:
      - id: dscl-dot-read
      - id: dscl-flag-read

  # dscl list composite
  - id: dscl-list
    desc: macOS Directory Services listing
    crit: notable
    conf: 0.65
    attack: "T1087.001"
    count: 1
    any:
      - id: dscl-dot-list
      - id: dscl-flag-list

  # Shadow hash access composite
  - id: shadow-hash
    desc: "Access to shadow password hashes"
    crit: suspicious
    conf: 0.85
    attack: "T1003.008"
    count: 1
    any:
      - id: dslocal-db
      - id: shadow-hash-data
      - id: etc-shadow

  # Credential keyword composite - references generic terms
  - id: credential-keyword
    desc: "Password or credential keyword reference"
    crit: inert
    conf: 0.3
    count: 1
    any:
      - id: data/text/generic/password
      - id: data/text/generic/pwd
      - id: data/text/generic/credential

  # CoreServices Identity query composite
  - id: csidentity-query
    desc: "macOS user enumeration via CoreServices Identity"
    crit: suspicious
    conf: 0.85
    attack: "T1087.001"
    platforms: [macos]
    for: [macho]
    all:
      - id: csidentity-query-create
    count: 1
    any:
      - id: csidentity-query-execute
      - id: csidentity-query-results

  # CoreServices password authentication composite
  - id: csidentity-password-auth
    desc: "macOS password authentication via CoreServices Identity API"
    crit: hostile
    conf: 0.95
    attack: "T1110.001"
    mbc: "E1110"
    platforms: [macos]
    for: [macho]
    all:
      - id: csidentity-auth-password
    any:
      - id: csidentity-query-create
      - id: csidentity-authority

  # Password validation + capture = credential theft
  - id: validation-theft
    desc: "macOS credential capture and validation"
    crit: hostile
    conf: 0.95
    attack: "T1110.001"
    for: [shell, applescript, python]
    all:
      - id: dscl-authonly
    any:
      - id: credential-keyword
      - id: evasion/applescript/password-dialog
