# Keylogging Detection - Python
# MBC: B0015 (Keylogging)
# ATT&CK: T1056.001 (Input Capture: Keylogging)

defaults:
  file_types: [python]
  mbc: "B0015"
  attack: "T1056.001"
  criticality: suspicious

traits:
  # pyHook - Windows keyboard hook library
  - id: credential/keylog/capture/python-pyhook
    description: "Windows keyboard hooking (pyHook)"
    confidence: 0.85
    platforms: [windows]
    condition:
      type: string
      regex: "import pyHook|from pyHook|pyHook\\.HookManager"

  # pyWinhook - maintained fork of pyHook
  - id: credential/keylog/capture/python-pywinhook
    description: "Windows keyboard hooking (pyWinhook)"
    confidence: 0.85
    platforms: [windows]
    condition:
      type: string
      regex: "import pyWinhook|from pyWinhook|pyWinhook\\.HookManager"

  # keyboard module - cross-platform
  - id: credential/keylog/capture/python-keyboard
    description: "Cross-platform keyboard capture (keyboard module)"
    confidence: 0.8
    condition:
      type: string
      regex: "import keyboard|keyboard\\.on_press|keyboard\\.hook|keyboard\\.record"

  # pynput keyboard listener (more specific than existing trait)
  - id: credential/keylog/capture/python-pynput-listener
    description: "Keyboard listener via pynput"
    confidence: 0.8
    condition:
      type: string
      regex: "keyboard\\.Listener\\(|on_press\\s*=|on_release\\s*="

  # HookKeyboard method call
  - id: credential/keylog/capture/python-hook-keyboard
    description: "Keyboard hook registration"
    confidence: 0.9
    condition:
      type: string
      regex: "\\.HookKeyboard\\(\\)"

  # KeyDown event handler
  - id: credential/keylog/capture/python-keydown-handler
    description: "KeyDown event handler registration"
    confidence: 0.85
    condition:
      type: string
      regex: "\\.KeyDown\\s*="

composite_rules:
  # Full keylogger pattern: hook + log to file
  - id: credential/keylog/capture/python-keylogger-file
    description: "Keylogger writing to file"
    confidence: 0.95
    criticality: hostile
    requires_all:
      - type: string
        regex: "import pyHook|import pyWinhook|import keyboard|pynput.*keyboard"
      - type: string
        regex: "open\\([^)]+[\"'](?:a|w)[\"']"

  # Windows keyboard hook with exfiltration
  - id: credential/keylog/capture/python-keylogger-exfil
    description: "Keylogger with network exfiltration"
    confidence: 0.95
    criticality: hostile
    requires_all:
      - type: string
        regex: "HookKeyboard\\(\\)|keyboard\\.Listener|keyboard\\.hook"
      - type: string
        regex: "requests\\.(post|get)|urllib|socket\\."
