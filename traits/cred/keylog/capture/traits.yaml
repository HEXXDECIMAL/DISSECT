# Keylogging Detection
# MBC: B0015 (Keylogging)
# ATT&CK: T1056.001 (Input Capture: Keylogging)
#
# NOTE: Single keyboard API usage is suspicious but not hostile.
# These APIs are used legitimately by accessibility software, games,
# hotkey managers, and automation tools. Hostile classification
# requires multiple indicators (e.g., keyboard capture + exfiltration).

defaults:
  mbc: "B0015"
  attack: "T1056.001"
  criticality: suspicious

traits:
  # === Atomic: Windows Keyboard Hooks ===
  - id: windows-hook
    description: Windows keyboard hooking via SetWindowsHookEx
    confidence: 0.7
    mbc: "B0015.001"
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: symbol
      pattern: "SetWindowsHookEx"

  - id: windows-rawinput
    description: Windows raw input API for keyboard access
    confidence: 0.7
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: symbol
      pattern: "GetRawInputData"

  - id: windows-asynckey
    description: Windows GetAsyncKeyState for key polling
    confidence: 0.65
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: symbol
      pattern: "GetAsyncKeyState"

  # === Atomic: Linux Keyboard Input ===
  - id: linux-input-device
    description: Direct access to Linux input devices
    confidence: 0.75
    platforms: [linux]
    file_types: [elf, python, shell]
    condition:
      type: string
      regex: "/dev/input/event[0-9]+"

  - id: x11-grab
    description: X11 key grabbing for keylogging
    confidence: 0.65
    platforms: [linux, unix]
    file_types: [elf, so]
    condition:
      type: symbol
      pattern: "XGrabKey"

  # === Atomic: macOS Keyboard Capture ===
  - id: macos-eventtap
    description: macOS CGEventTap for key interception
    confidence: 0.7
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "CGEventTapCreate"

  # === Atomic: Language Libraries ===
  - id: go-gohook
    description: Go robotn/gohook keyboard capture library
    confidence: 0.75
    file_types: [elf, macho]
    condition:
      type: string
      exact: "github.com/robotn/gohook"

  # === Python pynput atomic indicators ===
  - id: pynput-import-keyboard
    description: from pynput import keyboard
    confidence: 0.5
    file_types: [python]
    condition:
      type: string
      exact: "from pynput import keyboard"

  - id: pynput-keyboard-import
    description: from pynput.keyboard import
    confidence: 0.5
    file_types: [python]
    condition:
      type: string
      regex: "from pynput\\.keyboard"

  # === JS iohook atomic indicators ===
  - id: require-iohook
    description: require("iohook")
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      regex: "require\\(['\"]iohook['\"]\\)"

  - id: import-iohook
    description: from "iohook" import
    confidence: 0.6
    file_types: [javascript]
    condition:
      type: string
      regex: "from ['\"]iohook['\"]"

  # === Rust rdev atomic indicators ===
  - id: use-rdev
    description: "use rdev:: import statement"
    confidence: 0.5
    file_types: [rust]
    condition:
      type: string
      regex: "use rdev::"

  - id: extern-crate-rdev
    description: extern crate rdev
    confidence: 0.5
    file_types: [rust]
    condition:
      type: string
      exact: "extern crate rdev"

  # === AppleScript Keystroke Capture ===
  # YARA rule with multiple string matches - can stay hostile with file_types
  - id: applescript-keystroke
    description: AppleScript keystroke capture
    criticality: suspicious
    confidence: 0.95
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    # osascript can be invoked from any language
    file_types: ["*"]
    condition:
      type: yara
      source: |
        rule applescript_keystroke {
          strings:
            $osascript = "osascript" ascii nocase
            $keystroke = "keystroke" ascii nocase
            $keycode = "key code" ascii nocase
            $keydown = "key down" ascii nocase
            $systemevents = "System Events" ascii nocase
          condition:
            $osascript and any of ($keystroke, $keycode, $keydown, $systemevents)
        }

  # JXA (JavaScript for Automation) keystroke capture
  # YARA rule with multiple string matches - can stay hostile with file_types
  - id: jxa-keystroke
    description: JXA (JavaScript for Automation) keystroke capture
    criticality: suspicious
    confidence: 0.95
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    file_types: [javascript]
    condition:
      type: yara
      source: |
        rule jxa_keystroke {
          strings:
            $app = "Application(" ascii
            $systemevents = "System Events" ascii
            $keystroke = "keystroke" ascii
            $keycode = "keyCode" ascii
          condition:
            $app and $systemevents and any of ($keystroke, $keycode)
        }

  # Node.js AppleScript execution for keystroke
  - id: node-applescript
    description: Node.js AppleScript execution
    criticality: suspicious
    confidence: 0.85
    mbc: "B0015"
    attack: "T1059.002"
    platforms: [macos]
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule node_applescript {
          strings:
            $require1 = "require('applescript')" ascii
            $require2 = "require(\"applescript\")" ascii
            $require3 = "node-osascript" ascii
            $run = "run-applescript" ascii
            $exec = "execSync" ascii
            $osascript = "osascript" ascii
          condition:
            any of ($require*) or ($osascript and $exec) or $run
        }

composite_rules:
  # Python pynput composite
  - id: python-pynput
    description: Python pynput keyboard listener
    confidence: 0.7
    file_types: [python]
    requires_count: 1
    conditions:
      - id: pynput-import-keyboard
      - id: pynput-keyboard-import

  # JS iohook composite
  - id: js-iohook
    description: Node.js iohook global keyboard hook library
    confidence: 0.75
    file_types: [javascript]
    requires_count: 1
    conditions:
      - id: require-iohook
      - id: import-iohook

  # Rust rdev composite
  - id: rust-rdev
    description: Rust rdev keyboard event library
    confidence: 0.65
    file_types: [rust]
    requires_count: 1
    conditions:
      - id: use-rdev
      - id: extern-crate-rdev

  # === Platform Composite Rules ===
  # Multiple keyboard-related indicators - still only suspicious
  # Hostile classification requires exfiltration indicators
  - id: windows-keylogger
    description: Windows keylogger pattern (multiple keyboard APIs)
    confidence: 0.85
    platforms: [windows]
    file_types: [pe, dll]
    requires_count: 2
    conditions:
      - id: windows-hook
      - id: windows-rawinput
      - id: windows-asynckey

  - id: linux-keylogger
    description: Linux keylogger pattern (multiple input methods)
    confidence: 0.85
    platforms: [linux]
    file_types: [elf]
    requires_all:
      - id: linux-input-device
      - id: x11-grab
