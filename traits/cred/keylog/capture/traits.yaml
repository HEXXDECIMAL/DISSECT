# Keylogging Detection
# MBC: B0015 (Keylogging)
# ATT&CK: T1056.001 (Input Capture: Keylogging)
#
# NOTE: Single keyboard API usage is suspicious but not hostile.
# These APIs are used legitimately by accessibility software, games,
# hotkey managers, and automation tools. Hostile classification
# requires multiple indicators (e.g., keyboard capture + exfiltration).

defaults:
  mbc: "B0015"
  attack: "T1056.001"
  crit: suspicious

traits:
  # === Atomic: Windows Keyboard Hooks ===
  - id: windows-hook
    desc: Windows keyboard hooking via SetWindowsHookEx
    conf: 0.7
    mbc: "B0015.001"
    platforms: [windows]
    for: [pe, dll]
    if:
      type: symbol
      pattern: "SetWindowsHookEx"

  - id: windows-rawinput
    desc: Windows raw input API for keyboard access
    conf: 0.7
    platforms: [windows]
    for: [pe, dll]
    if:
      type: symbol
      pattern: "GetRawInputData"

  - id: windows-asynckey
    desc: Windows GetAsyncKeyState for key polling
    conf: 0.65
    platforms: [windows]
    for: [pe, dll]
    if:
      type: symbol
      pattern: "GetAsyncKeyState"

  # === Atomic: Linux Keyboard Input ===
  - id: linux-input-device
    desc: Direct access to Linux input devices
    conf: 0.75
    platforms: [linux]
    for: [elf, python, shell]
    if:
      type: string
      regex: "/dev/input/event[0-9]+"

  - id: x11-grab
    desc: X11 key grabbing for keylogging
    conf: 0.65
    platforms: [linux, unix]
    for: [elf, so]
    if:
      type: symbol
      pattern: "XGrabKey"

  # === Atomic: macOS Keyboard Capture ===
  - id: macos-eventtap
    desc: macOS CGEventTap for key interception
    conf: 0.7
    platforms: [macos]
    for: [macho, dylib]
    if:
      type: symbol
      pattern: "CGEventTapCreate"

  # === Atomic: Language Libraries ===
  - id: go-gohook
    desc: Go robotn/gohook keyboard capture library
    conf: 0.75
    for: [elf, macho]
    if:
      type: string
      exact: "github.com/robotn/gohook"

  # === Python pynput atomic indicators ===
  - id: pynput-import-keyboard
    desc: from pynput import keyboard
    conf: 0.5
    for: [python]
    if:
      type: string
      exact: "from pynput import keyboard"

  - id: pynput-keyboard-import
    desc: from pynput.keyboard import
    conf: 0.5
    for: [python]
    if:
      type: string
      regex: "from pynput\\.keyboard"

  # === JS iohook atomic indicators ===
  - id: require-iohook
    desc: require("iohook")
    conf: 0.6
    for: [javascript]
    if:
      type: string
      regex: "require\\(['\"]iohook['\"]\\)"

  - id: import-iohook
    desc: from "iohook" import
    conf: 0.6
    for: [javascript]
    if:
      type: string
      regex: 'from [''"]iohook[''"]'

  # === Rust rdev atomic indicators ===
  - id: use-rdev
    desc: "use rdev:: import statement"
    conf: 0.5
    for: [rust]
    if:
      type: string
      regex: "use rdev::"

  - id: extern-crate-rdev
    desc: extern crate rdev
    conf: 0.5
    for: [rust]
    if:
      type: string
      exact: "extern crate rdev"

  # === AppleScript Keystroke Capture ===
  # YARA rule with multiple string matches - can stay hostile with file_types
  - id: applescript-keystroke
    desc: AppleScript keystroke capture
    crit: suspicious
    conf: 0.95
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    # osascript can be invoked from any language
    for: ["*"]
    if:
      type: yara
      source: |
        rule applescript_keystroke {
          strings:
            $osascript = "osascript" ascii nocase
            $keystroke = "keystroke" ascii nocase
            $keycode = "key code" ascii nocase
            $keydown = "key down" ascii nocase
            $systemevents = "System Events" ascii nocase
          condition:
            $osascript and any of ($keystroke, $keycode, $keydown, $systemevents)
        }

  # JXA (JavaScript for Automation) keystroke capture
  # YARA rule with multiple string matches - can stay hostile with file_types
  - id: jxa-keystroke
    desc: JXA (JavaScript for Automation) keystroke capture
    crit: suspicious
    conf: 0.95
    mbc: "B0015"
    attack: "T1056.001"
    platforms: [macos]
    for: [javascript]
    if:
      type: yara
      source: |
        rule jxa_keystroke {
          strings:
            $app = "Application(" ascii
            $systemevents = "System Events" ascii
            $keystroke = "keystroke" ascii
            $keycode = "keyCode" ascii
          condition:
            $app and $systemevents and any of ($keystroke, $keycode)
        }

  # Node.js AppleScript execution for keystroke
  - id: node-applescript
    desc: Node.js AppleScript execution
    crit: suspicious
    conf: 0.85
    mbc: "B0015"
    attack: "T1059.002"
    platforms: [macos]
    for: [javascript, typescript]
    if:
      type: yara
      source: |
        rule node_applescript {
          strings:
            $require1 = "require('applescript')" ascii
            $require2 = "require(\"applescript\")" ascii
            $require3 = "node-osascript" ascii
            $run = "run-applescript" ascii
            $exec = "execSync" ascii
            $osascript = "osascript" ascii
          condition:
            any of ($require*) or ($osascript and $exec) or $run
        }

composite_rules:
  # Python pynput composite
  - id: python-pynput
    desc: Python pynput keyboard listener
    conf: 0.7
    for: [python]
    requires_count: 1
    any:
      - id: pynput-import-keyboard
      - id: pynput-keyboard-import

  # JS iohook composite
  - id: js-iohook
    desc: Node.js iohook global keyboard hook library
    conf: 0.75
    for: [javascript]
    requires_count: 1
    any:
      - id: require-iohook
      - id: import-iohook

  # Rust rdev composite
  - id: rust-rdev
    desc: Rust rdev keyboard event library
    conf: 0.65
    for: [rust]
    requires_count: 1
    any:
      - id: use-rdev
      - id: extern-crate-rdev

  # === Platform Composite Rules ===
  # Multiple keyboard-related indicators - still only suspicious
  # Hostile classification requires exfiltration indicators
  - id: windows-keylogger
    desc: Windows keylogger pattern (multiple keyboard APIs)
    conf: 0.85
    platforms: [windows]
    for: [pe, dll]
    requires_count: 2
    any:
      - id: windows-hook
      - id: windows-rawinput
      - id: windows-asynckey

  - id: linux-keylogger
    desc: Linux keylogger pattern (multiple input methods)
    conf: 0.85
    platforms: [linux]
    for: [elf]
    all:
      - id: linux-input-device
      - id: x11-grab
