# Clipboard Monitoring Detection - Python
# MBC: E1510 (Clipboard Data)
# ATT&CK: T1115 (Clipboard Data)

defaults:
  for: [python]
  mbc: "E1510"
  attack: "T1115"
  crit: suspicious

traits:
  # === win32clipboard atomic indicators ===
  - id: import-win32clipboard
    desc: import win32clipboard
    crit: inert
    conf: 0.6
    platforms: [windows]
    if:
      type: string
      exact: "import win32clipboard"

  - id: win32-get-clipboard
    desc: win32clipboard.GetClipboardData
    crit: inert
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      exact: "win32clipboard.GetClipboardData"

  - id: win32-set-clipboard
    desc: win32clipboard.SetClipboardData
    crit: inert
    conf: 0.6
    platforms: [windows]
    if:
      type: string
      exact: "win32clipboard.SetClipboardData"

  - id: win32-open-clipboard
    desc: win32clipboard.OpenClipboard
    crit: inert
    conf: 0.6
    platforms: [windows]
    if:
      type: string
      exact: "win32clipboard.OpenClipboard"

  # === pyperclip atomic indicators ===
  - id: import-pyperclip
    desc: import pyperclip
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "import pyperclip"

  - id: pyperclip-paste
    desc: pyperclip.paste
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "pyperclip.paste"

  - id: pyperclip-copy
    desc: pyperclip.copy
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "pyperclip.copy"

  # === wxPython clipboard atomic indicators ===
  - id: wx-clipboard
    desc: wx.Clipboard
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "wx.Clipboard"

  - id: clipboard-getdata
    desc: clipboard.GetData
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "clipboard.GetData"

  - id: wx-theclipboard
    desc: wx.TheClipboard
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "wx.TheClipboard"

  # === tkinter clipboard atomic indicators ===
  - id: clipboard-get-method
    desc: .clipboard_get() method
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: ".clipboard_get()"

  - id: clipboard-clear-method
    desc: .clipboard_clear() method
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: ".clipboard_clear()"

  # === Windows clipboard chain atomic ===
  - id: set-clipboard-viewer
    desc: SetClipboardViewer function
    crit: inert
    conf: 0.8
    platforms: [windows]
    if:
      type: string
      exact: "SetClipboardViewer("

  - id: wm-drawclipboard
    desc: WM_DRAWCLIPBOARD message
    crit: inert
    conf: 0.8
    platforms: [windows]
    if:
      type: string
      exact: "WM_DRAWCLIPBOARD"

  - id: wm-changecbchain
    desc: WM_CHANGECBCHAIN message
    crit: inert
    conf: 0.7
    platforms: [windows]
    if:
      type: string
      exact: "WM_CHANGECBCHAIN"

  # === pynput clipboard atomic ===
  - id: pynput-import-clipboard
    desc: from pynput import clipboard
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "from pynput import clipboard"

  - id: pynput-clipboard-mod
    desc: pynput.clipboard module
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "pynput.clipboard"

  # === Network exfil atomic (require clipboard context) ===
  - id: requests-post-clip
    desc: requests.post with clipboard
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: "clipboard.*requests\\.post|requests\\.post.*clipboard"

  - id: requests-get-clip
    desc: requests.get with clipboard
    crit: inert
    conf: 0.4
    if:
      type: content
      regex: "clipboard.*requests\\.get|requests\\.get.*clipboard"

  - id: urllib-clip
    desc: urllib with clipboard
    crit: inert
    conf: 0.4
    if:
      type: content
      regex: "clipboard.*urllib|urllib.*clipboard"

  - id: socket-clip
    desc: socket with clipboard
    crit: inert
    conf: 0.4
    if:
      type: content
      regex: "clipboard.*socket|socket.*clipboard"

  # === Loop/persistence atomic (require clipboard context) ===
  - id: while-clipboard-loop
    desc: while loop with clipboard
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: "while.*clipboard|clipboard.*while"

  - id: schedule-clipboard
    desc: schedule with clipboard
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: "schedule.*clipboard|clipboard.*schedule"

  - id: time-sleep-clipboard
    desc: time.sleep with clipboard
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: "time\\.sleep.*clipboard|clipboard.*time\\.sleep"

  # === Message loop atomic ===
  - id: wndproc-keyword
    desc: WndProc keyword
    crit: inert
    conf: 0.5
    platforms: [windows]
    if:
      type: string
      exact: "WndProc"

  - id: message-loop-str
    desc: '"message loop" string'
    crit: inert
    conf: 0.5
    platforms: [windows]
    if:
      type: string
      exact: "message loop"

  - id: getclipboarddata-fn
    desc: GetClipboardData function
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "GetClipboardData"

composite_rules:
  # win32clipboard composite
  - id: python-win32clipboard
    desc: "Windows clipboard access (win32clipboard)"
    conf: 0.8
    platforms: [windows]
    count_min: 1
    any:
      - id: import-win32clipboard
      - id: win32-get-clipboard
      - id: win32-set-clipboard
      - id: win32-open-clipboard

  # pyperclip composite
  - id: python-pyperclip
    desc: "Clipboard access (pyperclip)"
    conf: 0.7
    count_min: 1
    any:
      - id: import-pyperclip
      - id: pyperclip-paste
      - id: pyperclip-copy

  # wxPython clipboard composite
  - id: python-wx-clipboard
    desc: "Clipboard access (wxPython)"
    conf: 0.75
    count_min: 1
    any:
      - id: wx-clipboard
      - id: clipboard-getdata
      - id: wx-theclipboard

  # tkinter clipboard composite
  - id: python-tkinter-clipboard
    desc: "Clipboard access (tkinter)"
    conf: 0.65
    crit: notable
    count_min: 1
    any:
      - id: clipboard-get-method
      - id: clipboard-clear-method


  # Clipboard change notification composite
  - id: python-clipboard-change
    desc: "Clipboard change notification handler"
    conf: 0.9
    crit: suspicious
    platforms: [windows]
    count_min: 1
    any:
      - id: wm-drawclipboard
      - id: wm-changecbchain

  # pynput clipboard composite
  - id: python-pynput-clipboard
    desc: "Clipboard monitoring via pynput"
    conf: 0.75
    count_min: 1
    any:
      - id: pynput-import-clipboard
      - id: pynput-clipboard-mod

  # Clipboard access any library composite
  - id: python-clipboard-access-any
    desc: "Clipboard access via any library"
    conf: 0.7
    crit: notable
    count_min: 1
    any:
      - id: python-win32clipboard
      - id: python-pyperclip
      - id: python-wx-clipboard
      - id: clipboard-get-method

  # Network exfil composite
  - id: python-network-exfil
    desc: "Network communication for potential exfiltration"
    conf: 0.6
    crit: notable
    count_min: 1
    any:
      - id: requests-post-clip
      - id: requests-get-clip
      - id: urllib-clip
      - id: socket-clip

  # Loop persistence composite
  - id: python-loop-persistence
    desc: "Clipboard loop persistence"
    conf: 0.6
    crit: notable
    count_min: 1
    any:
      - id: while-clipboard-loop
      - id: schedule-clipboard
      - id: time-sleep-clipboard

  # Clipboard viewer notification composite
  - id: python-clipboard-viewer-notify
    desc: "Clipboard viewer or change notification"
    conf: 0.85
    crit: suspicious
    platforms: [windows]
    count_min: 1
    any:
      - id: set-clipboard-viewer
      - id: wm-drawclipboard

  # Clipboard data retrieval composite
  - id: python-clipboard-get-data
    desc: "Clipboard data retrieval function"
    conf: 0.8
    crit: notable
    count_min: 1
    any:
      - id: getclipboarddata-fn
      - id: clipboard-getdata

  # Message loop composite
  - id: python-message-loop
    desc: "Windows message loop or window"
    conf: 0.6
    crit: notable
    platforms: [windows]
    count_min: 1
    any:
      - id: while-keyword
      - id: wndproc-keyword
      - id: message-loop-str

  # Clipboard monitoring with exfiltration
  - id: python-clipboard-exfil
    desc: "Clipboard theft with exfiltration"
    conf: 0.95
    crit: hostile
    attack: "T1115"
    mbc: "E1510"
    for: [python]
    all:
      - id: python-clipboard-access-any
      - id: python-network-exfil
      - id: python-loop-persistence

  # Real-time clipboard monitoring (chain viewer)
  - id: python-realtime-monitor
    desc: "Real-time clipboard monitoring"
    conf: 0.9
    crit: hostile
    attack: "T1115"
    mbc: "E1510"
    for: [python]
    all:
      - id: python-clipboard-viewer-notify
      - id: python-clipboard-get-data
      - id: python-message-loop
