# Node.js Environment Variable Access
# ATT&CK: T1552.001 (Credentials In Files)

traits:
  # Generic config file access
  - id: node-config
    description: Accessing sensitive configuration files
    criticality: suspicious
    confidence: 0.7
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: '(\.env|\.ssh/id_rsa|\.aws/credentials|\.kube/config)'

  # AWS credentials
  - id: node-aws
    description: Accesses AWS credentials from environment
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(AWS_ACCESS_KEY|AWS_SECRET|AWS_SESSION_TOKEN)"

  # GitHub/GitLab tokens
  - id: node-git-token
    description: Accesses Git service tokens from environment
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(GITHUB_TOKEN|GITLAB_TOKEN|GH_TOKEN|BITBUCKET_TOKEN)"

  # NPM tokens
  - id: node-npm-token
    description: Accesses NPM authentication tokens
    criticality: suspicious
    confidence: 0.95
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(NPM_TOKEN|NPM_AUTH_TOKEN|NODE_AUTH_TOKEN)"

  # Discord tokens
  - id: node-discord
    description: Accesses Discord bot/user tokens
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(DISCORD_TOKEN|DISCORD_BOT_TOKEN|DISCORD_CLIENT_SECRET)"

  # Slack tokens
  - id: node-slack
    description: Accesses Slack tokens from environment
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(SLACK_TOKEN|SLACK_BOT_TOKEN|SLACK_WEBHOOK)"

  # Database credentials
  - id: node-database
    description: Accesses database connection strings
    criticality: suspicious
    confidence: 0.85
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(DATABASE_URL|MONGODB_URI|POSTGRES_|MYSQL_|REDIS_URL)"

  # API keys (generic)
  - id: node-api-key
    description: Accesses API keys from environment
    criticality: notable
    confidence: 0.75
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.[A-Z_]*(API_KEY|SECRET_KEY|PRIVATE_KEY|AUTH_KEY)"

  # Crypto/Wallet keys
  - id: node-crypto
    description: Accesses cryptocurrency private keys
    criticality: hostile
    confidence: 0.95
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(WALLET_|MNEMONIC|SEED_PHRASE|PRIVATE_KEY|ETH_PRIVATE)"

  # CI/CD tokens
  - id: node-cicd
    description: Accesses CI/CD pipeline tokens
    criticality: suspicious
    confidence: 0.85
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(CI_TOKEN|CIRCLE_TOKEN|TRAVIS_TOKEN|JENKINS_|BUILDKITE_)"

  # Cloud provider tokens
  - id: node-cloud
    description: Accesses cloud provider credentials
    criticality: suspicious
    confidence: 0.9
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "process\\.env\\.(GOOGLE_|GCP_|AZURE_|DIGITALOCEAN_|HEROKU_API)"

  # Full process.env dump
  - id: node-env-dump
    description: Accesses entire process.env object
    criticality: suspicious
    confidence: 0.85
    attack: "T1552.001"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: 'JSON\.stringify\(process\.env|Object\.keys\(process\.env|Object\.entries\(process\.env'

composite_rules:
  # Multi-credential access
  - id: node-multi-cred
    description: Accesses multiple credential sources (credential harvesting)
    criticality: hostile
    confidence: 0.95
    attack: "T1552.001"
    requires_count: 2
    conditions:
      - type: trait
        id: credential/environment/secret-access/node-aws
      - type: trait
        id: credential/environment/secret-access/node-git-token
      - type: trait
        id: credential/environment/secret-access/node-npm-token
      - type: trait
        id: credential/environment/secret-access/node-discord
      - type: trait
        id: credential/environment/secret-access/node-database
      - type: trait
        id: credential/environment/secret-access/node-crypto
