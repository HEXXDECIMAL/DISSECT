# Credential Access - SSH Keys and Configuration
# ATT&CK: T1552.004 (Unsecured Credentials: Private Keys)

defaults:
  platforms: [linux, macos, unix]

traits:
  # === Atomic: SSH Directory ===
  - id: slash-dot-ssh
    desc: /.ssh path reference
    crit: inert
    conf: 0.5
    attack: "T1552.004"
    if:
      type: string
      exact: "/.ssh"

  - id: dot-dot-ssh
    desc: ..ssh/ path reference
    crit: inert
    conf: 0.5
    attack: "T1552.004"
    if:
      type: string
      exact: "..ssh/"

  # === Atomic: SSH Private Keys ===
  - id: id-rsa
    desc: SSH id_rsa private key reference
    crit: suspicious
    conf: 0.75
    attack: "T1552.004"
    if:
      type: string
      exact: "id_rsa"

  - id: id-dsa
    desc: SSH id_dsa private key reference
    crit: suspicious
    conf: 0.75
    attack: "T1552.004"
    if:
      type: string
      exact: "id_dsa"

  - id: id-ecdsa
    desc: SSH id_ecdsa private key reference
    crit: suspicious
    conf: 0.75
    attack: "T1552.004"
    if:
      type: string
      exact: "id_ecdsa"

  - id: id-ed25519
    desc: SSH id_ed25519 private key reference
    crit: suspicious
    conf: 0.75
    attack: "T1552.004"
    if:
      type: string
      exact: "id_ed25519"

  # === Atomic: SSH Configuration Files ===
  - id: authorized-keys
    desc: SSH authorized_keys file reference
    crit: notable
    conf: 0.6
    attack: "T1552.004"
    if:
      type: string
      exact: "authorized_keys"

  - id: known-hosts
    desc: SSH known_hosts file reference
    crit: notable
    conf: 0.5
    attack: "T1552.004"
    if:
      type: string
      exact: "known_hosts"

  # === Atomic: PuTTY (Windows) ===
  - id: putty-sessions
    desc: PuTTY sessions registry reference
    crit: suspicious
    conf: 0.8
    attack: "T1552.004"
    platforms: [windows]
    if:
      type: string
      exact: "Software\\SimonTatham\\PuTTY\\Sessions"

  # === Atomic: SSHD Process (no ATT&CK - process reference, not credential access) ===
  - id: sshd-ref
    desc: SSHD daemon reference
    crit: notable
    conf: 0.5
    if:
      type: string
      exact: "sshd"

  - id: sshd-path
    desc: SSHD daemon path
    crit: suspicious
    conf: 0.7
    if:
      type: string
      exact: "/usr/bin/sshd"

  # === Atomic: SSHD network process indicators ===
  - id: sshd-net-bracket
    desc: SSHD net process reference
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "sshd: [net]"

  - id: sshd-accepted-bracket
    desc: SSHD accepted process reference
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "sshd: [accepted]"

  - id: sshd-proc-ref
    desc: SSHD process reference
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: "sshd_?proc"

  # === Atomic: Tracing/Debugging ===
  - id: ptrace-tracer
    desc: Process tracing reference
    crit: notable
    conf: 0.5
    if:
      type: symbol_or_string
      any: ["ptrace", "tracer"]

  - id: password-pattern
    desc: Password pattern reference
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "passw(or)?d"

  # === Atomic: Session Sniffing ===
  - id: session-sniff
    desc: SSH session sniffing indicators
    crit: suspicious
    conf: 0.9
    attack: "T1557"
    mbc: "E1056"
    platforms: [linux]
    for: [elf, so, python, shell]
    if:
      type: yara
      source: |
        rule ssh_sniff {
          strings:
            $sniff_ssh = "sniff_ssh" ascii nocase
            $ssh_sniff = "ssh_sniff" ascii nocase
            $sshpass = "sshpass" ascii
            $ssh_password = "ssh_password" ascii
            $ssh_cred = "ssh_cred" ascii
            $sshdone = "sshdone" ascii
          condition:
            any of them
        }

  - id: password-file-storage
    desc: SSH password file storage
    crit: suspicious
    conf: 0.85
    attack: "T1552.001"
    mbc: "E1056"
    platforms: [linux]
    for: [elf, so, python, shell]
    if:
      type: yara
      source: |
        rule ssh_password_storage {
          strings:
            $sshpass_txt = /sshpass\d?\.txt/ ascii
            $ssh_pass_log = "ssh_pass.log" ascii
            $pass_file = "password.txt" ascii
            $cred_file = "credentials.txt" ascii
          condition:
            any of them
        }

  # === Atomic: SSH host verification bypass ===
  - id: stricthostkey-bypass
    desc: SSH StrictHostKeyChecking bypass
    crit: suspicious
    conf: 0.8
    attack: "T1021.004"
    if:
      type: string
      exact: "StrictHostKeyChecking=no"

  - id: userknownhosts-bypass
    desc: SSH UserKnownHostsFile bypass
    crit: suspicious
    conf: 0.75
    attack: "T1021.004"
    if:
      type: string
      regex: "UserKnownHostsFile\\s*[=/]\\s*/dev/null"

composite_rules:
  # === Composite: SSH directory path ===
  - id: dot-ssh-path
    desc: SSH directory path reference
    crit: notable
    conf: 0.6
    attack: "T1552.004"
    requires_count: 1
    any:
      - id: slash-dot-ssh
      - id: dot-dot-ssh

  # === Composite: SSHD network process ===
  - id: sshd-net-proc
    desc: SSHD network process reference
    crit: suspicious
    conf: 0.8
    requires_count: 1
    any:
      - id: sshd-net-bracket
      - id: sshd-accepted-bracket

  # === Composite: SSH private key theft ===
  - id: private-key-theft
    desc: SSH private key theft
    crit: suspicious
    conf: 0.85
    attack: "T1552.004"
    mbc: "E1552"
    all:
      - id: dot-ssh-path
    any:
      - id: id-rsa
      - id: id-dsa
      - id: id-ecdsa
      - id: id-ed25519

  # === Composite: SSHD password tracing ===
  - id: sshd-password-trace
    desc: SSHD memory tracing for passwords
    crit: suspicious
    conf: 0.85
    attack: "T1552.004"
    platforms: [linux]
    all:
      - id: ptrace-tracer
      - id: password-pattern
      - id: sshd-ref

  # === Composite: SSH credential theft behavior ===
  - id: credential-theft
    desc: SSH credential theft behavior
    crit: hostile
    conf: 0.9
    attack: "T1556"
    mbc: "E1056"
    platforms: [linux]
    for: [elf, so, python, shell]
    any:
      - id: session-sniff
      - id: password-file-storage
    all:
      - id: sshd-ref
