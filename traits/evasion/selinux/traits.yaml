# SELinux Bypass/Manipulation Detection
# ATT&CK: T1562.001 (Impair Defenses: Disable or Modify Tools)

traits:
  # SELinux extended attribute manipulation
  - id: xattr-manipulation
    desc: SELinux extended attribute manipulation
    crit: suspicious
    conf: 0.75
    attack: "T1562.001"
    platforms: [linux]
    if:
      type: yara
      source: |
        rule selinux_xattr {
          strings:
            $security_selinux = "security.selinux" ascii
            $setxattr = "setxattr" ascii
            $fsetxattr = "fsetxattr" ascii
            $lsetxattr = "lsetxattr" ascii
          condition:
            $security_selinux and any of ($setxattr, $fsetxattr, $lsetxattr)
        }

  # Unconfined context assignment
  - id: unconfined-context
    desc: SELinux unconfined context assignment
    crit: suspicious
    conf: 0.8
    attack: "T1562.001"
    platforms: [linux]
    if:
      type: yara
      source: |
        rule selinux_unconfined {
          strings:
            $unconfined_u = "unconfined_u:" ascii
            $unconfined_r = "unconfined_r:" ascii
            $unconfined_t = "unconfined_t" ascii
            $object_r = "object_r:" ascii
          condition:
            any of ($unconfined*) or ($object_r and filesize < 5MB)
        }

  # SELinux setenforce/getenforce manipulation
  - id: setenforce
    desc: SELinux enforcement mode manipulation
    crit: suspicious
    conf: 0.85
    attack: "T1562.001"
    platforms: [linux]
    if:
      type: yara
      source: |
        rule selinux_enforce {
          strings:
            $setenforce = "setenforce" ascii
            $getenforce = "getenforce" ascii
            $enforcing = "/sys/fs/selinux/enforce" ascii
            $selinuxfs = "/selinux/enforce" ascii
            $permissive = "Permissive" ascii
          condition:
            any of ($setenforce, $getenforce, $enforcing, $selinuxfs) or
            ($permissive and filesize < 2MB)
        }

  # SELinux policy manipulation
  - id: policy-manipulation
    desc: SELinux policy load or manipulation
    crit: suspicious
    conf: 0.8
    attack: "T1562.001"
    platforms: [linux]
    if:
      type: yara
      source: |
        rule selinux_policy {
          strings:
            $load_policy = "load_policy" ascii
            $semodule = "semodule" ascii
            $policy_dir = "/etc/selinux" ascii
            $policy_file = "policy." ascii
            $chcon = "chcon" ascii
            $restorecon = "restorecon" ascii
          condition:
            any of them
        }

  # SELinux disable via kernel parameters
  - id: kernel-disable
    desc: SELinux kernel parameter disable
    crit: suspicious
    conf: 0.9
    attack: "T1562.001"
    platforms: [linux]
    for: [shell, elf]
    if:
      type: yara
      source: |
        rule selinux_kernel_disable {
          strings:
            $selinux0 = "selinux=0" ascii
            $enforcing0 = "enforcing=0" ascii
            $disable = "SELINUX=disabled" ascii
            $permissive_cfg = "SELINUX=permissive" ascii
          condition:
            any of them
        }

  # SELinux runtime state memory patching
  - id: runtime-patch
    desc: Direct kernel memory manipulation of SELinux enforcement state
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    platforms: [linux]
    for: [c]
    if:
      type: yara
      source: |
        rule selinux_runtime_patch {
          strings:
            $s1 = "selinux_state" ascii
            $s2 = "enforcing" ascii
            $s3 = "fake_enforce" ascii
            $s4 = "sel_read_enforce" ascii
            $s5 = "sel_write_enforce" ascii
          condition:
            ($s1 and $s2) or ($s4 and $s5) or ($s3 and $s1)
        }

composite_rules:
  # Active SELinux bypass
  - id: bypass
    desc: Active SELinux bypass behavior
    crit: hostile
    conf: 0.9
    attack: "T1562.001"
    platforms: [linux]
    for: [shell, c, elf]
    requires_count: 2
    any:
      - id: evasion/selinux/xattr-manipulation
      - id: evasion/selinux/unconfined-context
      - id: evasion/selinux/setenforce
      - id: evasion/selinux/kernel-disable
      - id: evasion/selinux/runtime-patch
