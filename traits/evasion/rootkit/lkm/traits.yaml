# Linux Kernel Rootkit Detection Traits
# These detect common rootkit behaviors in C source code
# MBC: Defense Evasion, Privilege Escalation
# ATT&CK: T1014 (Rootkit), T1068 (Exploitation for Privilege Escalation)

traits:
  # ============================================================ 
  # KERNEL MODULE HEADERS
  # ============================================================ 

  - id: kernel-module-header
    description: Linux kernel module header (loadable kernel module)
    criticality: suspicious
    confidence: 0.98
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/module.h"

  - id: kernel-header
    description: Linux kernel header
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/kernel.h"

  - id: kernel-syscalls-header
    description: Linux syscall definitions (syscall hooking)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/syscalls.h"

  - id: kernel-dirent-header
    description: Linux directory entry header (file hiding)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/dirent.h"

  - id: kernel-cred-header
    description: Linux credentials header (privilege escalation)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/cred.h"

  - id: kernel-kallsyms-header
    description: Linux kallsyms header (kernel symbol access)
    criticality: suspicious
    confidence: 0.98
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/kallsyms.h"

  - id: kernel-ftrace-header
    description: Linux ftrace header (function tracing/hooking)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/ftrace.h"

  - id: kernel-kprobes-header
    description: Linux kprobes header (kernel probing/hooking)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/kprobes.h"

  - id: kernel-procfs-header
    description: Linux procfs header (process hiding)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/proc_fs.h"

  - id: ftrace-helper-include
    description: Ftrace helper library (common rootkit hooking library)
    criticality: suspicious
    confidence: 0.99
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: preproc_include
      pattern: "ftrace_helper"

  # ============================================================ 
  # KERNEL FUNCTION CALLS
  # ============================================================ 

  - id: kallsyms-lookup
    description: Kernel symbol lookup (rootkit indicator)
    criticality: suspicious
    confidence: 0.98
    mbc: "F0004"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "kallsyms_lookup_name"

  - id: prepare-creds-call
    description: Prepare kernel credentials (privilege escalation)
    criticality: suspicious
    confidence: 0.98
    attack: "T1068"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "prepare_creds"

  - id: commit-creds-call
    description: Commit kernel credentials (privilege escalation)
    criticality: suspicious
    confidence: 0.98
    attack: "T1068"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "commit_creds"

  - id: list-del-call
    description: Kernel list deletion (module hiding)
    criticality: suspicious
    confidence: 0.95
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "list_del"

  - id: cr0-read-call
    description: Read CR0 register (memory protection bypass)
    criticality: suspicious
    confidence: 0.98
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "read_cr0"

  - id: cr0-write-call
    description: Write CR0 register (disable write protection)
    criticality: suspicious
    confidence: 0.99
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "write_cr0"

  - id: kzalloc-call
    description: Kernel memory allocation
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "kzalloc"

  - id: copy-from-user-call
    description: Copy data from user space to kernel
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "copy_from_user"

  - id: copy-to-user-call
    description: Copy data from kernel to user space
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "copy_to_user"

  # ============================================================ 
  # MODULE MACROS
  # ============================================================ 

  - id: module-license-macro
    description: Kernel module license declaration
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "MODULE_LICENSE"

  - id: module-init-macro
    description: Kernel module initialization function
    criticality: suspicious
    confidence: 0.98
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "module_init"

  - id: module-exit-macro
    description: Kernel module exit function
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "module_exit"

  - id: for-each-process-macro
    description: Kernel process enumeration macro
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "for_each_process"

  # ============================================================ 
  # DECLARATIONS / STRUCTURES
  # ============================================================ 

  - id: syscall-table-decl
    description: Syscall table pointer (syscall hooking)
    criticality: suspicious
    confidence: 0.99
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "sys_call_table"

  - id: task-struct-decl
    description: Task structure access (process manipulation)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "task_struct"

  - id: cred-struct-decl
    description: Credential structure access (privilege escalation)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "struct cred"

  - id: linux-dirent-decl
    description: Directory entry structure (file/process hiding)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "linux_dirent"

  - id: pt-regs-decl
    description: Register state structure (syscall interception)
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "pt_regs"

  # ============================================================ 
  # EXPRESSION PATTERNS
  # ============================================================ 

  - id: syscall-number-ref
    description: Direct syscall number reference (syscall hooking)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: binary_expression
      pattern: "__NR_"

  - id: proc-root-ino-ref
    description: Proc filesystem root inode (process hiding)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: binary_expression
      pattern: "PROC_ROOT_INO"

  - id: cr0-wp-bit-manipulation
    description: CR0 write-protect bit manipulation
    criticality: suspicious
    confidence: 0.99
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: binary_expression
      pattern: "0x00010000"

  - id: this-module-ref
    description: Kernel module self-reference (module hiding)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "THIS_MODULE"

  # ============================================================ 
  # COMMENT/METADATA DETECTION
  # ============================================================ 

  - id: rootkit-mention-comment
    description: Code explicitly mentions rootkit
    criticality: suspicious
    confidence: 1.0
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "rootkit"
      case_insensitive: true

  - id: malware-mention-comment
    description: Code explicitly mentions malware/backdoor
    criticality: suspicious
    confidence: 1.0
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "malware|backdoor"
      regex: true
      case_insensitive: true

  - id: privesc-mention-comment
    description: Code explicitly mentions privilege escalation
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "privilege.?escalation|privesc"
      regex: true
      case_insensitive: true

  - id: evasion-mention-comment
    description: Code mentions evasion techniques
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "evasion|evade"
      regex: true
      case_insensitive: true

  - id: syscall-hook-mention-comment
    description: Code mentions syscall hooking
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "syscall.*(hook|intercept)"
      regex: true
      case_insensitive: true

  # ============================================================ 
  # FUNCTION NAMING PATTERNS
  # ============================================================ 

  - id: hide-function-name
    description: Function name suggests hiding capability
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: function_definition
      pattern: "hide|invisible|stealth"
      regex: true
      case_insensitive: true

  - id: hook-syscall-function-name
    description: Function name suggests syscall hooking
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: function_definition
      pattern: "hook.*(sys|syscall)"
      regex: true
      case_insensitive: true

  # ============================================================ 
  # INLINE ASSEMBLY
  # ============================================================ 

  - id: asm-cr0-manipulation
    description: Inline assembly manipulating CR0 register
    criticality: suspicious
    confidence: 0.98
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: asm_statement
      pattern: "cr0"
      case_insensitive: true

  - id: asm-syscall-invocation
    description: Inline assembly with direct syscall invocation
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: asm_statement
      pattern: "int.*0x80|syscall|sysenter"
      regex: true

  # ============================================================ 
  # DIRECTORY ENTRY MANIPULATION (FILE/PROCESS HIDING)
  # ============================================================ 

  - id: d-reclen-manipulation
    description: Directory entry record length manipulation (file hiding)
    criticality: suspicious
    confidence: 0.98
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "d_reclen"

  - id: d-name-access
    description: Directory entry name field access
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "d_name"

  - id: simple-strtoul-call
    description: String to unsigned long conversion (PID parsing for hiding)
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "simple_strtoul"

  - id: memmove-call
    description: Memory move operation (often used for dirent manipulation)
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "memmove"

  - id: memcmp-dirent-context
    description: Memory comparison (file prefix matching for hiding)
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "memcmp"

  # ============================================================ 
  # MODULE HIDING TECHNIQUES
  # ============================================================ 

  - id: sect-attrs-removal
    description: Module section attributes removal (hide module info)
    criticality: suspicious
    confidence: 0.99
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "sect_attrs"

  - id: list-add-call
    description: Kernel list addition (module unhiding toggle)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "list_add"

  - id: kfree-call
    description: Kernel memory free (often used to remove module metadata)
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "kfree"

  # ============================================================ 
  # SYSCALL HOOKING INFRASTRUCTURE
  # ============================================================ 

  - id: asmlinkage-decl
    description: Assembly linkage declaration (syscall calling convention)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "asmlinkage"

  - id: t-syscall-typedef
    description: Syscall function pointer typedef
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: type_definition
      pattern: "t_syscall|syscall_fn|sys_call_ptr"
      regex: true

  - id: orig-syscall-pattern
    description: Original syscall saving pattern (hooking infrastructure)
    criticality: suspicious
    confidence: 0.95
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "orig_"
      regex: false

  - id: pt-regs-register-access
    description: Direct register access via pt_regs (syscall argument extraction)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "pt_regs->"

  - id: pt-regs-di-access
    description: RDI register access (first syscall argument)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "->di"

  - id: pt-regs-si-access
    description: RSI register access (second syscall argument)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "->si"

  # ============================================================ 
  # KERNEL STRUCTURE TRAVERSAL
  # ============================================================ 

  - id: current-files-access
    description: Current process file table access
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "current->files"

  - id: fdt-access
    description: File descriptor table access
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "->fdt"

  - id: f-path-dentry-access
    description: File path dentry access (inode traversal)
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "f_path.dentry"

  - id: d-inode-access
    description: Dentry inode access
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "->d_inode"

  - id: i-ino-access
    description: Inode number access (filesystem identification)
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "i_ino"

  - id: i-rdev-access
    description: Inode device number access
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "i_rdev"

  - id: major-macro-call
    description: MAJOR device number extraction
    criticality: suspicious
    confidence: 0.75
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "MAJOR"

  # ============================================================ 
  # USER/KERNEL BOUNDARY
  # ============================================================ 

  - id: user-annotation
    description: __user annotation (kernel/userspace boundary marker)
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "__user"

  - id: gfp-kernel-alloc
    description: GFP_KERNEL allocation flag
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "GFP_KERNEL"

  # ============================================================ 
  # MODULE LIFECYCLE
  # ============================================================ 

  - id: init-attribute
    description: __init module initialization attribute
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: function_definition
      pattern: "__init"

  - id: exit-attribute
    description: __exit module cleanup attribute
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: function_definition
      pattern: "__exit"

  - id: module-author-macro
    description: MODULE_AUTHOR declaration (attacker attribution)
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "MODULE_AUTHOR"

  - id: module-description-macro
    description: MODULE_DESCRIPTION declaration
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: call_expression
      pattern: "MODULE_DESCRIPTION"

  - id: dual-bsd-gpl-license
    description: Dual BSD/GPL license (common rootkit license)
    criticality: suspicious
    confidence: 0.6
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: string_literal
      pattern: "Dual BSD/GPL"

  # ============================================================ 
  # SIGNAL-BASED BACKDOOR CONTROL
  # ============================================================ 

  - id: custom-signal-define
    description: Custom signal definition (backdoor trigger)
    criticality: suspicious
    confidence: 0.95
    attack: "T1014"
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: preproc_def
      pattern: "SIG[A-Z]+"
      regex: true

  - id: signal-switch-handler
    description: Signal-based switch handler (command dispatch)
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: switch_statement
      pattern: "sig"
      case_insensitive: true

  # ============================================================ 
  # TASK/PROCESS MANIPULATION
  # ============================================================ 

  - id: task-flags-manipulation
    description: Task flags manipulation (process hiding via PF_INVISIBLE)
    criticality: suspicious
    confidence: 0.98
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "task->flags|p->flags"
      regex: true

  - id: pf-invisible-flag
    description: PF_INVISIBLE flag value (0x10000000)
    criticality: suspicious
    confidence: 0.99
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: binary_expression
      pattern: "0x10000000"

  - id: xor-assign-flags
    description: XOR assignment on flags (toggle visibility)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: assignment_expression
      pattern: "\\^="
      regex: true

  - id: current-macro-ref
    description: Current task reference macro
    criticality: suspicious
    confidence: 0.75
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: identifier
      pattern: "^current$"
      regex: true

  # ============================================================ 
  # CREDENTIAL MANIPULATION
  # ============================================================ 

  - id: uid-zero-assign
    description: UID set to zero (root privilege)
    criticality: suspicious
    confidence: 0.98
    attack: "T1068"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: assignment_expression
      pattern: "uid.*=.*0|->uid = 0"
      regex: true

  - id: gid-zero-assign
    description: GID set to zero (root group)
    criticality: suspicious
    confidence: 0.98
    attack: "T1068"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: assignment_expression
      pattern: "gid.*=.*0|->gid = 0"
      regex: true

  - id: euid-egid-access
    description: Effective UID/GID access (privilege escalation)
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: field_expression
      pattern: "euid|egid|suid|sgid|fsuid|fsgid"
      regex: true

  # ============================================================ 
  # COMPILER/MEMORY ORDERING
  # ============================================================ 

  - id: force-order-variable
    description: __force_order variable (prevent CR0 write reordering)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "__force_order"

  - id: volatile-asm
    description: Volatile inline assembly (prevent optimization)
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: asm_statement
      pattern: "volatile"

  # ============================================================ 
  # GETDENTS HOOKING SPECIFIC
  # ============================================================ 

  - id: getdents-hook-function
    description: getdents hook function (directory listing interception)
    criticality: suspicious
    confidence: 0.99
    attack: "T1014"
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: function_definition
      pattern: "getdents"
      case_insensitive: true

  - id: nr-getdents-ref
    description: __NR_getdents syscall number reference
    criticality: suspicious
    confidence: 0.98
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "__NR_getdents"

  - id: nr-kill-ref
    description: __NR_kill syscall number reference (signal hooking)
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "__NR_kill"

  # ============================================================ 
  # SUSPICIOUS COMMENT PATTERNS
  # ============================================================ 

  - id: corruption-mention-comment
    description: Code mentions corruption/corrupting
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "corrupt"
      case_insensitive: true

  - id: hiding-mention-comment
    description: Code mentions hiding/hidden
    criticality: suspicious
    confidence: 0.9
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "hid(e|ing|den)"
      regex: true
      case_insensitive: true

  - id: stealthy-mention-comment
    description: Code mentions stealth/stealthy
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "stealth"
      case_insensitive: true

  - id: unauthorized-mention-comment
    description: Code mentions unauthorized access
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "unauthori[sz]ed"
      regex: true
      case_insensitive: true

  - id: defeating-mention-comment
    description: Code mentions defeating protections
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "defeat"
      case_insensitive: true

  - id: persistence-mention-comment
    description: Code mentions persistence
    criticality: suspicious
    confidence: 0.85
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "persist"
      case_insensitive: true

  - id: polymorphic-mention-comment
    description: Code mentions polymorphic techniques
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "polymorphic"
      case_insensitive: true

  - id: covert-channel-mention-comment
    description: Code mentions covert channels/communication
    criticality: suspicious
    confidence: 0.95
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: comment
      pattern: "covert"
      case_insensitive: true

  # ============================================================ 
  # OBFUSCATED NAMING PATTERNS
  # ============================================================ 

  - id: random-prefix-function
    description: Function with random-looking prefix (obfuscation)
    criticality: suspicious
    confidence: 0.7
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: function_definition
      pattern: "^[a-z]{3,5}[0-9]?_"
      regex: true

  - id: underscore-heavy-naming
    description: Heavy underscore usage in names (kernel-style obfuscation)
    criticality: suspicious
    confidence: 0.6
    file_types: [c]
    condition:
      type: ast_pattern
      node_type: declaration
      pattern: "^__[a-z]+"
      regex: true

  # ============================================================ 
  # RETURN VALUE MANIPULATION
  # ============================================================ 

  - id: esrch-return
    description: Return -ESRCH (no such process - hiding indicator)
    criticality: suspicious
    confidence: 0.8
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: return_statement
      pattern: "ESRCH"

  - id: error-code-return
    description: Kernel error code return
    criticality: suspicious
    confidence: 0.6
    file_types: [c]
    platforms: [linux]
    condition:
      type: ast_pattern
      node_type: return_statement
      pattern: "-E[A-Z]+"
      regex: true

  # ============================================================ 
  # KERNEL MODULE LOADING (FILELESS)
  # ============================================================ 

  - id: fileless-lkm-loading
    description: Fileless kernel module loading (memfd_create + finit_module)
    criticality: suspicious
    confidence: 1.0
    attack: "T1620"
    file_types: [elf, c]
    condition:
      type: yara
      source: |
        rule fileless_lkm_loading {
          strings:
            $memfd = "memfd_create" ascii
            $finit = "finit_module" ascii
            $sys_memfd = "SYS_memfd_create" ascii
            $sys_finit = "SYS_finit_module" ascii
          condition:
            (any of ($memfd, $sys_memfd)) and (any of ($finit, $sys_finit))
        }

  # ============================================================ 
  # MEMORY PROTECTION BYPASS (PTE MANIPULATION)
  # ============================================================ 

  - id: pte-manipulation
    description: Direct PTE manipulation to bypass memory protection
    criticality: suspicious
    confidence: 0.95
    attack: "T1014"
    file_types: [c]
    condition:
      type: yara
      source: |
        rule pte_manipulation {
          strings:
            $lookup = "lookup_address" ascii
            $rw = "_PAGE_RW" ascii
            $nx = "_PAGE_NX" ascii
          condition:
            $lookup and ($rw or $nx)
        }

  # ============================================================ 
  # ELF BINARY PATCHING
  # ============================================================ 

  - id: elf-patching
    description: ELF binary structural patching (Infection)
    criticality: suspicious
    confidence: 0.95
    attack: "T1542.001"
    file_types: [c]
    condition:
      type: yara
      source: |
        rule elf_patching {
          strings:
            $elf1 = "Elf64_Ehdr" ascii
            $elf2 = "Elf64_Shdr" ascii
            $elf3 = "Elf64_Phdr" ascii
            $entry = "e_entry" ascii
            $patch = "patch" ascii nocase
          condition:
            all of ($elf*) and ($entry or $patch)
        }
composite_rules:
  # Advanced LKM Rootkit Flow
  - id: advanced-lkm-rootkit
    description: Advanced LKM rootkit with fileless loading or PTE manipulation
    criticality: hostile
    confidence: 1.0
    attack: "T1014"
    file_types: [elf, c]
    requires_any:
      - id: fileless-lkm-loading
      - id: pte-manipulation
      - id: elf-patching