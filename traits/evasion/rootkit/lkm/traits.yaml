# Linux Kernel Rootkit Detection Traits
# These detect common rootkit behaviors in C source code
# MBC: Defense Evasion, Privilege Escalation
# ATT&CK: T1014 (Rootkit), T1068 (Exploitation for Privilege Escalation)

traits:
  # ============================================================
  # KERNEL MODULE HEADERS
  # ============================================================

  - id: kernel-module-header
    desc: Linux kernel module header (loadable kernel module)
    crit: suspicious
    conf: 0.98
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/module.h"

  - id: kernel-header
    desc: Linux kernel header
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/kernel.h"

  - id: kernel-syscalls-header
    desc: Linux syscall definitions (syscall hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/syscalls.h"

  - id: kernel-dirent-header
    desc: Linux directory entry header (file hiding)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/dirent.h"

  - id: kernel-cred-header
    desc: Linux credentials header (privilege escalation)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/cred.h"

  - id: kernel-kallsyms-header
    desc: Linux kallsyms header (kernel symbol access)
    crit: suspicious
    conf: 0.98
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/kallsyms.h"

  - id: kernel-ftrace-header
    desc: Linux ftrace header (function tracing/hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/ftrace.h"

  - id: kernel-kprobes-header
    desc: Linux kprobes header (kernel probing/hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/kprobes.h"

  - id: kernel-procfs-header
    desc: Linux procfs header (process hiding)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "linux/proc_fs.h"

  - id: ftrace-helper-include
    desc: Ftrace helper library (common rootkit hooking library)
    crit: suspicious
    conf: 0.99
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: preproc_include
      pattern: "ftrace_helper"

  # ============================================================
  # KERNEL FUNCTION CALLS
  # ============================================================

  - id: kallsyms-lookup
    desc: Kernel symbol lookup (rootkit indicator)
    crit: suspicious
    conf: 0.98
    mbc: "F0004"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "kallsyms_lookup_name"

  - id: prepare-creds-call
    desc: Prepare kernel credentials (privilege escalation)
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "prepare_creds"

  - id: commit-creds-call
    desc: Commit kernel credentials (privilege escalation)
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "commit_creds"

  - id: list-del-call
    desc: Kernel list deletion (module hiding)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "list_del"

  - id: cr0-read-call
    desc: Read CR0 register (memory protection bypass)
    crit: suspicious
    conf: 0.98
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "read_cr0"

  - id: cr0-write-call
    desc: Write CR0 register (disable write protection)
    crit: suspicious
    conf: 0.99
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "write_cr0"

  - id: kzalloc-call
    desc: Kernel memory allocation
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "kzalloc"

  - id: copy-from-user-call
    desc: Copy data from user space to kernel
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "copy_from_user"

  - id: copy-to-user-call
    desc: Copy data from kernel to user space
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "copy_to_user"

  # ============================================================
  # MODULE MACROS
  # ============================================================

  - id: module-license-macro
    desc: Kernel module license declaration
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "MODULE_LICENSE"

  - id: module-init-macro
    desc: Kernel module initialization function
    crit: suspicious
    conf: 0.98
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "module_init"

  - id: module-exit-macro
    desc: Kernel module exit function
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "module_exit"

  - id: for-each-process-macro
    desc: Kernel process enumeration macro
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "for_each_process"

  # ============================================================
  # DECLARATIONS / STRUCTURES
  # ============================================================

  - id: syscall-table-decl
    desc: Syscall table pointer (syscall hooking)
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "sys_call_table"

  - id: task-struct-decl
    desc: Task structure access (process manipulation)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "task_struct"

  - id: cred-struct-decl
    desc: Credential structure access (privilege escalation)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "struct cred"

  - id: linux-dirent-decl
    desc: Directory entry structure (file/process hiding)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "linux_dirent"

  - id: pt-regs-decl
    desc: Register state structure (syscall interception)
    crit: suspicious
    conf: 0.85
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "pt_regs"

  # ============================================================
  # EXPRESSION PATTERNS
  # ============================================================

  - id: syscall-number-ref
    desc: Direct syscall number reference (syscall hooking)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: binary_expression
      pattern: "__NR_"

  - id: proc-root-ino-ref
    desc: Proc filesystem root inode (process hiding)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: binary_expression
      pattern: "PROC_ROOT_INO"

  - id: cr0-wp-bit-manipulation
    desc: CR0 write-protect bit manipulation
    crit: suspicious
    conf: 0.99
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: binary_expression
      pattern: "0x00010000"

  - id: this-module-ref
    desc: Kernel module self-reference (module hiding)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "THIS_MODULE"

  # ============================================================
  # COMMENT/METADATA DETECTION
  # ============================================================

  - id: rootkit-mention-comment
    desc: Code explicitly mentions rootkit
    crit: suspicious
    conf: 1.0
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "rootkit"
      case_insensitive: true

  - id: malware-mention-comment
    desc: Code explicitly mentions malware/backdoor
    crit: suspicious
    conf: 1.0
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "malware|backdoor"
      regex: true
      case_insensitive: true

  - id: privesc-mention-comment
    desc: Code explicitly mentions privilege escalation
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "privilege.?escalation|privesc"
      regex: true
      case_insensitive: true

  - id: evasion-mention-comment
    desc: Code mentions evasion techniques
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "evasion|evade"
      regex: true
      case_insensitive: true

  - id: syscall-hook-mention-comment
    desc: Code mentions syscall hooking
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "syscall.{0,20}(hook|intercept)"
      regex: true
      case_insensitive: true

  # ============================================================
  # FUNCTION NAMING PATTERNS
  # ============================================================

  - id: hide-function-name
    desc: Function name suggests hiding capability
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast_pattern
      node_type: function_definition
      pattern: "hide|invisible|stealth"
      regex: true
      case_insensitive: true

  - id: hook-syscall-function-name
    desc: Function name suggests syscall hooking
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast_pattern
      node_type: function_definition
      pattern: "hook.{0,20}(sys|syscall)"
      regex: true
      case_insensitive: true

  # ============================================================
  # INLINE ASSEMBLY
  # ============================================================

  - id: asm-cr0-manipulation
    desc: Inline assembly manipulating CR0 register
    crit: suspicious
    conf: 0.98
    for: [c]
    if:
      type: ast_pattern
      node_type: asm_statement
      pattern: "cr0"
      case_insensitive: true

  - id: asm-syscall-invocation
    desc: Inline assembly with direct syscall invocation
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast_pattern
      node_type: asm_statement
      pattern: "int.{0,10}0x80|syscall|sysenter"
      regex: true

  # ============================================================
  # DIRECTORY ENTRY MANIPULATION (FILE/PROCESS HIDING)
  # ============================================================

  - id: d-reclen-manipulation
    desc: Directory entry record length manipulation (file hiding)
    crit: suspicious
    conf: 0.98
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "d_reclen"

  - id: d-name-access
    desc: Directory entry name field access
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "d_name"

  - id: simple-strtoul-call
    desc: String to unsigned long conversion (PID parsing for hiding)
    crit: suspicious
    conf: 0.85
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "simple_strtoul"

  - id: memmove-call
    desc: Memory move operation (often used for dirent manipulation)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "memmove"

  - id: memcmp-dirent-context
    desc: Memory comparison (file prefix matching for hiding)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "memcmp"

  # ============================================================
  # MODULE HIDING TECHNIQUES
  # ============================================================

  - id: sect-attrs-removal
    desc: Module section attributes removal (hide module info)
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "sect_attrs"

  - id: list-add-call
    desc: Kernel list addition (module unhiding toggle)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "list_add"

  - id: kfree-call
    desc: Kernel memory free (often used to remove module metadata)
    crit: suspicious
    conf: 0.7
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "kfree"

  # ============================================================
  # SYSCALL HOOKING INFRASTRUCTURE
  # ============================================================

  - id: asmlinkage-decl
    desc: Assembly linkage declaration (syscall calling convention)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "asmlinkage"

  - id: t-syscall-typedef
    desc: Syscall function pointer typedef
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: type_definition
      pattern: "t_syscall|syscall_fn|sys_call_ptr"
      regex: true

  - id: orig-syscall-pattern
    desc: Original syscall saving pattern (hooking infrastructure)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "orig_"
      regex: false

  - id: pt-regs-register-access
    desc: Direct register access via pt_regs (syscall argument extraction)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "pt_regs->"

  - id: pt-regs-di-access
    desc: RDI register access (first syscall argument)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "->di"

  - id: pt-regs-si-access
    desc: RSI register access (second syscall argument)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "->si"

  # ============================================================
  # KERNEL STRUCTURE TRAVERSAL
  # ============================================================

  - id: current-files-access
    desc: Current process file table access
    crit: suspicious
    conf: 0.85
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "current->files"

  - id: fdt-access
    desc: File descriptor table access
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "->fdt"

  - id: f-path-dentry-access
    desc: File path dentry access (inode traversal)
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "f_path.dentry"

  - id: d-inode-access
    desc: Dentry inode access
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "->d_inode"

  - id: i-ino-access
    desc: Inode number access (filesystem identification)
    crit: suspicious
    conf: 0.85
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "i_ino"

  - id: i-rdev-access
    desc: Inode device number access
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "i_rdev"

  - id: major-macro-call
    desc: MAJOR device number extraction
    crit: suspicious
    conf: 0.75
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "MAJOR"

  # ============================================================
  # USER/KERNEL BOUNDARY
  # ============================================================

  - id: user-annotation
    desc: __user annotation (kernel/userspace boundary marker)
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "__user"

  - id: gfp-kernel-alloc
    desc: GFP_KERNEL allocation flag
    crit: suspicious
    conf: 0.7
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "GFP_KERNEL"

  # ============================================================
  # MODULE LIFECYCLE
  # ============================================================

  - id: init-attribute
    desc: __init module initialization attribute
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: function_definition
      pattern: "__init"

  - id: exit-attribute
    desc: __exit module cleanup attribute
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: function_definition
      pattern: "__exit"

  - id: module-author-macro
    desc: MODULE_AUTHOR declaration (attacker attribution)
    crit: suspicious
    conf: 0.7
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "MODULE_AUTHOR"

  - id: module-description-macro
    desc: MODULE_DESCRIPTION declaration
    crit: suspicious
    conf: 0.7
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "MODULE_DESCRIPTION"

  - id: dual-bsd-gpl-license
    desc: Dual BSD/GPL license (common rootkit license)
    crit: suspicious
    conf: 0.6
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: string_literal
      pattern: "Dual BSD/GPL"

  # ============================================================
  # SIGNAL-BASED BACKDOOR CONTROL
  # ============================================================

  - id: custom-signal-define
    desc: Custom signal definition (backdoor trigger)
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    if:
      type: ast_pattern
      node_type: preproc_def
      pattern: "SIG[A-Z]+"
      regex: true

  - id: signal-switch-handler
    desc: Signal-based switch handler (command dispatch)
    crit: suspicious
    conf: 0.8
    for: [c]
    if:
      type: ast_pattern
      node_type: switch_statement
      pattern: "sig"
      case_insensitive: true

  # ============================================================
  # TASK/PROCESS MANIPULATION
  # ============================================================

  - id: task-flags-manipulation
    desc: Task flags manipulation (process hiding via PF_INVISIBLE)
    crit: suspicious
    conf: 0.98
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "task->flags|p->flags"
      regex: true

  - id: pf-invisible-flag
    desc: PF_INVISIBLE flag value (0x10000000)
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: binary_expression
      pattern: "0x10000000"

  - id: xor-assign-flags
    desc: XOR assignment on flags (toggle visibility)
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast_pattern
      node_type: assignment_expression
      pattern: "\\^="
      regex: true

  - id: current-macro-ref
    desc: Current task reference macro
    crit: suspicious
    conf: 0.75
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: identifier
      pattern: "^current$"
      regex: true

  # ============================================================
  # CREDENTIAL MANIPULATION
  # ============================================================

  - id: uid-zero-assign
    desc: UID set to zero (root privilege)
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: assignment_expression
      pattern: "uid.{0,10}=.{0,10}0|->uid = 0"
      regex: true

  - id: gid-zero-assign
    desc: GID set to zero (root group)
    crit: suspicious
    conf: 0.98
    attack: "T1068"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: assignment_expression
      pattern: "gid.{0,10}=.{0,10}0|->gid = 0"
      regex: true

  - id: euid-egid-access
    desc: Effective UID/GID access (privilege escalation)
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "euid|egid|suid|sgid|fsuid|fsgid"
      regex: true

  # ============================================================
  # COMPILER/MEMORY ORDERING
  # ============================================================

  - id: force-order-variable
    desc: __force_order variable (prevent CR0 write reordering)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "__force_order"

  - id: volatile-asm
    desc: Volatile inline assembly (prevent optimization)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast_pattern
      node_type: asm_statement
      pattern: "volatile"

  # ============================================================
  # GETDENTS HOOKING SPECIFIC
  # ============================================================

  - id: getdents-hook-function
    desc: getdents hook function (directory listing interception)
    crit: suspicious
    conf: 0.99
    attack: "T1014"
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: function_definition
      pattern: "getdents"
      case_insensitive: true

  - id: nr-getdents-ref
    desc: __NR_getdents syscall number reference
    crit: suspicious
    conf: 0.98
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "__NR_getdents"

  - id: nr-kill-ref
    desc: __NR_kill syscall number reference (signal hooking)
    crit: suspicious
    conf: 0.95
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: subscript_expression
      pattern: "__NR_kill"

  # ============================================================
  # SUSPICIOUS COMMENT PATTERNS
  # ============================================================

  - id: corruption-mention-comment
    desc: Code mentions corruption/corrupting
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "corrupt"
      case_insensitive: true

  - id: hiding-mention-comment
    desc: Code mentions hiding/hidden
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "hid(e|ing|den)"
      regex: true
      case_insensitive: true

  - id: stealthy-mention-comment
    desc: Code mentions stealth/stealthy
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "stealth"
      case_insensitive: true

  - id: unauthorized-mention-comment
    desc: Code mentions unauthorized access
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "unauthori[sz]ed"
      regex: true
      case_insensitive: true

  - id: defeating-mention-comment
    desc: Code mentions defeating protections
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "defeat"
      case_insensitive: true

  - id: persistence-mention-comment
    desc: Code mentions persistence
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "persist"
      case_insensitive: true

  - id: polymorphic-mention-comment
    desc: Code mentions polymorphic techniques
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "polymorphic"
      case_insensitive: true

  - id: covert-channel-mention-comment
    desc: Code mentions covert channels/communication
    crit: suspicious
    conf: 0.95
    for: [c]
    if:
      type: ast_pattern
      node_type: comment
      pattern: "covert"
      case_insensitive: true

  # ============================================================
  # OBFUSCATED NAMING PATTERNS
  # ============================================================

  - id: random-prefix-function
    desc: Function with random-looking prefix (obfuscation)
    crit: suspicious
    conf: 0.7
    for: [c]
    if:
      type: ast_pattern
      node_type: function_definition
      pattern: "^[a-z]{3,5}[0-9]?_"
      regex: true

  - id: underscore-heavy-naming
    desc: Heavy underscore usage in names (kernel-style obfuscation)
    crit: suspicious
    conf: 0.6
    for: [c]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "^__[a-z]+"
      regex: true

  # ============================================================
  # RETURN VALUE MANIPULATION
  # ============================================================

  - id: esrch-return
    desc: Return -ESRCH (no such process - hiding indicator)
    crit: suspicious
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: return_statement
      pattern: "ESRCH"

  - id: error-code-return
    desc: Kernel error code return
    crit: suspicious
    conf: 0.6
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: return_statement
      pattern: "-E[A-Z]+"
      regex: true

  # ============================================================
  # KERNEL MODULE LOADING (FILELESS) - micro-traits
  # ============================================================

  - id: memfd-create-call
    desc: memfd_create function call
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    platforms: [linux]
    if:
      type: symbol
      pattern: "memfd_create"

  - id: sys-memfd-create-ref
    desc: SYS_memfd_create syscall reference
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    platforms: [linux]
    if:
      type: string
      exact: "SYS_memfd_create"

  - id: finit-module-call
    desc: finit_module function call
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    platforms: [linux]
    if:
      type: symbol
      pattern: "finit_module"

  - id: sys-finit-module-ref
    desc: SYS_finit_module syscall reference
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    platforms: [linux]
    if:
      type: string
      exact: "SYS_finit_module"

  # ============================================================
  # MEMORY PROTECTION BYPASS (PTE) - micro-traits
  # ============================================================

  - id: lookup-address-call
    desc: lookup_address kernel function call
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "lookup_address"

  - id: page-rw-flag
    desc: _PAGE_RW memory protection flag
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: string
      exact: "_PAGE_RW"

  - id: page-nx-flag
    desc: _PAGE_NX memory protection flag
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    if:
      type: string
      exact: "_PAGE_NX"

  # ============================================================
  # ELF BINARY PATCHING - micro-traits
  # ============================================================

  - id: elf64-ehdr-decl
    desc: Elf64_Ehdr structure declaration
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "Elf64_Ehdr"

  - id: elf64-shdr-decl
    desc: Elf64_Shdr structure declaration
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "Elf64_Shdr"

  - id: elf64-phdr-decl
    desc: Elf64_Phdr structure declaration
    crit: suspicious
    conf: 0.85
    for: [c]
    if:
      type: ast_pattern
      node_type: declaration
      pattern: "Elf64_Phdr"

  - id: elf-entry-field
    desc: e_entry ELF entry point field access
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: ast_pattern
      node_type: field_expression
      pattern: "e_entry"

  - id: patch-string-ref
    desc: patch string reference
    crit: inert
    conf: 0.6
    for: [c]
    if:
      type: string
      word: "patch"

composite_rules:
  # memfd_create composite
  - id: memfd-create
    desc: memfd_create usage (memory-backed file)
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    platforms: [linux]
    count: 1
    any:
      - id: memfd-create-call
      - id: sys-memfd-create-ref

  # finit_module composite
  - id: finit-module
    desc: finit_module usage (module loading)
    crit: suspicious
    conf: 0.95
    for: [elf, c]
    platforms: [linux]
    count: 1
    any:
      - id: finit-module-call
      - id: sys-finit-module-ref

  # Fileless LKM loading (migrated from YARA)
  - id: fileless-lkm-loading
    desc: Fileless kernel module loading (memfd_create + finit_module)
    crit: suspicious
    conf: 1.0
    attack: "T1620"
    for: [elf, c]
    all:
      - id: memfd-create
      - id: finit-module

  # Page protection flag composite
  - id: page-protection-flag
    desc: Memory page protection flags
    crit: suspicious
    conf: 0.9
    for: [c]
    platforms: [linux]
    count: 1
    any:
      - id: page-rw-flag
      - id: page-nx-flag

  # PTE manipulation (migrated from YARA)
  - id: pte-manipulation
    desc: Direct PTE manipulation to bypass memory protection
    crit: suspicious
    conf: 0.95
    attack: "T1014"
    for: [c]
    all:
      - id: lookup-address-call
      - id: page-protection-flag

  # ELF headers composite
  - id: elf64-headers
    desc: ELF64 structure headers
    crit: suspicious
    conf: 0.85
    for: [c]
    all:
      - id: elf64-ehdr-decl
      - id: elf64-shdr-decl
      - id: elf64-phdr-decl

  # ELF patching (migrated from YARA)
  - id: elf-patching
    desc: ELF binary structural patching (Infection)
    crit: suspicious
    conf: 0.95
    attack: "T1542.001"
    for: [c]
    all:
      - id: elf64-headers
    any:
      - id: elf-entry-field
      - id: patch-string-ref

  # Advanced LKM Rootkit Flow
  - id: advanced-lkm-rootkit
    desc: Advanced LKM rootkit with fileless loading or PTE manipulation
    crit: hostile
    conf: 1.0
    attack: "T1014"
    for: [elf, c]
    any:
      - id: fileless-lkm-loading
      - id: pte-manipulation
      - id: elf-patching
