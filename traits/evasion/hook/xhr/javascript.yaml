# XMLHttpRequest Hooking - JavaScript
# Detects hooking/patching of XMLHttpRequest to intercept web traffic
# ATT&CK: T1557 (Adversary-in-the-Middle), T1185 (Browser Session Hijacking)

defaults:
  file_types: [javascript]
  attack: "T1557"
  criticality: suspicious

traits:
  # === XMLHttpRequest prototype atomic ===
  - id: xhr-prototype-access
    description: XMLHttpRequest.prototype access
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      exact: "XMLHttpRequest.prototype"

  - id: xhr-bracket-access
    description: XMLHttpRequest bracket notation access
    criticality: inert
    confidence: 0.6
    condition:
      type: string
      regex: "XMLHttpRequest\\[.+\\]\\[.+\\]"

  # === XMLHttpRequest.open hook atomic ===
  - id: xhr-prototype-open-eq
    description: XMLHttpRequest.prototype.open assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "XMLHttpRequest\\.prototype\\.open\\s*="

  - id: xhr-bracket-open-eq
    description: XMLHttpRequest bracket open assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "XMLHttpRequest\\[.+\\]\\[.+open.+\\]\\s*="

  # === XMLHttpRequest.send hook atomic ===
  - id: xhr-prototype-send-eq
    description: XMLHttpRequest.prototype.send assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "XMLHttpRequest\\.prototype\\.send\\s*="

  - id: xhr-bracket-send-eq
    description: XMLHttpRequest bracket send assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "XMLHttpRequest\\[.+\\]\\[.+send.+\\]\\s*="

  # === fetch API hook atomic ===
  - id: window-fetch-eq
    description: window.fetch assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "window\\.fetch\\s*="

  - id: globalthis-fetch-eq
    description: globalThis.fetch assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "globalThis\\.fetch\\s*="

  - id: self-fetch-eq
    description: self.fetch assignment
    criticality: inert
    confidence: 0.7
    condition:
      type: string
      regex: "self\\.fetch\\s*="

  # onreadystatechange interception
  - id: readystate-intercept
    description: "XMLHttpRequest readystate interception"
    confidence: 0.7
    condition:
      type: string
      regex: "onreadystatechange\\s*=.*function"

composite_rules:
  # XMLHttpRequest prototype access composite
  - id: prototype-access
    description: "XMLHttpRequest prototype access (potential hooking)"
    confidence: 0.8
    requires_count: 1
    conditions:
      - type: trait
        id: xhr-prototype-access
      - type: trait
        id: xhr-bracket-access

  # XMLHttpRequest.open hook composite
  - id: open-hook
    description: "XMLHttpRequest.open method hooking"
    confidence: 0.85
    criticality: suspicious
    requires_count: 1
    conditions:
      - type: trait
        id: xhr-prototype-open-eq
      - type: trait
        id: xhr-bracket-open-eq

  # XMLHttpRequest.send hook composite
  - id: send-hook
    description: "XMLHttpRequest.send method hooking"
    confidence: 0.85
    criticality: suspicious
    requires_count: 1
    conditions:
      - type: trait
        id: xhr-prototype-send-eq
      - type: trait
        id: xhr-bracket-send-eq

  # fetch API hook composite
  - id: fetch-hook
    description: "fetch API hooking"
    confidence: 0.85
    criticality: suspicious
    requires_count: 1
    conditions:
      - type: trait
        id: window-fetch-eq
      - type: trait
        id: globalthis-fetch-eq
      - type: trait
        id: self-fetch-eq

  # Multiple XHR hooks = request interceptor
  - id: request-interceptor
    description: "HTTP request interceptor (XHR/fetch hooking)"
    criticality: hostile
    confidence: 0.9
    attack: "T1557"
    file_types: [javascript]
    requires_count: 2
    conditions:
      - type: composite
        id: open-hook
      - type: composite
        id: send-hook
      - type: composite
        id: fetch-hook
