# Timestomping Detection - Shell
# MBC: F0006 (Timestomp)
# ATT&CK: T1070.006

defaults:
  attack: "T1070.006"
  mbc: "F0006"

traits:
  # === Generic touch with timestamp flags ===
  - id: timestomp-touch
    desc: Modify timestamps via touch command
    crit: suspicious
    conf: 0.66
    for: [shell]
    if:
      type: string
      regex: "touch\\s+-[amdt]"

  # === Specific touch timestamp patterns ===
  - id: touch-t-flag
    desc: touch -t with numeric timestamp
    crit: inert
    conf: 0.75
    for: [shell]
    if:
      type: string
      regex: "touch\\s+-t\\s+[0-9]+"

  - id: touch-r-flag
    desc: touch -r reference file
    crit: inert
    conf: 0.75
    for: [shell]
    if:
      type: string
      regex: "touch\\s+-r\\s+"

  - id: touch-date-flag
    desc: touch --date flag
    crit: inert
    conf: 0.75
    for: [shell]
    if:
      type: string
      regex: "touch\\s+--date="

  - id: touch-a-flag
    desc: touch -a access time
    crit: inert
    conf: 0.7
    for: [shell]
    if:
      type: string
      regex: "touch\\s+-a"

  - id: touch-m-flag
    desc: touch -m modification time
    crit: inert
    conf: 0.7
    for: [shell]
    if:
      type: string
      regex: "touch\\s+-m"

  - id: touch-d-flag
    desc: touch -d date string
    crit: inert
    conf: 0.7
    for: [shell]
    if:
      type: string
      regex: "touch\\s+-d"

  # === Other timestamp manipulation ===
  - id: dd-timestamp-modify
    desc: dd to modify file timestamps
    crit: suspicious
    conf: 0.7
    for: [shell]
    if:
      type: string
      regex: "dd\\s+.{0,50}conv=notrunc"

  - id: debugfs-timestamp
    desc: debugfs to modify ext filesystem timestamps
    crit: suspicious
    conf: 0.85
    for: [shell]
    if:
      type: string
      regex: "debugfs.{0,50}-w.{0,50}set_inode_field"

  - id: setfile-timestamp-macos
    desc: SetFile to modify macOS timestamps
    crit: suspicious
    conf: 0.8
    for: [shell]
    if:
      type: string
      regex: "SetFile\\s+-[dm]"

  - id: powershell-timestamp-modify
    desc: PowerShell timestamp modification
    crit: suspicious
    conf: 0.8
    for: [powershell]
    if:
      type: string
      regex: "\\.(CreationTime|LastWriteTime|LastAccessTime)\\s*="

  # === Timestamp-related keywords ===
  - id: timestomp-keyword
    desc: timestomp keyword
    crit: notable
    conf: 0.85
    for: [shell, powershell]
    if:
      type: string
      word: "timestomp"

  - id: timestamp-forge-keyword
    desc: timestamp forge keyword
    crit: notable
    conf: 0.7
    for: [shell, powershell]
    if:
      type: string
      regex: "forge.{0,50}timestamp"

composite_rules:
  # Migrated from YARA
  - id: timestomp-touch-specific
    desc: Set specific timestamp via touch -t
    crit: suspicious
    conf: 0.8
    for: [shell]
    any:
      - {id: touch-t-flag}
      - {id: touch-r-flag}
      - {id: touch-date-flag}

  # Combined timestamp manipulation
  - id: timestamp-manipulation
    desc: File timestamp manipulation detected
    crit: suspicious
    conf: 0.85
    for: [shell, powershell]
    any:
      - {id: timestomp-touch-specific}
      - {id: dd-timestamp-modify}
      - {id: debugfs-timestamp}
      - {id: setfile-timestamp-macos}
      - {id: powershell-timestamp-modify}
      - {id: timestomp-keyword}
