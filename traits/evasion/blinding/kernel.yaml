# Security Product Blinding
# Detects active interference with security products (LKRG, EDR, AV)

traits:
  # === LKRG (Linux Kernel Runtime Guard) Functions ===
  - id: p-check-integrity
    desc: p_check_integrity LKRG function
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: string
      exact: "p_check_integrity"

  - id: p-dump-task-f
    desc: p_dump_task_f LKRG function
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: string
      exact: "p_dump_task_f"

  - id: p-cmp-creds
    desc: p_cmp_creds LKRG function
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: string
      exact: "p_cmp_creds"

  - id: p-cmp-tasks
    desc: p_cmp_tasks LKRG function
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: string
      exact: "p_cmp_tasks"

  - id: ed-task-add
    desc: ed_task_add LKRG function
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: string
      exact: "ed_task_add"

  - id: p-exploit-detection-init
    desc: p_exploit_detection_init LKRG function
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: string
      exact: "p_exploit_detection_init"

  # === Generic Kernel Security Functions ===
  - id: check-integrity
    desc: check_integrity function
    crit: suspicious
    conf: 0.85
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: string
      regex: "(?i)check_integrity"

  - id: validate-sp
    desc: validate_sp stack pointer check
    crit: suspicious
    conf: 0.85
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: string
      regex: "(?i)validate_sp"

  - id: enforce-pcfi
    desc: enforce_pcfi control flow integrity
    crit: suspicious
    conf: 0.9
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: string
      regex: "(?i)enforce_pcfi"

  - id: exploit-detection
    desc: exploit_detection function
    crit: suspicious
    conf: 0.9
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: string
      regex: "(?i)exploit_detection"

  - id: bypass-selinux
    desc: bypass_selinux function
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: string
      regex: "(?i)bypass_selinux"

  # Hooking Security functions (AST)
  - id: hook-security-logic
    desc: Structural detection of hooking kernel integrity checks
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [c]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "HOOK(.*integrity|.*exploit|.*pcfi)"
      regex: true

composite_rules:
  # LKRG blinding (migrated from YARA)
  - id: lkrg
    desc: Targets Linux Kernel Runtime Guard (LKRG) integrity checks
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    count_min: 1
    any:
      - id: p-check-integrity
      - id: p-dump-task-f
      - id: p-cmp-creds
      - id: p-cmp-tasks
      - id: ed-task-add
      - id: p-exploit-detection-init

  # Kernel integrity blinding (migrated from YARA)
  - id: kernel-integrity
    desc: Targets kernel integrity or exploit detection functions
    crit: suspicious
    conf: 0.9
    attack: "T1562.001"
    for: [c, elf]
    count_min: 1
    any:
      - id: check-integrity
      - id: validate-sp
      - id: enforce-pcfi
      - id: exploit-detection
      - id: bypass-selinux

  # Active security software blinding (e.g. LKRG, EDR)
  - id: security-software-blinding
    desc: High-confidence detection of security software blinding (LKRG/EDR)
    crit: hostile
    conf: 0.99
    attack: "T1562.001"
    for: [c]
    count_min: 2
    any:
      - id: lkrg
      - id: hook-security-logic
      - id: kernel-integrity
