# Security Product Blinding
# Detects active interference with security products (LKRG, EDR, AV)

traits:
  # LKRG Blinding
  - id: lkrg
    desc: Targets Linux Kernel Runtime Guard (LKRG) integrity checks
    crit: suspicious
    conf: 1.0
    attack: "T1562.001"
    for: [c]
    if:
      type: yara
      source: |
        rule target_lkrg {
          strings:
            $s1 = "p_check_integrity" ascii
            $s2 = "p_dump_task_f" ascii
            $s3 = "p_cmp_creds" ascii
            $s4 = "p_cmp_tasks" ascii
            $s5 = "ed_task_add" ascii
            $s6 = "p_exploit_detection_init" ascii
          condition:
            any of them
        }

  # Generic Kernel Security Blinding
  - id: kernel-integrity
    desc: Targets kernel integrity or exploit detection functions
    crit: suspicious
    conf: 0.9
    attack: "T1562.001"
    for: [c, elf]
    if:
      type: yara
      source: |
        rule kernel_security_blinding {
          strings:
            $f1 = "check_integrity" ascii nocase
            $f2 = "validate_sp" ascii nocase
            $f3 = "enforce_pcfi" ascii nocase
            $f4 = "exploit_detection" ascii nocase
            $f5 = "bypass_selinux" ascii nocase
          condition:
            any of them
        }

  # Hooking Security functions (AST)
  - id: hook-security-logic
    desc: Structural detection of hooking kernel integrity checks
    crit: suspicious
    conf: 0.95
    attack: "T1562.001"
    for: [c]
    if:
      type: ast_pattern
      node_type: call_expression
      pattern: "HOOK(.*integrity|.*exploit|.*pcfi)"
      regex: true

composite_rules:
  # Active security software blinding (e.g. LKRG, EDR)
  - id: security-software-blinding
    desc: High-confidence detection of security software blinding (LKRG/EDR)
    crit: hostile
    conf: 0.99
    attack: "T1562.001"
    for: [c]
    requires_count: 2
    any:
      - id: evasion/blinding/lkrg
      - id: evasion/blinding/hook-security-logic
      - id: evasion/blinding/kernel-integrity
      - id: kernel/rootkit/ftrace-helper-include
