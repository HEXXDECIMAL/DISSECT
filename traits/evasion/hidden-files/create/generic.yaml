# Hidden File Detection Traits
# Detects creation of hidden dotfiles often used to hide malware
# ATT&CK: T1564.001 (Hide Artifacts: Hidden Files and Directories)

defaults:
  for: [all]

traits:
  # === Hidden file write atomic indicators ===
  - id: curl-o-hidden
    desc: curl -O to hidden dotfile
    crit: inert
    conf: 0.7
    mbc: "F0005"
    attack: "T1564.001"
    if:
      type: string
      regex: "-O \\./\\.[a-zA-Z]"
      search_raw: true

  - id: redirect-hidden-space
    desc: redirect to hidden dotfile (with space)
    crit: inert
    conf: 0.7
    mbc: "F0005"
    attack: "T1564.001"
    if:
      type: string
      regex: "> \\./\\.[a-zA-Z]"
      search_raw: true

  - id: redirect-hidden-nospace
    desc: redirect to hidden dotfile (no space)
    crit: inert
    conf: 0.7
    mbc: "F0005"
    attack: "T1564.001"
    if:
      type: string
      regex: ">\\./\\.[a-zA-Z]"
      search_raw: true

  # === Hidden file execute atomic indicators ===
  - id: exec-hidden-space
    desc: execute hidden dotfile (followed by space)
    crit: inert
    conf: 0.7
    mbc: "B0024"
    attack: "T1059"
    if:
      type: string
      regex: "\\./\\.[a-zA-Z][a-zA-Z0-9_-]*\\s"
      search_raw: true

  - id: exec-hidden-eol
    desc: execute hidden dotfile (end of line)
    crit: inert
    conf: 0.7
    mbc: "B0024"
    attack: "T1059"
    if:
      type: string
      regex: "\\./\\.[a-zA-Z][a-zA-Z0-9_-]*$"
      search_raw: true

  - id: exec-hidden-semi
    desc: execute hidden dotfile (followed by semicolon)
    crit: inert
    conf: 0.7
    mbc: "B0024"
    attack: "T1059"
    if:
      type: string
      regex: "\\./\\.[a-zA-Z][a-zA-Z0-9_-]*;"
      search_raw: true

  # === chmod hidden file atomic indicators ===
  - id: chmod-x-hidden
    desc: chmod +x on hidden file
    crit: inert
    conf: 0.7
    mbc: "C0047"
    attack: "T1222.002"
    if:
      type: string
      regex: "chmod \\+x \\.[a-zA-Z]"
      search_raw: true

  - id: chmod-7xx-hidden
    desc: chmod 7xx on hidden file
    crit: inert
    conf: 0.7
    mbc: "C0047"
    attack: "T1222.002"
    if:
      type: string
      regex: "chmod 7[0-9][0-9] \\.[a-zA-Z]"
      search_raw: true

composite_rules:
  - id: hidden-file-write
    desc: Writing to hidden dotfile (malware hiding)
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    attack: "T1564.001"
    count: 1
    any:
      - id: curl-o-hidden
      - id: redirect-hidden-space
      - id: redirect-hidden-nospace

  - id: hidden-file-execute
    desc: Executing hidden dotfile
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059"
    count: 1
    any:
      - id: exec-hidden-space
      - id: exec-hidden-eol
      - id: exec-hidden-semi

  - id: chmod-hidden-file
    desc: Making hidden file executable
    crit: suspicious
    conf: 0.9
    mbc: "C0047"
    attack: "T1222.002"
    count: 1
    any:
      - id: chmod-x-hidden
      - id: chmod-7xx-hidden
