# Fake Installer Detection
# Detects malware masquerading as legitimate installers (e.g. Homebrew)
# ATT&CK: T1036.005 (Masquerading: Match Legitimate Name or Location)
# MBC: F0004 (Masquerading)

defaults:
  for: [shell, bash]

traits:
  # === Legitimate Context (Homebrew) ===
  - id: homebrew-prefix
    desc: "Homebrew prefix variable"
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "HOMEBREW_PREFIX"

  - id: brew-no-install
    desc: "Homebrew no-install marker"
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "brew.no_install"

  - id: homebrew-repo
    desc: "Homebrew repository URL"
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "github.com/Homebrew/brew"

  # === Suspicious Behaviors ===
  - id: dscl-authonly-loop
    desc: "macOS dscl phishing loop"
    crit: suspicious
    conf: 0.95
    attack: "T1056.002"
    if:
      type: content
      regex: "dscl . authonly.{0,100}while"

  - id: sudo-refresh-stdin
    desc: "Refreshes sudo via stdin"
    crit: suspicious
    conf: 0.9
    attack: "T1548.002"
    if:
      type: content
      contains: "sudo -v -S"

  - id: homabrews-domain
    desc: "Fake Homebrew typosquatting domain"
    crit: suspicious
    conf: 1.0
    attack: "T1036.005"
    if:
      type: string
      contains: "homabrews.org"

  - id: base64-password
    desc: "Base64 encodes password variable"
    crit: suspicious
    conf: 0.85
    if:
      type: content
      regex: "echo.{0,50}password.{0,50}base64"

composite_rules:
  # Helper: Legitimate Homebrew context markers
  - id: homebrew-context
    desc: "Homebrew context markers"
    crit: inert
    conf: 0.6
    count_min: 2
    any:
      - id: homebrew-prefix
      - id: brew-no-install
      - id: homebrew-repo

  # Helper: Suspicious installer behaviors
  - id: fake-installer-behaviors
    desc: "Suspicious installer behaviors"
    crit: suspicious
    conf: 0.9
    count_min: 2
    any:
      - id: dscl-authonly-loop
      - id: homabrews-domain
      - id: sudo-refresh-stdin
      - id: base64-password

  # Main detection rule
  - id: fake-homebrew-installer
    desc: "Homebrew installer masquerade"
    crit: hostile
    conf: 0.98
    attack: "T1036.005"
    mbc: "F0004"
    platforms: [macos, linux]
    file_types: [shell]
    all:
      - id: homebrew-context
      - id: fake-installer-behaviors