# Process Masquerading Detection
# MBC: F0004 (Process Name Spoofing)
# ATT&CK: T1036.004 (Masquerade Task or Service)

defaults:
  for: [elf]
  platforms: [linux]

traits:
  # === prctl PR_SET_NAME micro-traits ===
  - id: prctl-symbol
    desc: prctl function reference
    crit: inert
    conf: 0.8
    if:
      type: symbol
      pattern: "prctl"

  - id: pr-set-name-const
    desc: PR_SET_NAME constant reference
    crit: notable
    conf: 0.85
    if:
      type: string
      exact: "PR_SET_NAME"

  - id: prctl-syscall-x64
    desc: prctl syscall instruction (x86_64)
    crit: notable
    conf: 0.9
    if:
      type: hex
      pattern: "B8 9D 00 00 00"

  # === System daemon name micro-traits ===
  - id: fake-abrtd-path
    desc: Contains abrtd daemon path
    crit: notable
    conf: 0.85
    mbc: "F0004"
    if:
      type: string
      exact: "/usr/sbin/abrtd"

  - id: fake-abrtd-name
    desc: Contains abrtd daemon name
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "abrtd"

  - id: fake-sshd-bracket
    desc: Fake kernel thread name pattern
    crit: notable
    conf: 0.85
    mbc: "F0004"
    if:
      type: string
      exact: "[sshd]"

  - id: fake-kworker
    desc: Fake kernel worker thread name
    crit: notable
    conf: 0.85
    mbc: "F0004"
    if:
      type: string
      exact: "[kworker/"

  - id: fake-migration
    desc: Fake migration thread name
    crit: notable
    conf: 0.85
    mbc: "F0004"
    if:
      type: string
      exact: "[migration/"

  - id: fake-ksoftirqd
    desc: Fake ksoftirqd thread name
    crit: notable
    conf: 0.85
    mbc: "F0004"
    if:
      type: string
      exact: "[ksoftirqd/"

  - id: fake-kthreadd
    desc: Fake kthreadd thread name
    crit: notable
    conf: 0.85
    mbc: "F0004"
    if:
      type: string
      exact: "[kthreadd]"

  - id: fake-systemd-path
    desc: Contains systemd path (potential masquerade)
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/lib/systemd/systemd"

  - id: fake-udevd-path
    desc: Contains udevd path (potential masquerade)
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/sbin/udevd"

  - id: fake-rsyslogd-path
    desc: Contains rsyslogd path (potential masquerade)
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/usr/sbin/rsyslogd"

  - id: fake-crond-path
    desc: Contains crond path (potential masquerade)
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/usr/sbin/crond"

  - id: fake-atd-path
    desc: Contains atd path (potential masquerade)
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "/usr/sbin/atd"

  # === argv[0] manipulation micro-traits ===
  - id: strncpy-argv0
    desc: strncpy on argv[0] (process name
    crit: suspicious
    conf: 0.85
    mbc: "F0004"
    for: [c, elf]
    if:
      type: string
      regex: "strncpy\\s*\\(\\s*argv\\s*\\[\\s*0\\s*\\]"

  - id: memset-argv0
    desc: memset on argv[0] (process name
    crit: suspicious
    conf: 0.85
    mbc: "F0004"
    for: [c, elf]
    if:
      type: string
      regex: "memset\\s*\\(\\s*argv\\s*\\[\\s*0\\s*\\]"

  - id: strcpy-argv0
    desc: strcpy on argv[0] (process name
    crit: suspicious
    conf: 0.85
    mbc: "F0004"
    for: [c, elf]
    if:
      type: string
      regex: "strcpy\\s*\\(\\s*argv\\s*\\[\\s*0\\s*\\]"

composite_rules:
  # prctl-based process renaming
  - id: prctl-setname
    desc: Uses prctl to change process
    crit: suspicious
    conf: 0.8
    mbc: "F0004"
    attack: "T1036.004"
    for: [elf]
    count_min: 1
    any:
      - id: prctl-symbol
      - id: pr-set-name-const
      - id: prctl-syscall-x64

  # Masquerade as abrtd daemon (BPFDoor indicator)
  - id: fake-abrtd
    desc: Masquerades as abrtd daemon (BPFDoor
    crit: suspicious
    conf: 0.95
    mbc: "F0004"
    attack: "T1036.004"
    for: [elf]
    count_min: 1
    any:
      - id: fake-abrtd-path
      - id: fake-abrtd-name

  # Contains fake system process names (2+ needed)
  - id: fake-system-process
    desc: Contains names of system processes
    crit: suspicious
    conf: 0.75
    mbc: "F0004"
    attack: "T1036.004"
    for: [elf]
    count_min: 2
    any:
      - id: fake-sshd-bracket
      - id: fake-kworker
      - id: fake-migration
      - id: fake-ksoftirqd
      - id: fake-kthreadd
      - id: fake-systemd-path
      - id: fake-udevd-path
      - id: fake-rsyslogd-path
      - id: fake-crond-path
      - id: fake-atd-path

  # argv[0] manipulation
  - id: argv0-manipulation
    desc: Manipulates argv[0] to hide process
    crit: suspicious
    conf: 0.8
    mbc: "F0004"
    attack: "T1036.004"
    for: [c, elf]
    count_min: 1
    any:
      - id: strncpy-argv0
      - id: memset-argv0
      - id: strcpy-argv0

  # BPFDoor-style process masquerading
  - id: bpfdoor-style
    desc: BPFDoor-style process masquerading with anti-forensics
    crit: hostile
    conf: 0.98
    mbc: "F0004"
    attack: "T1036.004"
    for: [elf]
    all:
      - id: prctl-setname
    any:
      - id: fake-abrtd
      - id: fake-system-process
      - id: argv0-manipulation
