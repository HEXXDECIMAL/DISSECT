# AppleScript Window Manipulation Evasion
# Detects hiding of windows to evade user awareness
# ATT&CK: T1564.003 (Hidden Window)

defaults:
  attack: "T1564.003"
  platforms: [macos]
  # osascript can be invoked from any language: python subprocess, ruby system(), etc.
  for: [applescript, shell, python, ruby, perl, javascript, elf, macho]

traits:
  # Hide Terminal window
  - id: terminal-hide
    desc: "Hide Terminal window via AppleScript"
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "(?i)tell.{0,20}Terminal.{0,20}set visible.{0,10}false|Terminal.{0,20}visible.{0,10}false"

  # Hide any window
  - id: window-hide
    desc: "Hide application window"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "set visible.{0,10}to false|set visible of.{0,30}window.{0,10}false"

  # Minimize window
  - id: window-minimize
    desc: "Minimize application window"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "set miniaturized.{0,10}true|set collapsed.{0,10}true"

  # Hide entire application
  - id: app-hide
    desc: "Hide entire application"
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "set visible of.{0,30}application.{0,10}false|tell application.{0,30}to hide"

  # Set frontmost to false (push to back)
  - id: frontmost-false
    desc: "Push application to background"
    crit: notable
    conf: 0.7
    if:
      type: string
      regex: "set frontmost.{0,10}false"

composite_rules:
  # Terminal hiding with shell execution
  - id: hidden-terminal-exec
    desc: "Hidden Terminal with shell execution"
    crit: suspicious
    conf: 0.95
    attack: "T1564.003"
    for: [applescript]
    all:
      - { id: terminal-hide }
      - { id: exec/command/shell-execution }

  # Window hiding with credential access
  - id: hidden-cred-access
    desc: "Hidden AppleScript credential access"
    crit: suspicious
    conf: 0.95
    attack: "T1564.003"
    for: [applescript]
    all:
      - { id: terminal-hide }
    any:
      - { id: cred/phishing/hidden-answer }
      - { id: cred/macos/validation/dscl-authonly }
