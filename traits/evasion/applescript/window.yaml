# AppleScript Window Manipulation Evasion
# Detects hiding of windows to evade user awareness
# ATT&CK: T1564.003 (Hidden Window)

defaults:
  attack: "T1564.003"
  platforms: [macos]
  file_types: [applescript, shell]

traits:
  # Hide Terminal window
  - id: terminal-hide
    description: "Hide Terminal window via AppleScript"
    criticality: suspicious
    confidence: 0.9
    condition:
      type: string
      regex: "(?i)tell.*Terminal.*set visible.*false|Terminal.*visible.*false"

  # Hide any window
  - id: window-hide
    description: "Hide application window"
    criticality: notable
    confidence: 0.8
    condition:
      type: string
      regex: "set visible.*to false|set visible of.*window.*false"

  # Minimize window
  - id: window-minimize
    description: "Minimize application window"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "set miniaturized.*true|set collapsed.*true"

  # Hide entire application
  - id: app-hide
    description: "Hide entire application"
    criticality: notable
    confidence: 0.75
    condition:
      type: string
      regex: "set visible of.*application.*false|tell application.*to hide"

  # Set frontmost to false (push to back)
  - id: frontmost-false
    description: "Push application to background"
    criticality: notable
    confidence: 0.7
    condition:
      type: string
      regex: "set frontmost.*false"

composite_rules:
  # Terminal hiding with shell execution
  - id: hidden-terminal-exec
    description: "Hidden Terminal with shell execution"
    criticality: hostile
    confidence: 0.95
    attack: "T1564.003"
    file_types: [applescript]
    requires_all:
      - {id: terminal-hide}
      - {id: exec/command/shell-execution}

  # Window hiding with credential access
  - id: hidden-cred-access
    description: "Hidden window during credential access"
    criticality: hostile
    confidence: 0.95
    attack: "T1564.003"
    file_types: [applescript]
    requires_all:
      - {id: terminal-hide}
    requires_any:
      - {id: cred/phishing/hidden-answer}
      - {id: cred/macos/validation/dscl-authonly}
