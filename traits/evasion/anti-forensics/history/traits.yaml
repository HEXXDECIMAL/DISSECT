# Anti-Forensics: Shell History Clearing
# MBC: F0005 (Indicator Blocking)
# ATT&CK: T1070.003 (Clear Command History)

traits:
  # Bash history file clearing
  - id: histfile-null
    desc: Redirects shell history to /dev/null
    crit: suspicious
    conf: 0.9
    mbc: "F0005"
    attack: "T1070.003"
    if:
      type: yara
      source: |
        rule histfile_null {
          strings:
            $bash_hist = "HISTFILE=/dev/null" ascii nocase
            $hist_export = "export HISTFILE=" ascii
            $hist_unset = "unset HISTFILE" ascii
            $histsize_zero = "HISTSIZE=0" ascii
            $histfilesize = "HISTFILESIZE=0" ascii
          condition:
            any of them
        }

  # MySQL history clearing
  - id: mysql-histfile-null
    desc: Clears MySQL command history
    crit: suspicious
    conf: 0.9
    mbc: "F0005"
    attack: "T1070.003"
    if:
      type: yara
      source: |
        rule mysql_histfile_null {
          strings:
            $mysql_hist = "MYSQL_HISTFILE=/dev/null" ascii nocase
            $mysql_export = "export MYSQL_HISTFILE=" ascii
          condition:
            any of them
        }

  # Prompt command clearing (prevents logging)
  - id: prompt-command-unset
    desc: Unsets PROMPT_COMMAND to evade logging
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    attack: "T1070.003"
    if:
      type: yara
      source: |
        rule prompt_command_unset {
          strings:
            $unset = "unset PROMPT_COMMAND" ascii
            $export_empty = "PROMPT_COMMAND=''" ascii
            $export_null = "PROMPT_COMMAND=" ascii
          condition:
            any of them
        }

  # Terminal setup for backdoor shell
  - id: term-setup
    desc: Sets TERM variable (backdoor shell setup)
    crit: notable
    conf: 0.7
    if:
      type: yara
      source: |
        rule term_setup {
          strings:
            $term_vt100 = "export TERM=vt100" ascii
            $term_xterm = "export TERM=xterm" ascii
            $term_linux = "export TERM=linux" ascii
          condition:
            any of them
        }

composite_rules:
  # BPFDoor-style anti-forensics setup
  - id: backdoor-shell-setup
    desc: Multiple anti-forensics techniques (backdoor indicator)
    crit: hostile
    conf: 0.95
    attack: "T1070.003"
    for: [shell, elf]
    any:
      - id: evasion/anti-forensics/histfile-null
      - id: evasion/anti-forensics/mysql-histfile-null
      - id: evasion/anti-forensics/term-setup
    all:
      - id: evasion/anti-forensics/prompt-command-unset
