# Cryptographic Capabilities
# Covers hashing, encryption, decryption, key generation, etc.

simple_rules:
  # Hashing - MD5
  - symbol: MD5
    capability: crypto/hash/md5
    description: MD5 hashing
    confidence: 1.0

  - symbol: MD5_Init
    capability: crypto/hash/md5
    description: MD5 hashing (init)
    confidence: 1.0

  - symbol: CC_MD5
    capability: crypto/hash/md5
    description: MD5 hashing (CommonCrypto)
    confidence: 1.0
    platforms: [macos, ios]

  # Hashing - SHA family
  - symbol: SHA1
    capability: crypto/hash/sha1
    description: SHA-1 hashing
    confidence: 1.0

  - symbol: SHA1_Init
    capability: crypto/hash/sha1
    description: SHA-1 hashing (init)
    confidence: 1.0

  - symbol: CC_SHA1
    capability: crypto/hash/sha1
    description: SHA-1 hashing (CommonCrypto)
    confidence: 1.0
    platforms: [macos, ios]

  - symbol: SHA256
    capability: crypto/hash/sha256
    description: SHA-256 hashing
    confidence: 1.0

  - symbol: SHA256_Init
    capability: crypto/hash/sha256
    description: SHA-256 hashing (init)
    confidence: 1.0

  - symbol: CC_SHA256
    capability: crypto/hash/sha256
    description: SHA-256 hashing (CommonCrypto)
    confidence: 1.0
    platforms: [macos, ios]

  - symbol: SHA512
    capability: crypto/hash/sha512
    description: SHA-512 hashing
    confidence: 1.0

  - symbol: SHA512_Init
    capability: crypto/hash/sha512
    description: SHA-512 hashing (init)
    confidence: 1.0

  # Encryption - AES
  - symbol: AES_encrypt
    capability: crypto/encrypt/aes
    description: AES encryption
    confidence: 1.0

  - symbol: AES_decrypt
    capability: crypto/decrypt/aes
    description: AES decryption
    confidence: 1.0

  - symbol: AES_set_encrypt_key
    capability: crypto/encrypt/aes
    description: Set AES encryption key
    confidence: 1.0

  - symbol: AES_set_decrypt_key
    capability: crypto/decrypt/aes
    description: Set AES decryption key
    confidence: 1.0

  # Generic crypto (macOS/iOS)
  - symbol: CCCrypt
    capability: crypto/cipher
    description: Generic encryption/decryption (CommonCrypto)
    confidence: 0.9
    platforms: [macos, ios]

  - symbol: CCCryptorCreate
    capability: crypto/cipher
    description: Create crypto context (CommonCrypto)
    confidence: 0.9
    platforms: [macos, ios]

  # Encryption - RSA
  - symbol: RSA_public_encrypt
    capability: crypto/encrypt/rsa
    description: RSA public key encryption
    confidence: 1.0

  - symbol: RSA_private_decrypt
    capability: crypto/decrypt/rsa
    description: RSA private key decryption
    confidence: 1.0

  - symbol: RSA_sign
    capability: crypto/sign/rsa
    description: RSA signature
    confidence: 1.0

  - symbol: RSA_verify
    capability: crypto/verify/rsa
    description: RSA signature verification
    confidence: 1.0

  # Random number generation
  - symbol: arc4random
    capability: crypto/random
    description: Cryptographically secure random
    confidence: 1.0
    platforms: [macos, ios, unix]

  - symbol: arc4random_buf
    capability: crypto/random
    description: Cryptographically secure random buffer
    confidence: 1.0
    platforms: [macos, ios, unix]

  - symbol: SecRandomCopyBytes
    capability: crypto/random
    description: Secure random bytes (macOS)
    confidence: 1.0
    platforms: [macos, ios]

  - symbol: RAND_bytes
    capability: crypto/random
    description: Random bytes (OpenSSL)
    confidence: 1.0

  - symbol: CryptGenRandom
    capability: crypto/random
    description: Cryptographic random (Windows)
    confidence: 1.0
    platforms: [windows]

composite_rules:
  # Ransomware encryption pattern
  - capability: crypto/ransomware/encrypt
    description: Ransomware-style file encryption
    confidence: 0.9
    platforms: [all]

    requires_all:
      # Strong encryption
      - type: symbol_or_string
        any:
          - AES_encrypt
          - CCCrypt
          - CryptEncrypt
          - EVP_EncryptInit

      # File iteration
      - type: symbol_or_string
        any:
          - opendir
          - readdir
          - FindFirstFile
          - FindNextFile

      # File writing
      - type: symbol
        pattern: 'fwrite|write|WriteFile'

      # Ransom-related strings
      - type: string
        regex: '(decrypt|ransom|bitcoin|payment|recover|key)'
        case_insensitive: true

  # Weak crypto usage (security issue)
  - capability: crypto/weak/md5-password
    description: Weak crypto - MD5 for passwords
    confidence: 0.85
    platforms: [all]

    requires_all:
      # MD5 usage
      - type: symbol_or_string
        any:
          - MD5
          - MD5_Init
          - CC_MD5

      # Password-related strings
      - type: string
        regex: '(password|passwd|pwd|credential|auth)'
        case_insensitive: true

  # Custom crypto implementation (often weak)
  - capability: crypto/custom/implementation
    description: Custom cryptographic implementation
    confidence: 0.8
    platforms: [all]

    requires_count: 3
    conditions:
      # XOR operations (common in custom crypto)
      - type: yara_match
        namespace: crypto

      # Bit manipulation
      - type: yara_match
        namespace: anti-static.obfuscation

      # No standard crypto imports
      - type: imports_count
        max: 5
        filter: '(AES|SHA|MD5|RSA|CCCrypt|Crypt)'

      # High entropy
      - type: structure
        feature: entropy/high

  # Key derivation
  - capability: crypto/key/derivation
    description: Cryptographic key derivation
    confidence: 0.9
    platforms: [all]

    requires_any:
      # PBKDF2
      - type: symbol_or_string
        any:
          - PBKDF2
          - CCKeyDerivationPBKDF
          - CryptDeriveKey

      # Scrypt
      - type: symbol_or_string
        any:
          - scrypt
          - crypto_scrypt

      # Argon2
      - type: string
        regex: 'argon2'

  # Certificate operations
  - capability: crypto/certificate/operations
    description: X.509 certificate operations
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Certificate functions
      - type: symbol_or_string
        any:
          - X509_
          - SecCertificate
          - CertOpenStore
          - CertGetCertificateChain

      # Certificate strings
      - type: string
        regex: '(-----BEGIN CERTIFICATE|X509|PKCS|PEM)'

  # Cryptocurrency operations
  - capability: crypto/cryptocurrency
    description: Cryptocurrency operations
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Crypto addresses
      - type: string
        regex: '(bitcoin|ethereum|monero|ripple|litecoin|btc|eth|xmr)'
        case_insensitive: true

      # Address patterns
      - type: string
        regex: '(\b[13][a-km-zA-HJ-NP-Z1-9]{25,34}\b|0x[a-fA-F0-9]{40})'

      # SHA-256 (used in Bitcoin)
      - type: symbol_or_string
        any:
          - SHA256
          - RIPEMD160

      # Wallet strings
      - type: string
        regex: '(wallet|address|private.*key|mnemonic|seed)'
        case_insensitive: true

  # Secure delete (crypto wipe)
  - capability: crypto/secure-delete
    description: Cryptographically secure file deletion
    confidence: 0.85
    platforms: [all]

    requires_all:
      # Random data source
      - type: symbol_or_string
        any:
          - RAND_bytes
          - arc4random
          - /dev/urandom
          - SecRandomCopyBytes
          - CryptGenRandom

      # File write operations
      - type: symbol
        pattern: 'fwrite|write|WriteFile'

      # File deletion
      - type: symbol_or_string
        any:
          - unlink
          - remove
          - DeleteFile

  # Base64 encoding with crypto
  - capability: crypto/encoding/base64-crypto
    description: Base64 encoding with crypto operations
    confidence: 0.8
    platforms: [all]

    requires_all:
      # Base64
      - type: symbol_or_string
        any:
          - base64
          - EVP_EncodeBlock
          - EVP_DecodeBlock
          - CCCrypt

      # Encryption
      - type: symbol_or_string
        any:
          - AES_
          - CCCrypt
          - CryptEncrypt
          - EVP_Encrypt

  # Steganography
  - capability: crypto/steganography
    description: Steganography (hide data in images/files)
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Image file handling
      - type: string
        regex: '\.(png|jpg|jpeg|bmp|gif|wav|mp3)'
        case_insensitive: true

      # Crypto operations
      - type: symbol_or_string
        any:
          - AES_encrypt
          - XOR
          - CCCrypt

      # LSB or pixel manipulation
      - type: yara_match
        namespace: crypto

  # Password-based encryption
  - capability: crypto/password/encrypt
    description: Password-based encryption
    confidence: 0.85
    platforms: [all]

    requires_count: 2
    conditions:
      # Password strings
      - type: string
        regex: '(password|passphrase|enter.*key)'
        case_insensitive: true

      # Key derivation
      - type: symbol_or_string
        any:
          - PBKDF2
          - CCKeyDerivationPBKDF
          - scrypt
          - argon2

      # Encryption
      - type: symbol_or_string
        any:
          - AES_
          - CCCrypt
          - EVP_Encrypt

  # Hardware crypto (TPM/Secure Enclave)
  - capability: crypto/hardware/tpm
    description: Hardware-backed cryptography
    confidence: 0.9
    platforms: [all]

    requires_any:
      # macOS Secure Enclave
      - type: symbol_or_string
        any:
          - SecKeyCreateRandomKey
          - kSecAttrTokenIDSecureEnclave

      # Windows TPM
      - type: symbol_or_string
        any:
          - Tbsi_
          - Tpm_
          - NCryptOpenStorageProvider

      # Linux TPM
      - type: string
        regex: '/dev/tpm|tpm2_'

  # ChaCha20/Poly1305 (modern crypto)
  - capability: crypto/modern/chacha20
    description: Modern ChaCha20/Poly1305 encryption
    confidence: 0.95
    platforms: [all]

    requires_any:
      - type: symbol_or_string
        any:
          - chacha20
          - ChaCha20
          - poly1305
          - Poly1305

  # Elliptic curve crypto
  - capability: crypto/ecc
    description: Elliptic curve cryptography
    confidence: 0.9
    platforms: [all]

    requires_any:
      # ECC symbols
      - type: symbol_or_string
        any:
          - EC_KEY_new
          - ECDSA_sign
          - ECDH_compute_key
          - SecKeyCreateWithData

      # Curve names
      - type: string
        regex: '(secp256|prime256|curve25519|ed25519|P-256|P-384)'

  # Homomorphic encryption (rare, advanced)
  - capability: crypto/advanced/homomorphic
    description: Homomorphic encryption
    confidence: 0.95
    platforms: [all]

    requires_any:
      - type: string
        regex: '(homomorphic|HElib|SEAL|PALISADE|lattice)'
        case_insensitive: true

  # Zero-knowledge proofs
  - capability: crypto/advanced/zkp
    description: Zero-knowledge proof systems
    confidence: 0.95
    platforms: [all]

    requires_any:
      - type: string
        regex: '(zk-SNARK|zkSNARK|zero.*knowledge|bellman|groth16)'
        case_insensitive: true
