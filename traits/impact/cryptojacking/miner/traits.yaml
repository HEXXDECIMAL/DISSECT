# Impact - Cryptojacking / Cryptocurrency Mining
# ATT&CK: T1496 (Resource Hijacking)
# MBC: B0036 (Cryptomining)

traits:
  # === Atomic: Mining Protocols ===

  - id: stratum-protocol
    description: Stratum mining protocol reference
    criticality: suspicious
    confidence: 0.85
    attack: "T1496"
    condition:
      type: string
      regex: "stratum(\\+(tcp|ssl|tls))?://"

  # === Atomic: Mining Pools ===

  - id: pool-c3pool
    description: C3Pool mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "c3pool"

  - id: pool-f2pool
    description: F2Pool mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "f2pool"

  - id: pool-hashvault
    description: HashVault mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "hashvault"

  - id: pool-monerohash
    description: MoneroHash mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "monerohash"

  - id: pool-xmrpool
    description: XMRPool mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "xmrpool"

  - id: pool-supportxmr
    description: SupportXMR mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "supportxmr"

  - id: pool-minergate
    description: MinerGate mining pool
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "minergate"

  - id: pool-generic
    description: Generic mining pool reference
    criticality: suspicious
    confidence: 0.7
    attack: "T1496"
    condition:
      type: string
      regex: "crypto-pool|moneropool"

  # === Atomic: Mining Software ===

  - id: xmrig-ref
    description: XMRig miner reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: string
      exact: "xmrig"
      case_insensitive: true

  - id: cryptonight
    description: CryptoNight algorithm reference
    criticality: suspicious
    confidence: 0.85
    attack: "T1496"
    condition:
      type: string
      regex: "[Cc]rypto[Nn]ight"

  - id: monero-ref
    description: Monero cryptocurrency reference
    criticality: notable
    confidence: 0.6
    attack: "T1496"
    condition:
      type: string
      regex: "\\b[Mm]onero\\b|\\bMONERO\\b|\\bXMR\\b"

  # === Atomic: Mining Configuration ===

  - id: donate-level
    description: Mining donate-level configuration
    criticality: suspicious
    confidence: 0.85
    attack: "T1496"
    condition:
      type: string
      exact: "--donate-level"

  - id: tls-fingerprint
    description: Mining TLS fingerprint option
    criticality: suspicious
    confidence: 0.8
    attack: "T1496"
    condition:
      type: string
      exact: "--tls-fingerprint"

  - id: miner-name
    description: Miner name configuration
    criticality: suspicious
    confidence: 0.75
    attack: "T1496"
    condition:
      type: string
      exact: "miner_name"

  - id: miner-url
    description: Miner URL configuration
    criticality: suspicious
    confidence: 0.75
    attack: "T1496"
    condition:
      type: string
      exact: "miner_url"

  - id: normal-hashing
    description: Normal hashing configuration
    criticality: suspicious
    confidence: 0.8
    attack: "T1496"
    condition:
      type: string
      exact: "\"normalHashing\": true,"

  # === Atomic: Memory Optimization ===

  - id: hugepages
    description: Huge pages memory configuration
    criticality: suspicious
    confidence: 0.7
    attack: "T1496"
    file_types: [elf]
    condition:
      type: string
      exact: "vm.nr_hugepages"

  - id: nmi-watchdog
    description: NMI watchdog disable (mining optimization)
    criticality: suspicious
    confidence: 0.75
    attack: "T1496"
    file_types: [elf]
    condition:
      type: string
      exact: "kernel.nmi_watchdog"

  # === Atomic: Argon2 (Memory-Hard) ===

  - id: argon2d
    description: Argon2d hashing algorithm
    criticality: suspicious
    confidence: 0.7
    attack: "T1496"
    condition:
      type: string
      exact: "argon2d"

composite_rules:
  - id: cryptocurrency-miner
    description: Cryptocurrency miner detected
    criticality: suspicious
    confidence: 0.95
    attack: "T1496"
    mbc: "B0036"
    requires_count: 2
    conditions:
      - type: trait
        id: stratum-protocol
      - type: trait
        id: pool-c3pool
      - type: trait
        id: pool-f2pool
      - type: trait
        id: pool-hashvault
      - type: trait
        id: pool-monerohash
      - type: trait
        id: pool-xmrpool
      - type: trait
        id: pool-supportxmr
      - type: trait
        id: pool-minergate
      - type: trait
        id: xmrig-ref
      - type: trait
        id: cryptonight
      - type: trait
        id: donate-level
      - type: trait
        id: miner-name

  - id: memory-optimized-miner
    description: Memory-optimized cryptocurrency miner
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    mbc: "B0036"
    file_types: [elf]
    requires_all:
      - type: trait
        id: hugepages
    requires_any:
      - type: trait
        id: xmrig-ref
      - type: trait
        id: monero-ref
      - type: string
        exact: "wallet"

  - id: argon2-miner
    description: Argon2-based cryptocurrency miner
    criticality: suspicious
    confidence: 0.85
    attack: "T1496"
    mbc: "B0036"
    file_types: [elf]
    requires_all:
      - type: trait
        id: argon2d
      - type: string
        exact: "/proc/self"
      - type: string
        exact: "NUMA"
