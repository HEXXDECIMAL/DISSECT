# Impact - Cryptojacking / Cryptocurrency Mining
# ATT&CK: T1496 (Resource Hijacking)
# MBC: B0036 (Cryptomining)

traits:
  # === Atomic: Mining Protocols ===

  - id: stratum-protocol
    description: Stratum mining protocol reference
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      regex: "stratum(\\+(tcp|ssl|tls))?://"

  # === Atomic: Mining Pools ===

  - id: pool-c3pool
    description: C3Pool mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "c3pool"

  - id: pool-f2pool
    description: F2Pool mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "f2pool"

  - id: pool-hashvault
    description: HashVault mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "hashvault"

  - id: pool-monerohash
    description: MoneroHash mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "monerohash"

  - id: pool-xmrpool
    description: XMRPool mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "xmrpool"

  - id: pool-supportxmr
    description: SupportXMR mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "supportxmr"

  - id: pool-minergate
    description: MinerGate mining pool
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "minergate"

  - id: pool-crypto-pool
    description: Crypto-pool mining pool
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      exact: "crypto-pool"

  - id: pool-moneropool
    description: Moneropool mining pool
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      exact: "moneropool"

  # === Atomic: Mining Software ===

  - id: xmrig-ref
    description: XMRig miner reference
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    if:
      type: string
      exact: "xmrig"
      case_insensitive: true

  - id: cryptonight
    description: CryptoNight algorithm reference
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      regex: "[Cc]rypto[Nn]ight"

  - id: monero-lower
    description: monero word (lowercase)
    crit: inert
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "monero"

  - id: monero-title
    description: Monero word (title case)
    crit: inert
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "Monero"

  - id: monero-upper
    description: MONERO word (uppercase)
    crit: inert
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "MONERO"

  - id: xmr-ticker
    description: XMR ticker symbol
    crit: inert
    conf: 0.5
    attack: "T1496"
    if:
      type: string
      word: "XMR"

  # === Atomic: Mining Configuration ===

  - id: donate-level
    description: Mining donate-level configuration
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      exact: "--donate-level"

  - id: tls-fingerprint
    description: Mining TLS fingerprint option
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    if:
      type: string
      exact: "--tls-fingerprint"

  - id: miner-name
    description: Miner name configuration
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    if:
      type: string
      exact: "miner_name"

  - id: miner-url
    description: Miner URL configuration
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    if:
      type: string
      exact: "miner_url"

  - id: normal-hashing
    description: Normal hashing configuration
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    if:
      type: string
      exact: '"normalHashing": true,'

  # === Atomic: Memory Optimization ===

  - id: hugepages
    description: Huge pages memory configuration
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    for: [elf]
    if:
      type: string
      exact: "vm.nr_hugepages"

  - id: nmi-watchdog
    description: NMI watchdog disable (mining optimization)
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    for: [elf]
    if:
      type: string
      exact: "kernel.nmi_watchdog"

  # === Atomic: Argon2 (Memory-Hard) ===

  - id: argon2d
    description: Argon2d hashing algorithm
    crit: suspicious
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      exact: "argon2d"

  # === Atomic: Mining Indicators ===

  # NOTE: "wallet" is too generic - appears in many legitimate contexts.
  # Only meaningful with other mining indicators.
  - id: wallet-ref
    description: Wallet reference (mining context)
    crit: inert
    conf: 0.3
    attack: "T1496"
    if:
      type: string
      exact: "wallet"

  # NOTE: Go runtime uses /proc/self legitimately for memory management
  # Moved to inert - only meaningful with other mining indicators
  - id: proc-self-ref
    description: Process self reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "/proc/self"

  # NOTE: "NUMA" can appear in Go and other runtimes for memory optimization.
  # Only meaningful with other mining indicators.
  - id: numa-ref
    description: NUMA memory architecture reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "NUMA"

composite_rules:
  # Monero reference composite
  - id: monero-ref
    description: Monero cryptocurrency reference
    crit: notable
    conf: 0.6
    attack: "T1496"
    count_min: 1
    any:
      - id: monero-lower
      - id: monero-title
      - id: monero-upper
      - id: xmr-ticker

  - id: cryptocurrency-miner
    description: Cryptocurrency miner detected
    crit: suspicious
    conf: 0.95
    attack: "T1496"
    mbc: "B0036"
    count_min: 2
    any:
      - id: stratum-protocol
      - id: pool-c3pool
      - id: pool-f2pool
      - id: pool-hashvault
      - id: pool-monerohash
      - id: pool-xmrpool
      - id: pool-supportxmr
      - id: pool-minergate
      - id: pool-crypto-pool
      - id: pool-moneropool
      - id: xmrig-ref
      - id: cryptonight
      - id: donate-level
      - id: miner-name

  - id: memory-optimized-miner
    description: Memory-optimized cryptocurrency miner
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    mbc: "B0036"
    for: [elf]
    all:
      - id: hugepages
    any:
      - id: xmrig-ref
      - id: monero-ref
      - id: wallet-ref

  - id: argon2-miner
    description: Argon2-based cryptocurrency miner
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    mbc: "B0036"
    for: [elf]
    all:
      - id: argon2d
      - id: proc-self-ref
      - id: numa-ref
