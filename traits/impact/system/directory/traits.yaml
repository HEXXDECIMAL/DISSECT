# System Directory Destructive Operations
# Detects targeting of critical system directories for destructive purposes
# ATT&CK: T1485 (Data Destruction), T1561 (Disk Wipe)

defaults:
  attack: "T1485"
  criticality: suspicious

traits:
  # Windows System32 deletion
  - id: windows-system32-delete
    description: "Windows System32 directory deletion"
    confidence: 0.95
    platforms: [windows]
    condition:
      type: string
      regex: "(rmdir|del|remove|shutil\\.rmtree|os\\.remove).*[Ss]ystem32|[Ss]ystem32.*(rmdir|del|remove)"

  # Windows directory recursive deletion
  - id: windows-recursive-delete
    description: "Windows system directory recursive deletion"
    confidence: 0.9
    platforms: [windows]
    condition:
      type: string
      regex: "rd\\s+/s|rmdir\\s+/s.*Windows|del\\s+/f\\s+/q.*Windows"

  # Linux critical directory targeting
  - id: linux-etc-delete
    description: "Linux /etc directory deletion attempt"
    confidence: 0.95
    platforms: [linux]
    condition:
      type: string
      regex: "rm\\s+-rf\\s+/etc|shutil\\.rmtree.*[\"']/etc"

  # Linux /usr directory targeting (binaries/libs)
  - id: linux-usr-delete
    description: "Linux /usr directory deletion attempt"
    confidence: 0.95
    platforms: [linux]
    condition:
      type: string
      regex: "rm\\s+-rf\\s+/usr|shutil\\.rmtree.*[\"']/usr"

  # Linux boot directory targeting
  - id: linux-boot-delete
    description: "Linux /boot directory deletion attempt"
    confidence: 0.95
    platforms: [linux]
    condition:
      type: string
      regex: "rm\\s+-rf\\s+/boot|shutil\\.rmtree.*[\"']/boot"

  # Root filesystem wipe
  - id: root-wipe
    description: "Root filesystem wipe attempt"
    confidence: 0.95
    attack: "T1561"
    condition:
      type: string
      regex: "rm\\s+-rf\\s+/\\s|rm\\s+-rf\\s+/\\*|shutil\\.rmtree.*[\"']/[\"']"

  # macOS system directory targeting
  - id: macos-system-delete
    description: "macOS system directory deletion"
    confidence: 0.95
    platforms: [macos]
    condition:
      type: string
      regex: "rm\\s+-rf.*(/System|/Library/System)|shutil\\.rmtree.*/System"

  # MBR/Boot sector targeting
  - id: mbr-target
    description: "MBR/Boot sector targeting"
    confidence: 0.95
    attack: "T1561.002"
    condition:
      type: string
      regex: "/dev/sda|/dev/hda|PhysicalDrive0|\\\\\\\\\\\\.\\\\PhysicalDrive"

  # Recursive deletion command
  - id: recursive-delete-cmd
    description: "Recursive deletion command pattern"
    criticality: notable
    confidence: 0.8
    condition:
      type: string
      regex: "rmtree|rm\\s+-rf|rmdir.*(/s|/q)"

  # Iteration/loop pattern
  - id: iteration-loop-pattern
    description: "Iteration or loop pattern for file operations"
    criticality: notable
    confidence: 0.8
    condition:
      type: string
      regex: "for\\s|while\\s|os\\.walk|glob\\."

  # System directory reference
  - id: system-dir-reference
    description: "Reference to critical system directories"
    criticality: notable
    confidence: 0.8
    condition:
      type: string
      regex: "Windows|System32|/etc|/boot|/usr"

composite_rules:
  # System destruction with iteration
  - id: mass-deletion
    description: "Mass system file deletion"
    confidence: 0.95
    requires_all:
      - type: trait
        id: recursive-delete-cmd
      - type: trait
        id: iteration-loop-pattern
      - type: trait
        id: system-dir-reference
