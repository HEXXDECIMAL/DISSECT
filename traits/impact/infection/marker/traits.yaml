# Impact - Infection Markers
# ATT&CK: T1204 (User Execution)

traits:
  - id: infected-marker
    description: References being infected
    criticality: suspicious
    confidence: 0.7
    attack: "T1204"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)\\binfected\\b"

  - id: infection-marker
    description: References infection
    criticality: suspicious
    confidence: 0.7
    attack: "T1204"
    file_types: [all]
    condition:
      type: string
      exact: "infection"

  - id: infected-with
    description: Infection notification pattern
    criticality: suspicious
    confidence: 0.9
    attack: "T1204"
    file_types: [all]
    condition:
      type: string
      regex: ".{3,16} infected with .{3,16}"

  - id: virus-marker
    description: Virus reference
    criticality: suspicious
    confidence: 0.7
    attack: "T1204"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)\\bvirus\\b"

  - id: worm-marker
    description: Worm reference
    criticality: suspicious
    confidence: 0.7
    attack: "T1204"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)\\bworm\\b"

  - id: trojan-marker
    description: Trojan reference
    criticality: suspicious
    confidence: 0.7
    attack: "T1204"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)\\btrojan\\b"

composite_rules:
  # NOTE: Simple libc function references are too common in statically linked binaries
  # Require explicit infection markers or embedded ELF payloads at non-zero offset
  - id: elf-infector-detected
    description: ELF file infector
    criticality: suspicious
    confidence: 0.95
    attack: "T1204"
    mbc: "B0009"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule elf_infector {
          strings:
            // Infection-specific strings (required)
            $infect = "infect" nocase
            $payload = "payload" fullword
            $virus = "virus" nocase
            $parasite = "parasite" nocase
            $inject_elf = "inject" fullword
            // Embedded ELF magic at non-zero offset indicates payload
            $embedded_elf = { 7F 45 4C 46 }
            // Common file-scanning patterns in infectors
            $scan_elf = /scan.{0,10}elf/i
            $find_target = /find.{0,10}target/i
          condition:
            uint32(0) == 0x464C457F and
            filesize < 1MB and
            (
              // Explicit infection terminology
              any of ($infect, $virus, $parasite, $scan_elf, $find_target) or
              // Embedded ELF payload (not at offset 0)
              ($embedded_elf and @embedded_elf[1] > 512)
            )
        }

  - id: infected-xor-detected
    description: XOR obfuscated infection marker
    criticality: suspicious
    confidence: 0.95
    attack: "T1027"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule infected_xor {
          strings:
            $infected_x = "infected" xor(1-255)
            $INFECTED_x = "INFECTED" xor(1-255)
          condition:
            filesize < 5MB and any of them
        }
