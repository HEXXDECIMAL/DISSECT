# Root Privilege Escalation Traits
# Detects behavioral and structural patterns for becoming root

traits:
  # Become Root Pattern (AST Structural)
  - id: credential-manipulation
    description: Structural pattern of resetting multiple credential fields to 0 (root)
    crit: suspicious
    conf: 0.99
    attack: "T1068"
    for: [c]
    platforms: [linux]
    if:
      type: ast_query
      language: c
      query: |
        (assignment_expression
          left: (field_expression
            field: (field_identifier) @field)
          right: (number_literal) @val
          (#eq? @val "0")
          (#match? @field "^(uid|gid|euid|egid|suid|sgid|fsuid|fsgid|val)$"))

  - id: prepare-creds-string
    description: "Reference to prepare_creds kernel function for credential preparation"
    crit: notable
    conf: 0.8
    for: [c]
    platforms: [linux]
    if:
      type: string
      exact: "prepare_creds"

composite_rules:
  # Dummy Test Rule
  - id: test-dummy-rule
    description: "Dummy test rule for validation"
    crit: suspicious
    conf: 1.0
    requires_all:
      - id: impact/root/prepare-creds-string

  # Become Root Flow
  - id: my-become-root
    description: Complete 'become root' flow (prepare_creds -> set to 0 -> commit_creds)
    crit: suspicious
    conf: 1.0
    attack: "T1068"
    requires_all:
      - id: impact/root/prepare-creds-string
      - id: kernel/rootkit/prepare-creds-call
      - id: kernel/rootkit/commit-creds-call
      - id: impact/root/credential-manipulation
