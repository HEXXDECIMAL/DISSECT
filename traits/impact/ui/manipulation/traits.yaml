# Impact - UI Manipulation
# ATT&CK: T1491 (Defacement)

traits:
  - id: dock-hide
    description: macOS dock hiding
    criticality: suspicious
    confidence: 0.9
    attack: "T1564.003"
    file_types: [macho]
    condition:
      type: string
      regex: "(?i)(hideDock|applicationWillHide)"

  - id: screencapture
    description: macOS screencapture command
    criticality: suspicious
    confidence: 0.85
    attack: "T1113"
    file_types: [macho, shell]
    condition:
      type: string
      exact: "screencapture"

  - id: pil-imagegrab
    description: Python PIL screenshot capture
    criticality: suspicious
    confidence: 0.85
    attack: "T1113"
    file_types: [python]
    condition:
      type: string
      exact: "ImageGrab"

  - id: cg-window-capture
    description: macOS CGWindow capture
    criticality: suspicious
    confidence: 0.85
    attack: "T1113"
    file_types: [macho]
    condition:
      type: string
      exact: "CGWindowListCreateImageFromArray"

  - id: screensaver-engine
    description: macOS ScreenSaver control
    criticality: suspicious
    confidence: 0.8
    attack: "T1491"
    file_types: [macho, shell]
    condition:
      type: string
      exact: "ScreenSaverEngine"

  - id: system-events
    description: macOS System Events control
    criticality: suspicious
    confidence: 0.8
    attack: "T1059.002"
    file_types: [macho, shell]
    condition:
      type: string
      exact: "tell application \"System Events\""

  - id: window-watcher
    description: macOS window/application monitoring
    criticality: suspicious
    confidence: 0.9
    attack: "T1010"
    file_types: [macho]
    condition:
      type: string
      exact: "frontmostApplication"

  - id: screen-locked
    description: macOS screen lock detection
    criticality: suspicious
    confidence: 0.8
    attack: "T1010"
    file_types: [macho]
    condition:
      type: string
      exact: "CGSSessionScreenIsLocked"

  - id: x11-auth
    description: X11 authentication cookie
    criticality: suspicious
    confidence: 0.8
    attack: "T1056"
    file_types: [elf]
    condition:
      type: string
      exact: "MIT-MAGIC-COOKIE-1"

  - id: xsession
    description: Xsession reference
    criticality: suspicious
    confidence: 0.75
    attack: "T1056"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "Xsession"

  - id: hid-idle-time
    description: macOS HID idle time detection
    criticality: suspicious
    confidence: 0.8
    attack: "T1010"
    file_types: [macho]
    condition:
      type: string
      exact: "HIDIdleTime"

  - id: process-identifier
    description: macOS process identifier access
    criticality: notable
    confidence: 0.7
    attack: "T1010"
    file_types: [macho]
    condition:
      type: string
      exact: "processIdentifier"

composite_rules:
  - id: macos-spy-detected
    description: macOS UI spying
    criticality: suspicious
    confidence: 0.95
    attack: "T1010"
    mbc: "B0042"
    file_types: [macho]
    requires_any_n:
      count: 2
      conditions:
        - type: trait
          id: screen-locked
        - type: trait
          id: hid-idle-time
        - type: trait
          id: window-watcher
        - type: trait
          id: process-identifier
