# Impact - Service Manipulation
# ATT&CK: T1489 (Service Stop)

defaults:
  attack: "T1489"

traits:
  - id: esxcli
    description: VMware ESXi CLI usage
    criticality: suspicious
    confidence: 0.9
    file_types: [elf, shell]
    condition:
      type: string
      exact: "esxcli"

  - id: systemctl-stop
    description: Systemd service stop
    criticality: suspicious
    confidence: 0.8
    file_types: [elf, shell]
    condition:
      type: string
      regex: "systemctl\\s+stop"

  - id: service-stop
    description: SysV service stop
    criticality: suspicious
    confidence: 0.8
    file_types: [elf, shell]
    condition:
      type: string
      regex: "service\\s+\\w+\\s+stop"

  - id: sc-stop
    description: Windows service control stop
    criticality: suspicious
    confidence: 0.8
    file_types: [pe, shell]
    condition:
      type: string
      regex: "sc\\s+stop"

  - id: net-stop
    description: Windows net stop command
    criticality: suspicious
    confidence: 0.8
    file_types: [pe, shell]
    condition:
      type: string
      regex: "net\\s+stop"

  - id: vmsvc-getallvms
    description: VMware VM enumeration
    criticality: suspicious
    confidence: 0.9
    file_types: [elf, shell]
    condition:
      type: string
      exact: "vmsvc/getallvms"

  # === Database service termination (atomic) ===
  - id: kill-mysql
    description: MySQL service termination
    criticality: inert
    confidence: 0.6
    file_types: [all]
    condition:
      type: string
      regex: '(?i)(kill|stop).*mysql'

  - id: kill-postgres
    description: PostgreSQL service termination
    criticality: inert
    confidence: 0.6
    file_types: [all]
    condition:
      type: string
      regex: '(?i)(kill|stop).*postgres'

  - id: kill-oracle
    description: Oracle service termination
    criticality: inert
    confidence: 0.6
    file_types: [all]
    condition:
      type: string
      regex: '(?i)(kill|stop).*oracle'

  - id: kill-mssql
    description: MSSQL service termination
    criticality: inert
    confidence: 0.6
    file_types: [all]
    condition:
      type: string
      regex: '(?i)(kill|stop).*mssql'

  - id: kill-mongodb
    description: MongoDB service termination
    criticality: inert
    confidence: 0.6
    file_types: [all]
    condition:
      type: string
      regex: '(?i)(kill|stop).*mongodb'

  # === ESXi ransomware atomic indicators ===
  - id: onion-domain
    description: .onion domain reference
    criticality: inert
    confidence: 0.6
    file_types: [all]
    condition:
      type: string
      exact: ".onion"

  - id: word-encrypted
    description: Encrypted keyword
    criticality: inert
    confidence: 0.4
    file_types: [all]
    condition:
      type: string
      exact: encrypted
      case_insensitive: true

  - id: word-ransom
    description: Ransom keyword
    criticality: inert
    confidence: 0.5
    file_types: [all]
    condition:
      type: string
      exact: ransom
      case_insensitive: true

  - id: word-tor
    description: Tor keyword
    criticality: inert
    confidence: 0.4
    file_types: [all]
    condition:
      type: string
      exact: tor
      case_insensitive: true

  - id: word-bitcoin
    description: Bitcoin keyword
    criticality: inert
    confidence: 0.4
    file_types: [all]
    condition:
      type: string
      exact: bitcoin
      case_insensitive: true

  - id: word-victim
    description: Victim keyword
    criticality: inert
    confidence: 0.4
    file_types: [all]
    condition:
      type: string
      exact: victim
      case_insensitive: true

  - id: word-company
    description: Company keyword
    criticality: inert
    confidence: 0.3
    file_types: [all]
    condition:
      type: string
      exact: company

  - id: phrase-your-data
    description: Your data phrase
    criticality: inert
    confidence: 0.4
    file_types: [all]
    condition:
      type: string
      exact: "your data"

composite_rules:
  - id: kill-database
    description: Database service termination
    criticality: suspicious
    confidence: 0.9
    file_types: [all]
    requires_count: 1
    conditions:
      - id: kill-mysql
      - id: kill-postgres
      - id: kill-oracle
      - id: kill-mssql
      - id: kill-mongodb

  - id: esxi-ransomware
    description: VMware ESXi ransomware
    criticality: suspicious
    confidence: 0.99
    attack: "T1486"
    mbc: "B0040"
    file_types: [elf]
    requires_all:
      - id: esxcli
      - id: onion-domain
    requires_count: 1
    conditions:
      - id: word-encrypted
      - id: word-ransom
      - id: word-tor
      - id: word-bitcoin
      - id: word-victim
      - id: word-company
      - id: phrase-your-data
