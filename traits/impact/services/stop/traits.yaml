# Impact - Service Manipulation
# ATT&CK: T1489 (Service Stop)

defaults:
  attack: "T1489"
  # Service command strings can be embedded in any file type
  for: ["*"]

traits:
  - id: esxcli
    description: VMware ESXi CLI usage
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "esxcli"

  - id: systemctl-stop
    description: Systemd service stop
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "systemctl\\s+stop"

  - id: service-stop
    description: SysV service stop
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "service\\s+\\w+\\s+stop"

  - id: sc-stop
    description: Windows service control stop
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "sc\\s+stop"

  - id: net-stop
    description: Windows net stop command
    crit: suspicious
    conf: 0.8
    if:
      type: string
      regex: "net\\s+stop"

  - id: vmsvc-getallvms
    description: VMware VM enumeration
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "vmsvc/getallvms"

  # === Database service termination (atomic) ===
  - id: kill-mysql-kill
    description: MySQL kill command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)kill.{0,30}mysql"

  - id: kill-mysql-stop
    description: MySQL stop command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)stop.{0,30}mysql"

  - id: kill-postgres-kill
    description: PostgreSQL kill command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)kill.{0,30}postgres"

  - id: kill-postgres-stop
    description: PostgreSQL stop command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)stop.{0,30}postgres"

  - id: kill-oracle-kill
    description: Oracle kill command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)kill.{0,30}oracle"

  - id: kill-oracle-stop
    description: Oracle stop command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)stop.{0,30}oracle"

  - id: kill-mssql-kill
    description: MSSQL kill command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)kill.{0,30}mssql"

  - id: kill-mssql-stop
    description: MSSQL stop command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)stop.{0,30}mssql"

  - id: kill-mongodb-kill
    description: MongoDB kill command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)kill.{0,30}mongodb"

  - id: kill-mongodb-stop
    description: MongoDB stop command
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "(?i)stop.{0,30}mongodb"

  # === ESXi ransomware atomic indicators ===
  - id: onion-domain
    description: .onion domain reference
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: ".onion"

  - id: word-encrypted
    description: Encrypted keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: encrypted
      case_insensitive: true

  - id: word-ransom
    description: Ransom keyword
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: ransom
      case_insensitive: true

  - id: word-tor
    description: Tor keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: tor
      case_insensitive: true

  - id: word-bitcoin
    description: Bitcoin keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: bitcoin
      case_insensitive: true

  - id: word-victim
    description: Victim keyword
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: victim
      case_insensitive: true

  - id: word-company
    description: Company keyword
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: company

  - id: phrase-your-data
    description: Your data phrase
    crit: inert
    conf: 0.4
    if:
      type: string
      exact: "your data"

composite_rules:
  # Individual database kill composites
  - id: kill-mysql
    description: MySQL service termination
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: kill-mysql-kill
      - id: kill-mysql-stop

  - id: kill-postgres
    description: PostgreSQL service termination
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: kill-postgres-kill
      - id: kill-postgres-stop

  - id: kill-oracle
    description: Oracle service termination
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: kill-oracle-kill
      - id: kill-oracle-stop

  - id: kill-mssql
    description: MSSQL service termination
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: kill-mssql-kill
      - id: kill-mssql-stop

  - id: kill-mongodb
    description: MongoDB service termination
    crit: notable
    conf: 0.6
    requires_count: 1
    any:
      - id: kill-mongodb-kill
      - id: kill-mongodb-stop

  - id: kill-database
    description: Database service termination
    crit: suspicious
    conf: 0.9
    requires_count: 1
    any:
      - id: kill-mysql
      - id: kill-postgres
      - id: kill-oracle
      - id: kill-mssql
      - id: kill-mongodb

  - id: esxi-ransomware
    description: VMware ESXi ransomware
    crit: suspicious
    conf: 0.99
    attack: "T1486"
    mbc: "B0040"
    for: [elf]
    requires_all:
      - id: esxcli
      - id: onion-domain
    requires_count: 1
    any:
      - id: word-encrypted
      - id: word-ransom
      - id: word-tor
      - id: word-bitcoin
      - id: word-victim
      - id: word-company
      - id: phrase-your-data
