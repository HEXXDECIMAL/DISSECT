# Wiper/Destruction Patterns
# Detects patterns associated with destructive malware (wipers, protestware)
# ATT&CK: T1485 (Data Destruction), T1561 (Disk Wipe)

traits:
  # Recursive directory deletion (Node.js)
  - id: recursive-delete
    description: Recursive directory deletion function
    criticality: suspicious
    confidence: 0.85
    attack: "T1485"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule node_recursive_delete {
          strings:
            $readdir = "readdirSync" ascii
            $unlink = "unlinkSync" ascii
            $rmdir = "rmdirSync" ascii
            $rmrf = "rm -rf" ascii
            $rimraf = "rimraf" ascii
          condition:
            ($readdir and ($unlink or $rmdir)) or $rmrf or $rimraf
        }

  # Targets development directories
  - id: target-dev-dirs
    description: Targets development directories for deletion
    criticality: suspicious
    confidence: 0.9
    attack: "T1485"
    file_types: [javascript, typescript, python]
    condition:
      type: yara
      source: |
        rule target_dev_directories {
          strings:
            $dir1 = ".git" ascii
            $dir2 = ".svn" ascii
            $dir3 = "node_modules" ascii
            $dir4 = ".vscode" ascii
            $dir5 = "/src" ascii
            $dir6 = "/public" ascii
            $delete1 = "unlink" ascii
            $delete2 = "rmdir" ascii
            $delete3 = "rm -rf" ascii
            $delete4 = "rmtree" ascii
            $delete5 = "shutil.rmtree" ascii
          condition:
            3 of ($dir*) and any of ($delete*)
        }

  # Individual directory targeting
  - id: target-git
    description: Targets .git directory (version control)
    criticality: notable
    confidence: 0.85
    attack: "T1485"
    file_types: [javascript, typescript, python, shell]
    condition:
      type: string
      regex: '["'']\\./?\\.git["'']'

  - id: target-node-modules
    description: Targets node_modules directory
    criticality: notable
    confidence: 0.8
    attack: "T1485"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: '["'']/?(\\./)?node_modules["'']'

  - id: target-src
    description: Targets source code directory
    criticality: notable
    confidence: 0.85
    attack: "T1485"
    file_types: [javascript, typescript, python]
    condition:
      type: string
      regex: '["'']/?(\\./)?src["'']'

  - id: target-vscode
    description: Targets .vscode configuration directory
    criticality: notable
    confidence: 0.85
    attack: "T1485"
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: '["'']/?(\\./)?\\.(vscode|idea)["'']'

  # Conditional destruction based on environment
  - id: conditional-destroy
    description: Conditional destruction based on environment check
    criticality: suspicious
    confidence: 0.95
    attack: "T1485"
    file_types: [javascript, typescript]
    condition:
      type: yara
      source: |
        rule conditional_destruction {
          strings:
            $env_check = /process\.env\[[^\]]+\]\s*(!=|!==|==|===)/ ascii
            $node_env = "NODE_ENV" ascii
            $destroy1 = "unlinkSync" ascii
            $destroy2 = "rmdirSync" ascii
            $destroy3 = "rm -rf" ascii
          condition:
            ($env_check or $node_env) and any of ($destroy*)
        }

  # Android/mobile storage targeting
  - id: target-android-storage
    description: Targets Android storage directories
    criticality: suspicious
    confidence: 0.95
    attack: "T1485"
    file_types: [javascript, typescript, shell]
    condition:
      type: yara
      source: |
        rule target_android_storage {
          strings:
            $sdcard = "/sdcard" ascii
            $storage = "/storage/emulated" ascii
            $dcim = "DCIM" ascii
            $pictures = "Pictures" ascii
            $downloads = "Download" ascii
            $rm = "rm " ascii
            $rmrf = "rm -rf" ascii
            $spawn = "spawn(" ascii
          condition:
            ($sdcard or $storage) and any of ($dcim, $pictures, $downloads) and any of ($rm, $rmrf, $spawn)
        }

  # Mass file deletion
  - id: mass-delete
    description: Mass file deletion pattern
    criticality: suspicious
    confidence: 0.85
    attack: "T1485"
    file_types: [javascript, typescript, python, shell]
    condition:
      type: yara
      source: |
        rule mass_file_deletion {
          strings:
            $walk1 = "fs.readdirSync" ascii
            $walk2 = "os.walk" ascii
            $walk3 = "glob(" ascii
            $walk4 = "find ." ascii
            $delete1 = "unlinkSync" ascii
            $delete2 = "os.remove" ascii
            $delete3 = "os.unlink" ascii
            $delete4 = "-delete" ascii
            $delete5 = "rm -rf" ascii
          condition:
            any of ($walk*) and any of ($delete*)
        }

  # HTTP callback pattern (Node.js)
  - id: http-callback
    description: HTTP request pattern for callback/reporting
    criticality: notable
    confidence: 0.8
    file_types: [javascript, typescript]
    condition:
      type: string
      regex: "axios|fetch\\(|https\\.request|http\\.request"

composite_rules:
  # Protestware pattern (env-conditional destruction)
  - id: protestware
    description: Protestware pattern - conditional destruction based on location/env
    criticality: suspicious
    confidence: 0.98
    attack: "T1485"
    mbc: "B0031"
    file_types: [javascript, typescript]
    requires_all:
      - type: trait
        id: impact/wiper/conditional-destroy
      - type: trait
        id: impact/wiper/target-dev-dirs

  # Full wiper with HTTP callback (report success)
  - id: with-callback
    description: Wiper with HTTP callback (potential coordinated attack)
    criticality: suspicious
    confidence: 0.95
    attack: "T1485"
    mbc: "B0031"
    file_types: [javascript, typescript]
    requires_all:
      - type: trait
        id: impact/wiper/recursive-delete
      - type: trait
        id: impact/wiper/http-callback
