# Ransomware Detection Patterns
# ATT&CK: T1486 (Data Encrypted for Impact)
# Detects file encryption, key generation, and ransom note patterns

defaults:
  attack: "T1486"

traits:
  # === RSA key handling (atomic) ===
  - id: rsa-keyword
    description: RSA keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "RSA"

  - id: generate-keypair
    description: generateKeyPair function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "generateKeyPair"

  - id: public-encrypt
    description: publicEncrypt function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "publicEncrypt"

  - id: private-decrypt
    description: privateDecrypt function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "privateDecrypt"

  - id: begin-rsa-key
    description: BEGIN RSA key header
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "-----BEGIN RSA"

  - id: begin-public-key
    description: BEGIN PUBLIC KEY header
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "-----BEGIN PUBLIC KEY"

  - id: crypto-module
    description: crypto module
    crit: inert
    conf: 0.3
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "crypto"

  # === File iteration (atomic) ===
  - id: readdir-sync
    description: readdirSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "readdirSync"

  - id: walk-sync
    description: walkSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "walkSync"

  - id: glob-module
    description: glob module
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "glob"

  - id: readdir-fn
    description: readdir function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "readdir"

  - id: os-walk
    description: os.walk function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "os.walk"

  # === Encryption (atomic) ===
  - id: encrypt-fn
    description: encrypt function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "encrypt"

  - id: cipher-keyword
    description: cipher keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "cipher"

  - id: create-cipheriv
    description: createCipheriv function
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "createCipheriv"

  - id: aes-keyword
    description: AES keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "AES"

  # === File write (atomic) ===
  - id: writefile-sync
    description: writeFileSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "writeFileSync"

  - id: writefile-fn
    description: writeFile function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "writeFile"

  - id: open-paren
    description: open( function
    crit: inert
    conf: 0.3
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "open("

  # === Ransom note (atomic) ===
  - id: files-encrypted-msg
    description: Files encrypted message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "your files have been encrypted"
      case_insensitive: true

  - id: pay-bitcoin-msg
    description: Pay bitcoin message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "pay bitcoin"
      case_insensitive: true

  - id: pay-btc-msg
    description: Pay BTC message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "pay btc"
      case_insensitive: true

  - id: decrypt-files-msg
    description: Decrypt files message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "decrypt your files"
      case_insensitive: true

  - id: bitcoin-wallet-msg
    description: Bitcoin wallet message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "bitcoin wallet"
      case_insensitive: true

  - id: restore-files-msg
    description: Restore files message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "restore your files"
      case_insensitive: true

  - id: send-payment-msg
    description: Send payment message
    crit: inert
    conf: 0.7
    for: [javascript, typescript, python, shell]
    if:
      type: string
      exact: "send payment"
      case_insensitive: true

  - id: ransom-identifier
    description: Ransom-related terminology
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "(?i)\\bransom\\b"

  # === File rename (atomic) ===
  - id: rename-sync
    description: renameSync function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "renameSync"

  - id: rename-fn
    description: rename( function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "rename("

  - id: os-rename
    description: os.rename function
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    if:
      type: string
      exact: "os.rename"

  # === Encrypted extensions (atomic) ===
  - id: ext-encrypted
    description: .encrypted extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".encrypted"

  - id: ext-locked
    description: .locked extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".locked"

  - id: ext-enc
    description: .enc extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".enc"

  - id: ext-crypt
    description: .crypt extension
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    if:
      type: string
      exact: ".crypt"

  # === Medusa ransomware (atomic) ===
  - id: medusa-name
    description: Medusa name
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: medusa
      case_insensitive: true

  - id: polymorphic-keyword
    description: polymorphic keyword
    crit: inert
    conf: 0.5
    for: [javascript, typescript]
    if:
      type: string
      exact: polymorphic
      case_insensitive: true

  - id: mutate-keyword
    description: mutate keyword
    crit: inert
    conf: 0.4
    for: [javascript, typescript]
    if:
      type: string
      exact: mutate

  # === Shadow copy deletion (atomic) ===
  - id: vssadmin-delete
    description: vssadmin delete shadows
    crit: inert
    conf: 0.7
    attack: "T1490"
    for: [javascript, powershell, shell]
    if:
      type: string
      regex: 'vssadmin\s+delete\s+shadows'

  - id: wmic-shadowcopy
    description: wmic shadowcopy delete
    crit: inert
    conf: 0.7
    attack: "T1490"
    for: [javascript, powershell, shell]
    if:
      type: string
      regex: 'wmic\s+shadowcopy\s+delete'

  - id: bcdedit-recovery
    description: bcdedit recoveryenabled no
    crit: inert
    conf: 0.7
    attack: "T1490"
    for: [javascript, powershell, shell]
    if:
      type: string
      regex: "bcdedit.{0,30}recoveryenabled.{0,30}no"

composite_rules:
  # RSA key operations
  - id: rsa-key-operations
    description: RSA key operations
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    count_min: 2
    any:
      - id: rsa-keyword
      - id: generate-keypair
      - id: public-encrypt
      - id: private-decrypt
      - id: begin-rsa-key
      - id: begin-public-key

  # RSA key handling with crypto
  - id: rsa-key-handling
    description: RSA key generation or handling
    crit: notable
    conf: 0.8
    for: [javascript, typescript, python]
    all:
      - id: crypto-module
      - id: rsa-key-operations

  # File iteration
  - id: file-iteration
    description: File iteration functions
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: readdir-sync
      - id: walk-sync
      - id: glob-module
      - id: readdir-fn
      - id: os-walk

  # Encryption functions
  - id: encryption-functions
    description: Encryption functions
    crit: inert
    conf: 0.5
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: encrypt-fn
      - id: cipher-keyword
      - id: create-cipheriv
      - id: aes-keyword

  # File write functions
  - id: file-write-functions
    description: File write functions
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: writefile-sync
      - id: writefile-fn
      - id: open-paren

  # File encryption loop
  - id: file-encryption-loop
    description: File iteration with encryption (ransomware
    crit: suspicious
    conf: 0.9
    for: [javascript, typescript, python]
    all:
      - id: file-iteration
      - id: encryption-functions
      - id: file-write-functions

  # Ransom note
  - id: ransom-note
    description: Ransom note text patterns
    crit: suspicious
    conf: 0.95
    for: [javascript, typescript, python, shell]
    count_min: 2
    any:
      - id: files-encrypted-msg
      - id: pay-bitcoin-msg
      - id: pay-btc-msg
      - id: decrypt-files-msg
      - id: bitcoin-wallet-msg
      - id: restore-files-msg
      - id: send-payment-msg

  # Rename functions
  - id: rename-functions
    description: File rename functions
    crit: inert
    conf: 0.4
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: rename-sync
      - id: rename-fn
      - id: os-rename

  # Encrypted extensions
  - id: encrypted-extensions
    description: Encrypted file extensions
    crit: inert
    conf: 0.6
    for: [javascript, typescript, python]
    count_min: 1
    any:
      - id: ext-encrypted
      - id: ext-locked
      - id: ext-enc
      - id: ext-crypt

  # Extension change
  - id: extension-change
    description: Changes file extensions (potential ransomware)
    crit: suspicious
    conf: 0.85
    for: [javascript, typescript, python]
    all:
      - id: rename-functions
      - id: encrypted-extensions

  # Medusa pattern
  - id: medusa-pattern
    description: Medusa ransomware implementation indicators
    crit: notable
    conf: 0.95
    for: [javascript, typescript]
    all:
      - id: medusa-name
    count_min: 1
    any:
      - id: polymorphic-keyword
      - id: mutate-keyword
      - id: rsa-keyword

  # Shadow copy deletion
  - id: shadow-delete
    description: Shadow copy deletion (ransomware preparation)
    crit: suspicious
    conf: 0.95
    attack: "T1490"
    for: [javascript, powershell, shell]
    count_min: 1
    any:
      - id: vssadmin-delete
      - id: wmic-shadowcopy
      - id: bcdedit-recovery
