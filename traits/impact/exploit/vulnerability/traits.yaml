# Impact - Exploit Techniques
# ATT&CK: T1068 (Exploitation for Privilege Escalation)

traits:
  # CVE References
  - id: impact/exploit/cve-mention
    description: References a CVE identifier
    criticality: suspicious
    confidence: 0.8
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "CVE-20[12]\\d-\\d{4,7}"

  - id: impact/exploit/cve-poc
    description: References a CVE proof-of-concept
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(CVE[-_]POC|POC[-_]CVE)-20[12]\\d-\\d+"

  # PwnKit (CVE-2021-4034)
  - id: impact/exploit/pwnkit-name
    description: PwnKit exploit identifier
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [elf, python, shell]
    condition:
      type: string
      regex: "(?i)pwnkit"

  - id: impact/exploit/pwnkit-cve
    description: PwnKit CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2021[-_]?4034"

  - id: impact/exploit/pkexec-exploit
    description: pkexec exploitation marker
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [elf]
    condition:
      type: string
      exact: "pkexec"

  # GCONV_PATH Exploit
  - id: impact/exploit/gconv-path-dot
    description: GCONV_PATH override to current directory
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "GCONV_PATH=."

  # NOTE: gconv_init is present in glibc for character conversion
  # This trait alone is NOT a reliable exploit indicator
  # Only meaningful in small binaries or combined with GCONV_PATH= exploit pattern
  - id: impact/exploit/gconv-init
    description: GCONV initialization hook (requires context)
    criticality: notable
    confidence: 0.4
    attack: "T1068"
    file_types: [elf]
    condition:
      type: string
      exact: "gconv_init"

  # GLIBC_TUNABLES (CVE-2023-4911)
  # NOTE: GLIBC_TUNABLES is present in all statically linked glibc binaries
  # This trait alone is NOT a reliable exploit indicator - only notable when
  # combined with explicit exploit references (looney tunables, cve-2023-4911)
  - id: impact/exploit/glibc-tunables
    description: GLIBC_TUNABLES environment variable (requires context)
    criticality: notable
    confidence: 0.3
    attack: "T1068"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "GLIBC_TUNABLES"

  - id: impact/exploit/looney-tunables
    description: Looney Tunables exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)looney.?tunables"

  - id: impact/exploit/cve-2023-4911
    description: GLIBC_TUNABLES CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2023[-_]?4911"

  # Shellcode/Buffer Overflow
  - id: impact/exploit/shellcode-ref
    description: Shellcode reference
    criticality: suspicious
    confidence: 0.85
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "shellcode"

  - id: impact/exploit/exec-shellcode
    description: Shellcode execution function
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "exec(ute)?[_-]?shellcode"

  - id: impact/exploit/nop-sled
    description: NOP sled reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)nop[_-]?sled"

  - id: impact/exploit/payload-so
    description: Payload shared object
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [elf]
    condition:
      type: string
      exact: "payload.so"

  # DirtyPipe (CVE-2022-0847)
  - id: impact/exploit/dirtypipe
    description: DirtyPipe exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)dirty.?pipe"

  - id: impact/exploit/cve-2022-0847
    description: DirtyPipe CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2022[-_]?0847"

  # DirtyCow (CVE-2016-5195)
  - id: impact/exploit/dirtycow
    description: DirtyCow exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)dirty.?cow"

  - id: impact/exploit/cve-2016-5195
    description: DirtyCow CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2016[-_]?5195"

composite_rules:
  - id: impact/exploit/pwnkit-detected
    description: PwnKit pkexec exploit (CVE-2021-4034)
    criticality: suspicious
    confidence: 0.95
    reference: "https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034"
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    condition:
      type: yara
      source: |
        rule pwnkit_exploit {
          strings:
            $pwnkit1 = "PwnKit" nocase
            $pwnkit2 = "pwnkit" nocase
            $cve = /cve[-_]?2021[-_]?4034/i
            $path = "PATH" fullword
            $pkexec = "pkexec"
            $gconv_path = "GCONV_PATH=."
            $gconv_init = "gconv_init"
            $payload = "payload.so"
            $revshell = "reverse_shell"
          condition:
            filesize < 5MB and
            (any of ($pwnkit*, $cve) and any of ($path, $pkexec, $revshell)) or
            (4 of ($path, $pkexec, $gconv_path, $gconv_init, $payload))
        }

  - id: impact/exploit/buffer-overflow-detected
    description: Buffer overflow exploit
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    mbc: "E1068"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule buffer_overflow_exploit {
          strings:
            $shellcode = "shellcode" fullword
            $n_padding = "padding" fullword
            $n_address = "address" fullword
            $n_offset = "offset" fullword
            $n_overflow = "overflow" fullword
            $n_rop = "ROP" fullword
            $n_gadget = "gadget" fullword
            $not_fishshell = "fishshell"
            $not_powershell = "powershell"
          condition:
            filesize < 3MB and $shellcode and 2 of ($n*) and none of ($not*)
        }

  - id: impact/exploit/looney-tunables-detected
    description: Looney Tunables exploit (CVE-2023-4911)
    criticality: suspicious
    confidence: 0.95
    reference: "https://blog.qualys.com/vulnerabilities-threat-research/2023/10/03/cve-2023-4911-looney-tunables-local-privilege-escalation-in-the-glibcs-ld-so"
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    condition:
      type: yara
      source: |
        rule looney_tunables {
          strings:
            // Explicit exploit references (high confidence)
            $name = /looney.?tunables/i
            $cve = /cve[-_]?2023[-_]?4911/i
            // Exploit code patterns
            $tunables = "GLIBC_TUNABLES"
            $overflow = "overflow"
            $exploit = "exploit"
            $payload = "payload"
            $shellcode = "shellcode"
            $poc = "proof.?of.?concept"i
          condition:
            filesize < 5MB and
            // Only match if explicit exploit reference OR exploit patterns
            any of ($name, $cve) or
            ($tunables and any of ($overflow, $exploit, $payload, $shellcode, $poc))
        }
