# Impact - Exploit Techniques
# ATT&CK: T1068 (Exploitation for Privilege Escalation)

traits:
  # CVE References
  - id: cve-mention
    description: References a CVE identifier
    criticality: suspicious
    confidence: 0.8
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "CVE-20[12]\\d-\\d{4,7}"

  - id: cve-poc
    description: References a CVE proof-of-concept
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(CVE[-_]POC|POC[-_]CVE)-20[12]\\d-\\d+"

  # PwnKit (CVE-2021-4034)
  - id: pwnkit-name
    description: PwnKit exploit identifier
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [elf, python, shell]
    condition:
      type: string
      regex: "(?i)pwnkit"

  - id: pwnkit-cve
    description: PwnKit CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2021[-_]?4034"

  - id: pkexec-exploit
    description: pkexec exploitation marker
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [elf]
    condition:
      type: string
      exact: "pkexec"

  # GCONV_PATH Exploit
  - id: gconv-path-dot
    description: GCONV_PATH override to current directory
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "GCONV_PATH=."

  # NOTE: gconv_init is present in glibc for character conversion
  # This trait alone is NOT a reliable exploit indicator
  # Only meaningful in small binaries or combined with GCONV_PATH= exploit pattern
  - id: gconv-init
    description: GCONV initialization hook (requires context)
    criticality: notable
    confidence: 0.4
    attack: "T1068"
    file_types: [elf]
    condition:
      type: string
      exact: "gconv_init"

  # GLIBC_TUNABLES (CVE-2023-4911)
  # NOTE: GLIBC_TUNABLES is present in all statically linked glibc binaries
  # This trait alone is NOT a reliable exploit indicator - only notable when
  # combined with explicit exploit references (looney tunables, cve-2023-4911)
  - id: glibc-tunables
    description: GLIBC_TUNABLES environment variable (requires context)
    criticality: notable
    confidence: 0.3
    attack: "T1068"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "GLIBC_TUNABLES"

  - id: looney-tunables
    description: Looney Tunables exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)looney.?tunables"

  - id: cve-2023-4911
    description: GLIBC_TUNABLES CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2023[-_]?4911"

  # Shellcode/Buffer Overflow
  - id: shellcode-ref
    description: Shellcode reference
    criticality: suspicious
    confidence: 0.85
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "shellcode"

  - id: exec-shellcode
    description: Shellcode execution function
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "exec(ute)?[_-]?shellcode"

  - id: nop-sled
    description: NOP sled reference
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)nop[_-]?sled"

  - id: payload-so
    description: Payload shared object
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    file_types: [elf]
    condition:
      type: string
      exact: "payload.so"

  # DirtyPipe (CVE-2022-0847)
  - id: dirtypipe
    description: DirtyPipe exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)dirty.?pipe"

  - id: cve-2022-0847
    description: DirtyPipe CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2022[-_]?0847"

  # DirtyCow (CVE-2016-5195)
  - id: dirtycow
    description: DirtyCow exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)dirty.?cow"

  - id: cve-2016-5195
    description: DirtyCow CVE reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)cve[-_]?2016[-_]?5195"

  # Additional atomic traits for composite rules

  - id: path-env-var
    description: PATH environment variable reference
    criticality: notable
    confidence: 0.3
    attack: "T1068"
    file_types: [elf, shell]
    condition:
      type: string
      exact: "PATH"

  - id: reverse-shell-ref
    description: Reverse shell reference in exploit
    criticality: suspicious
    confidence: 0.8
    attack: "T1068"
    file_types: [elf, python, shell]
    condition:
      type: string
      exact: "reverse_shell"

  - id: buffer-padding
    description: Buffer padding reference
    criticality: notable
    confidence: 0.5
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "padding"

  - id: buffer-address
    description: Buffer address reference
    criticality: notable
    confidence: 0.5
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "address"

  - id: buffer-offset
    description: Buffer offset reference
    criticality: notable
    confidence: 0.5
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "offset"

  - id: overflow-ref
    description: Overflow reference
    criticality: notable
    confidence: 0.6
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "overflow"

  - id: rop-ref
    description: ROP (Return-Oriented Programming) reference
    criticality: suspicious
    confidence: 0.8
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "ROP"

  - id: gadget-ref
    description: ROP gadget reference
    criticality: suspicious
    confidence: 0.7
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "gadget"

  - id: exploit-ref
    description: Exploit reference
    criticality: notable
    confidence: 0.5
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "exploit"

  - id: payload-ref
    description: Payload reference
    criticality: notable
    confidence: 0.5
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      exact: "payload"

  - id: poc-ref
    description: Proof of concept reference
    criticality: notable
    confidence: 0.6
    attack: "T1068"
    file_types: [all]
    condition:
      type: string
      regex: "(?i)proof.?of.?concept"

composite_rules:
  - id: pwnkit-detected
    description: PwnKit pkexec exploit (CVE-2021-4034)
    criticality: suspicious
    confidence: 0.95
    reference: "https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034"
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    condition:
      type: yara
      source: |
        rule pwnkit_exploit {
          strings:
            $pwnkit1 = "PwnKit" nocase
            $pwnkit2 = "pwnkit" nocase
            $cve = /cve[-_]?2021[-_]?4034/i
            $path = "PATH" fullword
            $pkexec = "pkexec"
            $gconv_path = "GCONV_PATH=."
            $gconv_init = "gconv_init"
            $payload = "payload.so"
            $revshell = "reverse_shell"
          condition:
            filesize < 5MB and
            (any of ($pwnkit*, $cve) and any of ($path, $pkexec, $revshell)) or
            (4 of ($path, $pkexec, $gconv_path, $gconv_init, $payload))
        }

  - id: buffer-overflow-detected
    description: Buffer overflow exploit
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    mbc: "E1068"
    file_types: [all]
    condition:
      type: yara
      source: |
        rule buffer_overflow_exploit {
          strings:
            $shellcode = "shellcode" fullword
            $n_padding = "padding" fullword
            $n_address = "address" fullword
            $n_offset = "offset" fullword
            $n_overflow = "overflow" fullword
            $n_rop = "ROP" fullword
            $n_gadget = "gadget" fullword
            $not_fishshell = "fishshell"
            $not_powershell = "powershell"
          condition:
            filesize < 3MB and $shellcode and 2 of ($n*) and none of ($not*)
        }

  - id: looney-tunables-detected
    description: Looney Tunables exploit (CVE-2023-4911)
    criticality: suspicious
    confidence: 0.95
    reference: "https://blog.qualys.com/vulnerabilities-threat-research/2023/10/03/cve-2023-4911-looney-tunables-local-privilege-escalation-in-the-glibcs-ld-so"
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    condition:
      type: yara
      source: |
        rule looney_tunables {
          strings:
            // Explicit exploit references (high confidence)
            $name = /looney.?tunables/i
            $cve = /cve[-_]?2023[-_]?4911/i
            // Exploit code patterns
            $tunables = "GLIBC_TUNABLES"
            $overflow = "overflow"
            $exploit = "exploit"
            $payload = "payload"
            $shellcode = "shellcode"
            $poc = "proof.?of.?concept"i
          condition:
            filesize < 5MB and
            // Only match if explicit exploit reference OR exploit patterns
            any of ($name, $cve) or
            ($tunables and any of ($overflow, $exploit, $payload, $shellcode, $poc))
        }

  # Trait-based composite rules for simpler detection patterns

  - id: pwnkit-name-with-context
    description: PwnKit exploit with execution context
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    requires_any:
      - type: trait
        id: pwnkit-name
      - type: trait
        id: pwnkit-cve
    requires_all:
      - type: trait
        id: pkexec-exploit

  - id: gconv-path-exploit
    description: GCONV_PATH exploitation pattern
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, shell]
    requires_all:
      - type: trait
        id: gconv-path-dot
      - type: trait
        id: gconv-init
      - type: trait
        id: payload-so

  - id: looney-tunables-explicit
    description: Looney Tunables with explicit exploit reference
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    requires_any:
      - type: trait
        id: looney-tunables
      - type: trait
        id: cve-2023-4911

  - id: looney-tunables-with-exploit-pattern
    description: GLIBC_TUNABLES with exploit indicators
    criticality: suspicious
    confidence: 0.85
    attack: "T1068"
    mbc: "E1068"
    file_types: [elf, python, shell]
    requires_all:
      - type: trait
        id: glibc-tunables
    requires_any:
      - type: trait
        id: overflow-ref
      - type: trait
        id: exploit-ref
      - type: trait
        id: payload-ref
      - type: trait
        id: shellcode-ref
      - type: trait
        id: poc-ref

  - id: dirtypipe-detected
    description: DirtyPipe exploit detected
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    mbc: "E1068"
    file_types: [all]
    requires_any:
      - type: trait
        id: dirtypipe
      - type: trait
        id: cve-2022-0847

  - id: dirtycow-detected
    description: DirtyCow exploit detected
    criticality: suspicious
    confidence: 0.95
    attack: "T1068"
    mbc: "E1068"
    file_types: [all]
    requires_any:
      - type: trait
        id: dirtycow
      - type: trait
        id: cve-2016-5195

  - id: shellcode-with-rop
    description: Shellcode with ROP exploitation
    criticality: suspicious
    confidence: 0.9
    attack: "T1068"
    mbc: "E1068"
    file_types: [all]
    requires_all:
      - type: trait
        id: shellcode-ref
    requires_any:
      - type: trait
        id: rop-ref
      - type: trait
        id: gadget-ref
