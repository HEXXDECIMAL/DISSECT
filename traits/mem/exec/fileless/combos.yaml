# Memory-based Code Execution
# ATT&CK: T1055 (Process Injection)
# MBC: B0033

traits:
  - id: remote-injection
    description: Remote process memory manipulation
    criticality: suspicious
    confidence: 0.9
    attack: "T1055"
    platforms: [windows]
    file_types: [pe, dll]
    condition:
      type: yara
      source: |
        rule remote_injection {
          strings:
            $vpe = "VirtualProtectEx" ascii wide
            $vqe = "VirtualQueryEx" ascii wide
          condition:
            any of them
        }

  - id: execve-symbol
    description: Linux execve/fexecve symbol reference
    criticality: notable
    confidence: 0.8
    platforms: [linux]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "^_?(execve|fexecve)$"

  - id: python-encode-call
    description: Python encode method call
    criticality: notable
    confidence: 0.8
    platforms: [windows, linux, macos]
    file_types: [python]
    condition:
      type: ast_pattern
      node_type: call
      pattern: "encode"

  - id: python-b64decode-call
    description: Python base64 decode call
    criticality: notable
    confidence: 0.8
    platforms: [windows, linux, macos]
    file_types: [python]
    condition:
      type: ast_pattern
      node_type: call
      pattern: "b64decode"

composite_rules:
  - id: linux-memfd
    description: Fileless execution via anonymous memory
    criticality: suspicious
    confidence: 0.9
    attack: "T1055"
    mbc: "B0033"
    platforms: [linux]
    file_types: [elf]
    requires_all:
      - type: trait
        id: mem/anonymous/create/memfd-create
    requires_any:
      - type: trait
        id: execve-symbol
      - type: trait
        id: mem/protect/modify/mprotect

  - id: python-shellcode
    description: Python shellcode injection via VirtualProtect
    criticality: suspicious
    confidence: 0.95
    attack: "T1055"
    mbc: "B0033"
    platforms: [windows]
    file_types: [python]
    requires_all:
      - type: trait
        id: mem/protect/modify/virtualprotect-ctypes
    requires_any:
      - type: trait
        id: python-encode-call
      - type: trait
        id: python-b64decode-call
