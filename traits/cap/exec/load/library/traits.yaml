# Library References
# Generic library string references (inert markers)

traits:
  # === Network Libraries ===
  - id: libssl-ref
    desc: libssl library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      substr: "libssl"

  - id: libcrypto-ref
    desc: libcrypto library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      substr: "libcrypto"

  - id: libcurl-ref
    desc: libcurl library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      substr: "libcurl"

  # === System Libraries ===
  - id: gnu-coreutils-ref
    desc: GNU coreutils reference
    crit: inert
    conf: 0.3
    if:
      type: string
      substr: "GNU coreutils"

  - id: glibc-ref
    desc: glibc reference
    crit: inert
    conf: 0.3
    if:
      type: string
      substr: "glibc"

  - id: libc-characteristic-symbols
    desc: Characteristic system library exports
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "^(__libc_start_main|gnu_get_libc_version|__errno_location|__atan2_finite|feenableexcept|__log_finite|exp2f|__cxa_atexit|__cxa_finalize|__stack_chk_fail|__assert_fail)$"

  - id: libc-version-string
    desc: libc version string pattern
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "(?i)(?:^|\\b)(?:libc\\.so\\.[0-9]|glibc|musl libc|openbsd libc|freebsd libc|bionic|uclibc)"

  - id: libc-internal-functions
    desc: libc internal functions (malloc, etc)
    crit: inert
    conf: 0.7
    if:
      type: symbol
      # Functions that are always provided by libc AND typically exported
      regex: "^(__libc_|__ctype_|__tzname|__progname|__environ|__cxa_|_obstack_|_IO_|__malloc_|__free_|__realloc_)"

  # === C++ Standard Library (libc++/libstdc++) ===
  - id: libcxx-ref
    desc: LLVM libc++ stdlib
    crit: inert
    conf: 0.9
    if:
      type: string
      # Match libc++ library name or LLVM libc++ identifiers
      regex: "libc\\+\\+\\.so|libc\\+\\+abi|_LIBCPP_VERSION|__libcpp_"

  - id: libstdcxx-ref
    desc: GNU libstdc++ stdlib
    crit: inert
    conf: 0.9
    if:
      type: string
      # Match libstdc++ library name or GNU C++ identifiers
      regex: "libstdc\\+\\+\\.so|__gnu_cxx|__cxxabiv1"

  - id: cxx-abi-symbols
    desc: C++ ABI symbols
    crit: inert
    conf: 0.8
    if:
      type: symbol
      # C++ ABI functions found in standard library implementations
      regex: "^(__cxa_|__gxx_|_ZN[A-Z]|_ZSt|_ZNSt|_ZNK[A-Z])"

  - id: system-debug-lib
    desc: System debug library
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "lib.{1,20}_debug\\.so"

  # === Compression Libraries ===
  - id: lzma-ref
    desc: lzma compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\blzma\\b"

  - id: xz-ref
    desc: xz compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\bxz\\b"

  - id: zlib-ref
    desc: zlib compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\bzlib\\b"

  # === Graphics Libraries ===
  - id: mesa-ref
    desc: Mesa 3D graphics reference
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match Mesa graphics stack strings (library names, paths, internal names)
      regex: "(?i)(?:mesa|gallium|libGL|libEGL|libGLX|dri_|swrast|pipe_loader|_mesa_)"

  - id: opengl-ref
    desc: OpenGL graphics reference
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match OpenGL/graphics API strings
      regex: "(?i)(?:opengl|glx|\\begl\\b|vulkan|GL_VERSION|GL_RENDERER|glX[A-Z])"

  - id: x11-ref
    desc: X11 windowing reference
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match X11 windowing stack strings (includes IPC libraries like ICE, SM, Xpm)
      regex: "(?i)(?:libX11|libXpm|libxcb|libICE|libSM|xorg|xenocara|XOpenDisplay|XCreateWindow|XpmCreate|XpmRead|IceConn|SmcConn)"

  - id: dri-driver-ref
    desc: DRI graphics driver reference
    crit: inert
    conf: 0.6
    for: [elf, so]
    if:
      type: string
      # Match DRI driver paths and patterns common in Mesa/GPU drivers
      regex: "/usr/(?:lib|X11R6/lib)/(?:dri|modules/dri)/|_dri\\.so|drirc|DRI_PRIME"

  - id: x11-dga-marker
    desc: X11 DGA library marker
    crit: inert
    conf: 0.9
    for: [elf, so]
    if:
      type: string
      # Match XF86DGA/DGA extension strings - these libraries legitimately
      # access /dev/mem for direct video memory mapping
      regex: "(?i)(?:XF86DGA|XDGAOpenFramebuffer|XDGACloseFramebuffer|libXxf86dga|XFree86-DGA)"

  # === Video Acceleration Libraries ===
  - id: vaapi-ref
    desc: VA-API video acceleration library
    crit: inert
    conf: 0.9
    for: [elf, so]
    if:
      type: string
      # Match VA-API strings: libva, vaGetDisplay, VA_STATUS, VA-API, etc.
      regex: "(?i)(?:libva\\b|vaGetDisplay|VA_STATUS|VA-API|vaInitialize|vaTerminate|LIBVA_DRIVER)"

  - id: vdpau-ref
    desc: VDPAU video acceleration library
    crit: inert
    conf: 0.9
    for: [elf, so]
    if:
      type: string
      # Match VDPAU video decode/presentation strings
      regex: "(?i)(?:vdpau|VdpDevice|VdpVideoSurface|libvdpau)"

  - id: drm-driver-ref
    desc: DRM/KMS graphics driver reference
    crit: inert
    conf: 0.8
    for: [elf, so]
    if:
      type: string
      # Match DRM kernel mode setting strings used by video/graphics drivers
      regex: "(?i)(?:libdrm|drmOpen|drmModeGetResources|DRM_IOCTL|drm_mode_|/dev/dri/)"

  # === Shell Interpreters ===
  - id: shell-keyword-marker
    desc: Shell interpreter keyword marker
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      substr: "is a shell keyword"

  - id: shell-builtin-marker
    desc: Shell interpreter builtin marker
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      substr: "shell builtin"

  # === Debuggers ===
  - id: gdb-debugger-ref
    desc: GDB debugger reference
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      # Match GDB-specific strings that indicate this is gdb or a gdb-linked binary
      regex: "(?i)\\bGNU gdb\\b|\\bgdb\\s+(?:version|debugging|remote|server)|\\bgdbserver\\b|\\bgdb-multiarch\\b"

  - id: lldb-debugger-ref
    desc: LLDB debugger reference
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      # Match LLDB-specific strings:
      # - "lldb" followed by debugger/command/version/breakpoint
      # - lldb-server, lldb-argdumper binaries
      # - LLDB SB API classes (used in lldb Python bindings)
      # - LLDB command or plugin identifiers
      regex: "(?i)\\blldb\\b.{0,30}(?:debugger|command|version|breakpoint|frame|thread)|lldb-server|lldb-argdumper|SBDebugger|SBTarget|SBProcess|SBBreakpoint|SBFrame|\\bLLDB\\b.{0,20}(?:module|plugin)"

  - id: debugger-ptrace-marker
    desc: Debugger ptrace usage marker
    crit: inert
    conf: 0.7
    for: [elf, macho]
    if:
      type: string
      # Debugger-specific ptrace context strings
      regex: "PTRACE_(?:ATTACH|DETACH|CONT|PEEKDATA|POKEDATA|SINGLESTEP|GETREGS|SETREGS)"

  # === Compiler/Build Tools ===
  - id: llvm-project-ref
    desc: LLVM project reference
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "(?i)\\b(llvm|clang)\\s+(version|compiler|project|IR)"

  - id: gcc-project-ref
    desc: GCC project reference
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "(?i)\\bgcc\\s+(version|compiler)|\\bgnuc\\b"

  - id: cmake-build-ref
    desc: CMake build tool reference
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "(?i)\\bcmake\\b"

  # === X11 IPC Libraries ===
  - id: x11-ice-ref
    desc: X11 Inter-Client Exchange library
    crit: inert
    conf: 0.6
    if:
      type: string
      # Match ICE library strings - Inter-Client Exchange protocol
      regex: "(?i)(?:libICE|IceConn|IceProcessMessage|IceSetIOErrorHandler|IceRegisterForProtocolSetup)"

  - id: x11-sm-ref
    desc: X11 Session Management library
    crit: inert
    conf: 0.6
    if:
      type: string
      # Match SM library strings - Session Management protocol
      regex: "(?i)(?:libSM|SmcConn|SmcOpenConnection|SmcCloseConnection)"

  - id: x11-auth-protocol
    desc: X11 MIT-MAGIC-COOKIE authentication
    crit: inert
    conf: 0.5
    if:
      type: string
      # X11 standard authentication mechanism, used by all X11 IPC libraries
      substr: "MIT-MAGIC-COOKIE-1"

composite_rules:
  # X11 IPC libraries (ICE, SM) - these are network/IPC libraries by design
  - id: x11-ipc-lib-marker
    desc: X11 IPC library markers (ICE, SM)
    crit: inert
    conf: 0.6
    any:
      - id: x11-ice-ref
      - id: x11-sm-ref
      - id: x11-auth-protocol

  - id: network-lib-marker
    desc: Known network library markers
    crit: inert
    conf: 0.5
    any:
      - id: libssl-ref
      - id: libcrypto-ref
      - id: libcurl-ref
      - id: cap/comm/ssh/client::libssh
      - id: x11-ipc-lib-marker

  - id: video-lib-marker
    desc: Video acceleration library markers (VA-API, VDPAU)
    crit: inert
    conf: 0.9
    any:
      - id: vaapi-ref
      - id: vdpau-ref
      - id: drm-driver-ref

  - id: graphics-lib-marker
    desc: Graphics/OpenGL library markers
    crit: inert
    conf: 0.6
    any:
      - id: mesa-ref
      - id: opengl-ref
      - id: x11-ref
      - id: dri-driver-ref
      - id: video-lib-marker

  - id: cxx-stdlib-marker
    desc: C++ standard library markers (libc++, libstdc++)
    crit: inert
    conf: 0.9
    any:
      - id: libcxx-ref
      - id: libstdcxx-ref
      - id: cxx-abi-symbols

  - id: system-lib-marker
    desc: Known system library markers
    crit: inert
    conf: 0.5
    any:
      - id: gnu-coreutils-ref
      - id: glibc-ref
      - id: libc-characteristic-symbols
      - id: libc-version-string
      - id: libc-internal-functions
      - id: system-debug-lib
      - id: graphics-lib-marker
      - id: cxx-stdlib-marker

  - id: compression-lib
    desc: Compression library markers
    crit: inert
    conf: 0.4
    any:
      - id: lzma-ref
      - id: xz-ref
      - id: zlib-ref

  - id: shell-interpreter
    desc: Shell interpreter binary
    crit: inert
    conf: 0.9
    for: [elf, macho]
    any:
      - id: shell-keyword-marker
      - id: shell-builtin-marker

  - id: compiler-tool-marker
    desc: Compiler or build tool binary
    crit: inert
    conf: 0.8
    any:
      - id: llvm-project-ref
      - id: meta/lang/compiler::libllvm
      - id: gcc-project-ref
      - id: cmake-build-ref

  # Async I/O libraries need timing functions for event scheduling
  - id: async-io-lib-marker
    desc: Async I/O library (libevent, libev, etc.)
    crit: inert
    conf: 0.9
    all:
      - id: cap/comm/async

  - id: debugger-tool-marker
    desc: Debugger tool (gdb, lldb, etc.)
    crit: inert
    conf: 0.9
    for: [elf, macho]
    any:
      - id: gdb-debugger-ref
      - id: lldb-debugger-ref
      - id: debugger-ptrace-marker
