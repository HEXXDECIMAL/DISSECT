# Library References
# Generic library string references (inert markers)

traits:
  # === Network Libraries ===
  - id: libssl-ref
    desc: libssl library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libssl"

  - id: libcrypto-ref
    desc: libcrypto library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libcrypto"

  - id: libcurl-ref
    desc: libcurl library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libcurl"

  - id: libssh-ref
    desc: libssh library reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "libssh"

  # === System Libraries ===
  - id: gnu-coreutils-ref
    desc: GNU coreutils reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "GNU coreutils"

  - id: glibc-ref
    desc: glibc reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "glibc"

  - id: libc-characteristic-symbols
    desc: Characteristic system library exports
    crit: inert
    conf: 0.5
    if:
      type: symbol
      regex: "^(__libc_start_main|gnu_get_libc_version|__errno_location|__atan2_finite|feenableexcept|__log_finite|exp2f)$"

  - id: systemd-ref
    desc: systemd reference
    crit: inert
    conf: 0.3
    if:
      type: string
      exact: "systemd"

  - id: system-debug-lib
    desc: System debug library
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "lib.{1,20}_debug\\.so"

  # === Compression Libraries ===
  - id: lzma-ref
    desc: lzma compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\blzma\\b"

  - id: xz-ref
    desc: xz compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\bxz\\b"

  - id: zlib-ref
    desc: zlib compression reference
    crit: inert
    conf: 0.3
    if:
      type: string
      regex: "(?i)\\bzlib\\b"

  # === Graphics Libraries ===
  - id: mesa-ref
    desc: Mesa 3D graphics reference
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match Mesa graphics stack strings (library names, paths, internal names)
      regex: "(?i)(?:mesa|gallium|libGL|libEGL|libGLX|dri_|swrast|pipe_loader|_mesa_)"

  - id: opengl-ref
    desc: OpenGL graphics reference
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match OpenGL/graphics API strings
      regex: "(?i)(?:opengl|glx|\\begl\\b|vulkan|GL_VERSION|GL_RENDERER|glX[A-Z])"

  - id: x11-ref
    desc: X11 windowing reference
    crit: inert
    conf: 0.5
    if:
      type: string
      # Match X11 windowing stack strings (includes IPC libraries like ICE, SM)
      regex: "(?i)(?:libX11|libxcb|libICE|libSM|xorg|xenocara|XOpenDisplay|XCreateWindow|IceConn|SmcConn)"

  - id: dri-driver-ref
    desc: DRI graphics driver reference
    crit: inert
    conf: 0.6
    for: [elf, so]
    if:
      type: string
      # Match DRI driver paths and patterns common in Mesa/GPU drivers
      regex: "/usr/(?:lib|X11R6/lib)/(?:dri|modules/dri)/|_dri\\.so|drirc|DRI_PRIME"

  # === Shell Interpreters ===
  - id: shell-keyword-marker
    desc: Shell interpreter keyword marker
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      exact: "is a shell keyword"

  - id: shell-builtin-marker
    desc: Shell interpreter builtin marker
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      substr: "shell builtin"

  # === Debuggers ===
  - id: gdb-debugger-ref
    desc: GDB debugger reference
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      # Match GDB-specific strings that indicate this is gdb or a gdb-linked binary
      regex: "(?i)\\bGNU gdb\\b|\\bgdb\\s+(?:version|debugging|remote|server)|\\bgdbserver\\b|\\bgdb-multiarch\\b"

  - id: lldb-debugger-ref
    desc: LLDB debugger reference
    crit: inert
    conf: 0.9
    for: [elf, macho]
    if:
      type: string
      # Match LLDB-specific strings (bounded pattern to avoid backtracking)
      regex: "(?i)\\blldb\\b.{0,30}(?:debugger|command|version)|lldb-server|lldb-argdumper"

  - id: debugger-ptrace-marker
    desc: Debugger ptrace usage marker
    crit: inert
    conf: 0.7
    for: [elf, macho]
    if:
      type: string
      # Debugger-specific ptrace context strings
      regex: "PTRACE_(?:ATTACH|DETACH|CONT|PEEKDATA|POKEDATA|SINGLESTEP|GETREGS|SETREGS)"

  # === Compiler/Build Tools ===
  - id: llvm-project-ref
    desc: LLVM project reference
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "(?i)\\b(llvm|clang)\\s+(version|compiler|project|IR)"

  - id: llvm-lib-ref
    desc: libLLVM library reference
    crit: inert
    conf: 0.9
    if:
      type: string
      regex: "libLLVM"

  - id: gcc-project-ref
    desc: GCC project reference
    crit: inert
    conf: 0.8
    if:
      type: string
      regex: "(?i)\\bgcc\\s+(version|compiler)|\\bgnuc\\b"

  - id: cmake-build-ref
    desc: CMake build tool reference
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "(?i)\\bcmake\\b"

  # === X11 IPC Libraries ===
  - id: x11-ice-ref
    desc: X11 Inter-Client Exchange library
    crit: inert
    conf: 0.6
    if:
      type: string
      # Match ICE library strings - Inter-Client Exchange protocol
      regex: "(?i)(?:libICE|IceConn|IceProcessMessage|IceSetIOErrorHandler|IceRegisterForProtocolSetup)"

  - id: x11-sm-ref
    desc: X11 Session Management library
    crit: inert
    conf: 0.6
    if:
      type: string
      # Match SM library strings - Session Management protocol
      regex: "(?i)(?:libSM|SmcConn|SmcOpenConnection|SmcCloseConnection)"

  - id: x11-auth-protocol
    desc: X11 MIT-MAGIC-COOKIE authentication
    crit: inert
    conf: 0.5
    if:
      type: string
      # X11 standard authentication mechanism, used by all X11 IPC libraries
      exact: "MIT-MAGIC-COOKIE-1"

composite_rules:
  # X11 IPC libraries (ICE, SM) - these are network/IPC libraries by design
  - id: x11-ipc-lib-marker
    desc: X11 IPC library markers (ICE, SM)
    crit: inert
    conf: 0.6
    count_min: 1
    any:
      - id: x11-ice-ref
      - id: x11-sm-ref
      - id: x11-auth-protocol

  - id: network-lib-marker
    desc: Known network library markers
    crit: inert
    conf: 0.5
    count_min: 1
    any:
      - id: libssl-ref
      - id: libcrypto-ref
      - id: libcurl-ref
      - id: libssh-ref
      - id: x11-ipc-lib-marker

  - id: graphics-lib-marker
    desc: Graphics/OpenGL library markers
    crit: inert
    conf: 0.6
    count_min: 1
    any:
      - id: mesa-ref
      - id: opengl-ref
      - id: x11-ref
      - id: dri-driver-ref

  - id: system-lib-marker
    desc: Known system library markers
    crit: inert
    conf: 0.5
    count_min: 1
    any:
      - id: gnu-coreutils-ref
      - id: glibc-ref
      - id: systemd-ref
      - id: libc-characteristic-symbols
      - id: system-debug-lib
      - id: graphics-lib-marker

  - id: compression-lib
    desc: Compression library markers
    crit: inert
    conf: 0.4
    count_min: 1
    any:
      - id: lzma-ref
      - id: xz-ref
      - id: zlib-ref

  - id: shell-interpreter
    desc: Shell interpreter binary
    crit: inert
    conf: 0.9
    for: [elf, macho]
    count_min: 1
    any:
      - id: shell-keyword-marker
      - id: shell-builtin-marker

  - id: compiler-tool-marker
    desc: Compiler or build tool binary
    crit: inert
    conf: 0.8
    count_min: 1
    any:
      - id: llvm-project-ref
      - id: llvm-lib-ref
      - id: gcc-project-ref
      - id: cmake-build-ref

  - id: debugger-tool-marker
    desc: Debugger tool (gdb, lldb, etc.)
    crit: inert
    conf: 0.9
    for: [elf, macho]
    count_min: 1
    any:
      - id: gdb-debugger-ref
      - id: lldb-debugger-ref
      - id: debugger-ptrace-marker
