# AppleScript User Execution Lures
# Social engineering to trick users into running malicious AppleScript
# ATT&CK: T1204.002 (User Execution: Malicious File)

defaults:
  # osascript can be invoked from any language: python subprocess, ruby system(), etc.
  for: [applescript, shell, python, ruby, perl, javascript, elf, macho]
  platforms: [macos]
  attack: "T1204.002"

traits:
  # ============================================
  # Compatibility Wizard Lure (common in AMOS)
  # ============================================
  - id: compat-wizard
    desc: "Compatibility Wizard lure text"
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "(?i)Compatibility Wizard"

  - id: compat-issue
    desc: "Compatibility issue lure text"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "(?i)\\b(this|your|the)\\s+\\w+\\s+(has\\s+)?compatibility\\s+issue"

  - id: file-not-opened
    desc: "File couldn't be opened lure"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)couldn't be opened"

  # ============================================
  # Missing Components Lure
  # ============================================
  - id: missing-extensions
    desc: "Missing extensions lure text"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "(?i)extensions are missing"

  - id: missing-required-ext
    desc: "Missing required extensions lure"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "(?i)Missing required extensions"

  - id: missing-required-comp
    desc: "Missing required components lure"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "(?i)Missing required components"

  - id: required-components
    desc: "Required components lure text"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)required components"

  - id: required-extensions
    desc: "Required extensions lure text"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)required extensions"

  # ============================================
  # System Update Lure
  # ============================================
  - id: system-update
    desc: "System update lure text"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)System update"

  - id: check-updates
    desc: "Check updates lure text"
    crit: notable
    conf: 0.75
    if:
      type: string
      # Match "check for updates", "check updates", "checking for updates" etc.
      # Exclude matches like "checks if... updates" which are just docstrings
      regex: "(?i)check(?:ing)?\\s+(?:for\\s+)?updates"

  - id: install-components
    desc: "Install components lure text"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "(?i)install.{0,50}components"

  # ============================================
  # User Action Prompts
  # ============================================
  - id: click-button
    desc: "Instructs user to click button"
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "(?i)click the.{0,30}button"

  - id: press-continue
    desc: "Instructs user to press to"
    crit: notable
    conf: 0.75
    if:
      type: string
      regex: "(?i)press.{0,30}to continue"

composite_rules:
  # Missing message group
  - id: missing-message
    desc: Missing components/extensions message
    crit: suspicious
    conf: 0.85
    needs: 1
    any:
      - id: missing-extensions
      - id: missing-required-ext
      - id: missing-required-comp

  # User action prompt group
  - id: user-action-prompt
    desc: User action prompt text
    crit: notable
    conf: 0.75
    needs: 1
    any:
      - id: click-button
      - id: press-continue

  # Update message group
  - id: update-message
    desc: Update-related lure message
    crit: notable
    conf: 0.8
    needs: 1
    any:
      - id: system-update
      - id: check-updates

  # Compatibility lure group
  - id: compat-lure
    desc: Compatibility-related lure message
    crit: suspicious
    conf: 0.9
    needs: 1
    any:
      - id: compat-wizard
      - id: compat-issue
      - id: missing-extensions
      - id: missing-required-ext

  # ============================================
  # Compatibility Wizard Attack
  # ============================================
  - id: compat-wizard-attack
    desc: "Compatibility Wizard user execution lure"
    crit: suspicious
    conf: 0.95
    for: [applescript, shell]
    all:
      - id: compat-wizard
      - id: missing-message

  # ============================================
  # Fake Update Attack
  # ============================================
  - id: fake-update-attack
    desc: "Fake system update user execution"
    crit: suspicious
    conf: 0.9
    for: [applescript, shell]
    all:
      - id: update-message
      - id: install-components

  # ============================================
  # Missing Components Attack
  # ============================================
  - id: missing-components-attack
    desc: "Missing components user execution lure"
    crit: suspicious
    conf: 0.9
    for: [applescript, shell]
    all:
      - id: missing-message
      - id: user-action-prompt

  # ============================================
  # Lure with Shell Execution
  # ============================================
  - id: lure-with-shell
    desc: "User execution lure with shell"
    crit: suspicious
    conf: 0.95
    for: [applescript]
    all:
      - id: compat-lure
      - id: cap/exec/command/shell::shell-execution
