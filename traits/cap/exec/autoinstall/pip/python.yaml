# Automatic Dependency Installation - Python pip
# Detects runtime package installation, common in malware droppers
# ATT&CK: T1059.006 (Command and Scripting Interpreter: Python)

defaults:
  for: [python]
  mbc: "B0024"
  attack: "T1059.006"
  crit: suspicious

traits:
  # subprocess pip install - most common pattern
  - id: subprocess-install
    desc: "Runtime pip install via subprocess"
    conf: 0.9
    if:
      type: string
      regex: "subprocess\\.[a-z_]+\\([^)]*pip[^)]*install"

  # sys.executable -m pip pattern
  - id: sys-executable
    desc: "pip install using sys.executable"
    conf: 0.95
    if:
      type: string
      regex: "sys\\.executable[^)]*-m[^)]*pip[^)]*install"

  # os.system pip install
  - id: os-system
    desc: "Runtime pip install via os.system"
    conf: 0.9
    if:
      type: string
      regex: "os\\.system\\([^)]*pip[^)]*install"

  # importlib fallback pattern (try import, except install)
  - id: try-import-install
    desc: "Try-except import with fallback pip"
    conf: 0.85
    if:
      type: string
      # Matches pattern in try/except blocks
      regex: "except[^:]*:.{0,50}pip.{0,20}install|ImportError.{0,50}pip.{0,20}install"

  # pip.main() direct call
  - id: main-call
    desc: "Direct pip.main() installation"
    conf: 0.9
    if:
      type: string
      regex: "pip\\.main\\(\\[.{0,50}install"

  # ensurepip module usage
  - id: ensurepip
    desc: "pip bootstrapping via ensurepip"
    conf: 0.8
    crit: notable
    if:
      type: string
      regex: "ensurepip"

  # === Try/except block atomic indicators ===
  - id: try-colon
    desc: "try: statement"
    crit: inert
    conf: 0.5
    if:
      type: string
      exact: "try:"

  - id: except-colon-pattern
    desc: except statement with colon
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "except[^:]*:"

  - id: import-statement
    desc: import statement
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "import\\s+\\w+"

  - id: pip-install-pattern
    desc: pip install pattern
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "pip.{0,50}install"

composite_rules:
  # Migrated from YARA
  - id: yara-pip-fallback-install
    desc: Try import with pip install
    conf: 0.95
    crit: suspicious
    all:
      - { id: try-colon }
      - { id: except-colon-pattern }
      - { id: import-statement }
      - { id: pip-install-pattern }
