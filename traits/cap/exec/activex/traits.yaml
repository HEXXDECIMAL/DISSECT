# ActiveX COM Object Instantiation
# Detects Windows COM object creation for various malware purposes
# Generic indicator for VBScript/JScript malware

traits:
  - id: activex-filesystem
    desc: FileSystemObject COM
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "Scripting.FileSystemObject"
    notes: "FileSystemObject COM - file I/O operations"
    attack: "T1566"
    mbc: "E1082"

  - id: activex-wshell
    desc: WScript.Shell COM
    crit: notable
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "WScript.Shell"
    notes: "WScript.Shell COM - shell command execution"
    attack: "T1059.005"
    mbc: "E1243"

  - id: activex-shell-app
    desc: Shell.Application COM
    crit: notable
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "Shell.Application"
    notes: "Shell.Application COM - privileged operations"
    attack: "T1059.005"
    mbc: "E1243"

  - id: activex-xmlhttp
    desc: MSXML2.XMLHTTP COM
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "MSXML2.XMLHTTP"
        - substr: "MSXML.XMLHTTP"
    notes: "MSXML2.XMLHTTP COM - HTTP network requests"
    attack: "T1071"
    mbc: "C0005"

  - id: activex-winhttp
    desc: WinHTTP request object
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "WinHTTP.WinHTTPRequest"
    notes: "WinHTTP COM - HTTP/HTTPS requests"
    attack: "T1071"
    mbc: "C0005"

  - id: activex-scripting
    desc: Scripting COM object
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "Scripting.Dictionary"
        - substr: "Scripting.FileSystemObject"
    notes: "Scripting runtime COM objects"

  - id: activex-wmi
    desc: WbemScripting.SWbemLocator
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "WbemScripting.SWbemLocator"
    notes: "WMI access via COM (process execution)"
    attack: "T1047"
    mbc: "E1043"

  - id: activex-adodb
    desc: ADODB.Stream COM
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      any:
        - substr: "ADODB.Stream"
        - substr: "ADODB.Recordset"
    notes: "ADODB COM - data stream/database operations"
    attack: "T1566"

  - id: activex-object-create
    desc: new ActiveXObject pattern
    crit: notable
    conf: 0.7
    platforms: [windows]
    for: [javascript]
    if:
      type: string
      substr: "new ActiveXObject("
    notes: "ActiveXObject instantiation (COM object creation)"
    attack: "T1202"

composite_rules:
  - id: activex-network-access
    desc: ActiveX network capability
    crit: suspicious
    conf: 0.8
    platforms: [windows]
    for: [javascript]
    attack: "T1071"
    mbc: "C0005"
    notes: |
      Network communication via COM objects.

      Indicates:
      - HTTP/HTTPS requests
      - Command & control communication
      - Data exfiltration capability
      - Remote payload download

    any:
      - id: activex-xmlhttp
      - id: activex-winhttp

  - id: activex-file-network
    desc: File + network operations
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    attack: "T1071"
    mbc: "C0005"
    notes: |
      File operations combined with network capability.

      Indicates:
      - Dropper malware
      - Payload download and execution
      - Data stealing with network upload
      - Worm propagation

    all:
      - id: activex-filesystem
      - id: activex-network-access

  - id: activex-shell-execution
    desc: Shell command execution
    crit: suspicious
    conf: 0.85
    platforms: [windows]
    for: [javascript]
    attack: "T1059.005"
    mbc: "E1243"
    notes: |
      Shell execution capability via COM objects.

      Indicates:
      - Command execution
      - Process spawning
      - Arbitrary code execution
      - Command & control capability

    any:
      - id: activex-wshell
      - id: activex-shell-app
      - id: activex-wmi

  - id: activex-malware-toolkit
    desc: COM malware toolkit
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [javascript]
    attack: "T1202"
    mbc: "E1243"
    notes: |
      Complete malware toolkit via COM objects.

      Combines:
      - File system access
      - Shell command execution
      - Network communication
      - Process/WMI execution

      This indicates sophisticated script-based malware
      with comprehensive attack capabilities.

    count_min: 3
    any:
      - id: activex-filesystem
      - id: activex-wshell
      - id: activex-shell-app
      - id: activex-xmlhttp
      - id: activex-winhttp
      - id: activex-wmi

