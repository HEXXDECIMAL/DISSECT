# Windows Background Command Execution
# Detects commands designed to run in background/hidden on Windows
# ATT&CK: T1059.003 (Windows Command Shell)

defaults:
  for: [python, shell, php, javascript]
  attack: "T1059.003"
  mbc: "E1059"

traits:
  # Windows 'start' command for background execution
  - id: start-command
    desc: "Windows 'start' command for background"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "\\bstart\\s+['\"]?\\{?\\$?\\w*executable"

  # Start with /b flag (no window)
  - id: start-hidden
    desc: "Windows 'start /b' hidden background"
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "\\bstart\\s+/[bB]\\s"

  # Start with /min flag (minimized)
  - id: start-minimized
    desc: "Windows 'start /min' minimized process"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "\\bstart\\s+/min\\s"

  # PowerShell hidden window
  - id: powershell-hidden
    desc: "PowerShell hidden window execution"
    crit: suspicious
    conf: 0.9
    if:
      type: raw
      regex: "powershell.{0,50}-[Ww](indow)?[Ss](tyle)?\\s*[Hh]idden"

  # cmd.exe /c with start
  - id: cmd-start
    desc: "cmd.exe /c with background start"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "cmd(\\.exe)?\\s*/[cC]\\s+start"

composite_rules:
  # Background pip install on Windows (common malware pattern)
  - id: hidden-pip-install
    desc: "Background pip install via Windows"
    crit: suspicious
    conf: 0.95
    all:
      - id: start-hidden
      - id: cap/exec/autoinstall/pip::pip-install-pattern