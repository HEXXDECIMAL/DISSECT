# Obfuscated Windows Scripting Host (WSH) Detection
# Detects case-insensitive or obfuscated references to WSH objects
# Common in JScript/VBScript malware

defaults:
  crit: notable
  conf: 0.8
  platforms: [windows]
  for: [javascript, typescript]
  attack: "T1059.005"
  mbc: "E1059"

traits:
  - id: wscript-shell-obfuscated
    desc: Obfuscated WScript.Shell reference
    if:
      type: encoded
      regex: '(?i)WScript\.Shell|\{[^:]+:[''"]W[''"]\}\.[a-zA-Z0-9_$]+\+\{[^:]+:[''"]S[''"]\}'
    
  - id: activex-object-obfuscated
    desc: Obfuscated ActiveXObject creation
    if:
      type: encoded
      regex: '(?i)new\s+ActiveXObject|\{[^:]+:[''"]A[''"]\}\.[a-zA-Z0-9_$]+\+\{[^:]+:[''"]c[''"]\}'

  - id: wscript-network-obfuscated
    desc: Obfuscated WScript.Network reference
    if:
      type: encoded
      regex: "(?i)WScript\\.Network"

  - id: adodb-stream-obfuscated
    desc: Obfuscated ADODB.Stream reference
    if:
      type: encoded
      regex: '(?i)ADODB\.Stream|\{[^:]+:[''"]A[''"]\}\.[a-zA-Z0-9_$]+\+\{[^:]+:[''"]D[''"]\}'

  - id: xmlhttp-obfuscated
    desc: Obfuscated XMLHTTP reference
    if:
      type: encoded
      regex: '(?i)MSXML2\.ServerXMLHTTP|\{[^:]+:[''"]M[''"]\}\.[a-zA-Z0-9_$]+\+\{[^:]+:[''"]S[''"]\}'