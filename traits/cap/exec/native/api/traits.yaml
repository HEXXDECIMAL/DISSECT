# Native Code Execution
# Low-level process and code execution capabilities

defaults:
  for: ["pe", "dll"]
  platforms: ["windows"]

traits:
  # === Debugger Detection ===
  - id: debugger-detect-api
    desc: Windows IsDebuggerPresent check
    crit: notable
    conf: 0.95
    attack: "T1622"
    mbc: "B0001"
    if:
      type: symbol
      exact: "IsDebuggerPresent"
    # API set forwarder DLLs export this symbol but do not implement debugger checks.
    downgrade:
      any:
        - type: string
          substr: "ApiSet Stub DLL"

  - id: processor-feature-check
    desc: Check processor features
    crit: inert
    conf: 0.9
    if:
      type: symbol
      exact: "IsProcessorFeaturePresent"

  # === Dynamic Library Loading ===
  - id: load-library
    desc: Dynamic library loading via LoadLibrary
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "LoadLibrary"

  - id: load-library-a
    desc: Dynamic library loading via LoadLibraryA
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "LoadLibraryA"

  - id: load-library-w
    desc: Dynamic library loading via LoadLibraryW
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "LoadLibraryW"

  - id: load-library-ex
    desc: Extended dynamic library loading
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "LoadLibraryEx"

  - id: load-library-ex-a
    desc: Extended dynamic library loading (ANSI)
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "LoadLibraryExA"

  - id: load-library-ex-w
    desc: Extended dynamic library loading (Unicode)
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "LoadLibraryExW"

  - id: get-proc-address
    desc: Runtime function resolution
    crit: notable
    conf: 0.95
    if:
      type: symbol
      exact: "GetProcAddress"

  - id: get-module-handle
    desc: Module handle resolution
    crit: inert
    conf: 0.90
    if:
      type: symbol
      regex: "GetModuleHandle"

  # === Process Information Gathering ===
  - id: get-thread-id
    desc: Current thread ID retrieval
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "GetCurrentThreadId"

  # === System Time Access ===
  - id: system-time-filetime
    desc: System time as file time
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "GetSystemTimeAsFileTime"

  # === Memory Operations ===
  - id: heap-alloc
    desc: Heap memory allocation
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "HeapAlloc"

  - id: heap-realloc
    desc: Heap memory reallocation
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "HeapReAlloc"

  - id: get-process-heap
    desc: Get process heap handle
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "GetProcessHeap"

  # === Synchronization Primitives ===
  - id: critical-section-enter
    desc: Enter critical section
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "EnterCriticalSection"

  - id: critical-section-leave
    desc: Leave critical section
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "LeaveCriticalSection"

  - id: initialize-critical-section
    desc: Initialize critical section
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "InitializeCriticalSectionEx"

  # === Thread Local Storage ===
  - id: tls-alloc
    desc: Thread-local storage allocation
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "FlsAlloc"

  - id: tls-free
    desc: Thread-local storage deallocation
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "FlsFree"

  - id: tls-get-value
    desc: Thread-local storage retrieval
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "FlsGetValue"

  - id: tls-set-value
    desc: Thread-local storage assignment
    crit: inert
    conf: 0.90
    if:
      type: symbol
      exact: "FlsSetValue"

  # === Exception Handling ===
  - id: raise-exception
    desc: Raise structured exception
    crit: inert
    conf: 0.85
    if:
      type: symbol
      exact: "RaiseException"

  # === System Callback APIs (often used for stealthy execution) ===
  - id: enum-ui-languages
    desc: Enumerate UI languages (potential callback trigger)
    crit: inert
    conf: 0.95
    if:
      type: symbol
      regex: "^EnumUILanguages[AW]$"

  - id: enum-resource-types
    desc: Enumerate resource types (potential callback trigger)
    crit: inert
    conf: 0.95
    if:
      type: symbol
      regex: "^EnumResourceTypes[AW]$"

  - id: enum-resource-names
    desc: Enumerate resource names (potential callback trigger)
    crit: inert
    conf: 0.95
    if:
      type: symbol
      regex: "^EnumResourceNames[AW]$"

  - id: enum-desktop-windows
    desc: Enumerate desktop windows (potential callback trigger)
    crit: inert
    conf: 0.95
    if:
      type: symbol
      exact: "EnumDesktopWindows"

  - id: enum-date-formats
    desc: Enumerate date formats (potential callback trigger)
    crit: inert
    conf: 0.95
    if:
      type: symbol
      exact: "EnumDateFormatsA"

  - id: line-dda
    desc: LineDDA callback trigger
    crit: inert
    conf: 0.95
    if:
      type: symbol
      exact: "LineDDA"
