# PowerShell .NET Assembly Loading
# Detects reflective loading and execution of .NET assemblies within PowerShell
# MBC: B0024 (Execution), B0032 (Obfuscated Files or Information)
# ATT&CK: T1620 (Reflective Code Loading), T1059.001 (PowerShell)

defaults:
  for: [powershell, batch, shell]
  mbc: "B0024"
  attack: "T1620"

traits:
  # [System.Reflection.Assembly]::Load(...)
  - id: ps-assembly-load
    desc: Reflective assembly load
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: '(?i)\[System\.Reflection\.Assembly\]::Load\('

  # [System.Reflection.Assembly]::LoadWithPartialName(...)
  - id: ps-assembly-load-partial
    desc: Reflective assembly load with partial name
    crit: notable
    conf: 0.85
    if:
      type: raw
      regex: '(?i)\[System\.Reflection\.Assembly\]::LoadWithPartialName\('

  # Assembly EntryPoint Invocation
  - id: ps-assembly-invoke
    desc: Reflective assembly entry point invocation
    crit: suspicious
    conf: 0.95
    if:
      type: raw
      regex: '(?i)\.EntryPoint\.Invoke\('

  # [System.Convert]::FromBase64String(...)
  - id: ps-b64-decode
    desc: PowerShell Base64 decode
    crit: inert
    conf: 0.9
    if:
      type: raw
      regex: '(?i)\[System\.Convert\]::FromBase64String'

composite_rules:
  # [System.Convert]::FromBase64String(...) combined with assembly load
  - id: ps-decode-and-load
    desc: Base64 decode and assembly load
    crit: hostile
    conf: 0.95
    all:
      - id: ps-assembly-load
      - id: ps-b64-decode

  - id: ps-reflective-load
    desc: PowerShell reflective .NET loading
    crit: hostile
    conf: 0.98
    needs: 2
    any:
      - id: ps-assembly-load
      - id: ps-assembly-invoke
      - id: ps-decode-and-load