# Remote Code Evaluation - Python
# Detects eval/exec on data extracted from external sources
# ATT&CK: T1059.006 (Python), T1195.002 (Supply Chain)
# These patterns are strong indicators of supply-chain attacks

defaults:
  file_types: [python]
  attack: "T1059.006"

traits:
  # eval() on chained .get() calls - extracts nested value then executes
  # Pattern: eval(x.get(...).get(...).get(...))
  - id: eval-chained-get
    desc: eval on chained .get() calls
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    mbc: "E1059"
    if:
      type: content
      regex: "eval\\s*\\([^)]*\\.get\\s*\\([^)]*\\)\\s*\\.get\\s*\\("

  # eval() on single .get() with default - could be extracting from config
  - id: eval-dict-get
    desc: eval on dictionary .get()
    crit: notable
    conf: 0.8
    mbc: "E1059"
    if:
      type: content
      regex: "eval\\s*\\([^)]*\\.get\\s*\\([^)]*,[^)]*\\)\\s*\\)"

  # exec() on chained .get() calls
  - id: exec-chained-get
    desc: exec on chained .get() calls
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    mbc: "E1059"
    if:
      type: content
      regex: "exec\\s*\\([^)]*\\.get\\s*\\([^)]*\\)\\s*\\.get\\s*\\("

  # eval/exec on response/config object access
  - id: eval-config-access
    desc: eval on config/response field
    crit: suspicious
    conf: 0.9
    attack: "T1195.002"
    mbc: "E1059"
    if:
      type: content
      regex: "eval\\s*\\(\\s*(config|response|data|result|payload|body)\\s*[\\[\\.]"

  # Client config evaluation - ML/inference server pattern
  - id: eval-client-config
    desc: eval on client config value
    crit: suspicious
    conf: 0.9
    attack: "T1195.002"
    mbc: "E1059"
    if:
      type: content
      regex: "eval\\s*\\([^)]*client[^)]*\\.get"

  # Evaluate string_value field - common malicious config pattern
  - id: eval-string-value
    desc: eval on string_value field
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    mbc: "E1059"
    if:
      type: content
      regex: "eval\\s*\\([^)]*string_value"

  # eval/exec with bracket access on received data
  - id: eval-bracket-access
    desc: eval on bracket notation access
    crit: notable
    conf: 0.85
    mbc: "E1059"
    if:
      type: content
      regex: "eval\\s*\\([^)]*\\[[\"'][^\"']+[\"']\\]"

composite_rules:
  # Chained get with eval - strong supply chain indicator
  # Complexity: file_types(+1) + any(+1) + all(+2) = 4
  - id: remote-config-eval
    desc: Evaluates code from remote config
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    mbc: "E1059"
    file_types: [python]
    any:
      - id: eval-chained-get
      - id: exec-chained-get
    all:
      - id: obj/anti-static/obfuscation/payload/eval-function-call
      - id: cap/comm/http/request/url-literal

  # Config value evaluation with client reference
  # Complexity: file_types(+1) + all(+3) = 4
  - id: client-config-execution
    desc: Executes code from client config
    crit: hostile
    conf: 0.95
    attack: "T1195.002"
    mbc: "E1059"
    file_types: [python]
    all:
      - id: obj/anti-static/obfuscation/payload/eval-function-call
      - id: eval-dict-get
      - id: cap/comm/http/client

  # String value extraction and execution
  # Complexity: file_types(+1) + all(+2) + any(+1) = 4
  - id: config-string-execution
    desc: Executes extracted string_value
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    mbc: "E1059"
    file_types: [python]
    all:
      - id: obj/anti-static/obfuscation/payload/eval-function-call
      - id: eval-string-value
    any:
      - id: eval-chained-get
      - id: eval-config-access
