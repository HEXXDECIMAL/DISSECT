# Command Execution Detection
# MBC: OB0009 (Execution) â†’ E1059 (Command and Scripting Interpreter)
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  # C/C++ - Unix
  - id: c-system
    desc: Executes shell commands via C
    crit: notable
    mbc: "E1059.004"
    attack: "T1059.004"
    conf: 0.9
    if:
      type: symbol
      # Match only the actual system() function, not std::filesystem or other symbols
      regex: "^system$"
    platforms: [unix, linux, macos]
    for: [binaries]

  - id: c-popen
    desc: Executes command and captures output
    crit: notable
    mbc: "E1059.004"
    attack: "T1059.004"
    conf: 0.9
    if:
      type: symbol
      # Match only the actual popen() function
      regex: "^popen$"
    platforms: [unix, linux, macos]
    for: [binaries]

  - id: c-execve
    desc: Executes program directly via C
    crit: notable
    mbc: "E1059"
    attack: "T1059"
    conf: 0.95
    if:
      type: symbol
      regex: execve
    platforms: [unix, linux, macos]
    for: [binaries]

  # Windows
  - id: win-createprocess
    desc: Creates new process via Windows
    crit: notable
    mbc: "E1059.003"
    attack: "T1059.003"
    conf: 0.9
    if:
      type: symbol
      regex: CreateProcessA|CreateProcessW
    platforms: [windows]
    for: [pe, dll]

  - id: win-shellexecute
    desc: Executes file or program via
    crit: notable
    mbc: "E1059.003"
    attack: "T1059.003"
    conf: 0.9
    if:
      type: symbol
      regex: ShellExecuteA|ShellExecuteW|ShellExecuteExA|ShellExecuteExW
    platforms: [windows]
    for: [pe, dll]

  # Go
  - id: go-os-exec
    desc: Executes commands via Go os/exec
    crit: notable
    mbc: "E1059"
    attack: "T1059"
    conf: 0.9
    if:
      type: symbol
      regex: 'os/exec\..{0,50}'

  # Python
  - id: python-os-system
    desc: Executes shell commands via Python
    crit: notable
    mbc: "E1059.006"
    attack: "T1059.006"
    conf: 0.95
    for: [python]
    if:
      type: symbol
      exact: "os.system"

  # JavaScript
  - id: js-child-process
    desc: Executes commands via Node.js child_process
    crit: notable
    mbc: "E1059"
    attack: "T1059"
    conf: 0.9
    if:
      type: symbol
      regex: 'child_process\.(exec|spawn|fork).{0,50}'

  # Ruby
  - id: ruby-system
    desc: Executes commands via Ruby system()
    crit: notable
    mbc: "E1059"
    attack: "T1059"
    conf: 0.9
    for: [ruby]
    if:
      type: string
      regex: '\bsystem\([''\"]'

  # Rust
  - id: rust-command
    desc: Executes process via Rust std::process::Command
    crit: notable
    mbc: "E1059"
    attack: "T1059"
    conf: 0.9
    if:
      type: symbol
      regex: 'std::process::Command::.{0,50}'

  # Shell references
  - id: bin-sh
    desc: References /bin/sh (Bourne shell)
    crit: notable
    mbc: "E1059.004"
    attack: "T1059.004"
    conf: 0.6
    if:
      type: string
      substr: "/bin/sh"
    platforms: [unix, linux, macos]
    for: [binaries]

  - id: bin-bash
    desc: References /bin/bash (Bash shell)
    crit: notable
    mbc: "E1059.004"
    attack: "T1059.004"
    conf: 0.6
    if:
      type: string
      substr: "/bin/bash"
    platforms: [unix, linux, macos]
    for: [binaries]

  - id: cmd-exe
    desc: References cmd.exe (Windows Command Prompt)
    crit: notable
    mbc: "E1059.003"
    attack: "T1059.003"
    conf: 0.6
    if:
      type: string
      regex: 'cmd\.exe|cmd /c'
      case_insensitive: true
    platforms: [windows]

  # Behavioral Patterns
  - id: shell-platform-check
    desc: Checks OS type
    crit: notable
    conf: 0.8
    for: [shell]
    if:
      type: content
      regex: '$OSTYPE|linux-gnu|darwin|msys|cygwin'

  - id: curl-pipe-exec
    desc: One-liner download and execute
    crit: suspicious
    conf: 0.9
    for: [shell]
    if:
      type: content
      regex: 'curl.{0,50}\|.{0,50}(sudo\s+)?(python|bash|sh|node|php)'

  - id: sudo-piped-exec
    desc: Piped execution with sudo
    crit: suspicious
    conf: 0.9
    for: [shell]
    if:
      type: content
      regex: '\|\s*sudo\s+'

  # macOS open command to launch applications
  - id: open-a-app
    desc: macOS open -a application launch
    crit: notable
    conf: 0.8
    attack: "T1204.001"
    platforms: [macos]
    if:
      type: string
      regex: 'open -a \w+'