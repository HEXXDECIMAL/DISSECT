# Encoded Shell Command Detection
# GAP #3: Detects shell commands hidden in XOR, base64, hex, or other encodings
# Malware often encodes command strings to evade static analysis

defaults:
  for: [elf, macho, pe]
  platforms: [linux, macos, windows, unix]

traits:
  # XOR-encoded shell command indicators
  - id: xor-shell-command
    desc: "XOR-encoded shell command string"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    if:
      type: encoded
      encoding: xor
      regex: "\\b(bash|sh|cmd|powershell|popen|system|exec)\\b"
      case_insensitive: true

  # Base64-encoded shell commands
  - id: base64-shell-command
    desc: "Base64-encoded shell command"
    crit: suspicious
    conf: 0.85
    attack: "T1027"
    if:
      type: encoded
      encoding: base64
      regex: "\\b(bash|sh|cmd|powershell|wget|curl)\\b"
      case_insensitive: true

  # Any encoding type with shell patterns
  - id: encoded-shell-pattern
    desc: "Encoded shell command pattern"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    if:
      type: encoded
      regex: "\\b(popen|/bin/sh|/bin/bash)\\b"
      case_insensitive: true

  # Multiple encoded shell strings = deliberate obfuscation
  - id: multiple-encoded-shell
    desc: "Multiple encoded shell strings"
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    if:
      type: encoded
      encoding: [xor, base64, hex]
      regex: "\\b(sh|bash|cmd|exec)\\b"
      count_min: 3
      case_insensitive: true

  # Encoded command with common malware paths
  - id: encoded-tmp-exec
    desc: "Encoded /tmp execution path"
    crit: suspicious
    conf: 0.9
    attack: "T1027"
    if:
      type: encoded
      regex: "/tmp/[a-zA-Z0-9]+"
      count_min: 1

composite_rules:
  # Encoded shell commands + actual shell execution = obfuscated malware
  - id: obfuscated-shell-malware
    desc: "Obfuscated shell command malware"
    crit: suspicious
    conf: 0.95
    attack: "T1027"
    all:
      - id: cap/exec/command/shell::c-popen
    any:
      - id: xor-shell-command
      - id: encoded-shell-pattern
      - id: multiple-encoded-shell
    none:
      - id: meta/signed/platform::apple
