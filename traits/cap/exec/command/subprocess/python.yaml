# Python subprocess execution
# ATT&CK: T1059.006 (Python)

defaults:
  for: [python]
  attack: "T1059.006"

traits:
  # === Import patterns ===
  - id: import
    desc: subprocess module import
    crit: notable
    conf: 0.7
    mbc: "E1059.006"
    if:
      type: string
      regex: "import subprocess|from subprocess"

  # === String-based method detection ===
  # NOTE: popen removed - use popen-content (content type is broader)

  - id: run-call
    desc: subprocess.run call
    crit: notable
    conf: 0.75
    mbc: "E1059.006"
    if:
      type: string
      substr: "subprocess.run("

  - id: call
    desc: subprocess.call call
    crit: notable
    conf: 0.75
    mbc: "E1059.006"
    if:
      type: string
      substr: "subprocess.call("

  - id: check-output
    desc: subprocess.check_output call
    crit: notable
    conf: 0.75
    mbc: "E1059.006"
    if:
      type: string
      substr: "subprocess.check_output("

  # NOTE: check-call removed - use check-call-content (content type is broader)

  # === os.popen detection ===
  - id: os-popen
    desc: Executes command via os.popen
    crit: notable
    conf: 0.85
    mbc: "E1059.006"
    if:
      type: string
      substr: "os.popen("

  - id: os-popen-ast
    desc: Executes command via os.popen
    crit: notable
    conf: 0.9
    mbc: "C0017"
    if:
      type: ast
      query: |
        ((call
          function: (attribute
            object: (identifier) @mod
            attribute: (identifier) @meth))
         (#eq? @mod "os")
         (#eq? @meth "popen"))

  # === AST-based detection (more precise) ===
  - id: run-ast
    desc: "Executes external system command"
    crit: notable
    conf: 0.85
    mbc: "C0017"
    if:
      type: ast
      query: |
        ((call
          function: (attribute
            object: (identifier) @mod
            attribute: (identifier) @meth)
          arguments: (argument_list
            (string) @cmd))
         (#match? @mod "^subprocess$")
         (#match? @meth "^(Popen|run|call|check_output|check_call)$"))

  # === Content-based fallback ===
  # subprocess calls appear as code, not string literals, so string type misses them.
  # Content type matches raw file bytes.
  - id: popen-content
    desc: subprocess.Popen call (content)
    crit: notable
    conf: 0.75
    mbc: "E1059.006"
    if:
      type: content
      substr: "subprocess.Popen("

  - id: check-call-content
    desc: subprocess.check_call call (content)
    crit: notable
    conf: 0.75
    mbc: "E1059.006"
    if:
      type: content
      substr: "subprocess.check_call("

composite_rules:
  # All subprocess methods (string-based, AST-based, and content-based)
  - id: methods
    desc: subprocess module methods
    crit: notable
    conf: 0.75
    any:
      - id: popen-content
      - id: run-call
      - id: call
      - id: check-output
      - id: check-call-content
      - id: run-ast
