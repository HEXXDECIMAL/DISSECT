# Payload Execution Methods
# Detects various payload execution techniques
# ATT&CK: T1059 (Command Execution), T1106 (Native API)
# MBC: E1059 (Command Execution)

defaults:
  crit: suspicious
  attack: "T1059"
  mbc: "E1059"
  for: [python, shell]

traits:
  # === Copy Execution ===
  - id: cp-execute
    desc: cp command for execution
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: "cp\\s+-b|cp\\s+.{0,15}exec"

  # === Compiler Execution ===
  - id: gcc-compile-execute
    desc: gcc compile and execute
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "gcc.{0,20}-b|gcc.{0,20}compile.{0,10}exec"

  - id: compiler-payload-build
    desc: Compiler builds payload
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "(gcc|g\\+\\+|clang|cc).{0,15}\\.(c|cpp|o).{0,15}exec"

  # === Shell Execution ===
  - id: shell-execute-file
    desc: Shell executes file
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "shell=True.{0,20}exec|exec.{0,20}shell=True"

  - id: preexec-function
    desc: preexec_fn process isolation
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "preexec_fn=os\\.setpgrp|preexec_fn="

  # === macOS Open Command ===
  - id: macos-open-app
    desc: macOS open application
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "open.{0,10}-a.{0,10}\\.app|open.{0,10}\\.app"

  - id: open-command-execution
    desc: open command execution
    crit: suspicious
    conf: 0.75
    if:
      type: string
      regex: "\\['open'\\s*,|open\\s+-a"

  # === Hidden Execution Paths ===
  - id: hidden-dir-execution
    desc: Execute from hidden directory
    crit: suspicious
    conf: 0.90
    if:
      type: string
      regex: "\\/\\..{0,20}\\/.{0,20}exec|\\..{0,20}\\/exec"

  - id: dot-prefix-execution
    desc: Dot-prefixed execution path
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "\\..{0,10}[a-z]\\.[a-z]{2,}exec|exec\\..{0,10}[a-z]\\.[a-z]{2,}"

  # === Detached Execution ===
  - id: detached-process-exec
    desc: Detached process execution
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "DETACHED_PROCESS.{0,20}exec|exec.{0,20}DETACHED_PROCESS"

  - id: devnull-redirect
    desc: stdout/stderr to DEVNULL
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "DEVNULL.{0,20}stdout|stdout=.{0,20}DEVNULL"

composite_rules:
  # === Payload Execution ===
  - id: compiler-execution
    desc: Compile and execute payload
    crit: suspicious
    conf: 0.90
    attack: "T1059"
    needs: 1
    any:
      - id: gcc-compile-execute
      - id: compiler-payload-build
      - id: cp-execute

  - id: stealth-execution
    desc: Stealth payload execution
    crit: suspicious
    conf: 0.95
    attack: "T1059"
    mbc: "E1059"
    for: [python]
    needs: 2
    any:
      - id: preexec-function
      - id: detached-process-exec
      - id: devnull-redirect
      - id: hidden-dir-execution

  - id: macos-app-execution
    desc: macOS application execution
    crit: suspicious
    conf: 0.85
    attack: "T1106"
    platforms: [macos]
    needs: 1
    any:
      - id: macos-open-app
      - id: open-command-execution

  - id: advanced-payload-exec
    desc: Advanced payload execution
    crit: hostile
    conf: 0.98
    attack: "T1059"
    mbc: "E1059"
    platforms: [all]
    all:
      - id: compiler-execution
      - id: stealth-execution
