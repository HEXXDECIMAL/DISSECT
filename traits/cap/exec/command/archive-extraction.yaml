# Archive Extraction Detection
# Detects malware extracting and executing compressed payloads
# ATT&CK: T1105 (Ingress Tool Transfer), T1204 (User Execution)
# MBC: E1105 (Tool Transfer)

defaults:
  crit: suspicious
  attack: "T1105"
  mbc: "E1105"
  for: [python, shell, javascript]

traits:
  # === Tar Operations ===
  - id: tar-extract
    desc: tar archive extraction
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "tar\\s+(x|extract|xf|xzf|xvzf)"

  - id: tar-gzip-extract
    desc: tar.gz extraction command
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "tar.{0,10}gz|\\.tar\\.gz"

  - id: tar-execute
    desc: tar extract and execute
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "tar.{0,15}-C.{0,15}exec|extract.{0,15}exec"

  # === ZIP Operations ===
  - id: unzip-command
    desc: unzip archive extraction
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: "unzip\\s+-|extract.{0,15}\\.zip"

  - id: zipfile-module
    desc: Python zipfile module
    crit: notable
    conf: 0.70
    if:
      type: string
      substr: "zipfile"

  # === Archive Path Patterns ===
  - id: temp-archive-path
    desc: Temporary directory archive
    crit: notable
    conf: 0.65
    if:
      type: string
      regex: "(temp|tmp).{0,15}\\.(tar|zip|gz)"

  - id: hidden-archive-path
    desc: Hidden path archive extraction
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "\\/\\..{0,20}\\.(tar|gz|zip)"

  # === Extraction + Execution ===
  - id: extract-then-execute
    desc: Extract then execute pattern
    crit: suspicious
    conf: 0.90
    if:
      type: string
      regex: "(extract|unzip|tar).{0,50}(exec|run|open|subprocess)"

  - id: extract-to-temp
    desc: Extract payload to temp
    crit: suspicious
    conf: 0.80
    if:
      type: string
      regex: "(tempdir|gettempdir).{0,15}extract|extract.{0,15}tempdir"

composite_rules:
  # === Archive Extraction ===
  - id: archive-extraction
    desc: Archive extraction capability
    crit: notable
    conf: 0.75
    attack: "T1105"
    count_min: 2
    any:
      - id: tar-extract
      - id: tar-gzip-extract
      - id: unzip-command
      - id: zipfile-module

  - id: payload-extraction
    desc: Payload extraction behavior
    crit: suspicious
    conf: 0.85
    attack: "T1105"
    for: [python, shell]
    count_min: 2
    any:
      - id: temp-archive-path
      - id: hidden-archive-path
      - id: extract-to-temp
    all:
      - id: archive-extraction

  - id: extract-and-execute
    desc: Extract and execute payload
    crit: suspicious
    conf: 0.95
    attack: "T1204"
    mbc: "E1105"
    platforms: [all]
    count_min: 2
    all:
      - id: archive-extraction
      - id: extract-then-execute
