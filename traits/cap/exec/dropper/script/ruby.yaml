---
# Ruby malware dropper composite patterns

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === Ruby require strings (library imports) ===
  - id: net-http-single-quote
    desc: "'net/http' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "'net/http'"

  - id: net-http-double-quote
    desc: '"net/http" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: '"net/http"'

  - id: uri-single-quote
    desc: "'uri' require string"
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: "'uri'"

  - id: uri-double-quote
    desc: '"uri" require string'
    crit: inert
    conf: 0.6
    if:
      type: string
      exact: '"uri"'

  - id: base64-single-quote
    desc: "'base64' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "'base64'"

  - id: base64-double-quote
    desc: '"base64" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: '"base64"'

  - id: resolv-single-quote
    desc: "'resolv' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "'resolv'"

  - id: resolv-double-quote
    desc: '"resolv" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: '"resolv"'

  - id: socket-single-quote
    desc: "'socket' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      substr: "'socket'"

  - id: socket-double-quote
    desc: '"socket" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      substr: '"socket"'

  - id: tempfile-single-quote
    desc: "'tempfile' require string"
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "'tempfile'"

  - id: tempfile-double-quote
    desc: '"tempfile" require string'
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: '"tempfile"'

  - id: open-uri-single-quote
    desc: "'open-uri' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      substr: "'open-uri'"

  - id: open-uri-double-quote
    desc: '"open-uri" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      substr: '"open-uri"'

  - id: pty-single-quote
    desc: "'pty' require string"
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: "'pty'"

  - id: pty-double-quote
    desc: '"pty" require string'
    crit: inert
    conf: 0.75
    if:
      type: string
      exact: '"pty"'

  # === Base64 with Separator Obfuscation ===
  - id: base64-separator-obfuscation
    desc: Base64 with separator obfuscation
    crit: suspicious
    conf: 0.88
    attack: "T1027"
    if:
      type: raw
      regex: 'gsub\(.{0,10}"---"|\.gsub\(.{0,10}"---"|decode64.{0,50}gsub'

  # === Windows OS Check ===
  - id: windows-os-check
    desc: Windows OS platform check
    crit: notable
    conf: 0.70
    attack: "T1497"
    if:
      type: string
      regex: "mswin|msys|mingw|cygwin|bccwin|wince|emc|host_os.{0,50}match"

  # === VBS Script Writing ===
  - id: vbs-script-write
    desc: VBS script file creation
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    if:
      type: raw
      regex: 'File\.open\(.{0,50}\.vbs|\.vbs.{0,50}File\.open'

  # === WScript Execution ===
  - id: wscript-execution
    desc: WScript execution
    crit: notable
    conf: 0.85
    attack: "T1059"
    if:
      type: string
      regex: 'wscript|cscript|\.vbs'

composite_rules:
  # === Library require composites ===
  - id: ruby-require-net-http
    desc: Imports HTTP client library
    crit: notable
    conf: 0.80
    any:
      - id: net-http-single-quote
      - id: net-http-double-quote

  - id: ruby-require-uri
    desc: Imports URI parsing library
    crit: notable
    conf: 0.75
    any:
      - id: uri-single-quote
      - id: uri-double-quote

  - id: ruby-require-base64
    desc: Imports Base64 library
    crit: notable
    conf: 0.80
    any:
      - id: base64-single-quote
      - id: base64-double-quote

  - id: ruby-require-resolv
    desc: Imports DNS resolution library
    crit: notable
    conf: 0.80
    any:
      - id: resolv-single-quote
      - id: resolv-double-quote

  - id: ruby-require-socket
    desc: Imports socket library
    crit: notable
    conf: 0.85
    any:
      - id: socket-single-quote
      - id: socket-double-quote

  - id: ruby-require-tempfile
    desc: Imports temporary file library
    crit: notable
    conf: 0.80
    any:
      - id: tempfile-single-quote
      - id: tempfile-double-quote

  - id: ruby-require-open-uri
    desc: Imports Open-URI library
    crit: notable
    conf: 0.85
    any:
      - id: open-uri-single-quote
      - id: open-uri-double-quote

  - id: ruby-require-pty
    desc: Imports PTY (pseudo-terminal) library
    crit: notable
    conf: 0.85
    any:
      - id: pty-single-quote
      - id: pty-double-quote

  # === Dropper pattern composites ===
  - id: ruby-http-dropper
    desc: HTTP dropper downloads and executes
    conf: 0.95
    crit: suspicious
    needs: 3
    any:
      - id: cap/comm/http/request
      - id: cap/fs/write/file
      - id: cap/exec/command/shell

  - id: ruby-obfuscated-c2
    desc: Obfuscated C2 with Base64 and
    conf: 0.92
    crit: suspicious
    needs: 3
    any:
      - id: cap/data/encode/base64::base64-decode
      - id: cap/comm/dns/lookup::dns-resolve
      - id: cap/comm/http/lib/netlib::net-http
      - id: cap/comm/http/lib/netlib::http-get-method

  - id: ruby-tmp-execution
    desc: Write to /tmp, chmod, and execute
    conf: 0.93
    crit: suspicious
    needs: 3
    any:
      - id: cap/fs/write/file
      - id: cap/fs/chmod
      - id: cap/exec/command/shell
    downgrade:
      any:
        - id: meta/library::wal-shipper-header
        - id: meta/library::wal-shipper-config

  - id: ruby-reverse-shell
    desc: Reverse shell connection
    conf: 0.90
    crit: suspicious
    needs: 2
    any:
      - id: cap/comm/socket/listen::ruby-tcp-socket
      - id: cap/exec/command/shell
      - id: cap/process/tty/pty::ruby-pty
    downgrade:
      any:
        - id: meta/quality/testing::ruby-test-file

  - id: ruby-windows-vbs-dropper
    desc: Windows VBS payload dropper
    conf: 0.94
    crit: suspicious
    needs: 4
    any:
      - id: windows-os-check
      - id: base64-separator-obfuscation
      - id: vbs-script-write
      - id: wscript-execution
      - id: cap/exec/command/shell::ruby-system
      - id: cap/data/encode/base64::base64-decode
      - id: cap/data/encode/base64::decode64-symbol

  - id: ruby-binary-dropper
    desc: Downloads and writes binary payload
    conf: 0.94
    crit: notable
    needs: 2
    any:
      - id: cap/comm/http/lib/netlib::request-ruby
      - id: cap/fs/write/file::ruby-file-open-write-binary
