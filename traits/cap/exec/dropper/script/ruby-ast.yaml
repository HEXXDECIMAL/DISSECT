---
# Ruby AST-based behavioral detection patterns
# Uses AST patterns to detect suspicious Ruby code structures
# ATT&CK: T1059 (Command Execution), T1071 (Application Layer Protocol)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === HTTP Download in Method ===
  - id: ruby-ast-http-in-method
    desc: HTTP request inside method
    crit: notable
    conf: 0.88
    attack: "T1071"
    if:
      type: ast
      kind: call
      exact: "Net::HTTP.get_response"

  # === File Write with Binary Mode ===
  - id: ruby-ast-file-binmode-write
    desc: File binmode followed by write
    crit: notable
    conf: 0.85
    if:
      type: ast
      kind: call
      exact: ".binmode"

  # === File Chmod 777 ===
  - id: ruby-ast-chmod-777
    desc: File permission change to 777
    crit: notable
    conf: 0.90
    attack: "T1222"
    if:
      type: ast
      kind: call
      exact: ".chmod(0777)"

  # === Base64 Decode in DNS Resolution ===
  - id: ruby-ast-base64-dns
    desc: Base64 decode before DNS lookup
    crit: notable
    conf: 0.92
    attack: "T1027"
    if:
      type: ast
      kind: call
      exact: "Base64.decode64"

  # === System Execution in Method ===
  - id: ruby-ast-system-in-method
    desc: System command execution in method
    crit: notable
    conf: 0.88
    attack: "T1059"
    if:
      type: ast
      kind: call
      exact: "system("

  # === File Open Binary Write ===
  - id: ruby-ast-file-open-wb
    desc: File binary write mode
    crit: inert
    conf: 0.82
    if:
      type: ast
      query: |
        ((call
          receiver: (constant) @const
          method: (identifier) @method
          arguments: (argument_list
            (string) @mode))
         (#eq? @const "File")
         (#eq? @method "open")
         (#match? @mode "wb|w\\+b|ab|a\\+b"))

  # === File Rename ===
  - id: ruby-ast-file-rename
    desc: File rename operation
    crit: notable
    conf: 0.95
    if:
      type: ast
      query: |
        ((call
          receiver: (constant) @const
          method: (identifier) @method)
         (#eq? @const "File")
         (#eq? @method "rename"))

  # === File Rename Image to Exe ===
  - id: ruby-ast-rename-img-to-exe
    desc: Rename image file to executable
    crit: suspicious
    conf: 0.95
    if:
      type: ast
      query: |
        ((call
          receiver: (constant) @const
          method: (identifier) @method
          arguments: (argument_list
            (string) @source
            (string) @dest))
         (#eq? @const "File")
         (#eq? @method "rename")
         (#match? @source "\\.(png|jpg|jpeg|gif|bmp|ico|svg|webp)[\"']?$")
         (#match? @dest "\\.exe[\"']?$"))

  # === Windows OS Check (Regex) ===
  - id: ruby-ast-check-windows-regex
    desc: Check for Windows OS via regex
    crit: notable
    conf: 0.85
    if:
      type: ast
      query: |
        ((call
          method: (identifier) @method
          arguments: (argument_list (regex) @pattern))
         (#match? @pattern "mswin|mingw|cygwin|wince")
         (#eq? @method "match"))

  # === Host OS Configuration Access ===
  - id: ruby-ast-host-os-access
    desc: Access host OS configuration
    crit: notable
    conf: 0.9
    if:
      type: ast
      query: |
        ((element_reference
          object: (constant_resolution
            scope: (constant) @scope
            name: (constant) @name)
          index: (string) @key)
         (#eq? @scope "RbConfig")
         (#eq? @name "CONFIG")
         (#match? @key "host_os"))

composite_rules:
  # === Dropper Behavior via AST ===
  - id: ruby-ast-dropper-behavior
    desc: Dropper download write execute
    crit: suspicious
    conf: 0.93
    attack: "T1059"
    needs: 4
    any:
      - id: ruby-ast-http-in-method
      - id: ruby-ast-file-binmode-write
      - id: ruby-ast-chmod-777
      - id: ruby-ast-system-in-method
      - id: ruby-ast-file-open-wb

  # === Obfuscated C2 via AST ===
  - id: ruby-ast-obfuscated-c2
    desc: Base64 obfuscated C2 endpoint
    crit: suspicious
    conf: 0.91
    attack: "T1027"
    all:
      - id: ruby-ast-base64-dns
      - id: cap/comm/dns/lookup::dns-resolve
