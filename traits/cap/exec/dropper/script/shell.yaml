# Shell Dropper Detection
# Detects download-chmod-execute patterns common in supply chain attacks
# ATT&CK: T1059.004 (Command and Scripting Interpreter: Unix Shell)

defaults:
  # Shell command strings can be embedded in any language (subprocess, system(), etc.)
  for: [shell]

traits:
  - id: wget-download
    desc: "Download via wget"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: symbol
      exact: "wget"

  # === Wget output atomic indicators ===
  - id: wget-output-dash-O
    desc: "Wget with -O flag"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: string
      substr: " -O "

  - id: wget-output-document
    desc: "Wget with --output-document"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: string
      substr: "--output-document"

  # === Silent wget/curl to stdout (dropper pattern) ===
  - id: wget-silent-stdout
    desc: "Silent wget output to stdout"
    crit: suspicious
    conf: 0.9
    mbc: "C0002"
    attack: "T1105"
    if:
      type: content
      regex: 'wget\s+[^|&\n]*-q[^|&\n]*-O\s*-|wget\s+[^|&\n]*-O\s*-[^|&\n]*-q'

  - id: curl-silent-stdout
    desc: "Silent curl output to stdout"
    crit: notable
    conf: 0.9
    mbc: "C0002"
    attack: "T1105"
    # Small scripts using silent curl to stdout are more suspicious
    size_max: 5000
    if:
      type: content
      regex: 'curl\s+[^|&\n]*-s[^|&\n]*(https?://|ftp://)|curl\s+[^|&\n]*--silent[^|&\n]*(https?://|ftp://)'
      exclude_patterns:
        - "(?i)netbsd\\.org"
        - "(?i)freebsd\\.org"
        - "(?i)openbsd\\.org"
        - "(?i)dragonflybsd\\.org"
        - "(?i)kernel\\.org"
        - "(?i)github\\.com"
        - "(?i)google\\.com"

  - id: curl-download
    desc: "Download via curl"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: symbol
      exact: "curl"

  # === Curl output atomic indicators ===
  - id: curl-output-dash-o
    desc: "Curl with -o flag"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: string
      substr: " -o "

  - id: curl-output-flag
    desc: "Curl with --output"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: string
      substr: "--output"

  # === Execution patterns (content search for cross-line matching) ===
  - id: execute-dot-slash
    desc: "./ execution pattern"
    crit: inert
    conf: 0.5
    attack: "T1059.004"
    if:
      type: content
      regex: '\./[a-zA-Z0-9_.-]+'

  - id: execute-tmp-staging
    desc: "Execute from /tmp staging directory"
    crit: notable
    conf: 0.75
    attack: "T1059.004"
    if:
      type: content
      regex: '/(tmp|var/tmp|dev/shm)/[a-zA-Z0-9_.-]+'

  # === Dropper atomic patterns (content search) ===
  - id: curl-download-file
    desc: "curl downloading to file"
    crit: notable
    conf: 0.7
    mbc: "C0002"
    attack: "T1105"
    if:
      type: content
      regex: 'curl\s+[^|&\n]*\s+-o\s+'

  - id: chmod-plus-x-cmd
    desc: "chmod +x command"
    crit: notable
    conf: 0.7
    attack: "T1222"
    if:
      type: content
      regex: 'chmod\s+\+x'

  # === One-liner detection ===
  - id: oneliner-dropper-pattern
    desc: "Single-line curl+chmod+execute pattern"
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059.004"
    if:
      type: content
      regex: 'curl[^;\n]+;\s*chmod[^;\n]+;\s*/'

composite_rules:
  # Wget output file composite
  - id: wget-output-file
    desc: "Wget downloading to specific file"
    crit: notable
    conf: 0.8
    mbc: "C0002"
    attack: "T1105"
    needs: 1
    any:
      - id: wget-output-dash-O
      - id: wget-output-document

  # Curl output file composite
  - id: curl-output-file
    desc: "Curl downloading to file"
    crit: notable
    conf: 0.8
    mbc: "C0002"
    attack: "T1105"
    needs: 1
    any:
      - id: curl-output-dash-o
      - id: curl-output-flag

  # Tmp staging composite
  - id: tmp-staging
    desc: "/tmp staging directory usage"
    crit: suspicious
    conf: 0.8
    mbc: "C0047"
    attack: "T1074.001"
    needs: 1
    any:
      - id: cd-tmp
      - id: tmp-path

  - id: download-chmod-execute
    desc: "Download, chmod, and execute in"
    conf: 0.95
    crit: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux, macos]
    all:
      - id: wget-download
      - id: chmod-777
      - id: execute-dot-slash

  # Multi-line dropper pattern (suspicious)
  - id: curl-chmod-execute
    desc: "Download, chmod +x, and execute"
    conf: 0.9
    crit: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux, macos]
    all:
      - id: curl-download-file
      - id: chmod-plus-x-cmd
      - id: execute-tmp-staging

  # curl + chmod +x + ./ execute (suspicious - 3 conditions)
  - id: curl-chmod-dotslash
    desc: "Download, chmod +x, execute via ./"
    conf: 0.9
    crit: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    for: [shell]
    all:
      - id: curl-download-file
      - id: chmod-plus-x-cmd
      - id: execute-dot-slash

  # One-liner dropper (hostile)
  - id: oneliner-dropper
    desc: "One-liner download+chmod+execute pattern"
    conf: 0.98
    crit: hostile
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux, macos]
    all:
      - id: curl-download-file
      - id: chmod-plus-x-cmd
      - id: execute-tmp-staging
      - id: oneliner-dropper-pattern

  # MIPS architecture composite
  - id: iot-arch-mips
    desc: "MIPS architecture binary (IoT target)"
    crit: suspicious
    conf: 0.85
    needs: 1
    any:
      - id: mips-lower
      - id: mips-upper

  # MIPSEL architecture composite
  - id: iot-arch-mpsl
    desc: "MIPSEL architecture binary (IoT target)"
    crit: suspicious
    conf: 0.85
    needs: 1
    any:
      - id: mpsl-short
      - id: mipsel-lower
      - id: mipsel-upper

  - id: iot-multi-arch
    desc: "IoT botnet: multi-architecture payload dropper"
    conf: 0.95
    crit: suspicious
    mbc: "B0024"
    attack: "T1059.004"
    platforms: [linux]
    needs: 2
    any:
      - id: iot-arch-mips
      - id: iot-arch-arm
      - id: iot-arch-mpsl

  - id: tmp-staging-cleanup
    desc: "Payload staging in /tmp with"
    conf: 0.9
    crit: suspicious
    mbc: "C0047"
    attack: "T1074.001"
    platforms: [linux, macos]
    all:
      - id: tmp-staging
      - id: rm-rf-cleanup

  - id: hardcoded-c2-download
    desc: "Download from hardcoded C2 IP"
    conf: 0.95
    crit: suspicious
    mbc: "C0002"
    attack: "T1105"
    platforms: [linux, macos]
    all:
      - id: hardcoded-ip-url
      - id: wget-download
