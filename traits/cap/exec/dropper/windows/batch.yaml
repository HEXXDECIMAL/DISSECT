# Windows Batch Dropper Traits
# Detects malicious batch script patterns for downloading and executing payloads
# MBC: C0002 (Download), B0024 (Execution)
# ATT&CK: T1105 (Ingress Tool Transfer), T1059.003 (Windows Command Shell)

traits:
  # Download Patterns
  - id: curl-to-temp
    desc: Download to TEMP directory
    crit: suspicious
    conf: 0.9
    mbc: "C0002"
    attack: "T1074.001"
    for: [shell, batch]
    if:
      type: string
      regex: "%TEMP%|%TMP%|\\\\Temp\\\\"

  - id: powershell-download
    desc: PowerShell download cradle in batch
    crit: suspicious
    conf: 0.9
    mbc: "C0002"
    attack: "T1059.001"
    for: [shell, batch]
    if:
      type: string
      regex: "powershell.{0,50}DownloadFile|Invoke-WebRequest|iwr\\s|wget\\s"

  - id: certutil-download
    desc: Certutil download abuse (LOLBin technique)
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    if:
      type: string
      regex: "certutil\\s+.{0,50}-urlcache.{0,30}-split.{0,30}-f"

  - id: bitsadmin-download
    desc: BitsAdmin download abuse (LOLBin technique)
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    if:
      type: string
      regex: "bitsadmin\\s+.{0,50}\\/transfer"

  # Execution Patterns
  - id: start-hidden
    desc: Start process hidden (/B flag)
    crit: suspicious
    conf: 0.85
    mbc: "F0005"
    attack: "T1564"
    for: [shell, batch]
    if:
      type: string
      regex: "start\\s+[\"']?[\"']?\\s*/[Bb]"

  - id: temp-var
    desc: TEMP environment variable
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)%TEMP%|%TMP%"

  - id: exe-extension
    desc: .exe file reference
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\.exe"

  - id: start-cmd
    desc: start command
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bstart\\b"

  - id: run-from-temp
    desc: Execute binary from TEMP directory
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1059.003"
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)start[^\\n]*(%TEMP%|%TMP%)[^\\n]*\\.exe"

  # Persistence/Markers
  - id: done-marker
    desc: Execution marker file (run-once pattern)
    crit: notable
    conf: 0.75
    for: [shell, batch]
    if:
      type: string
      regex: "if exist.{0,30}\\.done|echo\\.>.{0,30}\\.done|\\.installed|\\.complete"

  # Evasion
  - id: echo-off
    desc: Echo off (hide command output)
    crit: inert
    conf: 0.6
    for: [shell, batch]
    if:
      type: string
      regex: "@echo\\s+off"

  - id: redirect-null
    desc: Redirect output to null (hide
    crit: notable
    conf: 0.7
    mbc: "F0005"
    for: [shell, batch]
    if:
      type: string
      regex: ">nul|2>nul|>NUL|2>&1"

  - id: delayed-expansion
    desc: Delayed expansion enabled (advanced scripting)
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      exact: "EnableDelayedExpansion"

  - id: curl-cmd
    desc: curl command
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bcurl\\b"

  - id: wget-cmd
    desc: wget command
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bwget\\b"

  - id: download-file-ps
    desc: PowerShell DownloadFile
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)DownloadFile"

  - id: certutil-cmd
    desc: certutil command
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bcertutil\\b"

  - id: bitsadmin-cmd
    desc: bitsadmin command
    crit: inert
    conf: 0.5
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bbitsadmin\\b"

  - id: output-flag
    desc: Output flag -o
    crit: inert
    conf: 0.4
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)-o\\b"

  - id: call-cmd
    desc: call command
    crit: inert
    conf: 0.4
    for: [shell, batch]
    if:
      type: string
      regex: "(?i)\\bcall\\b"

composite_rules:
  # Download tool composite
  - id: download-tool
    desc: Download tool usage
    crit: notable
    conf: 0.7
    for: [shell, batch]
    count_min: 1
    any:
      - id: curl-cmd
      - id: wget-cmd
      - id: download-file-ps
      - id: certutil-cmd
      - id: bitsadmin-cmd

  # Execute composite
  - id: exec-cmd
    desc: Execution command
    crit: notable
    conf: 0.6
    for: [shell, batch]
    count_min: 1
    any:
      - id: start-cmd
      - id: exe-extension
      - id: call-cmd

  # Download + Execute Combo
  - id: download-and-execute
    desc: Download and execute pattern (dropper
    crit: suspicious
    conf: 0.95
    mbc: "C0002"
    attack: "T1105"
    for: [shell, batch]
    all:
      - id: download-tool
      - id: exec-cmd
      - id: output-flag
