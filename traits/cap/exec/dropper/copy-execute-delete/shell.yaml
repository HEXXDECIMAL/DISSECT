# Copy-Execute-Delete Dropper Pattern Detection
# Detects shell scripts that copy a binary, execute it, then delete it
# ATT&CK: T1059.004 (Command and Scripting Interpreter: Unix Shell)
# MBC: B0024 (Software Stager), F0007 (Self Deletion)

defaults:
  for: [shell]
  crit: notable
  attack: "T1059.004"

traits:
  # === Copy to system directory patterns ===
  - id: cp-to-bin
    desc: Copy file to /bin directory
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1574.010"
    if:
      type: content
      regex: 'cp\s+[^|&;\n]+\s+/bin/[a-zA-Z0-9_.-]+'

  - id: cp-to-sbin
    desc: Copy file to /sbin directory
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1574.010"
    if:
      type: content
      regex: 'cp\s+[^|&;\n]+\s+/sbin/[a-zA-Z0-9_.-]+'

  - id: cp-to-usr-bin
    desc: Copy file to /usr/bin directory
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1574.010"
    if:
      type: content
      regex: 'cp\s+[^|&;\n]+\s+/usr/(s?bin|local/s?bin)/[a-zA-Z0-9_.-]+'

  - id: cp-force-flag
    desc: Copy with force overwrite
    crit: inert
    conf: 0.5
    if:
      type: content
      regex: 'cp\s+(-[a-z]*f|-f\s)'

  # === Execute from system directory ===
  - id: exec-bin-absolute
    desc: Execute binary from /bin
    crit: notable
    conf: 0.7
    attack: "T1059.004"
    if:
      type: content
      regex: '(?:^|&&|\|\||;)\s*/bin/[a-zA-Z0-9_.-]+(?:\s|$|>|&|;)'

  - id: exec-sbin-absolute
    desc: Execute binary from /sbin
    crit: notable
    conf: 0.7
    attack: "T1059.004"
    if:
      type: content
      regex: '(?:^|&&|\|\||;)\s*/sbin/[a-zA-Z0-9_.-]+(?:\s|$|>|&|;)'

  # === Delete after execution ===
  - id: rm-after-exec
    desc: Delete file following execution
    crit: suspicious
    conf: 0.8
    mbc: "F0007"
    attack: "T1070.004"
    if:
      type: content
      regex: '&&\s*rm\s+(-[a-z]+\s+)*(/bin/|/sbin/|/usr/)'

  - id: rm-bin-path
    desc: Delete file in /bin directory
    crit: suspicious
    conf: 0.75
    mbc: "F0007"
    attack: "T1070.004"
    if:
      type: content
      regex: 'rm\s+(-[a-z]+\s+)*(--\s+)?/bin/[a-zA-Z0-9_.-]+'

  - id: rm-sbin-path
    desc: Delete file in /sbin directory
    crit: suspicious
    conf: 0.75
    mbc: "F0007"
    attack: "T1070.004"
    if:
      type: content
      regex: 'rm\s+(-[a-z]+\s+)*(--\s+)?/sbin/[a-zA-Z0-9_.-]+'

  # === Combined patterns ===
  - id: cp-and-rm-chain
    desc: Copy then remove chain
    crit: suspicious
    conf: 0.85
    mbc: "B0024"
    attack: "T1059.004"
    if:
      type: content
      regex: 'cp\s+[^|&;\n]+&&[^;]*rm\s+'

  - id: exec-and-rm-chain
    desc: Execute then remove chain
    crit: suspicious
    conf: 0.85
    mbc: "F0007"
    attack: "T1070.004"
    if:
      type: content
      regex: '/(?:bin|sbin|usr/(?:local/)?(?:s?bin))/[a-zA-Z0-9_.-]+[^;]*&&[^;]*rm\s+'

composite_rules:
  # Copy to any system bin directory
  - id: copy-to-system-bin
    desc: Copy file to system bin directory
    crit: suspicious
    conf: 0.9
    mbc: "B0024"
    attack: "T1574.010"
    count_min: 1
    any:
      - id: cp-to-bin
      - id: cp-to-sbin
      - id: cp-to-usr-bin

  # Delete from system bin directory
  - id: delete-from-system-bin
    desc: Delete file from system bin directory
    crit: suspicious
    conf: 0.85
    mbc: "F0007"
    attack: "T1070.004"
    count_min: 1
    any:
      - id: rm-bin-path
      - id: rm-sbin-path

  # Copy-execute-delete shell dropper (HOSTILE)
  # complexity = file_types(1) + all(3) = 4
  - id: shell-dropper
    desc: Copy-execute-delete shell dropper
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    attack: "T1059.004"
    r#for: [shell]
    all:
      - id: copy-to-system-bin
      - id: exec-and-rm-chain
      - id: delete-from-system-bin
