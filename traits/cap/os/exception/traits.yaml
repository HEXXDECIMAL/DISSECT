# Exception Handling and Stack Unwinding
# Low-level exception and stack manipulation

defaults:
  for: ["pe", "dll"]
  platforms: ["windows"]

traits:
  # === Context Capture ===
  - id: capture-context
    desc: Capture CPU context/registers
    crit: notable
    conf: 0.90
    attack: "T1005"
    if:
      type: symbol
      exact: "RtlCaptureContext"

  # === Function Entry Lookup ===
  - id: lookup-function-entry
    desc: Lookup function entry point
    crit: notable
    conf: 0.85
    attack: "T1006"
    if:
      type: symbol
      exact: "RtlLookupFunctionEntry"

  # === Stack Unwinding ===
  - id: virtual-unwind
    desc: Virtual unwind stack frame
    crit: notable
    conf: 0.90
    attack: "T1006"
    if:
      type: symbol
      exact: "RtlVirtualUnwind"

  - id: unwind-ex
    desc: Extended stack unwinding
    crit: notable
    conf: 0.90
    attack: "T1006"
    if:
      type: symbol
      exact: "RtlUnwindEx"

  # === File Header Lookup ===
  - id: pc-to-file-header
    desc: Get module from code address
    crit: notable
    conf: 0.85
    attack: "T1005"
    if:
      type: symbol
      exact: "RtlPcToFileHeader"

  # === System Information Query ===
  - id: query-system-information
    desc: Query system information
    crit: suspicious
    conf: 0.85
    attack: "T1082"
    mbc: "C0046"
    if:
      type: symbol
      exact: "NtQuerySystemInformation"
