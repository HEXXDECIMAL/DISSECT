# Environment Variable Access
# MBC: C0034 (Environment Variable)
# ATT&CK: T1082 (System Information Discovery)

defaults:
  for: [elf, macho, so, dylib, c]

traits:
  - id: getenv
    desc: getenv function (read environment variable)
    crit: notable
    conf: 0.3
    if:
      type: symbol
      regex: "getenv"
    # Reading env vars is completely normal for system libs, video drivers, etc.
    downgrade:
      any:
        - id: cap/exec/load/video-lib-marker
        - id: cap/exec/load/graphics-lib-marker
        - id: cap/exec/load/system-lib-marker

  - id: setenv
    desc: setenv function (set environment variable)
    crit: inert
    conf: 0.4
    if:
      type: symbol
      regex: "setenv"

  - id: putenv
    desc: putenv function (modify environment variable)
    crit: inert
    conf: 0.4
    if:
      type: symbol
      regex: "putenv"

  - id: unsetenv
    desc: unsetenv function (remove environment variable)
    crit: inert
    conf: 0.4
    if:
      type: symbol
      regex: "unsetenv"

  - id: environ-global
    desc: environ global variable access
    crit: notable
    conf: 0.3
    if:
      type: symbol
      regex: "environ"

composite_rules:
  - id: env-access
    desc: Environment variable access functions
    crit: notable
    conf: 0.4
    needs: 1
    any:
      - id: getenv
      - id: setenv
      - id: putenv
      - id: unsetenv
    downgrade:
      any:
        - id: cap/exec/load/video-lib-marker
        - id: cap/exec/load/graphics-lib-marker
        - id: cap/exec/load/system-lib-marker

  - id: set
    desc: Environment variable modification
    crit: notable
    conf: 0.5
    needs: 1
    any:
      - id: setenv
      - id: putenv
      - id: unsetenv
