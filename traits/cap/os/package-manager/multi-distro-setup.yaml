# Multi-Distribution Package Manager Targeting
# Detects malware that adapts to multiple Linux distributions
# Indicates sophisticated distribution-agnostic attack preparation
# ATT&CK: T1195.001 (Supply Chain Compromise), T1072 (Software Deployment Tools)

traits:
  # === Package Manager Detection ===
  - id: apt-get-available
    desc: Check for apt-get availability
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "which apt-get"
    notes: "Debian/Ubuntu package manager check"

  - id: yum-available
    desc: Check for yum availability
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "which yum"
    notes: "RedHat/CentOS package manager check"

  - id: dnf-available
    desc: Check for dnf availability
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "which dnf"
    notes: "Fedora/RHEL 8+ package manager check"

  # === Sudo Installation Patterns ===
  - id: apt-install-sudo
    desc: apt-get install sudo
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "apt-get install -y sudo"
    notes: "Ensures sudo is installed on Debian systems"
    attack: "T1548.004"

  - id: yum-install-sudo
    desc: yum install sudo
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "yum install -y sudo"
    notes: "Ensures sudo is installed on RedHat systems"
    attack: "T1548.004"

  - id: dnf-install-sudo
    desc: dnf install sudo
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "dnf install -y sudo"
    notes: "Ensures sudo is installed on Fedora/RHEL 8+ systems"
    attack: "T1548.004"

  # === Multi-Distro Patterns ===
  - id: multi-distro-detection
    desc: Checks for multiple package managers
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "apt-get"
        - substr: "yum"
        - substr: "dnf"
    notes: "Detection of multiple Linux distribution types"

  - id: conditional-install
    desc: Conditional installation based on availability
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: ">/dev/null 2>&1 &&"
    notes: "Typical pattern for conditional command execution"

composite_rules:
  - id: apt-distro-targeting
    desc: apt-based distribution targeting
    any:
      - id: apt-get-available
      - id: apt-install-sudo

  - id: yum-distro-targeting
    desc: yum-based distribution targeting
    any:
      - id: yum-available
      - id: yum-install-sudo

  - id: dnf-distro-targeting
    desc: dnf-based distribution targeting
    any:
      - id: dnf-available
      - id: dnf-install-sudo

  - id: all-distros-targeted
    desc: All three major package manager families
    any:
      - id: apt-distro-targeting
      - id: yum-distro-targeting
      - id: dnf-distro-targeting

  - id: multi-distro-sudo-deployment
    desc: Multi-distribution sudo deployment
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1548.004"
    notes: |
      Malware deploys sudo across multiple Linux distributions.
      Indicates privilege escalation preparation.
      Suggests malware targets diverse environments.
    all:
      - id: conditional-install
      - id: all-distros-targeted
        count_min: 2

  - id: distribution-agnostic-attack
    desc: Distribution-agnostic attack infrastructure
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1195.001"
    notes: |
      Malware implements cross-distribution payload deployment.
      Pattern indicates sophisticated attackers:
      - Adapt to multiple Linux variants
      - Prepare infrastructure across platforms
      - Indicate planned mass deployment

      Common in botnet/worm-class malware.
    all:
      - id: multi-distro-detection
      - id: all-distros-targeted
        count_min: 2

  - id: kinsing-multi-distro-setup
    desc: Kinsing multi-distribution setup
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1548.004"
    notes: |
      Kinsing implements cross-distribution privilege escalation.
      Deploys sudo across:
      - Debian/Ubuntu systems (apt-get)
      - RedHat/CentOS systems (yum)
      - Fedora/RHEL 8+ systems (dnf)

      Indicates botnet designed for mass deployment.
    all:
      - id: kinsing-identifier
      - id: multi-distro-sudo-deployment
