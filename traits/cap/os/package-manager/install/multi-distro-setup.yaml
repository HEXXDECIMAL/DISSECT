# Multi-Distribution Package Manager Targeting
# Detects malware that adapts to multiple Linux distributions
# Indicates sophisticated distribution-agnostic attack preparation
# ATT&CK: T1195.001 (Supply Chain Compromise), T1072 (Software Deployment Tools)

traits:
  # === Package Manager Detection ===
  - id: apt-get-available
    desc: Check for apt-get availability
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "which apt-get"

  - id: yum-available
    desc: Check for yum availability
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "which yum"

  - id: dnf-available
    desc: Check for dnf availability
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "which dnf"

  # === Sudo Installation Patterns ===
  - id: apt-install-sudo
    desc: apt-get install sudo
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "apt-get install -y sudo"
    attack: "T1548.004"

  - id: yum-install-sudo
    desc: yum install sudo
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "yum install -y sudo"
    attack: "T1548.004"

  - id: dnf-install-sudo
    desc: dnf install sudo
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "dnf install -y sudo"
    attack: "T1548.004"

  # === Multi-Distro Patterns ===
  - id: multi-distro-apt-get-ref
    desc: apt-get reference
    crit: inert
    conf: 0.6
    for: [elf, shell]
    size_max: 1000000
    if:
      type: string
      substr: "apt-get"
    unless:
      - type: raw
        regex: "postgresql|libc|libgcc|libstdc\\+\\+"

  - id: multi-distro-yum-ref
    desc: yum reference
    crit: inert
    conf: 0.6
    for: [elf, shell]
    size_max: 1000000
    if:
      type: string
      substr: "yum"
    unless:
      - type: raw
        regex: "postgresql|libc|libgcc|libstdc\\+\\+"

  - id: multi-distro-dnf-ref
    desc: dnf reference
    crit: inert
    conf: 0.6
    for: [elf, shell]
    size_max: 1000000
    if:
      type: string
      substr: "dnf"
    unless:
      - type: raw
        regex: "postgresql|libc|libgcc|libstdc\\+\\+"

  - id: conditional-install-which
    desc: which-based conditional installation
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      regex: "which\\s+(apt-get|yum|dnf)\\s+.{0,50}>/dev/null.{0,80}&&\\s*(apt-get|yum|dnf)"

  - id: conditional-install-command
    desc: command -v conditional installation
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      regex: "command\\s+-v\\s+(apt-get|yum|dnf)\\s+.{0,50}>/dev/null.{0,80}&&\\s*(apt-get|yum|dnf)"

  - id: conditional-install-type
    desc: type-based conditional installation
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      regex: "type\\s+(apt-get|yum|dnf)\\s+.{0,50}>/dev/null.{0,80}&&\\s*(apt-get|yum|dnf)"

composite_rules:
  - id: multi-distro-detection
    desc: Checks for multiple package managers
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    needs: 2
    any:
      - id: multi-distro-apt-get-ref
      - id: multi-distro-yum-ref
      - id: multi-distro-dnf-ref

  - id: conditional-install
    desc: Conditional installation based on availability
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    any:
      - id: conditional-install-which
      - id: conditional-install-command
      - id: conditional-install-type

  - id: apt-distro-targeting
    desc: apt-based distribution targeting
    any:
      - id: apt-get-available
      - id: apt-install-sudo

  - id: yum-distro-targeting
    desc: yum-based distribution targeting
    any:
      - id: yum-available
      - id: yum-install-sudo

  - id: dnf-distro-targeting
    desc: dnf-based distribution targeting
    any:
      - id: dnf-available
      - id: dnf-install-sudo

  - id: all-distros-targeted
    desc: All three major package manager families
    any:
      - id: apt-distro-targeting
      - id: yum-distro-targeting
      - id: dnf-distro-targeting

  - id: multi-distro-sudo-deployment
    desc: Multi-distribution sudo deployment
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1548.004"
    all:
      - id: conditional-install
      - id: all-distros-targeted
        needs: 2

  - id: distribution-agnostic-attack
    desc: Distribution-agnostic attack infrastructure
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1195.001"
    all:
      - id: multi-distro-detection
      - id: all-distros-targeted
        needs: 2

  - id: kinsing-multi-distro-setup
    desc: Kinsing multi-distribution setup
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1548.004"
    all:
      - id: known/malware/miner/kinsing-enhanced::kinsing-identifier
      - id: multi-distro-sudo-deployment
