# BPF/eBPF Detection Patterns
# Can be both legitimate (tracing) and malicious (backdoors)

traits:
  # === BPF Socket Attachment ===
  - id: so-attach-filter
    desc: SO_ATTACH_FILTER socket option
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "SO_ATTACH_FILTER"

  - id: so-attach-bpf
    desc: SO_ATTACH_BPF socket option
    crit: notable
    conf: 0.7
    if:
      type: string
      exact: "SO_ATTACH_BPF"

  # === Raw Packet Capture ===
  - id: af-packet
    desc: AF_PACKET raw socket
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "AF_PACKET"

  - id: sock-raw
    desc: SOCK_RAW socket type
    crit: notable
    conf: 0.6
    if:
      type: string
      exact: "SOCK_RAW"

  # === Magic/Trigger Packet Patterns ===
  - id: magic-packet
    desc: magic_packet string
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "magic_packet"

  - id: trigger-packet
    desc: trigger_packet string
    crit: suspicious
    conf: 0.8
    if:
      type: string
      exact: "trigger_packet"

  - id: knock-string
    desc: knock string reference
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      # Match port knocking context, not generic "knock" word
      # Require explicit port/network context to avoid game/UI false positives
      regex: "(?i)(?:port[_-]?knock(?:ing|er|s)?|knock[_-]?(?:sequence|packet|daemon|port)|(?:tcp|udp)[_-]?knock)"

  - id: port-knock
    desc: port_knock string
    crit: suspicious
    conf: 0.75
    if:
      type: string
      exact: "port_knock"

  - id: sequence-string
    desc: knock sequence string reference
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "\\b(knock|port|packet)[_-]?sequence\\b"
      case_insensitive: true

  # === BPFDoor-style Components ===
  - id: bpf-program
    desc: bpf_program struct
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      exact: "bpf_program"

  - id: bpf-prefix
    desc: BPF_ prefix
    crit: inert
    conf: 0.4
    for: [elf, c]
    if:
      type: string
      exact: "BPF_"

  # NOTE: Changed from "pcap_" prefix to actual pcap function names.
  # The bare prefix can match unrelated strings in binaries.
  - id: pcap-prefix
    desc: pcap library function reference
    crit: inert
    conf: 0.5
    for: [elf, c]
    if:
      type: symbol
      # Match actual pcap API functions, not just the prefix
      pattern: "pcap_(?:open_live|compile|setfilter|loop|next|close|findalldevs|lookupdev)"

  - id: recvfrom-fn
    desc: recvfrom function
    crit: inert
    conf: 0.3
    for: [elf, c]
    if:
      type: symbol
      pattern: "recvfrom"

  # NOTE: dup2 and execve are defined in their canonical locations:
  # - cap/process/fd/dup2
  # - cap/exec/command/shell/c-execve
  # Composite rules below reference them using full paths.

  - id: ipproto-icmp
    desc: IPPROTO_ICMP protocol
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      exact: "IPPROTO_ICMP"

  - id: ipproto-udp
    desc: IPPROTO_UDP protocol
    crit: inert
    conf: 0.3
    for: [elf, c]
    if:
      type: string
      exact: "IPPROTO_UDP"

  # === Legitimate eBPF Tracing ===
  - id: bpftrace
    desc: bpftrace framework
    crit: benign
    conf: 0.85
    if:
      type: string
      exact: "bpftrace"

  - id: bcc-lib
    desc: BCC library
    crit: benign
    conf: 0.85
    if:
      type: string
      # Require "bcc" as a word boundary to avoid matching partial strings
      regex: "\\bbcc(?:_|/|\\s|$)"

  - id: libbpf
    desc: libbpf library
    crit: benign
    conf: 0.85
    if:
      type: string
      exact: "libbpf"

  - id: bpf-probe-read
    desc: bpf_probe_read function
    crit: benign
    conf: 0.8
    if:
      type: symbol
      pattern: "bpf_probe_read"

  - id: bpf-kprobe
    desc: bpf_kprobe function
    crit: benign
    conf: 0.8
    if:
      type: string
      exact: "bpf_kprobe"

  - id: bpf-tracepoint
    desc: bpf_tracepoint function
    crit: benign
    conf: 0.8
    if:
      type: string
      exact: "bpf_tracepoint"

  - id: cilium
    desc: Cilium observability
    crit: benign
    conf: 0.9
    if:
      type: string
      exact: "cilium"

  - id: falco
    desc: Falco security
    crit: benign
    conf: 0.9
    if:
      type: string
      exact: "falco"

  - id: tracee
    desc: Tracee observability
    crit: benign
    conf: 0.9
    if:
      type: string
      exact: "tracee"

composite_rules:
  # BPF attachment helper
  - id: bpf-attachment
    desc: BPF filter attachment
    crit: notable
    conf: 0.7
    count_min: 1
    any:
      - id: so-attach-filter
      - id: so-attach-bpf

  # Raw socket helper
  - id: raw-socket
    desc: Raw packet socket
    crit: notable
    conf: 0.6
    count_min: 1
    any:
      - id: af-packet
      - id: sock-raw

  # Magic/knock patterns helper
  - id: magic-knock-patterns
    desc: Magic packet or port knock
    crit: suspicious
    conf: 0.75
    count_min: 1
    any:
      - id: magic-packet
      - id: trigger-packet
      - id: knock-string
      - id: port-knock
      - id: sequence-string

  # BPF backdoor (migrated from YARA)
  - id: backdoor
    desc: BPF packet filtering for backdoor
    crit: suspicious
    conf: 0.8
    attack: "T1205"
    all:
      - id: bpf-attachment
      - id: raw-socket
      - id: magic-knock-patterns

  # BPF packet inspection helper
  # NOTE: Require at least 2 indicators to avoid false positives.
  # Individual functions like recvfrom are common in networking code.
  - id: bpf-packet-inspection
    desc: BPF packet inspection components
    crit: notable
    conf: 0.6
    for: [elf, c]
    count_min: 2
    any:
      - id: bpf-program
      - id: bpf-prefix
      - id: pcap-prefix
      - id: recvfrom-fn

  # Shell activation helper
  # NOTE: dup2 + execve is extremely common in legitimate programs.
  # Only suspicious in context of /bin/sh execution with fd redirection.
  - id: shell-activation
    desc: Shell execution components
    crit: inert
    conf: 0.6
    for: [elf, c]
    all:
      - id: cap/exec/command/shell/generic/bin-sh
    count_min: 1
    any:
      - id: cap/process/fd/dup2
      - id: cap/exec/command/shell/c-execve

  # Protocol trigger helper
  - id: protocol-trigger
    desc: ICMP/UDP protocol triggers
    crit: inert
    conf: 0.6
    for: [elf, c]
    count_min: 1
    any:
      - id: ipproto-icmp
      - id: ipproto-udp

  # BPFDoor-style helper
  # Requires both shell activation AND protocol trigger to be suspicious
  - id: bpfdoor-activation
    desc: BPFDoor activation components
    crit: notable
    conf: 0.85
    for: [elf, c]
    all:
      - id: shell-activation
      - id: protocol-trigger

  # BPFDoor-style backdoor (migrated from YARA)
  - id: bpfdoor-style
    desc: BPFDoor-style packet filter backdoor
    crit: suspicious
    conf: 0.9
    attack: "T1205"
    for: [elf, c]
    all:
      - id: bpf-packet-inspection
      - id: bpfdoor-activation

  # Tracing frameworks helper
  - id: tracing-frameworks
    desc: eBPF tracing frameworks
    crit: benign
    conf: 0.85
    count_min: 1
    any:
      - id: bpftrace
      - id: bcc-lib
      - id: libbpf

  # Tracing functions helper
  - id: tracing-functions
    desc: eBPF tracing functions
    crit: benign
    conf: 0.8
    count_min: 1
    any:
      - id: bpf-probe-read
      - id: bpf-kprobe
      - id: bpf-tracepoint

  # Observability tools helper
  - id: observability-tools
    desc: eBPF observability tools
    crit: benign
    conf: 0.9
    count_min: 1
    any:
      - id: cilium
      - id: falco
      - id: tracee

  # Legitimate eBPF tracing (migrated from YARA)
  - id: tracing
    desc: Legitimate eBPF tracing/observability
    crit: benign
    conf: 0.85
    count_min: 1
    any:
      - id: tracing-frameworks
      - id: tracing-functions
      - id: observability-tools
