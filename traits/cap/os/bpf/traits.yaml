# BPF/eBPF Detection Patterns
# Can be both legitimate (tracing) and malicious (backdoors)

traits:
  # === eBPF Development Headers ===
  # CO-RE (Compile Once - Run Everywhere) BTF header for kernel data structures
  - id: vmlinux-h
    desc: vmlinux.h CO-RE eBPF header
    crit: notable
    conf: 0.8
    for: [c]
    if:
      type: string
      substr: "vmlinux.h"

  # eBPF helper functions header (libbpf)
  - id: bpf-helpers-h
    desc: bpf/bpf_helpers.h include
    crit: notable
    conf: 0.85
    for: [c]
    if:
      type: content
      substr: "bpf/bpf_helpers.h"

  # SEC("license") declaration - required for BPF programs
  - id: sec-license
    desc: eBPF license section declaration
    crit: notable
    conf: 0.8
    for: [c]
    if:
      type: content
      regex: 'SEC\s*\(\s*"license'

  # === Network Packet Manipulation Helpers ===
  # Checksum manipulation for packet modification
  - id: csum-helper
    desc: Checksum helper function
    crit: notable
    conf: 0.75
    for: [c]
    if:
      type: content
      regex: "csum_(?:fold|replace|update|diff)"

  # Ethernet address swap macro/function
  - id: eth-swap
    desc: Ethernet address swap macro
    crit: notable
    conf: 0.8
    for: [c]
    if:
      type: content
      substr: "eth_swap"

  # ETH_ALEN constant (6 bytes for MAC address)
  - id: eth-alen
    desc: ETH_ALEN Ethernet address length
    crit: inert
    conf: 0.6
    for: [c]
    if:
      type: content
      substr: "ETH_ALEN"

  # Network byte order conversion (packet parsing)
  - id: ntohs-bswap
    desc: Network byte order conversion
    crit: inert
    conf: 0.5
    for: [c]
    if:
      type: content
      regex: "(?:ntohs|htons|ntohl|htonl|__builtin_bswap(?:16|32|64))"


  # === BPF Socket Attachment ===
  - id: so-attach-filter
    desc: SO_ATTACH_FILTER socket option
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "SO_ATTACH_FILTER"

  - id: so-attach-bpf
    desc: SO_ATTACH_BPF socket option
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "SO_ATTACH_BPF"

  # === Raw Packet Capture ===
  - id: af-packet
    desc: AF_PACKET raw socket
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "AF_PACKET"

  - id: sock-raw
    desc: SOCK_RAW socket type
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "SOCK_RAW"

  # === Magic/Trigger Packet Patterns ===
  - id: magic-packet
    desc: magic_packet string
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "magic_packet"

  - id: trigger-packet
    desc: trigger_packet string
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "trigger_packet"

  - id: knock-string
    desc: knock string reference
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      # Match port knocking context, not generic "knock" word
      # Require explicit port/network context to avoid game/UI false positives
      regex: "(?i)(?:port[_-]?knock(?:ing|er|s)?|knock[_-]?(?:sequence|packet|daemon|port)|(?:tcp|udp)[_-]?knock)"

  - id: port-knock
    desc: port_knock string
    crit: suspicious
    conf: 0.75
    if:
      type: string
      substr: "port_knock"

  - id: sequence-string
    desc: knock sequence string reference
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "\\b(knock|port|packet)[_-]?sequence\\b"
      case_insensitive: true

  # === BPFDoor-style Components ===
  - id: bpf-program
    desc: bpf_program struct
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      substr: "bpf_program"

  - id: bpf-prefix
    desc: BPF_ prefix
    crit: inert
    conf: 0.4
    for: [elf, c]
    if:
      type: string
      exact: "BPF_"

  # NOTE: Changed from "pcap_" prefix to actual pcap function names.
  # The bare prefix can match unrelated strings in binaries.
  - id: pcap-prefix
    desc: pcap library function reference
    crit: inert
    conf: 0.5
    for: [elf, c]
    if:
      type: symbol
      # Match actual pcap API functions, not just the prefix
      regex: "pcap_(?:open_live|compile|setfilter|loop|next|close|findalldevs|lookupdev)"

  - id: recvfrom-fn
    desc: recvfrom function
    crit: inert
    conf: 0.3
    for: [elf, c]
    if:
      type: symbol
      regex: "recvfrom"

  # NOTE: dup2 and execve are defined in their canonical locations:
  # - cap/process/fd/dup2
  # - cap/exec/command/shell/c-execve
  # Composite rules below reference them using full paths.

  - id: ipproto-icmp
    desc: IPPROTO_ICMP protocol
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      substr: "IPPROTO_ICMP"

  - id: ipproto-udp
    desc: IPPROTO_UDP protocol
    crit: inert
    conf: 0.3
    for: [elf, c]
    if:
      type: string
      substr: "IPPROTO_UDP"

  # === XDP Return Values ===
  # XDP_TX is particularly suspicious - reflects packets back out the interface
  - id: xdp-tx
    desc: XDP_TX packet reflection
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      substr: "XDP_TX"

  - id: xdp-drop
    desc: XDP_DROP packet discard
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: content
      substr: "XDP_DROP"

  - id: xdp-pass
    desc: XDP_PASS packet passthrough
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: content
      substr: "XDP_PASS"

  # === XDP Attachment API ===
  # bpf_xdp_attach() attaches an XDP program to a network interface
  - id: xdp-attach
    desc: XDP program attachment to interface
    crit: notable
    conf: 0.9
    for: [c, elf]
    if:
      type: content
      substr: "bpf_xdp_attach"

  # XDP flags for attachment mode
  - id: xdp-flags
    desc: XDP attachment flags
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: content
      regex: "XDP_FLAGS_(?:UPDATE_IF_NOEXIST|SKB_MODE|DRV_MODE|HW_MODE)"

  # BPF skeleton header include (.skel.h)
  # Generated by bpftool gen skeleton - contains embedded BPF bytecode
  - id: bpf-skeleton-include
    desc: BPF skeleton header include
    crit: notable
    conf: 0.9
    for: [c]
    if:
      type: content
      regex: "#include\\s+\"[^\"]+\\.skel\\.h\""

  # === ICMP Covert Channel Patterns ===
  # ICMP pingback - using ICMP echo/reply for covert communication
  - id: icmp-pingback
    desc: ICMP pingback covert channel marker
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: content
      regex: "(?i)(?:icmp[_-]?ping[_-]?back|ping[_-]?back[_-]?(?:server|client|daemon)|icmp[_-]?(?:shell|backdoor|c2|covert))"

  # ICMP reply program - XDP program that sends ICMP replies
  - id: icmp-prog-reply
    desc: ICMP reply program reference
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      regex: "(?i)icmp[_-]?(?:prog[_-]?)?reply|reply[_-]?icmp"

  # === ICMP Header Manipulation ===
  - id: icmphdr-struct
    desc: ICMP header structure
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      regex: "struct\\s+icmphdr|icmphdr\\s*\\*"

  - id: icmp-type-field
    desc: ICMP type field access
    crit: notable
    conf: 0.75
    for: [c]
    if:
      type: content
      # Match direct ICMP type field manipulation (icmph->type, icmp->type, etc.)
      regex: "icmp[h]?->type"

  - id: icmp-echo-request
    desc: ICMP echo request type (8)
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: content
      # Match ICMP type 8 (echo request) checks
      regex: "->type\\s*==\\s*8|type\\s*==\\s*(?:ICMP_ECHO|8)"

  - id: icmp-echo-reply
    desc: ICMP echo reply type (0)
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: content
      # Match ICMP type being set to 0 (echo reply)
      regex: "->type\\s*=\\s*0[^0-9]|type\\s*=\\s*(?:ICMP_ECHOREPLY|0)[^0-9]"

  # === BPF Map Operations ===
  - id: bpf-map-lookup
    desc: BPF map lookup helper
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      substr: "bpf_map_lookup_elem"

  - id: bpf-map-update
    desc: BPF map update helper
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      substr: "bpf_map_update_elem"

  - id: bpf-map-delete
    desc: BPF map delete helper
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      substr: "bpf_map_delete_elem"

  # === BPF Map Type Declarations ===
  - id: bpf-map-array
    desc: BPF array map type
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: content
      substr: "BPF_MAP_TYPE_ARRAY"

  # === Ethernet/IP Header Manipulation ===
  - id: ethhdr-struct
    desc: Ethernet header structure
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: content
      regex: "struct\\s+ethhdr|ethhdr\\s*\\*"

  - id: iphdr-struct
    desc: IP header structure
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: content
      regex: "struct\\s+iphdr|iphdr\\s*\\*"

  - id: ip-addr-swap
    desc: IP address swap operation
    crit: notable
    conf: 0.75
    for: [c]
    if:
      type: content
      # Match IP address field swaps (saddr/daddr swap)
      regex: "swap.{0,30}(?:saddr|daddr)|(?:saddr|daddr).{0,30}swap"

  # === Legitimate eBPF Tracing ===
  - id: bpftrace
    desc: bpftrace framework
    crit: benign
    conf: 0.85
    if:
      type: string
      substr: "bpftrace"

  - id: bcc-lib
    desc: BCC library
    crit: benign
    conf: 0.85
    if:
      type: string
      # Require "bcc" as a word boundary to avoid matching partial strings
      regex: "\\bbcc(?:_|/|\\s|$)"

  - id: libbpf
    desc: libbpf library
    crit: benign
    conf: 0.85
    if:
      type: string
      substr: "libbpf"

  - id: bpf-probe-read
    desc: bpf_probe_read function
    crit: benign
    conf: 0.8
    if:
      type: symbol
      regex: "bpf_probe_read"

  # eBPF user memory read - used for data exfiltration
  - id: bpf-core-read-user
    desc: eBPF read from user memory
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      regex: "bpf_(?:core_read_user|probe_read_user)"

  - id: bpf-kprobe
    desc: bpf_kprobe function
    crit: benign
    conf: 0.8
    if:
      type: string
      substr: "bpf_kprobe"

  - id: bpf-tracepoint
    desc: bpf_tracepoint function
    crit: benign
    conf: 0.8
    if:
      type: string
      substr: "bpf_tracepoint"

  - id: cilium
    desc: Cilium observability
    crit: benign
    conf: 0.9
    if:
      type: string
      substr: "cilium"

  - id: falco
    desc: Falco security
    crit: benign
    conf: 0.9
    if:
      type: string
      substr: "falco"

  - id: tracee
    desc: Tracee observability
    crit: benign
    conf: 0.9
    if:
      type: string
      substr: "tracee"

  # === Uprobe Attachment ===
  - id: uprobe-attach
    desc: eBPF uprobe attachment
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      regex: "(?:attach_uprobe|uprobe_opts|bpf_program__attach_uprobe)"

  # eBPF SEC macro uprobe section declaration
  - id: uprobe-sec
    desc: eBPF uprobe SEC declaration
    crit: notable
    conf: 0.85
    for: [c]
    if:
      type: string
      regex: "uprobe/"

  - id: uprobe-retprobe
    desc: eBPF return probe
    crit: notable
    conf: 0.75
    for: [c, elf]
    if:
      type: string
      contains: "retprobe"

  # === SSL/TLS Function Hooking Targets ===
  - id: ssl-openssl-fn
    desc: OpenSSL function names
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      regex: "\\bSSL_(?:read|write|set_fd|connect|accept)\\b"

  # === SSL Sniffer Loader API ===
  # Patterns for eBPF-based SSL/TLS interception loaders
  - id: ssl-attach-openssl
    desc: SSL attach to OpenSSL
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: content
      regex: "ssl_attach_openssl"
      case_insensitive: true

  - id: ssl-attach-gnutls
    desc: SSL attach to GnuTLS
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: content
      regex: "ssl_attach_gnutls"
      case_insensitive: true

  - id: ssl-attach-nss
    desc: SSL attach to NSS
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: content
      regex: "ssl_attach_nss"
      case_insensitive: true

  # SSL attach macro pattern (C preprocessor token concatenation)
  # Pattern: ssl_attach_## for dynamic SSL library hooking
  - id: ssl-attach-macro
    desc: SSL attach macro pattern
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: content
      substr: "ssl_attach_##"

  # NSS library target (Mozilla NSS via libnspr4)
  - id: libnspr4-target
    desc: NSS/NSPR library target
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      substr: "libnspr4.so"

  # eBPF loader header include
  - id: ebpf-loader-include
    desc: eBPF loader header include
    crit: notable
    conf: 0.85
    for: [c]
    if:
      type: content
      substr: "ebpf/loader"

  # Library resolver/searcher pattern
  - id: lib-resolver-include
    desc: Library resolver header include
    crit: notable
    conf: 0.75
    for: [c]
    if:
      type: content
      substr: "libresolver"

  - id: ssl-listen-event
    desc: SSL event listener
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      regex: "ssl_listen_event"
      case_insensitive: true

  - id: ssl-load-fn
    desc: SSL loader function
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      regex: "\\bssl_load\\s*\\("
      case_insensitive: true

  # SSL function names in uprobe hook targets (lowercase variant)
  - id: ssl-hook-target
    desc: SSL function as hook target
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      regex: "(?i)ssl_(?:read|write)"

  - id: ssl-gnutls-fn
    desc: GnuTLS function names
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      regex: "\\bgnutls_record_(?:send|recv)\\b"

  - id: ssl-nss-fn
    desc: NSS/NSPR function names
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      regex: "\\bPR_(?:Read|Write|Send|Recv)\\b"

  - id: ssl-op-string
    desc: SSL operation indicator
    crit: notable
    conf: 0.75
    for: [c, elf]
    if:
      type: content
      regex: "SSL_OP_(?:READ|WRITE)"

  # SSL operation type definition (ssl_op_t enum/typedef)
  - id: ssl-op-type
    desc: SSL operation type definition
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      regex: "\\bssl_op(?:_t)?\\b"
      case_insensitive: true

  # === eBPF Kernel Types ===
  # __u32, __u64 are eBPF/kernel type aliases
  - id: ebpf-kernel-types
    desc: eBPF kernel type aliases
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: content
      regex: "\\b__u(?:8|16|32|64)\\b"

  # === eBPF Data Event Structures ===
  # data_event struct is a common pattern for kernelâ†’userspace data transfer
  - id: data-event-struct
    desc: eBPF data event structure
    crit: notable
    conf: 0.75
    for: [c, elf]
    if:
      type: content
      regex: "\\bdata_event\\b"

  # Kernel to userspace data transfer comment/intent
  - id: kernel-userspace-transfer
    desc: Kernel to userspace data transfer
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      regex: "(?i)kernel\\s+to\\s+user\\s*space|user\\s*space.{0,30}kernel"

  # === eBPF skeleton patterns ===
  - id: bpf-skeleton
    desc: BPF skeleton pattern
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: string
      regex: "\\w+_bpf__(?:open|load|attach|destroy)"

  - id: bpf-ring-buffer
    desc: BPF ring buffer usage
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: string
      regex: "ring_buffer__(?:new|poll|free)"

  # eBPF ringbuf helper functions (kernel-side)
  - id: bpf-ringbuf
    desc: eBPF ringbuf helpers
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: symbol
      regex: "bpf_ringbuf_(?:reserve|submit|discard|output)"

  # === eBPF Map Type Declarations ===
  # BPF_MAP_TYPE_RINGBUF in eBPF code (data exfiltration buffer)
  - id: bpf-map-ringbuf
    desc: BPF ring buffer map
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      substr: "BPF_MAP_TYPE_RINGBUF"

  # BPF_MAP_TYPE_HASH for connection/context tracking
  - id: bpf-map-hash
    desc: BPF hash map
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: content
      substr: "BPF_MAP_TYPE_HASH"

  # === BPF Loader API ===
  - id: bpf-object-open
    desc: Load BPF object from file
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      regex: "bpf_object__open(?:_file)?"

  - id: bpf-object-load
    desc: Load BPF object into kernel
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      regex: "bpf_object__load"

  - id: bpf-program-find
    desc: Find BPF program in object by name
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: symbol
      regex: "bpf_object__find_program_by_name"

  - id: bpf-rlimit-memlock
    desc: High RLIMIT_MEMLOCK for BPF
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: content
      # Matches RLIMIT_MEMLOCK combined with large shift (common in BPF loaders)
      regex: "(?s)(?:RLIMIT_MEMLOCK.{0,200}(?:\\d+UL\\s*<<\\s*20|1\\s*<<\\s*30)|(?:\\d+UL\\s*<<\\s*20|1\\s*<<\\s*30).{0,200}RLIMIT_MEMLOCK)"

  # === SSL/TLS Context Tracking ===
  # Map names indicating SSL context tracking (fd_to_ssl_ctx, ssl_ctx_map, etc.)
  - id: ssl-ctx-map
    desc: SSL context tracking map
    crit: suspicious
    conf: 0.9
    for: [c, elf]
    if:
      type: content
      regex: "(?i)(?:fd_to_ssl|ssl_(?:ctx|context)_(?:map|hash)|ssl_to_fd)"

  # SSL CTX reference in comments or identifiers
  - id: ssl-ctx-ref
    desc: SSL context reference
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: content
      regex: "\\bSSL[_\\s]?CTX\\b"
      case_insensitive: true

composite_rules:
  # BPF attachment helper
  - id: bpf-attachment
    desc: BPF filter attachment
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: so-attach-filter
      - id: so-attach-bpf

  # Raw socket helper
  - id: raw-socket
    desc: Raw packet socket
    crit: notable
    conf: 0.6
    needs: 1
    any:
      - id: af-packet
      - id: sock-raw

  # Magic/knock patterns helper
  - id: magic-knock-patterns
    desc: "Magic packet/knock sequences in BPF"
    crit: notable
    conf: 0.7
    any:

  # BPF backdoor (migrated from YARA)
  - id: backdoor
    desc: BPF packet filtering for backdoor
    crit: suspicious
    conf: 0.8
    attack: "T1205"
    all:
      - id: bpf-attachment
      - id: raw-socket
      - id: magic-knock-patterns

  # BPF packet inspection helper
  # NOTE: Require at least 2 indicators to avoid false positives.
  # Individual functions like recvfrom are common in networking code.
  - id: bpf-packet-inspection
    desc: BPF packet inspection components
    crit: notable
    conf: 0.6
    for: [elf, c]
    needs: 2
    any:
      - id: bpf-program
      - id: bpf-prefix
      - id: pcap-prefix
      - id: recvfrom-fn

  # Shell activation helper
  # NOTE: dup2 + execve is extremely common in legitimate programs.
  # Only suspicious in context of /bin/sh execution with fd redirection.
  - id: shell-activation
    desc: Shell execution components
    crit: inert
    conf: 0.6
    for: [elf, c]
    all:
      - id: cap/exec/command/shell/generic/bin-sh
    needs: 1
    any:
      - id: cap/process/fd/dup2
      - id: cap/exec/command/shell/c-execve

  # Protocol trigger helper
  - id: protocol-trigger
    desc: ICMP/UDP protocol triggers
    crit: inert
    conf: 0.6
    for: [elf, c]
    needs: 1
    any:
      - id: ipproto-icmp
      - id: ipproto-udp

  # BPFDoor-style helper
  # Requires both shell activation AND protocol trigger to be suspicious
  - id: bpfdoor-activation
    desc: BPFDoor activation components
    crit: notable
    conf: 0.85
    for: [elf, c]
    all:
      - id: shell-activation
      - id: protocol-trigger

  # BPFDoor-style backdoor (migrated from YARA)
  - id: bpfdoor-style
    desc: BPFDoor-style packet filter backdoor
    crit: suspicious
    conf: 0.9
    attack: "T1205"
    for: [elf, c]
    all:
      - id: bpf-packet-inspection
      - id: bpfdoor-activation

  # Tracing frameworks helper
  - id: tracing-frameworks
    desc: eBPF tracing frameworks
    crit: benign
    conf: 0.85
    needs: 1
    any:
      - id: bpftrace
      - id: bcc-lib
      - id: libbpf

  # Tracing functions helper
  - id: tracing-functions
    desc: eBPF tracing functions
    crit: benign
    conf: 0.8
    needs: 1
    any:
      - id: bpf-probe-read
      - id: bpf-kprobe
      - id: bpf-tracepoint

  # Observability tools helper
  - id: observability-tools
    desc: eBPF observability tools
    crit: benign
    conf: 0.9
    needs: 1
    any:
      - id: cilium
      - id: falco
      - id: tracee

  # Legitimate eBPF tracing (migrated from YARA)
  - id: tracing
    desc: Legitimate eBPF tracing/observability
    crit: benign
    conf: 0.85
    needs: 1
    any:
      - id: tracing-frameworks
      - id: tracing-functions
      - id: observability-tools

  # SSL sniffer loader API helper
  - id: ssl-attach-targets
    desc: SSL library attach targets
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    needs: 1
    any:
      - id: ssl-attach-openssl
      - id: ssl-attach-gnutls
      - id: ssl-attach-nss

  # SSL sniffer loader pattern
  # Multiple TLS library attach functions = SSL interception tool
  - id: ssl-sniffer-loader
    desc: SSL sniffer loader API
    crit: suspicious
    conf: 0.9
    attack: "T1557"
    for: [c, elf]
    needs: 2
    any:
      - id: ssl-attach-openssl
      - id: ssl-attach-gnutls
      - id: ssl-attach-nss
      - id: ssl-listen-event
      - id: ssl-load-fn
      - id: ssl-attach-macro

  # SSL/TLS context tracking infrastructure
  # eBPF maps designed to track SSL connections
  - id: ssl-ctx-tracking
    desc: SSL context tracking maps
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    all:
      - id: ssl-ctx-map
      - id: ssl-ctx-ref

  # eBPF data buffer infrastructure (ring buffer or hash for collection)
  - id: ebpf-data-buffer
    desc: eBPF data buffer maps
    crit: notable
    conf: 0.7
    for: [c, elf]
    needs: 1
    any:
      - id: bpf-map-ringbuf
      - id: bpf-ring-buffer
      - id: bpf-ringbuf

  # eBPF SSL interception infrastructure
  # Ring buffer + SSL context tracking = SSL interception tool
  - id: ssl-intercept-infra
    desc: eBPF SSL interception infrastructure
    crit: suspicious
    conf: 0.9
    attack: "T1557"
    for: [c, elf]
    all:
      - id: ebpf-data-buffer
      - id: ssl-ctx-tracking

  # eBPF SSL sniffer header pattern
  # SSL operation types + data event struct = SSL sniffer infrastructure
  - id: ssl-sniffer-header
    desc: eBPF SSL sniffer header pattern
    crit: suspicious
    conf: 0.85
    attack: "T1557"
    for: [c]
    all:
      - id: ssl-op-string
    needs: 1
    any:
      - id: data-event-struct
      - id: ssl-op-type
      - id: kernel-userspace-transfer

  # eBPF data exfiltration structure
  # eBPF types + data event struct + kernel transfer = data collection
  - id: ebpf-exfil-struct
    desc: eBPF data exfiltration structures
    crit: suspicious
    conf: 0.85
    for: [c]
    all:
      - id: ebpf-kernel-types
      - id: data-event-struct
    needs: 1
    any:
      - id: kernel-userspace-transfer
      - id: ssl-op-string
      - id: ssl-op-type

  # === eBPF Development Header Patterns ===
  # eBPF CO-RE development header (vmlinux.h + bpf_helpers.h)
  - id: ebpf-core-header
    desc: eBPF CO-RE development header
    crit: notable
    conf: 0.85
    for: [c]
    all:
      - id: vmlinux-h
      - id: bpf-helpers-h

  # eBPF program header with license
  - id: ebpf-program-header
    desc: eBPF program with license section
    crit: notable
    conf: 0.8
    for: [c]
    needs: 2
    any:
      - id: vmlinux-h
      - id: bpf-helpers-h
      - id: sec-license

  # eBPF network packet manipulation helpers
  # Checksum recalculation + MAC swap = packet modification
  - id: packet-manip-helpers
    desc: eBPF packet manipulation helpers
    crit: notable
    conf: 0.8
    for: [c]
    needs: 2
    any:
      - id: csum-helper
      - id: eth-swap
      - id: eth-alen
      - id: ntohs-bswap

  # eBPF XDP/TC helper header for packet manipulation
  # CO-RE header + packet manipulation functions = XDP/TC helper module
  - id: xdp-helper-header
    desc: eBPF XDP/TC packet helper header
    crit: suspicious
    conf: 0.9
    attack: "T1205.001"
    for: [c]
    all:
      - id: ebpf-program-header
      - id: packet-manip-helpers

  # === XDP Packet Reflection ===
  # XDP_TX with packet manipulation = covert reflection/reply
  - id: xdp-packet-reflection
    desc: XDP packet reflection pattern
    crit: suspicious
    conf: 0.9
    attack: "T1205.001"
    for: [c, elf]
    all:
      - id: xdp-tx
      - id: packet-manip-helpers

  # === ICMP Manipulation Patterns ===
  # ICMP header parsing + type field access
  - id: icmp-parsing
    desc: ICMP packet parsing
    crit: notable
    conf: 0.75
    for: [c, elf]
    needs: 2
    any:
      - id: ipproto-icmp
      - id: icmphdr-struct
      - id: icmp-type-field
      - id: icmp-echo-request
      - id: icmp-echo-reply

  # ICMP type spoofing/modification
  # Changing ICMP type field (e.g., request to reply) = covert response
  - id: icmp-type-spoof
    desc: ICMP type modification
    crit: suspicious
    conf: 0.85
    for: [c]
    all:
      - id: icmp-type-field
    needs: 1
    any:
      - id: icmp-echo-request
      - id: icmp-echo-reply

  # === XDP ICMP Pingback/Covert Channel ===
  # XDP program + ICMP manipulation + packet reflection = ICMP covert channel
  - id: xdp-icmp-covert
    desc: XDP ICMP covert channel
    crit: suspicious
    conf: 0.95
    attack: "T1095"
    for: [c, elf]
    all:
      - id: obj/anti-analysis/kernel-hide/ebpf/sec-xdp
      - id: icmp-parsing
      - id: xdp-tx

  # XDP loader with ICMP covert channel markers
  # Userspace loader that attaches XDP program for ICMP manipulation
  - id: xdp-icmp-loader
    desc: XDP ICMP covert channel loader
    crit: suspicious
    conf: 0.9
    attack: "T1095"
    for: [c, elf]
    all:
      - id: xdp-attach
      - id: icmp-indicators
    needs: 1
    any:
      - id: bpf-skeleton-include
      - id: cap/comm/ip/services/services-icmp

  # ICMP indicators helper
  - id: icmp-indicators
    desc: ICMP covert channel indicators
    crit: notable
    conf: 0.8
    for: [c, elf]
    needs: 1
    any:
      - id: icmp-pingback
      - id: icmp-prog-reply
      - id: cap/comm/ip/services/services-icmp
