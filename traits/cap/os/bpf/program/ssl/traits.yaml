# eBPF Programs - SSL/TLS Sniffer Programs
# Capabilities for BPF/eBPF program detection

traits:
  - id: ssl-ctx-map
    desc: SSL context tracking map
    crit: suspicious
    conf: 0.9
    for: [c, elf]
    if:
      type: raw
      regex: "(?i)(?:fd_to_ssl|ssl_(?:ctx|context)_(?:map|hash)|ssl_to_fd)"

  # SSL CTX reference in comments or identifiers
  - id: ssl-ctx-ref
    desc: SSL context reference
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: raw
      regex: "\\bSSL[_\\s]?CTX\\b"
      case_insensitive: true

  # BPF attachment helper
  - id: ssl-attach-openssl
    desc: SSL attach to OpenSSL
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: raw
      regex: "ssl_attach_openssl"
      case_insensitive: true

  - id: ssl-attach-gnutls
    desc: SSL attach to GnuTLS
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: raw
      regex: "ssl_attach_gnutls"
      case_insensitive: true

  - id: ssl-attach-nss
    desc: SSL attach to NSS
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    if:
      type: raw
      regex: "ssl_attach_nss"
      case_insensitive: true

  # SSL attach macro pattern (C preprocessor token concatenation)
  # Pattern: ssl_attach_## for dynamic SSL library hooking
  - id: ssl-attach-macro
    desc: SSL attach macro pattern
    crit: suspicious
    conf: 0.9
    for: [c]
    if:
      type: raw
      substr: "ssl_attach_##"

  # NSS library target (Mozilla NSS via libnspr4)
  - id: libnspr4-target
    desc: NSS/NSPR library target
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: raw
      substr: "libnspr4.so"

  # eBPF loader header include
  - id: ebpf-loader-include
    desc: eBPF loader header include
    crit: notable
    conf: 0.85
    for: [c]
    if:
      type: raw
      substr: "ebpf/loader"

  # Library resolver/searcher pattern
  - id: lib-resolver-include
    desc: Library resolver header include
    crit: notable
    conf: 0.75
    for: [c]
    if:
      type: raw
      substr: "libresolver"

  - id: ssl-listen-event
    desc: SSL event listener
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: raw
      regex: "ssl_listen_event"
      case_insensitive: true

  - id: ssl-load-fn
    desc: SSL loader function
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: raw
      regex: "\\bssl_load\\s*\\("
      case_insensitive: true

  # SSL function names in uprobe hook targets (lowercase variant)
  - id: ssl-hook-target
    desc: SSL function as hook target
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: string
      regex: "(?i)ssl_(?:read|write)"

  - id: ssl-gnutls-fn
    desc: GnuTLS function names
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      regex: "\\bgnutls_record_(?:send|recv)\\b"

  - id: ssl-nss-fn
    desc: NSS/NSPR function names
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      regex: "\\bPR_(?:Read|Write|Send|Recv)\\b"

  - id: ssl-op-string
    desc: SSL operation indicator
    crit: notable
    conf: 0.75
    for: [c, elf]
    if:
      type: raw
      regex: "SSL_OP_(?:READ|WRITE)"

  # SSL operation type definition (ssl_op_t enum/typedef)
  - id: ssl-op-type
    desc: SSL operation type definition
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: raw
      regex: "\\bssl_op(?:_t)?\\b"
      case_insensitive: true

  # === SSL/TLS Function Hooking Targets ===
  - id: ssl-openssl-fn
    desc: OpenSSL function names
    crit: notable
    conf: 0.7
    for: [c, elf]
    if:
      type: string
      regex: "\\bSSL_(?:read|write|set_fd|connect|accept)\\b"

composite_rules:
  - id: bpf-attachment
    desc: BPF filter attachment
    crit: notable
    conf: 0.7
    any:
      - id: cap/comm/socket/options/unix::options-filter
      - id: cap/os/bpf/program/network::so-attach-bpf

  # Raw socket helper
  - id: raw-socket
    desc: Raw packet socket
    crit: notable
    conf: 0.6
    any:
      - id: cap/os/bpf/program/network::af-packet
      - id: cap/comm/ip/spoof::sock-raw-constant

  # Magic/knock patterns helper
  - id: magic-knock-patterns
    desc: "Magic packet/knock sequences in BPF"
    crit: notable
    conf: 0.7
    any:

  # BPF backdoor (migrated from YARA)
  - id: backdoor
    desc: BPF packet filtering for backdoor
    crit: suspicious
    conf: 0.8
    attack: "T1205"
    all:
      - id: bpf-attachment
      - id: raw-socket
      - id: magic-knock-patterns

  # BPF packet inspection helper
  # NOTE: Require at least 2 indicators to avoid false positives.
  # Individual functions like recvfrom are common in networking code.
  - id: bpf-packet-inspection
    desc: BPF packet inspection components
    crit: notable
    conf: 0.6
    for: [elf, c]
    needs: 2
    any:
      - id: cap/os/bpf/network-infra
      - id: cap/os/bpf/program/network
      - id: cap/os/bpf/program/loader

  # Shell activation helper
  # NOTE: dup2 + execve is extremely common in legitimate programs.
  # Only suspicious in context of /bin/sh execution with fd redirection.
  - id: shell-activation
    desc: Shell execution components
    crit: inert
    conf: 0.6
    for: [elf, c]
    all:
      - id: cap/exec/command/shell::bin-sh
    any:
      - id: cap/process/fd/dup::dup2
      - id: cap/exec/command/shell::c-execve

  # Protocol trigger helper
  - id: protocol-trigger
    desc: ICMP/UDP protocol triggers
    crit: inert
    conf: 0.6
    for: [elf, c]
    any:
      - id: cap/comm/ip/services::ipproto-icmp
      - id: cap/os/bpf/program/network::ipproto-udp

  # BPFDoor-style helper
  # Requires both shell activation AND protocol trigger to be suspicious
  - id: bpfdoor-activation
    desc: BPFDoor activation components
    crit: notable
    conf: 0.85
    for: [elf, c]
    all:
      - id: shell-activation
      - id: protocol-trigger

  # BPFDoor-style backdoor (migrated from YARA)
  - id: bpfdoor-style
    desc: BPFDoor-style packet filter backdoor
    crit: suspicious
    conf: 0.9
    attack: "T1205"
    for: [elf, c]
    all:
      - id: bpf-packet-inspection
      - id: bpfdoor-activation

  # Tracing frameworks helper
  - id: tracing-frameworks
    desc: eBPF tracing frameworks
    crit: notable
    conf: 0.85
    any:
      - id: cap/os/bpf/trace-frameworks

  # Tracing functions helper
  - id: tracing-functions
    desc: eBPF tracing functions
    crit: notable
    conf: 0.8
    any:
      - id: cap/os/bpf/trace-functions

  # Observability tools helper
  - id: observability-tools
    desc: eBPF observability tools
    crit: notable
    conf: 0.9
    any:
      - id: cap/os/bpf/trace-tools

  # Legitimate eBPF tracing (migrated from YARA)
  - id: tracing
    desc: Legitimate eBPF tracing/observability
    crit: notable
    conf: 0.85
    any:
      - id: tracing-frameworks
      - id: tracing-functions
      - id: observability-tools

  # SSL sniffer loader API helper
  - id: ssl-attach-targets
    desc: SSL library attach targets
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    any:
      - id: ssl-attach-openssl
      - id: ssl-attach-gnutls
      - id: ssl-attach-nss

  # SSL sniffer loader pattern
  # Multiple TLS library attach functions = SSL interception tool
  - id: ssl-sniffer-loader
    desc: SSL sniffer loader API
    crit: suspicious
    conf: 0.9
    attack: "T1557"
    for: [c, elf]
    needs: 2
    any:
      - id: ssl-attach-openssl
      - id: ssl-attach-gnutls
      - id: ssl-attach-nss
      - id: ssl-listen-event
      - id: ssl-load-fn
      - id: ssl-attach-macro

  # SSL/TLS context tracking infrastructure
  # eBPF maps designed to track SSL connections
  - id: ssl-ctx-tracking
    desc: SSL context tracking maps
    crit: suspicious
    conf: 0.85
    for: [c, elf]
    all:
      - id: ssl-ctx-map
      - id: ssl-ctx-ref

  # eBPF data buffer infrastructure (ring buffer or hash for collection)
  - id: ebpf-data-buffer
    desc: eBPF data buffer maps
    crit: notable
    conf: 0.7
    for: [c, elf]
    any:
      - id: cap/os/bpf/program/maps::bpf-map-ringbuf
      - id: cap/os/bpf/program/loader::bpf-ring-buffer
      - id: cap/os/bpf/program/loader::bpf-ringbuf

  # eBPF SSL interception infrastructure
  # Ring buffer + SSL context tracking = SSL interception tool
  - id: ssl-intercept-infra
    desc: eBPF SSL interception infrastructure
    crit: suspicious
    conf: 0.9
    attack: "T1557"
    for: [c, elf]
    all:
      - id: ebpf-data-buffer
      - id: ssl-ctx-tracking

  # eBPF SSL sniffer header pattern
  # SSL operation types + data event struct = SSL sniffer infrastructure
  - id: ssl-sniffer-header
    desc: eBPF SSL sniffer header pattern
    crit: suspicious
    conf: 0.85
    attack: "T1557"
    for: [c]
    all:
      - id: ssl-op-string
    any:
      - id: cap/os/bpf/program/loader::data-event-struct
      - id: ssl-op-type
      - id: cap/os/bpf/program/loader::kernel-userspace-transfer

  # eBPF data exfiltration structure
  # eBPF types + data event struct + kernel transfer = data collection
  - id: ebpf-exfil-struct
    desc: eBPF data exfiltration structures
    crit: suspicious
    conf: 0.85
    for: [c]
    all:
      - id: cap/os/bpf/program/loader::ebpf-kernel-types
      - id: cap/os/bpf/program/loader::data-event-struct
    any:
      - id: cap/os/bpf/program/loader::kernel-userspace-transfer
      - id: ssl-op-string
      - id: ssl-op-type

  # === SSL Sniffer Loader API ===
  # Patterns for eBPF-based SSL/TLS interception loaders
