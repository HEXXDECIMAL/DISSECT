# eBPF Programs - Network Packet Manipulation
# Capabilities for BPF/eBPF program detection


traits:
  # === BPF Socket Attachment ===
  # Removed so-attach-filter duplicate - use cap/comm/socket/options/unix::options-filter

  - id: so-attach-bpf
    desc: SO_ATTACH_BPF socket option
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "SO_ATTACH_BPF"

  # === Raw Packet Capture ===
  - id: af-packet
    desc: AF_PACKET raw socket
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "AF_PACKET"

  # Removed sock-raw duplicate - use cap/comm/ip/spoof::sock-raw-constant

  # === Magic/Trigger Packet Patterns ===
  - id: magic-packet
    desc: magic_packet string
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "magic_packet"

  - id: trigger-packet
    desc: trigger_packet string
    crit: suspicious
    conf: 0.8
    if:
      type: string
      substr: "trigger_packet"

  - id: knock-string
    desc: knock string reference
    crit: notable
    conf: 0.6
    for: [elf, c]
    if:
      type: string
      # Match port knocking context, not generic "knock" word
      # Require explicit port/network context to avoid game/UI false positives
      regex: "(?i)(?:port[_-]?knock(?:ing|er|s)?|knock[_-]?(?:sequence|packet|daemon|port)|(?:tcp|udp)[_-]?knock)"

  - id: port-knock
    desc: port_knock string
    crit: suspicious
    conf: 0.75
    if:
      type: string
      substr: "port_knock"

  - id: sequence-string
    desc: knock sequence string reference
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: "\\b(knock|port|packet)[_-]?sequence\\b"
      case_insensitive: true

  # NOTE: dup2, execve, and protocol constants are defined in their canonical locations:
  # - cap/process/fd/dup::dup2
  # - cap/exec/command/shell/c-execve
  # - cap/comm/ip/services::ipproto-icmp
  # Composite rules below reference them using full paths.

  - id: ipproto-udp
    desc: IPPROTO_UDP protocol
    crit: inert
    conf: 0.3
    for: [elf, c]
    if:
      type: string
      substr: "IPPROTO_UDP"

  # === XDP Return Values ===
  # XDP_TX is particularly suspicious - reflects packets back out the interface
  - id: xdp-tx
    desc: XDP_TX packet reflection
    crit: notable
    conf: 0.8
    for: [c, elf]
    if:
      type: raw
      substr: "XDP_TX"

  - id: xdp-drop
    desc: XDP_DROP packet discard
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: raw
      substr: "XDP_DROP"

  - id: xdp-pass
    desc: XDP_PASS packet passthrough
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: raw
      substr: "XDP_PASS"

  # === XDP Attachment API ===
  # bpf_xdp_attach() attaches an XDP program to a network interface
  - id: xdp-attach
    desc: XDP program attachment to interface
    crit: notable
    conf: 0.9
    for: [c, elf]
    if:
      type: raw
      substr: "bpf_xdp_attach"

  # XDP flags for attachment mode
  - id: xdp-flags
    desc: XDP attachment flags
    crit: inert
    conf: 0.6
    for: [c, elf]
    if:
      type: raw
      regex: "XDP_FLAGS_(?:UPDATE_IF_NOEXIST|SKB_MODE|DRV_MODE|HW_MODE)"

  # BPF skeleton header include (.skel.h)
  # Generated by bpftool gen skeleton - contains embedded BPF bytecode
  - id: bpf-skeleton-include
    desc: BPF skeleton header include
    crit: notable
    conf: 0.9
    for: [c]
    if:
      type: raw
      regex: "#include\\s+\"[^\"]+\\.skel\\.h\""

  # === XDP Packet Reflection ===
  # XDP_TX with packet manipulation = covert reflection/reply
  - id: ethhdr-struct
    desc: Ethernet header structure
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: raw
      regex: "struct\\s+ethhdr|ethhdr\\s*\\*"

  - id: iphdr-struct
    desc: IP header structure
    crit: inert
    conf: 0.5
    for: [c, elf]
    if:
      type: raw
      regex: "struct\\s+iphdr|iphdr\\s*\\*"

  - id: ip-addr-swap
    desc: IP address swap operation
    crit: notable
    conf: 0.75
    for: [c]
    if:
      type: raw
      # Match IP address field swaps (saddr/daddr swap)
      regex: "swap.{0,30}(?:saddr|daddr)|(?:saddr|daddr).{0,30}swap"


composite_rules:
  - id: xdp-packet-reflection
    desc: XDP packet reflection pattern
    crit: suspicious
    conf: 0.9
    attack: "T1205.001"
    for: [c, elf]
    all:
      - id: xdp-tx
      - id: cap/os/bpf/program/loader::packet-manip-helpers

  # === Ethernet/IP Header Manipulation ===
