# Bracket Notation Obfuscation
# Detects obfuscated property access using bracket notation with hex escapes.
# E.g., var["\x63\x68\x61\x72\x41\x74"](1) instead of var.charAt(1)

defaults:
  crit: suspicious
  conf: 0.8

traits:
  - id: hex-escaped-bracket-property
    desc: Property access via hex-escaped string in brackets
    if:
      type: raw
      # Matches ["..."] where the string contains at least 3 hex escapes (\xHH)
      # Works for mixed content like "c\x68\x61r\x41t"
      regex: '\[\s*["''](?:[^"''\\]*\\x[0-9a-fA-F]{2}){3,}[^"''\\]*["'']\s*\]'

  - id: hex-escaped-char-at
    desc: Specific detection of ["\x63\x68\x61\x72\x41\x74"] (charAt)
    if:
      type: raw
      regex: '\[\s*["''](?:\\x63\\x68\\x61\\x72\\x41\\x74|\\x63\\x68\\x61\\x72\\x61\\x74)["'']\s*\]'

  - id: hex-escaped-from-char-code
    desc: Specific detection of ["\x66\x72\x6f\x6d\x43\x68\x61\x72\x43\x6f\x64\x65"] (fromCharCode)
    if:
      type: raw
      regex: '\[\s*["'']\\x66\\x72\\x6f\\x6d\\x43\\x68\\x61\\x72\\x43\\x6f\\x64\\x65["'']\s*\]'
