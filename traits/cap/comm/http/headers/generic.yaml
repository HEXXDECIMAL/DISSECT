# HTTP Headers
# MBC: C0002 (HTTP Communication)
# ATT&CK: T1071.001

defaults:
  mbc: "C0002"
  attack: "T1071.001"

traits:
  # === User-Agent indicators ===
  - id: ua-mozilla-old
    desc: Old Mozilla 4.0 User-Agent
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Mozilla/4.0"

  - id: ua-curl
    desc: curl User-Agent
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: '\bcurl/'

  - id: ua-wget
    desc: wget User-Agent
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: '\bWget/'

  - id: ua-python-urllib
    desc: Python urllib User-Agent
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "Python-urllib"

  # === Authorization header atomic indicators ===
  - id: auth-header
    desc: Authorization header
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Authorization:"

  - id: bearer-token
    desc: Bearer token authentication
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Bearer "

  - id: basic-auth
    desc: Basic authentication
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Basic "

  - id: headers-encoding
    desc: Accept-Encoding header
    crit: inert
    conf: 0.66
    if:
      type: string
      substr: Accept-Encoding

  # === Custom HTTP headers (commonly used in malware) ===
  - id: header-user
    desc: HTTP header user/userid
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "-H\\s+[\"']?(user|userid):"

  - id: header-client
    desc: HTTP header client
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "-H\\s+[\"']?client:"

  - id: header-bot
    desc: HTTP header bot
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "-H\\s+[\"']?bot:"

  - id: header-build
    desc: HTTP header build
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "-H\\s+[\"']?build:"

  - id: header-hwid
    desc: HTTP header hwid
    crit: inert
    conf: 0.6
    if:
      type: string
      regex: "-H\\s+[\"']?hwid:"

  - id: header-machine
    desc: HTTP header machine
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "-H\\s+[\"']?machine:"

  - id: x-header-user
    desc: X-User header
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "X-User"

  - id: x-header-client
    desc: X-Client header
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "X-Client"

  - id: x-header-bot
    desc: X-Bot header
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "X-Bot"

  - id: x-header-build
    desc: X-Build header
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "X-Build"

  - id: x-header-hwid
    desc: X-HWID header
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "X-HWID"

  # === Multipart form data ===
  - id: multipart-form-data
    desc: multipart/form-data content type
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "multipart/form-data"

  - id: boundary-param
    desc: boundary= parameter
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "boundary="

  - id: content-disposition-filename
    desc: Content-Disposition filename
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "Content-Disposition.{0,30}filename"

  - id: form-data-header
    desc: HTTP multipart form-data header
    crit: inert
    conf: 0.5
    if:
      type: string
      substr: "Content-Disposition: form-data"

composite_rules:
  - id: headers-auth
    desc: HTTP Authorization header
    crit: notable
    conf: 0.66
    needs: 1
    any:
      - id: auth-header
      - id: bearer-token
      - id: basic-auth

  - id: headers-useragent-fake
    desc: Fake or suspicious User-Agent
    crit: notable
    conf: 0.66
    needs: 1
    any:
      - id: ua-mozilla-old
      - id: ua-curl
      - id: ua-wget
      - id: ua-python-urllib

  # Bot identification headers
  - id: bot-headers
    desc: Bot identification HTTP headers
    crit: notable
    conf: 0.7
    needs: 1
    any:
      - id: header-user
      - id: header-client
      - id: header-bot
      - id: header-build
      - id: header-hwid
      - id: header-machine
      - id: x-header-user
      - id: x-header-client
      - id: x-header-bot
      - id: x-header-build
      - id: x-header-hwid

  # Multipart upload
  - id: multipart-upload
    desc: Multipart form data upload
    crit: notable
    conf: 0.6
    needs: 1
    any:
      - id: multipart-form-data
      - id: boundary-param
      - id: content-disposition-filename
      - id: form-data-header
