# HTTP Request Operations - Python
# MBC: C0002 (HTTP Communication)
# ATT&CK: T1071.001

defaults:
  for: [python]

traits:
  # === HTTP library atomic indicators ===
  - id: py-requests-get
    desc: requests.get call (Python)
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "requests.get"

  - id: py-requests-post
    desc: requests.post call (Python)
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "requests.post"

  - id: urllib
    desc: urllib module reference
    crit: inert
    conf: 0.6
    if:
      type: string
      substr: "urllib"

  - id: urllib-urlopen
    desc: urllib.request.urlopen call
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "urllib.request.urlopen"

  - id: urllib-urlopen-py2
    desc: urllib.urlopen call (Python 2)
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "urllib.urlopen"

  - id: aiohttp-session
    desc: aiohttp.ClientSession usage
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "aiohttp.ClientSession"

  - id: httpx-get
    desc: httpx.get call
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "httpx.get"

  - id: httpx-post
    desc: httpx.post call
    crit: inert
    conf: 0.7
    if:
      type: string
      substr: "httpx.post"

  - id: url-literal
    desc: "Direct URL literal in HTTP"
    crit: notable
    conf: 0.8
    for: [python]
    if:
      type: ast
      query: |
        ((call
          function: (attribute
            object: (identifier) @obj
            attribute: (identifier) @meth)
          arguments: (argument_list
            (string) @url))
         (#match? @obj "^(requests|urqt|urllib|urllib2|req|r|client|http|session|httpx)$")
         (#match? @meth "^(get|post|urlopen|urlretrieve|request)$"))
    unless:
      - type: basename
        regex: '(test_|_test\.|\.test\.|\.spec\.).*\.(py)$'

  - id: py-post-generic
    desc: "Generic .post() call"
    crit: inert
    conf: 0.5
    for: [python]
    if:
      type: string
      regex: "\\.post\\("

composite_rules:
  # HTTP request composite
  - id: request-python
    desc: "Performs HTTP request (urllib, requests,"
    crit: inert
    conf: 0.9
    needs: 1
    any:
      - id: py-requests-get
      - id: py-requests-post
      - id: urllib-urlopen
      - id: urllib-urlopen-py2
      - id: url-literal
      - id: aiohttp-session
      - id: httpx-get
      - id: httpx-post

  # HTTP GET composite
  - id: get
    desc: "Performs HTTP GET request"
    crit: notable
    conf: 0.9
    needs: 1
    any:
      - id: requests-get
      - id: httpx-get

  # HTTP POST composite
  - id: post
    desc: "Performs HTTP POST request (Exfiltration"
    crit: notable
    conf: 0.9
    needs: 1
    any:
      - id: requests-post
      - id: httpx-post

# Note: Exfiltration composite rule moved to exfil/http/python.yaml
