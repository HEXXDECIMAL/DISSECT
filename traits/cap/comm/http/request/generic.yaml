# HTTP Request Operations - Generic
# MBC: C0002 (HTTP Communication)
# ATT&CK: T1071.001

traits:
  # === HTTP request micro-traits (migrated from YARA) ===
  - id: http-request-func
    desc: httpRequest function reference
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    if:
      type: string
      substr: "httpRequest"

  - id: user-agent-header
    desc: User-Agent header
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    for: [all]
    if:
      type: string
      substr: "User-Agent"

  - id: http-version
    desc: HTTP/1.x version string
    crit: notable
    conf: 0.5
    mbc: "C0002"
    attack: "T1071.001"
    if:
      type: string
      substr: "HTTP/1."

  # === Network exfiltration atomic indicators ===
  - id: requests-post
    desc: Python requests.post call
    crit: notable
    conf: 0.5
    if:
      type: string
      regex: "requests\\.post"

  - id: requests-get
    desc: Python requests.get call
    crit: inert
    conf: 0.4
    if:
      type: string
      regex: "requests\\.get"

  - id: socket-dot
    desc: socket module usage
    crit: inert
    conf: 0.4
    # Restrict to script languages - "socket." matches too many binary strings
    # like library names (socket.so), debug paths, etc.
    for: [python, ruby, javascript, typescript]
    if:
      type: string
      regex: "socket\\."

  - id: fetch-call
    desc: JavaScript fetch call
    crit: notable
    conf: 0.4
    # Restrict to JavaScript/TypeScript - "fetch(" as a string is too generic
    # for binaries where it matches C++ method names like llvm::Fetcher::fetch()
    for: [javascript, typescript]
    if:
      type: string
      regex: "fetch\\("

  - id: xmlhttprequest-word
    desc: XMLHttpRequest reference
    crit: notable
    conf: 0.4
    if:
      type: string
      substr: "XMLHttpRequest"

composite_rules:
  # HTTP request composite (migrated from YARA)
  - id: request
    desc: Makes HTTP requests
    crit: notable
    conf: 0.66
    mbc: "C0002"
    attack: "T1071.001"
    any:
      - id: http-request-func
      - id: user-agent-header
      - id: http-version

  # Network client library composite
  # NOTE: These are common HTTP/network client patterns used in any networked
  # application. The name "network-exfil" was misleading - these are just client
  # capabilities, not exfiltration indicators.
  - id: http-client
    desc: HTTP client library usage
    crit: inert
    conf: 0.7
    any:
      - id: requests-post
      - id: requests-get
      - id: cap/comm/http/lib/urllib::urllib-word
      - id: socket-dot
      - id: fetch-call
      - id: xmlhttprequest-word
