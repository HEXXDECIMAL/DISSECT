# User Home Directory Access - Python
# Detects Python code accessing user home directories
# ATT&CK: T1083 (File and Directory Discovery)

defaults:
  for: [python]
  mbc: "E1083"
  attack: "T1083"
  crit: notable

traits:
  # os.path.expanduser("~") - most common pattern
  - id: python-expanduser
    desc: "Home directory expansion (os.path.expanduser)"
    conf: 0.8
    if:
      type: string
      regex: "os\\.path\\.expanduser\\([^)]*[\"']~"

  # === pathlib.Path.home() atomic indicators ===
  - id: python-path-home-direct
    desc: "Path.home() direct call"
    conf: 0.7
    crit: inert
    if:
      type: string
      substr: "Path.home()"

  - id: python-path-home-method
    desc: "Path().home() method call"
    conf: 0.7
    crit: inert
    if:
      type: string
      regex: "Path\\(\\)\\s*\\.home\\(\\)"

  # os.environ['HOME'] or os.environ.get('HOME')
  - id: python-environ-home
    desc: "HOME environment variable access"
    conf: 0.75
    if:
      type: string
      regex: "os\\.environ\\[['\"]HOME['\"]\\]|os\\.environ\\.get\\(['\"]HOME"

  # USERPROFILE for Windows
  - id: python-environ-userprofile
    desc: "USERPROFILE environment variable access (Windows)"
    conf: 0.75
    platforms: [windows]
    if:
      type: string
      regex: "os\\.environ\\[['\"]USERPROFILE['\"]\\]|os\\.environ\\.get\\(['\"]USERPROFILE"

  # os.getenv('HOME')
  - id: python-getenv-home
    desc: "Home directory via getenv"
    conf: 0.75
    if:
      type: string
      regex: "os\\.getenv\\(['\"]HOME['\"]"

  # Home directory access via any method (for composite rules)
  - id: python-home-access-any
    desc: "Home directory access via expanduser,"
    conf: 0.75
    if:
      type: string
      regex: "os\\.path\\.expanduser\\([^)]*~|Path\\.home\\(\\)|os\\.environ.{0,30}HOME"

  # Hidden directory path construction via os.path.join
  - id: python-hidden-dir-join
    desc: "Path join with hidden directory"
    conf: 0.75
    if:
      type: string
      regex: "os\\.path\\.join\\([^)]*,\\s*[\"']\\.[a-zA-Z]"

composite_rules:
  - id: python-pathlib-home
    desc: "Home directory via pathlib (Path.home)"
    conf: 0.8
    any:
      - id: python-path-home-direct
      - id: python-path-home-method

  # Home directory + hidden path construction
  - id: python-home-hidden-dir
    desc: "Hidden directory in home (likely"
    conf: 0.9
    crit: suspicious
    all:
      - id: python-home-access-any
      - id: python-hidden-dir-join
