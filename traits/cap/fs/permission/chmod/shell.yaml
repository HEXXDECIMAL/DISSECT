# File Permission Modification - Shell Commands
# MBC: E1222 (File Permission Modification)
# ATT&CK: T1222

traits:
  - id: chmod-666-shell
    desc: chmod 666 command (world-writable)
    crit: notable
    conf: 0.7
    mbc: E1222
    attack: T1222
    if:
      type: string
      regex: 'chmod [\-\w ]{0,4}666[ \$\w\/\.]{0,32}'

  - id: chmod-666-ruby
    desc: chmod(0666) Ruby-style call
    crit: notable
    conf: 0.7
    mbc: E1222
    attack: T1222
    if:
      type: string
      substr: "chmod(0666)"

  - id: chmod-777-shell
    desc: chmod 777 command (world-writable+executable)
    crit: suspicious
    conf: 0.7
    mbc: E1222
    attack: T1222
    if:
      type: string
      regex: 'chmod [\-\w ]{0,4}777[ \$\w\/\.]{0,32}'

  - id: chmod-777-ruby
    desc: chmod(0777) Ruby-style call
    crit: suspicious
    conf: 0.7
    mbc: E1222
    attack: T1222
    if:
      type: string
      substr: "chmod(0777)"

  - id: chmod-777-python
    desc: chmod(...777) Python-style call
    crit: suspicious
    conf: 0.7
    mbc: E1222
    attack: T1222
    if:
      type: string
      regex: 'chmod\([\w, ]{1,16}777\)'

  - id: chmod-plus-x-non-shell
    desc: chmod +x command (suspicious in non-shell)
    crit: suspicious
    conf: 0.8
    mbc: E1222
    attack: T1222
    for: [python, javascript, ruby, go, rust, c, cpp, pe, elf, macho]
    if:
      type: string
      regex: 'chmod\s+(\-[a-zA-Z]+\s+)*\+x'

  - id: chmod-1777-sticky
    desc: chmod 1777 (sticky bit, legitimate
    crit: inert
    conf: 1.0
    if:
      type: string
      substr: "chmod 1777"

  - id: chmod-01777-sticky
    desc: chmod 01777 (sticky bit, octal
    crit: inert
    conf: 1.0
    if:
      type: string
      substr: "chmod 01777"

  - id: chmod-777-var-tmp
    desc: chmod 0777 /var/tmp (legitimate temp
    crit: inert
    conf: 1.0
    if:
      type: string
      word: "chmod 0777 /var/tmp"

composite_rules:
  - id: chmod-world-write
    desc: Makes file world-writable (chmod 666,
    crit: suspicious
    conf: 0.66
    mbc: E1222
    attack: T1222
    any:
      - id: chmod-666-shell
      - id: chmod-666-ruby

  - id: chmod-777-patterns
    desc: chmod 777 pattern (any variant)
    crit: notable
    conf: 0.7
    mbc: E1222
    attack: T1222
    any:
      - id: chmod-777-shell
      - id: chmod-777-ruby
      - id: chmod-777-python

  - id: chmod-world-exec
    desc: Makes file world-writable and executable
    crit: suspicious
    conf: 0.66
    mbc: E1222
    attack: T1222
    all:
      - id: chmod-777-patterns
    none:
      - id: chmod-1777-sticky
      - id: chmod-01777-sticky
      - id: chmod-777-var-tmp
