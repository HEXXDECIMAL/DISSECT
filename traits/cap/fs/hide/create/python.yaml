# Hidden File/Directory Detection - Python
# Detects Python code creating hidden dotfiles/directories
# ATT&CK: T1564.001 (Hide Artifacts: Hidden Files and Directories)

defaults:
  for: [python]
  mbc: "F0005"
  attack: "T1564.001"
  crit: suspicious

traits:
  # Hidden directory in path join: os.path.join(..., ".hidden")
  - id: python-join-hidden
    desc: "Hidden directory construction via os.path.join"
    crit: notable
    conf: 0.9
    if:
      type: string
      # Matches: os.path.join(..., ".xyz") or join(foo, ".bar")
      regex: "os\\.path\\.join\\([^)]*[,]\\s*[\"']\\.[a-zA-Z][a-zA-Z0-9_-]*[\"']"
      not:
        - regex: "[\"']\\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)[\"']"

  # Pathlib hidden directory: Path(...) / ".hidden"
  - id: python-pathlib-hidden
    desc: "Hidden directory construction via pathlib"
    crit: notable
    conf: 0.9
    if:
      type: string
      # Matches: Path(...) / ".xyz" or path / ".bar"
      regex: "/\\s*[\"']\\.[a-zA-Z][a-zA-Z0-9_-]*[\"']"
      not:
        - regex: "[\"']\\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)[\"']"

  # String literal hidden path: "/.hidden" or "~/.config"
  - id: python-string-hidden-path
    desc: "Hidden path string literal"
    conf: 0.75
    crit: notable
    if:
      type: string
      # Matches: "/." or "~/." patterns in strings (not comments)
      regex: "[\"'][^\"']*[/~]\\.[a-zA-Z][a-zA-Z0-9_-]*"

  # makedirs with hidden directory
  - id: python-makedirs-hidden
    desc: "Create hidden directory (os.makedirs)"
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: "os\\.makedirs\\([^)]*\\.[a-zA-Z][a-zA-Z0-9_-]*"
      not:
        - regex: "[\"']\\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)[\"']"

  # mkdir with hidden directory (pathlib)
  - id: python-mkdir-hidden
    desc: "Create hidden directory (pathlib mkdir)"
    crit: notable
    conf: 0.9
    if:
      type: content
      regex: "\\.mkdir\\(\\s*[\"'](?:\\.[a-zA-Z][a-zA-Z0-9_-]*|[^\"']*[\\\\/]\\.[a-zA-Z][a-zA-Z0-9_-]*)[\"']"
    unless:
      - type: string
        regex: "\\.(tox|cache|git|venv|env|pytest_cache|mypy_cache|build|dist)"

  # Home directory expansion: expanduser or Path.home
  - id: python-home-expansion
    desc: "Home directory path expansion"
    crit: notable
    conf: 0.8
    if:
      type: string
      # expanduser or Path.home
      regex: 'os\.path\.expanduser\([^)]*~|Path\.home\(\)'

  # Hidden directory join pattern
  - id: python-hidden-join-pattern
    desc: "Join with hidden directory pattern"
    crit: notable
    conf: 0.8
    if:
      type: string
      # join with hidden dir
      regex: "os\\.path\\.join\\([^)]*[,]\\s*[\"']\\.[a-zA-Z]|/\\s*[\"']\\.[a-zA-Z]"

  # === File write atomic indicators ===
  - id: python-os-makedirs
    desc: os.makedirs call
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "os\\.makedirs\\("

  - id: python-open-write
    desc: open() with write mode
    crit: inert
    conf: 0.7
    if:
      type: string
      regex: "open\\([^)]+[\"']w"

  # Hidden directory with short cryptic name (.n2, .x, .tmp2)
  # Only match in contexts suggesting directory creation, not file extensions
  - id: python-cryptic-hidden
    desc: "Cryptic hidden directory name (likely"
    crit: suspicious
    conf: 0.85
    if:
      type: string
      # Match hidden dir pattern in os.path.join, Path /operator, or makedirs context
      # Explicitly exclude file extensions (.py, .js, .go, etc.) by matching directory patterns
      regex: "(os\\.path\\.join|/\\s*[\"']\\.|makedirs|mkdir)\\([^)]*[\"']\\.[a-z][a-z0-9]?[\"']"
      not:
        # Exclude common file extensions
        - regex: "[\"']\\.(py|js|ts|go|rs|rb|md|sh|c|h|pyc|pt|so|git|ssh|aws|npm)[\"']"

composite_rules:
  # File write or makedirs composite
  - id: python-write-or-makedirs
    desc: File write or directory creation
    crit: notable
    conf: 0.8
    needs: 2
    any:
      - id: python-os-makedirs
      - id: python-open-write

  # Home + hidden directory - classic malware staging area
