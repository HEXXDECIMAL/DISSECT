# Message Queue Threading Pattern
# Detects server-based malware using message queues
# Generic indicator for RATs, command servers

traits:
  # Removed peek-message-api duplicate - use cap/os/message/queue::peek-message-a (same pattern, canonical location)

  - id: cap/os/message/queue::post-thread-message-a  # not-dupe (threading IPC context)
    desc: Message queue posting (PostThreadMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "PostThreadMessageA"
    attack: "T1129"
    mbc: "C0019"

  - id: cap/os/message/queue::get-message-a  # not-dupe (threading IPC context)
    desc: Message queue retrieval (GetMessageA)
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: symbol
      exact: "GetMessageA"
    attack: "T1129"
    mbc: "C0019"

composite_rules:
  - id: message-queue-threading
    desc: Message queue-based thread communication
    crit: notable
    conf: 0.8
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    all:
      - id: cap/process/create
      - id: cap/process/threading
    any:
      - id: cap/os/message/queue::peek-message-a
      - id: cap/os/message/queue::get-message-a  # not-dupe (threading IPC context)
    needs: 1

  - id: message-based-command-server
    desc: Message queue command server pattern
    crit: notable
    conf: 0.85
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    all:
      - id: message-queue-threading
      - id: cap/os/message/queue::post-thread-message-a  # not-dupe (threading IPC context)

  - id: message-dispatch-framework
    desc: Sophisticated message dispatch framework
    crit: hostile
    conf: 0.9
    platforms: [windows]
    for: [pe]
    attack: "T1129"
    mbc: "C0019"
    all:
      - id: message-based-command-server
      - id: cap/process/create/

