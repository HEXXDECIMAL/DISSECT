# Legitimate Cryptographic Usage
# These traits indicate normal/benign cryptographic operations
# Useful for differential analysis to distinguish malware from legitimate software

defaults:
  for: [pe, elf, macho, dll, so, dylib]
  crit: benign

traits:
  # === OpenSSL atomic indicators ===
  - id: ssl-library-init
    desc: OpenSSL SSL_library_init
    conf: 0.7
    if:
      type: string
      exact: SSL_library_init

  - id: ssl-ctx-new
    desc: OpenSSL SSL_CTX_new
    conf: 0.7
    if:
      type: string
      exact: SSL_CTX_new

  - id: ssl-new
    desc: OpenSSL SSL_new
    conf: 0.7
    if:
      type: string
      exact: SSL_new

  - id: ssl-connect
    desc: OpenSSL SSL_connect
    conf: 0.7
    if:
      type: string
      exact: SSL_connect

  - id: ssl-read
    desc: OpenSSL SSL_read
    conf: 0.7
    if:
      type: string
      exact: SSL_read

  - id: ssl-write
    desc: OpenSSL SSL_write
    conf: 0.7
    if:
      type: string
      exact: SSL_write

  - id: tls-v1-method
    desc: TLSv1_method
    conf: 0.8
    if:
      type: string
      exact: TLSv1_method

  - id: tls-v1-2-method
    desc: TLSv1_2_method
    conf: 0.8
    if:
      type: string
      exact: TLSv1_2_method

  - id: tls-method
    desc: TLS_method
    conf: 0.8
    if:
      type: string
      exact: TLS_method

  - id: openssl-version
    desc: OpenSSL version string
    conf: 0.9
    if:
      type: string
      exact: "OpenSSL "

  # === Hash function atomic indicators ===
  - id: md5-init
    desc: MD5_Init function
    conf: 0.6
    if:
      type: string
      exact: MD5_Init

  - id: md5-update
    desc: MD5_Update function
    conf: 0.6
    if:
      type: string
      exact: MD5_Update

  - id: md5-final
    desc: MD5_Final function
    conf: 0.6
    if:
      type: string
      exact: MD5_Final

  - id: sha1-init
    desc: SHA1_Init function
    conf: 0.6
    if:
      type: string
      exact: SHA1_Init

  - id: sha1-update
    desc: SHA1_Update function
    conf: 0.6
    if:
      type: string
      exact: SHA1_Update

  - id: sha256-init
    desc: SHA256_Init function
    conf: 0.6
    if:
      type: string
      exact: SHA256_Init

  - id: sha256-update
    desc: SHA256_Update function
    conf: 0.6
    if:
      type: string
      exact: SHA256_Update

  - id: sha512-init
    desc: SHA512_Init function
    conf: 0.6
    if:
      type: string
      exact: SHA512_Init

  - id: go-crypto-sha256
    desc: Go crypto/sha256 package
    conf: 0.8
    if:
      type: string
      exact: crypto/sha256

  - id: go-crypto-sha512
    desc: Go crypto/sha512 package
    conf: 0.8
    if:
      type: string
      exact: crypto/sha512

  - id: go-crypto-md5
    desc: Go crypto/md5 package
    conf: 0.8
    if:
      type: string
      exact: crypto/md5

  # === GnuTLS atomic indicators ===
  - id: gnutls-init
    desc: gnutls_init function
    conf: 0.7
    if:
      type: string
      exact: gnutls_init

  - id: gnutls-handshake
    desc: gnutls_handshake function
    conf: 0.7
    if:
      type: string
      exact: gnutls_handshake

  - id: gnutls-record-send
    desc: gnutls_record_send function
    conf: 0.7
    if:
      type: string
      exact: gnutls_record_send

  - id: gnutls-record-recv
    desc: gnutls_record_recv function
    conf: 0.7
    if:
      type: string
      exact: gnutls_record_recv

  - id: gnutls-certificate
    desc: gnutls_certificate_ prefix
    conf: 0.7
    if:
      type: string
      regex: "gnutls_certificate_"

  - id: gnutls-x509
    desc: gnutls_x509_ prefix
    conf: 0.7
    if:
      type: string
      regex: "gnutls_x509_"

  - id: gnutls-version
    desc: GnuTLS version string
    conf: 0.9
    if:
      type: string
      exact: GnuTLS

  # === NSS atomic indicators ===
  - id: nss-init
    desc: NSS_Init function
    conf: 0.7
    if:
      type: string
      exact: NSS_Init

  - id: nss-pk11
    desc: PK11_ prefix
    conf: 0.7
    if:
      type: string
      regex: "PK11_"

  - id: nss-cert
    desc: CERT_ prefix
    conf: 0.7
    if:
      type: string
      regex: '\bCERT_'

  - id: nss-sec
    desc: SEC_ prefix
    conf: 0.7
    if:
      type: string
      regex: '\bSEC_'

  - id: nss-secmod
    desc: SECMOD_ prefix
    conf: 0.7
    if:
      type: string
      regex: "SECMOD_"

  - id: libnss
    desc: libnss library
    conf: 0.8
    if:
      type: string
      exact: libnss

  # === libsodium atomic indicators ===
  - id: sodium-init
    desc: sodium_init function
    conf: 0.8
    if:
      type: string
      exact: sodium_init

  - id: sodium-secretbox
    desc: crypto_secretbox function
    conf: 0.8
    if:
      type: string
      exact: crypto_secretbox

  - id: sodium-box
    desc: crypto_box function
    conf: 0.8
    if:
      type: string
      exact: crypto_box

  - id: sodium-sign
    desc: crypto_sign function
    conf: 0.8
    if:
      type: string
      exact: crypto_sign

  - id: sodium-hash
    desc: crypto_hash function
    conf: 0.8
    if:
      type: string
      exact: crypto_hash

  - id: sodium-pwhash
    desc: crypto_pwhash function
    conf: 0.8
    if:
      type: string
      exact: crypto_pwhash

  - id: sodium-randombytes
    desc: randombytes function
    conf: 0.7
    if:
      type: string
      exact: randombytes

  - id: libsodium
    desc: libsodium library
    conf: 0.9
    if:
      type: string
      exact: libsodium

  # === Rust crypto atomic indicators ===
  - id: rust-ring
    desc: Rust ring crate
    conf: 0.8
    if:
      type: string
      exact: "ring::"

  - id: rust-rustls
    desc: Rust rustls crate
    conf: 0.8
    if:
      type: string
      exact: "rustls::"

  - id: rust-aes
    desc: Rust aes crate
    conf: 0.7
    if:
      type: string
      exact: "aes::"

  - id: rust-chacha
    desc: Rust chacha20poly1305
    conf: 0.8
    if:
      type: string
      exact: chacha20poly1305

  - id: rust-rsa
    desc: Rust rsa crate
    conf: 0.7
    if:
      type: string
      exact: "rsa::"

  - id: rust-ed25519
    desc: Rust ed25519
    conf: 0.8
    if:
      type: string
      exact: ed25519

  - id: cargo-registry
    desc: Cargo registry path
    conf: 0.6
    if:
      type: string
      exact: /cargo/registry/src/

  # === Go crypto atomic indicators ===
  - id: go-crypto-tls
    desc: Go crypto/tls package
    conf: 0.8
    if:
      type: string
      exact: crypto/tls

  - id: go-crypto-x509
    desc: Go crypto/x509 package
    conf: 0.8
    if:
      type: string
      exact: crypto/x509

  - id: go-crypto-rsa
    desc: Go crypto/rsa package
    conf: 0.8
    if:
      type: string
      exact: crypto/rsa

  - id: go-crypto-ecdsa
    desc: Go crypto/ecdsa package
    conf: 0.8
    if:
      type: string
      exact: crypto/ecdsa

  - id: go-crypto-aes
    desc: Go crypto/aes package
    conf: 0.8
    if:
      type: string
      exact: crypto/aes

  - id: go-crypto-cipher
    desc: Go crypto/cipher package
    conf: 0.8
    if:
      type: string
      exact: crypto/cipher

  - id: go-crypto-rand
    desc: Go crypto/rand package
    conf: 0.8
    if:
      type: string
      exact: crypto/rand

  - id: go-x-crypto
    desc: Go golang.org/x/crypto
    conf: 0.8
    if:
      type: string
      exact: golang.org/x/crypto

  # === Certificate handling atomic indicators ===
  - id: x509-prefix
    desc: X509_ function prefix
    conf: 0.7
    if:
      type: string
      regex: "X509_"

  - id: x509-string
    desc: x509 string reference
    conf: 0.6
    if:
      type: string
      regex: '\bx509\b'
      case_insensitive: true

  - id: certificate-ref
    desc: certificate string reference
    conf: 0.5
    if:
      type: string
      regex: '\bcertificate\b'
      case_insensitive: true

  - id: pem-begin
    desc: PEM begin marker
    conf: 0.7
    if:
      type: string
      exact: "-----BEGIN"

  - id: pem-end
    desc: PEM end marker
    conf: 0.7
    if:
      type: string
      exact: "-----END"

  - id: ssl-certs-path
    desc: System SSL certs path
    conf: 0.8
    if:
      type: string
      exact: /etc/ssl/certs

  - id: ca-certificates
    desc: CA certificates reference
    conf: 0.8
    if:
      type: string
      exact: ca-certificates

  # === Secure random atomic indicators ===
  - id: dev-urandom
    desc: /dev/urandom access
    conf: 0.7
    if:
      type: string
      exact: /dev/urandom

  - id: dev-random
    desc: /dev/random access
    conf: 0.7
    if:
      type: string
      exact: /dev/random

  - id: rand-bytes
    desc: RAND_bytes function
    conf: 0.8
    if:
      type: string
      exact: RAND_bytes

  - id: getrandom
    desc: getrandom syscall
    conf: 0.8
    if:
      type: string
      exact: getrandom

  - id: arc4random
    desc: arc4random function
    conf: 0.8
    if:
      type: string
      exact: arc4random

  - id: getentropy
    desc: getentropy function
    conf: 0.8
    if:
      type: string
      exact: getentropy

  - id: secrandomcopybytes
    desc: SecRandomCopyBytes (macOS)
    conf: 0.8
    if:
      type: string
      exact: SecRandomCopyBytes

  # === KDF atomic indicators ===
  - id: pbkdf2
    desc: PBKDF2 key derivation
    conf: 0.75
    if:
      type: string
      exact: PBKDF2
      case_insensitive: true

  - id: scrypt
    desc: scrypt key derivation
    conf: 0.75
    if:
      type: string
      exact: scrypt
      case_insensitive: true

  - id: argon2
    desc: argon2 key derivation
    conf: 0.75
    if:
      type: string
      exact: argon2
      case_insensitive: true

  - id: bcrypt
    desc: bcrypt password hashing
    conf: 0.75
    if:
      type: string
      exact: bcrypt
      case_insensitive: true

  - id: hkdf
    desc: HKDF key derivation
    conf: 0.75
    if:
      type: string
      exact: HKDF

  - id: evp-pkey-derive
    desc: EVP_PKEY_derive function
    conf: 0.75
    if:
      type: string
      exact: EVP_PKEY_derive

  - id: pkcs5-pbkdf2
    desc: PKCS5_PBKDF2_HMAC function
    conf: 0.75
    if:
      type: string
      exact: PKCS5_PBKDF2_HMAC

composite_rules:
  # OpenSSL TLS (3+ SSL functions or any TLS method or version string)
  - id: openssl-tls
    desc: OpenSSL TLS library usage (legitimate)
    conf: 0.8
    count_min: 3
    any:
      - id: tls-v1-method
      - id: tls-v1-2-method
      - id: tls-method
      - id: openssl-version
      - id: ssl-library-init
      - id: ssl-ctx-new
      - id: ssl-new
      - id: ssl-connect
      - id: ssl-read
      - id: ssl-write

  # Hash functions (2+ MD5 or 2+ SHA or any Go crypto)
  - id: hash-functions
    desc: Standard cryptographic hash function usage
    conf: 0.75
    count_min: 2
    any:
      - id: md5-init
      - id: md5-update
      - id: md5-final
      - id: sha1-init
      - id: sha1-update
      - id: sha256-init
      - id: sha256-update
      - id: sha512-init
      - id: go-crypto-sha256
      - id: go-crypto-sha512
      - id: go-crypto-md5

  # GnuTLS (2+ functions or version string)
  - id: gnutls
    desc: GnuTLS library usage (legitimate)
    conf: 0.8
    count_min: 2
    any:
      - id: gnutls-version
      - id: gnutls-init
      - id: gnutls-handshake
      - id: gnutls-record-send
      - id: gnutls-record-recv
      - id: gnutls-certificate
      - id: gnutls-x509

  # NSS (2+ indicators)
  - id: nss
    desc: Mozilla NSS crypto library usage
    conf: 0.8
    count_min: 2
    any:
      - id: nss-init
      - id: nss-pk11
      - id: nss-cert
      - id: nss-sec
      - id: nss-secmod
      - id: libnss

  # libsodium (2+ functions or library name)
  - id: libsodium
    desc: libsodium modern crypto library usage
    conf: 0.8
    count_min: 2
    any:
      - id: cap/crypto/legitimate/libsodium
      - id: sodium-init
      - id: sodium-secretbox
      - id: sodium-box
      - id: sodium-sign
      - id: sodium-hash
      - id: sodium-pwhash
      - id: sodium-randombytes

  # Rust crypto
  - id: rust-crypto
    desc: Rust cryptographic crate usage
    conf: 0.75
    count_min: 1
    any:
      - id: rust-ring
      - id: rust-rustls
      - id: rust-chacha
      - id: rust-aes
      - id: rust-rsa
      - id: rust-ed25519

  # Go crypto (2+ packages)
  - id: go-crypto
    desc: Go standard crypto package usage
    conf: 0.8
    count_min: 2
    any:
      - id: go-crypto-tls
      - id: go-crypto-x509
      - id: go-crypto-rsa
      - id: go-crypto-ecdsa
      - id: go-crypto-aes
      - id: go-crypto-cipher
      - id: go-crypto-rand
      - id: go-x-crypto

  # Certificate handling
  - id: certificate-handling
    desc: X.509 certificate handling (legitimate)
    conf: 0.8
    count_min: 2
    any:
      - id: ssl-certs-path
      - id: ca-certificates
      - id: x509-prefix
      - id: x509-string
      - id: certificate-ref
      - id: pem-begin
      - id: pem-end

  # Secure random
  - id: secure-random
    desc: Secure random number generation
    conf: 0.8
    count_min: 1
    any:
      - id: dev-urandom
      - id: dev-random
      - id: rand-bytes
      - id: getrandom
      - id: arc4random
      - id: getentropy
      - id: secrandomcopybytes

  # Key derivation
  - id: key-derivation
    desc: Key derivation function usage
    conf: 0.75
    count_min: 1
    any:
      - id: pbkdf2
      - id: scrypt
      - id: argon2
      - id: bcrypt
      - id: hkdf
      - id: evp-pkey-derive
      - id: pkcs5-pbkdf2
