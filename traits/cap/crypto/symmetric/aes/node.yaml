# Node.js AES Encryption Traits
# Detects AES encryption usage patterns (often used in C2 communication)
# MBC: C0027 (Cryptography)
# ATT&CK: T1573 (Encrypted Channel)

traits:
  # === Crypto module import atomic indicators ===
  - id: crypto-require-call
    desc: require('crypto') import
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "require\\(['\"]crypto['\"]\\)"

  - id: crypto-from-import
    desc: from 'crypto' import (ESM)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "from ['\"]crypto['\"]"

  # Cipher Creation
  # createCipheriv - use cap/crypto/operations/encryption::create-cipheriv

  - id: createDecipheriv
    desc: Create decipher with IV (symmetric)
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "createDecipheriv"

  # === AES-128-CTR atomic indicators ===
  - id: aes-128-ctr-dash
    desc: AES-128-CTR with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "aes-128-ctr"

  - id: aes128ctr-nodash
    desc: AES-128-CTR without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "aes128ctr"

  # === AES-256-CBC atomic indicators ===
  - id: aes-256-cbc-dash
    desc: AES-256-CBC with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "aes-256-cbc"

  - id: aes256cbc-nodash
    desc: AES-256-CBC without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "aes256cbc"

  # === AES-256-GCM atomic indicators ===
  - id: aes-256-gcm-dash
    desc: AES-256-GCM with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "aes-256-gcm"

  - id: aes256gcm-nodash
    desc: AES-256-GCM without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      substr: "aes256gcm"

  # === AES algorithm string ===
  - id: aes-algorithm
    desc: AES algorithm string prefix
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\baes-"
      case_insensitive: true

  # === Key/IV Handling micro-traits ===
  - id: hardcoded-key-pattern
    desc: Hardcoded encryption key in string
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "(?:key|secret|password|pass)\\s*[=:]\\s*Buffer\\.from\\(['\"][0-9a-fA-F]{32,}['\"]"

  - id: hardcoded-iv-pattern
    desc: Hardcoded IV in string literal
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "\\biv\\b\\s*[=:]\\s*Buffer\\.from\\(['\"][0-9a-fA-F]{16,}['\"]"

  - id: buffer-hex-key-material
    desc: Buffer.from with hex-encoded key material
    crit: notable
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: raw
      regex: "Buffer\\.from\\(['\"][0-9a-fA-F]{32,}['\"],\\s*['\"]hex['\"]"

  - id: buffer-from-hex
    desc: Buffer.from with long hex string
    crit: notable
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\s*\\(\\s*['\"][0-9a-fA-F]{32,}['\"]"

  # === Compression micro-traits ===
  - id: gzip-function
    desc: gzip compression function
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "gzip"

  - id: gunzip-function
    desc: gunzip decompression function
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      substr: "gunzip"

  # Removed inflate-function duplicate - use cap/data/compression/library::inflate (symbol works for all file types)
  # Removed deflate-function duplicate - use cap/data/compression/library::deflate (symbol works for all file types)

composite_rules:
  # Crypto require composite
  - id: crypto-require
    desc: Node.js crypto module import
    crit: notable
    conf: 0.9
    for: [javascript, typescript]
    any:
      - id: crypto-require-call
      - id: crypto-from-import

  # AES-128-CTR composite
  - id: aes-128-ctr
    desc: AES-128-CTR encryption (stream cipher mode)
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    any:
      - id: aes-128-ctr-dash
      - id: aes128ctr-nodash

  # AES-256-CBC composite
  - id: aes-256-cbc
    desc: AES-256-CBC encryption
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    any:
      - id: aes-256-cbc-dash
      - id: aes256cbc-nodash

  # AES-256-GCM composite
  - id: aes-256-gcm
    desc: AES-256-GCM authenticated encryption
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    any:
      - id: aes-256-gcm-dash
      - id: aes256gcm-nodash

  # Cipher creation composite
  - id: cipher-create
    desc: Cipher or decipher creation
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    any:
      - id: cap/crypto/operations/encryption::create-cipheriv
      - id: createDecipheriv

  # Network request composite
  - id: http-client
    desc: HTTP/HTTPS client request capability
    crit: inert
    conf: 0.8
    for: [javascript, typescript]
    all:
      - id: cap/comm/http/request/

  # Compression library composite
  - id: compression-lib
    desc: Compression/decompression library usage
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    any:
      - id: cap/data/encode/compression::zlib-signature
      - id: gzip-function
      - id: gunzip-function
      - id: cap/data/compression/library::inflate
      - id: cap/data/compression/library::deflate

  # Hardcoded crypto key composite
  - id: hardcoded-key
    desc: Hardcoded encryption key pattern
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    any:
      - id: hardcoded-key-pattern
      - id: hardcoded-iv-pattern
      - id: buffer-from-hex
      - id: buffer-hex-key-material

  # Encrypted C2 channel detection (migrated from YARA)
  - id: encrypted-c2
    desc: AES encryption combined with network
    crit: suspicious
    conf: 0.9
    mbc: "C0027"
    attack: "T1573"
    for: [javascript, typescript]
    all:
      - id: cipher-create
      - id: aes-algorithm
      - id: http-client

  # Compression with encryption (migrated from YARA)
  - id: gzip-with-crypto
    desc: Gzip compression with encryption (obfuscated
    crit: suspicious
    conf: 0.85
    mbc: "C0027"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: compression-lib
      - id: cipher-create
