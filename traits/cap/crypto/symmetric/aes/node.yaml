# Node.js AES Encryption Traits
# Detects AES encryption usage patterns (often used in C2 communication)
# MBC: C0027 (Cryptography)
# ATT&CK: T1573 (Encrypted Channel)

traits:
  # === Crypto module import atomic indicators ===
  - id: crypto-require-call
    desc: require('crypto') import
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "require\\(['\"]crypto['\"]\\)"

  - id: crypto-from-import
    desc: from 'crypto' import (ESM)
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      regex: "from ['\"]crypto['\"]"

  # Cipher Creation
  - id: createCipheriv
    desc: Create cipher with IV (symmetric
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      exact: "createCipheriv"

  - id: createDecipheriv
    desc: Create decipher with IV (symmetric
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: ast
      kind: call
      exact: "createDecipheriv"

  # === AES-128-CTR atomic indicators ===
  - id: aes-128-ctr-dash
    desc: AES-128-CTR with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes-128-ctr"

  - id: aes128ctr-nodash
    desc: AES-128-CTR without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes128ctr"

  # === AES-256-CBC atomic indicators ===
  - id: aes-256-cbc-dash
    desc: AES-256-CBC with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes-256-cbc"

  - id: aes256cbc-nodash
    desc: AES-256-CBC without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes256cbc"

  # === AES-256-GCM atomic indicators ===
  - id: aes-256-gcm-dash
    desc: AES-256-GCM with dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes-256-gcm"

  - id: aes256gcm-nodash
    desc: AES-256-GCM without dashes
    crit: inert
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      exact: "aes256gcm"

  - id: dns-resolve-txt
    desc: DNS TXT record resolution
    crit: notable
    conf: 0.85
    for: [javascript, typescript]
    if:
      type: string
      exact: "resolveTxt"

  # === AES algorithm string ===
  - id: aes-algorithm
    desc: AES algorithm string prefix
    crit: inert
    conf: 0.7
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\baes-"
      case_insensitive: true

  # === Key/IV Handling micro-traits ===
  - id: hardcoded-key-pattern
    desc: Hardcoded encryption key in string
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "['\"](?:key|secret|password|pass)['\"]\\s*[,:=]\\s*['\"][A-Za-z0-9+/=]{16,}['\"]"

  - id: hardcoded-iv-pattern
    desc: Hardcoded IV in string literal
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "\\biv\\s*[,:=]\\s*['\"][A-Za-z0-9+/=]{16,}['\"]"

  - id: buffer-from-hex
    desc: Buffer.from with long hex string
    crit: notable
    conf: 0.75
    mbc: "C0027"
    for: [javascript, typescript]
    if:
      type: string
      regex: "Buffer\\.from\\s*\\(\\s*['\"][0-9a-fA-F]{32,}['\"]"

  # === Compression micro-traits ===
  - id: zlib-module
    desc: zlib compression module
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "zlib"

  - id: gzip-function
    desc: gzip compression function
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "gzip"

  - id: gunzip-function
    desc: gunzip decompression function
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "gunzip"

  - id: inflate-function
    desc: inflate decompression function
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "inflate"

  - id: deflate-function
    desc: deflate compression function
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    if:
      type: string
      exact: "deflate"

composite_rules:
  # Crypto require composite
  - id: crypto-require
    desc: Node.js crypto module import
    crit: notable
    conf: 0.9
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: crypto-require-call
      - id: crypto-from-import

  # AES-128-CTR composite
  - id: aes-128-ctr
    desc: AES-128-CTR encryption (stream cipher mode)
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: aes-128-ctr-dash
      - id: aes128ctr-nodash

  # AES-256-CBC composite
  - id: aes-256-cbc
    desc: AES-256-CBC encryption
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: aes-256-cbc-dash
      - id: aes256cbc-nodash

  # AES-256-GCM composite
  - id: aes-256-gcm
    desc: AES-256-GCM authenticated encryption
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: aes-256-gcm-dash
      - id: aes256gcm-nodash

  # Cipher creation composite
  - id: cipher-create
    desc: Cipher or decipher creation
    crit: notable
    conf: 0.85
    mbc: "C0027"
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: createCipheriv
      - id: createDecipheriv

  # Network request composite
  - id: http-client
    desc: HTTP/HTTPS client request capability
    crit: inert
    conf: 0.8
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: cap/comm/http/request/javascript/https-request
      - id: cap/comm/http/request/javascript/http-request
      - id: cap/comm/http/request/javascript/fetch-call
      - id: cap/comm/http/request/javascript/axios
      - id: dns-resolve-txt

  # Compression library composite
  - id: compression-lib
    desc: Compression/decompression library usage
    crit: notable
    conf: 0.8
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: zlib-module
      - id: gzip-function
      - id: gunzip-function
      - id: inflate-function
      - id: deflate-function

  # Hardcoded crypto key composite
  - id: hardcoded-key
    desc: Hardcoded encryption key pattern
    crit: suspicious
    conf: 0.8
    mbc: "C0027"
    for: [javascript, typescript]
    count_min: 1
    any:
      - id: hardcoded-key-pattern
      - id: hardcoded-iv-pattern
      - id: buffer-from-hex

  # Encrypted C2 channel detection (migrated from YARA)
  - id: encrypted-c2
    desc: AES encryption combined with network
    crit: suspicious
    conf: 0.9
    mbc: "C0027"
    attack: "T1573"
    for: [javascript, typescript]
    all:
      - id: cipher-create
      - id: aes-algorithm
      - id: http-client

  # Compression with encryption (migrated from YARA)
  - id: gzip-with-crypto
    desc: Gzip compression with encryption (obfuscated
    crit: suspicious
    conf: 0.85
    mbc: "C0027"
    attack: "T1027"
    for: [javascript, typescript]
    all:
      - id: compression-lib
      - id: cipher-create
