traits:
  - id: js-fragmented-url-construction
    desc: URL construction from many small fragments (likely
    crit: suspicious
    conf: 0.95
    mbc: "B0032"
    attack: "T1027"
    for: [javascript]
    if:
      type: ast
      lang: javascript
      # Matches: "htt" + "p:" + "//" or similar deeply nested concatenations
      # The engine may limit depth, so we look for many additions in a row or within a function
      query: |
        (binary_expression
          operator: "+"
          left: (binary_expression
            operator: "+"
            left: (string) @s1 (#match? @s1 "^"https?"$")
          )
        )
    # Also support a more robust pattern: a sequence of variables being concatenated
    # that starts with a 'http' fragment.
    # But since we have minified variables, we can also use raw regex for the pattern
    # of many '+' and (function|variable) calls together.

  - id: js-fragmented-url-regex
    desc: URL construction from many concatenated fragments (Regex)
    crit: suspicious
    conf: 0.9
    for: [javascript]
    if:
      type: raw
      # Many concatenations of IIFEs or identifiers: (...) + (...) + (...) + ...
      regex: '(?:\([\w\s]*\)|[\w]+)\s*\+\s*(?:\([\w\s]*\)|[\w]+)\s*\+\s*(?:\([\w\s]*\)|[\w]+)\s*\+\s*(?:\([\w\s]*\)|[\w]+)'
      count_min: 2 # Multiple sequences of this
