# Serialization Library Detection
# Useful for ML features and supply chain diff analysis

traits:
  # === Protocol Buffers micro-traits ===
  - id: google-protobuf
    desc: google.protobuf namespace
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "google.protobuf"
      exclude_patterns: ["protocolInformation", "id-mod-timestamp-protocol"]

  - id: proto-extension
    desc: .proto file extension
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: ".proto"
    not:
      - substr: ".prototype"

  - id: protobuf-string
    desc: protobuf string
    crit: notable
    conf: 0.8
    if:
      type: string
      word: "protobuf"

  - id: parse-from-string
    desc: ParseFromString method
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "ParseFromString"

  - id: serialize-to-string
    desc: SerializeToString method
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "SerializeToString"

  - id: protoc-string
    desc: protoc compiler
    crit: notable
    conf: 0.7
    if:
      type: string
      word: "protoc"

  # === JSON micro-traits ===
  - id: json-marshal-go
    desc: Go json.Marshal
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "json.Marshal"

  - id: json-unmarshal-go
    desc: Go json.Unmarshal
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "json.Unmarshal"

  - id: json-parse-js
    desc: JavaScript JSON.parse
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "JSON.parse"

  - id: json-stringify-js
    desc: JavaScript JSON.stringify
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "JSON.stringify"

  - id: serde-json
    desc: Rust serde_json
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "serde_json"

  - id: nlohmann-json
    desc: C++ nlohmann/json
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "nlohmann/json"

  - id: rapidjson
    desc: rapidjson library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "rapidjson"

  - id: cjson
    desc: cJSON library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "cJSON"

  # === YAML micro-traits ===
  - id: yaml-v2
    desc: yaml.v2 Go library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "yaml.v2"

  - id: yaml-v3
    desc: yaml.v3 Go library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "yaml.v3"

  - id: pyyaml
    desc: PyYAML library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "PyYAML"

  - id: yaml-safe-load
    desc: yaml.safe_load Python
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "yaml.safe_load"

  - id: serde-yaml
    desc: Rust serde_yaml
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "serde_yaml"

  - id: yaml-cpp
    desc: yaml-cpp library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "yaml-cpp"

  # === XML micro-traits ===
  - id: encoding-xml
    desc: Go encoding/xml
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "encoding/xml"

  - id: xml-etree
    desc: Python xml.etree
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "xml.etree"

  - id: lxml
    desc: lxml library
    crit: notable
    conf: 0.85
    if:
      type: string
      exact: "lxml"

  - id: libxml2
    desc: libxml2 library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "libxml2"

  - id: tinyxml
    desc: tinyxml library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "tinyxml"

  - id: pugixml
    desc: pugixml library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "pugixml"

  - id: xerces
    desc: xerces library
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "xerces"

  # === MessagePack micro-traits ===
  - id: msgpack-lower
    desc: msgpack string
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "msgpack"

  - id: msgpack-camel
    desc: MessagePack string
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "MessagePack"

  - id: msgpack-go
    desc: Go vmihailenco/msgpack
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "vmihailenco/msgpack"

  # === CBOR micro-traits ===
  - id: cbor-lower
    desc: cbor string (lowercase)
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: "(?i)\\bcbor\\b"

  # === Apache Avro micro-traits ===
  - id: avro-lower
    desc: avro string
    crit: notable
    conf: 0.9
    if:
      type: string
      exact: "avro"

  - id: avro-apache
    desc: org.apache.avro
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "org.apache.avro"

  - id: avsc-extension
    desc: .avsc file extension
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: ".avsc"

  # === Apache Thrift micro-traits ===
  - id: thrift-lower
    desc: thrift string
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "thrift"

  - id: thrift-apache
    desc: apache.thrift
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "apache.thrift"

  - id: thrift-extension
    desc: .thrift file extension
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: ".thrift"

  # === FlatBuffers micro-traits ===
  - id: flatbuffers-string
    desc: flatbuffers string
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "flatbuffers"

  - id: flatbuffer-builder
    desc: FlatBufferBuilder class
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "FlatBufferBuilder"

  - id: fbs-extension
    desc: .fbs file extension
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: ".fbs"

  # === Cap'n Proto micro-traits ===
  - id: capnp-string
    desc: capnp string
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "capnp"

  - id: capnproto-string
    desc: capnproto string
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "capnproto"

  - id: capnp-extension
    desc: .capnp file extension
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: ".capnp"

  # === BSON micro-traits ===
  - id: bson-lower
    desc: bson string
    crit: notable
    conf: 0.9
    if:
      type: string
      exact: "bson"

  - id: bson-upper
    desc: BSON string
    crit: notable
    conf: 0.9
    if:
      type: string
      exact: "BSON"

  - id: bson-go
    desc: Go mongo-driver/bson
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "go.mongodb.org/mongo-driver/bson"

  # === Python pickle micro-traits ===
  - id: pickle-load
    desc: pickle.load
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "pickle.load"

  - id: pickle-dump
    desc: pickle.dump
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "pickle.dump"

  - id: cpickle
    desc: cPickle
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "cPickle"

  - id: pickle-unpickler
    desc: pickle.Unpickler
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "pickle.Unpickler"

  # === Go gob micro-traits ===
  - id: encoding-gob
    desc: Go encoding/gob
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "encoding/gob"

  - id: gob-newencoder
    desc: gob.NewEncoder
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "gob.NewEncoder"

  - id: gob-newdecoder
    desc: gob.NewDecoder
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "gob.NewDecoder"

composite_rules:
  # Protocol Buffers composite (migrated from YARA)
  - id: protobuf
    desc: Google Protocol Buffers
    crit: notable
    conf: 0.9
    any:
      - id: google-protobuf
      - id: proto-extension
      - id: protobuf-string
      - id: parse-from-string
      - id: serialize-to-string
      - id: protoc-string

  # JSON composite (migrated from YARA)
  - id: json
    desc: JSON serialization libraries
    crit: notable
    conf: 0.85
    any:
      - id: json-marshal-go
      - id: json-unmarshal-go
      - id: json-parse-js
      - id: json-stringify-js
      - id: serde-json
      - id: nlohmann-json
      - id: rapidjson
      - id: cjson

  # YAML composite (migrated from YARA)
  - id: yaml
    desc: YAML serialization libraries
    crit: notable
    conf: 0.85
    any:
      - id: yaml-v2
      - id: yaml-v3
      - id: pyyaml
      - id: yaml-safe-load
      - id: serde-yaml
      - id: yaml-cpp

  # XML composite (migrated from YARA)
  - id: xml
    desc: XML serialization libraries
    crit: notable
    conf: 0.85
    any:
      - id: encoding-xml
      - id: xml-etree
      - id: lxml
      - id: libxml2
      - id: tinyxml
      - id: pugixml
      - id: xerces

  # MessagePack composite (migrated from YARA)
  - id: msgpack
    desc: MessagePack serialization
    crit: notable
    conf: 0.9
    any:
      - id: msgpack-lower
      - id: msgpack-camel
      - id: msgpack-go

  # CBOR composite (migrated from YARA)

  # Apache Avro composite (migrated from YARA)
  - id: avro
    desc: Apache Avro serialization
    crit: notable
    conf: 0.9
    any:
      - id: avro-lower
      - id: avro-apache
      - id: avsc-extension

  # Apache Thrift composite (migrated from YARA)
  - id: thrift
    desc: Apache Thrift serialization
    crit: notable
    conf: 0.9
    any:
      - id: thrift-lower
      - id: thrift-apache
      - id: thrift-extension

  # FlatBuffers composite (migrated from YARA)
  - id: flatbuffers
    desc: Google FlatBuffers
    crit: notable
    conf: 0.9
    any:
      - id: flatbuffers-string
      - id: flatbuffer-builder
      - id: fbs-extension

  # Cap'n Proto composite (migrated from YARA)
  - id: capnproto
    desc: Cap'n Proto serialization
    crit: notable
    conf: 0.9
    any:
      - id: capnp-string
      - id: capnproto-string
      - id: capnp-extension

  # BSON composite (migrated from YARA)
  - id: bson
    desc: BSON serialization (MongoDB)
    crit: notable
    conf: 0.9
    any:
      - id: bson-lower
      - id: bson-upper
      - id: bson-go

  # Pickle composite (migrated from YARA)
  - id: pickle
    desc: Python pickle serialization
    crit: notable
    conf: 0.9
    any:
      - id: pickle-load
      - id: pickle-dump
      - id: cpickle
      - id: pickle-unpickler

  # Gob composite (migrated from YARA)
  - id: gob
    desc: Go gob serialization
    crit: notable
    conf: 0.9
    any:
      - id: encoding-gob
      - id: gob-newencoder
      - id: gob-newdecoder
