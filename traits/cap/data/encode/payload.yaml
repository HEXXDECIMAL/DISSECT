# Encoded Payload Detection
# Detects large encoded/compressed payloads in binaries
# Indicates obfuscated second-stage malware

traits:
  - id: large-base64-payload
    desc: Large base64 encoded payload
    crit: notable
    conf: 0.8
    platforms: [all]
    for: [pe, elf, macho]
    if:
      type: string
      regex: "^[A-Za-z0-9+/]{200,}={0,2}$"
    # Exclude CamelCase identifier strings (CLI options, enum variants, etc.)
    # These are common in compiled binaries and not actual payloads
    # Pattern: strings that are mostly CamelCase words without + or /
    not:
      # Pure CamelCase identifiers (no +/)
      - regex: '^([A-Z][a-z0-9]*)+$'
      # Strings starting with multiple CamelCase words (enum variants, struct names)
      - regex: '^([A-Z][a-z]+){5,}'
      # Pure alphabetic strings (font glyph tables, identifier data - not real base64)
      - regex: '^[A-Za-z]+$'
    attack: "T1140"
    mbc: "C0043"

  - id: large-hex-payload
    desc: Large hexadecimal encoded payload
    crit: notable
    conf: 0.8
    platforms: [all]
    for: [pe, elf, macho]
    if:
      type: string
      regex: "^[0-9A-Fa-f]{200,}$"
    attack: "T1140"
    mbc: "C0043"

  - id: payload-blob-metrics
    desc: High entropy encrypted data
    crit: notable
    conf: 0.75
    platforms: [windows]
    for: [pe]
    if:
      type: section_entropy
      section: "^\\.rdata"
      min_entropy: 6.5

composite_rules:
  - id: embedded-obfuscated-payload
    desc: Embedded obfuscated payload
    crit: suspicious
    conf: 0.85
    attack: "T1140"
    mbc: "C0043"
    platforms: [all]
    for: [pe, elf, macho]
    any:
      - id: large-base64-payload
      - id: large-hex-payload
      - id: payload-blob-metrics
    none:
      - id: meta/signed/type/platform
