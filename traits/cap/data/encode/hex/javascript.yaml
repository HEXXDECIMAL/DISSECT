defaults:
  for: [javascript, typescript]

traits:
  - id: buffer-from-hex
    desc: Hex decoding/usage via Buffer.from
    crit: inert
    conf: 0.8
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (member_expression
            object: (identifier) @buf
            property: (property_identifier) @from
          )
          arguments: (arguments
            (_)
            (string) @enc
          )
          (#eq? @buf "Buffer")
          (#eq? @from "from")
          (#match? @enc "hex")
        )

  - id: buffer-to-hex
    desc: Hex encoding via Buffer.toString('hex')
    crit: notable
    conf: 0.8
    if:
      type: ast
      language: javascript
      query: |
        (call_expression
          function: (member_expression
            object: (_) @buf
            property: (property_identifier) @tostring
          )
          arguments: (arguments
            (string) @enc
          )
          (#match? @tostring "toString")
          (#match? @enc "hex")
        )

  - id: js-hex-char-array
    desc: Array of hex-encoded characters
    crit: notable
    conf: 0.8
    if:
      type: ast
      language: javascript
      query: |
        (
          (array
            (string (string_fragment) @hex)
          )
          (#match? @hex "^0x[0-9a-fA-F]{1,2}$")
        )
    unless:
      - id: meta/library/syntaxhighlighter::syntaxhighlighter-brush
      - id: meta/dev/testing::node-common-require
      - id: meta/library::ioredis-auto-pipeline
      - id: meta/library::commander
      - id: meta/library/nodeunit::nodeunit
      - id: meta/library::commander-require

  - id: js-tohex-helper
    desc: Helper function 'toHex' for data encoding
    crit: notable
    conf: 0.9
    if:
      type: ast
      language: javascript
      query: |
        (function_declaration
          name: (identifier) @name
          parameters: (formal_parameters (identifier) @param)
          body: (statement_block
            (_)
            (_)
            (return_statement (identifier) @text_ref)
          )
        )
        (#eq? @name "toHex")