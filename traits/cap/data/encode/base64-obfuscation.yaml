# Base64 String Obfuscation Detection
# Detects base64-encoded sensitive paths and credentials
# ATT&CK: T1027.001 (Obfuscation: Steganography or Compression)
# MBC: F0001 (Obfuscation)

traits:
  # === Base64-Encoded Persistence Paths ===
  - id: base64-systemd-path
    desc: "Base64-encoded systemd path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "/usr/lib/systemd/systemd"
    notes: "Base64-encoded systemd service for persistent execution"
    attack: "T1547"

  - id: base64-ssh-sftp-path
    desc: "Base64-encoded SSH SFTP path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "/usr/libexec/openssh/sftp-server"
    notes: "Base64-encoded OpenSSH SFTP subsystem for backdoor access"
    attack: "T1021.004"

  # === Base64-Encoded DVR Targeting Paths ===
  - id: base64-hikvision-firmware-path
    desc: "Base64-encoded Hikvision path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "usr/dvr_main _8182T_1108"
    notes: "Base64-encoded Hikvision 8182T firmware target (revision 1108)"
    attack: "T1046"

  - id: base64-anko-dvr-path
    desc: "Base64-encoded Anko DVR path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "anko-app/ankosample _8182T_1104"
    notes: "Base64-encoded Anko DVR application target (revision 1104)"
    attack: "T1046"

  # === Generic Base64 Encoding Pattern ===
  - id: base64-path-prefix
    desc: "Base64-encoded system path"
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      regex: "^/[a-z]{2,}[a-z_/]*$"
    notes: "Common pattern for base64-encoded system paths and binaries"
    attack: "T1027.001"

  - id: base64-suspicious-encoding
    desc: "Suspicious base64 patterns"
    crit: suspicious
    conf: 0.75
    for: [elf, shell]
    if:
      type: string
      regex: "[a-zA-Z0-9+/]={1,3}$"
    notes: "Base64-like padding patterns suggesting encoded content"
    attack: "T1027.001"

composite_rules:
  - id: base64-encoded-dvr-targeting
    desc: "Base64-encoded DVR targeting"
    crit: suspicious
    conf: 0.93
    for: [elf, shell]
    attack: "T1046"
    notes: |
      Base64-encoded DVR/CCTV platform targeting path detected.
      Indicates obfuscated device-specific exploitation.
    any:
      - id: base64-hikvision-firmware-path
      - id: base64-anko-dvr-path

  - id: base64-obfuscation-evidence
    desc: "Base64 obfuscation evidence"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1027.001"
    mbc: "F0001"
    notes: |
      Multiple base64-encoded system paths detected.
      Indicates systematic string obfuscation strategy.
    all:
      - id: base64-path-prefix
      - id: base64-suspicious-encoding

  - id: mirai-base64-obfuscation
    desc: "Mirai base64 obfuscation"
    crit: suspicious
    conf: 0.92
    for: [elf, shell]
    attack: "T1027.001"
    mbc: "F0001"
    notes: |
      Mirai botnet with base64-encoded sensitive paths.
      Pattern combines:
      - Mirai identification
      - Base64-encoded persistence mechanisms
      - Base64-encoded backdoor infrastructure
      - Base64-encoded DVR targeting
    all:
      - id: known/malware/botnet/mirai
      - id: base64-obfuscation-evidence

