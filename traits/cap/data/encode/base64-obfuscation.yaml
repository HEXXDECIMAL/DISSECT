# Base64 String Obfuscation Detection
# Detects base64-encoded sensitive paths and credentials
# ATT&CK: T1027.001 (Obfuscation: Steganography or Compression)
# MBC: F0001 (Obfuscation)

traits:
  # === Base64-Encoded Persistence Paths ===
  - id: base64-systemd-path
    desc: "Base64-encoded systemd path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "/usr/lib/systemd/systemd"
    attack: "T1547"

  - id: base64-ssh-sftp-path
    desc: "Base64-encoded SSH SFTP path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "/usr/libexec/openssh/sftp-server"
    attack: "T1021.004"

  # === Base64-Encoded DVR Targeting Paths ===
  - id: base64-hikvision-firmware-path
    desc: "Base64-encoded Hikvision path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "usr/dvr_main _8182T_1108"
    attack: "T1046"

  - id: base64-anko-dvr-path
    desc: "Base64-encoded Anko DVR path"
    crit: suspicious
    conf: 0.95
    for: [elf, shell]
    if:
      type: string
      substr: "anko-app/ankosample _8182T_1104"
    attack: "T1046"

  # === Generic Base64 Encoding Pattern ===
  - id: base64-path-prefix
    desc: "Base64-encoded system path"
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      regex: "^/[a-z]{2,}[a-z_/]*$"
    attack: "T1027.001"

  - id: base64-suspicious-encoding
    desc: "Suspicious base64 patterns"
    crit: suspicious
    conf: 0.75
    for: [elf, shell]
    if:
      type: string
      regex: "[a-zA-Z0-9+/]={1,3}$"
    attack: "T1027.001"

composite_rules:
  - id: base64-encoded-dvr-targeting
    desc: "Base64-encoded DVR targeting"
    crit: suspicious
    conf: 0.93
    for: [elf, shell]
    attack: "T1046"
    any:
      - id: base64-hikvision-firmware-path
      - id: base64-anko-dvr-path

  - id: base64-obfuscation-evidence
    desc: "Base64 obfuscation evidence"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1027.001"
    mbc: "F0001"
    all:
      - id: base64-path-prefix
      - id: base64-suspicious-encoding

  - id: mirai-base64-obfuscation
    desc: "Mirai base64 obfuscation"
    crit: suspicious
    conf: 0.92
    for: [elf, shell]
    attack: "T1027.001"
    mbc: "F0001"
    all:
      - id: known/malware/botnet/mirai
      - id: base64-obfuscation-evidence

