# XOR Obfuscation Detection
# Detects XOR-encoded strings and obfuscation markers
# ATT&CK: T1027 (Obfuscated Files or Information)
# MBC: B0041 (Execution)

traits:
  # === XOR Markers ===
  - id: xor-infection-marker
    desc: "XOR infection marker"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      substr: "@GOLJ]LM"
    attack: "T1027"

  - id: xor-marker-extended
    desc: "Extended XOR marker"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "EFE)@GOLJ]LM)HNH@G"
    attack: "T1027"

  # === Obfuscation Patterns ===
  - id: tab-terminated-strings
    desc: "Tab-terminated strings"
    crit: suspicious
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      regex: "[a-zA-Z0-9]{4,}\\t$"
    attack: "T1027"

  # Note: Large Rust/Go binaries with regex/Unicode support contain lookup tables
  # that appear as unusual character sequences. Size constraint reduces FPs.
  # Compression tools (zstd, lzma, xz, etc.) contain Huffman/FSE lookup tables
  # that legitimately contain unusual character sequences.
  # Build tools (make, cmake, etc.) contain shell metacharacter definitions.
  - id: unusual-character-combinations
    desc: "Unusual character combinations"
    crit: suspicious
    conf: 0.65
    for: [elf]
    size_max: 2097152
    if:
      type: string
      regex: "[^a-zA-Z0-9\\s\\.,\\-_/\\\\:@]{8,}"
      not:
        # Shell metacharacter definitions used by build tools, shells, interpreters
        - regex: "^[#;\"'*?\\[\\]&|<>(){}$`^~!]+$"
    attack: "T1027"
    unless:
      - id: cap/exec/load/system-lib-marker
      - id: cap/interface/usage/usage-help
      # Exclude curl/libcurl which has special chars in help text
      - id: cap/comm/download/curl/curl-easy-init
    downgrade:
      any:
        # Compression libraries have Huffman/FSE lookup tables that trigger this
        - type: string
          substr: "ZSTD_CCtx"
        - type: string
          substr: "ZSTD_DCtx"
        - type: string
          substr: "libzstd"
        - type: string
          substr: "liblzma"
        - type: string
          substr: "LzmaEnc"
        - type: string
          substr: "LzmaDec"
        - type: string
          substr: "deflate"
        - type: string
          substr: "liblz4"
        - type: string
          substr: "LZ4_compress"
        # Database clients have locale/collation tables that trigger this
        - type: string
          substr: "libpq"
        - type: string
          substr: "postgresql"

  # === Known XOR Key Indicators ===
  - id: xor-key-null-pattern
    desc: "Null XOR key pattern"
    crit: suspicious
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "\\x00\\x00"
    attack: "T1027"

composite_rules:
  - id: xor-encoded-strings
    desc: "XOR-encoded strings"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1027"
    any:
      - id: xor-infection-marker
      - id: xor-marker-extended
      - id: tab-terminated-strings

  - id: xor-obfuscation-evidence
    desc: "XOR obfuscation evidence"
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    attack: "T1027"
    mbc: "B0041"
    any:
      - id: xor-encoded-strings
      - id: unusual-character-combinations
      - id: xor-key-null-pattern
    unless:
      - id: cap/interface/usage/usage-help
      - id: cap/data/database/libpq
    downgrade:
      any:
        - id: cap/data/compression/zstd
        - id: cap/data/compression/lzma
        - id: cap/data/compression/zlib
        - id: cap/data/compression/lz4
        - id: cap/data/compression/bzip2

  - id: mirai-xor-obfuscation
    desc: "Mirai XOR obfuscation"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1027"
    mbc: "B0041"
    all:
      # Require actual Mirai detection (composite), not just any trait in the directory
      # The /detected composite requires 6+ indicators plus size constraints
      - id: known/malware/botnet/mirai/detected
      - id: xor-obfuscation-evidence
