# XOR Obfuscation Detection
# Detects XOR-encoded strings and obfuscation markers
# ATT&CK: T1027 (Obfuscated Files or Information)
# MBC: B0041 (Execution)

traits:
  # === XOR Markers ===
  - id: xor-infection-marker
    desc: "XOR infection marker"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      substr: "@GOLJ]LM"
    attack: "T1027"

  - id: xor-marker-extended
    desc: "Extended XOR marker"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      substr: "EFE)@GOLJ]LM)HNH@G"
    attack: "T1027"

  # === Obfuscation Patterns ===
  - id: tab-terminated-strings
    desc: "Tab-terminated strings"
    crit: suspicious
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      regex: "[a-zA-Z0-9]{4,}\\t$"
    attack: "T1027"

  - id: unusual-character-combinations
    desc: "Unusual character combinations"
    crit: suspicious
    conf: 0.65
    for: [elf]
    if:
      type: string
      regex: "[^a-zA-Z0-9]{8,}"
    attack: "T1027"

  # === Known XOR Key Indicators ===
  - id: xor-key-null-pattern
    desc: "Null XOR key pattern"
    crit: suspicious
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      substr: "\\x00\\x00"
    attack: "T1027"

composite_rules:
  - id: xor-encoded-strings
    desc: "XOR-encoded strings"
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    attack: "T1027"
    any:
      - id: xor-infection-marker
      - id: xor-marker-extended
      - id: tab-terminated-strings

  - id: xor-obfuscation-evidence
    desc: "XOR obfuscation evidence"
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    attack: "T1027"
    mbc: "B0041"
    any:
      - id: xor-encoded-strings
      - id: unusual-character-combinations
      - id: xor-key-null-pattern

  - id: mirai-xor-obfuscation
    desc: "Mirai XOR obfuscation"
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1027"
    mbc: "B0041"
    all:
      - id: known/malware/botnet/mirai
      - id: xor-obfuscation-evidence
