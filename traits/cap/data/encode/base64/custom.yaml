# Custom Base64 Implementation Detection
# Detects hardcoded base64 alphabets instead of using system libraries
# Malware often implements custom encoding to avoid detection
# ATT&CK: T1027.010 (Obfuscated Files or Information: Command Obfuscation)
#
# NOTE: Many legitimate system libraries (libX11, libc, OpenSSL, etc.) include
# base64 implementations. These traits should be inert for compiled binaries
# and only notable/suspicious in script contexts where custom implementations
# are more unusual.

defaults:
  attack: "T1027.010"
  mbc: "B0032.001"
  crit: inert

traits:
  # === Standard base64 alphabet ===
  # NOTE: This is extremely common in legitimate software (email clients,
  # HTTP libraries, crypto libraries, X11, etc.). Downgraded to inert.
  - id: alphabet-standard
    desc: "Hardcoded standard base64 alphabet"
    crit: inert
    conf: 0.5
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      exact: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"

  # === Base64 decode lookup table ===
  # NOTE: Downgraded to inert for compiled binaries. Only flag in scripts.
  - id: decode-table
    desc: "Custom base64 decode lookup table"
    crit: inert
    conf: 0.5
    for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      # More specific shifted alphabet pattern typical of custom base64 implementations
      regex: "[|\\$}][a-zA-Z0-9+/]{10,20}[rstuvwxyz].{0,10}[\\{\\$].{0,10}[@ABCDEFGHIJKLMNOPQRSTUVW].{0,10}[XYZ\\[\\\\\\]\\^_`abcdefghijklmnopq]"

  # === Script-specific base64 alphabet (more suspicious in scripts) ===
  - id: alphabet-script
    desc: "Hardcoded base64 alphabet in script"
    crit: notable
    conf: 0.7
    for: [python, javascript, shell, ruby, php]
    if:
      type: string
      exact: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"

  # === Base64 padding patterns ===
  - id: padding-char
    desc: "Base64 padding character reference"
    crit: inert
    conf: 0.5
    if:
      type: string
      regex: "\\bpadding\\s*=\\s*['\"]=['\"]|\\bpad_char\\b"

composite_rules:
  # Hardcoded base64 with decode table = custom implementation
  - id: custom-implementation
    desc: "Custom base64 implementation"
    crit: notable
    conf: 0.9
    attack: "T1027.010"
    mbc: "B0032.001"
    count_min: 1
    any:
      - id: alphabet-standard
      - id: decode-table
