# Python Serialization
# Detects usage of Python serialization modules (marshal, pickle, etc.)
# MBC: C0038 (Serialize Data)
# ATT&CK: T1505 (Server Software Component)

defaults:
  crit: inert
  for: [python]
  mbc: "C0038"
  attack: "T1505"

traits:
  # === Marshal Module ===
  - id: import-marshal
    desc: Imports marshal module
    conf: 0.9
    if:
      type: ast
      kind: import
      exact: "marshal"

  - id: marshal-loads-symbol
    desc: marshal.loads symbol
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "marshal.loads"

  - id: marshal-loads-dynamic
    desc: marshal.loads dynamic import
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "import__('marshal').loads"

  - id: marshal-load
    desc: Calls marshal.load
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "marshal.load"

  # === Pickle Module ===
  - id: import-pickle
    desc: Imports pickle module
    conf: 0.9
    if:
      type: ast
      kind: import
      exact: "pickle"

  - id: pickle-loads
    desc: Calls pickle.loads
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "pickle.loads"

  - id: pickle-load
    desc: Calls pickle.load
    crit: notable
    conf: 0.9
    if:
      type: symbol
      exact: "pickle.load"

composite_rules:
  - id: marshal-loads
    desc: Calls marshal.loads
    crit: notable
    conf: 0.9
    any:
      - id: marshal-loads-symbol
      - id: marshal-loads-dynamic

  - id: marshal-deserialization
    desc: Marshal deserialization
    crit: notable
    conf: 0.95
    any:
      - id: marshal-loads
      - id: marshal-load

  - id: pickle-deserialization
    desc: Pickle deserialization
    crit: suspicious
    conf: 0.95
    any:
      - id: pickle-loads
      - id: pickle-load
