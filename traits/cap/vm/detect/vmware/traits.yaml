# VMware/ESXi Capabilities
# Interaction with VMware virtualization infrastructure

traits:
  # === Discovery ===
  - id: esxcli-vm-list
    desc: Reference to ESXi VM process list command
    crit: notable
    conf: 0.85
    if:
      type: string
      substr: "esxcli vm process list"

  - id: esxcli-tool
    desc: Reference to ESXi CLI tool (esxcli)
    crit: notable
    conf: 0.9
    for: [elf, binaries]
    if:
      type: string
      substr: "esxcli"

  - id: vmware-extensions
    desc: VMware virtual machine file extensions
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: '\.(vmdk|vmx|vmsd|vmsn|vswp|vmem|nvram|vmxf)($|\b)'

  - id: vmfs-path
    desc: Reference to VMware VMFS volumes path
    crit: notable
    conf: 0.9
    if:
      type: string
      substr: "/vmfs/"

  - id: vm-world-id
    desc: Reference to ESXi VM World ID
    crit: notable
    conf: 0.9
    if:
      type: string
      regex: 'World ID:|VM:.{0,20}ID:|Running VM:'

  # === Control/Termination ===
  - id: esxcli-vm-kill
    desc: Reference to ESXi VM process kill commands
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: 'esxcli\s+vm\s+process\s+kill'

  - id: vimcmd-snapshot-remove
    desc: Reference to VMware snapshot removal command
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: 'vim-cmd.{0,30}snapshot\.remove'

  - id: esxi-world-id-param
    desc: ESXi VM world-id parameter usage
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: string
      regex: '--world-id[=:]?'

  - id: cpp-vm-killer-symbols
    desc: C++ symbols for VM termination
    crit: suspicious
    conf: 0.95
    for: [elf]
    if:
      type: string
      regex: '_Z\d+(Kill(Virtual)?Machines?|KillVm|KillProcess)'

  - id: vm-killer-flags
    desc: Command-line flags for VM termination
    crit: suspicious
    conf: 0.9
    for: [elf]
    if:
      type: string
      regex: '--(vmkill(er)?|prockill(er)?|vmlist)'

  # === Indicators/Messages ===
  - id: killing-vms-msg
    desc: Message indicating VM termination operation
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: 'Killing VM[Ss]?:|Removing Snapshots'

  - id: killing-vm-simple
    desc: Simple VM termination message
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: 'Killing VM |Skipping VM '

  - id: esxi-preparation
    desc: Reference to ESXi preparation/waiting state
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "Waiting for ESXi Preparation"
