# Memory-based Code Execution
# ATT&CK: T1055 (Process Injection)
# MBC: B0033

traits:
  - id: remote-injection
    desc: Remote process memory manipulation
    crit: suspicious
    conf: 0.9
    attack: "T1055"
    platforms: [windows]
    for: [pe, dll]
    if:
      type: yara
      source: |
        rule remote_injection {
          strings:
            $vpe = "VirtualProtectEx" ascii wide
            $vqe = "VirtualQueryEx" ascii wide
          condition:
            any of them
        }

  - id: execve-symbol
    desc: Linux execve/fexecve symbol reference
    crit: notable
    conf: 0.8
    platforms: [linux]
    for: [elf]
    if:
      type: symbol
      regex: "^_?(execve|fexecve)$"

  - id: python-encode-call
    desc: Python encode method call
    crit: notable
    conf: 0.8
    platforms: [windows, linux, macos]
    for: [python]
    if:
      type: ast
      kind: call
      exact: "encode"

  - id: python-b64decode-call
    desc: Python base64 decode call
    crit: notable
    conf: 0.8
    platforms: [windows, linux, macos]
    for: [python]
    if:
      type: ast
      kind: call
      exact: "b64decode"

composite_rules:
  - id: linux-memfd
    desc: Fileless execution via anonymous memory
    crit: suspicious
    conf: 0.9
    attack: "T1055"
    mbc: "B0033"
    platforms: [linux]
    for: [elf]
    all:
      - id: cap/mem/anonymous/create/memfd-create
    any:
      - id: execve-symbol
      - id: cap/mem/protect/modify/mprotect

  - id: python-shellcode
    desc: Python shellcode injection via VirtualProtect
    crit: suspicious
    conf: 0.95
    attack: "T1055"
    mbc: "B0033"
    platforms: [windows]
    for: [python]
    all:
      - id: cap/mem/protect/modify/virtualprotect-ctypes
    any:
      - id: python-encode-call
      - id: python-b64decode-call
