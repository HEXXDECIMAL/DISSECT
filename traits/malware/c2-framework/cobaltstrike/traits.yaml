# Cobalt Strike / VermilionStrike Detection
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: C0001 (HTTP Communication)

traits:
  - id: malware/c2-framework/cobaltstrike/config-block
    description: Cobalt Strike beacon configuration block
    criticality: hostile
    confidence: 0.9
    mbc: "C0001"
    attack: "T1071"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule cobaltstrike_config {
          strings:
            $cfg1 = { 00 01 00 01 00 02 00 01 00 02 00 }
            $cfg2 = { 00 02 00 01 00 02 00 02 00 04 00 }
            $cfg3 = { 00 01 00 01 00 02 00 02 00 04 00 02 }
            $sleep = { 00 03 00 02 00 00 [4] 00 04 00 }
            $spawn_x86 = { 00 0d 00 80 00 00 }
            $spawn_x64 = { 00 0e 00 80 00 00 }
          condition:
            2 of ($cfg*) or ($sleep and (any of ($spawn*)))
        }

  - id: malware/c2-framework/cobaltstrike/named-pipe
    description: Cobalt Strike default named pipe patterns
    criticality: suspicious
    confidence: 0.85
    mbc: "C0001"
    attack: "T1071"
    file_types: [pe, dll]
    condition:
      type: yara
      source: |
        rule cobaltstrike_pipes {
          strings:
            $pipe1 = "\\\\.\\pipe\\msagent_" ascii wide
            $pipe2 = "\\\\.\\pipe\\MSSE-" ascii wide
            $pipe3 = "\\\\.\\pipe\\postex_" ascii wide
            $pipe4 = "\\\\.\\pipe\\postex_ssh_" ascii wide
            $pipe5 = "\\\\.\\pipe\\status_" ascii wide
            $pipe6 = "\\\\%s\\pipe\\" ascii
            $pipe7 = "\\pipe\\mojo" ascii
          condition:
            2 of them
        }

  - id: malware/c2-framework/cobaltstrike/sleep-mask
    description: Cobalt Strike sleep mask obfuscation
    criticality: suspicious
    confidence: 0.8
    mbc: "C0001"
    attack: "T1071"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule cobaltstrike_sleepmask {
          strings:
            $sleep1 = "sleep_mask" ascii
            $sleep2 = "SleepMask" ascii
            $obf1 = "obfuscate" ascii
            $obf2 = "deobfuscate" ascii
            $xor_sleep = { 31 ?? 48 83 ?? ?? 48 83 ?? ?? 7? }
          condition:
            (any of ($sleep*) and any of ($obf*)) or $xor_sleep
        }

  - id: malware/c2-framework/cobaltstrike/malleable-c2
    description: Cobalt Strike malleable C2 profile patterns
    criticality: suspicious
    confidence: 0.85
    mbc: "C0001"
    attack: "T1071"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule cobaltstrike_malleable {
          strings:
            $uri1 = "/submit.php" ascii
            $uri2 = "/pixel.gif" ascii
            $uri3 = "/pixel" ascii
            $uri4 = "/__utm.gif" ascii
            $uri5 = "/ga.js" ascii
            $uri6 = "/fwlink" ascii
            $ua1 = "Mozilla/5.0 (compatible; MSIE" ascii
            $ua2 = "Mozilla/4.0 (compatible; MSIE" ascii
          condition:
            3 of ($uri*) or (2 of ($uri*) and any of ($ua*))
        }

  - id: malware/c2-framework/cobaltstrike/vermilionstrike
    description: VermilionStrike Linux Cobalt Strike beacon
    criticality: hostile
    confidence: 0.95
    mbc: "C0001"
    attack: "T1071"
    file_types: [elf, so]
    condition:
      type: yara
      source: |
        rule vermilionstrike {
          strings:
            $beacon1 = "%s (admin)" ascii
            $beacon2 = "%s (ssh)" ascii
            $beacon3 = "beacon" ascii nocase
            $c2_1 = "%s:%d%s" ascii
            $c2_2 = "POST %s HTTP/1.1" ascii
            $jitter = "jitter" ascii
            $sleep = "sleeptime" ascii
            $ssl1 = "BIO_new_ssl_connect" ascii
            $ssl2 = "SSL_CTX_new" ascii
            $str1 = "could not spawn" ascii
            $str2 = "could not upload" ascii
            $str3 = "could not download" ascii
          condition:
            (($ssl1 or $ssl2) and 3 of ($beacon*, $c2_*)) or
            ($jitter and $sleep and $beacon3) or
            3 of ($str*)
        }

  - id: malware/c2-framework/cobaltstrike/reflective-load
    description: Cobalt Strike reflective DLL loading patterns
    criticality: suspicious
    confidence: 0.85
    mbc: "C0001"
    attack: "T1620"
    file_types: [pe, dll]
    condition:
      type: yara
      source: |
        rule cobaltstrike_reflective {
          strings:
            $ref1 = "ReflectiveLoader" ascii
            $pe_header = { 4D 5A }
            $dos_stub = "This program cannot be run" ascii
            $loader1 = { 48 8B 52 60 48 8B 52 18 48 8B 52 20 }
            $loader2 = { 8B 52 60 8B 52 18 8B 52 20 }
          condition:
            ($ref1 and ($pe_header at 0 or $dos_stub)) or any of ($loader*)
        }

  - id: malware/c2-framework/cobaltstrike/process-inject
    description: Cobalt Strike process injection patterns
    criticality: suspicious
    confidence: 0.8
    mbc: "C0001"
    attack: "T1055"
    file_types: [elf, macho, pe, so, dylib, dll]
    condition:
      type: yara
      source: |
        rule cobaltstrike_inject {
          strings:
            $inject1 = "shinject" ascii
            $inject2 = "dllspawn" ascii
            $mem1 = "VirtualAllocEx" ascii
            $mem2 = "WriteProcessMemory" ascii
            $mem3 = "CreateRemoteThread" ascii
            $linux1 = "PTRACE_POKETEXT" ascii
            $linux2 = "process_vm_writev" ascii
          condition:
            any of ($inject*) or 3 of ($mem*) or all of ($linux*)
        }

composite_rules:
  # Full Cobalt Strike beacon detection
  - id: malware/c2-framework/cobaltstrike/beacon
    description: Cobalt Strike beacon detected
    criticality: hostile
    confidence: 0.95
    file_types: [elf, macho, pe, so, dylib, dll]
    requires_any:
      - type: trait
        id: malware/c2-framework/cobaltstrike/vermilionstrike
      - type: trait
        id: malware/c2-framework/cobaltstrike/config-block
      - type: trait
        id: malware/c2-framework/cobaltstrike/malleable-c2
      - type: trait
        id: malware/c2-framework/cobaltstrike/named-pipe
      - type: trait
        id: malware/c2-framework/cobaltstrike/sleep-mask