# Cobalt Strike / VermilionStrike Detection
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: C0001 (HTTP Communication)

traits:
  # Beacon config block patterns (more specific)
  - id: malware/c2-framework/cobaltstrike/config-block
    description: Cobalt Strike beacon configuration block
    criticality: hostile
    confidence: 0.9
    mbc: "C0001"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule cobaltstrike_config {
          strings:
            // Beacon config start markers (more specific sequences)
            $cfg1 = { 00 01 00 01 00 02 00 01 00 02 00 }
            $cfg2 = { 00 02 00 01 00 02 00 02 00 04 00 }
            // Beacon config block with setting type markers
            $cfg3 = { 00 01 00 01 00 02 00 02 00 04 00 02 }
            // Sleeptime config followed by value
            $sleep = { 00 03 00 02 00 00 [4] 00 04 00 }
            // Spawnto x86 marker
            $spawn_x86 = { 00 0d 00 80 00 00 }
            // Spawnto x64 marker
            $spawn_x64 = { 00 0e 00 80 00 00 }
          condition:
            any of ($cfg*) or ($sleep and (any of ($spawn*)))
        }

  # Beacon named pipe patterns
  - id: malware/c2-framework/cobaltstrike/named-pipe
    description: Cobalt Strike default named pipe patterns
    criticality: suspicious
    confidence: 0.85
    mbc: "C0001"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule cobaltstrike_pipes {
          strings:
            $pipe1 = "\\\\.\\pipe\\msagent_" ascii wide
            $pipe2 = "\\\\.\\pipe\\MSSE-" ascii wide
            $pipe3 = "\\\\.\\pipe\\postex_" ascii wide
            $pipe4 = "\\\\.\\pipe\\postex_ssh_" ascii wide
            $pipe5 = "\\\\.\\pipe\\status_" ascii wide
            $pipe6 = "\\\\%s\\pipe\\" ascii
            $pipe7 = "\\pipe\\mojo" ascii
          condition:
            any of them
        }

  # Beacon sleep mask patterns
  - id: malware/c2-framework/cobaltstrike/sleep-mask
    description: Cobalt Strike sleep mask obfuscation
    criticality: suspicious
    confidence: 0.8
    mbc: "C0001"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule cobaltstrike_sleepmask {
          strings:
            $sleep1 = "sleep_mask" ascii
            $sleep2 = "SleepMask" ascii
            $obf1 = "obfuscate" ascii
            $obf2 = "deobfuscate" ascii
            // XOR sleep pattern
            $xor_sleep = { 31 ?? 48 83 ?? ?? 48 83 ?? ?? 7? }
          condition:
            any of ($sleep*) or ($obf1 and $obf2) or $xor_sleep
        }

  # Malleable C2 profile indicators
  - id: malware/c2-framework/cobaltstrike/malleable-c2
    description: Cobalt Strike malleable C2 profile patterns
    criticality: suspicious
    confidence: 0.85
    mbc: "C0001"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule cobaltstrike_malleable {
          strings:
            $uri1 = "/submit.php" ascii
            $uri2 = "/pixel.gif" ascii
            $uri3 = "/pixel" ascii
            $uri4 = "/__utm.gif" ascii
            $uri5 = "/ga.js" ascii
            $uri6 = "/fwlink" ascii
            $ua1 = "Mozilla/5.0 (compatible; MSIE" ascii
            $ua2 = "Mozilla/4.0 (compatible; MSIE" ascii
          condition:
            2 of ($uri*) or (any of ($uri*) and any of ($ua*))
        }

  # VermilionStrike Linux beacon
  - id: malware/c2-framework/cobaltstrike/vermilionstrike
    description: VermilionStrike Linux Cobalt Strike beacon
    criticality: hostile
    confidence: 0.95
    mbc: "C0001"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule vermilionstrike {
          strings:
            $beacon1 = "%s (admin)" ascii
            $beacon2 = "%s (ssh)" ascii
            $beacon3 = "beacon" ascii nocase
            $c2_1 = "%s:%d%s" ascii
            $c2_2 = "POST %s HTTP/1.1" ascii
            $jitter = "jitter" ascii
            $sleep = "sleeptime" ascii
            $ssl1 = "BIO_new_ssl_connect" ascii
            $ssl2 = "SSL_CTX_new" ascii
            // Common beacon strings
            $str1 = "could not spawn" ascii
            $str2 = "could not upload" ascii
            $str3 = "could not download" ascii
          condition:
            (($ssl1 or $ssl2) and 2 of ($beacon*, $c2_*)) or
            ($jitter and $sleep) or
            2 of ($str*)
        }

  # Beacon reflective loading
  - id: malware/c2-framework/cobaltstrike/reflective-load
    description: Cobalt Strike reflective DLL loading patterns
    criticality: suspicious
    confidence: 0.85
    mbc: "C0001"
    attack: "T1620"
    condition:
      type: yara
      source: |
        rule cobaltstrike_reflective {
          strings:
            $ref1 = "ReflectiveLoader" ascii
            $ref2 = "reflective" ascii nocase
            $pe_header = { 4D 5A }
            $dos_stub = "This program cannot be run" ascii
            // Reflective loading shellcode patterns
            $loader1 = { 48 8B 52 60 48 8B 52 18 48 8B 52 20 }
            $loader2 = { 8B 52 60 8B 52 18 8B 52 20 }
          condition:
            $ref1 or ($ref2 and ($pe_header at 0 or $dos_stub)) or
            any of ($loader*)
        }

  # Beacon process injection
  - id: malware/c2-framework/cobaltstrike/process-inject
    description: Cobalt Strike process injection patterns
    criticality: suspicious
    confidence: 0.8
    mbc: "C0001"
    attack: "T1055"
    condition:
      type: yara
      source: |
        rule cobaltstrike_inject {
          strings:
            $inject1 = "inject" ascii
            $inject2 = "shinject" ascii
            $inject3 = "dllspawn" ascii
            $mem1 = "VirtualAllocEx" ascii
            $mem2 = "WriteProcessMemory" ascii
            $mem3 = "CreateRemoteThread" ascii
            // Linux equivalents
            $linux1 = "ptrace" ascii
            $linux2 = "PTRACE_POKETEXT" ascii
            $linux3 = "process_vm_writev" ascii
          condition:
            any of ($inject*) or 2 of ($mem*) or 2 of ($linux*)
        }

  # Beacon default User-Agent
  - id: malware/c2-framework/cobaltstrike/user-agent
    description: Cobalt Strike default or common User-Agents
    criticality: notable
    confidence: 0.7
    mbc: "C0001"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule cobaltstrike_useragent {
          strings:
            $ua1 = "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; BOIE9;ENUS)" ascii
            $ua2 = "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.0; Trident/5.0)" ascii
            $ua3 = "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0)" ascii
            $ua4 = "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0)" ascii
          condition:
            any of them
        }

composite_rules:
  # Full Cobalt Strike beacon detection
  - id: malware/c2-framework/cobaltstrike/beacon
    description: Cobalt Strike beacon detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/c2-framework/cobaltstrike/vermilionstrike
      - type: trait
        id: malware/c2-framework/cobaltstrike/watermark
      - type: trait
        id: malware/c2-framework/cobaltstrike/malleable-c2
      - type: trait
        id: malware/c2-framework/cobaltstrike/named-pipe
      - type: trait
        id: malware/c2-framework/cobaltstrike/sleep-mask
