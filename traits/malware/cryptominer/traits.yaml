# Cryptominer Detection
# Detects cryptocurrency mining malware
# ATT&CK: T1496 (Resource Hijacking)

traits:
  # XMRig miner
  - id: malware/cryptominer/xmrig
    description: XMRig cryptocurrency miner
    criticality: suspicious
    confidence: 0.95
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule xmrig {
          strings:
            $xmrig = "xmrig" ascii nocase
            $randomx = "RandomX" ascii
            $cn_variant = "cn/" ascii
            $pool = "stratum+tcp://" ascii
          condition:
            $xmrig or ($randomx and $pool) or ($cn_variant and $pool)
        }

  # Generic Stratum mining protocol
  - id: malware/cryptominer/stratum
    description: Stratum mining protocol usage
    criticality: suspicious
    confidence: 0.85
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule stratum_protocol {
          strings:
            $stratum = "stratum" ascii nocase
            $mining_subscribe = "mining.subscribe" ascii
            $mining_authorize = "mining.authorize" ascii
            $mining_submit = "mining.submit" ascii
            $pool_port = ":3333" ascii
            $pool_port2 = ":14433" ascii
          condition:
            $stratum or any of ($mining_*) or any of ($pool_port*)
        }

  # Monero wallet patterns
  - id: malware/cryptominer/monero-wallet
    description: Monero wallet address pattern
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule monero_wallet {
          strings:
            $wallet_4 = /4[0-9A-Za-z]{94}/ ascii
            $wallet_8 = /8[0-9A-Za-z]{94}/ ascii
          condition:
            any of them
        }

  # CPU/GPU mining indicators
  - id: malware/cryptominer/hardware-mining
    description: Hardware mining configuration
    criticality: suspicious
    confidence: 0.8
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule hardware_mining {
          strings:
            $hugepages = "hugepages" ascii nocase
            $threads = "threads" ascii
            $opencl = "OpenCL" ascii
            $cuda = "CUDA" ascii
            $hashrate = "hashrate" ascii nocase
          condition:
            ($hugepages and $threads) or (($opencl or $cuda) and $hashrate)
        }

  # Known mining pools
  - id: malware/cryptominer/known-pools
    description: Known cryptocurrency mining pool domains
    criticality: suspicious
    confidence: 0.9
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule known_pools {
          strings:
            $pool1 = "xmrpool.eu" ascii
            $pool2 = "minexmr.com" ascii
            $pool3 = "supportxmr.com" ascii
            $pool4 = "nanopool.org" ascii
            $pool5 = "f2pool.com" ascii
            $pool6 = "hashvault.pro" ascii
            $pool7 = "pool.minergate.com" ascii
            $pool8 = "moneroocean.stream" ascii
          condition:
            any of them
        }

composite_rules:
  # Full cryptominer deployment
  - id: malware/cryptominer/active-miner
    description: Active cryptocurrency miner
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/cryptominer/xmrig
      - type: trait
        id: malware/cryptominer/stratum
    requires_all:
      - type: trait
        id: malware/cryptominer/known-pools
