# Kinsing Cryptominer Detection
# ATT&CK: T1496 (Resource Hijacking)
# MBC: B0030 (Remote Access)

traits:
  # Kinsing cryptominer indicators
  - id: malware/cryptominer/kinsing/generic
    description: Kinsing cryptominer patterns
    criticality: hostile
    confidence: 0.9
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule kinsing_miner {
          strings:
            $name1 = "kinsing" ascii nocase
            $name2 = "Kinsing" ascii
            $name3 = "kdevtmpfsi" ascii
            // Kinsing binary names
            $bin1 = "kinsing" ascii
            $bin2 = "kdevtmpfsi" ascii
            // Go module paths
            $go1 = "kinsing/main" ascii
            $go2 = "main.Kinsing" ascii
          condition:
            any of them
        }

  # Kinsing container targeting
  - id: malware/cryptominer/kinsing/container
    description: Kinsing container/K8s targeting
    criticality: hostile
    confidence: 0.85
    attack: "T1610"
    condition:
      type: yara
      source: |
        rule kinsing_container {
          strings:
            $name = "kinsing" ascii nocase
            // Container escape
            $cont1 = "/var/run/docker.sock" ascii
            $cont2 = "/.dockerenv" ascii
            // Kubernetes
            $k8s1 = "KUBERNETES_SERVICE" ascii
            $k8s2 = "/var/run/secrets/kubernetes" ascii
            // Cloud metadata
            $cloud1 = "169.254.169.254" ascii
            $cloud2 = "metadata.google" ascii
          condition:
            $name or
            (any of ($cont*) and any of ($k8s*, $cloud*))
        }

  # Kinsing spreading
  - id: malware/cryptominer/kinsing/spreading
    description: Kinsing lateral movement
    criticality: hostile
    confidence: 0.85
    attack: "T1021"
    condition:
      type: yara
      source: |
        rule kinsing_spread {
          strings:
            $name = "kinsing" ascii nocase
            // SSH spreading
            $ssh1 = "/.ssh/known_hosts" ascii
            $ssh2 = "/.ssh/id_rsa" ascii
            // Mass scanning
            $scan1 = "masscan" ascii
            $scan2 = "pnscan" ascii
            // Redis exploit
            $redis1 = "redis-cli" ascii
            $redis2 = "SLAVEOF" ascii
          condition:
            $name or
            (all of ($ssh*)) or
            (any of ($scan*) and any of ($redis*))
        }

  # Kinsing mining
  - id: malware/cryptominer/kinsing/mining
    description: Kinsing XMRig deployment
    criticality: hostile
    confidence: 0.9
    attack: "T1496"
    condition:
      type: yara
      source: |
        rule kinsing_xmrig {
          strings:
            $name = "kinsing" ascii nocase
            // XMRig patterns
            $xmr1 = "xmrig" ascii nocase
            $xmr2 = "stratum+" ascii
            $xmr3 = "pool.minexmr" ascii
            $xmr4 = "moneroocean" ascii
            // Mining config
            $cfg1 = "donate-level" ascii
            $cfg2 = "cpu-priority" ascii
          condition:
            $name or
            (any of ($xmr*) and any of ($cfg*))
        }

composite_rules:
  - id: malware/cryptominer/kinsing/detected
    description: Kinsing cryptominer detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/cryptominer/kinsing/generic
      - type: trait
        id: malware/cryptominer/kinsing/mining
