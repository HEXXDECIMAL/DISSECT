# Malware Family - AMOS Infostealer
# macOS infostealer (Atomic macOS Stealer)
# Reference: https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/
# ATT&CK: T1555 (Credentials from Password Stores)

traits:
  # === Atomic Traits ===

  - id: malware/stealer/amos/magic-var
    description: AMOS magic variable marker
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1555"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      exact: "_MAGIC_VAR_"

  - id: malware/stealer/amos/base32-invalid
    description: AMOS base32 decoding error
    criticality: suspicious
    confidence: 0.6
    family: true
    attack: "T1140"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      exact: "Invalid Base32 character"

  - id: malware/stealer/amos/base32-charset
    description: AMOS base32 charset
    criticality: suspicious
    confidence: 0.5
    attack: "T1140"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      exact: "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"

composite_rules:
  # AMOS magic variable variant
  - id: malware/stealer/amos/magic-variant-detected
    description: AMOS infostealer (magic var variant)
    criticality: hostile
    confidence: 0.95
    family: true
    reference: "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
    attack: "T1555"
    mbc: "B0028"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: yara
      source: |
        import "math"
        rule amos_magic_var {
          strings:
            $not_jar = "META-INF/"
            $not_dwarf = "_DWARF"
            $not_kext = "_.SYMDEF SORTED"
            $magic = "_MAGIC_VAR_"
            $header = "mh_execute_header"
            $main = "main" fullword
            $f_system = "@_system"
            $f_setsid = "@_setsid"
            $f_fork = "@_fork"
            $word_with_spaces = /[a-z]{2,} [a-z]{2,}/
          condition:
            (uint32(0) == 4277009102 or uint32(0) == 3472551422 or
             uint32(0) == 4277009103 or uint32(0) == 3489328638 or
             uint32(0) == 3405691582 or uint32(0) == 3199925962 or
             uint32(0) == 3405691583 or uint32(0) == 3216703178) and
            none of ($not*) and
            filesize > 100KB and filesize < 600KB and
            $magic and $header and $main and all of ($f*) and
            #word_with_spaces < 3
        }

  # AMOS base32 variant
  - id: malware/stealer/amos/base32-variant-detected
    description: AMOS infostealer (base32 variant)
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1555"
    mbc: "B0028"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: yara
      source: |
        rule amos_base32 {
          strings:
            $not_jar = "META-INF/"
            $not_dwarf = "_DWARF"
            $not_kext = "_.SYMDEF SORTED"
            $base32 = "Invalid Base32 character"
            $header = "mh_execute_header"
            $f_system = "@_system"
            $charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"
            $at_exit = "@___cxa_atexit"
          condition:
            (uint32(0) == 4277009102 or uint32(0) == 3472551422 or
             uint32(0) == 4277009103 or uint32(0) == 3489328638 or
             uint32(0) == 3405691582 or uint32(0) == 3199925962 or
             uint32(0) == 3405691583 or uint32(0) == 3216703178) and
            none of ($not*) and
            filesize > 40KB and filesize < 2MB and all of them
        }

  # AMOS hex obfuscated variant
  - id: malware/stealer/amos/hex-obfuscated-detected
    description: AMOS infostealer (hex obfuscated)
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1555"
    mbc: "B0028"
    platforms: [macos]
    file_types: [macho]
    condition:
      type: yara
      source: |
        import "math"
        rule amos_hex_obfuscated {
          strings:
            $not_jar = "META-INF/"
            $not_dwarf = "_DWARF"
            $not_kext = "_.SYMDEF SORTED"
            $f_zd = "@__ZdlPv" fullword
            $f_sy = "@_system" fullword
            $f_main = "_main" fullword
            $f_labs = "@_labs" fullword
            $f_memcpy = "@_memcpy" fullword
            $f_signal = "@_signal" fullword
            $f_fork = "@_fork" fullword
            $f_exit = "@_exit" fullword
            $f_setsid = "@_setsid" fullword
            $f_memset = "@_memset" fullword
            $f_strlen = "@_strlen" fullword
            $f_unwind = "@__Unwind_Resume" fullword
            $x = /0x[\dabcdefABCDEF]{2,8}/
          condition:
            (uint32(0) == 4277009102 or uint32(0) == 3472551422 or
             uint32(0) == 4277009103 or uint32(0) == 3489328638 or
             uint32(0) == 3405691582 or uint32(0) == 3199925962 or
             uint32(0) == 3405691583 or uint32(0) == 3216703178) and
            none of ($not*) and
            filesize > 190KB and filesize < 400KB and
            95% of ($f*) and math.entropy(20000, 50000) >= 4.5 and #x > 64
        }
