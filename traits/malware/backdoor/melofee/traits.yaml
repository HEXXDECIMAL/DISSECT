# Melofee Linux Backdoor Detection
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: B0030 (Remote Access)

defaults:
  file_types: [elf, macho, so, dylib]

traits:
  # Melofee backdoor artifacts
  - id: malware/backdoor/melofee/artifact
    description: Melofee backdoor identifier string
    criticality: notable
    confidence: 0.7
    condition:
      type: yara
      source: |
        rule melofee_artifact {
          strings:
            $name1 = "melofee" ascii nocase fullword
            $winnti1 = "winnti" ascii nocase fullword
            $mel1 = "melo_" ascii
            $mel2 = "fee_" ascii
          condition:
            any of them
        }

  # Generic Kernel Process Hiding
  - id: kernel/rootkit/process-hiding
    description: Kernel-level process hiding logic
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule process_hiding {
          strings:
            $kern1 = "list_del_init" ascii
            $kern2 = "THIS_MODULE" ascii
            $hide1 = "hide_pid" ascii
            $hide2 = "hidden_pids" ascii
          condition:
            any of ($kern*) and any of ($hide*)
        }

  # Generic Heartbeat C2
  - id: net/c2/heartbeat-protocol
    description: C2 heartbeat/beacon protocol implementation
    criticality: suspicious
    confidence: 0.8
    condition:
      type: yara
      source: |
        rule heartbeat_c2 {
          strings:
            $c2_1 = "heartbeat" ascii
            $c2_2 = "checkin" ascii
            $c2_3 = "beacon" ascii
            $cmd1 = "shell_exec" ascii
            $cmd2 = "file_upload" ascii
            $enc1 = "aes_encrypt" ascii
          condition:
            any of ($c2_*) and any of ($cmd*) and $enc1
        }

composite_rules:
  # Melofee detection
  - id: malware/backdoor/melofee/detected
    description: Melofee backdoor detected
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: trait
        id: malware/backdoor/melofee/artifact
    requires_any:
      - type: trait
        id: kernel/rootkit/process-hiding
      - type: trait
        id: net/c2/heartbeat-protocol
