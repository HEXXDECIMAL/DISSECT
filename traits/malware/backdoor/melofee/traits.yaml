# Melofee Linux Backdoor Detection
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: B0030 (Remote Access)

traits:
  # Melofee backdoor
  - id: malware/backdoor/melofee/generic
    description: Melofee Linux backdoor patterns
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule melofee_backdoor {
          strings:
            // Melofee identifiers
            $name1 = "melofee" ascii nocase
            $name2 = "Melo" ascii
            // Winnti-related (Melofee associated with Winnti group)
            $winnti1 = "winnti" ascii nocase
            // Melofee specific strings
            $mel1 = "melo_" ascii
            $mel2 = "fee_" ascii
            // Configuration
            $cfg1 = "config_path" ascii
            $cfg2 = "beacon_interval" ascii
          condition:
            any of ($name*) or $winnti1 or
            (any of ($mel*) and any of ($cfg*))
        }

  # Melofee kernel rootkit
  - id: malware/backdoor/melofee/rootkit
    description: Melofee kernel module rootkit
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule melofee_rootkit {
          strings:
            // Melofee kernel rootkit
            $name1 = "melofee" ascii nocase
            // Kernel module hiding
            $kern1 = "list_del_init" ascii
            $kern2 = "THIS_MODULE" ascii
            $kern3 = "module_list" ascii
            // Process hiding
            $hide1 = "hide_pid" ascii
            $hide2 = "hidden_pids" ascii
            // Port hiding
            $port1 = "hide_port" ascii
            $port2 = "hidden_ports" ascii
          condition:
            $name1 or
            (any of ($kern*) and (any of ($hide*) or any of ($port*)))
        }

  # Melofee C2 protocol
  - id: malware/backdoor/melofee/c2
    description: Melofee C2 communication protocol
    criticality: hostile
    confidence: 0.85
    mbc: "B0030"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule melofee_c2 {
          strings:
            // Melofee identifiers
            $name1 = "melofee" ascii nocase
            // C2 beacon patterns
            $c2_1 = "heartbeat" ascii
            $c2_2 = "checkin" ascii
            $c2_3 = "beacon" ascii
            // Command types
            $cmd1 = "shell_exec" ascii
            $cmd2 = "file_upload" ascii
            $cmd3 = "file_download" ascii
            // Encryption
            $enc1 = "aes_encrypt" ascii
            $enc2 = "rc4_crypt" ascii
          condition:
            $name1 or
            (any of ($c2_*) and any of ($cmd*) and any of ($enc*))
        }

composite_rules:
  # Melofee detection
  - id: malware/backdoor/melofee/detected
    description: Melofee backdoor detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/backdoor/melofee/generic
      - type: trait
        id: malware/backdoor/melofee/rootkit
      - type: trait
        id: malware/backdoor/melofee/c2
