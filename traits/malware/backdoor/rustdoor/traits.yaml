# Malware Family - Rustdoor macOS Backdoor
# Rust-based macOS backdoor
# Reference: https://medium.com/s2wblog/rustdoor-and-gatedoor-a-new-pair-of-weapons-disguised-as-legitimate-software-by-suspected-34c94e558b40
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  # === Atomic Traits ===

  - id: malware/backdoor/rustdoor/botkill
    description: Rustdoor botkill function
    criticality: hostile
    confidence: 0.85
    family: true
    attack: "T1562"
    file_types: [macho]
    condition:
      type: string
      exact: "botkill"

  - id: malware/backdoor/rustdoor/ziptask
    description: Rustdoor ziptask dialog
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1059"
    file_types: [macho]
    condition:
      type: string
      exact: "ziptask"

  - id: malware/backdoor/rustdoor/upload-files
    description: Rustdoor file upload function
    criticality: hostile
    confidence: 0.85
    family: true
    attack: "T1041"
    file_types: [macho]
    condition:
      type: string
      exact: "upload_filesrc"

  - id: malware/backdoor/rustdoor/launch-agents
    description: Rustdoor LaunchAgents persistence
    criticality: hostile
    confidence: 0.8
    family: true
    attack: "T1543.001"
    file_types: [macho]
    condition:
      type: string
      exact: "LaunchAgents.plist"

  # === V2 config traits ===
  # Note: "daemonize" alone is too generic (matches any daemon)
  # Detection relies on the composite rule requiring multiple config strings

  - id: malware/backdoor/rustdoor/cfg-check-cron
    description: Rustdoor v2 cron check config
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1053.003"
    file_types: [macho]
    condition:
      type: string
      exact: "check_cron_asked"

  - id: malware/backdoor/rustdoor/cfg-lock-cron
    description: Rustdoor v2 cron lock config
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1053.003"
    file_types: [macho]
    condition:
      type: string
      exact: "lock_in_cron"

  - id: malware/backdoor/rustdoor/cfg-lock-dock
    description: Rustdoor v2 dock lock config
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1543.001"
    file_types: [macho]
    condition:
      type: string
      exact: "lock_in_dock"

  - id: malware/backdoor/rustdoor/cfg-lock-launch
    description: Rustdoor v2 launch lock config
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1543.001"
    file_types: [macho]
    condition:
      type: string
      exact: "lock_in_launch"

  - id: malware/backdoor/rustdoor/cfg-copy-files
    description: Rustdoor v2 file copy config
    criticality: suspicious
    confidence: 0.5
    family: true
    attack: "T1105"
    file_types: [macho]
    condition:
      type: string
      exact: "copy_files"

composite_rules:
  # Rustdoor v1 detection - with Mach-O magic check
  - id: malware/backdoor/rustdoor/v1-detected
    description: Rustdoor macOS backdoor v1
    criticality: hostile
    confidence: 0.95
    family: true
    reference: "https://medium.com/s2wblog/rustdoor-and-gatedoor-a-new-pair-of-weapons-disguised-as-legitimate-software-by-suspected-34c94e558b40"
    attack: "T1059"
    mbc: "B0022"
    file_types: [macho]
    condition:
      type: yara
      source: |
        rule rustdoor_v1 {
          strings:
            $botkill = "botkill"
            $dialog = "ziptask"
            $upload = "upload_filesrc"
            $launchagents = "LaunchAgents.plist"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE or
             uint32(0) == 0xBEBAFECA or uint32(0) == 0xCAFEBABE) and
            filesize > 1MB and filesize < 10MB and all of them
        }

  # Rustdoor v2 detection
  - id: malware/backdoor/rustdoor/v2-detected
    description: Rustdoor macOS backdoor v2
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1059"
    mbc: "B0022"
    file_types: [macho]
    condition:
      type: yara
      source: |
        rule rustdoor_v2 {
          strings:
            $cfg_daemonize = "daemonize"
            $cfg_cron = "check_cron_asked"
            $cfg_lock_in_cron = "lock_in_cron"
            $cfg_lock_in_dock = "lock_in_dock"
            $cfg_lock_in_launch = "lock_in_launch"
            $cfg_copy_files = "copy_files"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE or
             uint32(0) == 0xBEBAFECA or uint32(0) == 0xCAFEBABE) and
            filesize > 1MB and filesize < 10MB and 4 of them
        }
