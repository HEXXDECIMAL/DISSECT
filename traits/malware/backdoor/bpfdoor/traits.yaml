# BPFDoor Backdoor Detection
# Advanced Linux backdoor using BPF for covert communication
# Reference: https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/bpfdoor.html

traits:
  - id: malware/backdoor/bpfdoor
    description: BPFDoor backdoor indicators
    criticality: hostile
    confidence: 0.95
    condition:
      type: yara
      source: |
        rule bpfdoor {
          meta:
            description = "BPFDoor Linux backdoor"
          strings:
            // Anti-forensics setup
            $hist1 = "HISTFILE=/dev/null" ascii
            $hist2 = "MYSQL_HISTFILE=/dev/null" ascii
            $prompt = "unset PROMPT_COMMAND" ascii
            // Process masquerade
            $abrtd = "/usr/sbin/abrtd" ascii
            // Password prompt
            $getpass = "getpass" ascii
            // RC4 encryption
            $rc4_init = { 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f }
            // Socket setup
            $socket = "socket" ascii
            $bind = "bind" ascii
            $listen = "listen" ascii
          condition:
            (2 of ($hist*, $prompt)) or 
            ($abrtd and 2 of ($socket, $bind, $listen)) or
            (4 of them)
        }

  - id: malware/backdoor/bpfdoor-magic
    description: BPFDoor magic packet activation
    criticality: hostile
    confidence: 0.9
    condition:
      type: yara
      source: |
        rule bpfdoor_magic {
          strings:
            // BPF filter setup functions (not just "bpf" which is too short)
            $bpf1 = "bpf_filter" ascii
            $bpf2 = "SO_ATTACH_BPF" ascii
            $bpf3 = "setsockopt" ascii
            $raw_socket = "SOCK_RAW" ascii
            // Magic packet markers
            $magic1 = "magic_packet" ascii
            $magic2 = "magicval" ascii
            // Raw socket operations
            $recvfrom = "recvfrom" ascii
            $sendto = "sendto" ascii
            // BPFDoor specific strings
            $bpfd1 = "/var/run/haldrund.pid" ascii
            $bpfd2 = "/dev/shm/kdmtmpflush" ascii
          condition:
            any of ($bpfd*) or
            (($bpf1 or $bpf2) and $raw_socket and ($recvfrom or $sendto)) or
            (any of ($magic*) and $raw_socket)
        }

composite_rules:
  - id: malware/backdoor/bpfdoor-full
    description: Full BPFDoor backdoor detection
    criticality: hostile
    confidence: 0.98
    requires_any:
      - type: trait
        id: malware/backdoor/bpfdoor
      - type: trait
        id: malware/backdoor/bpfdoor-magic
    requires_all:
      - type: trait
        id: evasion/masquerade/prctl-setname
