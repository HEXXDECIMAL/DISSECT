# SystemBC Backdoor Detection
# ATT&CK: T1090.001 (Proxy: Internal Proxy)
# MBC: B0030 (Remote Access)

traits:
  # SystemBC SOCKS5 proxy capability
  - id: malware/backdoor/systembc/socks-proxy
    description: SystemBC SOCKS5 proxy functionality
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1090.001"
    condition:
      type: yara
      source: |
        rule systembc_socks {
          strings:
            $proxy1 = "SOCKS5" ascii
            $proxy2 = "socks5" ascii
            $proxy3 = "socks_proxy" ascii
            $conn1 = "proxy" ascii nocase
            $conn2 = "tunnel" ascii nocase
            $bc1 = "systembc" ascii nocase
            $bc2 = "socks5_proxy" ascii
          condition:
            any of ($bc*) or (any of ($proxy*) and any of ($conn*))
        }

  # SystemBC RC4 encryption
  - id: malware/backdoor/systembc/rc4-crypto
    description: SystemBC RC4 encrypted C2 communication
    criticality: suspicious
    confidence: 0.8
    mbc: "B0030"
    attack: "T1573"
    condition:
      type: yara
      source: |
        rule systembc_rc4 {
          strings:
            // RC4 key schedule
            $rc4_1 = { 8A ?? ?? 8A ?? ?? 02 ?? 88 ?? ?? 88 ?? ?? }
            // RC4 encrypt loop
            $rc4_2 = { 30 ?? 4? 83 ?? FF 75 }
            $key1 = "rc4" ascii nocase
            $key2 = "crypt" ascii nocase
          condition:
            any of ($rc4*) or ($key1 and $key2)
        }

  # SystemBC command shell - requires SOCKS context to avoid false positives
  - id: malware/backdoor/systembc/cmd-shell
    description: SystemBC command shell with SOCKS proxy context
    criticality: suspicious
    confidence: 0.75
    mbc: "B0030"
    attack: "T1059"
    condition:
      type: yara
      source: |
        rule systembc_shell {
          strings:
            $shell1 = "/bin/sh" ascii
            $shell2 = "/bin/bash" ascii
            $exec1 = "popen" ascii
            $pipe1 = "pipe" ascii
            $pipe2 = "dup2" ascii
            // Require SOCKS context
            $socks1 = "SOCKS" ascii
            $socks2 = "socks" ascii
            $socks3 = "proxy" ascii nocase
          condition:
            (any of ($shell*) and any of ($exec*, $pipe*)) and any of ($socks*)
        }

  # SystemBC persistence
  - id: malware/backdoor/systembc/persistence
    description: SystemBC persistence mechanisms
    criticality: suspicious
    confidence: 0.8
    mbc: "B0030"
    attack: "T1547"
    condition:
      type: yara
      source: |
        rule systembc_persist {
          strings:
            $cron1 = "/etc/cron" ascii
            $cron2 = "crontab" ascii
            $init1 = "/etc/init.d" ascii
            $init2 = "/etc/rc.d" ascii
            $systemd1 = ".service" ascii
            $systemd2 = "systemctl" ascii
          condition:
            2 of them
        }

composite_rules:
  # Full SystemBC detection
  - id: malware/backdoor/systembc/detected
    description: SystemBC backdoor detected
    criticality: hostile
    confidence: 0.95
    requires_all:
      - type: trait
        id: malware/backdoor/systembc/socks-proxy
    requires_any:
      - type: trait
        id: malware/backdoor/systembc/cmd-shell
      - type: trait
        id: malware/backdoor/systembc/rc4-crypto
