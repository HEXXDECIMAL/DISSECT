# SSH Backdoor Detection Patterns
# ATT&CK: T1556.004 (Modify Authentication Process: SSH)

defaults:
  file_types: [elf, macho, so, dylib]

traits:
  # SSH backdoor generic
  - id: malware/backdoor/ssh/generic
    description: SSH backdoor patterns
    criticality: hostile
    confidence: 0.85
    attack: "T1556.004"
    condition:
      type: yara
      source: |
        rule ssh_backdoor {
          strings:
            $sshd = "sshd" ascii fullword
            // Backdoored sshd markers
            $bd1 = "backdoor" ascii nocase fullword
            $bd2 = "sshdoor" ascii nocase fullword
            $bd3 = "sshkit" ascii nocase fullword
            // Hardcoded credentials
            $cred1 = "master_password" ascii
            $cred2 = "backdoor_pass" ascii
            $cred3 = "magic_password" ascii
            // Auth bypass
            $bypass1 = "auth_bypass" ascii
            $bypass2 = "skip_auth" ascii
          condition:
            $sshd and (any of ($bd*) or any of ($cred*) or any of ($bypass*))
        }

  # SSH key injection
  - id: malware/backdoor/ssh/key-inject
    description: SSH authorized_keys injection
    criticality: suspicious
    confidence: 0.8
    attack: "T1098.004"
    condition:
      type: yara
      source: |
        rule ssh_key_inject {
          strings:
            // Authorized keys manipulation
            $ak1 = "authorized_keys" ascii
            $ak2 = ".ssh/authorized" ascii
            // Key injection patterns
            $inj1 = "ssh-rsa " ascii
            $inj2 = "ssh-ed25519 " ascii
            // File operations
            $file1 = "echo " ascii
            $file2 = ">>" ascii
            $file3 = "chmod 600" ascii
          condition:
            (any of ($ak*) and any of ($inj*)) or
            (any of ($ak*) and any of ($file*))
        }

  # SSH credential logging
  - id: malware/backdoor/ssh/cred-log
    description: SSH credential logging backdoor
    criticality: hostile
    confidence: 0.9
    attack: "T1556.004"
    condition:
      type: yara
      source: |
        rule ssh_cred_log {
          strings:
            // Credential logging
            $log1 = "password_log" ascii
            $log2 = "cred_log" ascii
            $log3 = "auth_log" ascii
            // SSH auth context
            $ssh1 = "sshd" ascii fullword
            $ssh2 = "ssh_userauth" ascii fullword
            // File paths for logging
            $path1 = "/tmp/." ascii
            $path2 = "/dev/shm/." ascii
            $path3 = "/var/tmp/." ascii
          condition:
            (any of ($log*) and any of ($ssh*)) or
            (any of ($ssh*) and any of ($path*) and any of ($log*))
        }

  # PAM-based SSH backdoor
  - id: malware/backdoor/ssh/pam
    description: PAM-based SSH authentication backdoor
    criticality: hostile
    confidence: 0.85
    attack: "T1556.003"
    condition:
      type: yara
      source: |
        rule ssh_pam_backdoor {
          strings:
            // PAM module functions
            $pam1 = "pam_sm_authenticate" ascii
            $pam2 = "pam_sm_setcred" ascii
            // Magic strings
            $magic1 = "magic" ascii
            $magic2 = "backdoor" ascii
            $magic3 = "master" ascii
            // SSH context
            $ssh1 = "sshd" ascii
            $ssh2 = "/etc/pam.d/sshd" ascii
          condition:
            (any of ($pam*) and any of ($magic*)) or
            ($pam1 and any of ($ssh*) and any of ($magic*))
        }