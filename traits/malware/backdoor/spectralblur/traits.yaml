# Malware Family - SpectralBlur
# DPRK/Lazarus-linked macOS backdoor discovered in 2024
# Reference: https://objective-see.org/blog/blog_0x7A.html
# ATT&CK: T1059.004 (Unix Shell), T1071 (Application Layer Protocol)
#
# NOTE: Individual traits are marked "suspicious" because while these function
# names are characteristic of SpectralBlur, they could theoretically appear in
# legitimate software (e.g., backup tools, network utilities). Only the composite
# rule combining multiple indicators is marked "hostile" per criticality.md:
# "Definitively malicious with no reasonable alternative explanation"

traits:
  # Command handler functions characteristic of SpectralBlur
  # These are suspicious individually but hostile when combined
  - id: malware/backdoor/spectralblur/proc-upload
    description: SpectralBlur-style file upload handler
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1041"
    file_types: [macho]
    condition:
      type: string
      regex: "_proc_upload(_content)?"

  - id: malware/backdoor/spectralblur/proc-download
    description: SpectralBlur-style file download handler
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1105"
    file_types: [macho]
    condition:
      type: string
      regex: "_proc_download(_content)?"

  - id: malware/backdoor/spectralblur/proc-shell
    description: SpectralBlur-style shell command handler
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1059.004"
    file_types: [macho]
    condition:
      type: string
      exact: "_proc_shell"

  - id: malware/backdoor/spectralblur/proc-dir
    description: SpectralBlur-style directory listing handler
    criticality: suspicious
    confidence: 0.85
    family: true
    attack: "T1083"
    file_types: [macho]
    condition:
      type: string
      exact: "_proc_dir"

  - id: malware/backdoor/spectralblur/proc-rmfile
    description: SpectralBlur-style file deletion handler
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1070.004"
    file_types: [macho]
    condition:
      type: string
      exact: "_proc_rmfile"

  - id: malware/backdoor/spectralblur/proc-hibernate
    description: SpectralBlur-style hibernation handler
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1029"
    file_types: [macho]
    condition:
      type: string
      exact: "_proc_hibernate"

  - id: malware/backdoor/spectralblur/proc-config
    description: SpectralBlur-style configuration handler
    criticality: suspicious
    confidence: 0.85
    family: true
    attack: "T1071"
    file_types: [macho]
    condition:
      type: string
      regex: "_proc_(get|set)cfg"

  - id: malware/backdoor/spectralblur/proc-sleep
    description: SpectralBlur-style sleep handler
    criticality: notable
    confidence: 0.8
    attack: "T1029"
    file_types: [macho]
    condition:
      type: string
      exact: "_proc_sleep"

  - id: malware/backdoor/spectralblur/proc-testconn
    description: SpectralBlur-style connection test handler
    criticality: notable
    confidence: 0.8
    attack: "T1071"
    file_types: [macho]
    condition:
      type: string
      exact: "_proc_testconn"

  - id: malware/backdoor/spectralblur/proc-lifecycle
    description: SpectralBlur-style lifecycle control handler
    criticality: suspicious
    confidence: 0.9
    family: true
    attack: "T1059"
    file_types: [macho]
    condition:
      type: string
      regex: "_proc_(die|stop|restart|none)"

  # Internal communication functions - suspicious patterns
  - id: malware/backdoor/spectralblur/authchannel
    description: SpectralBlur-style authentication channel
    criticality: suspicious
    confidence: 0.85
    family: true
    attack: "T1071"
    file_types: [macho]
    condition:
      type: string
      exact: "_authchannel"

  - id: malware/backdoor/spectralblur/openchannel
    description: SpectralBlur-style channel open function
    criticality: suspicious
    confidence: 0.85
    family: true
    attack: "T1071"
    file_types: [macho]
    condition:
      type: string
      exact: "_openchannel"

  - id: malware/backdoor/spectralblur/xcrypt
    description: SpectralBlur-style encryption wrapper
    criticality: suspicious
    confidence: 0.85
    family: true
    attack: "T1573"
    file_types: [macho]
    condition:
      type: string
      exact: "_xcrypt"

  - id: malware/backdoor/spectralblur/packet-io
    description: SpectralBlur-style packet communication
    criticality: notable
    confidence: 0.8
    family: true
    attack: "T1071"
    file_types: [macho]
    condition:
      type: string
      regex: "_read_packet|_write_packet"

  # Generic behaviors - notable (common in many programs)
  - id: malware/backdoor/spectralblur/config-persist
    description: Configuration load/save functions
    criticality: notable
    confidence: 0.7
    attack: "T1027"
    file_types: [macho]
    condition:
      type: string
      regex: "_load_config|_save_config"

  - id: malware/backdoor/spectralblur/mainloop
    description: Main processing loop functions
    criticality: notable
    confidence: 0.7
    attack: "T1059"
    file_types: [macho]
    condition:
      type: string
      regex: "_mainprocess|_mainthread"

composite_rules:
  # This is the ONLY hostile rule - requires multiple indicators
  # "Definitively malicious with no reasonable alternative explanation"
  - id: malware/backdoor/spectralblur/detected
    description: SpectralBlur macOS backdoor (DPRK/Lazarus)
    criticality: hostile
    confidence: 0.98
    family: true
    reference: "https://objective-see.org/blog/blog_0x7A.html"
    attack: "T1059.004"
    mbc: "B0022"
    file_types: [macho]
    condition:
      type: yara
      source: |
        rule spectralblur_macos {
          meta:
            description = "SpectralBlur macOS backdoor (DPRK/Lazarus)"
            author = "DISSECT"
            date = "2024"
            reference = "https://objective-see.org/blog/blog_0x7A.html"
          strings:
            // Command handlers
            $proc_upload = "_proc_upload"
            $proc_download = "_proc_download"
            $proc_shell = "_proc_shell"
            $proc_dir = "_proc_dir"
            $proc_rmfile = "_proc_rmfile"
            $proc_hibernate = "_proc_hibernate"
            $proc_getcfg = "_proc_getcfg"
            $proc_setcfg = "_proc_setcfg"
            $proc_testconn = "_proc_testconn"
            $proc_sleep = "_proc_sleep"
            $proc_die = "_proc_die"
            $proc_restart = "_proc_restart"
            // PTY backdoor pattern
            $posix_openpt = "posix_openpt"
            $grantpt = "grantpt"
            $unlockpt = "unlockpt"
            // Shell
            $bin_sh = "/bin/sh"
            // GPL string (present in SpectralBlur)
            $gpl = "There is NO WARRANTY"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE) and
            filesize < 100KB and
            (
              // Strong match: multiple proc handlers
              (4 of ($proc_*)) or
              // Alternative: proc handlers with PTY pattern
              (2 of ($proc_*) and $posix_openpt and $grantpt) or
              // Alternative: key proc handlers with GPL string
              ($proc_shell and $proc_upload and $gpl)
            )
        }

  # Behavioral pattern - suspicious (could be similar legitimate tool)
  - id: malware/backdoor/spectralblur/behavioral
    description: SpectralBlur-like C2 backdoor behavior
    criticality: suspicious
    confidence: 0.85
    attack: "T1059.004"
    mbc: "B0022"
    file_types: [macho]
    condition:
      type: yara
      source: |
        rule spectralblur_behavior {
          meta:
            description = "SpectralBlur-like behavioral pattern"
          strings:
            // POSIX PTY creation
            $posix_openpt = "posix_openpt" fullword
            $grantpt = "grantpt" fullword
            $unlockpt = "unlockpt" fullword
            $ptsname = "ptsname" fullword
            // Network
            $socket = "socket" fullword
            $connect = "connect" fullword
            $recv = "recv" fullword
            $send = "send" fullword
            // Process
            $fork = "fork" fullword
            $setsid = "setsid" fullword
            $execve = "execve" fullword
            // Shell
            $bin_sh = "/bin/sh"
            $dev_null = "/dev/null"
          condition:
            (uint32(0) == 0xFEEDFACE or uint32(0) == 0xFEEDFACF or
             uint32(0) == 0xCEFAEDFE or uint32(0) == 0xCFFAEDFE) and
            filesize < 500KB and
            // PTY backdoor pattern
            $posix_openpt and $grantpt and $unlockpt and
            // Network communication
            $socket and $connect and ($recv or $send) and
            // Process daemonization
            $fork and $setsid and
            // Shell execution
            ($bin_sh or $execve)
        }
