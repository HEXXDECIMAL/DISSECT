# Symbiote Linux Rootkit Detection
# ATT&CK: T1014 (Rootkit)
# MBC: F0015 (Hijack Execution Flow)

traits:
  # Symbiote LD_PRELOAD rootkit
  - id: malware/rootkit/symbiote/ld-preload
    description: Symbiote LD_PRELOAD-based rootkit
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule symbiote_ldpreload {
          strings:
            // Symbiote-specific identifiers
            $name1 = "symbiote" ascii nocase
            $name2 = "kerneldev" ascii
            // Common Symbiote paths
            $path1 = "/lib/security/libns" ascii
            $path2 = "kerneldev.so" ascii
            $path3 = "/usr/lib/security/" ascii
            // LD_PRELOAD mechanism
            $ld1 = "LD_PRELOAD" ascii
            $ld2 = "/etc/ld.so.preload" ascii
            $hook1 = "RTLD_NEXT" ascii
            $hook2 = "dlsym" ascii
          condition:
            any of ($name*) or any of ($path*) or
            (any of ($ld*) and all of ($hook*))
        }

  # Symbiote credential theft
  - id: malware/rootkit/symbiote/credential-theft
    description: Symbiote credential harvesting
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1556"
    condition:
      type: yara
      source: |
        rule symbiote_creds {
          strings:
            // Symbiote captures credentials via hooked functions
            $hook1 = "pam_sm_authenticate" ascii
            $hook2 = "getaddrinfo" ascii
            // Credential exfil
            $exfil1 = "captura" ascii
            $exfil2 = "credenciais" ascii
            // DNS exfil pattern
            $dns1 = "dns_exfil" ascii
            $dns2 = ".dns." ascii
            // Symbiote-specific strings
            $symb1 = "symbiote" ascii nocase
            $symb2 = "kerneldev" ascii
          condition:
            any of ($symb*) or
            ($hook1 and any of ($exfil*)) or
            (any of ($hook*) and any of ($dns*))
        }

  # Symbiote process/network hiding
  - id: malware/rootkit/symbiote/hiding
    description: Symbiote process and network connection hiding
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule symbiote_hiding {
          strings:
            // Symbiote identifiers
            $name1 = "symbiote" ascii nocase
            $name2 = "kerneldev" ascii
            // Hooked libc functions for hiding
            $hook1 = "readdir" ascii
            $hook2 = "readdir64" ascii
            $hook3 = "fopen" ascii
            $hook4 = "fopen64" ascii
            // Network hiding
            $net1 = "/proc/net/tcp" ascii
            $net2 = "/proc/net/tcp6" ascii
            // Process hiding
            $proc1 = "/proc/self" ascii
            $proc2 = "hide_process" ascii
            $proc3 = "hidden_port" ascii
          condition:
            any of ($name*) or
            (2 of ($hook*) and any of ($net*)) or
            any of ($proc2, $proc3)
        }

  # Symbiote BPF packet capture
  - id: malware/rootkit/symbiote/bpf-capture
    description: Symbiote BPF packet interception
    criticality: hostile
    confidence: 0.85
    mbc: "F0015"
    attack: "T1040"
    condition:
      type: yara
      source: |
        rule symbiote_bpf {
          strings:
            // BPF for packet capture
            $bpf1 = "AF_PACKET" ascii
            $bpf2 = "SOCK_RAW" ascii
            $bpf3 = "setsockopt" ascii
            $bpf4 = "SO_ATTACH_FILTER" ascii
            // Symbiote markers
            $name1 = "symbiote" ascii nocase
            $name2 = "kerneldev" ascii
            // Capture patterns
            $cap1 = "pcap_" ascii
            $cap2 = "packet_capture" ascii
          condition:
            any of ($name*) or
            ($bpf1 and $bpf2 and ($bpf4 or any of ($cap*)))
        }

composite_rules:
  # Symbiote rootkit detection
  - id: malware/rootkit/symbiote/detected
    description: Symbiote rootkit detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/rootkit/symbiote/ld-preload
      - type: trait
        id: malware/rootkit/symbiote/credential-theft
      - type: trait
        id: malware/rootkit/symbiote/hiding
