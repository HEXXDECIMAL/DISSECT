# OrBit Linux Rootkit Detection
# ATT&CK: T1014 (Rootkit)
# MBC: F0015 (Hijack Execution Flow)

traits:
  # OrBit LD_PRELOAD injection
  - id: malware/rootkit/orbit/ld-preload
    description: OrBit LD_PRELOAD-based userspace rootkit
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule orbit_ldpreload {
          strings:
            $ld1 = "LD_PRELOAD" ascii
            $ld2 = "/etc/ld.so.preload" ascii
            $hook1 = "dlsym" ascii
            $hook2 = "RTLD_NEXT" ascii
            // OrBit-specific paths
            $path1 = "/dev/shm/.orbit" ascii
            $path2 = ".orbit" ascii
            $path3 = "libOrbit" ascii nocase
          condition:
            any of ($path*) or
            (($ld1 or $ld2) and all of ($hook*))
        }

  # OrBit SSH credential stealing
  - id: malware/rootkit/orbit/ssh-steal
    description: OrBit SSH credential theft via PAM hook
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1556"
    condition:
      type: yara
      source: |
        rule orbit_ssh_steal {
          strings:
            // OrBit-specific patterns required
            $orbit1 = "orbit" ascii nocase
            $orbit2 = "/dev/shm/.orbit" ascii
            $orbit3 = "libOrbit" ascii nocase
            // PAM hooking with credential logging
            $pam_hook1 = "pam_sm_authenticate" ascii
            $pam_hook2 = "pam_sm_setcred" ascii
            $log_cred = "/dev/shm/.sshd.auth" ascii
            $log_pass = "sshd.passwd" ascii
          condition:
            any of ($orbit*) or
            ($pam_hook1 and $log_cred) or
            ($pam_hook1 and $log_pass)
        }

  # OrBit process/file hiding
  - id: malware/rootkit/orbit/hiding
    description: OrBit process and file hiding capabilities
    criticality: hostile
    confidence: 0.9
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule orbit_hiding {
          strings:
            // OrBit-specific identifiers
            $orbit1 = "orbit" ascii nocase
            $orbit2 = "/dev/shm/.orbit" ascii
            $orbit3 = "libOrbit" ascii nocase
            // OrBit-specific hiding patterns
            $hide_func1 = "hide_module" ascii
            $hide_func2 = "hide_tcp" ascii
            $hide_func3 = "is_hidden" ascii
            $hook1 = "RTLD_NEXT" ascii
            $hook2 = "dlsym" ascii
          condition:
            any of ($orbit*) or
            (any of ($hide_func*) and all of ($hook*))
        }

  # OrBit network hiding
  - id: malware/rootkit/orbit/net-hide
    description: OrBit network connection hiding
    criticality: hostile
    confidence: 0.85
    mbc: "F0015"
    attack: "T1014"
    condition:
      type: yara
      source: |
        rule orbit_net_hide {
          strings:
            $net1 = "/proc/net/tcp" ascii
            $net2 = "/proc/net/tcp6" ascii
            $net3 = "/proc/net/udp" ascii
            $hook1 = "fopen" ascii
            $hook2 = "fgets" ascii
            $hide = "hide" ascii
          condition:
            any of ($net*) and any of ($hook*) and $hide
        }

composite_rules:
  # Full OrBit rootkit detection
  - id: malware/rootkit/orbit/detected
    description: OrBit rootkit detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/rootkit/orbit/ld-preload
      - type: trait
        id: malware/rootkit/orbit/ssh-steal
      - type: trait
        id: malware/rootkit/orbit/hiding
