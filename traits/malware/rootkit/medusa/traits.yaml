# Malware Family - Medusa LD_PRELOAD Rootkit
# Reference: https://github.com/ldpreload/Medusa
# ATT&CK: T1574.006 (Hijack Execution Flow: LD_PRELOAD)

traits:
  - id: malware/rootkit/medusa/dynamic-linker-bug
    description: Medusa cloned thread error message
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1574.006"
    file_types: [elf, so]
    condition:
      type: string
      exact: "DYNAMIC LINKER BUG!"

  - id: malware/rootkit/medusa/execve-hook
    description: Medusa execve hook
    criticality: hostile
    confidence: 0.85
    family: true
    attack: "T1574.006"
    file_types: [elf, so]
    condition:
      type: string
      exact: "__execve"

  - id: malware/rootkit/medusa/lxstat64-hook
    description: Medusa lxstat64 hook
    criticality: hostile
    confidence: 0.85
    family: true
    attack: "T1574.006"
    file_types: [elf, so]
    condition:
      type: string
      exact: "__lxstat64"

  - id: malware/rootkit/medusa/archloaded
    description: Medusa archloaded marker
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1574.006"
    file_types: [elf, so]
    condition:
      type: string
      exact: "archloaded"

  - id: malware/rootkit/medusa/rkload
    description: Medusa rootkit load marker
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1574.006"
    file_types: [elf, so]
    condition:
      type: string
      exact: "rkload"

  - id: malware/rootkit/medusa/backup-ld
    description: Medusa LD backup mechanism
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1574.006"
    file_types: [elf, so]
    condition:
      type: string
      exact: "backup_ld"

composite_rules:
  - id: malware/rootkit/medusa/detected
    description: Medusa LD_PRELOAD rootkit
    criticality: hostile
    confidence: 0.95
    family: true
    reference: "https://github.com/ldpreload/Medusa"
    attack: "T1574.006"
    mbc: "E1014"
    file_types: [elf, so]
    condition:
      type: yara
      source: |
        rule medusa_rootkit {
          strings:
            $cloned_thread = "DYNAMIC LINKER BUG!"
            $__execve = "__execve" fullword
            $lxstat64 = "__lxstat64" fullword
            $syslog = "syslog" fullword
            $LD_PRELOAD = "LD_PRELOAD" fullword
            $LD_LIBRARY_PATH = "LD_LIBRARY_PATH" fullword
            $archloaded = "archloaded" fullword
            $rkload = "rkload" fullword
            $wcs = "wcsmbsload" fullword
            $readdir64 = "readdir64" fullword
            $backup_ld = "backup_ld" fullword
          condition:
            uint32(0) == 0x464C457F and
            filesize < 2MB and all of them
        }
