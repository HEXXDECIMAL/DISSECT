# Malware Family - Melofee Rootkit
# Reference: https://blog.exatrack.com/melofee/
# ATT&CK: T1014 (Rootkit)

traits:
  - id: malware/rootkit/melofee/audio-loader
    description: Melofee audio loader path
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1014"
    file_types: [elf]
    condition:
      type: string
      exact: "/etc/intel_audio/audio | xargs kill"

  - id: malware/rootkit/melofee/create-failed
    description: Melofee rootkit creation error
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1014"
    file_types: [elf]
    condition:
      type: string
      exact: "create rootkit file failed"

  - id: malware/rootkit/melofee/insmod-ko
    description: Melofee kernel module loading
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1547.006"
    file_types: [elf]
    condition:
      type: string
      exact: "/sbin/insmod /etc/intel_audio/intel_audio.ko"

  - id: malware/rootkit/melofee/sodl-close
    description: Melofee 2024 variant marker
    criticality: hostile
    confidence: 0.95
    family: true
    attack: "T1014"
    file_types: [elf]
    condition:
      type: string
      exact: "/var/run/nscd/sodl-close.c"

  - id: malware/rootkit/melofee/hide-ok
    description: Melofee hide success marker
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1014"
    file_types: [elf]
    condition:
      type: string
      exact: "hide ok"

  - id: malware/rootkit/melofee/show-ok
    description: Melofee show success marker
    criticality: hostile
    confidence: 0.9
    family: true
    attack: "T1014"
    file_types: [elf]
    condition:
      type: string
      exact: "show ok"

composite_rules:
  - id: malware/rootkit/melofee/2023-detected
    description: Melofee rootkit (2023)
    criticality: hostile
    confidence: 0.95
    family: true
    reference: "https://blog.exatrack.com/melofee/"
    attack: "T1014"
    mbc: "E1014"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule melofee_2023 {
          strings:
            $loader = "/etc/intel_audio/audio | xargs kill"
            $failed = "create rootkit file failed"
            $insmod = "/sbin/insmod /etc/intel_audio/intel_audio.ko"
            $lock = "/var/lock/%s.lock"
          condition:
            uint32(0) == 0x464C457F and
            filesize < 5MB and 2 of them
        }

  - id: malware/rootkit/melofee/2024-detected
    description: Melofee rootkit (2024)
    criticality: hostile
    confidence: 0.95
    family: true
    reference: "https://blog.xlab.qianxin.com/analysis_of_new_melofee_variant_en/"
    attack: "T1014"
    mbc: "E1014"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule melofee_2024 {
          strings:
            $sodl = "/var/run/nscd/sodl-close.c"
            $hide_ok = "hide ok"
            $show_ok = "show ok"
          condition:
            uint32(0) == 0x464C457F and
            filesize < 7MB and all of them
        }
