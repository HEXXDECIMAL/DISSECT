# LockBit Ransomware Detection
# ATT&CK: T1486 (Data Encrypted for Impact)
# MBC: C0027 (Encrypt Files)

traits:
  # LockBit binary naming convention
  - id: malware/ransomware/lockbit/naming
    description: LockBit locker binary naming pattern
    criticality: suspicious
    confidence: 0.8
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule lockbit_naming {
          strings:
            $locker = "locker_" ascii nocase
            $lockbit = "lockbit" ascii nocase
            // More specific LockBit identifiers
            $lb2_full = "LockBit 2.0" ascii
            $lb3_full = "LockBit 3.0" ascii
            $lb_black = "LockBit Black" ascii
            $lb_green = "LockBit Green" ascii
            // LockBit file extension patterns
            $ext_lb = ".lockbit" ascii
            $ext_lb2 = ".LB2" ascii
          condition:
            $lockbit or $locker or any of ($lb*_full, $lb_black, $lb_green, $ext_*)
        }

  # LockBit ransom note patterns
  - id: malware/ransomware/lockbit/ransom-note
    description: LockBit ransom note indicators
    criticality: hostile
    confidence: 0.95
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule lockbit_note {
          strings:
            $note1 = "Restore-My-Files.txt" ascii wide nocase
            $note2 = "LockBit-note.hta" ascii wide nocase
            $note3 = "LOCKBIT" ascii wide
            $note4 = "lockbit" ascii wide
            $ext1 = ".lockbit" ascii
            $ext2 = ".lock" ascii
            $ext3 = ".lb2" ascii
            $onion = ".onion" ascii
            $tor = "torproject" ascii nocase
          condition:
            any of ($note*) or (any of ($ext*) and ($onion or $tor))
        }

  # LockBit 3.0 / Black patterns
  - id: malware/ransomware/lockbit/3-black
    description: LockBit 3.0 (LockBit Black) specific patterns
    criticality: hostile
    confidence: 0.9
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule lockbit_3_black {
          strings:
            // LockBit specific status messages with LockBit context
            $debug1 = "Encrypting files" ascii
            $debug2 = "encrypted successfully" ascii
            $debug3 = "File encrypted:" ascii
            // Ransom note specific
            $note1 = "restore-my-files" ascii nocase
            $note2 = "lockbit-note" ascii nocase
            $note3 = "LOCKBIT_README" ascii
            // LockBit Black specific strings
            $black1 = "LockBit Black" ascii
            $black2 = "lockbit3" ascii nocase
            $black3 = "lb3_config" ascii
            $black4 = "lockbit" ascii nocase
            // LockBit ransom demands
            $ransom1 = ".lockbit" ascii
            $ransom2 = "LB2" ascii
            $ransom3 = "decryption ID" ascii nocase
          condition:
            any of ($note*, $black*) or
            (any of ($debug*) and any of ($ransom*))
        }

  # LockBit Linux/ESXi variant
  - id: malware/ransomware/lockbit/linux-esxi
    description: LockBit Linux/ESXi targeting
    criticality: hostile
    confidence: 0.95
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule lockbit_linux_esxi {
          strings:
            $vmfs = "/vmfs/volumes" ascii
            $esxi1 = "esxcli" ascii
            $esxi2 = "vim-cmd" ascii
            $esxi3 = "vmsvc" ascii
            $esxi4 = "vmdk" ascii wide
            $esxi5 = "vmx" ascii wide
            $esxi6 = "vmem" ascii wide
            $esxi7 = "vswp" ascii wide
            $kill_vm = "vm process kill" ascii
            $snapshot = "snapshot.remove" ascii
          condition:
            ($vmfs and 2 of ($esxi*)) or $kill_vm or $snapshot
        }

  # LockBit process/service termination
  - id: malware/ransomware/lockbit/service-kill
    description: LockBit service and process termination
    criticality: suspicious
    confidence: 0.8
    mbc: "C0027"
    attack: "T1489"
    condition:
      type: yara
      source: |
        rule lockbit_service_kill {
          strings:
            // Services commonly killed
            $svc1 = "vss" ascii nocase
            $svc2 = "sql" ascii nocase
            $svc3 = "backup" ascii nocase
            $svc4 = "exchange" ascii nocase
            $svc5 = "oracle" ascii nocase
            // Kill commands
            $kill1 = "taskkill" ascii nocase
            $kill2 = "net stop" ascii nocase
            $kill3 = "sc stop" ascii nocase
            // Linux
            $kill4 = "pkill" ascii
            $kill5 = "killall" ascii
          condition:
            (2 of ($svc*) and any of ($kill*))
        }

  # LockBit multi-arch builder
  - id: malware/ransomware/lockbit/multiarch
    description: LockBit multi-architecture build patterns
    criticality: suspicious
    confidence: 0.75
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule lockbit_multiarch {
          strings:
            $arch1 = "x86_64" ascii
            $arch2 = "AArch" ascii
            $arch3 = "ARM" ascii
            $arch4 = "MIPS" ascii
            $arch5 = "PowerPC" ascii
            $arch6 = "SPARC" ascii
            $arch7 = "s390x" ascii
            $arch8 = "FreeBSD" ascii
            $arch9 = "ESXI" ascii nocase
            $locker = "locker" ascii nocase
          condition:
            $locker and 3 of ($arch*)
        }

  # LockBit shadow copy deletion
  - id: malware/ransomware/lockbit/shadow-delete
    description: LockBit shadow copy deletion
    criticality: suspicious
    confidence: 0.85
    mbc: "C0027"
    attack: "T1490"
    condition:
      type: yara
      source: |
        rule lockbit_shadow {
          strings:
            $vss1 = "vssadmin" ascii nocase
            $vss2 = "delete shadows" ascii nocase
            $wmic1 = "wmic" ascii nocase
            $wmic2 = "shadowcopy delete" ascii nocase
            $bcdedit = "bcdedit" ascii nocase
            $recovery = "recoveryenabled" ascii nocase
          condition:
            ($vss1 and $vss2) or ($wmic1 and $wmic2) or ($bcdedit and $recovery)
        }

composite_rules:
  # Full LockBit detection
  - id: malware/ransomware/lockbit/detected
    description: LockBit ransomware detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/ransomware/lockbit/ransom-note
      - type: trait
        id: malware/ransomware/lockbit/linux-esxi
      - type: trait
        id: malware/ransomware/lockbit/naming
      - type: trait
        id: malware/ransomware/lockbit/3-black
