# DarkSide Ransomware Detection
# ATT&CK: T1486 (Data Encrypted for Impact)
# MBC: C0027 (Encrypt Files)

traits:
  # DarkSide ransom note
  - id: malware/ransomware/darkside/ransom-note
    description: DarkSide ransom note indicators
    criticality: hostile
    confidence: 0.95
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule darkside_note {
          strings:
            $note1 = "darkside" ascii nocase
            $onion1 = "darksidfqzcuhtk2.onion" ascii
            $onion2 = ".onion" ascii
            $ext1 = ".darkside" ascii
            $threat1 = "data will be published" ascii nocase
            $threat2 = "leaked" ascii nocase
          condition:
            any of ($note1, $onion1, $ext1) or
            ($onion2 and any of ($threat*))
        }

  # DarkSide Linux/ESXi variant
  - id: malware/ransomware/darkside/linux-esxi
    description: DarkSide Linux/ESXi targeting
    criticality: hostile
    confidence: 0.9
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule darkside_linux {
          strings:
            $vmfs = "/vmfs/volumes" ascii
            $esxi1 = "esxcli" ascii
            $esxi2 = "vim-cmd" ascii
            $ext1 = ".vmdk" ascii
            $ext2 = ".vmx" ascii
            $ext3 = ".vmem" ascii
            $kill = "vm process kill" ascii
          condition:
            ($vmfs and any of ($esxi*)) or
            ($kill) or
            (any of ($esxi*) and 2 of ($ext*))
        }

  # DarkSide encryption markers
  - id: malware/ransomware/darkside/encryption
    description: DarkSide encryption patterns
    criticality: hostile
    confidence: 0.85
    mbc: "C0027"
    attack: "T1486"
    condition:
      type: yara
      source: |
        rule darkside_encrypt {
          strings:
            $salsa = "salsa20" ascii nocase
            $chacha = "chacha" ascii nocase
            $rsa = "RSA" ascii
            $key1 = "public_key" ascii
            $key2 = "encrypt_key" ascii
            $marker1 = "DARKSIDE" ascii
            $marker2 = "encrypted" ascii
          condition:
            $marker1 or
            (any of ($salsa, $chacha) and any of ($rsa, $key*)) or
            (any of ($key*) and $marker2)
        }

  # DarkSide service termination
  - id: malware/ransomware/darkside/service-kill
    description: DarkSide service termination for encryption
    criticality: suspicious
    confidence: 0.8
    mbc: "C0027"
    attack: "T1489"
    condition:
      type: yara
      source: |
        rule darkside_svc_kill {
          strings:
            // Full service names that ransomware targets
            $svc1 = "vssadmin" ascii nocase
            $svc2 = "sqlservr" ascii nocase
            $svc3 = "mssqlserver" ascii nocase
            $svc4 = "vmware-hostd" ascii nocase
            $svc5 = "vmware-vpxd" ascii nocase
            $svc6 = "backup-agent" ascii nocase
            $svc7 = "veeam" ascii nocase
            // Service stop commands with service name
            $kill1 = "systemctl stop" ascii
            $kill2 = "net stop" ascii
            $kill3 = "sc stop" ascii
            $kill4 = "service stop" ascii
          condition:
            any of ($svc*) and any of ($kill*)
        }

composite_rules:
  # Full DarkSide detection
  - id: malware/ransomware/darkside/detected
    description: DarkSide ransomware detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/ransomware/darkside/ransom-note
      - type: trait
        id: malware/ransomware/darkside/linux-esxi
      - type: trait
        id: malware/ransomware/darkside/encryption
