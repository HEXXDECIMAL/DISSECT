# K4Spreader Malware Detection
# ATT&CK: T1059 (Command and Scripting Interpreter)
# MBC: B0030 (Remote Access)

traits:
  # K4Spreader dropper
  - id: malware/dropper/k4spreader/generic
    description: K4Spreader malware dropper patterns
    criticality: hostile
    confidence: 0.9
    mbc: "B0030"
    attack: "T1059"
    condition:
      type: yara
      source: |
        rule k4spreader_dropper {
          strings:
            // K4Spreader identifiers
            $name1 = "k4spreader" ascii nocase
            $name2 = "K4SPREADER" ascii
            $name3 = "k4-spreader" ascii nocase
            // Related malware
            $rel1 = "tsunami" ascii nocase
            $rel2 = "kaiten" ascii nocase
            // Spreading patterns
            $spread1 = "scanner" ascii
            $spread2 = "exploit" ascii
            $spread3 = "brute" ascii
          condition:
            any of ($name*) or
            (any of ($rel*) and 2 of ($spread*))
        }

  # K4Spreader C2 communication
  - id: malware/dropper/k4spreader/c2
    description: K4Spreader C2 patterns
    criticality: hostile
    confidence: 0.85
    mbc: "B0030"
    attack: "T1071"
    condition:
      type: yara
      source: |
        rule k4spreader_c2 {
          strings:
            // K4Spreader C2 patterns
            $name1 = "k4spreader" ascii nocase
            // IRC C2
            $irc1 = "PRIVMSG" ascii
            $irc2 = "NICK " ascii
            $irc3 = "USER " ascii
            $irc4 = "JOIN #" ascii
            // Bot commands
            $cmd1 = ".udp" ascii
            $cmd2 = ".tcp" ascii
            $cmd3 = ".http" ascii
            $cmd4 = ".shell" ascii
          condition:
            $name1 or
            (3 of ($irc*) and any of ($cmd*))
        }

  # K4Spreader DDoS capability
  - id: malware/dropper/k4spreader/ddos
    description: K4Spreader DDoS attack capability
    criticality: hostile
    confidence: 0.85
    mbc: "B0030"
    attack: "T1498"
    condition:
      type: yara
      source: |
        rule k4spreader_ddos {
          strings:
            // K4Spreader identifiers
            $name1 = "k4spreader" ascii nocase
            // DDoS methods
            $ddos1 = "UDP flood" ascii nocase
            $ddos2 = "TCP flood" ascii nocase
            $ddos3 = "SYN flood" ascii nocase
            $ddos4 = "HTTP flood" ascii nocase
            // Raw socket
            $raw1 = "SOCK_RAW" ascii
            $raw2 = "IPPROTO_RAW" ascii
          condition:
            $name1 or
            (any of ($ddos*) and any of ($raw*))
        }

composite_rules:
  # K4Spreader detection
  - id: malware/dropper/k4spreader/detected
    description: K4Spreader malware detected
    criticality: hostile
    confidence: 0.95
    requires_any:
      - type: trait
        id: malware/dropper/k4spreader/generic
      - type: trait
        id: malware/dropper/k4spreader/c2
      - type: trait
        id: malware/dropper/k4spreader/ddos
