# Testing Framework Detection
# Useful for identifying test binaries vs production code

traits:
  # === Atomic: Google Test (C++) ===

  - id: gtest-testing-test
    desc: "testing::Test class"
    crit: inert
    conf: 0.7
    for: [cpp]
    if:
      type: string
      exact: "testing::Test"

  - id: gtest-macro-prefix
    desc: GTEST_ macro prefix
    crit: inert
    conf: 0.7
    for: [cpp]
    if:
      type: string
      exact: "GTEST_"

  - id: gtest-test-f
    desc: TEST_F macro
    crit: inert
    conf: 0.8
    for: [cpp]
    if:
      type: string
      exact: "TEST_F("

  - id: gtest-expect-prefix
    desc: EXPECT_ macro prefix
    crit: inert
    conf: 0.7
    for: [cpp]
    if:
      type: string
      exact: "EXPECT_"

  - id: gtest-assert-prefix
    desc: ASSERT_ macro prefix
    crit: inert
    conf: 0.7
    for: [cpp]
    if:
      type: string
      exact: "ASSERT_"

  - id: gtest-word
    desc: gtest reference
    crit: inert
    conf: 0.6
    for: [cpp]
    if:
      type: string
      word: "gtest"

  # === Atomic: Catch2 (C++) ===

  - id: catch2-namespace
    desc: "Catch:: namespace"
    crit: inert
    conf: 0.8
    for: [cpp]
    if:
      type: string
      exact: "Catch::"

  - id: catch2-macro-prefix
    desc: CATCH_ macro prefix
    crit: inert
    conf: 0.8
    for: [cpp]
    if:
      type: string
      exact: "CATCH_"

  - id: catch2-test-case
    desc: TEST_CASE macro
    crit: inert
    conf: 0.8
    for: [cpp]
    if:
      type: string
      exact: "TEST_CASE"

  - id: catch2-section
    desc: SECTION macro
    crit: inert
    conf: 0.7
    for: [cpp]
    if:
      type: string
      word: "SECTION"

  - id: catch2-require
    desc: REQUIRE macro
    crit: inert
    conf: 0.7
    for: [cpp]
    if:
      type: string
      word: "REQUIRE"

  # === Atomic: JUnit (Java) ===

  - id: junit-package
    desc: org.junit package
    crit: inert
    conf: 0.8
    for: [java]
    if:
      type: string
      exact: "org.junit"

  - id: junit-test-annotation
    desc: "@Test annotation"
    crit: inert
    conf: 0.8
    for: [java]
    if:
      type: string
      exact: "@Test"

  - id: junit-assert-equals
    desc: assertEquals method
    crit: inert
    conf: 0.7
    for: [java]
    if:
      type: string
      word: "assertEquals"

  - id: junit-assert-true
    desc: assertTrue method
    crit: inert
    conf: 0.7
    for: [java]
    if:
      type: string
      word: "assertTrue"

  - id: junit-assert-not-null
    desc: assertNotNull method
    crit: inert
    conf: 0.7
    for: [java]
    if:
      type: string
      word: "assertNotNull"

  # === Atomic: pytest (Python) ===

  - id: pytest-word
    desc: pytest reference
    crit: inert
    conf: 0.7
    for: [python]
    if:
      type: string
      word: "pytest"

  - id: pytest-test-func
    desc: "def test_ function"
    crit: inert
    conf: 0.8
    for: [python]
    if:
      type: string
      exact: "def test_"

  - id: pytest-decorator
    desc: "@pytest decorator"
    crit: inert
    conf: 0.8
    for: [python]
    if:
      type: string
      exact: "@pytest"

  - id: pytest-conftest
    desc: conftest.py file
    crit: inert
    conf: 0.9
    for: [python]
    if:
      type: string
      exact: "conftest.py"

  - id: python-assert-statement
    desc: "assert statement"
    crit: inert
    conf: 0.4
    for: [python]
    if:
      type: string
      exact: "assert "

  # === Atomic: Go testing ===

  - id: go-testing-t
    desc: testing.T type
    crit: inert
    conf: 0.7
    for: [go]
    if:
      type: string
      exact: "testing.T"

  - id: go-testing-m
    desc: testing.M type
    crit: inert
    conf: 0.7
    for: [go]
    if:
      type: string
      exact: "testing.M"

  - id: go-testing-b
    desc: testing.B type
    crit: inert
    conf: 0.7
    for: [go]
    if:
      type: string
      exact: "testing.B"

  - id: go-func-test
    desc: "func Test prefix"
    crit: inert
    conf: 0.8
    for: [go]
    if:
      type: string
      exact: "func Test"

  - id: go-t-error
    desc: t.Error method
    crit: inert
    conf: 0.7
    for: [go]
    if:
      type: string
      exact: "t.Error"

  - id: go-t-fatal
    desc: t.Fatal method
    crit: inert
    conf: 0.7
    for: [go]
    if:
      type: string
      exact: "t.Fatal"

  # === Atomic: Rust testing ===

  - id: rust-test-attr
    desc: "#[test] attribute"
    crit: inert
    conf: 0.9
    for: [rust]
    if:
      type: string
      exact: "#[test]"

  - id: rust-cfg-test
    desc: "#[cfg(test)] attribute"
    crit: inert
    conf: 0.9
    for: [rust]
    if:
      type: string
      exact: "#[cfg(test)]"

  - id: rust-assert-macro
    desc: "assert! macro"
    crit: inert
    conf: 0.6
    for: [rust]
    if:
      type: string
      exact: "assert!"

  - id: rust-assert-eq-macro
    desc: "assert_eq! macro"
    crit: inert
    conf: 0.7
    for: [rust]
    if:
      type: string
      exact: "assert_eq!"

  - id: rust-cargo-test
    desc: cargo test command
    crit: inert
    conf: 0.8
    for: [rust]
    if:
      type: string
      exact: "cargo test"

  # === Atomic: Jest (JavaScript) ===

  - id: jest-word
    desc: jest reference
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: string
      word: "jest"

  - id: jest-describe
    desc: "describe() function"
    crit: inert
    conf: 0.6
    for: [javascript]
    if:
      type: string
      exact: "describe("

  - id: jest-it
    desc: "it() function"
    crit: inert
    conf: 0.5
    for: [javascript]
    if:
      type: string
      exact: "it("

  - id: jest-expect
    desc: "expect() function"
    crit: inert
    conf: 0.5
    for: [javascript]
    if:
      type: string
      exact: "expect("

  - id: jest-to-be
    desc: "toBe() matcher"
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: string
      exact: "toBe("

  - id: jest-to-equal
    desc: "toEqual() matcher"
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: string
      exact: "toEqual("

  # === Atomic: Mocha (JavaScript) ===

  - id: mocha-word
    desc: mocha reference
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: string
      word: "mocha"

  # describe() and it() shared with Jest above

  - id: mocha-before
    desc: "before() hook"
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: string
      exact: "before("

  - id: mocha-after
    desc: "after() hook"
    crit: inert
    conf: 0.7
    for: [javascript]
    if:
      type: string
      exact: "after("

  # === Atomic: RSpec (Ruby) ===

  - id: rspec-lower
    desc: rspec reference (lowercase)
    crit: inert
    conf: 0.7
    for: [ruby]
    if:
      type: string
      word: "rspec"

  - id: rspec-title
    desc: RSpec reference (title case)
    crit: inert
    conf: 0.7
    for: [ruby]
    if:
      type: string
      word: "RSpec"

  - id: rspec-describe
    desc: "describe statement"
    crit: inert
    conf: 0.6
    for: [ruby]
    if:
      type: string
      exact: "describe "

  - id: rspec-context
    desc: "context statement"
    crit: inert
    conf: 0.6
    for: [ruby]
    if:
      type: string
      exact: "context "

  - id: rspec-expect
    desc: "expect() function"
    crit: inert
    conf: 0.6
    for: [ruby]
    if:
      type: string
      exact: "expect("

  # === Atomic: Fuzzing ===

  - id: libfuzzer-word
    desc: libfuzzer reference
    crit: inert
    conf: 0.8
    for: [c, cpp]
    if:
      type: string
      word: "libfuzzer"

  - id: llvm-fuzzer
    desc: LLVMFuzzer reference
    crit: inert
    conf: 0.9
    for: [c, cpp]
    if:
      type: string
      word: "LLVMFuzzer"

  - id: afl-word
    desc: AFL fuzzer
    crit: inert
    conf: 0.7
    for: [c, cpp]
    if:
      type: string
      word: "AFL"

  - id: honggfuzz-word
    desc: honggfuzz reference
    crit: inert
    conf: 0.9
    for: [c, cpp]
    if:
      type: string
      word: "honggfuzz"

  - id: go-fuzz
    desc: go-fuzz reference
    crit: inert
    conf: 0.9
    for: [go]
    if:
      type: string
      word: "go-fuzz"

  - id: cargo-fuzz
    desc: cargo-fuzz reference
    crit: inert
    conf: 0.9
    for: [rust]
    if:
      type: string
      word: "cargo-fuzz"

  # === Atomic: Benchmark ===

  - id: benchmark-lower
    desc: benchmark reference (lowercase)
    crit: inert
    conf: 0.5
    for: [all]
    if:
      type: string
      word: "benchmark"

  - id: benchmark-title
    desc: Benchmark reference (title case)
    crit: inert
    conf: 0.5
    for: [all]
    if:
      type: string
      word: "Benchmark"

  - id: google-benchmark
    desc: google/benchmark library
    crit: inert
    conf: 0.9
    for: [cpp]
    if:
      type: string
      exact: "google/benchmark"

  - id: go-benchmark-type
    desc: Go testing.B benchmark type
    crit: inert
    conf: 0.8
    for: [go]
    if:
      type: string
      exact: "testing.B"

  - id: criterion-bench
    desc: Criterion benchmark library
    crit: inert
    conf: 0.9
    for: [rust]
    if:
      type: string
      word: "criterion"

  - id: benchmarkdotnet
    desc: BenchmarkDotNet library
    crit: inert
    conf: 0.9
    for: [csharp]
    if:
      type: string
      word: "BenchmarkDotNet"

composite_rules:
  # Google Test (C++)
  - id: gtest
    desc: Google Test framework
    crit: benign
    conf: 0.95
    for: [cpp]
    count_min: 2
    any:
      - { id: gtest-testing-test }
      - { id: gtest-macro-prefix }
      - { id: gtest-test-f }
      - { id: gtest-expect-prefix }
      - { id: gtest-assert-prefix }
      - { id: gtest-word }

  # Catch2 (C++)
  - id: catch2
    desc: Catch2 test framework
    crit: benign
    conf: 0.95
    for: [cpp]
    count_min: 2
    any:
      - { id: catch2-namespace }
      - { id: catch2-macro-prefix }
      - { id: catch2-test-case }
      - { id: catch2-section }
      - { id: catch2-require }

  # JUnit (Java)
  - id: junit
    desc: JUnit test framework
    crit: benign
    conf: 0.95
    for: [java]
    any:
      - { id: junit-package }
      - { id: junit-test-annotation }
      - { id: junit-assert-equals }
      - { id: junit-assert-true }
      - { id: junit-assert-not-null }

  # pytest (Python) - helper for pytest markers
  - id: pytest-markers
    desc: pytest-specific markers
    crit: inert
    conf: 0.8
    for: [python]
    any:
      - { id: pytest-word }
      - { id: pytest-test-func }
      - { id: pytest-decorator }
      - { id: pytest-conftest }

  # pytest with assert helper
  - id: pytest-with-assert
    desc: pytest markers with assert statement
    crit: inert
    conf: 0.8
    for: [python]
    all:
      - { id: python-assert-statement }
      - { id: pytest-markers }

  # pytest (Python) - main composite
  - id: pytest
    desc: pytest test framework
    crit: benign
    conf: 0.95
    for: [python]
    any:
      - { id: pytest-markers }
      - { id: pytest-with-assert }

  # Go testing
  - id: go-test
    desc: Go testing package
    crit: benign
    conf: 0.95
    for: [go]
    count_min: 2
    any:
      - { id: go-testing-t }
      - { id: go-testing-m }
      - { id: go-testing-b }
      - { id: go-func-test }
      - { id: go-t-error }
      - { id: go-t-fatal }

  # Rust testing
  - id: rust-test
    desc: Rust test framework
    crit: benign
    conf: 0.95
    for: [rust]
    any:
      - { id: rust-test-attr }
      - { id: rust-cfg-test }
      - { id: rust-assert-macro }
      - { id: rust-assert-eq-macro }
      - { id: rust-cargo-test }

  # Jest BDD functions helper (shared with Mocha)
  - id: js-bdd-functions
    desc: JavaScript BDD test functions
    crit: inert
    conf: 0.6
    for: [javascript]
    count_min: 3
    any:
      - { id: jest-describe }
      - { id: jest-it }
      - { id: jest-expect }
      - { id: jest-to-be }
      - { id: jest-to-equal }

  # Jest (JavaScript)
  - id: jest
    desc: Jest test framework
    crit: benign
    conf: 0.95
    for: [javascript]
    any:
      - { id: jest-word }
      - { id: js-bdd-functions }

  # Mocha (JavaScript) - all patterns helper
  - id: mocha-all-patterns
    desc: Mocha test patterns
    crit: inert
    conf: 0.7
    for: [javascript]
    count_min: 3
    any:
      - { id: mocha-word }
      - { id: jest-describe }
      - { id: jest-it }
      - { id: mocha-before }
      - { id: mocha-after }

  # Mocha (JavaScript)
  - id: mocha
    desc: Mocha test framework
    crit: benign
    conf: 0.95
    for: [javascript]
    any:
      - { id: mocha-word }
      - { id: mocha-all-patterns }

  # RSpec BDD patterns helper
  - id: rspec-bdd-patterns
    desc: RSpec BDD patterns
    crit: inert
    conf: 0.7
    for: [ruby]
    count_min: 2
    any:
      - { id: rspec-describe }
      - { id: rspec-context }
      - { id: rspec-expect }

  # RSpec (Ruby)
  - id: rspec
    desc: RSpec test framework
    crit: benign
    conf: 0.95
    for: [ruby]
    any:
      - { id: rspec-lower }
      - { id: rspec-title }
      - { id: rspec-bdd-patterns }

  # Fuzzing frameworks
  - id: fuzzing
    desc: Fuzzing test framework
    crit: benign
    conf: 0.9
    any:
      - { id: libfuzzer-word }
      - { id: llvm-fuzzer }
      - { id: afl-word }
      - { id: honggfuzz-word }
      - { id: go-fuzz }
      - { id: cargo-fuzz }

  # Benchmark frameworks
  - id: benchmark
    desc: Benchmark test framework
    crit: benign
    conf: 0.9
    any:
      - { id: benchmark-lower }
      - { id: benchmark-title }
      - { id: google-benchmark }
      - { id: go-benchmark-type }
      - { id: criterion-bench }
      - { id: benchmarkdotnet }
