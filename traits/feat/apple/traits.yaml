# Meta - Apple System Component Identification
# Identifies legitimate Apple system binaries and frameworks
# These traits help contextualize findings for known-good system components

defaults:
  crit: inert
  platforms: [macos]
  for: [macho, dylib]

traits:
  # === Bundle Identifiers ===

  - id: bundle-id
    description: Apple bundle identifier (com.apple.*)
    crit: inert
    conf: 0.95
    if:
      type: string
      regex: "com\\.apple\\.[a-z][a-z0-9.-]+"

  - id: system-daemon
    description: Apple system daemon (libexec)
    crit: inert
    conf: 0.9
    platforms: [macos]
    for: [macho]
    if:
      type: string
      regex: "/usr/libexec/[a-z][a-z0-9_-]+d\\b"

  - id: xpc-service
    description: Apple XPC service
    crit: inert
    conf: 0.9
    platforms: [macos]
    for: [macho]
    if:
      type: string
      regex: "\\.xpc/Contents/MacOS/"

  # === Code Signing ===

  # === Project Identifiers ===

  - id: project-marker
    description: Apple internal project marker
    conf: 0.95
    if:
      type: string
      # Apple internal PROJECT: marker in binary
      regex: "@\\(#\\)PROGRAM:[a-z]+\\s+PROJECT:[A-Za-z]+-[0-9]+"

  # === Apple Frameworks ===

  # === Ad framework atomic indicators ===
  - id: adcore-framework
    description: AdCore.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "/AdCore.framework/"

  - id: adid-framework
    description: AdID.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "/AdID.framework/"

  - id: limitadtracking-framework
    description: LimitAdTracking.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "/LimitAdTracking.framework/"

  # === Privacy framework atomic indicators ===
  - id: apptrackingtransparency-framework
    description: AppTrackingTransparency.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "/AppTrackingTransparency.framework/"

  - id: privacycontentprediction-framework
    description: PrivacyContentPrediction.framework usage
    crit: inert
    conf: 0.7
    if:
      type: string
      exact: "/PrivacyContentPrediction.framework/"

  - id: private-framework
    description: Apple private framework usage
    conf: 0.85
    if:
      type: string
      exact: "/System/Library/PrivateFrameworks"

  - id: system-framework
    description: Apple system framework path
    crit: inert
    conf: 0.85
    if:
      type: string
      exact: "/System/Library/Frameworks"

  - id: launchd-plist
    description: launchd plist embedding
    crit: inert
    conf: 0.85
    if:
      type: string
      exact: "launchd.plist"

  # === IPC Mechanisms ===

  # === Dispatch (GCD) ===

  # === Dispatch queue atomic indicators ===
  - id: dispatch-queue-create
    description: dispatch_queue_create symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      pattern: "dispatch_queue_create"

  - id: dispatch-get-global-queue
    description: dispatch_get_global_queue symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      pattern: "dispatch_get_global_queue"

  # === Dispatch async atomic indicators ===
  - id: dispatch-async-symbol
    description: dispatch_async symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      pattern: "dispatch_async"

  - id: dispatch-sync-symbol
    description: dispatch_sync symbol
    crit: inert
    conf: 0.6
    if:
      type: symbol
      pattern: "dispatch_sync"

  - id: dispatch-source
    description: Grand Central Dispatch source (event monitoring)
    conf: 0.85
    if:
      type: symbol
      pattern: "dispatch_source_create"

composite_rules:
  - id: ad-framework
    description: Apple advertising framework usage
    crit: notable
    conf: 0.9
    requires_count: 1
    any:
      - id: adcore-framework
      - id: adid-framework
      - id: limitadtracking-framework

  - id: privacy-framework
    description: Apple privacy framework usage
    crit: notable
    conf: 0.9
    requires_count: 1
    any:
      - id: apptrackingtransparency-framework
      - id: privacycontentprediction-framework

  - id: dispatch-queue
    description: Grand Central Dispatch queue usage
    conf: 0.8
    requires_count: 1
    any:
      - id: dispatch-queue-create
      - id: dispatch-get-global-queue

  - id: dispatch-async
    description: Grand Central Dispatch async execution
    conf: 0.8
    requires_count: 1
    any:
      - id: dispatch-async-symbol
      - id: dispatch-sync-symbol

  # Helper: Any Apple framework path detected
  - id: any-framework
    description: Any Apple framework path (system or private)
    crit: inert
    conf: 0.85
    platforms: [macos]
    for: [macho]
    requires_any:
      - id: system-framework
      - id: private-framework

  # Bundle + Project combination
  - id: bundle-and-project
    description: Apple bundle identifier with project marker
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    requires_all:
      - id: bundle-id
      - id: project-marker

  # Bundle + Framework combination
  - id: bundle-and-framework
    description: Apple bundle identifier with framework path
    crit: inert
    conf: 0.9
    platforms: [macos]
    for: [macho]
    requires_all:
      - id: bundle-id
      - id: any-framework

  # Project + Framework combination
  - id: project-and-framework
    description: Apple project marker with framework path
    crit: inert
    conf: 0.9
    platforms: [macos]
    for: [macho]
    requires_all:
      - id: project-marker
      - id: any-framework

  # Main composite: Any valid combination
  - id: system-component
    description: Apple system component (legitimate macOS binary)
    crit: inert
    conf: 0.95
    platforms: [macos]
    for: [macho]
    requires_any:
      - id: bundle-and-project
      - id: bundle-and-framework
      - id: project-and-framework
