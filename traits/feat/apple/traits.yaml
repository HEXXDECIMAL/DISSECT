# Meta - Apple System Component Identification
# Identifies legitimate Apple system binaries and frameworks
# These traits help contextualize findings for known-good system components

defaults:
  criticality: inert
  platforms: [macos]
  file_types: [macho, dylib]

traits:
  # === Bundle Identifiers ===

  - id: bundle-id
    description: Apple bundle identifier (com.apple.*)
    criticality: inert
    confidence: 0.95
    condition:
      type: string
      regex: "com\\.apple\\.[a-z][a-z0-9.-]+"

  - id: system-daemon
    description: Apple system daemon (libexec)
    criticality: inert
    confidence: 0.9
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      regex: "/usr/libexec/[a-z][a-z0-9_-]+d\\b"

  - id: xpc-service
    description: Apple XPC service
    criticality: inert
    confidence: 0.9
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      regex: "\\.xpc/Contents/MacOS/"

  # === Code Signing ===

  # === Project Identifiers ===

  - id: project-marker
    description: Apple internal project marker
    confidence: 0.95
    condition:
      type: string
      # Apple internal PROJECT: marker in binary
      regex: "@\\(#\\)PROGRAM:[a-z]+\\s+PROJECT:[A-Za-z]+-[0-9]+"

  # === Apple Frameworks ===

  - id: ad-framework
    description: Apple advertising framework usage
    criticality: notable
    confidence: 0.9
    condition:
      type: string
      regex: "/AdCore\\.framework/|/AdID\\.framework/|/LimitAdTracking\\.framework/"

  - id: privacy-framework
    description: Apple privacy framework usage
    criticality: notable
    confidence: 0.9
    condition:
      type: string
      regex: "/AppTrackingTransparency\\.framework/|/PrivacyContentPrediction\\.framework/"

  - id: private-framework
    description: Apple private framework usage
    confidence: 0.85
    condition:
      type: string
      exact: "/System/Library/PrivateFrameworks"

  - id: system-framework
    description: Apple system framework path
    criticality: inert
    confidence: 0.85
    condition:
      type: string
      exact: "/System/Library/Frameworks"

  - id: launchd-plist
    description: launchd plist embedding
    criticality: inert
    confidence: 0.85
    condition:
      type: string
      exact: "launchd.plist"

  # === IPC Mechanisms ===

  # === Dispatch (GCD) ===

  - id: dispatch-queue
    description: Grand Central Dispatch queue usage
    confidence: 0.8
    condition:
      type: symbol
      pattern: "dispatch_queue_create|dispatch_get_global_queue"

  - id: dispatch-async
    description: Grand Central Dispatch async execution
    confidence: 0.8
    condition:
      type: symbol
      pattern: "dispatch_async|dispatch_sync"

  - id: dispatch-source
    description: Grand Central Dispatch source (event monitoring)
    confidence: 0.85
    condition:
      type: symbol
      pattern: "dispatch_source_create"

composite_rules:
  # Helper: Any Apple framework path detected
  - id: any-framework
    description: Any Apple framework path (system or private)
    criticality: inert
    confidence: 0.85
    platforms: [macos]
    file_types: [macho]
    requires_any:
      - id: system-framework
      - id: private-framework

  # Bundle + Project combination
  - id: bundle-and-project
    description: Apple bundle identifier with project marker
    criticality: inert
    confidence: 0.95
    platforms: [macos]
    file_types: [macho]
    requires_all:
      - id: bundle-id
      - id: project-marker

  # Bundle + Framework combination
  - id: bundle-and-framework
    description: Apple bundle identifier with framework path
    criticality: inert
    confidence: 0.9
    platforms: [macos]
    file_types: [macho]
    requires_all:
      - id: bundle-id
      - id: any-framework

  # Project + Framework combination
  - id: project-and-framework
    description: Apple project marker with framework path
    criticality: inert
    confidence: 0.9
    platforms: [macos]
    file_types: [macho]
    requires_all:
      - id: project-marker
      - id: any-framework

  # Main composite: Any valid combination
  - id: system-component
    description: Apple system component (legitimate macOS binary)
    criticality: inert
    confidence: 0.95
    platforms: [macos]
    file_types: [macho]
    requires_any:
      - id: bundle-and-project
      - id: bundle-and-framework
      - id: project-and-framework
