# Meta - Security Hardening Behaviors
# Identifies legitimate security-positive behaviors
# These traits indicate the program is using security features, not evading them

defaults:
  criticality: notable

traits:
  # === Sandbox Entry (macOS) ===

  - id: sandbox-init
    description: macOS sandbox initialization
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "sandbox_init"

  - id: sandbox-init-params
    description: macOS sandbox initialization with parameters
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "sandbox_init_with_parameters"

  - id: sandbox-extension-consume
    description: macOS sandbox extension consumption
    confidence: 0.9
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "sandbox_extension_consume"

  - id: sandbox-extension-issue
    description: macOS sandbox extension issuance
    confidence: 0.9
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "sandbox_extension_issue"

  - id: sandbox-check
    description: macOS sandbox check function
    confidence: 0.9
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: symbol
      pattern: "sandbox_check"

  # === Sandbox Entry Messages ===

  - id: sandbox-entering
    description: Sandbox entry log message
    confidence: 0.85
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      regex: "entering sandbox"
      case_insensitive: true

  # === Hardened Runtime (macOS) ===

  - id: hardened-runtime
    description: macOS Hardened Runtime enabled
    confidence: 0.9
    platforms: [macos]
    file_types: [macho]
    condition:
      type: string
      exact: "runtime"

  # === seccomp (Linux) ===

  - id: seccomp-init
    description: Linux seccomp sandbox initialization
    confidence: 0.95
    platforms: [linux]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "seccomp_init"

  - id: seccomp-rule-add
    description: Linux seccomp rule addition
    confidence: 0.9
    platforms: [linux]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "seccomp_rule_add"

  - id: seccomp-load
    description: Linux seccomp profile loading
    confidence: 0.95
    platforms: [linux]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "seccomp_load"

  - id: prctl-seccomp
    description: Linux prctl seccomp mode
    confidence: 0.85
    platforms: [linux]
    file_types: [elf]
    condition:
      type: string
      exact: "PR_SET_SECCOMP"

  # === Pledge/Unveil (OpenBSD) ===

  - id: pledge
    description: OpenBSD pledge syscall restriction
    confidence: 0.95
    platforms: [openbsd]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "^pledge$"

  - id: unveil
    description: OpenBSD unveil filesystem restriction
    confidence: 0.95
    platforms: [openbsd]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "^unveil$"

  # === Capsicum (FreeBSD) ===

  - id: cap-enter
    description: FreeBSD Capsicum capability mode
    confidence: 0.95
    platforms: [freebsd]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "cap_enter"

  - id: cap-rights-limit
    description: FreeBSD Capsicum rights limiting
    confidence: 0.9
    platforms: [freebsd]
    file_types: [elf]
    condition:
      type: symbol
      pattern: "cap_rights_limit"

composite_rules:
  - id: macos-sandboxed
    description: macOS App Sandbox enabled
    criticality: notable
    confidence: 0.95
    platforms: [macos]
    file_types: [macho, dylib]
    condition:
      type: yara
      source: |
        rule macos_sandboxed {
          meta:
            description = "macOS application using App Sandbox"
          strings:
            // Sandbox initialization symbols
            $sandbox_init = "sandbox_init" ascii
            $sandbox_init_params = "sandbox_init_with_parameters" ascii
            // Sandbox extension handling
            $ext_consume = "sandbox_extension_consume" ascii
            $ext_issue = "sandbox_extension_issue" ascii
            // Log messages indicating sandbox entry
            $entering = "entering sandbox" nocase ascii
            $failed = "Failed to enter sandbox" ascii
          condition:
            filesize < 100MB and
            (1 of ($sandbox_init*) or 2 of ($ext_*) or any of ($entering, $failed))
        }

  - id: linux-seccomp
    description: Linux seccomp sandbox enabled
    criticality: notable
    confidence: 0.95
    platforms: [linux]
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule linux_seccomp {
          meta:
            description = "Linux application using seccomp sandbox"
          strings:
            $seccomp_init = "seccomp_init" ascii
            $seccomp_load = "seccomp_load" ascii
            $seccomp_rule = "seccomp_rule_add" ascii
            $prctl_seccomp = "PR_SET_SECCOMP" ascii
            $seccomp_mode = "SECCOMP_MODE_FILTER" ascii
          condition:
            filesize < 100MB and 2 of them
        }
