# Network Capabilities
# Covers socket operations, HTTP/HTTPS, DNS, raw packets, etc.

simple_rules:
  # Socket operations
  - symbol: socket
    capability: net/socket/create
    description: Create network sockets
    confidence: 0.7  # Common in benign software
    platforms: [all]

  - symbol: bind
    capability: net/socket/listen
    description: Bind and listen on network port
    confidence: 0.8
    platforms: [all]

  - symbol: listen
    capability: net/socket/listen
    description: Listen for incoming connections
    confidence: 0.8
    platforms: [all]

  - symbol: accept
    capability: net/socket/listen
    description: Accept incoming connections
    confidence: 0.8
    platforms: [all]

  - symbol: connect
    capability: net/socket/connect
    description: Connect to remote host
    confidence: 0.7
    platforms: [all]

  # DNS resolution
  - symbol: gethostbyname
    capability: net/dns/resolve
    description: Resolve hostnames to IP addresses
    confidence: 0.8
    platforms: [unix, linux, macos]

  - symbol: getaddrinfo
    capability: net/dns/resolve
    description: Resolve hostnames to IP addresses
    confidence: 0.8
    platforms: [all]

  - symbol: res_query
    capability: net/dns/query
    description: Perform DNS queries
    confidence: 0.9
    platforms: [unix, linux, macos]

  # Hostname operations
  - symbol: gethostname
    capability: net/hostname/get
    description: Get system hostname
    confidence: 0.6
    platforms: [all]

  - symbol: sethostname
    capability: net/hostname/set
    description: Set system hostname
    confidence: 1.0
    platforms: [unix, linux, macos]

composite_rules:
  # Reverse shell detection
  - capability: net/reverse-shell
    description: Reverse shell behavior pattern
    confidence: 0.9
    platforms: [linux, macos, unix]
    file_types: [elf, macho, shellscript]

    requires_count: 2
    conditions:
      # Network connection
      - type: symbol_or_string
        any:
          - socket
          - connect
          - 'tcp://'
          - '/dev/tcp/'

      # File descriptor duplication (stdin/stdout/stderr redirect)
      - type: symbol_or_string
        any:
          - dup2
          - dup
          - _dup2

      # Shell execution
      - type: symbol_or_string
        any:
          - execve
          - execl
          - system
          - '/bin/sh'
          - '/bin/bash'
          - 'sh -i'

  # Hardcoded C2 IP address
  - capability: c2/ip/hardcoded
    description: Hardcoded IP address (potential C2)
    confidence: 0.85
    platforms: [all]

    requires_all:
      # Must have network capability
      - type: symbol_or_string
        any:
          - socket
          - connect
          - URLSession
          - HttpURLConnection

      # Suspicious IP pattern (exclude common private/local ranges)
      - type: string
        regex: '\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]{1,5}\b'
        exclude_patterns:
          - '127\.0\.0\.'
          - '192\.168\.'
          - '10\.'
          - '172\.(1[6-9]|2[0-9]|3[01])\.'
          - '0\.0\.0\.0'
          - '255\.255\.255\.255'

  # Tor usage for anonymity
  - capability: c2/network/tor
    description: Use Tor for anonymity
    confidence: 0.9
    platforms: [all]

    requires_any:
      # .onion domain
      - type: string
        regex: '[a-z2-7]{16,56}\.onion'

      # SOCKS proxy to Tor default port
      - type: string
        regex: 'socks[45]://127\.0\.0\.1:9050'

      # Tor control port
      - type: string
        exact: ':9051'

      # YARA match for Tor
      - type: yara_match
        namespace: c2.tor

  # Bind shell
  - capability: net/bind-shell
    description: Bind shell listening for connections
    confidence: 0.9
    platforms: [linux, macos, unix]

    requires_all:
      # Listen on socket
      - type: symbol_or_string
        any:
          - bind
          - listen
          - accept

      # File descriptor duplication
      - type: symbol
        pattern: 'dup2|dup'

      # Shell execution
      - type: symbol_or_string
        any:
          - execve
          - system
          - '/bin/sh'
          - '/bin/bash'

  # Raw socket creation (packet crafting)
  - capability: net/socket/raw
    description: Create raw sockets for packet crafting
    confidence: 0.95
    platforms: [linux, macos, unix]

    requires_all:
      - type: symbol
        pattern: socket

      - type: string
        regex: 'SOCK_RAW|IPPROTO_RAW'

  # HTTP/HTTPS client
  - capability: net/http/client
    description: HTTP/HTTPS client functionality
    confidence: 0.75
    platforms: [all]

    requires_any:
      # Common HTTP libraries/symbols
      - type: symbol_or_string
        any:
          - curl_easy_init
          - URLSession
          - HttpURLConnection
          - XMLHttpRequest
          - 'http://'
          - 'https://'

      # YARA match for HTTP
      - type: yara_match
        namespace: net.http

  # DGA (Domain Generation Algorithm)
  - capability: c2/dns/dga
    description: Domain Generation Algorithm for C2
    confidence: 0.85
    platforms: [all]

    requires_all:
      # YARA detected DGA pattern
      - type: yara_match
        namespace: c2.dga

      # DNS resolution capability
      - type: symbol_or_string
        any:
          - getaddrinfo
          - gethostbyname
          - res_query
          - DNSServiceQueryRecord

  # Suspicious user agent
  - capability: net/http/suspicious-ua
    description: Suspicious or non-standard user agent
    confidence: 0.7
    platforms: [all]

    requires_all:
      # HTTP capability
      - type: symbol_or_string
        any:
          - curl_
          - URLSession
          - 'User-Agent'

      # Suspicious UA patterns
      - type: string
        regex: 'User-Agent:?\s*(curl|wget|python|go-http|okhttp|bot)'
        case_insensitive: true

  # IRC C2
  - capability: c2/protocol/irc
    description: IRC protocol for C2 communication
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      # IRC commands
      - type: string
        regex: '(JOIN|PRIVMSG|NICK|USER|PONG)\s+[:#]'

      # IRC port
      - type: string
        exact: ':6667'

      # Socket operations
      - type: symbol
        pattern: 'socket|connect'

  # DNS tunneling
  - capability: c2/dns/tunnel
    description: DNS tunneling for data exfiltration
    confidence: 0.85
    platforms: [all]

    requires_all:
      # Many DNS queries
      - type: yara_match
        namespace: exfil.dns

      # DNS functions
      - type: symbol_or_string
        any:
          - res_query
          - res_send
          - getaddrinfo

      # Suspicious domain patterns (long subdomain)
      - type: string
        regex: '[a-z0-9]{32,}\.'
