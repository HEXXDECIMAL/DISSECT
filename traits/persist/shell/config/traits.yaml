# Persistence - Shell Configuration Files
# ATT&CK: T1546.004 (Unix Shell Configuration Modification)

traits:
  # Bash persistence
  - id: bash-profile
    description: Accesses .bash_profile for shell persistence
    crit: suspicious
    confidence: 0.7
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".bash_profile"

  - id: bashrc
    description: Accesses .bashrc for shell persistence
    crit: suspicious
    confidence: 0.7
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".bashrc"

  - id: bash-login
    description: Accesses .bash_login for shell persistence
    crit: suspicious
    confidence: 0.75
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".bash_login"

  - id: bash-logout
    description: Accesses .bash_logout for shell persistence
    crit: suspicious
    confidence: 0.85
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".bash_logout"

  - id: profile
    description: Accesses .profile for shell persistence
    crit: suspicious
    confidence: 0.7
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      # Use regex with word boundary to avoid matching .profiled, .profiles, etc.
      regex: "\\.profile\\b"

  - id: etc-profile
    description: Accesses /etc/profile for system-wide shell persistence
    crit: suspicious
    confidence: 0.75
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/profile"

  - id: etc-bashrc
    description: Accesses /etc/bashrc for system-wide shell persistence
    crit: suspicious
    confidence: 0.75
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/bashrc"

  # Zsh persistence
  - id: zshrc
    description: Accesses .zshrc for shell persistence
    crit: suspicious
    confidence: 0.7
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".zshrc"

  - id: zprofile
    description: Accesses .zprofile for shell persistence
    crit: suspicious
    confidence: 0.7
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".zprofile"

  - id: zlogin
    description: Accesses .zlogin for shell persistence
    crit: suspicious
    confidence: 0.75
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".zlogin"

  - id: zlogout
    description: Accesses .zlogout for shell persistence
    crit: suspicious
    confidence: 0.85
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: ".zlogout"

  - id: etc-zshrc
    description: Accesses /etc/zshrc for system-wide shell persistence
    crit: suspicious
    confidence: 0.75
    attack: "T1546.004"
    file_types: [all]
    condition:
      type: string
      exact: "/etc/zshrc"

  # Hardcoded paths (more suspicious)
  - id: hardcoded-profile
    description: Hardcoded path to .profile
    crit: suspicious
    confidence: 0.9
    attack: "T1546.004"
    file_types: [elf]
    condition:
      type: string
      regex: "/[\\w./]{0,32}/\\.profile"

  - id: hardcoded-bashrc
    description: Hardcoded path to .bashrc
    crit: suspicious
    confidence: 0.9
    attack: "T1546.004"
    file_types: [elf]
    condition:
      type: string
      regex: "/[\\w./]{0,32}/\\.bashrc"

  # Composite patterns (moved to traits due to single YARA condition)
  - id: multi-file-access
    description: Multiple shell config file access (persistence)
    crit: suspicious
    confidence: 0.9
    attack: "T1546.004"
    condition:
      type: yara
      source: |
        rule shell_persistence_multi {
          strings:
            $bash_profile = ".bash_profile"
            $bash_login = ".bash_login"
            $profile = ".profile" fullword
            $bashrc = ".bashrc" fullword
            $zshrc = ".zshrc" fullword
            $zprofile = ".zprofile"
            $not_bash = "POSIXLY_CORRECT"
            $not_csh = ".cshrc"
            $not_tcsh = "tcsh" fullword
          condition:
            filesize < 10MB and
            3 of ($bash*, $profile, $bashrc, $zshrc, $zprofile) and
            none of ($not*)
        }

  - id: elf-hardcoded
    description: ELF binary with hardcoded shell config paths
    crit: suspicious
    confidence: 0.95
    attack: "T1546.004"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule elf_shell_persistence {
          strings:
            $profile = /\/[\w\.\/]{0,32}\/\.profile/ fullword
            $bashrc = /\/[\w\.\/]{0,32}\/\.bashrc/ fullword
            $zshrc = /\/[\w\.\/]{0,32}\/\.zshrc/ fullword
          condition:
            uint32(0) == 0x464C457F and
            filesize < 100MB and any of them
        }
