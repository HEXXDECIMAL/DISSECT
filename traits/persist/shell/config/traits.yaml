# Persistence - Shell Configuration Files
# ATT&CK: T1546.004 (Unix Shell Configuration Modification)

traits:
  # Bash persistence
  - id: bash-profile
    description: .bash_profile shell configuration file
    crit: suspicious
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".bash_profile"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft
      inert:
        any:
          - id: feat/library/system-lib-marker

  - id: bashrc
    description: .bashrc shell configuration file
    crit: suspicious
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".bashrc"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft
      inert:
        any:
          - id: feat/library/system-lib-marker

  - id: bash-login
    description: .bash_login shell configuration file
    crit: suspicious
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: ".bash_login"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft

  - id: bash-logout
    description: .bash_logout shell configuration file
    crit: suspicious
    conf: 0.85
    attack: T1546.004
    if:
      type: string
      exact: ".bash_logout"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft

  - id: profile
    description: .profile shell configuration file
    crit: suspicious
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      word: ".profile"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft
      inert:
        any:
          - id: feat/library/system-lib-marker

  - id: etc-profile
    description: /etc/profile system-wide shell configuration
    crit: suspicious
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: "/etc/profile"

  - id: etc-bashrc
    description: /etc/bashrc system-wide shell configuration
    crit: suspicious
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: "/etc/bashrc"

  # Zsh persistence
  - id: zshrc
    description: .zshrc shell configuration file
    crit: suspicious
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".zshrc"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft
      inert:
        any:
          - id: feat/library/system-lib-marker

  - id: zprofile
    description: .zprofile shell configuration file
    crit: suspicious
    conf: 0.7
    attack: T1546.004
    if:
      type: string
      exact: ".zprofile"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft
      inert:
        any:
          - id: feat/library/system-lib-marker

  - id: zlogin
    description: .zlogin shell configuration file
    crit: suspicious
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: ".zlogin"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft

  - id: zlogout
    description: .zlogout shell configuration file
    crit: suspicious
    conf: 0.85
    attack: T1546.004
    if:
      type: string
      exact: ".zlogout"
    downgrade:
      notable:
        any:
          - id: file/signed/apple
          - id: file/signed/microsoft

  - id: etc-zshrc
    description: /etc/zshrc system-wide shell configuration
    crit: suspicious
    conf: 0.75
    attack: T1546.004
    if:
      type: string
      exact: "/etc/zshrc"

  # Hardcoded paths (more suspicious)
  - id: hardcoded-profile
    description: Hardcoded path to .profile file
    crit: suspicious
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.profile'

  - id: hardcoded-bashrc
    description: Hardcoded path to .bashrc file
    crit: suspicious
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.bashrc'

  - id: hardcoded-zshrc
    description: Hardcoded path to .zshrc file
    crit: suspicious
    conf: 0.9
    for: [elf, macho]
    attack: T1546.004
    if:
      type: string
      regex: '/[\w./]{0,32}/\.zshrc'

  # Exclusion patterns
  - id: posixly-correct
    description: POSIXLY_CORRECT environment variable (legitimate bash behavior)
    crit: inert
    conf: 1.0
    if:
      type: string
      exact: "POSIXLY_CORRECT"

  - id: cshrc-file
    description: .cshrc file (C shell, not persistence)
    crit: inert
    conf: 1.0
    if:
      type: string
      exact: ".cshrc"

  - id: tcsh-keyword
    description: tcsh keyword (shell name)
    crit: inert
    conf: 1.0
    if:
      type: string
      word: "tcsh"

composite_rules:
  - id: bash-files
    description: Bash shell configuration files
    crit: suspicious
    conf: 0.7
    attack: T1546.004
    any:
      - id: bash-profile
      - id: bash-login
      - id: profile
      - id: bashrc

  - id: multi-file-access
    description: Multiple shell config files accessed (3+, persistence indicator)
    crit: suspicious
    conf: 0.9
    attack: T1546.004
    count_min: 3
    any:
      - id: bash-profile
      - id: bash-login
      - id: profile
      - id: bashrc
      - id: zshrc
      - id: zprofile
    none:
      - id: posixly-correct
      - id: cshrc-file
      - id: tcsh-keyword

  - id: elf-hardcoded
    description: Binary with hardcoded shell config paths (persistence)
    crit: suspicious
    conf: 0.95
    for: [elf, macho]
    attack: T1546.004
    any:
      - id: hardcoded-profile
      - id: hardcoded-bashrc
      - id: hardcoded-zshrc
