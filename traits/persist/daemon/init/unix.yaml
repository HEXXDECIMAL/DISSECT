# Unix Daemon Persistence
# Detects daemon/background process behavior common in malware
# ATT&CK: T1543 (Create or Modify System Process)

traits:
  # === daemon-fork atomic indicators ===
  - id: fork-symbol
    description: fork syscall symbol
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bfork\\b"

  - id: daemon-symbol
    description: daemon function symbol
    crit: inert
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bdaemon\\b"

  - id: daemon-setsid
    description: "Session creation (setsid) for daemon"
    crit: notable
    confidence: 0.5
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: symbol
      pattern: "\\bsetsid\\b"

  - id: daemon-dev-null
    description: "Redirects I/O to /dev/null (daemon behavior)"
    crit: notable
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: string
      exact: "/dev/null"

  - id: daemon-chdir-root
    description: "Change directory to root (daemon behavior)"
    crit: notable
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bchdir\\b"

  # NOTE: Go runtime uses /proc/self legitimately for memory management
  # and process introspection. Downgraded to inert.
  - id: daemon-proc-self
    description: "Reads /proc/self (process introspection)"
    crit: inert
    confidence: 0.3
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "/proc/self(/|$)"

  # === Signal handling micro-traits (migrated from YARA) ===
  - id: signal-symbol
    description: signal function symbol
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: symbol
      pattern: "\\bsignal\\b"

  - id: sigaction-symbol
    description: sigaction function symbol
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: symbol
      pattern: "\\bsigaction\\b"

  - id: sig-ign-sighup-x64
    description: SIGHUP signal ignore pattern (x86_64)
    crit: notable
    confidence: 0.6
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: hex
      pattern: "BF 01 00 00 00 BE 01 00 00 00"

  - id: sig-ign-sigpipe-x64
    description: SIGPIPE signal ignore pattern (x86_64)
    crit: notable
    confidence: 0.6
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: hex
      pattern: "BF 0D 00 00 00 BE 01 00 00 00"

  # === sigchld-handler atomic indicators ===
  - id: sigchild-underscore
    description: _sigchild string
    crit: inert
    confidence: 0.5
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "_sigchild"

  - id: sigchld-handler-string
    description: sigchld_handler string
    crit: inert
    confidence: 0.5
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "sigchld_handler"

  - id: handle-sigchld-string
    description: handle_sigchld string
    crit: inert
    confidence: 0.5
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      exact: "handle_sigchld"

composite_rules:
  - id: daemon-fork
    description: "Process forking for daemon behavior"
    crit: notable
    confidence: 0.4
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos]
    count: 1
    any:
      - id: fork-symbol
      - id: daemon-symbol

  # Signal function composite
  - id: signal-function
    description: Signal handling function
    crit: inert
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    count: 1
    any:
      - id: signal-symbol
      - id: sigaction-symbol

  # Signal ignore pattern composite
  - id: sig-ign-pattern
    description: Signal ignore byte pattern (x86_64)
    crit: notable
    confidence: 0.6
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    count: 1
    any:
      - id: sig-ign-sighup-x64
      - id: sig-ign-sigpipe-x64

  # Signal ignore for daemon (migrated from YARA)
  - id: signal-ignore-pattern
    description: "Signal handler setup (daemon persistence pattern)"
    crit: inert
    confidence: 0.3
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    all:
      - id: signal-function
      - id: sig-ign-pattern

  - id: sigchld-handler
    description: "Custom SIGCHLD handler (child process reaping)"
    crit: notable
    confidence: 0.6
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    count: 1
    any:
      - id: sigchild-underscore
      - id: sigchld-handler-string
      - id: handle-sigchld-string

  - id: full-daemon
    description: "Full daemon behavior (fork + setsid + /dev/null)"
    crit: suspicious
    confidence: 0.8
    attack: "T1543"
    mbc: "F0006"
    file_types: [elf]
    platforms: [linux]
    all:
      - id: daemon-dev-null
    any:
      - id: daemon-fork
      - id: daemon-setsid

  # NOTE: Since daemon-proc-self is now inert (Go uses /proc/self legitimately),
  # this composite needs additional indicators to be meaningful.
  - id: stealth-daemon
    description: "Stealthy daemon (daemon + proc introspection)"
    crit: notable
    confidence: 0.5
    attack: "T1543"
    mbc: "F0006"
    file_types: [elf]
    platforms: [linux]
    all:
      - id: daemon-proc-self
    any:
      - id: daemon-fork
      - id: daemon-setsid
