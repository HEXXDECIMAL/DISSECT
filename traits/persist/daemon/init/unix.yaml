# Unix Daemon Persistence
# Detects daemon/background process behavior common in malware
# ATT&CK: T1543 (Create or Modify System Process)

composite_rules:
  - id: daemon-fork
    description: "Process forking for daemon behavior"
    criticality: notable
    confidence: 0.4
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bfork\\b|\\bdaemon\\b"

  - id: daemon-setsid
    description: "Session creation (setsid) for daemon"
    criticality: notable
    confidence: 0.5
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    condition:
      type: symbol
      pattern: "\\bsetsid\\b"

  - id: daemon-dev-null
    description: "Redirects I/O to /dev/null (daemon behavior)"
    criticality: notable
    confidence: 0.4
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: string
      exact: "/dev/null"

  - id: daemon-chdir-root
    description: "Change directory to root (daemon behavior)"
    criticality: notable
    confidence: 0.3
    file_types: [elf, macho]
    platforms: [linux, macos]
    condition:
      type: symbol
      pattern: "\\bchdir\\b"

  - id: daemon-proc-self
    description: "Reads /proc/self (process introspection)"
    criticality: notable
    confidence: 0.5
    file_types: [elf]
    platforms: [linux]
    condition:
      type: string
      regex: "/proc/self(/|$)"

  - id: full-daemon
    description: "Full daemon behavior (fork + setsid + /dev/null)"
    criticality: suspicious
    confidence: 0.8
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    requires_all:
      - type: trait
        id: daemon-dev-null
    requires_any:
      - type: trait
        id: daemon-fork
      - type: trait
        id: daemon-setsid

  - id: stealth-daemon
    description: "Stealthy daemon (daemon + proc introspection)"
    criticality: suspicious
    confidence: 0.75
    attack: "T1543"
    file_types: [elf]
    platforms: [linux]
    requires_all:
      - type: trait
        id: daemon-proc-self
    requires_any:
      - type: trait
        id: daemon-fork
      - type: trait
        id: daemon-setsid

  # Signal handling for daemon persistence
  - id: signal-ignore-pattern
    description: "Signal handler setup (daemon persistence pattern)"
    criticality: notable
    confidence: 0.6
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: yara
      source: |
        rule daemon_signal_ignore {
          meta:
            description = "Daemon ignores terminal/pipe signals"
          strings:
            $signal = "signal" fullword
            $sigaction = "sigaction" fullword
            // Signal numbers: SIGPIPE=13, SIGHUP=1
            $sig_ign = { bf 01 00 00 00 be 01 00 00 00 }  // mov edi, 1; mov esi, 1 (SIGHUP, SIG_IGN)
            $sig_ign2 = { bf 0d 00 00 00 be 01 00 00 00 } // mov edi, 13; mov esi, 1 (SIGPIPE, SIG_IGN)
          condition:
            filesize < 10MB and
            ($signal or $sigaction) and
            ($sig_ign or $sig_ign2)
        }

  - id: sigchld-handler
    description: "Custom SIGCHLD handler (child process reaping)"
    criticality: notable
    confidence: 0.6
    attack: "T1543"
    file_types: [elf, macho]
    platforms: [linux, macos, unix]
    condition:
      type: string
      regex: "_sigchild|sigchld_handler|handle_sigchld"
