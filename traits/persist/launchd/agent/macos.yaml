# LaunchDaemon/LaunchAgent Persistence (macOS)
# MBC: B0028 (Scheduled Task/Job)
# ATT&CK: T1543.004

traits:
  - id: launch-agents
    description: LaunchAgents directory (user-level services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      exact: "LaunchAgents"

  - id: launch-daemons
    description: LaunchDaemons directory (system-level services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      exact: "LaunchDaemons"

  - id: launchctl-command
    description: launchctl command (manage launchd services)
    crit: notable
    conf: 0.7
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      word: "launchctl"

  - id: plist-extension
    description: .plist file extension (property list)
    crit: notable
    conf: 0.6
    attack: T1543.004
    if:
      type: string
      exact: ".plist"

  - id: run-at-load
    description: RunAtLoad key (start service at boot)
    crit: notable
    conf: 0.8
    mbc: B0028
    attack: T1543.004
    if:
      type: string
      exact: "RunAtLoad"

composite_rules:
  - id: launchd
    description: macOS launchd persistence (2+ indicators)
    crit: notable
    conf: 0.66
    mbc: B0028
    attack: T1543.004
    count_min: 2
    any:
      - id: launch-agents
      - id: launch-daemons
      - id: launchctl-command
      - id: plist-extension
      - id: run-at-load
