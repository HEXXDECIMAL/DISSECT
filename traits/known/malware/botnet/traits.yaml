# P2P Botnet Detection
# Detects peer-to-peer botnet artifacts and behaviors
# ATT&CK: T1090.003 (Multi-hop Proxy)

defaults:
  for: [elf]

traits:
  # IPStorm botnet
  - id: p2p-botnet/ipstorm
    desc: IPStorm P2P botnet indicators
    crit: suspicious
    conf: 0.95
    attack: "T1090.003"
    if:
      type: yara
      source: |
        rule ipstorm {
          strings:
            $ipfs = "ipfs" ascii nocase
            $libp2p = "libp2p" ascii
            $storm = "storm" ascii nocase
            $dht = "github.com/libp2p/go-libp2p-kad-dht" ascii
            $peer = "peer.ID" ascii
          condition:
            ($ipfs and $libp2p) or ($storm and $dht) or ($libp2p and $peer)
        }

  # Mozi botnet
  - id: p2p-botnet/mozi-artifact
    desc: Mozi botnet identifier string
    crit: notable
    conf: 0.7
    if:
      type: yara
      source: |
        rule mozi_artifact {
          strings:
            $mozi = "mozi" ascii nocase fullword
          condition:
            $mozi
        }

  - id: p2p-botnet/dht-iot-bootstrap
    desc: P2P DHT bootstrapping for IoT
    crit: suspicious
    conf: 0.8
    attack: "T1090.003"
    if:
      type: yara
      source: |
        rule dht_iot_bootstrap {
          strings:
            $dht_node = "dht_node" ascii
            $bootstrap = "bootstrap" ascii
            $netgear = "netgear" ascii nocase
            $huawei = "huawei" ascii nocase
          condition:
            $dht_node and $bootstrap and ($netgear or $huawei)
        }

  # Generic DHT-based botnet - require kademlia specifically or multiple DHT indicators
  # "dht" and "bootstrap" alone are too common in legitimate P2P/networking code
  - id: cap/comm/p2p/dht-network
    desc: Kademlia DHT networking
    crit: inert
    conf: 0.5
    if:
      type: yara
      source: |
        rule dht_botnet {
          strings:
            $kademlia = "kademlia" ascii nocase
            $kad_dht = "kad-dht" ascii
            $libp2p_dht = "go-libp2p-kad-dht" ascii
            $find_node = "find_node" ascii
            $store_value = "store_value" ascii
          condition:
            $kademlia or $kad_dht or $libp2p_dht or ($find_node and $store_value)
        }

  # FritzFrog SSH worm
  - id: p2p-botnet/fritzfrog
    desc: FritzFrog P2P SSH worm
    crit: suspicious
    conf: 0.95
    attack: "T1110"
    if:
      type: yara
      source: |
        rule fritzfrog {
          strings:
            $fritzfrog = "fritzfrog" ascii nocase
            $p2p_ssh = "P2P" ascii
            $ssh_brute = "authorized_keys" ascii
            $ifrit = "ifrit" ascii
          condition:
            $fritzfrog or $ifrit or ($p2p_ssh and $ssh_brute)
        }
