# Mozi P2P Botnet Detection
# ATT&CK: T1071.001 (Application Layer Protocol: Web Protocols)
# MBC: B0030 (Remote Access)

defaults:
  for: [elf, macho, so, dylib]

traits:
  # Mozi DHT-based communication
  - id: botnet/mozi/dht-p2p
    desc: Mozi DHT-based P2P communication patterns
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1071"
    if:
      type: yara
      source: |
        rule mozi_dht {
          strings:
            $dht1 = "get_peers" ascii
            $dht2 = "announce_peer" ascii
            $dht3 = "find_node" ascii
            $dht4 = "info_hash" ascii
            $bencode1 = "d1:" ascii
            $bencode2 = "e1:" ascii
            // Mozi magic
            $magic1 = "Mozi" fullword
          condition:
            $magic1 or (any of ($dht*) and $magic1) or (3 of ($dht*) and any of ($bencode*))
        }

  # Mozi XOR encryption
  - id: botnet/mozi/xor-config
    desc: Mozi XOR encrypted configuration
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1027"
    if:
      type: yara
      source: |
        rule mozi_xor {
          strings:
            // XOR decryption loop patterns
            $xor1 = { 31 ?? 88 ?? 4? 83 ?? ?? 7? }
            $xor2 = { 30 ?? 40 3? ?? 7? }
            // Config markers
            $cfg1 = "[ss]" ascii
            $cfg2 = "[cpu]" ascii
            $cfg3 = "[count]" ascii
            $cfg4 = "[dk]" ascii
          condition:
            any of ($xor*) and any of ($cfg*)
        }

  # Mozi Mirai-derived functionality
  - id: botnet/mozi/mirai-derived
    desc: Mozi Mirai-derived attack capabilities
    crit: suspicious
    conf: 0.85
    mbc: "B0030"
    attack: "T1498"
    if:
      type: yara
      source: |
        rule mozi_mirai {
          strings:
            $attack1 = "udp_flood" ascii
            $attack2 = "tcp_flood" ascii
            $attack3 = "http_flood" ascii
            $attack4 = "syn_flood" ascii
            $scan1 = "scanner" ascii
            $scan2 = "telnet" ascii
            // Go runtime markers to exclude
            $go1 = "runtime.goexit" ascii
          condition:
            not $go1 and (3 of ($attack*) or (any of ($scan*) and 2 of ($attack*)))
        }

composite_rules:
  # Full Mozi detection
  - id: botnet/mozi/detected
    desc: Mozi botnet detected
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071"
    needs: 2
    any:
      - id: botnet/mozi/dht-p2p
      - id: botnet/mozi/xor-config
      - id: botnet/mozi/mirai-derived
