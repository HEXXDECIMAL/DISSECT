# Malware Family - Mirai IoT Botnet
# Reference: https://www.cloudflare.com/learning/ddos/glossary/mirai-botnet/
# ATT&CK: T1583.005 (Botnet)

traits:
  # === Behavioral Indicators ===
  # Individual strings are suspicious, not hostile - detection requires combination

  - id: cnc-connect
    desc: Mirai C2 connection function signature
    crit: suspicious
    conf: 0.8
    attack: "T1071"
    for: [elf]
    if:
      type: string
      substr: "connectToCNC"

  - id: scanner-cookie
    desc: Mirai scanner module reference
    crit: suspicious
    conf: 0.75
    attack: "T1046"
    for: [elf]
    if:
      type: string
      substr: "__scan_cookie.c"

  - id: anti-reinfect
    desc: Mirai anti-reinfection marker
    crit: suspicious
    conf: 0.8
    attack: "T1480"
    for: [elf]
    if:
      type: string
      substr: "been_there_done_that"

  - id: dvr-helper
    desc: Mirai DVR exploitation helper function
    crit: suspicious
    conf: 0.8
    attack: "T1190"
    for: [elf]
    if:
      type: string
      substr: "dvrHelper"

  - id: read-module
    desc: Mirai _READ.c module reference
    crit: suspicious
    conf: 0.7
    for: [elf]
    if:
      type: string
      substr: "_READ.c"

  - id: write-module
    desc: Mirai _WRITE.c module reference
    crit: suspicious
    conf: 0.7
    for: [elf]
    if:
      type: string
      substr: "_WRITE.c"

  - id: killer-module
    desc: Mirai killer module initialization
    crit: suspicious
    conf: 0.75
    attack: "T1489"
    for: [elf]
    if:
      type: string
      substr: "killer_init"

  - id: attack-module
    desc: Mirai attack module initialization
    crit: suspicious
    conf: 0.75
    attack: "T1498"
    for: [elf]
    if:
      type: string
      substr: "attack_init"

  # === Proc filesystem indicators ===
  # Note: /proc/%d is too generic - many Linux programs use this pattern.
  # It's only meaningful when combined with other Mirai indicators.
  # Moved to cap/ since it's a capability, not a Mirai-specific signature.
  - id: proc-format
    desc: Mirai proc format string
    crit: inert
    conf: 0.3
    for: [elf]
    # Size constraint: Real Mirai samples are small (30KB-200KB).
    # Larger binaries commonly have /proc/%d for legitimate process monitoring.
    size_max: 200000
    if:
      type: string
      substr: "/proc/%d"

  # Removed proc-cpuinfo duplicate - use cap/fs/proc/system/linux::system-cpuinfo

  - id: http-1-0
    desc: HTTP/1.0 protocol string
    crit: inert
    conf: 0.5
    for: [elf]
    if:
      type: string
      substr: "HTTP/1.0"

composite_rules:
  # Main Mirai detection - requires 6 of 12 indicators plus size constraints
  - id: detected
    desc: Mirai IoT botnet detected
    crit: suspicious
    conf: 0.95
    attack: "T1583.005"
    mbc: "OB0004"
    for: [elf]
    size_min: 30000
    size_max: 200000
    needs: 6
    any:
      - id: proc-format
      - id: proc-cpuinfo
      - id: obj/exec/fileless/memory::proc-self-fd
      - id: cnc-connect
      - id: scanner-cookie
      - id: anti-reinfect
      - id: read-module
      - id: write-module
      - id: killer-module
      - id: attack-module

  # Mirai DVR helper variant - requires brand + dvr + HTTP
  - id: dvr-helper-detected
    desc: Mirai DVR exploitation helper variant
    crit: suspicious
    conf: 0.95
    attack: "T1190"
    mbc: "OB0004"
    for: [elf]
    all:
      - id: known/malware/botnet/mirai-variant::mirai-brand-mirai
      - id: dvr-helper
      - id: http-1-0

  # Behavioral variant detection (no brand string required)
  - id: variant
    desc: Mirai botnet variant (behavioral match)
    crit: suspicious
    conf: 0.9
    attack: "T1583.005"
    mbc: "OB0004"
    for: [elf]
    all:
      - id: cnc-connect
    needs: 2
    any:
      - id: scanner-cookie
      - id: anti-reinfect
      - id: killer-module
      - id: attack-module
