# Mining pool connection detection
# ATT&CK: T1496 (Resource Hijacking)

traits:
  - id: cryptominer/pool/port-3333
    desc: "Mining pool port 3333"
    crit: notable
    conf: 0.7
    attack: "T1496"
    if:
      type: string
      regex: ":\\s*3333\\b"

  - id: cryptominer/pool/port-14444
    desc: "Mining pool port 14444 (XMR"
    crit: suspicious
    conf: 0.75
    attack: "T1496"
    if:
      type: string
      regex: ":\\s*14444\\b"

  - id: cryptominer/pool/domain
    desc: "Mining pool domain pattern"
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    if:
      type: string
      # Require actual domain patterns, not Rust library paths like "client/pool.rs"
      # Match: pool.example.com:3333, xmr.pool.io:443, etc.
      # Exclude: /pool.rs, pool.rs:123 (source file references)
      regex: "\\b(pool|mining|mine|xmr|monero)\\.[a-z]{2,}.{0,100}:\\d+"
      exclude_patterns:
        - "\\.rs:"
        - "/pool\\."
        - "pool\\.rs"

  # === Stratum protocol atomic indicators ===
  - id: cryptominer/pool/stratum-tcp
    desc: "Stratum TCP mining protocol"
    crit: notable
    conf: 0.8
    attack: "T1496"
    if:
      type: string
      substr: "stratum+tcp://"

  - id: cryptominer/pool/stratum-ssl
    desc: "Stratum SSL mining protocol"
    crit: notable
    conf: 0.8
    attack: "T1496"
    if:
      type: string
      substr: "stratum+ssl://"

composite_rules:
  # Stratum protocol composite
  - id: cryptominer/pool/stratum
    desc: "Stratum mining protocol"
    crit: suspicious
    conf: 0.85
    attack: "T1496"
    needs: 1
    any:
      - id: cryptominer/pool/stratum-tcp
      - id: cryptominer/pool/stratum-ssl
