# XMRig cryptocurrency miner detection
# ATT&CK: T1496 (Resource Hijacking)

traits:
  # === XMRig user flag atomic indicators ===
  - id: cryptominer/xmrig/user-flag-u
    description: "XMRig -u flag"
    crit: notable
    confidence: 0.7
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      exact: "'-u'"

  - id: cryptominer/xmrig/user-flag-user
    description: "XMRig -user flag"
    crit: notable
    confidence: 0.7
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      exact: "'-user'"

  # === XMRig pool flag atomic indicators ===
  - id: cryptominer/xmrig/pool-flag-o
    description: "XMRig -o flag"
    crit: notable
    confidence: 0.7
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      exact: "'-o'"

  - id: cryptominer/xmrig/pool-flag-url
    description: "XMRig --url flag"
    crit: notable
    confidence: 0.7
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      exact: "'--url'"

  # === Mining port atomic indicators ===
  - id: cryptominer/xmrig/port-3333
    description: "Mining port 3333"
    crit: inert
    confidence: 0.6
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      regex: ":\\d*3333\\b"

  - id: cryptominer/xmrig/port-8080
    description: "Mining port 8080"
    crit: inert
    confidence: 0.5
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      regex: ":\\d*8080\\b"

  - id: cryptominer/xmrig/port-14444
    description: "Mining port 14444"
    crit: inert
    confidence: 0.6
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      regex: ":\\d*14444\\b"

  - id: cryptominer/xmrig/port-5555
    description: "Mining port 5555"
    crit: inert
    confidence: 0.6
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      regex: ":\\d*5555\\b"

  - id: cryptominer/xmrig/port-7777
    description: "Mining port 7777"
    crit: inert
    confidence: 0.6
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      regex: ":\\d*7777\\b"

  - id: cryptominer/xmrig/port-45700
    description: "Mining port 45700"
    crit: inert
    confidence: 0.6
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    condition:
      type: string
      regex: ":\\d*45700\\b"

composite_rules:
  # XMRig user flag composite
  - id: cryptominer/xmrig/user-flag
    description: "XMRig -u flag (wallet/user)"
    crit: suspicious
    confidence: 0.8
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    count_min: 1
    any:
      - id: cryptominer/xmrig/user-flag-u
      - id: cryptominer/xmrig/user-flag-user

  # XMRig pool flag composite
  - id: cryptominer/xmrig/pool-flag
    description: "XMRig -o flag (pool address)"
    crit: suspicious
    confidence: 0.8
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    count_min: 1
    any:
      - id: cryptominer/xmrig/pool-flag-o
      - id: cryptominer/xmrig/pool-flag-url

  # Mining port composite
  - id: cryptominer/xmrig/mining-port
    description: "Common cryptocurrency mining pool ports"
    crit: notable
    confidence: 0.7
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    count_min: 1
    any:
      - id: cryptominer/xmrig/port-3333
      - id: cryptominer/xmrig/port-8080
      - id: cryptominer/xmrig/port-14444
      - id: cryptominer/xmrig/port-5555
      - id: cryptominer/xmrig/port-7777
      - id: cryptominer/xmrig/port-45700

  - id: cryptominer/xmrig/invocation
    description: "XMRig-style miner invocation"
    confidence: 0.95
    crit: suspicious
    mbc: "B0036"
    attack: "T1496"
    file_types: [elf, macho, pe, so, dylib, dll, shell]
    count_min: 2
    any:
      - id: cryptominer/xmrig/user-flag
      - id: cryptominer/xmrig/pool-flag
      - id: cryptominer/xmrig/mining-port
