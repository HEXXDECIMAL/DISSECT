# XMRig cryptocurrency miner detection
# ATT&CK: T1496 (Resource Hijacking)

traits:
  # === XMRig user flag atomic indicators ===
  # NOTE: '-u' alone is too generic (matches any tool's -u flag in shell completion code)
  # For XMRig detection, we need more context: the flag combined with mining-related patterns
  - id: user-flag-u
    desc: "XMRig -u flag with wallet context"
    crit: notable
    conf: 0.7
    attack: "T1496"
    for: [shell]
    if:
      type: string
      # Match -u with a wallet-like argument (xmrig -u WALLET)
      regex: "-u\\s+[A-Za-z0-9]{40,}"

  - id: user-flag-user
    desc: "XMRig --user flag"
    crit: notable
    conf: 0.7
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      substr: "'--user'"

  # === XMRig pool flag atomic indicators ===
  - id: pool-flag-o
    desc: "XMRig -o flag"
    crit: notable
    conf: 0.7
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: "\\s-o\\s+[^-\\s][^\\s]*:\\d+"

  - id: pool-flag-url
    desc: "XMRig --url flag"
    crit: notable
    conf: 0.7
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      substr: "'--url'"

  # === Mining port atomic indicators ===
  - id: xmrig-port-3333
    desc: "Mining port 3333"
    crit: inert
    conf: 0.6
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: ":\\d*3333\\b"

  - id: port-8080
    desc: "Mining port 8080"
    crit: inert
    conf: 0.5
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: ":\\d*8080\\b"

  - id: xmrig-port-14444
    desc: "Mining port 14444"
    crit: inert
    conf: 0.6
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: ":\\d*14444\\b"

  - id: port-5555
    desc: "Mining port 5555"
    crit: inert
    conf: 0.6
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: ":\\d*5555\\b"

  - id: port-7777
    desc: "Mining port 7777"
    crit: inert
    conf: 0.6
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: ":\\d*7777\\b"

  - id: port-45700
    desc: "Mining port 45700"
    crit: inert
    conf: 0.6
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    if:
      type: string
      regex: ":\\d*45700\\b"

composite_rules:
  # XMRig user flag composite
  - id: user-flag
    desc: "XMRig -u flag (wallet/user)"
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: user-flag-u
      - id: user-flag-user

  # XMRig pool flag composite
  - id: pool-flag
    desc: "XMRig -o flag (pool address)"
    crit: suspicious
    conf: 0.8
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: pool-flag-o
      - id: pool-flag-url

  # Mining port composite
  - id: mining-port
    desc: "Common cryptocurrency mining pool ports"
    crit: notable
    conf: 0.7
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    any:
      - id: xmrig-port-3333
      - id: port-8080
      - id: xmrig-port-14444
      - id: port-5555
      - id: port-7777
      - id: port-45700

  - id: invocation
    desc: "XMRig-style miner invocation"
    conf: 0.95
    crit: suspicious
    mbc: "B0036"
    attack: "T1496"
    for: [elf, macho, pe, so, dylib, dll, shell]
    needs: 2
    any:
      - id: user-flag
      - id: pool-flag
      - id: mining-port
