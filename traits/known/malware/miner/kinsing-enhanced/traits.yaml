# Kinsing Cryptocurrency Miner - Enhanced Detection
# Detects sophisticated Kinsing botnet with persistent backdoor
# Includes shell command patterns, persistence, and credential theft

traits:
  # === Kinsing/XMRig Core Identification ===
  - id: kinsing-identifier
    desc: Kinsing process identifier
    crit: notable
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "kinsing"
        - substr: "kdevtmpfsi"
        - substr: "kworker"
    notes: "Kinsing botnet identifier"
    attack: "T1496"

  - id: xmrig-miner-core
    desc: XMRig core miner reference
    crit: notable
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "xmrig"
        - substr: "xmrig-proxy"
    notes: "XMRig cryptocurrency miner"
    attack: "T1496"

  # === SSH Backdoor Installation ===
  - id: sshd-config-modification
    desc: SSH daemon configuration modification
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "sshd_config"
        - substr: "PermitRootLogin"
    notes: "SSH daemon backdoor installation"
    attack: "T1098.004"

  - id: authorized-keys-harvesting
    desc: SSH authorized_keys harvesting
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "authorized_keys"
        - substr: "/.ssh/"
    notes: "SSH credential file access/modification"
    attack: "T1555.003"

  # === User Account Creation ===
  - id: backdoor-user-creation
    desc: Backdoor user account creation
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "useradd"
        - substr: "adduser"
        - substr: "/bin/bash"
    notes: "Backdoor user account with bash shell"
    attack: "T1136.001"

  - id: privilege-escalation-setup
    desc: Sudoers privilege escalation
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "sudoers"
        - substr: "usermod -aG wheel"
        - substr: "usermod -aG sudo"
    notes: "Privilege escalation installation"
    attack: "T1548.004"

  # === Persistence Mechanisms ===
  - id: systemd-service-persistence
    desc: Systemd service persistence
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "systemctl"
        - substr: "systemctl enable"
        - substr: "/etc/systemd/system/"
    notes: "Systemd service for persistence"
    attack: "T1547.002"

  - id: cron-persistence
    desc: Cron job persistence
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "crontab"
        - substr: "/var/spool/cron"
        - substr: "/etc/cron"
    notes: "Cron job for persistence"
    attack: "T1053.006"

  - id: shell-rc-persistence
    desc: Shell rc file persistence
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: ".bashrc"
        - substr: ".profile"
        - substr: ".zshrc"
    notes: "Shell initialization file modification for persistence"
    attack: "T1547.013"

  # === Anti-Forensics ===
  - id: evidence-removal
    desc: Evidence removal patterns
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "sed -i"
        - substr: "(deleted)"
        - substr: "pkill -9"
        - substr: "rm -f"
    notes: "Evidence removal and cleanup"
    attack: "T1070.003"

  - id: competing-malware-kill
    desc: Competing malware termination
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "mirai"
        - substr: "watchdog"
        - substr: "xmrig"
        - substr: "grep deleted"
    notes: "Kill competing malware (botnet exclusivity)"
    attack: "T1070.003"

  # === Credential Theft ===
  - id: shadow-file-access
    desc: /etc/shadow credential file access
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "/etc/shadow"
        - substr: "/etc/passwd"
    notes: "System credential file access"
    attack: "T1555"

  - id: ssh-key-harvesting
    desc: SSH private key harvesting
    crit: suspicious
    conf: 0.85
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "id_rsa"
        - substr: "known_hosts"
    notes: "SSH credential harvesting"
    attack: "T1555.003"

  # === Turkish Language Indicators ===
  - id: turkish-language-text
    desc: Turkish language in binary
    crit: inert
    conf: 0.7
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "kuruluyor"
        - substr: "yetkisi"
        - substr: "grubuna"
        - substr: "Systemd ve cron temizleniyor"
    notes: "Turkish language text (attacker origin indicator)"

  # === Firewall Configuration ===
  - id: firewall-tool-abuse
    desc: Firewall configuration abuse
    crit: suspicious
    conf: 0.8
    for: [elf, shell]
    if:
      type: string
      any:
        - substr: "firewall-cmd"
        - substr: "ufw"
        - substr: "--add-port"
    notes: "Firewall tool abuse for SSH access"
    attack: "T1562.004"

composite_rules:
  # === Individual attack vector composites ===
  - id: kinsing-mining-capability
    desc: Kinsing cryptocurrency mining capability
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1496"
    notes: |
      XMRig cryptocurrency mining capability detected.
      Indicates:
      - Monero mining operation
      - Resource hijacking
    count_min: 2
    any:
      - id: kinsing-identifier
      - id: xmrig-miner-core

  - id: kinsing-ssh-backdoor
    desc: Kinsing SSH backdoor installation
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1098.004"
    notes: |
      SSH backdoor installation detected.
      Indicates:
      - Persistent SSH access
      - Remote attacker access
    all:
      - id: sshd-config-modification
      - id: authorized-keys-harvesting

  - id: kinsing-account-escalation
    desc: Kinsing account with privilege escalation
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1136.001"
    notes: |
      Backdoor account with privilege escalation.
      Indicates:
      - Persistent privileged access
      - Full system compromise
    all:
      - id: backdoor-user-creation
      - id: privilege-escalation-setup

  - id: kinsing-persistence-suite
    desc: Kinsing multiple persistence mechanisms
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1547"
    notes: |
      Multiple persistence mechanisms deployed.
      Indicates:
      - Sophisticated persistence setup
      - Multiple survival vectors
    count_min: 2
    any:
      - id: systemd-service-persistence
      - id: cron-persistence
      - id: shell-rc-persistence

  - id: kinsing-forensics-evasion
    desc: Kinsing forensics evasion patterns
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1070.003"
    notes: |
      Anti-forensics and evidence removal.
      Indicates:
      - Forensics-aware malware
      - Cover-up operations
    count_min: 2
    any:
      - id: evidence-removal
      - id: competing-malware-kill

  - id: kinsing-credential-theft
    desc: Kinsing credential theft
    crit: suspicious
    conf: 0.9
    for: [elf, shell]
    attack: "T1555"
    notes: |
      System credential theft patterns.
      Indicates:
      - Credential exfiltration
      - Lateral movement preparation
    count_min: 2
    any:
      - id: shadow-file-access
      - id: ssh-key-harvesting

  # === Complete attack chain composites ===
  - id: kinsing-complete-infection
    desc: Complete Kinsing infection pattern
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    attack: "T1496"
    mbc: "B0014"
    notes: |
      COMPLETE KINSING BOTNET INFECTION PATTERN DETECTED.

      Combines all major attack vectors:
      - XMRig cryptocurrency mining
      - SSH backdoor installation
      - Persistent backdoor account with privileges
      - Multiple persistence mechanisms
      - Anti-forensics and evidence removal
      - Credential theft

      This indicates:
      - Sophisticated, professional malware
      - Complete system compromise
      - Resource hijacking + persistent attacker control
      - Ransomware deployment capability
    count_min: 5
    any:
      - id: kinsing-mining-capability
      - id: kinsing-ssh-backdoor
      - id: kinsing-account-escalation
      - id: kinsing-persistence-suite
      - id: kinsing-forensics-evasion
      - id: kinsing-credential-theft

  - id: kinsing-with-language-origin
    desc: Kinsing botnet with language attribution
    crit: hostile
    conf: 0.95
    for: [elf, shell]
    notes: |
      Kinsing botnet with Turkish language indicators.
      Suggests Turkish-speaking threat actor.
    all:
      - id: kinsing-complete-infection
      - id: turkish-language-text

