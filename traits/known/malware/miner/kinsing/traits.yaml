# Kinsing Cryptominer Detection
# ATT&CK: T1496 (Resource Hijacking)
# MBC: B0030 (Remote Access)

traits:
  # === Kinsing Name Patterns ===
  - id: kinsing-lower
    desc: kinsing string (lowercase)
    crit: inert
    conf: 0.8
    for: [elf, go, shell]
    if:
      type: string
      word: "kinsing"

  - id: kinsing-title
    desc: Kinsing string (title case)
    crit: inert
    conf: 0.8
    for: [elf, go, shell]
    if:
      type: string
      word: "Kinsing"

  - id: kinsing-upper
    desc: KINSING string (uppercase)
    crit: inert
    conf: 0.8
    for: [elf, go, shell]
    if:
      type: string
      word: "KINSING"

  - id: kdevtmpfsi
    desc: kdevtmpfsi disguised process name
    crit: inert
    conf: 0.85
    for: [elf, go, shell]
    if:
      type: string
      substr: "kdevtmpfsi"

  # === Go Module Paths ===
  - id: kinsing-main-path
    desc: kinsing/main Go module path
    crit: inert
    conf: 0.85
    for: [elf, go]
    if:
      type: string
      substr: "kinsing/main"

  - id: main-kinsing-symbol
    desc: main.Kinsing Go symbol
    crit: inert
    conf: 0.85
    for: [elf, go]
    if:
      type: symbol
      exact: "main.Kinsing"

  # === Container Escape Patterns ===
  - id: docker-sock-path
    desc: /var/run/docker.sock Docker socket
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: string
      substr: "/var/run/docker.sock"

  # Removed dockerenv-path duplicate - use cap/os/container/runtime::dockerenv

  # === Kubernetes Patterns ===
  # Removed kubernetes-service-var duplicate - use cap/os/container/runtime::service-env
  # Removed k8s-secrets-path duplicate - use cap/os/container/runtime::secrets-path

  # === Cloud Metadata Patterns ===
  - id: gcp-metadata-domain
    desc: metadata.google GCP metadata domain
    crit: inert
    conf: 0.7
    for: [elf, go, shell]
    if:
      type: string
      substr: "metadata.google"

  # === SSH Spreading Patterns ===
  - id: ssh-known-hosts-path
    desc: /.ssh/known_hosts file path
    crit: inert
    conf: 0.7
    for: [elf, go, shell]
    if:
      type: string
      substr: "/.ssh/known_hosts"

  - id: ssh-id-rsa-path
    desc: /.ssh/id_rsa private key path
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: string
      substr: "/.ssh/id_rsa"

  # === Mass Scanning Tools ===
  # Removed masscan-tool duplicate - use known/tools/offensive::masscan-ref

  - id: pnscan-tool
    desc: pnscan network scanner
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: string
      word: "pnscan"

  # === Redis Exploitation ===
  - id: redis-cli-tool
    desc: redis-cli command-line tool
    crit: inert
    conf: 0.7
    for: [elf, go, shell]
    if:
      type: string
      word: "redis-cli"

  - id: slaveof-command
    desc: SLAVEOF Redis replication command
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: string
      substr: "SLAVEOF"

  # === XMRig Mining Patterns ===
  # Note: xmrig case variants already defined in parent traits file
  - id: stratum-plus
    desc: stratum+ pool connection prefix
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: raw
      substr: "stratum+"

  - id: stratum-protocol
    desc: Stratum mining protocol indicator
    crit: notable
    conf: 0.8
    for: [elf, go, shell]
    if:
      type: raw
      regex: 'stratum[+]tcp'

  - id: monero-indicator-obfuscated
    desc: Monero (XMR) indicator (obfuscated)
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: raw
      substr: "PXxmr"

  - id: ethereum-indicator-obfuscated
    desc: Ethereum (ETH) indicator (obfuscated)
    crit: notable
    conf: 0.7
    for: [elf]
    if:
      type: raw
      substr: "WEth"

  - id: pool-minexmr
    desc: pool.minexmr mining pool domain
    crit: inert
    conf: 0.8
    for: [elf, go, shell]
    if:
      type: string
      substr: "pool.minexmr"

  - id: moneroocean-string
    desc: moneroocean mining pool
    crit: inert
    conf: 0.8
    for: [elf, go, shell]
    if:
      type: string
      word: "moneroocean"

  # === XMRig Config Options ===
  - id: donate-level
    desc: donate-level XMRig config option
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: string
      substr: "donate-level"

  - id: cpu-priority
    desc: cpu-priority XMRig config option
    crit: inert
    conf: 0.75
    for: [elf, go, shell]
    if:
      type: string
      substr: "cpu-priority"

composite_rules:
  # === Helper composites ===
  - id: kinsing-keyword
    desc: Kinsing keyword (case variants)
    for: [elf, go, shell]
    any:
      - id: kinsing-lower
      - id: kinsing-title
      - id: kinsing-upper

  - id: kinsing-names
    desc: Kinsing name patterns
    for: [elf, go, shell]
    any:
      - id: kinsing-keyword
      - id: kdevtmpfsi

  - id: kinsing-go-paths
    desc: Kinsing Go module paths
    for: [elf, go]
    any:
      - id: kinsing-main-path
      - id: main-kinsing-symbol

  - id: container-escape
    desc: Container escape indicators
    for: [elf, go, shell]
    any:
      - id: docker-sock-path
      - id: cap/os/container/runtime::dockerenv

  - id: kubernetes-indicators
    desc: Kubernetes environment indicators
    for: [elf, go, shell]
    any:
      - id: cap/os/container/runtime::service-env
      - id: cap/os/container/runtime::secrets-path

  - id: cloud-metadata
    desc: Cloud metadata service access
    for: [elf, go, shell]
    any:
      - id: obj/creds/cloud/token::aws-imds-ip
      - id: gcp-metadata-domain

  - id: ssh-files
    desc: SSH credential file access
    for: [elf, go, shell]
    any:
      - id: ssh-known-hosts-path
      - id: ssh-id-rsa-path

  - id: network-scanners
    desc: Network scanning tools
    for: [elf, go, shell]
    any:
      - id: known/tools/offensive::masscan-ref
      - id: pnscan-tool

  - id: redis-exploitation
    desc: Redis exploitation patterns
    for: [elf, go, shell]
    any:
      - id: redis-cli-tool
      - id: slaveof-command

  - id: xmrig-patterns
    desc: XMRig mining patterns
    for: [elf, go, shell]
    any:
      - id: stratum-plus
      - id: stratum-protocol
      - id: pool-minexmr
      - id: monero-indicator-obfuscated
      - id: ethereum-indicator-obfuscated
      - id: moneroocean-string

  - id: xmrig-config
    desc: XMRig configuration options
    for: [elf, go, shell]
    any:
      - id: donate-level
      - id: cpu-priority

  # === Helper composites ===
  - id: kinsing-with-paths
    desc: Kinsing name with Go paths
    all:
      - id: kinsing-names
      - id: kinsing-go-paths

  - id: kinsing-with-kdev
    desc: Kinsing with kdevtmpfsi
    all:
      - id: kinsing-lower
      - id: kdevtmpfsi

  # === Migrated from YARA ===
  - id: kinsing-generic
    desc: Kinsing cryptominer patterns
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    for: [elf, go]
    any:
      - id: kinsing-with-paths
      - id: kinsing-go-paths
        needs: 2
      - id: kinsing-with-kdev

  - id: container-indicators
    desc: Container/K8s/Cloud indicators
    any:
      - id: container-escape
      - id: kubernetes-indicators
      - id: cloud-metadata

  - id: kinsing-container-combo
    desc: Kinsing with container indicators
    all:
      - id: kinsing-keyword
      - id: container-indicators

  - id: full-container-suite
    desc: Container escape with K8s and
    all:
      - id: container-escape
      - id: kubernetes-indicators
      - id: cloud-metadata

  - id: container
    desc: Kinsing container/K8s targeting
    crit: suspicious
    conf: 0.85
    attack: "T1610"
    for: [elf, go, shell]
    any:
      - id: kinsing-container-combo
      - id: full-container-suite

  - id: lateral-movement-methods
    desc: Lateral movement methods
    any:
      - id: ssh-files
      - id: network-scanners
      - id: redis-exploitation

  - id: kinsing-lateral
    desc: Kinsing with lateral movement
    all:
      - id: kinsing-keyword
      - id: lateral-movement-methods

  - id: scanner-or-redis
    desc: Network scanner or Redis exploitation
    any:
      - id: network-scanners
      - id: redis-exploitation

  - id: ssh-with-exploit
    desc: SSH files with exploitation methods
    all:
      - id: ssh-files
        needs: 2
      - id: scanner-or-redis

  - id: spreading
    desc: Kinsing lateral movement
    crit: suspicious
    conf: 0.85
    attack: "T1021"
    for: [elf, go, shell]
    any:
      - id: kinsing-lateral
      - id: ssh-with-exploit

  - id: xmrig-indicators
    desc: XMRig patterns or config
    any:
      - id: xmrig-patterns
      - id: xmrig-config

  - id: kinsing-with-xmrig
    desc: Kinsing with XMRig indicators
    all:
      - id: kinsing-keyword
      - id: xmrig-indicators

  - id: xmrig-full
    desc: XMRig patterns and config
    all:
      - id: xmrig-patterns
      - id: xmrig-config

  - id: mining
    desc: Kinsing XMRig deployment
    crit: suspicious
    conf: 0.9
    attack: "T1496"
    for: [elf, go, shell]
    any:
      - id: kinsing-with-xmrig
      - id: xmrig-full

  - id: kinsing-behavioral-suite
    desc: Complete Kinsing behavioral patterns
    all:
      - id: kinsing-names
      - id: mining
    any:
      - id: kinsing-generic
      - id: container
      - id: spreading
      - id: known/malware/miner/kinsing-enhanced::kinsing-forensics-evasion
      - id: known/malware/miner/kinsing-enhanced::kinsing-persistence-suite
      - id: obj/persist/account/create::user-creation-ok
      - id: obj/persist/account/create::skel-profile-setup

  - id: kinsing-detected
    desc: Kinsing cryptominer detected
    crit: hostile
    conf: 0.95
    mbc: "B0014"
    attack: "T1496"
    for: [elf, go]
    needs: 4
    all:
      - id: kinsing-names
      - id: mining
    any:
      - id: kinsing-behavioral-suite
      - id: kinsing-generic
      - id: container
      - id: spreading
      - id: known/malware/miner/kinsing-enhanced::kinsing-forensics-evasion
      - id: known/malware/miner/kinsing-enhanced::kinsing-persistence-suite
      - id: obj/persist/account/create::user-creation-ok
      - id: obj/persist/account/create::skel-profile-setup
