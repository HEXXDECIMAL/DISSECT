# Merlin C2 Agent Detection
# Go-based post-exploitation agent
# Reference: https://github.com/Ne0nd0g/merlin

traits:
  - id: c2-framework/merlin/github-ref
    desc: Merlin GitHub import path
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    if:
      type: string
      exact: "github.com/Ne0nd0g/merlin"

  # === Merlin agent atomic indicators ===
  - id: c2-framework/merlin/agent-dash
    desc: merlin-agent reference
    crit: notable
    conf: 0.85
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    if:
      type: string
      exact: "merlin-agent"

  - id: c2-framework/merlin/agent-camel
    desc: MerlinAgent reference
    crit: notable
    conf: 0.85
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    if:
      type: string
      exact: "MerlinAgent"

  - id: c2-framework/merlin/pkg-messages
    desc: Merlin package messages reference
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    if:
      type: string
      exact: "merlin/pkg/messages"

  - id: c2-framework/merlin/execute-commands
    desc: Merlin shellcode/assembly execution
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1059"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    if:
      type: yara
      source: |
        rule merlin_execute {
          strings:
            $execute_shellcode = "execute-shellcode" ascii
            $execute_assembly = "execute-assembly" ascii
          condition:
            $execute_shellcode and $execute_assembly
        }

  - id: c2-framework/merlin/http2
    desc: Merlin HTTP/2 C2 communication
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    if:
      type: yara
      source: |
        rule merlin_http2 {
          strings:
            $h2 = "HTTP/2" ascii
            $merlin = "merlin" ascii nocase
            $proto = "application/octet-stream" ascii
            $jwt = "eyJ" ascii
          condition:
            $h2 and $merlin and ($proto or $jwt)
        }

composite_rules:
  # Merlin agent ref composite
  - id: c2-framework/merlin/agent-ref
    desc: Merlin agent reference
    crit: suspicious
    conf: 0.95
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    count_min: 1
    any:
      - id: c2-framework/merlin/agent-dash
      - id: c2-framework/merlin/agent-camel

  - id: c2-framework/merlin/detected
    desc: Merlin C2 detected
    crit: suspicious
    conf: 0.95
    family: true
    reference: "https://github.com/Ne0nd0g/merlin"
    mbc: "B0030"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll, go]
    count_min: 2
    any:
      - id: c2-framework/merlin/github-ref
      - id: c2-framework/merlin/agent-ref
      - id: c2-framework/merlin/pkg-messages
      - id: c2-framework/merlin/execute-commands
      - id: c2-framework/merlin/http2
