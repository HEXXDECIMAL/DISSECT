# Cobalt Strike / VermilionStrike Detection
# Commercial adversary simulation / C2 framework commonly abused by threat actors
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: C0001 (HTTP Communication), B0030 (C2 Communication)

traits:
  - id: c2-framework/cobalt-strike/config-block
    desc: Cobalt Strike beacon configuration block
    crit: suspicious
    conf: 0.9
    mbc: "C0001"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: yara
      source: |
        rule cobaltstrike_config {
          strings:
            $cfg1 = { 00 01 00 01 00 02 00 01 00 02 00 }
            $cfg2 = { 00 02 00 01 00 02 00 02 00 04 00 }
            $cfg3 = { 00 01 00 01 00 02 00 02 00 04 00 02 }
            $sleep = { 00 03 00 02 00 00 [4] 00 04 00 }
            $spawn_x86 = { 00 0d 00 80 00 00 }
            $spawn_x64 = { 00 0e 00 80 00 00 }
          condition:
            2 of ($cfg*) or ($sleep and (any of ($spawn*)))
        }

  - id: c2-framework/cobalt-strike/named-pipe
    desc: Cobalt Strike default named pipe
    crit: suspicious
    conf: 0.85
    mbc: "C0001"
    attack: "T1071"
    r#for: [pe, dll]
    if:
      type: yara
      source: |
        rule cobaltstrike_pipes {
          strings:
            $pipe1 = "\\\\.\\pipe\\msagent_" ascii wide
            $pipe2 = "\\\\.\\pipe\\MSSE-" ascii wide
            $pipe3 = "\\\\.\\pipe\\postex_" ascii wide
            $pipe4 = "\\\\.\\pipe\\postex_ssh_" ascii wide
            $pipe5 = "\\\\.\\pipe\\status_" ascii wide
            $pipe6 = "\\\\%s\\pipe\\" ascii
            $pipe7 = "\\pipe\\mojo" ascii
          condition:
            2 of them
        }

  - id: c2-framework/cobalt-strike/sleep-mask
    desc: Cobalt Strike sleep mask obfuscation
    crit: suspicious
    conf: 0.8
    mbc: "C0001"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: yara
      source: |
        rule cobaltstrike_sleepmask {
          strings:
            // More specific patterns - require both sleep_mask/SleepMask variants
            // AND Cobalt Strike specific context
            $sleep1 = "sleep_mask" ascii
            $sleep2 = "SleepMask" ascii
            $obf1 = "obfuscate_sleep" ascii
            $obf2 = "deobfuscate_sleep" ascii
            $beacon_ctx = "beacon" ascii nocase
            $cs_ctx = "cobaltstrike" ascii nocase
          condition:
            // Require sleep mask string + beacon/CS context, or specific obfuscate patterns
            (any of ($sleep*) and any of ($beacon_ctx, $cs_ctx)) or
            (any of ($obf*))
        }

  - id: c2-framework/cobalt-strike/malleable-c2
    desc: Cobalt Strike malleable C2 profile
    crit: suspicious
    conf: 0.85
    mbc: "C0001"
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: yara
      source: |
        rule cobaltstrike_malleable {
          strings:
            $uri1 = "/submit.php" ascii
            $uri2 = "/pixel.gif" ascii
            $uri3 = "/pixel" ascii
            $uri4 = "/__utm.gif" ascii
            $uri5 = "/ga.js" ascii
            $uri6 = "/fwlink" ascii
            $ua1 = "Mozilla/5.0 (compatible; MSIE" ascii
            $ua2 = "Mozilla/4.0 (compatible; MSIE" ascii
          condition:
            3 of ($uri*) or (2 of ($uri*) and any of ($ua*))
        }

  - id: c2-framework/cobalt-strike/vermilionstrike
    desc: VermilionStrike Linux Cobalt Strike beacon
    crit: suspicious
    conf: 0.95
    mbc: "C0001"
    attack: "T1071"
    r#for: [elf, so]
    if:
      type: yara
      source: |
        rule vermilionstrike {
          strings:
            $beacon1 = "%s (admin)" ascii
            $beacon2 = "%s (ssh)" ascii
            $beacon3 = "beacon" ascii nocase
            $c2_1 = "%s:%d%s" ascii
            $c2_2 = "POST %s HTTP/1.1" ascii
            $jitter = "jitter" ascii
            $sleep = "sleeptime" ascii
            $ssl1 = "BIO_new_ssl_connect" ascii
            $ssl2 = "SSL_CTX_new" ascii
            $str1 = "could not spawn" ascii
            $str2 = "could not upload" ascii
            $str3 = "could not download" ascii
          condition:
            (($ssl1 or $ssl2) and 3 of ($beacon*, $c2_*)) or
            ($jitter and $sleep and $beacon3) or
            3 of ($str*)
        }

  - id: c2-framework/cobalt-strike/reflective-load
    desc: Cobalt Strike reflective DLL loading
    crit: suspicious
    conf: 0.85
    mbc: "C0001"
    attack: "T1620"
    r#for: [pe, dll]
    if:
      type: yara
      source: |
        rule cobaltstrike_reflective {
          strings:
            $ref1 = "ReflectiveLoader" ascii
            $pe_header = { 4D 5A }
            $dos_stub = "This program cannot be run" ascii
            $loader1 = { 48 8B 52 60 48 8B 52 18 48 8B 52 20 }
            $loader2 = { 8B 52 60 8B 52 18 8B 52 20 }
          condition:
            ($ref1 and ($pe_header at 0 or $dos_stub)) or any of ($loader*)
        }

  - id: c2-framework/cobalt-strike/process-inject
    desc: Cobalt Strike process injection patterns
    crit: suspicious
    conf: 0.8
    mbc: "C0001"
    attack: "T1055"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: yara
      source: |
        rule cobaltstrike_inject {
          strings:
            $inject1 = "shinject" ascii
            $inject2 = "dllspawn" ascii
            $mem1 = "VirtualAllocEx" ascii
            $mem2 = "WriteProcessMemory" ascii
            $mem3 = "CreateRemoteThread" ascii
            $linux1 = "PTRACE_POKETEXT" ascii
            $linux2 = "process_vm_writev" ascii
          condition:
            any of ($inject*) or 3 of ($mem*) or all of ($linux*)
        }

  - id: c2-framework/cobalt-strike/format-string
    desc: Cobalt Strike format string indicator
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    platforms: [all]
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      substr: "%s as %s\\%s: %d"

  # === Cobalt Strike beacon reference atomic indicators ===
  - id: beacon-dll-file
    desc: beacon.dll file reference
    crit: suspicious
    conf: 0.95
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      substr: "beacon.dll"

  - id: beacon-exe-file
    desc: beacon.exe file reference
    crit: suspicious
    conf: 0.95
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      substr: "beacon.exe"

  - id: beacon-bin-file
    desc: beacon.bin file reference
    crit: suspicious
    conf: 0.95
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      substr: "beacon.bin"

  - id: beacon-config-ref
    desc: beacon_config or beacon config reference
    crit: notable
    conf: 0.8
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "beacon[_\\s]?config"

  - id: beacon-metadata-ref
    desc: beacon_metadata reference
    crit: notable
    conf: 0.8
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "beacon[_\\s]?metadata"

  - id: beacon-payload-ref
    desc: beacon_payload reference
    crit: notable
    conf: 0.8
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "beacon[_\\s]?payload"

  - id: beacon-command-ref
    desc: beacon_command reference
    crit: notable
    conf: 0.8
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "beacon[_\\s]?command"

  - id: beacon-task-ref
    desc: beacon_task reference
    crit: notable
    conf: 0.8
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "beacon[_\\s]?task"

  - id: cobaltstrike-beacon-combo
    desc: cobaltstrike and beacon combined reference
    crit: notable
    conf: 0.85
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "cobaltstrike.{0,50}beacon|beacon.{0,50}cobaltstrike"

  - id: reflectiveloader-beacon-ref
    desc: ReflectiveLoader beacon reference
    crit: notable
    conf: 0.85
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    if:
      type: string
      regex: "ReflectiveLoader.{0,50}beacon"

composite_rules:
  # Cobalt Strike beacon reference composite
  - id: c2-framework/cobalt-strike/beacon-ref
    desc: Cobalt Strike beacon reference
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1071"
    r#for: [elf, macho, pe, so, dylib, dll]
    count_min: 1
    any:
      - id: beacon-dll-file
      - id: beacon-exe-file
      - id: beacon-bin-file
      - id: beacon-config-ref
      - id: beacon-metadata-ref
      - id: beacon-payload-ref
      - id: beacon-command-ref
      - id: beacon-task-ref
      - id: cobaltstrike-beacon-combo
      - id: reflectiveloader-beacon-ref

  # Full Cobalt Strike beacon detection
  - id: c2-framework/cobalt-strike/beacon
    desc: Cobalt Strike beacon detected
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    mbc: "B0030"
    r#for: [elf, macho, pe, so, dylib, dll]
    any:
      - id: c2-framework/cobalt-strike/vermilionstrike
      - id: c2-framework/cobalt-strike/config-block
      - id: c2-framework/cobalt-strike/malleable-c2
      - id: c2-framework/cobalt-strike/named-pipe
      - id: c2-framework/cobalt-strike/sleep-mask
      - id: c2-framework/cobalt-strike/format-string

  # macOS beacon detection via syscall combination + entropy
  - id: c2-framework/cobalt-strike/macos-beacon
    desc: Cobalt Strike macOS beacon
    crit: suspicious
    conf: 0.9
    family: true
    mbc: "B0030"
    attack: "T1071"
    platforms: [macos]
    r#for: [macho]
    all:
      - id: c2-framework/cobalt-strike/config-block
      - id: c2-framework/cobalt-strike/sleep-mask
      - id: c2-framework/cobalt-strike/process-inject
