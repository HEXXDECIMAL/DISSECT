# evilBPF Rootkit
# Framework for eBPF-based rootkits (XDP backdoors, SSL sniffers, etc.)
# Reference: https://github.com/m0nad/evilBPF (similar frameworks)
# This trait captures the specific implementation seen in our samples.

traits:
  - id: icmp-prog-reply
    desc: evilBPF ICMP reply program name
    crit: suspicious
    for: [c, elf]
    if:
      type: string
      exact: "icmp_prog_reply"

  - id: attach-macro
    desc: evilBPF library attachment macro pattern
    crit: suspicious
    for: [c, elf]
    if:
      type: content
      substr: "ssl_attach_##"

  - id: ssl-load
    desc: evilBPF ssl_load function
    crit: notable
    for: [c, elf]
    if:
      type: symbol
      regex: "\\bssl_load\\b"

  - id: ssl-listen-event
    desc: evilBPF ssl_listen_event function
    crit: notable
    for: [c, elf]
    if:
      type: symbol
      regex: "\\bssl_listen_event\\b"

  - id: hide-pid-prog
    desc: evilBPF hide_pid program name
    crit: suspicious
    for: [c, elf]
    if:
      type: content
      regex: "hide_pid_(?:exit|make_it_disappear)"

composite_rules:
  - id: icmp-loader
    desc: evilBPF ICMP loader
    crit: suspicious
    all:
      - id: icmp-prog-reply
      - id: cap/os/bpf/program::xdp-attach

  - id: ssl-loader
    desc: evilBPF SSL sniffer loader
    crit: suspicious
    all:
      - id: attach-macro
      - id: cap/os/bpf/program::libbpf

  - id: ssl-sniffer
    desc: evilBPF SSL sniffer
    crit: suspicious
    all:
      - id: ssl-load
      - id: ssl-listen-event
      - id: cap/os/bpf/program::bpf-skeleton

  - id: pid-hider
    desc: evilBPF PID hider
    crit: suspicious
    all:
      - id: hide-pid-prog
      - id: cap/os/bpf/program::bpf-skeleton

  - id: evilbpf
    desc: evilBPF eBPF rootkit framework
    crit: hostile
    conf: 1.0
    attack: "T1014"
    mbc: "B0006"
    any:
      - id: icmp-loader
      - id: ssl-loader
      - id: ssl-sniffer
      - id: pid-hider