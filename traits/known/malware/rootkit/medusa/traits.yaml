# Malware Family - Medusa Rootkit
# LD_PRELOAD userspace rootkit with SSH credential theft
# Reference: https://www.elastic.co/security-labs/unveiling-medusa
# ATT&CK: T1574.006 (Dynamic Linker Hijacking), T1556 (Modify Authentication Process)

traits:
  # === Atomic: Hidden directory markers ===

  - id: rootkit/medusa/libseconf-dir
    description: Medusa hidden configuration directory
    crit: suspicious
    confidence: 0.95
    family: true
    attack: "T1574.006"
    file_types: [elf]
    condition:
      type: string
      regex: "/lib/libseconf"

  - id: rootkit/medusa/sshpass-file
    description: Medusa SSH credential storage file
    crit: suspicious
    confidence: 0.98
    family: true
    attack: "T1556"
    file_types: [elf]
    condition:
      type: string
      regex: "sshpass\\d?\\.txt"

  - id: rootkit/medusa/boot-script
    description: Medusa boot persistence script
    crit: suspicious
    confidence: 0.95
    family: true
    attack: "T1547.006"
    file_types: [elf]
    condition:
      type: string
      exact: ".boot.sh"

  - id: rootkit/medusa/logpam
    description: Medusa PAM logging file
    crit: suspicious
    confidence: 0.95
    family: true
    attack: "T1556.003"
    file_types: [elf]
    condition:
      type: string
      exact: ".logpam"

  - id: rootkit/medusa/ports-file
    description: Medusa ports configuration file
    crit: suspicious
    confidence: 0.9
    family: true
    attack: "T1571"
    file_types: [elf]
    condition:
      type: string
      exact: ".ports"

  # === Atomic: Dynamic linker hijacking ===

  - id: rootkit/medusa/libdsx
    description: Medusa malicious library (libdsx.so)
    crit: suspicious
    confidence: 0.95
    family: true
    attack: "T1574.006"
    file_types: [elf]
    condition:
      type: string
      exact: "libdsx.so"

  - id: rootkit/medusa/backup-ld
    description: Medusa ld.so backup pattern
    crit: suspicious
    confidence: 0.9
    family: true
    attack: "T1574.006"
    file_types: [elf]
    condition:
      type: string
      regex: "\\.backup_ld\\.so"

  - id: rootkit/medusa/ldx-staging
    description: Medusa /dev/shm/ldx staging directory
    crit: suspicious
    confidence: 0.9
    family: true
    attack: "T1574.006"
    file_types: [elf]
    condition:
      type: string
      exact: "/dev/shm/ldx"

  # === Atomic: SSH session sniffing ===

  - id: rootkit/medusa/sniff-ssh
    description: Medusa SSH session sniffing function
    crit: suspicious
    confidence: 0.98
    family: true
    attack: "T1557"
    file_types: [elf]
    condition:
      type: string
      exact: "sniff_ssh_session"

  - id: rootkit/medusa/sshdone
    description: Medusa SSH completion marker
    crit: suspicious
    confidence: 0.9
    family: true
    attack: "T1556"
    file_types: [elf]
    condition:
      type: string
      exact: "sshdone"

  - id: rootkit/medusa/sshpass-var
    description: Medusa sshpass variable
    crit: suspicious
    confidence: 0.75
    family: true
    attack: "T1556"
    file_types: [elf]
    condition:
      type: string
      exact: "sshpass"

  # === Atomic: SELinux bypass ===

  - id: rootkit/medusa/selinux-context
    description: Medusa SELinux context manipulation
    crit: suspicious
    confidence: 0.9
    family: true
    attack: "T1562.001"
    file_types: [elf]
    condition:
      type: string
      exact: "unconfined_u:object_r:sshd_tmp_t:s0"

  - id: rootkit/medusa/unconfined-exec
    description: Medusa unconfined execution
    crit: suspicious
    confidence: 0.7
    family: true
    attack: "T1562.001"
    file_types: [elf]
    condition:
      type: string
      exact: "unconfined_exec"

  - id: rootkit/medusa/ld-preload-file
    description: Medusa ld.so.preload configuration file access
    crit: suspicious
    confidence: 0.85
    family: true
    attack: "T1574.006"
    file_types: [elf]
    condition:
      type: string
      exact: "/etc/ld.so.preload"

  # === Atomic: YARA detection ===

  - id: rootkit/medusa/yara
    description: Medusa rootkit via YARA
    crit: suspicious
    confidence: 0.98
    family: true
    attack: "T1574.006"
    mbc: "F0015"
    file_types: [elf]
    condition:
      type: yara
      source: |
        rule medusa_rootkit {
          meta:
            description = "Medusa LD_PRELOAD rootkit"
            reference = "https://www.elastic.co/security-labs/unveiling-medusa"
          strings:
            // Hidden directory and files
            $libseconf = "/lib/libseconf" ascii
            $sshpass = /sshpass\d?\.txt/ ascii
            $boot_sh = ".boot.sh" ascii
            $logpam = ".logpam" ascii
            $ports = ".ports" ascii

            // Dynamic linker hijacking
            $libdsx = "libdsx.so" ascii
            $backup_ld = ".backup_ld.so" ascii
            $ldx_staging = "/dev/shm/ldx" ascii
            $ld_preload = "/etc/ld.so.preload" ascii

            // SSH credential theft
            $sniff_ssh = "sniff_ssh_session" ascii
            $sshdone = "sshdone" ascii
            $ssh_argv = "ssh_argv" ascii
            $stricthost = "StrictHostKeyChecking=no" ascii

            // SELinux bypass
            $selinux_ctx = "unconfined_u:object_r:sshd_tmp_t:s0" ascii
            $unconfined = "unconfined_exec" ascii
            $security_selinux = "security.selinux" ascii
          condition:
            uint32(0) == 0x464C457F and
            (
              // Primary indicators (any one is highly suspicious)
              $libseconf or $sniff_ssh or $sshpass or
              // Secondary indicators (combination required)
              ($backup_ld and $ldx_staging) or
              ($selinux_ctx and any of ($ssh*)) or
              ($stricthost and any of ($ssh*)) or
              ($unconfined and $security_selinux) or
              (3 of ($libdsx, $boot_sh, $logpam, $ports, $ld_preload))
            )
        }

composite_rules:
  # === Composite: Full Medusa rootkit detection ===


  # === Composite: SSH credential theft behavior ===

  - id: rootkit/medusa/ssh-theft
    description: Medusa SSH credential theft capability
    crit: suspicious
    confidence: 0.95
    attack: "T1556"
    mbc: "E1056"
    file_types: [elf]
    count_min: 2
    any:
      - id: rootkit/medusa/sniff-ssh
      - id: rootkit/medusa/sshpass-file
      - id: rootkit/medusa/sshdone
      - id: rootkit/medusa/sshpass-var

  # === Composite: Dynamic linker hijacking behavior ===

  - id: rootkit/medusa/ld-hijack
    description: Medusa dynamic linker hijacking
    crit: suspicious
    confidence: 0.95
    attack: "T1574.006"
    mbc: "F0015"
    file_types: [elf]
    count_min: 2
    any:
      - id: rootkit/medusa/libdsx
      - id: rootkit/medusa/backup-ld
      - id: rootkit/medusa/ldx-staging
      - id: rootkit/medusa/ld-preload-file
