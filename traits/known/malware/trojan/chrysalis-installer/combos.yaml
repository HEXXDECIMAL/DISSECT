# Known Malware: Chrysalis Installer Detection Rules
# Nullsoft NSIS installer deployment patterns

composite_rules:
  # === NSIS Installer Signature ===
  - id: nsis-installer-detected
    desc: Nullsoft NSIS installer detected
    crit: notable
    conf: 0.90
    for: ["pe"]
    all:
      - id: known/malware/trojan/chrysalis-installer/nullsoft-installer
      - id: known/malware/trojan/chrysalis-installer/nsis-version

  # === Registry Installation Pattern ===
  - id: registry-installation
    desc: Installation with registry configuration
    crit: suspicious
    conf: 0.80
    for: ["pe"]
    all:
      - id: cap/os/registry/reg-create-key
      - id: cap/os/registry/reg-set-value
      - id: cap/io/console/write-file

  # === Privilege Escalation Installation ===
  - id: elevated-installation
    desc: Installation with privilege escalation
    crit: suspicious
    conf: 0.85
    attack: "T1548.002"
    for: ["pe"]
    all:
      - id: cap/os/privilege/open-process-token
      - id: cap/os/privilege/adjust-token-privileges
      - id: cap/io/console/write-file
    downgrade:
      any:
        - id: known/malware/trojan/chrysalis-installer/nsis-installer-detected
        - id: meta/quality/versioned

  # === Chrysalis Installer Detected ===
  - id: installer-detected
    desc: Chrysalis installer (update.exe) detected
    crit: suspicious
    conf: 0.75
    for: ["pe"]
    all:
      - id: known/malware/trojan/chrysalis-installer/nsis-installer-detected
      - id: cap/os/registry/reg-set-value
      - id: cap/process/create/create-process-w
      - id: cap/io/console/write-file

  # === Deployment Chain ===
  - id: full-deployment
    desc: Complete malware deployment pattern
    crit: suspicious
    conf: 0.80
    for: ["pe"]
    all:
      - id: known/malware/trojan/chrysalis-installer/installer-detected
      - id: cap/os/privilege/adjust-token-privileges
      - id: cap/data/encode/compression/lzma-signature
