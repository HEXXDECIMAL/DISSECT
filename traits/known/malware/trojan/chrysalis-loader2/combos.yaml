# Known Malware: Chrysalis loader2 Detection
# Thread-based launcher component of Chrysalis malware family

composite_rules:
  # === Thread-based Execution ===
  - id: thread-based-execution
    desc: Thread creation + message queue
    crit: suspicious
    conf: 0.85
    attack: "T1129"
    for: ["pe", "dll"]
    all:
      - id: cap/process/thread/create/create-thread
      - id: cap/os/message/queue/peek-message-a
      - id: cap/os/message/queue/post-thread-message-a

  # === Exception Handling ===
  - id: exception-control
    desc: Custom exception handler registration
    crit: suspicious
    conf: 0.80
    attack: "T1006"
    for: ["pe", "dll"]
    all:
      - id: cap/os/exception/register/rtl-add-function-table
      - id: cap/os/exception/handler/capture-context
      - id: cap/os/exception/handler/virtual-unwind

  # === Memory Execution Pattern ===
  - id: memory-execute
    desc: Allocate + protect + execute
    crit: suspicious
    conf: 0.85
    for: ["pe", "dll"]
    all:
      - id: cap/mem/protect/modify/virtual-alloc
      - id: cap/mem/protect/modify/virtual-protect
      - id: cap/os/exception/register/rtl-add-function-table

  # === Minimal Shellcode Loader ===
  - id: loader2-detected
    desc: Chrysalis loader2 thread-based launcher
    crit: suspicious
    conf: 0.75
    for: ["pe"]
    all:
      - id: known/malware/trojan/chrysalis-loader2/mingw-compiler
      - id: cap/process/thread/create/create-thread
      - id: cap/os/exception/register/rtl-add-function-table
      - id: cap/mem/protect/modify/virtual-protect

  # === C Runtime Indicator ===
  - id: c-runtime-mingw
    desc: C runtime + MinGW libraries
    crit: notable
    conf: 0.85
    for: ["pe", "dll"]
    all:
      - id: cap/mem/c-runtime/functions/malloc
      - id: cap/mem/c-runtime/functions/free
      - id: known/malware/trojan/chrysalis-loader2/mingw-compiler
