# Known Malware: s047t5g Detection
# Loader/launcher component of Chrysalis malware family

composite_rules:
  # === Anti-Analysis Pattern ===
  - id: anti-analysis-core
    desc: Debugger detection + process termination
    crit: suspicious
    conf: 0.85
    attack: "T1562.001"
    for: ["pe", "dll"]
    all:
      - id: cap/exec/native/debugger-detect-api
      - id: cap/process/terminate/terminate-process

  # === Stack Manipulation Pattern ===
  - id: stack-unwinding
    desc: Stack and context manipulation
    crit: suspicious
    conf: 0.80
    attack: "T1006"
    for: ["pe", "dll"]
    all:
      - id: cap/os/exception/capture-context
      - id: cap/os/exception/virtual-unwind

  # === Loader Pattern ===
  - id: dynamic-loader
    desc: Runtime library loading pattern
    crit: notable
    conf: 0.85
    for: ["pe", "dll"]
    all:
      - id: cap/exec/native/load-library-a
      - id: cap/exec/native/get-proc-address
      - id: cap/exec/native/load-library-ex

  # === File System Enumeration ===
  - id: directory-scan
    desc: File system enumeration
    crit: notable
    conf: 0.80
    for: ["pe", "dll"]
    all:
      - id: cap/fs/enumerate/find-first-file
      - id: cap/fs/enumerate/find-next-file

  # === Console-based Execution ===
  - id: console-launcher
    desc: Console-based launcher pattern
    crit: notable
    conf: 0.75
    for: ["pe", "dll"]
    all:
      - id: cap/io/console/get-std-handle
      - id: cap/io/console/write-file

  # === Loader Evasion Chain ===
  - id: evasion-launcher
    desc: Anti-analysis + exception handling + dynamic loading
    crit: suspicious
    conf: 0.85
    attack: "T1562.001"
    for: ["pe", "dll"]
    all:
      - id: known/malware/trojan/loader-s047t5g/anti-analysis-core
      - id: cap/os/exception/lookup-function-entry

  # === s047t5g Specific Detection ===
  - id: detected
    desc: s047t5g loader detected
    crit: suspicious
    conf: 0.80
    for: ["pe"]
    all:
      - id: known/malware/trojan/loader-s047t5g/pdb-path
      - id: cap/exec/native/debugger-detect-api
      - id: cap/os/exception/virtual-unwind

  # === Chrysalis Family Launcher ===
  - id: chrysalis-launcher
    desc: Chrysalis family launcher component
    crit: suspicious
    conf: 0.75
    attack: "T1562"
    for: ["pe"]
    all:
      - id: known/malware/trojan/loader-s047t5g/detected
      - id: cap/process/terminate/terminate-process
      - id: cap/exec/native/load-library-a
