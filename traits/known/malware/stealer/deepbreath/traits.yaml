# DEEPBREATH Data Miner/Stealer Detection
# UNC1069 AppleScript-based data exfiltration tool
# Source: Google Threat Intelligence Group (GTIG)

defaults:
  platforms: [macos]
  for: [applescript, macho]

composite_rules:
  # Strict DEEPBREATH detection
  - id: deepbreath-strict
    desc: DEEPBREATH data miner (exact match)
    crit: hostile
    conf: 1.0
    attack: "T1555.003"
    needs: 6
    all:
      # At least 2 CLI flags
      - id: cap/interface/cli/flags::fakedel-flag
      - id: cap/interface/cli/flags::autodat-flag
      # At least 2 TCC access patterns
      - id: cap/data/tcc/database::tcc-db-alias
      # At least 3 browser data paths
      - id: cap/data/browser/access::chrome-support-path
      - id: cap/data/browser/access::extension-settings-path
      - id: cap/data/browser/access::cookies-path-concat
      - id: cap/data/browser/access::login-data-path-concat
      # Copy with quoted form
      - id: cap/data/browser/access::cp-quoted-form

  # Generalized AppleScript browser credential theft
  - id: applescript-browser-stealer
    desc: AppleScript-based browser credential stealer
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    all:
      - id: cap/data/tcc/database::tcc-db-alias
      - id: cap/data/browser/access::browser-data-theft
    any:
      - id: cap/interface/cli/flags

  # TCC bypass with browser data theft
  - id: tcc-browser-theft
    desc: TCC database access for browser credential theft
    crit: hostile
    conf: 0.95
    attack: "T1555.003"
    needs: 2
    all:
      - id: cap/data/tcc/database::tcc-db-alias
    any:
      - id: cap/data/browser/access::extension-settings-path
      - id: cap/data/browser/access::cookies-path-concat
      - id: cap/data/browser/access::login-data-path-concat
      - id: cap/data/tcc/database::tccclickjack-string
