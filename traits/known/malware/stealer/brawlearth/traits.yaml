# Malware Family - BrawlEarth macOS Stealer
# Rust-based macOS infostealer targeting browser data and crypto wallets
# Reference: https://github.com/anthropics/claude-code (sample analysis)
# ATT&CK: T1555 (Credentials from Password Stores)

traits:
  # === Brand/Name Markers ===

  - id: stealer/brawlearth/brand-name
    desc: BrawlEarth stealer brand string
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    if:
      type: string
      substr: "BrawlEarth"

  - id: stealer/brawlearth/version-string
    desc: BrawlEarth version identifier
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    if:
      type: string
      regex: "BrawlEarth[0-9.]+"

  # === Source Code Paths (developer signature) ===

  # === Browser module source path atomic indicators ===
  - id: src-path-chromium
    desc: BrawlEarth chromium module source path
    crit: notable
    conf: 0.8
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    if:
      type: string
      substr: "src/browsers/chromium/modules"

  - id: src-path-firefox
    desc: BrawlEarth firefox module source path
    crit: notable
    conf: 0.8
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    if:
      type: string
      substr: "src/browsers/firefox/modules"

  - id: stealer/brawlearth/src-path-decryptors
    desc: BrawlEarth decryptor module source path
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    if:
      type: string
      substr: "src/browsers/firefox/modules/decryptors.rs"

  # === C2/Exfiltration ===

  - id: stealer/brawlearth/c2-connect-msg
    desc: BrawlEarth C2 connection error message
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    platforms: [macos]
    r#for: [macho]
    if:
      type: string
      substr: "Cannot connect to the server..."

  # === YARA-based detection ===

  - id: stealer/brawlearth/detected-yara
    desc: BrawlEarth stealer via YARA
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    if:
      type: yara
      source: |
        rule brawlearth_stealer {
          meta:
            description = "BrawlEarth macOS Infostealer"
            author = "DISSECT"
          strings:
            // Brand/version markers
            $brand = "BrawlEarth" ascii
            $version = /BrawlEarth[0-9.]+/ ascii

            // Developer source paths (compiled into binary)
            $src1 = "src/browsers/chromium/modules" ascii
            $src2 = "src/browsers/firefox/modules" ascii
            $src3 = "src/programmes/modules.rs" ascii
            $src4 = "src/utils.rs" ascii

            // C2/config strings
            $c2_msg = "Cannot connect to the server..." ascii
            $build = "buildNamebuildVersionuid" ascii

            // Rust tokio async runtime (common in Rust stealers)
            $tokio = "/Users/rootr/.cargo/registry/src/" ascii

            // Target artifacts
            $kc = "/Library/Keychains/login.keychain" ascii
            $screenshot = "screenshot.png" ascii
            $zipdata = "zipdata.zip" ascii

          condition:
            (uint32(0) == 0xFEEDFACF or uint32(0) == 0xCFFAEDFE or
             uint32(0) == 0xCAFEBABE or uint32(0) == 0xBEBAFECA) and
            filesize > 1MB and filesize < 20MB and
            ($brand or $version) and
            2 of ($src*) and
            any of ($kc, $screenshot, $zipdata) and
            ($c2_msg or $build or $tokio)
        }

composite_rules:
  # Browser source path composite
  - id: stealer/brawlearth/src-path-browsers
    desc: BrawlEarth browser module source path
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1555"
    platforms: [macos]
    r#for: [macho]
    count_min: 1
    any:
      - id: src-path-chromium
      - id: src-path-firefox

