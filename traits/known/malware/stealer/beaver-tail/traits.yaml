# Malware Family - Beaver Tail Infostealer
# Reference: https://objective-see.org/blog/blog_0x7A.html
# ATT&CK: T1555 (Credentials from Password Stores)

traits:
  - id: stealer/beaver-tail/pdown
    desc: Beaver Tail download endpoint
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1105"
    r#for: [elf, macho]
    if:
      type: string
      substr: "/pdown"

  - id: stealer/beaver-tail/upload-ldb
    desc: Beaver Tail LDB upload marker
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1041"
    r#for: [elf, macho]
    if:
      type: string
      substr: "Upload LDB Finshed"

  - id: stealer/beaver-tail/python-download
    desc: Beaver Tail Python download success
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1105"
    r#for: [elf, macho]
    if:
      type: string
      substr: "Download Python Success!"

  - id: stealer/beaver-tail/pyp-python
    desc: Beaver Tail hidden Python path
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1059.006"
    r#for: [elf, macho]
    if:
      type: string
      substr: "/.pyp/python.exe"

  - id: stealer/beaver-tail/keychain-log
    desc: Beaver Tail keychain logging
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1555.001"
    r#for: [elf, macho]
    if:
      type: string
      substr: "logkc_db"

  - id: stealer/beaver-tail/client-99
    desc: Beaver Tail client endpoint
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1071"
    r#for: [elf, macho]
    if:
      type: string
      substr: "/client/99"

  - id: stealer/beaver-tail/ldb-glob
    desc: Beaver Tail LDB file glob
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1555.003"
    r#for: [elf, macho]
    if:
      type: string
      substr: "*.ldb"

  - id: stealer/beaver-tail/pdown-finished
    desc: Beaver Tail pDown callback
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1105"
    r#for: [elf, macho]
    if:
      type: string
      substr: "pDownFinished"

  - id: stealer/beaver-tail/browser-url
    desc: Beaver Tail browser URL setter
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1555.003"
    r#for: [elf, macho]
    if:
      type: string
      substr: "setBaseBrowserUrl"

composite_rules:
  - id: stealer/beaver-tail/detected
    desc: Beaver Tail Infostealer
    crit: suspicious
    conf: 0.95
    family: true
    reference: "https://objective-see.org/blog/blog_0x7A.html"
    attack: "T1555"
    mbc: "B0028"
    r#for: [elf, macho]
    count_min: 3
    any:
      - id: stealer/beaver-tail/pdown
      - id: stealer/beaver-tail/upload-ldb
      - id: stealer/beaver-tail/python-download
      - id: stealer/beaver-tail/keychain-log
      - id: stealer/beaver-tail/pdown-finished
      - id: stealer/beaver-tail/browser-url
