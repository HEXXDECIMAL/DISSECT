# Malware Family - Beaver Tail Infostealer
# Reference: https://objective-see.org/blog/blog_0x7A.html
# ATT&CK: T1555 (Credentials from Password Stores)

traits:
  - id: pdown
    desc: Beaver Tail download endpoint
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    for: [elf, macho]
    if:
      type: string
      substr: "/pdown"

  - id: upload-ldb
    desc: Beaver Tail LDB upload marker
    crit: suspicious
    conf: 0.95
    attack: "T1041"
    for: [elf, macho]
    if:
      type: string
      substr: "Upload LDB Finshed"

  - id: python-download
    desc: Beaver Tail Python download success
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    for: [elf, macho]
    if:
      type: string
      substr: "Download Python Success!"

  - id: pyp-python
    desc: Beaver Tail hidden Python path
    crit: suspicious
    conf: 0.9
    attack: "T1059.006"
    for: [elf, macho]
    if:
      type: string
      substr: "/.pyp/python.exe"

  - id: keychain-log
    desc: Beaver Tail keychain logging
    crit: suspicious
    conf: 0.95
    attack: "T1555.001"
    for: [elf, macho]
    if:
      type: string
      substr: "logkc_db"

  - id: client-99
    desc: Beaver Tail client endpoint
    crit: suspicious
    conf: 0.9
    attack: "T1071"
    for: [elf, macho]
    if:
      type: string
      substr: "/client/99"

  - id: ldb-glob
    desc: Beaver Tail LDB file glob
    crit: suspicious
    conf: 0.9
    attack: "T1555.003"
    for: [elf, macho]
    if:
      type: string
      substr: "*.ldb"

  - id: pdown-finished
    desc: Beaver Tail pDown callback
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    for: [elf, macho]
    if:
      type: string
      substr: "pDownFinished"

  - id: browser-url
    desc: Beaver Tail browser URL setter
    crit: suspicious
    conf: 0.95
    attack: "T1555.003"
    for: [elf, macho]
    if:
      type: string
      substr: "setBaseBrowserUrl"

composite_rules:
  - id: beaver-tail-detected
    desc: Beaver Tail Infostealer
    crit: suspicious
    conf: 0.95
    attack: "T1555"
    mbc: "B0028"
    for: [elf, macho]
    needs: 3
    any:
      - id: pdown
      - id: upload-ldb
      - id: python-download
      - id: keychain-log
      - id: pdown-finished
      - id: browser-url
