# CryptoAITools Malware Detection
# Crypto trading bot themed malware family (2024)
# Typically distributed as fake trading bots (Meme-Token-Hunter-Bot, etc.)
# ATT&CK: T1204 (User Execution), T1105 (Ingress Tool Transfer)
# MBC: B0024 (Dropper)

defaults:
  crit: suspicious
  mbc: "B0024"
  attack: "T1105"
  for: [python]

traits:
  # === CryptoAITools-specific Markers ===
  - id: encoded-base-key
    desc: Base64 encoded base key variable
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: "encoded_base_key\\s*=\\s*['\"]"

  - id: encoded-licences
    desc: Encoded licences array
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: "encoded_licences\\s*=\\s*\\["

  - id: tmpcode-directory
    desc: tmpcode directory in home
    crit: suspicious
    conf: 0.85
    if:
      type: content
      substr: "~/tmpcode"

  - id: mhtbot-filename
    desc: MHTBot.py filename reference
    crit: suspicious
    conf: 0.95
    if:
      type: content
      substr: "MHTBot.py"

  - id: coinsw-domain
    desc: coinsw.app C2 domain
    crit: suspicious
    conf: 0.95
    if:
      type: content
      substr: "coinsw.app"

  # === Helper Pattern Markers ===
  - id: base-helper-import
    desc: base_helper.py import
    crit: suspicious
    conf: 0.85
    if:
      type: content
      word: "base_helper"

  - id: basec-helper-import
    desc: basec_helper.py import
    crit: suspicious
    conf: 0.85
    if:
      type: content
      substr: "basec_helper"

  # === Crypto Trading Decoy Patterns ===
  - id: uniswap-sushiswap
    desc: Uniswap and Sushiswap references
    crit: inert
    conf: 0.50
    if:
      type: string
      regex: "(?i)(uniswap|sushiswap)"

  - id: swap-event
    desc: Swap event handler
    crit: inert
    conf: 0.50
    if:
      type: string
      regex: "\\.on\\(['\"]Swap['\"]"

  - id: token-pair-contract
    desc: Token pair contract patterns
    crit: inert
    conf: 0.50
    if:
      type: string
      regex: "(getPairContract|getTokenAndContract)"

  - id: meme-hunter-keyword
    desc: MemeHunter keyword
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "MemeHunter"

  - id: arb-for-against
    desc: Arbitrage variables
    crit: inert
    conf: 0.50
    if:
      type: string
      regex: "(ARB_FOR|ARB_AGAINST)"

  # === OS-aware Helper Dispatch ===
  - id: run-mac-helper
    desc: run_mac_helper function
    crit: suspicious
    conf: 0.85
    if:
      type: content
      substr: "run_mac_helper"

  - id: run-windows-helper
    desc: run_windows_helper function
    crit: suspicious
    conf: 0.85
    if:
      type: content
      substr: "run_windows_helper"

  # === Safe Connector Deception ===
  - id: safe-connector-string
    desc: Safe Connector deceptive string
    crit: suspicious
    conf: 0.85
    if:
      type: content
      substr: "Safe Connector"

composite_rules:
  # === Helper composites ===
  - id: encoded-config
    desc: Encoded configuration pattern
    any:
      - id: encoded-base-key
      - id: encoded-licences

  - id: helper-files
    desc: Helper file references
    any:
      - id: base-helper-import
      - id: basec-helper-import

  - id: os-dispatch
    desc: OS-aware helper dispatch
    any:
      - id: run-mac-helper
      - id: run-windows-helper

  - id: crypto-trading-terms
    desc: Crypto trading terminology
    any:
      - id: uniswap-sushiswap
      - id: swap-event
      - id: token-pair-contract
      - id: arb-for-against

  # === Main Detection Rules ===
  - id: dropper-payload
    desc: CryptoAITools dropper payload
    crit: suspicious
    conf: 0.90
    attack: "T1105"
    needs: 2
    any:
      - id: encoded-config
      - id: tmpcode-directory
      - id: mhtbot-filename
      - id: coinsw-domain

  - id: crypto-bot-decoy
    desc: Crypto bot decoy with helpers
    crit: suspicious
    conf: 0.85
    attack: "T1204"
    all:
      - id: obj/lateral/supply-chain/pypi/malicious-packages::wildcard-import-helpers
    any:
      - id: crypto-trading-terms

  # === HOSTILE: OS-aware Dropper Dispatcher ===
  # Complexity: file_types(+1) + all(+2) + any(+1) = 4 >= 4
  - id: os-aware-dropper
    desc: CryptoAITools OS-aware dropper
    crit: hostile
    conf: 0.90
    mbc: "B0024"
    attack: "T1105"
    for: [python]
    all:
      - id: os-dispatch
      - id: helper-files
    any:
      - id: obj/discovery/host/system/os-fingerprint::os-check-darwin
      - id: obj/discovery/host/system/os-fingerprint::os-check-windows

  # === HOSTILE: Full CryptoAITools Detection (dropper payload) ===
  # Complexity: file_types(+1) + all(+3) = 4 >= 4
  - id: detected
    desc: CryptoAITools malware detected
    crit: hostile
    conf: 0.95
    mbc: "B0024"
    attack: "T1105"
    for: [python]
    all:
      - id: encoded-config
      - id: tmpcode-directory
      - id: mhtbot-filename

  # === HOSTILE: CryptoAITools C2 Domain Detection ===
  # Complexity: file_types(+1) + all(+2) + any(+1) = 4 >= 4
  - id: detected-c2
    desc: CryptoAITools C2 domain detected
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1071.001"
    for: [python]
    all:
      - id: encoded-config
      - id: tmpcode-directory
    any:
      - id: coinsw-domain
      - id: safe-connector-string
