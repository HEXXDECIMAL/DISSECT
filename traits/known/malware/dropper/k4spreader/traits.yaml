# K4Spreader Malware Detection
# Detects K4Spreader (Tsunami-derived) IoT malware
# ATT&CK: T1583.005 (Botnet)

defaults:
  for: [elf, macho, so, dylib, python, shell]

traits:
  # === K4Spreader Binary Names ===
  - id: klibsystem5-marker
    desc: klibsystem5 binary name (K4Spreader)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      substr: "klibsystem5"

  # === Related Malware Names (fullword = word boundary) ===
  - id: tsunami-lower
    desc: tsunami malware name (lowercase)
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "tsunami"

  - id: tsunami-title
    desc: Tsunami malware name (title case)
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "Tsunami"

  - id: tsunami-upper
    desc: TSUNAMI malware name (uppercase)
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "TSUNAMI"

  - id: kaiten-lower
    desc: kaiten malware name (lowercase)
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "kaiten"

  - id: kaiten-title
    desc: Kaiten malware name (title case)
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "Kaiten"

  - id: kaiten-upper
    desc: KAITEN malware name (uppercase)
    crit: inert
    conf: 0.75
    if:
      type: string
      word: "KAITEN"

  # === Spreading Keywords (require malware-specific context) ===
  # NOTE: Generic terms like "scanner" and "exploit" are too common in legitimate tools
  # (e.g., flex generates lexical scanners, security tools document exploits).
  # These patterns require malware-specific context to avoid false positives.
  - id: scanner-exploit-combo
    desc: scanner + exploit keywords together
    crit: inert
    conf: 0.7
    if:
      type: string
      # Require both words in close proximity (shell script spreading pattern)
      regex: "(?i)(?:scanner.{0,50}exploit|exploit.{0,50}scanner)"

  # === K4Spreader Magic String ===
  - id: k4spreader-magic
    desc: K4SPREADER magic string
    crit: inert
    conf: 0.95
    if:
      type: string
      substr: "K4SPREADER"

composite_rules:
  # === Helper composites ===
  - id: tsunami-keyword
    desc: Tsunami keyword (case variants)
    any:
      - id: tsunami-lower
      - id: tsunami-title
      - id: tsunami-upper

  - id: kaiten-keyword
    desc: Kaiten keyword (case variants)
    any:
      - id: kaiten-lower
      - id: kaiten-title
      - id: kaiten-upper

  - id: related-malware
    desc: Related malware names (Tsunami/Kaiten)
    any:
      - id: tsunami-keyword
      - id: kaiten-keyword

  # === Helper composite ===
  - id: malware-with-spreading
    desc: Related malware with spreading keywords
    all:
      - id: related-malware
      - id: scanner-exploit-combo

  # === Migrated from YARA ===
  - id: k4spreader-generic
    desc: K4Spreader malware detected
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1583.005"
    any:
      - id: k4spreader-magic
      - id: klibsystem5-marker
      - id: malware-with-spreading
