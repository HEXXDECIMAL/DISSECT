# Generalized Rust Dropper/Stager
# Detects Rust binaries combining HTTP downloads with file system and execution capabilities.
# ATT&CK: T1105 (Ingress Tool Transfer), T1059 (Command and Scripting Interpreter)

traits:
  # === Rust HTTP Client Libraries ===
  - id: reqwest-crate
    desc: reqwest Rust HTTP library
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: string
      word: "reqwest"

  - id: ureq-crate
    desc: ureq Rust HTTP library
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: string
      word: "ureq"

  - id: hyper-crate
    desc: hyper Rust HTTP library
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: string
      word: "hyper"

  # NOTE: "surf" as a word is too generic - appears in graphics libraries (surface, surfaceformat).
  # Changed to match Rust crate path patterns instead.
  - id: surf-crate
    desc: surf Rust HTTP library
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: string
      # Match surf crate paths like "surf-2.3.0/src" or "surf::" namespace
      regex: '(surf-\d+\.\d+|surf::)'

  - id: curl-rust-crate
    desc: curl-rust Rust HTTP library
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: string
      substr: "curl-rust"

  # === Rust Process Execution ===
  - id: std-process-command
    desc: std::process::Command Rust type
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "std::process::Command"

  - id: command-new
    desc: Command::new Rust method
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "Command::new"

  - id: std-process-child
    desc: std::process::Child Rust type
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "std::process::Child"

  # === Rust File System Operations ===
  - id: std-fs-file-create
    desc: std::fs::File::create Rust method
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "std::fs::File::create"

  - id: std-fs-write
    desc: std::fs::write Rust function
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "std::fs::write"

  - id: std-fs-openoptions
    desc: std::fs::OpenOptions Rust type
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "std::fs::OpenOptions"

  - id: std-io-copy
    desc: std::io::copy Rust function
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: symbol
      exact: "std::io::copy"

  # === ureq Specific Artifacts ===
  - id: ureq-body-rs
    desc: ureq-2.12.1/src/body.rs source path
    crit: inert
    conf: 0.8
    for: [elf, macho, pe]
    if:
      type: string
      substr: "ureq-2.12.1/src/body.rs"

  - id: ureq-chunked-decoder-rs
    desc: ureq-2.12.1/src/chunked/decoder.rs source path
    crit: inert
    conf: 0.8
    for: [elf, macho, pe]
    if:
      type: string
      substr: "ureq-2.12.1/src/chunked/decoder.rs"

  - id: ureq-pool-rs
    desc: ureq-2.12.1/src/pool.rs source path
    crit: inert
    conf: 0.8
    for: [elf, macho, pe]
    if:
      type: string
      substr: "ureq-2.12.1/src/pool.rs"

  - id: fixupcount-s3-url
    desc: fixupcount S3 bucket URL
    crit: inert
    conf: 0.95
    for: [elf, macho, pe]
    if:
      type: string
      substr: "https://fixupcount.s3.dualstack.ap-northeast-1.amazonaws.com/wehn/rich.png"

  - id: cosmanking-cargo-path
    desc: /Users/cosmanking/.cargo/registry/src/ path
    crit: inert
    conf: 0.85
    for: [elf, macho, pe]
    if:
      type: string
      substr: "/Users/cosmanking/.cargo/registry/src/"

  - id: stager-ureq-user-agent
    desc: "Specific User-Agent string from ureq/vget"
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_8; en-us) AppleWebKit/534.50 (KHTML, like Gecko) Version/5.1 Safari/534.50"

  - id: stager-s3-url
    desc: "Reference to S3 bucket used"
    crit: notable
    conf: 0.8
    if:
      type: string
      regex: "s3.{0,50}amazonaws.com"

  # === Rust Build Artifacts ===
  - id: rustc-compiler
    desc: rustc Rust compiler reference
    crit: inert
    conf: 0.6
    for: [elf, macho, pe]
    if:
      type: string
      word: "rustc"

  - id: static-pie
    desc: static-pie build type
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    if:
      type: string
      substr: "static-pie"

  - id: https-url
    desc: "HTTPS URL reference"
    crit: inert
    conf: 0.5
    for: [elf, macho, pe]
    if:
      type: string
      substr: "https://"

composite_rules:
  # === Helper composites ===
  - id: rust-http-libs
    desc: Rust HTTP client libraries
    for: [elf, macho, pe]
    any:
      - id: reqwest-crate
      - id: ureq-crate
      - id: hyper-crate
      - id: surf-crate
      - id: curl-rust-crate

  - id: rust-process-exec
    desc: Rust process execution types
    for: [elf, macho, pe]
    any:
      - id: std-process-command
      - id: command-new
      - id: std-process-child

  - id: rust-fs-operations
    desc: Rust file system operations
    for: [elf, macho, pe]
    any:
      - id: std-fs-file-create
      - id: std-fs-write
      - id: std-fs-openoptions
      - id: std-io-copy

  - id: ureq-source-paths
    desc: ureq 2.12.1 source file paths
    for: [elf, macho, pe]
    any:
      - id: ureq-body-rs
      - id: ureq-chunked-decoder-rs
      - id: ureq-pool-rs


  # Note: small-binary (filesize < 5MB) cannot be directly translated
  # to DISSECT trait system as filesize constraints are not supported

  # Helper composite
  - id: cosmanking-ureq
    desc: Cosmanking cargo with ureq artifacts
    all:
      - id: cosmanking-cargo-path
      - id: ureq-source-paths
        needs: 2
  - id: vget-specific
    desc: "Rust-based downloader (ureq) with specific"
    crit: suspicious
    conf: 0.95
    attack: "T1105"
    for: [elf, macho, pe]
    any:
      - id: fixupcount-s3-url
      - id: cosmanking-ureq

  - id: stager-static-pie
    desc: "Rust static PIE binary (evasive"
    crit: notable
    conf: 0.7
    for: [elf, macho, pe]
    all:
      - id: rustc-compiler
      - id: static-pie

  # Helper composite
  - id: http-client
    desc: Rust HTTP client detected
    crit: inert
    conf: 0.7
    for: [elf, macho, pe]
    needs: 1
    any:
      - id: reqwest-crate
      - id: ureq-crate
      - id: hyper-crate
      - id: surf-crate
      - id: curl-rust-crate

  - id: file-execution
    desc: Rust file execution capability
    crit: notable
    conf: 0.8
    for: [elf, macho, pe]
    needs: 1
    any:
      - id: std-process-command
      - id: command-new
      - id: std-process-child

  - id: fs-ops
    desc: Rust filesystem operations
    crit: notable
    conf: 0.8
    for: [elf, macho, pe]
    needs: 1
    any:
      - id: std-fs-file-create
      - id: std-fs-write
      - id: std-fs-openoptions
      - id: std-io-copy

  - id: exec-or-fs
    desc: File execution or filesystem operations
    any:
      - id: file-execution
      - id: fs-ops

  - id: stager-behavior
    desc: "Rust-based Downloader/Stager behavior detected"
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1105"
    for: [elf, macho, pe]
    all:
      - id: http-client
      - id: exec-or-fs

  - id: likely-stager
    desc: "Likely Rust-based stager (small binary"
    crit: hostile
    conf: 0.95
    mbc: "B0030"
    attack: "T1105"
    for: [elf, macho, pe]
    all:
      - id: http-client
      - id: https-url
      - id: exec-or-fs