# Ultralytics Supply Chain Attack Pattern (2024)
# Detects malware disguised as legitimate ML library modifications
# ATT&CK: T1195.002 (Supply Chain Compromise)
# MBC: B0024 (Dropper)

defaults:
  attack: "T1195.002"
  mbc: "B0024"
  for: [python]

traits:
  # Import of safe_run function from downloads module
  - id: safe-run-import
    desc: safe_run dropper import
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "from\\s+.{1,80}downloads\\s+import\\s+.{1,50}safe_run"

  # Call to safe_run with /tmp path
  - id: safe-run-tmp
    desc: safe_run tmp execution
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "safe_run\\s*\\(\\s*[\"']/tmp/"

  # Git blob SHA pattern (40 hex chars)
  - id: git-blob-sha
    desc: Git blob SHA payload
    crit: notable
    conf: 0.80
    if:
      type: string
      regex: '"[a-f0-9]{40}"'

  # gitApi parameter in function call
  - id: gitapi-param
    desc: gitApi=True parameter for GitHub API
    crit: notable
    conf: 0.85
    if:
      type: string
      exact: "gitApi=True"

  # ultralytics_runner binary name
  - id: ultralytics-runner
    desc: Ultralytics runner payload name
    crit: suspicious
    conf: 0.98
    if:
      type: string
      exact: "ultralytics_runner"

  # Ultralytics v8.3.46 xmrig dropper pattern
  # Downloads xmrig from GitHub and runs with supportxmr pool
  - id: xmrig-dropper
    desc: xmrig download in os.system
    crit: suspicious
    conf: 0.98
    if:
      type: string
      regex: "xmrig.{0,200}supportxmr"

  # Module-level platform check with os.system
  - id: module-platform-exec
    desc: Platform check with os.system execution
    crit: suspicious
    conf: 0.90
    if:
      type: content
      regex: 'if\s+"Linux"\s+in\s+platform\.system\(\).{0,50}os\.system'

composite_rules:
  # Download and run from tmp via gitApi
  - id: github-dropper
    desc: Download via GitHub API and execute
    crit: suspicious
    conf: 0.95
    attack: "T1195.002"
    for: [python]
    count_min: 2
    any:
      - id: git-blob-sha
      - id: gitapi-param
      - id: cap/exec/dropper/tmp-exec/tmp-path
      - id: cap/exec/dropper/tmp-exec/tmp-path-short

  # Complete ultralytics-style supply chain attack (safe_run variant)
  - id: detected-safe-run
    desc: Ultralytics safe_run dropper
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    for: [python]
    all:
      - id: safe-run-import
    any:
      - id: safe-run-tmp
      - id: ultralytics-runner
      - id: github-dropper

  # Combined detection for all Ultralytics variants
  # Complexity: any:+1, file_types:+1, all:+2 = 4
  - id: detected
    desc: Ultralytics supply chain attack
    crit: hostile
    conf: 0.98
    attack: "T1195.002"
    for: [python]
    all:
      - id: cap/exec/command/shell/python-os-system
      - id: obj/impact/cryptojacking/miner/xmrig-ref
    any:
      - id: detected-safe-run
      - id: xmrig-dropper
      - id: module-platform-exec
