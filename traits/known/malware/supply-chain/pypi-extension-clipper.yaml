# PyPI Browser Extension Crypto Clipper Family
# A family of typosquatting PyPI packages that drop malicious browser
# extensions for cryptocurrency clipboard hijacking.
#
# Attack chain:
# 1. Obfuscated setup.py with Chinese character variables + state machine
# 2. String construction via getattr(__builtins__, chr) with bit-shift arithmetic
# 3. pip.main() installs pypiwin32 at egg_info/build time
# 4. At install time: writes manifest.json + background.js to %APPDATA%\Extension
# 5. Enumerates browser shortcuts (.lnk) across Start Menu/Taskbar/Desktop
# 6. Injects --load-extension into Chrome/Edge/Brave shortcuts via WScript.Shell COM
# 7. Extension monitors clipboard and replaces crypto wallet addresses
#
# Known packages: prompt-oolkit, colouramo, requesfs, and similar typosquats
# ATT&CK: T1195.002 (Compromise Software Supply Chain), T1176 (Browser Extensions)

defaults:
  for: [python]
  platforms: [windows]
  attack: "T1195.002"

composite_rules:
  # === PyPI Extension Clipper Family ===
  # Combines the unique behavioral fingerprint of this family:
  # obfuscated state machine + shortcut hijack + file write + pip autoinstall
  # Complexity: all(+5) = 5+ (meets HOSTILE threshold)
  - id: pypi-extension-clipper
    desc: PyPI crypto clipper via browser extension injection
    crit: hostile
    conf: 0.98
    mbc: "E1204"
    attack: "T1176"
    all:
      - id: obj/anti-static/obfuscation/code::state-machine-obfuscation
      - id: obj/anti-static/obfuscation/code::join-map-getattr-chr
      - id: obj/persist/startup/registry::windows-shortcut-argument-injection
      - id: obj/lateral/supply-chain/pypi/install-patterns::setup-py-file-write
      - id: cap/exec/autoinstall/pip::main-call-content
