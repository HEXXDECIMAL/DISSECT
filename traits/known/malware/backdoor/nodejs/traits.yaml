# NodeJS-based Backdoor Detections
# ATT&CK: T1059.003 (Command and Scripting Interpreter: JavaScript), T1071 (Application Layer Protocol)

defaults:
  r#for: [elf, macho, so, dylib]

traits:
  # === Packaging Markers (Boring/Inert) ===

  - id: nodejs/pkg-marker
    desc: "NodeJS binary packaged with 'pkg'"
    crit: notable
    conf: 1.0
    if:
      type: string
      substr: "/snapshot/"

  - id: nodejs/nexe-marker
    desc: "NodeJS binary packaged with 'nexe'"
    crit: notable
    conf: 1.0
    if:
      type: string
      substr: "nexe.js"

  # NOTE: Cannot be migrated - requires YARA ELF module for section enumeration
  - id: nodejs/lpstub-section
    desc: "NodeJS binary with 'lpstub' (hugepages"
    crit: inert
    conf: 1.0
    if:
      type: yara
      source: |
        import "elf"
        rule nodejs_lpstub {
          condition:
            for any i in (0..elf.number_of_sections-1) : (
              elf.sections[i].name == "lpstub"
            )
        }

  # === Suspicious Indicators ===

  - id: backdoor/nodejs/suspicious-c2
    desc: "Suspicious NodeJS C2 endpoint (securitytrails.pro)"
    crit: suspicious
    conf: 1.0
    attack: "T1071"
    if:
      type: string
      substr: "ws://securitytrails.pro:2052"

composite_rules:
  # Migrated from YARA nodejs_exfil - references generic traits
  - id: backdoor/nodejs/exfil-pattern
    desc: NodeJS combination of WebSockets and
    crit: suspicious
    conf: 0.8
    all:
      - id: cap/data/archive/archiver
      - id: cap/comm/websocket/ws
      - id: nodejs/pkg-marker

  # Helper: any backdoor behavior indicator
  - id: nodejs-backdoor-behavior
    desc: NodeJS backdoor behavior indicators
    any:
      - id: backdoor/nodejs/suspicious-c2
      - id: backdoor/nodejs/exfil-pattern
      - id: obj/c2/client/generic/marker
      - id: cap/exec/remote-command/generic
      - id: cap/data/archive/zip/generic

  - id: backdoor/nodejs/detected
    desc: "NodeJS-based Backdoor detected"
    crit: suspicious
    conf: 0.95
    attack: "T1059.003"
    mbc: "B0022"
    all:
      - id: nodejs/pkg-marker
      - id: nodejs-backdoor-behavior
