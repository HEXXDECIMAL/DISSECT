# FreeDownloadManager Backdoor Detection
# 2023 supply chain compromise of FreeDownloadManager Linux packages
# ATT&CK: T1195.002 (Supply Chain Compromise)
# Reference: https://securelist.com/backdoored-free-download-manager-linux-malware/110465/

defaults:
  attack: "T1195.002"
  mbc: "B0030"

traits:
  # FDM backdoor C2 domain
  - id: backdoor/fdm-backdoor/c2-domain
    desc: FDM backdoor C2 domain
    crit: suspicious
    conf: 0.98
    family: true
    attack: "T1071"
    if:
      type: string
      substr: "u.fdmpkg.org"

  # FDM backdoor C2 IP
  - id: backdoor/fdm-backdoor/c2-ip
    desc: FDM backdoor C2 IP address
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1071"
    if:
      type: string
      substr: "45.88.3.6"

  # FDM specific temp file pattern
  - id: backdoor/fdm-backdoor/temp-file
    desc: FDM backdoor specific temp file
    crit: suspicious
    conf: 0.9
    if:
      type: yara
      source: |
        rule fdm_temp_file {
          strings:
            $tmp1 = "/tmp/tmpA81e4gVs" ascii
            $tmp2 = "tmpd819is13." ascii
          condition:
            any of them
        }

  # FDM postinst script patterns
  - id: backdoor/fdm-backdoor/postinst-pattern
    desc: FDM backdoor postinst script patterns
    crit: suspicious
    conf: 0.9
    for: [shell, text]
    if:
      type: yara
      source: |
        rule fdm_postinst {
          strings:
            // Ukrainian comment marker
            $ukr = { D1 81 D0 BB D0 B0 D0 B2 D0 B0 }  // "слава" in UTF-8
            // Specific patterns
            $botdir_func = "botdir()" ascii
            $crond_name = "/crond" ascii
            $etc_openal = "/etc/openal" ascii
            $etc_thermald = "/etc/thermald" ascii
            // Cron job name used
            $cron_collect = "/etc/cron.d/collect" ascii
          condition:
            $ukr or $cron_collect or
            ($botdir_func and any of ($crond_name, $etc_openal, $etc_thermald))
        }

  # FDM backdoor ELF indicators
  - id: backdoor/fdm-backdoor/elf-indicators
    desc: FDM backdoor ELF binary indicators
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1195.002"
    for: [elf]
    if:
      type: yara
      source: |
        rule fdm_elf_backdoor {
          strings:
            $c2_domain = "u.fdmpkg.org" ascii
            $c2_ip = "45.88.3.6" ascii
            $tmp1 = "/tmp/tmpA81e4gVs" ascii
            $tmp2 = "tmpd819is13." ascii
            $uniqid = "UNIQID" ascii
            $dnscache = "DNSCACHEIP" ascii
          condition:
            uint32(0) == 0x464C457F and
            (any of ($c2*) or 2 of ($tmp*, $uniqid, $dnscache))
        }

composite_rules:
  # Full FDM backdoor detection
  - id: backdoor/fdm-backdoor/detected
    desc: FreeDownloadManager supply chain backdoor
    crit: suspicious
    conf: 0.98
    family: true
    attack: "T1195.002"
    mbc: "B0030"
    for: [elf]
    any:
      - id: backdoor/fdm-backdoor/c2-domain
      - id: backdoor/fdm-backdoor/c2-ip
      - id: backdoor/fdm-backdoor/elf-indicators
