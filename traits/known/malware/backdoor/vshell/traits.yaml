# Malware Family - VShell / Agent-CNO Trojan
# Reference: https://malpedia.caad.fkie.fraunhofer.de/details/elf.vshell
# ATT&CK: T1059 (Command and Scripting Interpreter)

traits:
  - id: backdoor/vshell/send-vshell
    desc: VShell send function marker
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1059"
    r#for: [elf]
    if:
      type: string
      exact: ".SendVShell"

  - id: backdoor/vshell/sockopt-fprog
    desc: VShell BPF socket filter
    crit: suspicious
    conf: 0.9
    family: true
    attack: "T1205"
    r#for: [elf]
    if:
      type: string
      exact: ".SetsockoptSockFprog"

  # VShell YARA signature trait
  - id: backdoor/vshell/yara-signature
    desc: VShell YARA signature
    crit: suspicious
    conf: 0.95
    family: true
    attack: "T1059"
    mbc: "B0022"
    r#for: [elf]
    if:
      type: yara
      source: |
        rule vshell_trojan {
          strings:
            $send_vshell = ".SendVShell"
            $sockopt = ".SetsockoptSockFprog"
          condition:
            uint32(0) == 0x464C457F and
            filesize < 20MB and all of them
        }

composite_rules:
  - id: backdoor/vshell/detected
    desc: VShell / Agent-CNO Trojan
    crit: hostile
    conf: 0.95
    family: true
    reference: "https://malpedia.caad.fkie.fraunhofer.de/details/elf.vshell"
    attack: "T1059"
    mbc: "B0022"
    r#for: [elf]
    all:
      - id: backdoor/vshell/send-vshell
      - id: backdoor/vshell/sockopt-fprog
      - id: backdoor/vshell/yara-signature
