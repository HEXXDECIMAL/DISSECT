# Malware Family - SSHDoor Backdoor
# Backdoored SSH daemon for credential theft
# ATT&CK: T1556.003 (Pluggable Authentication Modules)

traits:
  # === Atomic Traits ===

  - id: backdoor/sshdoor/krb5-ccname
    desc: SSHDoor Kerberos credential cache reference
    crit: suspicious
    conf: 0.5
    attack: "T1558"
    for: [elf]
    if:
      type: string
      substr: "KRB5CCNAME"

  - id: backdoor/sshdoor/rm-var-tmp
    desc: SSHDoor temp file cleanup pattern
    crit: suspicious
    conf: 0.85
    attack: "T1070.004"
    for: [elf]
    if:
      type: string
      regex: "rm /var/tmp/\\.\\w{0,16}"

  - id: backdoor/sshdoor/group-json
    desc: SSHDoor group JSON key
    crit: suspicious
    conf: 0.6
    attack: "T1556.003"
    for: [elf]
    if:
      type: string
      substr: '"Group"'

  - id: backdoor/sshdoor/password-json
    desc: SSHDoor password JSON key
    crit: suspicious
    conf: 0.6
    attack: "T1556.003"
    for: [elf]
    if:
      type: string
      substr: '"Password"'

  - id: backdoor/sshdoor/login-lock
    desc: SSHDoor login lock file
    crit: suspicious
    conf: 0.9
    attack: "T1556.003"
    for: [elf]
    if:
      type: string
      substr: ".login_lock"

  - id: backdoor/sshdoor/login-format
    desc: SSHDoor login format string
    crit: suspicious
    conf: 0.95
    attack: "T1556.003"
    for: [elf]
    if:
      type: string
      substr: "%s:Login to %s:%s"

  - id: backdoor/sshdoor/server-locked
    desc: SSHDoor server locked message
    crit: suspicious
    conf: 0.95
    attack: "T1556.003"
    for: [elf]
    if:
      type: string
      substr: "ssh server is locked"

composite_rules:
  # === Helper composite ===
  - id: sshdoor-indicators
    desc: SSHDoor-specific string indicators
    for: [elf]
    any:
      - id: backdoor/sshdoor/rm-var-tmp
      - id: backdoor/sshdoor/group-json
      - id: backdoor/sshdoor/password-json
      - id: backdoor/sshdoor/login-lock
      - id: backdoor/sshdoor/login-format
      - id: backdoor/sshdoor/server-locked

  # === Migrated from YARA ===
  # Original YARA: KRB5CCNAME AND 2 of (6 other patterns)
  # Note: uint32(0) == 0x464C457F (ELF magic) and filesize < 2MB constraints
  # cannot be translated to DISSECT trait system
  - id: backdoor/sshdoor/yara-signature
    desc: SSHDoor backdoored SSH daemon YARA
    crit: suspicious
    conf: 0.95
    attack: "T1556.003"
    mbc: "B0022"
    for: [elf]
    all:
      - id: backdoor/sshdoor/krb5-ccname
      - id: sshdoor-indicators
        needs: 2
  - id: backdoor/sshdoor/detected
    desc: SSHDoor backdoored SSH daemon
    crit: hostile
    conf: 0.95
    attack: "T1556.003"
    mbc: "B0022"
    for: [elf]
    needs: 3
    any:
      - id: backdoor/sshdoor/krb5-ccname
      - id: backdoor/sshdoor/rm-var-tmp
      - id: backdoor/sshdoor/login-lock
      - id: backdoor/sshdoor/login-format
      - id: backdoor/sshdoor/server-locked
      - id: backdoor/sshdoor/yara-signature
