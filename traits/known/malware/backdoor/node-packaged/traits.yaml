# NodeJS-based Backdoor Detections
# Detects Node.js binaries packaged with pkg/nexe that exhibit backdoor behavior
# ATT&CK: T1059.003 (Command and Scripting Interpreter: JavaScript), T1071 (Application Layer Protocol)

defaults:
  for: [elf, macho, so, dylib]

traits:
  # === Packaging Markers ===
  - id: pkg-marker
    desc: "NodeJS binary packaged with 'pkg'"
    crit: notable
    conf: 1.0
    if:
      type: string
      substr: "/snapshot/"

  - id: nexe-marker
    desc: "NodeJS binary packaged with 'nexe'"
    crit: notable
    conf: 1.0
    if:
      type: string
      substr: "nexe.js"

  # NOTE: Cannot be migrated - requires YARA ELF module for section enumeration
  - id: lpstub-section
    desc: "NodeJS binary with 'lpstub' (hugepages)"
    crit: inert
    conf: 1.0
    if:
      type: yara
      source: |
        import "elf"
        rule nodejs_lpstub {
          condition:
            for any i in (0..elf.number_of_sections-1) : (
              elf.sections[i].name == "lpstub"
            )
        }

  # === Suspicious Indicators ===
  - id: suspicious-c2
    desc: "Suspicious NodeJS C2 endpoint (securitytrails.pro)"
    crit: suspicious
    conf: 1.0
    attack: "T1071"
    if:
      type: string
      substr: "ws://securitytrails.pro:2052"

composite_rules:
  # NodeJS exfil pattern
  - id: exfil-pattern
    desc: NodeJS combination of WebSockets and archiver
    crit: suspicious
    conf: 0.8
    all:
      - id: cap/data/archive/library::archiver
      - id: cap/comm/websocket/library::ws
      - id: pkg-marker

  # Helper: any backdoor behavior indicator
  - id: behavior
    desc: NodeJS backdoor behavior indicators
    crit: notable
    conf: 0.8
    any:
      - id: suspicious-c2
      - id: exfil-pattern
      - id: obj/c2/client/connection::marker
      - id: cap/exec/remote-command/protocol::generic
      - id: cap/data/archive/zip::generic

  # Main detection
  - id: detected
    desc: "NodeJS-based Backdoor detected"
    crit: suspicious
    conf: 0.95
    attack: "T1059.003"
    mbc: "B0022"
    all:
      - id: pkg-marker
      - id: behavior
