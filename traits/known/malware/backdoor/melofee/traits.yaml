# Melofee Linux Backdoor Detection
# ATT&CK: T1071 (Application Layer Protocol)
# MBC: B0030 (Remote Access)
#
# NOTE: This file contains ONLY Melofee-specific identifiers.
# Generic C2 terms (heartbeat, beacon, checkin) are NOT Melofee-specific
# and belong in cap/comm/c2/ if needed.

defaults:
  for: [elf, macho, pe, so, dylib, dll, python, shell, javascript]

traits:
  # === Melofee Name Variants (case-insensitive via variants) ===
  - id: melofee-lower
    desc: melofee name (lowercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "melofee"

  - id: melofee-upper
    desc: MELOFEE name (uppercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "MELOFEE"

  - id: melofee-title
    desc: Melofee name (title case)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "Melofee"

  # Winnti variants (Melofee is attributed to Winnti group)
  - id: winnti-lower
    desc: winnti name (lowercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "winnti"

  - id: winnti-upper
    desc: WINNTI name (uppercase)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "WINNTI"

  - id: winnti-title
    desc: Winnti name (title case)
    crit: suspicious
    conf: 0.95
    if:
      type: string
      word: "Winnti"

  # Melofee-specific code prefixes
  - id: melo-prefix
    desc: melo_ prefix (Melofee code convention)
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: "melo_"

  - id: fee-prefix
    desc: fee_ prefix (Melofee code convention)
    crit: notable
    conf: 0.8
    if:
      type: string
      exact: "fee_"

  # === Kernel Process Hiding (Melofee rootkit behavior) ===
  - id: hide-pid-string
    desc: hide_pid string (Melofee rootkit)
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "hide_pid"

  - id: hidden-pids-string
    desc: hidden_pids string (Melofee rootkit)
    crit: suspicious
    conf: 0.9
    if:
      type: string
      exact: "hidden_pids"

composite_rules:
  # === Helper composites ===
  - id: melofee-names
    description: Melofee name (case variants)
    any:
      - id: melofee-lower
      - id: melofee-upper
      - id: melofee-title

  - id: winnti-names
    description: Winnti name (case variants)
    any:
      - id: winnti-lower
      - id: winnti-upper
      - id: winnti-title

  - id: melo-fee-prefixes
    description: melo_ or fee_ prefixes
    any:
      - id: melo-prefix
      - id: fee-prefix

  - id: hiding-strings
    description: Process hiding strings
    any:
      - id: hide-pid-string
      - id: hidden-pids-string

  # === Detection composites ===
  - id: artifact
    description: Melofee backdoor identifier string
    crit: suspicious
    conf: 0.85
    any:
      - id: melofee-names
      - id: winnti-names

  - id: rootkit-behavior
    description: Melofee rootkit behavior
    crit: suspicious
    conf: 0.9
    mbc: "B0030"
    attack: "T1014"
    all:
      - id: hiding-strings
      - id: melo-fee-prefixes

  # Melofee detection
  - id: detected
    description: Melofee backdoor detected
    crit: suspicious
    conf: 0.95
    attack: "T1071"
    mbc: "B0030"
    all:
      - id: artifact
      - id: rootkit-behavior
