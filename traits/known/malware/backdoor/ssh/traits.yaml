# SSH Backdoor Detection Patterns
# ATT&CK: T1556.004 (Modify Authentication Process: SSH)

defaults:
  for: [elf, macho, pe, so, dylib, dll, python, shell, javascript]

traits:
  # === SSH backdoor-SPECIFIC markers (ONLY these belong here) ===
  - id: backdoor/ssh/sshdoor-word
    desc: sshdoor backdoor name
    crit: suspicious
    conf: 0.9
    if:
      type: string
      word: "sshdoor"

  - id: backdoor/ssh/sshkit-word
    desc: sshkit backdoor toolkit name
    crit: suspicious
    conf: 0.9
    if:
      type: string
      word: "sshkit"

  - id: backdoor/ssh/master-password
    desc: master_password hardcoded credential
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "master_password"

  - id: backdoor/ssh/backdoor-pass
    desc: backdoor_pass hardcoded credential
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "backdoor_pass"

  - id: backdoor/ssh/magic-password
    desc: magic_password hardcoded credential
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "magic_password"

  - id: backdoor/ssh/auth-bypass
    desc: auth_bypass function marker
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "auth_bypass"

  - id: backdoor/ssh/skip-auth
    desc: skip_auth function marker
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "skip_auth"

  - id: backdoor/ssh/password-log
    desc: password_log credential logging
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "password_log"

  - id: backdoor/ssh/cred-log
    desc: cred_log credential logging
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "cred_log"

composite_rules:
  # === Helper composites ===
  - id: ssh-backdoor-names
    desc: SSH backdoor family names
    any:
      - id: backdoor/ssh/sshdoor-word
      - id: backdoor/ssh/sshkit-word

  - id: ssh-hardcoded-creds
    desc: Hardcoded SSH credential strings
    any:
      - id: backdoor/ssh/master-password
      - id: backdoor/ssh/backdoor-pass
      - id: backdoor/ssh/magic-password

  - id: ssh-auth-bypass
    desc: SSH auth bypass markers
    any:
      - id: backdoor/ssh/auth-bypass
      - id: backdoor/ssh/skip-auth

  - id: ssh-cred-logging
    desc: SSH credential logging
    any:
      - id: backdoor/ssh/password-log
      - id: backdoor/ssh/cred-log

  # === Detection rules ===
  - id: backdoor/ssh/generic
    desc: SSH backdoor patterns
    crit: suspicious
    conf: 0.85
    attack: "T1556.004"
    any:
      - id: ssh-backdoor-names
      - id: ssh-hardcoded-creds
      - id: ssh-auth-bypass

  # === Main detection rule ===
  - id: backdoor/ssh/detected
    desc: SSH backdoor detected
    crit: suspicious
    conf: 0.95
    attack: "T1556.004"
    mbc: "B0022"
    needs: 2
    any:
      - id: backdoor/ssh/generic
      - id: backdoor/ssh/cred-capture
      - id: ssh-backdoor-names
      - id: ssh-hardcoded-creds
