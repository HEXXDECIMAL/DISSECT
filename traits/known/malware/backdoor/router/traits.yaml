# Router/IoT Malware Detection
# Detects malware targeting network devices
# ATT&CK: T1584.008 (Network Devices)

defaults:
  for: [elf, macho, so, dylib]

traits:
  # VPNFilter modular malware
  - id: router/vpnfilter
    desc: VPNFilter router malware indicators
    crit: suspicious
    conf: 0.95
    attack: "T1584.008"
    if:
      type: yara
      source: |
        rule vpnfilter {
          strings:
            $photobucket = "photobucket" ascii nocase fullword
            $toknowall = "toknowall" ascii nocase fullword
            $stage = "stage" ascii nocase fullword
            $qnap = "qnap" ascii nocase fullword
            $nvram = "/nvram" ascii
          condition:
            any of ($photobucket, $toknowall) or ($stage and ($qnap or $nvram))
        }

  # Router firmware paths
  - id: router/firmware-access
    desc: Accesses router firmware paths
    crit: notable
    conf: 0.8
    if:
      type: yara
      source: |
        rule router_firmware {
          strings:
            $nvram = "/nvram" ascii
            $jffs = "/jffs" ascii
            $mtd = "/dev/mtd" ascii
            $factory = "/etc/factory" ascii
            $sysconfig = "/etc/config" ascii
          condition:
            2 of them
        }

  # Router reboot/brick patterns
  - id: router/destructive
    desc: Router destructive capabilities
    crit: suspicious
    conf: 0.9
    attack: "T1485"
    if:
      type: yara
      source: |
        rule router_destructive {
          strings:
            $reboot = "reboot" ascii fullword
            $dd_mtd = "dd if=" ascii
            $erase = "mtd erase" ascii
            $factory_reset = "factory" ascii fullword
            $nvram_erase = "nvram erase" ascii
          condition:
            2 of them
        }

  # MikroTik targeting
  - id: router/mikrotik
    desc: Targets MikroTik routers
    crit: suspicious
    conf: 0.85
    if:
      type: yara
      source: |
        rule mikrotik_target {
          strings:
            $mikrotik = "mikrotik" ascii nocase fullword
            $routeros = "routeros" ascii nocase fullword
            $winbox = "winbox" ascii nocase fullword
            $api_port = ":8728" ascii
          condition:
            any of them
        }

  # Ubiquiti targeting
  - id: router/ubiquiti
    desc: Targets Ubiquiti devices
    crit: suspicious
    conf: 0.85
    if:
      type: yara
      source: |
        rule ubiquiti_target {
          strings:
            $ubnt = "ubnt" ascii nocase fullword
            $unifi = "unifi" ascii nocase fullword
            $edgeos = "edgeos" ascii nocase fullword
            $vyatta = "vyatta" ascii nocase fullword
          condition:
            any of them
        }
