# Babuk Ransomware & Derivatives
# Specifically targeting Linux/ESXi environments

traits:
  - id: putinhuilo-marker
    desc: Babuk derivative unique campaign marker (PUTINHUILO1337)
    crit: suspicious
    conf: 1.0
    if:
      type: string
      substr: "PUTINHUILO1337"

  # Atomic traits for log style
  - id: babuk-log-id
    desc: Babuk identifier string
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "[IDENTIFIER]"

  - id: babuk-log-fmt
    desc: Babuk log format regex
    crit: notable
    conf: 0.6
    if:
      type: string
      regex: '(\[\+\]|\[\-\]|\[\!\]) (Context|Encrypt|Generated|File)'

  # Atomic traits for ESXi targeting
  - id: babuk-vmfs
    desc: VMFS path reference
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "/vmfs/"

  - id: babuk-scan
    desc: ScanDirectory string
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "ScanDirectory"

  - id: babuk-list
    desc: listFiles string
    crit: notable
    conf: 0.6
    if:
      type: string
      substr: "listFiles"

  # Naming conventions for progress tracking
  - id: babuk-progress-vars
    desc: Babuk locker progress tracking variables
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "(llSize|llDone|llRead)"

composite_rules:
  - id: babuk-locker-log-style
    desc: Babuk locker logging style with specific identifier
    crit: suspicious
    conf: 0.9
    all:
      - id: babuk-log-id
      - id: babuk-log-fmt

  - id: babuk-esxi-targeting
    desc: Babuk ESXi filesystem targeting and scanning
    crit: hostile
    conf: 0.95
    all:
      - id: babuk-vmfs
      - id: babuk-scan
      - id: babuk-list

  - id: babuk-ransomware-esxi
    desc: Babuk-family ESXi ransomware detection
    crit: hostile
    conf: 0.98
    for: [elf]
    all:
      - id: obj/impact/ransom/encrypt::babuk-config-marker
      - id: cap/vm/detect/vmware::vmfs-path
    any:
      - id: putinhuilo-marker
      - id: babuk-locker-log-style
      - id: babuk-progress-vars
      - id: obj/impact/ransom/encrypt::locker-config-fields
