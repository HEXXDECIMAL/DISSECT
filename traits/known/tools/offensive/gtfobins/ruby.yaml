---
# GTFOBins Ruby Abuse Detection
# GTFOBins: https://gtfobins.github.io/
# Specific GTFOBins patterns for Ruby abuse
# ATT&CK: T1059 (Command and Scripting Interpreter), T1068 (Exploitation for Privilege Escalation)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === GTFOBins Ruby Marker ===
  - id: gtfobins-ruby-marker
    desc: GTFOBins Ruby pattern marker
    crit: notable
    conf: 0.70
    if:
      type: raw
      regex: 'ruby -e|ruby -rsocket|ruby -ropen-uri|ruby -rfiddle'

  # === GTFOBins Ruby shell spawning ===
  - id: gtfobins-ruby-exec-shell
    desc: GTFOBins Ruby shell spawning
    crit: suspicious
    conf: 0.90
    attack: "T1059"
    if:
      type: raw
      regex: 'ruby -e.{0,30}exec.{0,30}bin/sh|ruby -e.{0,30}exec.{0,30}bin/bash|ruby -e.{0,30}system.{0,30}sh'

  # === GTFOBins Ruby file write ===
  - id: gtfobins-ruby-file-write
    desc: GTFOBins Ruby file write technique
    crit: suspicious
    conf: 0.90
    attack: "T1083"
    if:
      type: raw
      regex: 'ruby -e.{0,50}File\.(open|write).{0,50}w.{0,50}write'

composite_rules:
  # === GTFOBins Library Load ===
  - id: gtfobins-ruby-library-load
    desc: GTFOBins shared library loading via Ruby
    crit: suspicious
    conf: 0.93
    attack: "T1059"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: cap/exec/dylib/load::ruby-ffi-dlopen
      - id: cap/exec/dylib/load::fiddle-dlopen

  # === GTFOBins Privilege Escalation ===
  - id: gtfobins-ruby-privesc
    desc: GTFOBins privilege escalation via Ruby
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: obj/privesc/setuid/abuse::ruby-setuid
      - id: obj/privesc/setuid/abuse::ruby-root-shell

  # === GTFOBins File Operations ===
  - id: gtfobins-ruby-file-ops
    desc: GTFOBins file operations via Ruby
    crit: suspicious
    conf: 0.85
    attack: "T1083"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: cap/fs/file/read::ruby-file-read-content
      - id: cap/fs/write/file::ruby-file-write-content

  # === GTFOBins Reverse Shell ===
  - id: gtfobins-ruby-reverse-shell
    desc: GTFOBins reverse shell via Ruby
    crit: suspicious
    conf: 0.93
    attack: "T1059"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: obj/c2/reverse-shell

  # === GTFOBins Shell ===
  - id: gtfobins-ruby-shell
    desc: GTFOBins shell execution via Ruby
    crit: suspicious
    conf: 0.85
    attack: "T1059"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: cap/exec/command/shell/lang::ruby-shell-exec
