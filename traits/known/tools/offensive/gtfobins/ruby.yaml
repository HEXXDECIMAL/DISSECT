---
# GTFOBins Ruby Abuse Detection
# GTFOBins: https://gtfobins.github.io/
# Specific GTFOBins patterns for Ruby abuse
# ATT&CK: T1059 (Command and Scripting Interpreter), T1068 (Exploitation for Privilege Escalation)

defaults:
  for: [ruby]
  platforms: [all]

traits:
  # === GTFOBins Ruby Marker ===
  - id: gtfobins-ruby-marker
    desc: GTFOBins Ruby pattern marker
    crit: notable
    conf: 0.70
    if:
      type: string
      regex: 'ruby -e|ruby -rsocket|ruby -ropen-uri|ruby -rfiddle'

composite_rules:
  # === GTFOBins Library Load ===
  - id: gtfobins-ruby-library-load
    desc: GTFOBins shared library loading via Ruby
    crit: suspicious
    conf: 0.93
    attack: "T1059"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: cap/exec/dylib/ruby-ffi-dlopen
      - id: cap/exec/dylib/fiddle-dlopen

  # === GTFOBins Privilege Escalation ===
  - id: gtfobins-ruby-privesc
    desc: GTFOBins privilege escalation via Ruby
    crit: suspicious
    conf: 0.95
    attack: "T1068"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: obj/privesc/setuid/ruby-setuid
      - id: cap/exec/command/shell/ruby-root-shell

  # === GTFOBins File Operations ===
  - id: gtfobins-ruby-file-ops
    desc: GTFOBins file operations via Ruby
    crit: notable
    conf: 0.75
    attack: "T1083"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: cap/fs/file/read/ruby-file-read
      - id: cap/fs/write/file/ruby-file-write-content

  # === GTFOBins Reverse Shell ===
  - id: gtfobins-ruby-reverse-shell
    desc: GTFOBins reverse shell via Ruby
    crit: suspicious
    conf: 0.93
    attack: "T1059"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: obj/c2/reverse-shell/tcpsocket-ref
      - id: obj/c2/reverse-shell/io-popen
      - id: obj/c2/reverse-shell/ruby-tcp-socket

  # === GTFOBins Shell ===
  - id: gtfobins-ruby-shell
    desc: GTFOBins shell execution via Ruby
    crit: notable
    conf: 0.80
    attack: "T1059"
    needs: 2
    any:
      - id: gtfobins-ruby-marker
      - id: cap/exec/command/shell/ruby-shell-exec
