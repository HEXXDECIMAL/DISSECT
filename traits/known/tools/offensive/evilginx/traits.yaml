# Evilginx2 - Advanced Phishing Framework
# A man-in-the-middle attack framework for phishing login credentials
# along with session cookies, bypassing 2FA
#
# GitHub: github.com/kgretzky/evilginx2
# ATT&CK: T1557 (Man-in-the-Middle), T1539 (Steal Web Session Cookie)
# MBC: B0030 (Credential Theft)

defaults:
  for: [elf, macho, pe]
  platforms: [all]
  attack: "T1557"

traits:
  # === Phishlet Configuration File Detection ===
  # These traits detect Evilginx phishlet YAML configuration files

  - id: phishlet-proxy-hosts
    desc: Phishlet proxy_hosts configuration
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "proxy_hosts:"

  - id: phishlet-phish-sub
    desc: Phishlet phish_sub directive
    crit: suspicious
    conf: 0.95
    for: [all]
    if:
      type: content
      substr: "phish_sub:"

  - id: phishlet-orig-sub
    desc: Phishlet orig_sub directive
    crit: suspicious
    conf: 0.95
    for: [all]
    if:
      type: content
      substr: "orig_sub:"

  - id: phishlet-auth-tokens
    desc: Phishlet auth_tokens section
    crit: suspicious
    conf: 0.95
    for: [all]
    if:
      type: content
      substr: "auth_tokens:"

  - id: phishlet-credentials
    desc: Phishlet credentials section
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      regex: "credentials:\\s*[\\s\\S]{0,500}(username|password|custom):\\s*[\\s\\S]{0,200}(key|search|type):"

  - id: phishlet-sub-filters
    desc: Phishlet sub_filters section
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "sub_filters:"

  - id: phishlet-js-inject
    desc: Phishlet js_inject section
    crit: suspicious
    conf: 0.95
    for: [all]
    if:
      type: content
      substr: "js_inject:"

  - id: phishlet-is-landing
    desc: Phishlet is_landing directive
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "is_landing:"

  - id: phishlet-min-ver
    desc: Phishlet min_ver version marker
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: content
      regex: "min_ver:\\s*['\"]?[0-9]+\\.[0-9]+"

  - id: phishlet-trigger-domains
    desc: Phishlet trigger_domains directive
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "trigger_domains:"

  - id: phishlet-force-post
    desc: Phishlet force_post directive
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "force_post:"

  - id: phishlet-auth-urls
    desc: Phishlet auth_urls directive
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "auth_urls:"

  # === Evilginx Main Config Detection ===
  # Detects Evilginx main config.yaml files

  - id: config-lures
    desc: Evilginx lures configuration
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      substr: "lures:"

  - id: config-phishlet-ref
    desc: Evilginx phishlet reference
    crit: suspicious
    conf: 0.9
    for: [all]
    if:
      type: content
      regex: "phishlet:\\s*(google|outlook|yahoo|facebook|linkedin|instagram|twitter|microsoft|office365|o365)"

  - id: config-redirect-url
    desc: Evilginx redirect_url config
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: content
      substr: "redirect_url:"

  - id: config-site-domains
    desc: Evilginx site_domains config
    crit: suspicious
    conf: 0.85
    for: [all]
    if:
      type: content
      substr: "site_domains:"

  - id: config-verification-key
    desc: Evilginx verification_key config
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: content
      substr: "verification_key:"

  - id: config-blacklist-mode
    desc: Evilginx blacklist_mode config
    crit: notable
    conf: 0.8
    for: [all]
    if:
      type: content
      substr: "blacklist_mode:"

  # === Core Evilginx identifiers ===

  - id: github-ref
    desc: Evilginx2 GitHub path reference
    crit: suspicious
    conf: 0.98
    if:
      type: string
      substr: "github.com/kgretzky/evilginx2"

  - id: core-package
    desc: Evilginx2 core package reference
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "kgretzky/evilginx2/core"

  - id: database-package
    desc: Evilginx2 database package reference
    crit: suspicious
    conf: 0.95
    if:
      type: string
      regex: "kgretzky/evilginx2/database"

  - id: log-package
    desc: Evilginx2 log package reference
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "kgretzky/evilginx2/log"

  # === Phishlet functionality ===

  - id: phishlet-string
    desc: Phishlet configuration string
    crit: suspicious
    conf: 0.9
    if:
      type: string
      word: "phishlet"

  - id: phishlet-hostname
    desc: Phishlet hostname configuration
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "phishlet hostname"

  - id: phishlet-version
    desc: Phishlet version reference
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "PhishletVersion"

  # === Lure functionality (phishing URL generation) ===

  - id: lure-functions
    desc: Lure management functions
    crit: suspicious
    conf: 0.9
    if:
      type: string
      regex: "(AddLure|GetLure|DeleteLure|GetLureUrl)"

  - id: phish-url
    desc: Phishing URL generation
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "createPhishUrl"

  - id: phish-domain
    desc: Phishing domain configuration
    crit: suspicious
    conf: 0.85
    if:
      type: string
      substr: "getPhishDomain"

  # === Session/credential capture ===

  - id: auth-token-capture
    desc: Auth token capture patterns
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "(isAuthToken|AddAuthToken|authTokens)"

  # === Root CA for MITM ===

  - id: evil-root-ca
    desc: Evilginx root CA string
    crit: suspicious
    conf: 0.98
    if:
      type: string
      substr: "Evilginx Super-Evil Root CA"

  - id: signature-trust
    desc: Evilginx signature trust string
    crit: suspicious
    conf: 0.9
    if:
      type: string
      substr: "Evilginx Signature Trust Co"

  # === Proxy interception ===

  - id: proxy-interception
    desc: HTTP proxy interception
    crit: notable
    conf: 0.8
    if:
      type: string
      substr: "replaceHostWithPhished"

  - id: force-post
    desc: Force POST interception
    crit: suspicious
    conf: 0.85
    if:
      type: string
      regex: "force_post:.{0,50}(body|url matched)"

  # === Educational disclaimer (ironic indicator) ===

  - id: educational-disclaimer
    desc: Educational purposes disclaimer
    crit: notable
    conf: 0.7
    if:
      type: string
      substr: "built for educational purposes only"

composite_rules:
  # === Phishlet Configuration File Detection ===
  # Detects Evilginx phishlet YAML configuration files
  # Complexity: all(4) = 4 >= 4 ✓ HOSTILE
  - id: phishlet-config
    desc: Evilginx phishlet configuration file
    crit: hostile
    conf: 0.95
    attack: "T1539"
    for: [all]
    all:
      - id: phishlet-proxy-hosts
      - id: phishlet-phish-sub
      - id: phishlet-auth-tokens
      - id: phishlet-credentials

  # === Main Config File Detection ===
  # Detects Evilginx main config.yaml files
  # Complexity: all(4) = 4 >= 4 ✓ HOSTILE
  - id: main-config
    desc: Evilginx main configuration file
    crit: hostile
    conf: 0.9
    attack: "T1566"
    for: [all]
    all:
      - id: config-lures
      - id: config-phishlet-ref
      - id: config-site-domains
      - id: config-redirect-url

  # Phishlet with credential capture
  # Complexity: all(4) = 4 >= 4 ✓ HOSTILE
  - id: phishlet-with-js-inject
    desc: Phishlet with JS injection
    crit: hostile
    conf: 0.95
    attack: "T1185"
    for: [all]
    all:
      - id: phishlet-proxy-hosts
      - id: phishlet-phish-sub
      - id: phishlet-js-inject
      - id: phishlet-trigger-domains

  # Primary detection: explicit Evilginx reference with core functionality
  # Complexity: all(4) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: detected
    desc: Evilginx2 phishing framework detected
    crit: hostile
    conf: 0.98
    attack: "T1557"
    for: [elf, macho, pe]
    all:
      - id: github-ref
      - id: core-package
      - id: phishlet-string
      - id: lure-functions

  # Alternative detection: Root CA + phishlet patterns
  # Complexity: all(4) + for(1) = 5 >= 4 ✓ HOSTILE
  - id: detected-by-ca
    desc: Evilginx2 detected by Root CA
    crit: hostile
    conf: 0.95
    attack: "T1557"
    for: [elf, macho, pe]
    all:
      - id: evil-root-ca
      - id: phishlet-string
      - id: lure-functions
      - id: auth-token-capture

  # Behavioral: phishing toolkit patterns
  # Complexity: all(5) + for(1) = 6 >= 4 ✓ HOSTILE
  - id: phishing-toolkit-behavior
    desc: Phishing toolkit behavioral pattern
    crit: hostile
    conf: 0.9
    attack: "T1539"
    for: [elf, macho, pe]
    all:
      - id: phishlet-string
      - id: lure-functions
      - id: auth-token-capture
      - id: proxy-interception
      - id: phish-url
