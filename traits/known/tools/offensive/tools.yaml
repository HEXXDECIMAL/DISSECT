# Security Tools - Penetration Testing Frameworks
# Used for both legitimate security testing and malicious purposes

traits:
  # === Atomic: Metasploit ===

  - id: metasploit-ref
    desc: Metasploit framework reference
    crit: suspicious
    conf: 0.8
    attack: "T1588.002"
    platforms: [all]
    if:
      type: string
      substr: "metasploit"
      case_insensitive: true

  - id: msfpayload
    desc: Metasploit payload generator reference
    crit: suspicious
    conf: 0.9
    attack: "T1587.001"
    platforms: [all]
    if:
      type: string
      substr: "msfpayload"

  - id: metasploit-url
    desc: Metasploit website reference
    crit: suspicious
    conf: 0.75
    attack: "T1588.002"
    platforms: [all]
    if:
      type: string
      regex: "metasploit\\.com"

  - id: meterpreter
    desc: Meterpreter payload reference
    crit: suspicious
    conf: 0.95
    attack: "T1059"
    platforms: [windows]
    if:
      type: string
      regex: "/meterpreter/"

  - id: payload-label
    desc: Payload label string
    crit: inert
    conf: 0.6
    platforms: [all]
    if:
      type: string
      substr: "Payload: "

  - id: shh-bin-path
    desc: Suspicious /shh/bin path (typosquat)
    crit: notable
    conf: 0.7
    platforms: [all]
    if:
      type: string
      substr: "/shh/bin"

  # === Atomic: Network Scanners ===

  - id: nmap-ref
    desc: Nmap port scanner reference
    crit: notable
    conf: 0.6
    attack: "T1046"
    platforms: [all]
    if:
      type: string
      # Word boundaries to avoid matching substrings like "dynmap", "unmap", etc.
      word: "nmap"

  # Nmap spoofing flags - used to hide scanner identity
  - id: nmap-spoof-source
    desc: Nmap source IP spoofing
    crit: suspicious
    conf: 0.85
    attack: "T1046"
    platforms: [all]
    if:
      type: raw
      # Matches nmap -S or arguments containing -S for source IP spoofing
      regex: "(?:nmap|scan).{0,50}-S\\s+[0-9]|arguments.{0,20}-S\\s+[0-9]|'-S\\s+[0-9]"

  - id: nmap-decoy-scan
    desc: Nmap decoy scan
    crit: suspicious
    conf: 0.85
    attack: "T1046"
    platforms: [all]
    if:
      type: raw
      # Require an actual nmap invocation with -D decoy args (avoids matching unrelated '-D 96' style flags).
      regex: "\\bnmap(?:\\.exe)?\\b[^\\n\\r]{0,120}\\s-D\\s*(?:ME|RND(?::\\d+)?|[0-9]{1,3}(?:\\.[0-9]{1,3}){3}|[0-9,]+)"

  - id: masscan-ref
    desc: Masscan port scanner reference
    crit: suspicious
    conf: 0.75
    attack: "T1046"
    platforms: [all]
    if:
      type: string
      substr: "masscan"

  - id: masscan-config
    desc: Masscan configuration patterns
    crit: suspicious
    conf: 0.85
    attack: "T1046"
    platforms: [all]
    if:
      type: yara
      source: |
        rule masscan_config {
          strings:
            $adapter_ip = "adapter-ip"
            $nocapture = "nocapture"
            $output_format = "output-format"
            $randomize_hosts = "randomize-hosts"
          condition:
            3 of them
        }

  - id: execve-symbol
    desc: execve system call symbol
    crit: inert
    conf: 0.9
    platforms: [linux]
    for: [elf]
    if:
      type: symbol
      regex: "^_?execve$"

  - id: system-symbol
    desc: system() function symbol
    crit: inert
    conf: 0.9
    platforms: [linux, macos]
    for: [elf, macho]
    if:
      type: symbol
      regex: "^_?system$"

  # Removed go-exec-cmd-run duplicate - use obj/c2/reverse-shell/socket/go::exec-cmd-run

  # === Atomic: Tunneling Tools ===

  - id: chisel-ref
    desc: Chisel TCP/UDP tunnel tool
    crit: suspicious
    conf: 0.9
    attack: "T1572"
    platforms: [all]
    if:
      type: string
      substr: "jpillora/chisel"

  - id: chisel-functions
    desc: Chisel tunnel tool function signatures
    crit: suspicious
    conf: 0.85
    attack: "T1572"
    platforms: [all]
    if:
      type: yara
      source: |
        rule chisel_functions {
          strings:
            $f1 = "tlsLetsEncrypt"
            $f2 = "authUser"
            $f3 = "handleWebsocket"
            $f4 = "tlsKeyCert"
            $f5 = "tunnel_out_ssh"
          condition:
            3 of them
        }

  # === Atomic: Venom RAT ===

  - id: venom-dliv3
    desc: Venom Dliv3 GitHub reference
    crit: suspicious
    conf: 0.9
    attack: "T1090"
    platforms: [all]
    if:
      type: string
      substr: "Dliv3/Venom"

  - id: venom-agent-path
    desc: Venom agent path reference
    crit: suspicious
    conf: 0.9
    attack: "T1090"
    platforms: [all]
    if:
      type: string
      substr: "/Venom/agent"

  - id: venom-agent-name
    desc: Venom agent name reference
    crit: suspicious
    conf: 0.9
    attack: "T1090"
    platforms: [all]
    if:
      type: string
      substr: "venom_agent"

  # === Atomic: Web Recon ===

  - id: dirbuster
    desc: DirBuster directory brute-force tool
    crit: suspicious
    conf: 0.8
    attack: "T1595.003"
    platforms: [all]
    if:
      type: string
      substr: "dirbuster"

  # === Atomic: SMB Tools ===

  - id: smbexec-ntlm
    desc: SMBExec NTLM HASH indicator
    crit: suspicious
    conf: 0.85
    attack: "T1021.002"
    platforms: [all]
    if:
      type: string
      substr: "NTLM HASH"

  - id: smbexec-hashpass
    desc: SMBExec HASH PASS substitution indicator
    crit: suspicious
    conf: 0.85
    attack: "T1021.002"
    platforms: [all]
    if:
      type: string
      substr: "HASH PASS: Substituting"

  # === Atomic: Process Snooping ===

  - id: pspy-ref
    desc: pspy process snooping tool
    crit: suspicious
    conf: 0.9
    attack: "T1057"
    platforms: [linux]
    if:
      type: string
      substr: "dominicbreuker/pspy"

  - id: pspy-functions
    desc: pspy tool function signatures
    crit: suspicious
    conf: 0.8
    attack: "T1057"
    platforms: [linux]
    if:
      type: yara
      source: |
        rule pspy_functions {
          strings:
            $f1 = "startFSW"
            $f2 = "startPSS"
            $f3 = "triggerEvery"
          condition:
            2 of them
        }

composite_rules:
  # Venom RAT composite
  - id: venom-ref
    desc: "Venom shellcode generator reference"
    crit: notable
    conf: 0.7
    any:

  # SMBExec composite
  - id: smbexec
    desc: "SMBExec tool usage"
    crit: notable
    conf: 0.7
    any:

  # Execution capability group
  - id: exec-capability
    desc: Command execution capability
    crit: inert
    conf: 0.7
    any:
      - id: execve-symbol
      - id: system-symbol
      - id: obj/c2/reverse-shell/socket/go::exec-cmd-run

  - id: metasploit-payload
    desc: Metasploit payload detected
    crit: suspicious
    conf: 0.95
    attack: "T1587.001"
    for: [all]
    needs: 2
    any:
      - id: msfpayload
      - id: metasploit-url
      - id: payload-label
      - id: shh-bin-path

  - id: masscan-execution
    desc: Masscan scanner execution
    crit: suspicious
    conf: 0.9
    attack: "T1046"
    platforms: [linux]
    for: [elf]
    all:
      - id: masscan-ref
      - id: exec-capability
