# Combined capability rules for testing

simple_rules:
  - symbol: socket
    capability: net/socket/create
    description: Create network sockets
    confidence: 0.7

  - symbol: connect
    capability: net/socket/connect
    description: Connect to remote host
    confidence: 0.7

  - symbol: ptrace
    capability: anti-analysis/debug/detect
    description: Detect debugger via ptrace
    confidence: 0.8

  - symbol: mprotect
    capability: anti-analysis/memory/protect
    description: Change memory protection
    confidence: 0.7

composite_rules:
  # Reverse shell detection
  - capability: net/reverse-shell
    description: Reverse shell behavior pattern
    confidence: 0.95
    platforms: [linux, macos, unix]
    file_types: [elf, macho]

    requires_count: 2
    conditions:
      - type: symbol_or_string
        any:
          - socket
          - connect

      - type: symbol_or_string
        any:
          - dup2
          - dup

      - type: symbol_or_string
        any:
          - execve
          - system
          - '/bin/sh'
          - '/bin/bash'

  # Runtime packing/unpacking
  - capability: anti-analysis/packing/runtime
    description: Runtime unpacking detected
    confidence: 0.9
    platforms: [all]

    requires_all:
      - type: symbol_or_string
        any:
          - mmap
          - VirtualAlloc
          - malloc

      - type: symbol
        pattern: 'mprotect|VirtualProtect'

      - type: structure
        feature: entropy/high
        min_sections: 1

  # VM detection
  - capability: anti-analysis/vm/detect
    description: Virtual machine detection
    confidence: 0.9
    platforms: [all]

    requires_count: 2
    conditions:
      - type: string
        regex: '(VMware|VirtualBox|VBOX|QEMU|Xen|Parallels|KVM)'
        case_insensitive: true

      - type: string
        regex: '(VMXH|VBox|QEMU|virtio)'
        case_insensitive: true

      - type: symbol_or_string
        any:
          - sysctl
          - 'hw.model'

  # Stripped binary with network + high entropy
  - capability: anti-analysis/suspicious-binary
    description: Stripped binary with network and high entropy
    confidence: 0.85
    platforms: [all]
    file_types: [elf, macho, pe]

    requires_all:
      - type: structure
        feature: binary/stripped

      - type: structure
        feature: entropy/high
        min_sections: 1

      - type: symbol_or_string
        any:
          - socket
          - connect

  # Supply chain attack with appended payload
  # DISABLED: capability and capability_pattern condition types not implemented yet
  # - capability: supply-chain/appended-payload
  #   description: Supply chain attack with appended malicious payload
  #   confidence: 0.95
  #   platforms: [all]
  #   file_types: [elf, macho, pe]
  #
  #   requires_all:
  #     - type: capability
  #       id: binary/overlay-data
  #       min_confidence: 0.7
  #
  #     - type: capability_pattern
  #       pattern: 'data/(compression|embedded)/.*'
  #       min_count: 1
  #
  #   requires_count: 1
  #   conditions:
  #     - type: capability
  #       id: net/dns
  #
  #     - type: capability
  #       id: net/http
  #
  #     - type: capability_pattern
  #       pattern: 'evasion/.*'

  # Multi-stage payload delivery
  # DISABLED: capability condition type not implemented yet
  # - capability: supply-chain/multi-stage
  #   description: Multi-stage payload delivery system
  #   confidence: 0.9
  #   platforms: [all]
  #   file_types: [elf, macho, pe]
  #
  #   requires_all:
  #     - type: capability
  #       id: data/embedded/multiple
  #
  #     - type: capability
  #       id: binary/overlay-data
  #
  #     - type: trait
  #       name: embedded_file_count
  #       operator: '>='
  #       value: 3
